<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>522</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    522
                    <a href="521.html">prev</a>
                    <a href="523.html">next</a>
                    <a href="522_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    DTStack/flinkStreamSQL_e83f8c3a3cbab21ecd8ceab223b0f3539be4b5fd_kafka-base/kafka-base-sink/src/main/java/com/dtstack/flink/sql/sink/kafka/serialization/AvroCRowSerializationSchema.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;e83f8c3a3cbab21ecd8ceab223b0f3539be4b5fd:kafka-base/kafka-base-sink/src/main/java/com/dtstack/flink/sql/sink/kafka/serialization/AvroCRowSerializationSchema.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;e83f8c3a3cbab21ecd8ceab223b0f3539be4b5fd^1:kafka-base/kafka-base-sink/src/main/java/com/dtstack/flink/sql/sink/kafka/serialization/AvroCRowSerializationSchema.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;e83f8c3a3cbab21ecd8ceab223b0f3539be4b5fd^2:kafka-base/kafka-base-sink/src/main/java/com/dtstack/flink/sql/sink/kafka/serialization/AvroCRowSerializationSchema.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;55715c184d537500eff25ccea853833950100929:kafka-base/kafka-base-sink/src/main/java/com/dtstack/flink/sql/sink/kafka/serialization/AvroCRowSerializationSchema.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[sbj]], subset: [[sbj]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
   2 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   3 /*</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   4  * Licensed to the Apache Software Foundation (ASF) under one</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   5  * or more contributor license agreements.  See the NOTICE file</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   6  * distributed with this work for additional information</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   7  * regarding copyright ownership.  The ASF licenses this file</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   8  * to you under the Apache License, Version 2.0 (the</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   9  * &quot;License&quot;); you may not use this file except in compliance</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  10  * with the License.  You may obtain a copy of the License at</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  11  *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  12  *     http://www.apache.org/licenses/LICENSE-2.0</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  13  *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  14  * Unless required by applicable law or agreed to in writing, software</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  15  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  16  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  17  * See the License for the specific language governing permissions and</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  18  * limitations under the License.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  19  */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  20 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  21 package com.dtstack.flink.sql.sink.kafka.serialization;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  22 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  23 import com.dtstack.flink.sql.enums.EUpdateMode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  24 import org.apache.avro.LogicalType;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  25 import org.apache.avro.LogicalTypes;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  26 import org.apache.avro.Schema;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  27 import org.apache.avro.SchemaParseException;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  28 import org.apache.avro.generic.GenericData;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  29 import org.apache.avro.generic.GenericDatumWriter;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  30 import org.apache.avro.generic.GenericRecord;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  31 import org.apache.avro.generic.IndexedRecord;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  32 import org.apache.avro.io.DatumWriter;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  33 import org.apache.avro.io.Encoder;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  34 import org.apache.avro.io.EncoderFactory;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  35 import org.apache.avro.specific.SpecificData;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  36 import org.apache.avro.specific.SpecificDatumWriter;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  37 import org.apache.avro.specific.SpecificRecord;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  38 import org.apache.avro.util.Utf8;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  39 import org.apache.commons.lang3.StringUtils;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  40 import org.apache.flink.api.common.serialization.SerializationSchema;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  41 import org.apache.flink.table.runtime.types.CRow;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  42 import org.apache.flink.types.Row;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  43 import org.apache.flink.util.Preconditions;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  44 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  45 import java.io.ByteArrayOutputStream;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  46 import java.io.IOException;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  47 import java.io.ObjectInputStream;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  48 import java.io.ObjectOutputStream;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  49 import java.math.BigDecimal;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  50 import java.nio.ByteBuffer;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  51 import java.sql.Date;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  52 import java.sql.Time;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  53 import java.sql.Timestamp;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  54 import java.util.HashMap;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  55 import java.util.List;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  56 import java.util.Map;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  57 import java.util.Objects;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  58 import java.util.Optional;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  59 import java.util.TimeZone;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  60 import java.util.stream.Collectors;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  61 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  62 /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  63  * Serialization schema that serializes CROW into Avro bytes.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  64  *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  65  * &lt;p&gt;Serializes objects that are represented in (nested) Flink rows. It support types that</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  66  * are compatible with Flink&#x27;s Table &amp; SQL API.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  67  **</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  68  * @author  maqi</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  69  */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  70 public class AvroCRowSerializationSchema implements SerializationSchema&lt;CRow&gt; {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  71 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  72 	/**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  73 	 * Used for time conversions from SQL types.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  74 	 */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  75 	private static final TimeZone LOCAL_TZ = TimeZone.getDefault();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  76 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  77 	/**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  78 	 * Avro record class for serialization. Might be null if record class is not available.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  79 	 */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  80 	private Class&lt;? extends SpecificRecord&gt; recordClazz;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  81 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  82 	/**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  83 	 * Schema string for deserialization.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  84 	 */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  85 	private String schemaString;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  86 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  87 	/**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  88 	 * Avro serialization schema.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  89 	 */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  90 	private transient Schema schema;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  91 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  92 	/**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  93 	 * Writer to serialize Avro record into a byte array.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  94 	 */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  95 	private transient DatumWriter&lt;IndexedRecord&gt; datumWriter;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  96 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  97 	/**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  98 	 * Output stream to serialize records into byte array.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  99 	 */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 100 	private transient ByteArrayOutputStream arrayOutputStream;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 101 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 102 	/**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 103 	 * Low-level class for serialization of Avro values.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 104 	 */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 105 	private transient Encoder encoder;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 106 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 107 	private String updateMode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 108 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 109 	private String retractKey = &quot;retract&quot;;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 110 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 111 	/**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 112 	 * Creates an Avro serialization schema for the given specific record class.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 113 	 *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 114 	 * @param recordClazz Avro record class used to serialize Flink&#x27;s row to Avro&#x27;s record</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 115 	 */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 116 	public AvroCRowSerializationSchema(Class&lt;? extends SpecificRecord&gt; recordClazz, String updateMode) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 117 		Preconditions.checkNotNull(recordClazz, &quot;Avro record class must not be null.&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 118 		this.recordClazz = recordClazz;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 119 		this.schema = SpecificData.get().getSchema(recordClazz);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 120 		this.schemaString = schema.toString();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 121 		this.datumWriter = new SpecificDatumWriter&lt;&gt;(schema);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 122 		this.arrayOutputStream = new ByteArrayOutputStream();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 123 		this.encoder = EncoderFactory.get().binaryEncoder(arrayOutputStream, null);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 124 		this.updateMode = updateMode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 125 	}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 126 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 127 	/**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 128 	 * Creates an Avro serialization schema for the given Avro schema string.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 129 	 *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 130 	 * @param avroSchemaString Avro schema string used to serialize Flink&#x27;s row to Avro&#x27;s record</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 131 	 */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 132 	public AvroCRowSerializationSchema(String avroSchemaString,String updateMode) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 133 		Preconditions.checkNotNull(avroSchemaString, &quot;Avro schema must not be null.&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 134 		this.recordClazz = null;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 135 		this.schemaString = avroSchemaString;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 136 		try {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 137 			this.schema = new Schema.Parser().parse(avroSchemaString);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 138 		} catch (SchemaParseException e) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 139 			throw new IllegalArgumentException(&quot;Could not parse Avro schema string.&quot;, e);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 140 		}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 141 		this.datumWriter = new GenericDatumWriter&lt;&gt;(schema);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 142 		this.arrayOutputStream = new ByteArrayOutputStream();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 143 		this.encoder = EncoderFactory.get().binaryEncoder(arrayOutputStream, null);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 144 		this.updateMode = updateMode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 145 	}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 146 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 147 	@Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 148 	public byte[] serialize(CRow crow) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 149 		try {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 150 			Row row = crow.row();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 151 			boolean change = crow.change();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 152 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 153 			// convert to record</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 154 			final GenericRecord record = convertRowToAvroRecord(schema, row);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 155 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 156 			dealRetractField(change, record);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 157 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 158 			arrayOutputStream.reset();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 159 			datumWriter.write(record, encoder);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 160 			encoder.flush();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 161 			return arrayOutputStream.toByteArray();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 162 		} catch (Exception e) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 163 			throw new RuntimeException(&quot;Failed to serialize row.&quot;, e);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 164 		}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 165 	}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 166 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 167 	protected void dealRetractField(boolean change, GenericRecord record) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 168 		schema.getFields()</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 169 				.stream()</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 170 				.filter(field -&gt; StringUtils.equalsIgnoreCase(field.name(), retractKey))</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 171 				.findFirst()</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 172 				.ifPresent(field -&gt; {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 173 					if (StringUtils.equalsIgnoreCase(updateMode, EUpdateMode.UPSERT.name())) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 174 						record.put(retractKey, convertFlinkType(field.schema(), change));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 175 					}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 176 				});</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 177 	}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 178 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 179 	@Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 180 	public boolean equals(Object o) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 181 		if (this == o) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 182 			return true;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 183 		}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 184 		if (o == null || getClass() != o.getClass()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 185 			return false;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 186 		}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 187 		final AvroCRowSerializationSchema that = (AvroCRowSerializationSchema) o;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 188 		return Objects.equals(recordClazz, that.recordClazz) &amp;&amp; Objects.equals(schemaString, that.schemaString);"> 188 		return Objects.equals(recordClazz, that.recordClazz) &amp;&amp; Objects.equals(schemaString, that.schemaString)🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 189 	}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 190 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 191 	@Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 192 	public int hashCode() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 193 		return Objects.hash(recordClazz, schemaString);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 194 	}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 195 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 196 	// --------------------------------------------------------------------------------------------</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 197 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 198 	private GenericRecord convertRowToAvroRecord(Schema schema, Row row) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 199 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 200 		final List&lt;Schema.Field&gt; fields = schema.getFields()</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 201 				.stream()</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 202 				.filter(field -&gt; !StringUtils.equalsIgnoreCase(field.name(), retractKey))</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 203 				.collect(Collectors.toList());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 204 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 205 		final int length = fields.size();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 206 		final GenericRecord record = new GenericData.Record(schema);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 207 		for (int i = 0; i &lt; length; i++) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 208 			final Schema.Field field = fields.get(i);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 209 			record.put(i, convertFlinkType(field.schema(), row.getField(i)));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 210 		}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 211 		return record;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 212 	}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 213 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 214 	private Object convertFlinkType(Schema schema, Object object) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 215 		if (object == null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 216 			return null;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 217 		}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 218 		switch (schema.getType()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 219 			case RECORD:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 220 				if (object instanceof Row) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 221 					return convertRowToAvroRecord(schema, (Row) object);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 222 				}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 223 				throw new IllegalStateException(&quot;Row expected but was: &quot; + object.getClass());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 224 			case ENUM:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 225 				return new GenericData.EnumSymbol(schema, object.toString());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 226 			case ARRAY:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 227 				final Schema elementSchema = schema.getElementType();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 228 				final Object[] array = (Object[]) object;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 229 				final GenericData.Array&lt;Object&gt; convertedArray = new GenericData.Array&lt;&gt;(array.length, schema);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 230 				for (Object element : array) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 231 					convertedArray.add(convertFlinkType(elementSchema, element));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 232 				}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 233 				return convertedArray;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 234 			case MAP:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 235 				final Map&lt;?, ?&gt; map = (Map&lt;?, ?&gt;) object;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 236 				final Map&lt;Utf8, Object&gt; convertedMap = new HashMap&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 237 				for (Map.Entry&lt;?, ?&gt; entry : map.entrySet()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 238 					convertedMap.put(</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 239 						new Utf8(entry.getKey().toString()),</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 240 						convertFlinkType(schema.getValueType(), entry.getValue()));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 241 				}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 242 				return convertedMap;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 243 			case UNION:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 244 				final List&lt;Schema&gt; types = schema.getTypes();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 245 				final int size = types.size();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 246 				final Schema actualSchema;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 247 				if (size == 2 &amp;&amp; types.get(0).getType() == Schema.Type.NULL) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 248 					actualSchema = types.get(1);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 249 				} else if (size == 2 &amp;&amp; types.get(1).getType() == Schema.Type.NULL) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 250 					actualSchema = types.get(0);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 251 				} else if (size == 1) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 252 					actualSchema = types.get(0);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 253 				} else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 254 					// generic type</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 255 					return object;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 256 				}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 257 				return convertFlinkType(actualSchema, object);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 258 			case FIXED:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 259 				// check for logical type</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 260 				if (object instanceof BigDecimal) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 261 					return new GenericData.Fixed(</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 262 						schema,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 263 						convertFromDecimal(schema, (BigDecimal) object));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 264 				}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 265 				return new GenericData.Fixed(schema, (byte[]) object);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 266 			case STRING:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 267 				return new Utf8(object.toString());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 268 			case BYTES:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 269 				// check for logical type</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 270 				if (object instanceof BigDecimal) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 271 					return ByteBuffer.wrap(convertFromDecimal(schema, (BigDecimal) object));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 272 				}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 273 				return ByteBuffer.wrap((byte[]) object);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 274 			case INT:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 275 				// check for logical types</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 276 				if (object instanceof Date) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 277 					return convertFromDate(schema, (Date) object);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 278 				} else if (object instanceof Time) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 279 					return convertFromTime(schema, (Time) object);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 280 				}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 281 				return object;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 282 			case LONG:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 283 				// check for logical type</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 284 				if (object instanceof Timestamp) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 285 					return convertFromTimestamp(schema, (Timestamp) object);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 286 				}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 287 				return object;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 288 			case FLOAT:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 289 			case DOUBLE:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 290 			case BOOLEAN:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 291 				return object;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 292 		}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 293 		throw new RuntimeException(&quot;Unsupported Avro type:&quot; + schema);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 294 	}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 295 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 296 	private byte[] convertFromDecimal(Schema schema, BigDecimal decimal) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 297 		final LogicalType logicalType = schema.getLogicalType();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 298 		if (logicalType instanceof LogicalTypes.Decimal) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 299 			final LogicalTypes.Decimal decimalType = (LogicalTypes.Decimal) logicalType;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 300 			// rescale to target type</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 301 			final BigDecimal rescaled = decimal.setScale(decimalType.getScale(), BigDecimal.ROUND_UNNECESSARY);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 302 			// byte array must contain the two&#x27;s-complement representation of the</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 303 			// unscaled integer value in big-endian byte order</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 304 			return decimal.unscaledValue().toByteArray();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 305 		} else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 306 			throw new RuntimeException(&quot;Unsupported decimal type.&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 307 		}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 308 	}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 309 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 310 	private int convertFromDate(Schema schema, Date date) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 311 		final LogicalType logicalType = schema.getLogicalType();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 312 		if (logicalType == LogicalTypes.date()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 313 			// adopted from Apache Calcite</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 314 			final long time = date.getTime();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 315 			final long converted = time + (long) LOCAL_TZ.getOffset(time);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 316 			return (int) (converted / 86400000L);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 317 		} else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 318 			throw new RuntimeException(&quot;Unsupported date type.&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 319 		}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 320 	}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 321 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 322 	private int convertFromTime(Schema schema, Time date) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 323 		final LogicalType logicalType = schema.getLogicalType();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 324 		if (logicalType == LogicalTypes.timeMillis()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 325 			// adopted from Apache Calcite</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 326 			final long time = date.getTime();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 327 			final long converted = time + (long) LOCAL_TZ.getOffset(time);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 328 			return (int) (converted % 86400000L);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 329 		} else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 330 			throw new RuntimeException(&quot;Unsupported time type.&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 331 		}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 332 	}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 333 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 334 	private long convertFromTimestamp(Schema schema, Timestamp date) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 335 		final LogicalType logicalType = schema.getLogicalType();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 336 		if (logicalType == LogicalTypes.timestampMillis()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 337 			// adopted from Apache Calcite</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 338 			final long time = date.getTime();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 339 			return time + (long) LOCAL_TZ.getOffset(time);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 340 		} else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 341 			throw new RuntimeException(&quot;Unsupported timestamp type.&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 342 		}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 343 	}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 344 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 345 	private void writeObject(ObjectOutputStream outputStream) throws IOException {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 346 		outputStream.writeObject(recordClazz);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 347 		outputStream.writeObject(schemaString); // support for null</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 348 		outputStream.writeObject(retractKey);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 349 		outputStream.writeObject(updateMode);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 350 	}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 351 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 352 	@SuppressWarnings(&quot;unchecked&quot;)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 353 	private void readObject(ObjectInputStream inputStream) throws ClassNotFoundException, IOException {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 354 		recordClazz = (Class&lt;? extends SpecificRecord&gt;) inputStream.readObject();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 355 		schemaString = (String) inputStream.readObject();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 356 		if (recordClazz != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 357 			schema = SpecificData.get().getSchema(recordClazz);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 358 		} else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 359 			schema = new Schema.Parser().parse(schemaString);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 360 		}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 361 		retractKey = (String) inputStream.readObject();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 362 		updateMode = (String) inputStream.readObject();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 363 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 364 		datumWriter = new SpecificDatumWriter&lt;&gt;(schema);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 365 		arrayOutputStream = new ByteArrayOutputStream();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 366 		encoder = EncoderFactory.get().binaryEncoder(arrayOutputStream, null);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 367 	}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 368 }</span>
 369 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 370 /*</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 371  * Licensed to the Apache Software Foundation (ASF) under one</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 372  * or more contributor license agreements.  See the NOTICE file</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 373  * distributed with this work for additional information</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 374  * regarding copyright ownership.  The ASF licenses this file</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 375  * to you under the Apache License, Version 2.0 (the</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 376  * &quot;License&quot;); you may not use this file except in compliance</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 377  * with the License.  You may obtain a copy of the License at</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 378  *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 379  *     http://www.apache.org/licenses/LICENSE-2.0</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 380  *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 381  * Unless required by applicable law or agreed to in writing, software</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 382  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 383  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 384  * See the License for the specific language governing permissions and</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 385  * limitations under the License.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 386  */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 387 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 388 package com.dtstack.flink.sql.sink.kafka.serialization;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 389 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 390 import com.dtstack.flink.sql.enums.EUpdateMode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 391 import org.apache.avro.LogicalType;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 392 import org.apache.avro.LogicalTypes;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 393 import org.apache.avro.Schema;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 394 import org.apache.avro.SchemaParseException;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 395 import org.apache.avro.generic.GenericData;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 396 import org.apache.avro.generic.GenericDatumWriter;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 397 import org.apache.avro.generic.GenericRecord;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 398 import org.apache.avro.generic.IndexedRecord;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 399 import org.apache.avro.io.DatumWriter;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 400 import org.apache.avro.io.Encoder;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 401 import org.apache.avro.io.EncoderFactory;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 402 import org.apache.avro.specific.SpecificData;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 403 import org.apache.avro.specific.SpecificDatumWriter;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 404 import org.apache.avro.specific.SpecificRecord;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 405 import org.apache.avro.util.Utf8;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 406 import org.apache.commons.lang3.StringUtils;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 407 import org.apache.flink.api.common.serialization.SerializationSchema;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 408 import org.apache.flink.table.runtime.types.CRow;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 409 import org.apache.flink.types.Row;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 410 import org.apache.flink.util.Preconditions;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 411 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 412 import java.io.ByteArrayOutputStream;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 413 import java.io.IOException;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 414 import java.io.ObjectInputStream;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 415 import java.io.ObjectOutputStream;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 416 import java.math.BigDecimal;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 417 import java.nio.ByteBuffer;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 418 import java.sql.Date;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 419 import java.sql.Time;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 420 import java.sql.Timestamp;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 421 import java.util.HashMap;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 422 import java.util.List;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 423 import java.util.Map;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 424 import java.util.Objects;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 425 import java.util.TimeZone;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 426 import java.util.stream.Collectors;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 427 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 428 /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 429  * Serialization schema that serializes CROW into Avro bytes.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 430  *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 431  * &lt;p&gt;Serializes objects that are represented in (nested) Flink rows. It support types that</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 432  * are compatible with Flink&#x27;s Table &amp; SQL API.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 433  **</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 434  * @author  maqi</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 435  */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 436 public class AvroCRowSerializationSchema implements SerializationSchema&lt;CRow&gt; {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 437 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 438 	/**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 439 	 * Used for time conversions from SQL types.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 440 	 */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 441 	private static final TimeZone LOCAL_TZ = TimeZone.getDefault();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 442 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 443 	/**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 444 	 * Avro record class for serialization. Might be null if record class is not available.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 445 	 */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 446 	private Class&lt;? extends SpecificRecord&gt; recordClazz;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 447 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 448 	/**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 449 	 * Schema string for deserialization.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 450 	 */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 451 	private String schemaString;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 452 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 453 	/**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 454 	 * Avro serialization schema.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 455 	 */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 456 	private transient Schema schema;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 457 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 458 	/**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 459 	 * Writer to serialize Avro record into a byte array.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 460 	 */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 461 	private transient DatumWriter&lt;IndexedRecord&gt; datumWriter;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 462 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 463 	/**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 464 	 * Output stream to serialize records into byte array.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 465 	 */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 466 	private transient ByteArrayOutputStream arrayOutputStream;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 467 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 468 	/**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 469 	 * Low-level class for serialization of Avro values.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 470 	 */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 471 	private transient Encoder encoder;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 472 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 473 	private String updateMode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 474 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 475 	private String retractKey = &quot;retract&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 476 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 477 	/**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 478 	 * Creates an Avro serialization schema for the given specific record class.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 479 	 *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 480 	 * @param recordClazz Avro record class used to serialize Flink&#x27;s row to Avro&#x27;s record</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 481 	 */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 482 	public AvroCRowSerializationSchema(Class&lt;? extends SpecificRecord&gt; recordClazz, String updateMode) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 483 		Preconditions.checkNotNull(recordClazz, &quot;Avro record class must not be null.&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 484 		this.recordClazz = recordClazz;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 485 		this.schema = SpecificData.get().getSchema(recordClazz);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 486 		this.schemaString = schema.toString();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 487 		this.datumWriter = new SpecificDatumWriter&lt;&gt;(schema);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 488 		this.arrayOutputStream = new ByteArrayOutputStream();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 489 		this.encoder = EncoderFactory.get().binaryEncoder(arrayOutputStream, null);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 490 		this.updateMode = updateMode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 491 	}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 492 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 493 	/**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 494 	 * Creates an Avro serialization schema for the given Avro schema string.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 495 	 *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 496 	 * @param avroSchemaString Avro schema string used to serialize Flink&#x27;s row to Avro&#x27;s record</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 497 	 */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 498 	public AvroCRowSerializationSchema(String avroSchemaString,String updateMode) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 499 		Preconditions.checkNotNull(avroSchemaString, &quot;Avro schema must not be null.&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 500 		this.recordClazz = null;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 501 		this.schemaString = avroSchemaString;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 502 		try {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 503 			this.schema = new Schema.Parser().parse(avroSchemaString);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 504 		} catch (SchemaParseException e) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 505 			throw new IllegalArgumentException(&quot;Could not parse Avro schema string.&quot;, e);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 506 		}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 507 		this.datumWriter = new GenericDatumWriter&lt;&gt;(schema);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 508 		this.arrayOutputStream = new ByteArrayOutputStream();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 509 		this.encoder = EncoderFactory.get().binaryEncoder(arrayOutputStream, null);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 510 		this.updateMode = updateMode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 511 	}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 512 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 513 	@Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 514 	public byte[] serialize(CRow crow) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 515 		try {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 516 			Row row = crow.row();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 517 			boolean change = crow.change();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 518 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 519 			// convert to record</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 520 			final GenericRecord record = convertRowToAvroRecord(schema, row);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 521 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 522 			dealRetractField(change, record);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 523 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 524 			arrayOutputStream.reset();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 525 			datumWriter.write(record, encoder);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 526 			encoder.flush();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 527 			return arrayOutputStream.toByteArray();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 528 		} catch (Exception e) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 529 			throw new RuntimeException(&quot;Failed to serialize row.&quot;, e);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 530 		}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 531 	}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 532 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 533 	protected void dealRetractField(boolean change, GenericRecord record) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 534 		schema.getFields()</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 535 				.stream()</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 536 				.filter(field -&gt; StringUtils.equalsIgnoreCase(field.name(), retractKey))</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 537 				.findFirst()</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 538 				.ifPresent(field -&gt; {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 539 					if (StringUtils.equalsIgnoreCase(updateMode, EUpdateMode.UPSERT.name())) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 540 						record.put(retractKey, convertFlinkType(field.schema(), change));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 541 					}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 542 				});</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 543 	}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 544 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 545 	@Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 546 	public boolean equals(Object o) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 547 		if (this == o) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 548 			return true;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 549 		}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 550 		if (o == null || getClass() != o.getClass()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 551 			return false;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 552 		}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 553 		final AvroCRowSerializationSchema that = (AvroCRowSerializationSchema) o;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 554 		return Objects.equals(recordClazz, that.recordClazz) &amp;&amp; Objects.equals(schemaString, that.schemaString);"> 554 		return Objects.equals(recordClazz, that.recordClazz) &amp;&amp; Objects.equals(schemaString, that.schemaString)🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 555 	}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 556 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 557 	@Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 558 	public int hashCode() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 559 		return Objects.hash(recordClazz, schemaString);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 560 	}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 561 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 562 	// --------------------------------------------------------------------------------------------</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 563 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 564 	private GenericRecord convertRowToAvroRecord(Schema schema, Row row) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 565 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 566 		final List&lt;Schema.Field&gt; fields = schema.getFields()</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 567 				.stream()</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 568 				.filter(field -&gt; !StringUtils.equalsIgnoreCase(field.name(), retractKey))</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 569 				.collect(Collectors.toList());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 570 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 571 		final int length = fields.size();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 572 		final GenericRecord record = new GenericData.Record(schema);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 573 		for (int i = 0; i &lt; length; i++) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 574 			final Schema.Field field = fields.get(i);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 575 			record.put(i, convertFlinkType(field.schema(), row.getField(i)));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 576 		}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 577 		return record;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 578 	}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 579 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 580 	private Object convertFlinkType(Schema schema, Object object) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 581 		if (object == null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 582 			return null;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 583 		}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 584 		switch (schema.getType()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 585 			case RECORD:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 586 				if (object instanceof Row) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 587 					return convertRowToAvroRecord(schema, (Row) object);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 588 				}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 589 				throw new IllegalStateException(&quot;Row expected but was: &quot; + object.getClass());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 590 			case ENUM:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 591 				return new GenericData.EnumSymbol(schema, object.toString());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 592 			case ARRAY:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 593 				final Schema elementSchema = schema.getElementType();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 594 				final Object[] array = (Object[]) object;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 595 				final GenericData.Array&lt;Object&gt; convertedArray = new GenericData.Array&lt;&gt;(array.length, schema);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 596 				for (Object element : array) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 597 					convertedArray.add(convertFlinkType(elementSchema, element));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 598 				}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 599 				return convertedArray;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 600 			case MAP:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 601 				final Map&lt;?, ?&gt; map = (Map&lt;?, ?&gt;) object;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 602 				final Map&lt;Utf8, Object&gt; convertedMap = new HashMap&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 603 				for (Map.Entry&lt;?, ?&gt; entry : map.entrySet()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 604 					convertedMap.put(</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 605 						new Utf8(entry.getKey().toString()),</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 606 						convertFlinkType(schema.getValueType(), entry.getValue()));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 607 				}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 608 				return convertedMap;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 609 			case UNION:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 610 				final List&lt;Schema&gt; types = schema.getTypes();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 611 				final int size = types.size();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 612 				final Schema actualSchema;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 613 				if (size == 2 &amp;&amp; types.get(0).getType() == Schema.Type.NULL) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 614 					actualSchema = types.get(1);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 615 				} else if (size == 2 &amp;&amp; types.get(1).getType() == Schema.Type.NULL) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 616 					actualSchema = types.get(0);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 617 				} else if (size == 1) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 618 					actualSchema = types.get(0);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 619 				} else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 620 					// generic type</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 621 					return object;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 622 				}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 623 				return convertFlinkType(actualSchema, object);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 624 			case FIXED:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 625 				// check for logical type</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 626 				if (object instanceof BigDecimal) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 627 					return new GenericData.Fixed(</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 628 						schema,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 629 						convertFromDecimal(schema, (BigDecimal) object));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 630 				}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 631 				return new GenericData.Fixed(schema, (byte[]) object);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 632 			case STRING:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 633 				return new Utf8(object.toString());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 634 			case BYTES:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 635 				// check for logical type</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 636 				if (object instanceof BigDecimal) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 637 					return ByteBuffer.wrap(convertFromDecimal(schema, (BigDecimal) object));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 638 				}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 639 				return ByteBuffer.wrap((byte[]) object);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 640 			case INT:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 641 				// check for logical types</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 642 				if (object instanceof Date) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 643 					return convertFromDate(schema, (Date) object);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 644 				} else if (object instanceof Time) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 645 					return convertFromTime(schema, (Time) object);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 646 				}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 647 				return object;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 648 			case LONG:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 649 				// check for logical type</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 650 				if (object instanceof Timestamp) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 651 					return convertFromTimestamp(schema, (Timestamp) object);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 652 				}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 653 				return object;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 654 			case FLOAT:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 655 			case DOUBLE:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 656 			case BOOLEAN:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 657 				return object;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 658 			default:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 659 		}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 660 		throw new RuntimeException(&quot;Unsupported Avro type:&quot; + schema);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 661 	}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 662 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 663 	private byte[] convertFromDecimal(Schema schema, BigDecimal decimal) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 664 		final LogicalType logicalType = schema.getLogicalType();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 665 		if (logicalType instanceof LogicalTypes.Decimal) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 666 			final LogicalTypes.Decimal decimalType = (LogicalTypes.Decimal) logicalType;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 667 			// rescale to target type</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 668 			final BigDecimal rescaled = decimal.setScale(decimalType.getScale(), BigDecimal.ROUND_UNNECESSARY);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 669 			// byte array must contain the two&#x27;s-complement representation of the</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 670 			// unscaled integer value in big-endian byte order</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 671 			return decimal.unscaledValue().toByteArray();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 672 		} else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 673 			throw new RuntimeException(&quot;Unsupported decimal type.&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 674 		}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 675 	}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 676 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 677 	private int convertFromDate(Schema schema, Date date) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 678 		final LogicalType logicalType = schema.getLogicalType();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 679 		if (logicalType == LogicalTypes.date()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 680 			// adopted from Apache Calcite</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 681 			final long time = date.getTime();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 682 			final long converted = time + (long) LOCAL_TZ.getOffset(time);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 683 			return (int) (converted / 86400000L);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 684 		} else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 685 			throw new RuntimeException(&quot;Unsupported date type.&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 686 		}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 687 	}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 688 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 689 	private int convertFromTime(Schema schema, Time date) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 690 		final LogicalType logicalType = schema.getLogicalType();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 691 		if (logicalType == LogicalTypes.timeMillis()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 692 			// adopted from Apache Calcite</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 693 			final long time = date.getTime();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 694 			final long converted = time + (long) LOCAL_TZ.getOffset(time);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 695 			return (int) (converted % 86400000L);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 696 		} else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 697 			throw new RuntimeException(&quot;Unsupported time type.&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 698 		}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 699 	}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 700 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 701 	private long convertFromTimestamp(Schema schema, Timestamp date) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 702 		final LogicalType logicalType = schema.getLogicalType();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 703 		if (logicalType == LogicalTypes.timestampMillis()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 704 			// adopted from Apache Calcite</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 705 			final long time = date.getTime();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 706 			return time + (long) LOCAL_TZ.getOffset(time);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 707 		} else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 708 			throw new RuntimeException(&quot;Unsupported timestamp type.&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 709 		}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 710 	}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 711 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 712 	private void writeObject(ObjectOutputStream outputStream) throws IOException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 713 		outputStream.writeObject(recordClazz);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 714 		outputStream.writeObject(schemaString); // support for null</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 715 		outputStream.writeObject(retractKey);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 716 		outputStream.writeObject(updateMode);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 717 	}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 718 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 719 	@SuppressWarnings(&quot;unchecked&quot;)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 720 	private void readObject(ObjectInputStream inputStream) throws ClassNotFoundException, IOException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 721 		recordClazz = (Class&lt;? extends SpecificRecord&gt;) inputStream.readObject();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 722 		schemaString = (String) inputStream.readObject();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 723 		if (recordClazz != null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 724 			schema = SpecificData.get().getSchema(recordClazz);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 725 		} else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 726 			schema = new Schema.Parser().parse(schemaString);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 727 		}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 728 		retractKey = (String) inputStream.readObject();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 729 		updateMode = (String) inputStream.readObject();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 730 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 731 		datumWriter = new SpecificDatumWriter&lt;&gt;(schema);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 732 		arrayOutputStream = new ByteArrayOutputStream();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 733 		encoder = EncoderFactory.get().binaryEncoder(arrayOutputStream, null);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 734 	}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 735 }</span>
 736 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs</pre></td>
                            <td><pre>   1 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
   2 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   3 /*</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   4  * Licensed to the Apache Software Foundation (ASF) under one</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   5  * or more contributor license agreements.  See the NOTICE file</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   6  * distributed with this work for additional information</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   7  * regarding copyright ownership.  The ASF licenses this file</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   8  * to you under the Apache License, Version 2.0 (the</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   9  * &quot;License&quot;); you may not use this file except in compliance</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  10  * with the License.  You may obtain a copy of the License at</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  11  *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  12  *     http://www.apache.org/licenses/LICENSE-2.0</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  13  *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  14  * Unless required by applicable law or agreed to in writing, software</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  15  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  16  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  17  * See the License for the specific language governing permissions and</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  18  * limitations under the License.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  19  */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  20 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  21 package com.dtstack.flink.sql.sink.kafka.serialization;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  22 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  23 import com.dtstack.flink.sql.enums.EUpdateMode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  24 import org.apache.avro.LogicalType;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  25 import org.apache.avro.LogicalTypes;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  26 import org.apache.avro.Schema;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  27 import org.apache.avro.SchemaParseException;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  28 import org.apache.avro.generic.GenericData;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  29 import org.apache.avro.generic.GenericDatumWriter;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  30 import org.apache.avro.generic.GenericRecord;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  31 import org.apache.avro.generic.IndexedRecord;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  32 import org.apache.avro.io.DatumWriter;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  33 import org.apache.avro.io.Encoder;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  34 import org.apache.avro.io.EncoderFactory;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  35 import org.apache.avro.specific.SpecificData;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  36 import org.apache.avro.specific.SpecificDatumWriter;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  37 import org.apache.avro.specific.SpecificRecord;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  38 import org.apache.avro.util.Utf8;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  39 import org.apache.commons.lang3.StringUtils;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  40 import org.apache.flink.api.common.serialization.SerializationSchema;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  41 import org.apache.flink.table.runtime.types.CRow;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  42 import org.apache.flink.types.Row;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  43 import org.apache.flink.util.Preconditions;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  44 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  45 import java.io.ByteArrayOutputStream;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  46 import java.io.IOException;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  47 import java.io.ObjectInputStream;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  48 import java.io.ObjectOutputStream;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  49 import java.math.BigDecimal;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  50 import java.nio.ByteBuffer;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  51 import java.sql.Date;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  52 import java.sql.Time;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  53 import java.sql.Timestamp;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  54 import java.util.HashMap;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  55 import java.util.List;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  56 import java.util.Map;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  57 import java.util.Objects;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  58 import java.util.Optional;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  59 import java.util.TimeZone;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  60 import java.util.stream.Collectors;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  61 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  62 /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  63  * Serialization schema that serializes CROW into Avro bytes.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  64  *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  65  * &lt;p&gt;Serializes objects that are represented in (nested) Flink rows. It support types that</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  66  * are compatible with Flink&#x27;s Table &amp; SQL API.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  67  **</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  68  * @author  maqi</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  69  */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  70 public class AvroCRowSerializationSchema implements SerializationSchema&lt;CRow&gt; {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  71 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  72 	/**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  73 	 * Used for time conversions from SQL types.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  74 	 */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  75 	private static final TimeZone LOCAL_TZ = TimeZone.getDefault();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  76 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  77 	/**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  78 	 * Avro record class for serialization. Might be null if record class is not available.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  79 	 */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  80 	private Class&lt;? extends SpecificRecord&gt; recordClazz;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  81 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  82 	/**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  83 	 * Schema string for deserialization.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  84 	 */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  85 	private String schemaString;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  86 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  87 	/**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  88 	 * Avro serialization schema.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  89 	 */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  90 	private transient Schema schema;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  91 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  92 	/**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  93 	 * Writer to serialize Avro record into a byte array.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  94 	 */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  95 	private transient DatumWriter&lt;IndexedRecord&gt; datumWriter;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  96 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  97 	/**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  98 	 * Output stream to serialize records into byte array.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  99 	 */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 100 	private transient ByteArrayOutputStream arrayOutputStream;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 101 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 102 	/**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 103 	 * Low-level class for serialization of Avro values.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 104 	 */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 105 	private transient Encoder encoder;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 106 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 107 	private String updateMode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 108 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 109 	private String retractKey = &quot;retract&quot;;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 110 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 111 	/**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 112 	 * Creates an Avro serialization schema for the given specific record class.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 113 	 *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 114 	 * @param recordClazz Avro record class used to serialize Flink&#x27;s row to Avro&#x27;s record</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 115 	 */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 116 	public AvroCRowSerializationSchema(Class&lt;? extends SpecificRecord&gt; recordClazz, String updateMode) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 117 		Preconditions.checkNotNull(recordClazz, &quot;Avro record class must not be null.&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 118 		this.recordClazz = recordClazz;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 119 		this.schema = SpecificData.get().getSchema(recordClazz);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 120 		this.schemaString = schema.toString();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 121 		this.datumWriter = new SpecificDatumWriter&lt;&gt;(schema);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 122 		this.arrayOutputStream = new ByteArrayOutputStream();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 123 		this.encoder = EncoderFactory.get().binaryEncoder(arrayOutputStream, null);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 124 		this.updateMode = updateMode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 125 	}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 126 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 127 	/**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 128 	 * Creates an Avro serialization schema for the given Avro schema string.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 129 	 *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 130 	 * @param avroSchemaString Avro schema string used to serialize Flink&#x27;s row to Avro&#x27;s record</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 131 	 */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 132 	public AvroCRowSerializationSchema(String avroSchemaString,String updateMode) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 133 		Preconditions.checkNotNull(avroSchemaString, &quot;Avro schema must not be null.&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 134 		this.recordClazz = null;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 135 		this.schemaString = avroSchemaString;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 136 		try {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 137 			this.schema = new Schema.Parser().parse(avroSchemaString);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 138 		} catch (SchemaParseException e) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 139 			throw new IllegalArgumentException(&quot;Could not parse Avro schema string.&quot;, e);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 140 		}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 141 		this.datumWriter = new GenericDatumWriter&lt;&gt;(schema);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 142 		this.arrayOutputStream = new ByteArrayOutputStream();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 143 		this.encoder = EncoderFactory.get().binaryEncoder(arrayOutputStream, null);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 144 		this.updateMode = updateMode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 145 	}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 146 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 147 	@Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 148 	public byte[] serialize(CRow crow) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 149 		try {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 150 			Row row = crow.row();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 151 			boolean change = crow.change();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 152 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 153 			// convert to record</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 154 			final GenericRecord record = convertRowToAvroRecord(schema, row);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 155 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 156 			dealRetractField(change, record);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 157 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 158 			arrayOutputStream.reset();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 159 			datumWriter.write(record, encoder);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 160 			encoder.flush();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 161 			return arrayOutputStream.toByteArray();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 162 		} catch (Exception e) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 163 			throw new RuntimeException(&quot;Failed to serialize row.&quot;, e);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 164 		}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 165 	}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 166 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 167 	protected void dealRetractField(boolean change, GenericRecord record) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 168 		schema.getFields()</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 169 				.stream()</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 170 				.filter(field -&gt; StringUtils.equalsIgnoreCase(field.name(), retractKey))</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 171 				.findFirst()</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 172 				.ifPresent(field -&gt; {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 173 					if (StringUtils.equalsIgnoreCase(updateMode, EUpdateMode.UPSERT.name())) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 174 						record.put(retractKey, convertFlinkType(field.schema(), change));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 175 					}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 176 				});</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 177 	}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 178 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 179 	@Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 180 	public boolean equals(Object o) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 181 		if (this == o) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 182 			return true;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 183 		}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 184 		if (o == null || getClass() != o.getClass()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 185 			return false;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 186 		}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 187 		final AvroCRowSerializationSchema that = (AvroCRowSerializationSchema) o;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 188 		return Objects.equals(recordClazz, that.recordClazz) &amp;&amp; Objects.equals(schemaString, that.schemaString);"> 188 		return Objects.equals(recordClazz, that.recordClazz) &amp;&amp; Objects.equals(schemaString, that.schemaString)🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 189 	}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 190 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 191 	@Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 192 	public int hashCode() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 193 		return Objects.hash(recordClazz, schemaString);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 194 	}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 195 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 196 	// --------------------------------------------------------------------------------------------</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 197 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 198 	private GenericRecord convertRowToAvroRecord(Schema schema, Row row) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 199 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 200 		final List&lt;Schema.Field&gt; fields = schema.getFields()</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 201 				.stream()</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 202 				.filter(field -&gt; !StringUtils.equalsIgnoreCase(field.name(), retractKey))</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 203 				.collect(Collectors.toList());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 204 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 205 		final int length = fields.size();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 206 		final GenericRecord record = new GenericData.Record(schema);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 207 		for (int i = 0; i &lt; length; i++) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 208 			final Schema.Field field = fields.get(i);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 209 			record.put(i, convertFlinkType(field.schema(), row.getField(i)));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 210 		}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 211 		return record;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 212 	}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 213 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 214 	private Object convertFlinkType(Schema schema, Object object) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 215 		if (object == null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 216 			return null;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 217 		}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 218 		switch (schema.getType()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 219 			case RECORD:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 220 				if (object instanceof Row) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 221 					return convertRowToAvroRecord(schema, (Row) object);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 222 				}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 223 				throw new IllegalStateException(&quot;Row expected but was: &quot; + object.getClass());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 224 			case ENUM:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 225 				return new GenericData.EnumSymbol(schema, object.toString());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 226 			case ARRAY:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 227 				final Schema elementSchema = schema.getElementType();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 228 				final Object[] array = (Object[]) object;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 229 				final GenericData.Array&lt;Object&gt; convertedArray = new GenericData.Array&lt;&gt;(array.length, schema);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 230 				for (Object element : array) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 231 					convertedArray.add(convertFlinkType(elementSchema, element));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 232 				}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 233 				return convertedArray;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 234 			case MAP:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 235 				final Map&lt;?, ?&gt; map = (Map&lt;?, ?&gt;) object;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 236 				final Map&lt;Utf8, Object&gt; convertedMap = new HashMap&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 237 				for (Map.Entry&lt;?, ?&gt; entry : map.entrySet()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 238 					convertedMap.put(</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 239 						new Utf8(entry.getKey().toString()),</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 240 						convertFlinkType(schema.getValueType(), entry.getValue()));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 241 				}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 242 				return convertedMap;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 243 			case UNION:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 244 				final List&lt;Schema&gt; types = schema.getTypes();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 245 				final int size = types.size();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 246 				final Schema actualSchema;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 247 				if (size == 2 &amp;&amp; types.get(0).getType() == Schema.Type.NULL) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 248 					actualSchema = types.get(1);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 249 				} else if (size == 2 &amp;&amp; types.get(1).getType() == Schema.Type.NULL) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 250 					actualSchema = types.get(0);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 251 				} else if (size == 1) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 252 					actualSchema = types.get(0);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 253 				} else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 254 					// generic type</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 255 					return object;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 256 				}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 257 				return convertFlinkType(actualSchema, object);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 258 			case FIXED:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 259 				// check for logical type</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 260 				if (object instanceof BigDecimal) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 261 					return new GenericData.Fixed(</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 262 						schema,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 263 						convertFromDecimal(schema, (BigDecimal) object));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 264 				}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 265 				return new GenericData.Fixed(schema, (byte[]) object);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 266 			case STRING:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 267 				return new Utf8(object.toString());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 268 			case BYTES:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 269 				// check for logical type</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 270 				if (object instanceof BigDecimal) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 271 					return ByteBuffer.wrap(convertFromDecimal(schema, (BigDecimal) object));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 272 				}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 273 				return ByteBuffer.wrap((byte[]) object);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 274 			case INT:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 275 				// check for logical types</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 276 				if (object instanceof Date) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 277 					return convertFromDate(schema, (Date) object);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 278 				} else if (object instanceof Time) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 279 					return convertFromTime(schema, (Time) object);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 280 				}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 281 				return object;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 282 			case LONG:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 283 				// check for logical type</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 284 				if (object instanceof Timestamp) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 285 					return convertFromTimestamp(schema, (Timestamp) object);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 286 				}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 287 				return object;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 288 			case FLOAT:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 289 			case DOUBLE:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 290 			case BOOLEAN:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 291 				return object;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 292 		}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 293 		throw new RuntimeException(&quot;Unsupported Avro type:&quot; + schema);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 294 	}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 295 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 296 	private byte[] convertFromDecimal(Schema schema, BigDecimal decimal) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 297 		final LogicalType logicalType = schema.getLogicalType();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 298 		if (logicalType instanceof LogicalTypes.Decimal) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 299 			final LogicalTypes.Decimal decimalType = (LogicalTypes.Decimal) logicalType;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 300 			// rescale to target type</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 301 			final BigDecimal rescaled = decimal.setScale(decimalType.getScale(), BigDecimal.ROUND_UNNECESSARY);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 302 			// byte array must contain the two&#x27;s-complement representation of the</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 303 			// unscaled integer value in big-endian byte order</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 304 			return decimal.unscaledValue().toByteArray();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 305 		} else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 306 			throw new RuntimeException(&quot;Unsupported decimal type.&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 307 		}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 308 	}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 309 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 310 	private int convertFromDate(Schema schema, Date date) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 311 		final LogicalType logicalType = schema.getLogicalType();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 312 		if (logicalType == LogicalTypes.date()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 313 			// adopted from Apache Calcite</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 314 			final long time = date.getTime();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 315 			final long converted = time + (long) LOCAL_TZ.getOffset(time);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 316 			return (int) (converted / 86400000L);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 317 		} else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 318 			throw new RuntimeException(&quot;Unsupported date type.&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 319 		}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 320 	}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 321 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 322 	private int convertFromTime(Schema schema, Time date) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 323 		final LogicalType logicalType = schema.getLogicalType();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 324 		if (logicalType == LogicalTypes.timeMillis()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 325 			// adopted from Apache Calcite</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 326 			final long time = date.getTime();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 327 			final long converted = time + (long) LOCAL_TZ.getOffset(time);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 328 			return (int) (converted % 86400000L);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 329 		} else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 330 			throw new RuntimeException(&quot;Unsupported time type.&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 331 		}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 332 	}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 333 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 334 	private long convertFromTimestamp(Schema schema, Timestamp date) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 335 		final LogicalType logicalType = schema.getLogicalType();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 336 		if (logicalType == LogicalTypes.timestampMillis()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 337 			// adopted from Apache Calcite</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 338 			final long time = date.getTime();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 339 			return time + (long) LOCAL_TZ.getOffset(time);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 340 		} else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 341 			throw new RuntimeException(&quot;Unsupported timestamp type.&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 342 		}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 343 	}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 344 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 345 	private void writeObject(ObjectOutputStream outputStream) throws IOException {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 346 		outputStream.writeObject(recordClazz);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 347 		outputStream.writeObject(schemaString); // support for null</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 348 		outputStream.writeObject(retractKey);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 349 		outputStream.writeObject(updateMode);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 350 	}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 351 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 352 	@SuppressWarnings(&quot;unchecked&quot;)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 353 	private void readObject(ObjectInputStream inputStream) throws ClassNotFoundException, IOException {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 354 		recordClazz = (Class&lt;? extends SpecificRecord&gt;) inputStream.readObject();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 355 		schemaString = (String) inputStream.readObject();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 356 		if (recordClazz != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 357 			schema = SpecificData.get().getSchema(recordClazz);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 358 		} else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 359 			schema = new Schema.Parser().parse(schemaString);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 360 		}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 361 		retractKey = (String) inputStream.readObject();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 362 		updateMode = (String) inputStream.readObject();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 363 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 364 		datumWriter = new SpecificDatumWriter&lt;&gt;(schema);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 365 		arrayOutputStream = new ByteArrayOutputStream();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 366 		encoder = EncoderFactory.get().binaryEncoder(arrayOutputStream, null);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 367 	}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 368 }</span>
 369 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 370 /*</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 371  * Licensed to the Apache Software Foundation (ASF) under one</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 372  * or more contributor license agreements.  See the NOTICE file</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 373  * distributed with this work for additional information</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 374  * regarding copyright ownership.  The ASF licenses this file</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 375  * to you under the Apache License, Version 2.0 (the</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 376  * &quot;License&quot;); you may not use this file except in compliance</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 377  * with the License.  You may obtain a copy of the License at</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 378  *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 379  *     http://www.apache.org/licenses/LICENSE-2.0</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 380  *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 381  * Unless required by applicable law or agreed to in writing, software</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 382  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 383  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 384  * See the License for the specific language governing permissions and</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 385  * limitations under the License.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 386  */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 387 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 388 package com.dtstack.flink.sql.sink.kafka.serialization;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 389 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 390 import com.dtstack.flink.sql.enums.EUpdateMode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 391 import org.apache.avro.LogicalType;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 392 import org.apache.avro.LogicalTypes;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 393 import org.apache.avro.Schema;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 394 import org.apache.avro.SchemaParseException;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 395 import org.apache.avro.generic.GenericData;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 396 import org.apache.avro.generic.GenericDatumWriter;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 397 import org.apache.avro.generic.GenericRecord;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 398 import org.apache.avro.generic.IndexedRecord;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 399 import org.apache.avro.io.DatumWriter;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 400 import org.apache.avro.io.Encoder;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 401 import org.apache.avro.io.EncoderFactory;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 402 import org.apache.avro.specific.SpecificData;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 403 import org.apache.avro.specific.SpecificDatumWriter;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 404 import org.apache.avro.specific.SpecificRecord;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 405 import org.apache.avro.util.Utf8;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 406 import org.apache.commons.lang3.StringUtils;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 407 import org.apache.flink.api.common.serialization.SerializationSchema;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 408 import org.apache.flink.table.runtime.types.CRow;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 409 import org.apache.flink.types.Row;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 410 import org.apache.flink.util.Preconditions;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 411 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 412 import java.io.ByteArrayOutputStream;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 413 import java.io.IOException;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 414 import java.io.ObjectInputStream;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 415 import java.io.ObjectOutputStream;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 416 import java.math.BigDecimal;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 417 import java.nio.ByteBuffer;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 418 import java.sql.Date;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 419 import java.sql.Time;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 420 import java.sql.Timestamp;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 421 import java.util.HashMap;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 422 import java.util.List;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 423 import java.util.Map;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 424 import java.util.Objects;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 425 import java.util.TimeZone;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 426 import java.util.stream.Collectors;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 427 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 428 /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 429  * Serialization schema that serializes CROW into Avro bytes.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 430  *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 431  * &lt;p&gt;Serializes objects that are represented in (nested) Flink rows. It support types that</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 432  * are compatible with Flink&#x27;s Table &amp; SQL API.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 433  **</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 434  * @author  maqi</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 435  */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 436 public class AvroCRowSerializationSchema implements SerializationSchema&lt;CRow&gt; {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 437 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 438 	/**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 439 	 * Used for time conversions from SQL types.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 440 	 */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 441 	private static final TimeZone LOCAL_TZ = TimeZone.getDefault();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 442 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 443 	/**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 444 	 * Avro record class for serialization. Might be null if record class is not available.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 445 	 */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 446 	private Class&lt;? extends SpecificRecord&gt; recordClazz;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 447 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 448 	/**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 449 	 * Schema string for deserialization.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 450 	 */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 451 	private String schemaString;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 452 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 453 	/**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 454 	 * Avro serialization schema.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 455 	 */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 456 	private transient Schema schema;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 457 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 458 	/**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 459 	 * Writer to serialize Avro record into a byte array.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 460 	 */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 461 	private transient DatumWriter&lt;IndexedRecord&gt; datumWriter;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 462 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 463 	/**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 464 	 * Output stream to serialize records into byte array.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 465 	 */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 466 	private transient ByteArrayOutputStream arrayOutputStream;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 467 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 468 	/**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 469 	 * Low-level class for serialization of Avro values.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 470 	 */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 471 	private transient Encoder encoder;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 472 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 473 	private String updateMode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 474 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 475 	private String retractKey = &quot;retract&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 476 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 477 	/**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 478 	 * Creates an Avro serialization schema for the given specific record class.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 479 	 *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 480 	 * @param recordClazz Avro record class used to serialize Flink&#x27;s row to Avro&#x27;s record</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 481 	 */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 482 	public AvroCRowSerializationSchema(Class&lt;? extends SpecificRecord&gt; recordClazz, String updateMode) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 483 		Preconditions.checkNotNull(recordClazz, &quot;Avro record class must not be null.&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 484 		this.recordClazz = recordClazz;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 485 		this.schema = SpecificData.get().getSchema(recordClazz);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 486 		this.schemaString = schema.toString();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 487 		this.datumWriter = new SpecificDatumWriter&lt;&gt;(schema);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 488 		this.arrayOutputStream = new ByteArrayOutputStream();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 489 		this.encoder = EncoderFactory.get().binaryEncoder(arrayOutputStream, null);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 490 		this.updateMode = updateMode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 491 	}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 492 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 493 	/**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 494 	 * Creates an Avro serialization schema for the given Avro schema string.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 495 	 *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 496 	 * @param avroSchemaString Avro schema string used to serialize Flink&#x27;s row to Avro&#x27;s record</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 497 	 */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 498 	public AvroCRowSerializationSchema(String avroSchemaString,String updateMode) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 499 		Preconditions.checkNotNull(avroSchemaString, &quot;Avro schema must not be null.&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 500 		this.recordClazz = null;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 501 		this.schemaString = avroSchemaString;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 502 		try {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 503 			this.schema = new Schema.Parser().parse(avroSchemaString);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 504 		} catch (SchemaParseException e) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 505 			throw new IllegalArgumentException(&quot;Could not parse Avro schema string.&quot;, e);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 506 		}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 507 		this.datumWriter = new GenericDatumWriter&lt;&gt;(schema);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 508 		this.arrayOutputStream = new ByteArrayOutputStream();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 509 		this.encoder = EncoderFactory.get().binaryEncoder(arrayOutputStream, null);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 510 		this.updateMode = updateMode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 511 	}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 512 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 513 	@Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 514 	public byte[] serialize(CRow crow) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 515 		try {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 516 			Row row = crow.row();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 517 			boolean change = crow.change();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 518 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 519 			// convert to record</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 520 			final GenericRecord record = convertRowToAvroRecord(schema, row);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 521 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 522 			dealRetractField(change, record);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 523 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 524 			arrayOutputStream.reset();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 525 			datumWriter.write(record, encoder);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 526 			encoder.flush();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 527 			return arrayOutputStream.toByteArray();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 528 		} catch (Exception e) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 529 			throw new RuntimeException(&quot;Failed to serialize row.&quot;, e);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 530 		}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 531 	}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 532 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 533 	protected void dealRetractField(boolean change, GenericRecord record) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 534 		schema.getFields()</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 535 				.stream()</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 536 				.filter(field -&gt; StringUtils.equalsIgnoreCase(field.name(), retractKey))</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 537 				.findFirst()</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 538 				.ifPresent(field -&gt; {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 539 					if (StringUtils.equalsIgnoreCase(updateMode, EUpdateMode.UPSERT.name())) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 540 						record.put(retractKey, convertFlinkType(field.schema(), change));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 541 					}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 542 				});</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 543 	}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 544 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 545 	@Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 546 	public boolean equals(Object o) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 547 		if (this == o) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 548 			return true;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 549 		}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 550 		if (o == null || getClass() != o.getClass()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 551 			return false;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 552 		}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 553 		final AvroCRowSerializationSchema that = (AvroCRowSerializationSchema) o;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 554 		return Objects.equals(recordClazz, that.recordClazz) &amp;&amp; Objects.equals(schemaString, that.schemaString);"> 554 		return Objects.equals(recordClazz, that.recordClazz) &amp;&amp; Objects.equals(schemaString, that.schemaString)🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 555 	}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 556 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 557 	@Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 558 	public int hashCode() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 559 		return Objects.hash(recordClazz, schemaString);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 560 	}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 561 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 562 	// --------------------------------------------------------------------------------------------</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 563 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 564 	private GenericRecord convertRowToAvroRecord(Schema schema, Row row) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 565 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 566 		final List&lt;Schema.Field&gt; fields = schema.getFields()</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 567 				.stream()</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 568 				.filter(field -&gt; !StringUtils.equalsIgnoreCase(field.name(), retractKey))</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 569 				.collect(Collectors.toList());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 570 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 571 		final int length = fields.size();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 572 		final GenericRecord record = new GenericData.Record(schema);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 573 		for (int i = 0; i &lt; length; i++) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 574 			final Schema.Field field = fields.get(i);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 575 			record.put(i, convertFlinkType(field.schema(), row.getField(i)));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 576 		}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 577 		return record;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 578 	}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 579 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 580 	private Object convertFlinkType(Schema schema, Object object) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 581 		if (object == null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 582 			return null;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 583 		}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 584 		switch (schema.getType()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 585 			case RECORD:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 586 				if (object instanceof Row) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 587 					return convertRowToAvroRecord(schema, (Row) object);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 588 				}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 589 				throw new IllegalStateException(&quot;Row expected but was: &quot; + object.getClass());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 590 			case ENUM:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 591 				return new GenericData.EnumSymbol(schema, object.toString());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 592 			case ARRAY:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 593 				final Schema elementSchema = schema.getElementType();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 594 				final Object[] array = (Object[]) object;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 595 				final GenericData.Array&lt;Object&gt; convertedArray = new GenericData.Array&lt;&gt;(array.length, schema);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 596 				for (Object element : array) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 597 					convertedArray.add(convertFlinkType(elementSchema, element));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 598 				}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 599 				return convertedArray;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 600 			case MAP:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 601 				final Map&lt;?, ?&gt; map = (Map&lt;?, ?&gt;) object;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 602 				final Map&lt;Utf8, Object&gt; convertedMap = new HashMap&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 603 				for (Map.Entry&lt;?, ?&gt; entry : map.entrySet()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 604 					convertedMap.put(</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 605 						new Utf8(entry.getKey().toString()),</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 606 						convertFlinkType(schema.getValueType(), entry.getValue()));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 607 				}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 608 				return convertedMap;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 609 			case UNION:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 610 				final List&lt;Schema&gt; types = schema.getTypes();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 611 				final int size = types.size();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 612 				final Schema actualSchema;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 613 				if (size == 2 &amp;&amp; types.get(0).getType() == Schema.Type.NULL) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 614 					actualSchema = types.get(1);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 615 				} else if (size == 2 &amp;&amp; types.get(1).getType() == Schema.Type.NULL) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 616 					actualSchema = types.get(0);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 617 				} else if (size == 1) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 618 					actualSchema = types.get(0);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 619 				} else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 620 					// generic type</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 621 					return object;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 622 				}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 623 				return convertFlinkType(actualSchema, object);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 624 			case FIXED:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 625 				// check for logical type</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 626 				if (object instanceof BigDecimal) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 627 					return new GenericData.Fixed(</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 628 						schema,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 629 						convertFromDecimal(schema, (BigDecimal) object));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 630 				}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 631 				return new GenericData.Fixed(schema, (byte[]) object);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 632 			case STRING:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 633 				return new Utf8(object.toString());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 634 			case BYTES:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 635 				// check for logical type</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 636 				if (object instanceof BigDecimal) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 637 					return ByteBuffer.wrap(convertFromDecimal(schema, (BigDecimal) object));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 638 				}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 639 				return ByteBuffer.wrap((byte[]) object);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 640 			case INT:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 641 				// check for logical types</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 642 				if (object instanceof Date) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 643 					return convertFromDate(schema, (Date) object);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 644 				} else if (object instanceof Time) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 645 					return convertFromTime(schema, (Time) object);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 646 				}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 647 				return object;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 648 			case LONG:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 649 				// check for logical type</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 650 				if (object instanceof Timestamp) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 651 					return convertFromTimestamp(schema, (Timestamp) object);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 652 				}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 653 				return object;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 654 			case FLOAT:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 655 			case DOUBLE:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 656 			case BOOLEAN:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 657 				return object;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 658 			default:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 659 		}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 660 		throw new RuntimeException(&quot;Unsupported Avro type:&quot; + schema);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 661 	}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 662 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 663 	private byte[] convertFromDecimal(Schema schema, BigDecimal decimal) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 664 		final LogicalType logicalType = schema.getLogicalType();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 665 		if (logicalType instanceof LogicalTypes.Decimal) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 666 			final LogicalTypes.Decimal decimalType = (LogicalTypes.Decimal) logicalType;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 667 			// rescale to target type</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 668 			final BigDecimal rescaled = decimal.setScale(decimalType.getScale(), BigDecimal.ROUND_UNNECESSARY);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 669 			// byte array must contain the two&#x27;s-complement representation of the</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 670 			// unscaled integer value in big-endian byte order</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 671 			return decimal.unscaledValue().toByteArray();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 672 		} else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 673 			throw new RuntimeException(&quot;Unsupported decimal type.&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 674 		}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 675 	}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 676 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 677 	private int convertFromDate(Schema schema, Date date) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 678 		final LogicalType logicalType = schema.getLogicalType();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 679 		if (logicalType == LogicalTypes.date()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 680 			// adopted from Apache Calcite</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 681 			final long time = date.getTime();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 682 			final long converted = time + (long) LOCAL_TZ.getOffset(time);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 683 			return (int) (converted / 86400000L);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 684 		} else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 685 			throw new RuntimeException(&quot;Unsupported date type.&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 686 		}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 687 	}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 688 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 689 	private int convertFromTime(Schema schema, Time date) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 690 		final LogicalType logicalType = schema.getLogicalType();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 691 		if (logicalType == LogicalTypes.timeMillis()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 692 			// adopted from Apache Calcite</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 693 			final long time = date.getTime();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 694 			final long converted = time + (long) LOCAL_TZ.getOffset(time);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 695 			return (int) (converted % 86400000L);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 696 		} else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 697 			throw new RuntimeException(&quot;Unsupported time type.&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 698 		}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 699 	}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 700 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 701 	private long convertFromTimestamp(Schema schema, Timestamp date) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 702 		final LogicalType logicalType = schema.getLogicalType();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 703 		if (logicalType == LogicalTypes.timestampMillis()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 704 			// adopted from Apache Calcite</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 705 			final long time = date.getTime();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 706 			return time + (long) LOCAL_TZ.getOffset(time);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 707 		} else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 708 			throw new RuntimeException(&quot;Unsupported timestamp type.&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 709 		}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 710 	}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 711 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 712 	private void writeObject(ObjectOutputStream outputStream) throws IOException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 713 		outputStream.writeObject(recordClazz);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 714 		outputStream.writeObject(schemaString); // support for null</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 715 		outputStream.writeObject(retractKey);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 716 		outputStream.writeObject(updateMode);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 717 	}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 718 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 719 	@SuppressWarnings(&quot;unchecked&quot;)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 720 	private void readObject(ObjectInputStream inputStream) throws ClassNotFoundException, IOException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 721 		recordClazz = (Class&lt;? extends SpecificRecord&gt;) inputStream.readObject();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 722 		schemaString = (String) inputStream.readObject();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 723 		if (recordClazz != null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 724 			schema = SpecificData.get().getSchema(recordClazz);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 725 		} else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 726 			schema = new Schema.Parser().parse(schemaString);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 727 		}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 728 		retractKey = (String) inputStream.readObject();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 729 		updateMode = (String) inputStream.readObject();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 730 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 731 		datumWriter = new SpecificDatumWriter&lt;&gt;(schema);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 732 		arrayOutputStream = new ByteArrayOutputStream();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 733 		encoder = EncoderFactory.get().binaryEncoder(arrayOutputStream, null);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 734 	}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 735 }</span>
 736 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS</pre></td>
                            <td><pre>   1 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
   2 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="   3 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/">   3 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kw🔵</abbr></span>
   4 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">   5 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">   6 /*</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">   7  * Licensed to the Apache Software Foundation (ASF) under one</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">   8  * or more contributor license agreements.  See the NOTICE file</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">   9  * distributed with this work for additional information</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  10  * regarding copyright ownership.  The ASF licenses this file</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  11  * to you under the Apache License, Version 2.0 (the</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  12  * &quot;License&quot;); you may not use this file except in compliance</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  13  * with the License.  You may obtain a copy of the License at</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  14  *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  15  *     http://www.apache.org/licenses/LICENSE-2.0</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  16  *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  17  * Unless required by applicable law or agreed to in writing, software</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  18  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  19  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  20  * See the License for the specific language governing permissions and</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  21  * limitations under the License.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  22  */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  23 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  24 package com.dtstack.flink.sql.sink.kafka.serialization;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  25 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  26 import com.dtstack.flink.sql.enums.EUpdateMode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  27 import org.apache.avro.LogicalType;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  28 import org.apache.avro.LogicalTypes;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  29 import org.apache.avro.Schema;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  30 import org.apache.avro.SchemaParseException;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  31 import org.apache.avro.generic.GenericData;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  32 import org.apache.avro.generic.GenericDatumWriter;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  33 import org.apache.avro.generic.GenericRecord;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  34 import org.apache.avro.generic.IndexedRecord;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  35 import org.apache.avro.io.DatumWriter;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  36 import org.apache.avro.io.Encoder;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  37 import org.apache.avro.io.EncoderFactory;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  38 import org.apache.avro.specific.SpecificData;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  39 import org.apache.avro.specific.SpecificDatumWriter;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  40 import org.apache.avro.specific.SpecificRecord;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  41 import org.apache.avro.util.Utf8;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  42 import org.apache.commons.lang3.StringUtils;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  43 import org.apache.flink.api.common.serialization.SerializationSchema;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  44 import org.apache.flink.table.runtime.types.CRow;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  45 import org.apache.flink.types.Row;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  46 import org.apache.flink.util.Preconditions;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  47 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  48 import java.io.ByteArrayOutputStream;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  49 import java.io.IOException;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  50 import java.io.ObjectInputStream;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  51 import java.io.ObjectOutputStream;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  52 import java.math.BigDecimal;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  53 import java.nio.ByteBuffer;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  54 import java.sql.Date;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  55 import java.sql.Time;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  56 import java.sql.Timestamp;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  57 import java.util.HashMap;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  58 import java.util.List;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  59 import java.util.Map;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  60 import java.util.Objects;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  61 import java.util.TimeZone;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  62 import java.util.stream.Collectors;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  63 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  64 /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  65  * Serialization schema that serializes CROW into Avro bytes.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  66  *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  67  * &lt;p&gt;Serializes objects that are represented in (nested) Flink rows. It support types that</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  68  * are compatible with Flink&#x27;s Table &amp; SQL API.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  69  **</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  70  * @author  maqi</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  71  */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  72 public class AvroCRowSerializationSchema implements SerializationSchema&lt;CRow&gt; {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  73 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  74 	/**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  75 	 * Used for time conversions from SQL types.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  76 	 */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  77 	private static final TimeZone LOCAL_TZ = TimeZone.getDefault();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  78 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  79 	/**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  80 	 * Avro record class for serialization. Might be null if record class is not available.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  81 	 */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  82 	private Class&lt;? extends SpecificRecord&gt; recordClazz;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  83 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  84 	/**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  85 	 * Schema string for deserialization.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  86 	 */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  87 	private String schemaString;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  88 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  89 	/**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  90 	 * Avro serialization schema.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  91 	 */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  92 	private transient Schema schema;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  93 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  94 	/**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  95 	 * Writer to serialize Avro record into a byte array.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  96 	 */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  97 	private transient DatumWriter&lt;IndexedRecord&gt; datumWriter;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  98 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  99 	/**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 100 	 * Output stream to serialize records into byte array.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 101 	 */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 102 	private transient ByteArrayOutputStream arrayOutputStream;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 103 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 104 	/**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 105 	 * Low-level class for serialization of Avro values.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 106 	 */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 107 	private transient Encoder encoder;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 108 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 109 	private String updateMode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 110 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 111 	private String retractKey = &quot;retract&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 112 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 113 	/**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 114 	 * Creates an Avro serialization schema for the given specific record class.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 115 	 *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 116 	 * @param recordClazz Avro record class used to serialize Flink&#x27;s row to Avro&#x27;s record</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 117 	 */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 118 	public AvroCRowSerializationSchema(Class&lt;? extends SpecificRecord&gt; recordClazz, String updateMode) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 119 		Preconditions.checkNotNull(recordClazz, &quot;Avro record class must not be null.&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 120 		this.recordClazz = recordClazz;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 121 		this.schema = SpecificData.get().getSchema(recordClazz);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 122 		this.schemaString = schema.toString();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 123 		this.datumWriter = new SpecificDatumWriter&lt;&gt;(schema);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 124 		this.arrayOutputStream = new ByteArrayOutputStream();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 125 		this.encoder = EncoderFactory.get().binaryEncoder(arrayOutputStream, null);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 126 		this.updateMode = updateMode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 127 	}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 128 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 129 	/**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 130 	 * Creates an Avro serialization schema for the given Avro schema string.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 131 	 *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 132 	 * @param avroSchemaString Avro schema string used to serialize Flink&#x27;s row to Avro&#x27;s record</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 133 	 */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 134 	public AvroCRowSerializationSchema(String avroSchemaString,String updateMode) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 135 		Preconditions.checkNotNull(avroSchemaString, &quot;Avro schema must not be null.&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 136 		this.recordClazz = null;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 137 		this.schemaString = avroSchemaString;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 138 		try {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 139 			this.schema = new Schema.Parser().parse(avroSchemaString);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 140 		} catch (SchemaParseException e) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 141 			throw new IllegalArgumentException(&quot;Could not parse Avro schema string.&quot;, e);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 142 		}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 143 		this.datumWriter = new GenericDatumWriter&lt;&gt;(schema);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 144 		this.arrayOutputStream = new ByteArrayOutputStream();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 145 		this.encoder = EncoderFactory.get().binaryEncoder(arrayOutputStream, null);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 146 		this.updateMode = updateMode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 147 	}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 148 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 149 	@Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 150 	public byte[] serialize(CRow crow) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 151 		try {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 152 			Row row = crow.row();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 153 			boolean change = crow.change();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 154 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 155 			// convert to record</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 156 			final GenericRecord record = convertRowToAvroRecord(schema, row);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 157 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 158 			dealRetractField(change, record);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 159 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 160 			arrayOutputStream.reset();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 161 			datumWriter.write(record, encoder);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 162 			encoder.flush();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 163 			return arrayOutputStream.toByteArray();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 164 		} catch (Exception e) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 165 			throw new RuntimeException(&quot;Failed to serialize row.&quot;, e);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 166 		}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 167 	}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 168 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 169 	protected void dealRetractField(boolean change, GenericRecord record) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 170 		schema.getFields()</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 171 				.stream()</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 172 				.filter(field -&gt; StringUtils.equalsIgnoreCase(field.name(), retractKey))</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 173 				.findFirst()</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 174 				.ifPresent(field -&gt; {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 175 					if (StringUtils.equalsIgnoreCase(updateMode, EUpdateMode.UPSERT.name())) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 176 						record.put(retractKey, convertFlinkType(field.schema(), change));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 177 					}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 178 				});</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 179 	}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 180 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 181 	@Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 182 	public boolean equals(Object o) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 183 		if (this == o) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 184 			return true;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 185 		}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 186 		if (o == null || getClass() != o.getClass()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 187 			return false;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 188 		}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 189 		final AvroCRowSerializationSchema that = (AvroCRowSerializationSchema) o;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 190 		return Objects.equals(recordClazz, that.recordClazz) &amp;&amp; Objects.equals(schemaString, that.schemaString);"> 190 		return Objects.equals(recordClazz, that.recordClazz) &amp;&amp; Objects.equals(schemaString, that.schemaString)🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 191 	}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 192 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 193 	@Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 194 	public int hashCode() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 195 		return Objects.hash(recordClazz, schemaString);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 196 	}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 197 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 198 	// --------------------------------------------------------------------------------------------</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 199 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 200 	private GenericRecord convertRowToAvroRecord(Schema schema, Row row) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 201 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 202 		final List&lt;Schema.Field&gt; fields = schema.getFields()</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 203 				.stream()</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 204 				.filter(field -&gt; !StringUtils.equalsIgnoreCase(field.name(), retractKey))</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 205 				.collect(Collectors.toList());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 206 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 207 		final int length = fields.size();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 208 		final GenericRecord record = new GenericData.Record(schema);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 209 		for (int i = 0; i &lt; length; i++) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 210 			final Schema.Field field = fields.get(i);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 211 			record.put(i, convertFlinkType(field.schema(), row.getField(i)));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 212 		}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 213 		return record;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 214 	}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 215 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 216 	private Object convertFlinkType(Schema schema, Object object) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 217 		if (object == null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 218 			return null;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 219 		}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 220 		switch (schema.getType()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 221 			case RECORD:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 222 				if (object instanceof Row) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 223 					return convertRowToAvroRecord(schema, (Row) object);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 224 				}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 225 				throw new IllegalStateException(&quot;Row expected but was: &quot; + object.getClass());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 226 			case ENUM:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 227 				return new GenericData.EnumSymbol(schema, object.toString());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 228 			case ARRAY:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 229 				final Schema elementSchema = schema.getElementType();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 230 				final Object[] array = (Object[]) object;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 231 				final GenericData.Array&lt;Object&gt; convertedArray = new GenericData.Array&lt;&gt;(array.length, schema);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 232 				for (Object element : array) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 233 					convertedArray.add(convertFlinkType(elementSchema, element));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 234 				}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 235 				return convertedArray;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 236 			case MAP:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 237 				final Map&lt;?, ?&gt; map = (Map&lt;?, ?&gt;) object;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 238 				final Map&lt;Utf8, Object&gt; convertedMap = new HashMap&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 239 				for (Map.Entry&lt;?, ?&gt; entry : map.entrySet()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 240 					convertedMap.put(</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 241 						new Utf8(entry.getKey().toString()),</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 242 						convertFlinkType(schema.getValueType(), entry.getValue()));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 243 				}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 244 				return convertedMap;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 245 			case UNION:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 246 				final List&lt;Schema&gt; types = schema.getTypes();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 247 				final int size = types.size();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 248 				final Schema actualSchema;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 249 				if (size == 2 &amp;&amp; types.get(0).getType() == Schema.Type.NULL) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 250 					actualSchema = types.get(1);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 251 				} else if (size == 2 &amp;&amp; types.get(1).getType() == Schema.Type.NULL) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 252 					actualSchema = types.get(0);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 253 				} else if (size == 1) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 254 					actualSchema = types.get(0);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 255 				} else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 256 					// generic type</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 257 					return object;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 258 				}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 259 				return convertFlinkType(actualSchema, object);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 260 			case FIXED:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 261 				// check for logical type</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 262 				if (object instanceof BigDecimal) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 263 					return new GenericData.Fixed(</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 264 						schema,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 265 						convertFromDecimal(schema, (BigDecimal) object));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 266 				}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 267 				return new GenericData.Fixed(schema, (byte[]) object);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 268 			case STRING:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 269 				return new Utf8(object.toString());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 270 			case BYTES:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 271 				// check for logical type</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 272 				if (object instanceof BigDecimal) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 273 					return ByteBuffer.wrap(convertFromDecimal(schema, (BigDecimal) object));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 274 				}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 275 				return ByteBuffer.wrap((byte[]) object);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 276 			case INT:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 277 				// check for logical types</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 278 				if (object instanceof Date) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 279 					return convertFromDate(schema, (Date) object);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 280 				} else if (object instanceof Time) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 281 					return convertFromTime(schema, (Time) object);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 282 				}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 283 				return object;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 284 			case LONG:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 285 				// check for logical type</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 286 				if (object instanceof Timestamp) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 287 					return convertFromTimestamp(schema, (Timestamp) object);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 288 				}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 289 				return object;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 290 			case FLOAT:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 291 			case DOUBLE:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 292 			case BOOLEAN:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 293 				return object;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 294 			default:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 295 		}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 296 		throw new RuntimeException(&quot;Unsupported Avro type:&quot; + schema);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 297 	}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 298 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 299 	private byte[] convertFromDecimal(Schema schema, BigDecimal decimal) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 300 		final LogicalType logicalType = schema.getLogicalType();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 301 		if (logicalType instanceof LogicalTypes.Decimal) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 302 			final LogicalTypes.Decimal decimalType = (LogicalTypes.Decimal) logicalType;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 303 			// rescale to target type</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 304 			final BigDecimal rescaled = decimal.setScale(decimalType.getScale(), BigDecimal.ROUND_UNNECESSARY);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 305 			// byte array must contain the two&#x27;s-complement representation of the</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 306 			// unscaled integer value in big-endian byte order</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 307 			return decimal.unscaledValue().toByteArray();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 308 		} else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 309 			throw new RuntimeException(&quot;Unsupported decimal type.&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 310 		}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 311 	}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 312 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 313 	private int convertFromDate(Schema schema, Date date) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 314 		final LogicalType logicalType = schema.getLogicalType();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 315 		if (logicalType == LogicalTypes.date()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 316 			// adopted from Apache Calcite</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 317 			final long time = date.getTime();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 318 			final long converted = time + (long) LOCAL_TZ.getOffset(time);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 319 			return (int) (converted / 86400000L);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 320 		} else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 321 			throw new RuntimeException(&quot;Unsupported date type.&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 322 		}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 323 	}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 324 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 325 	private int convertFromTime(Schema schema, Time date) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 326 		final LogicalType logicalType = schema.getLogicalType();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 327 		if (logicalType == LogicalTypes.timeMillis()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 328 			// adopted from Apache Calcite</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 329 			final long time = date.getTime();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 330 			final long converted = time + (long) LOCAL_TZ.getOffset(time);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 331 			return (int) (converted % 86400000L);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 332 		} else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 333 			throw new RuntimeException(&quot;Unsupported time type.&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 334 		}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 335 	}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 336 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 337 	private long convertFromTimestamp(Schema schema, Timestamp date) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 338 		final LogicalType logicalType = schema.getLogicalType();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 339 		if (logicalType == LogicalTypes.timestampMillis()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 340 			// adopted from Apache Calcite</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 341 			final long time = date.getTime();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 342 			return time + (long) LOCAL_TZ.getOffset(time);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 343 		} else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 344 			throw new RuntimeException(&quot;Unsupported timestamp type.&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 345 		}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 346 	}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 347 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 348 	private void writeObject(ObjectOutputStream outputStream) throws IOException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 349 		outputStream.writeObject(recordClazz);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 350 		outputStream.writeObject(schemaString); // support for null</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 351 		outputStream.writeObject(retractKey);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 352 		outputStream.writeObject(updateMode);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 353 	}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 354 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 355 	@SuppressWarnings(&quot;unchecked&quot;)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 356 	private void readObject(ObjectInputStream inputStream) throws ClassNotFoundException, IOException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 357 		recordClazz = (Class&lt;? extends SpecificRecord&gt;) inputStream.readObject();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 358 		schemaString = (String) inputStream.readObject();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 359 		if (recordClazz != null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 360 			schema = SpecificData.get().getSchema(recordClazz);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 361 		} else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 362 			schema = new Schema.Parser().parse(schemaString);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 363 		}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 364 		retractKey = (String) inputStream.readObject();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 365 		updateMode = (String) inputStream.readObject();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 366 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 367 		datumWriter = new SpecificDatumWriter&lt;&gt;(schema);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 368 		arrayOutputStream = new ByteArrayOutputStream();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 369 		encoder = EncoderFactory.get().binaryEncoder(arrayOutputStream, null);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 370 	}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 371 }</span>
 372 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre><span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   1 -/*</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   2 - * Licensed to the Apache Software Foundation (ASF) under one</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   3 - * or more contributor license agreements.  See the NOTICE file</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   4 - * distributed with this work for additional information</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   5 - * regarding copyright ownership.  The ASF licenses this file</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   6 - * to you under the Apache License, Version 2.0 (the</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   7 - * &quot;License&quot;); you may not use this file except in compliance</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   8 - * with the License.  You may obtain a copy of the License at</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   9 - *</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  10 - *     http://www.apache.org/licenses/LICENSE-2.0</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  11 - *</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  12 - * Unless required by applicable law or agreed to in writing, software</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  13 - * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  14 - * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  15 - * See the License for the specific language governing permissions and</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  16 - * limitations under the License.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  17 - */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  18 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  19 -package com.dtstack.flink.sql.sink.kafka.serialization;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  20 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  21 -import com.dtstack.flink.sql.enums.EUpdateMode;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  22 -import org.apache.avro.LogicalType;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  23 -import org.apache.avro.LogicalTypes;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  24 -import org.apache.avro.Schema;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  25 -import org.apache.avro.SchemaParseException;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  26 -import org.apache.avro.generic.GenericData;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  27 -import org.apache.avro.generic.GenericDatumWriter;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  28 -import org.apache.avro.generic.GenericRecord;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  29 -import org.apache.avro.generic.IndexedRecord;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  30 -import org.apache.avro.io.DatumWriter;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  31 -import org.apache.avro.io.Encoder;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  32 -import org.apache.avro.io.EncoderFactory;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  33 -import org.apache.avro.specific.SpecificData;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  34 -import org.apache.avro.specific.SpecificDatumWriter;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  35 -import org.apache.avro.specific.SpecificRecord;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  36 -import org.apache.avro.util.Utf8;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  37 -import org.apache.commons.lang3.StringUtils;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  38 -import org.apache.flink.api.common.serialization.SerializationSchema;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  39 -import org.apache.flink.table.runtime.types.CRow;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  40 -import org.apache.flink.types.Row;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  41 -import org.apache.flink.util.Preconditions;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  42 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  43 -import java.io.ByteArrayOutputStream;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  44 -import java.io.IOException;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  45 -import java.io.ObjectInputStream;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  46 -import java.io.ObjectOutputStream;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  47 -import java.math.BigDecimal;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  48 -import java.nio.ByteBuffer;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  49 -import java.sql.Date;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  50 -import java.sql.Time;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  51 -import java.sql.Timestamp;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  52 -import java.util.HashMap;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  53 -import java.util.List;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  54 -import java.util.Map;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  55 -import java.util.Objects;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  56 -import java.util.Optional;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  57 -import java.util.TimeZone;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  58 -import java.util.stream.Collectors;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  59 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  60 -/**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  61 - * Serialization schema that serializes CROW into Avro bytes.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  62 - *</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  63 - * &lt;p&gt;Serializes objects that are represented in (nested) Flink rows. It support types that</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  64 - * are compatible with Flink&#x27;s Table &amp; SQL API.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  65 - **</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  66 - * @author  maqi</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  67 - */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  68 -public class AvroCRowSerializationSchema implements SerializationSchema&lt;CRow&gt; {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  69 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  70 -	/**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  71 -	 * Used for time conversions from SQL types.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  72 -	 */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  73 -	private static final TimeZone LOCAL_TZ = TimeZone.getDefault();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  74 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  75 -	/**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  76 -	 * Avro record class for serialization. Might be null if record class is not available.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  77 -	 */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  78 -	private Class&lt;? extends SpecificRecord&gt; recordClazz;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  79 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  80 -	/**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  81 -	 * Schema string for deserialization.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  82 -	 */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  83 -	private String schemaString;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  84 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  85 -	/**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  86 -	 * Avro serialization schema.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  87 -	 */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  88 -	private transient Schema schema;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  89 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  90 -	/**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  91 -	 * Writer to serialize Avro record into a byte array.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  92 -	 */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  93 -	private transient DatumWriter&lt;IndexedRecord&gt; datumWriter;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  94 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  95 -	/**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  96 -	 * Output stream to serialize records into byte array.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  97 -	 */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  98 -	private transient ByteArrayOutputStream arrayOutputStream;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  99 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 100 -	/**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 101 -	 * Low-level class for serialization of Avro values.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 102 -	 */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 103 -	private transient Encoder encoder;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 104 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 105 -	private String updateMode;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 106 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 107 -	private String retractKey = &quot;retract&quot;;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 108 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 109 -	/**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 110 -	 * Creates an Avro serialization schema for the given specific record class.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 111 -	 *</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 112 -	 * @param recordClazz Avro record class used to serialize Flink&#x27;s row to Avro&#x27;s record</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 113 -	 */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 114 -	public AvroCRowSerializationSchema(Class&lt;? extends SpecificRecord&gt; recordClazz, String updateMode) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 115 -		Preconditions.checkNotNull(recordClazz, &quot;Avro record class must not be null.&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 116 -		this.recordClazz = recordClazz;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 117 -		this.schema = SpecificData.get().getSchema(recordClazz);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 118 -		this.schemaString = schema.toString();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 119 -		this.datumWriter = new SpecificDatumWriter&lt;&gt;(schema);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 120 -		this.arrayOutputStream = new ByteArrayOutputStream();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 121 -		this.encoder = EncoderFactory.get().binaryEncoder(arrayOutputStream, null);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 122 -		this.updateMode = updateMode;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 123 -	}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 124 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 125 -	/**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 126 -	 * Creates an Avro serialization schema for the given Avro schema string.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 127 -	 *</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 128 -	 * @param avroSchemaString Avro schema string used to serialize Flink&#x27;s row to Avro&#x27;s record</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 129 -	 */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 130 -	public AvroCRowSerializationSchema(String avroSchemaString,String updateMode) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 131 -		Preconditions.checkNotNull(avroSchemaString, &quot;Avro schema must not be null.&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 132 -		this.recordClazz = null;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 133 -		this.schemaString = avroSchemaString;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 134 -		try {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 135 -			this.schema = new Schema.Parser().parse(avroSchemaString);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 136 -		} catch (SchemaParseException e) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 137 -			throw new IllegalArgumentException(&quot;Could not parse Avro schema string.&quot;, e);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 138 -		}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 139 -		this.datumWriter = new GenericDatumWriter&lt;&gt;(schema);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 140 -		this.arrayOutputStream = new ByteArrayOutputStream();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 141 -		this.encoder = EncoderFactory.get().binaryEncoder(arrayOutputStream, null);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 142 -		this.updateMode = updateMode;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 143 -	}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 144 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 145 -	@Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 146 -	public byte[] serialize(CRow crow) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 147 -		try {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 148 -			Row row = crow.row();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 149 -			boolean change = crow.change();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 150 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 151 -			// convert to record</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 152 -			final GenericRecord record = convertRowToAvroRecord(schema, row);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 153 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 154 -			dealRetractField(change, record);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 155 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 156 -			arrayOutputStream.reset();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 157 -			datumWriter.write(record, encoder);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 158 -			encoder.flush();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 159 -			return arrayOutputStream.toByteArray();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 160 -		} catch (Exception e) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 161 -			throw new RuntimeException(&quot;Failed to serialize row.&quot;, e);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 162 -		}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 163 -	}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 164 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 165 -	protected void dealRetractField(boolean change, GenericRecord record) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 166 -		schema.getFields()</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 167 -				.stream()</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 168 -				.filter(field -&gt; StringUtils.equalsIgnoreCase(field.name(), retractKey))</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 169 -				.findFirst()</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 170 -				.ifPresent(field -&gt; {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 171 -					if (StringUtils.equalsIgnoreCase(updateMode, EUpdateMode.UPSERT.name())) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 172 -						record.put(retractKey, convertFlinkType(field.schema(), change));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 173 -					}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 174 -				});</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 175 -	}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 176 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 177 -	@Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 178 -	public boolean equals(Object o) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 179 -		if (this == o) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 180 -			return true;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 181 -		}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 182 -		if (o == null || getClass() != o.getClass()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 183 -			return false;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 184 -		}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 185 -		final AvroCRowSerializationSchema that = (AvroCRowSerializationSchema) o;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 186 -		return Objects.equals(recordClazz, that.recordClazz) &amp;&amp; Objects.equals(schemaString, that.schemaString);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 187 -	}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 188 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 189 -	@Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 190 -	public int hashCode() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 191 -		return Objects.hash(recordClazz, schemaString);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 192 -	}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 193 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 194 -	// --------------------------------------------------------------------------------------------</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 195 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 196 -	private GenericRecord convertRowToAvroRecord(Schema schema, Row row) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 197 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 198 -		final List&lt;Schema.Field&gt; fields = schema.getFields()</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 199 -				.stream()</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 200 -				.filter(field -&gt; !StringUtils.equalsIgnoreCase(field.name(), retractKey))</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 201 -				.collect(Collectors.toList());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 202 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 203 -		final int length = fields.size();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 204 -		final GenericRecord record = new GenericData.Record(schema);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 205 -		for (int i = 0; i &lt; length; i++) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 206 -			final Schema.Field field = fields.get(i);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 207 -			record.put(i, convertFlinkType(field.schema(), row.getField(i)));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 208 -		}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 209 -		return record;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 210 -	}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 211 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 212 -	private Object convertFlinkType(Schema schema, Object object) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 213 -		if (object == null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 214 -			return null;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 215 -		}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 216 -		switch (schema.getType()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 217 -			case RECORD:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 218 -				if (object instanceof Row) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 219 -					return convertRowToAvroRecord(schema, (Row) object);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 220 -				}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 221 -				throw new IllegalStateException(&quot;Row expected but was: &quot; + object.getClass());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 222 -			case ENUM:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 223 -				return new GenericData.EnumSymbol(schema, object.toString());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 224 -			case ARRAY:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 225 -				final Schema elementSchema = schema.getElementType();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 226 -				final Object[] array = (Object[]) object;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 227 -				final GenericData.Array&lt;Object&gt; convertedArray = new GenericData.Array&lt;&gt;(array.length, schema);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 228 -				for (Object element : array) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 229 -					convertedArray.add(convertFlinkType(elementSchema, element));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 230 -				}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 231 -				return convertedArray;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 232 -			case MAP:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 233 -				final Map&lt;?, ?&gt; map = (Map&lt;?, ?&gt;) object;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 234 -				final Map&lt;Utf8, Object&gt; convertedMap = new HashMap&lt;&gt;();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 235 -				for (Map.Entry&lt;?, ?&gt; entry : map.entrySet()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 236 -					convertedMap.put(</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 237 -						new Utf8(entry.getKey().toString()),</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 238 -						convertFlinkType(schema.getValueType(), entry.getValue()));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 239 -				}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 240 -				return convertedMap;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 241 -			case UNION:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 242 -				final List&lt;Schema&gt; types = schema.getTypes();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 243 -				final int size = types.size();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 244 -				final Schema actualSchema;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 245 -				if (size == 2 &amp;&amp; types.get(0).getType() == Schema.Type.NULL) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 246 -					actualSchema = types.get(1);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 247 -				} else if (size == 2 &amp;&amp; types.get(1).getType() == Schema.Type.NULL) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 248 -					actualSchema = types.get(0);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 249 -				} else if (size == 1) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 250 -					actualSchema = types.get(0);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 251 -				} else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 252 -					// generic type</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 253 -					return object;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 254 -				}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 255 -				return convertFlinkType(actualSchema, object);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 256 -			case FIXED:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 257 -				// check for logical type</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 258 -				if (object instanceof BigDecimal) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 259 -					return new GenericData.Fixed(</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 260 -						schema,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 261 -						convertFromDecimal(schema, (BigDecimal) object));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 262 -				}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 263 -				return new GenericData.Fixed(schema, (byte[]) object);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 264 -			case STRING:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 265 -				return new Utf8(object.toString());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 266 -			case BYTES:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 267 -				// check for logical type</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 268 -				if (object instanceof BigDecimal) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 269 -					return ByteBuffer.wrap(convertFromDecimal(schema, (BigDecimal) object));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 270 -				}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 271 -				return ByteBuffer.wrap((byte[]) object);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 272 -			case INT:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 273 -				// check for logical types</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 274 -				if (object instanceof Date) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 275 -					return convertFromDate(schema, (Date) object);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 276 -				} else if (object instanceof Time) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 277 -					return convertFromTime(schema, (Time) object);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 278 -				}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 279 -				return object;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 280 -			case LONG:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 281 -				// check for logical type</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 282 -				if (object instanceof Timestamp) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 283 -					return convertFromTimestamp(schema, (Timestamp) object);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 284 -				}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 285 -				return object;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 286 -			case FLOAT:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 287 -			case DOUBLE:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 288 -			case BOOLEAN:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 289 -				return object;</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 290 -		}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 291 -		throw new RuntimeException(&quot;Unsupported Avro type:&quot; + schema);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 292 -	}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 293 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 294 -	private byte[] convertFromDecimal(Schema schema, BigDecimal decimal) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 295 -		final LogicalType logicalType = schema.getLogicalType();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 296 -		if (logicalType instanceof LogicalTypes.Decimal) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 297 -			final LogicalTypes.Decimal decimalType = (LogicalTypes.Decimal) logicalType;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 298 -			// rescale to target type</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 299 -			final BigDecimal rescaled = decimal.setScale(decimalType.getScale(), BigDecimal.ROUND_UNNECESSARY);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 300 -			// byte array must contain the two&#x27;s-complement representation of the</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 301 -			// unscaled integer value in big-endian byte order</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 302 -			return decimal.unscaledValue().toByteArray();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 303 -		} else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 304 -			throw new RuntimeException(&quot;Unsupported decimal type.&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 305 -		}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 306 -	}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 307 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 308 -	private int convertFromDate(Schema schema, Date date) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 309 -		final LogicalType logicalType = schema.getLogicalType();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 310 -		if (logicalType == LogicalTypes.date()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 311 -			// adopted from Apache Calcite</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 312 -			final long time = date.getTime();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 313 -			final long converted = time + (long) LOCAL_TZ.getOffset(time);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 314 -			return (int) (converted / 86400000L);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 315 -		} else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 316 -			throw new RuntimeException(&quot;Unsupported date type.&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 317 -		}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 318 -	}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 319 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 320 -	private int convertFromTime(Schema schema, Time date) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 321 -		final LogicalType logicalType = schema.getLogicalType();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 322 -		if (logicalType == LogicalTypes.timeMillis()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 323 -			// adopted from Apache Calcite</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 324 -			final long time = date.getTime();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 325 -			final long converted = time + (long) LOCAL_TZ.getOffset(time);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 326 -			return (int) (converted % 86400000L);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 327 -		} else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 328 -			throw new RuntimeException(&quot;Unsupported time type.&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 329 -		}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 330 -	}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 331 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 332 -	private long convertFromTimestamp(Schema schema, Timestamp date) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 333 -		final LogicalType logicalType = schema.getLogicalType();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 334 -		if (logicalType == LogicalTypes.timestampMillis()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 335 -			// adopted from Apache Calcite</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 336 -			final long time = date.getTime();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 337 -			return time + (long) LOCAL_TZ.getOffset(time);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 338 -		} else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 339 -			throw new RuntimeException(&quot;Unsupported timestamp type.&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 340 -		}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 341 -	}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 342 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 343 -	private void writeObject(ObjectOutputStream outputStream) throws IOException {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 344 -		outputStream.writeObject(recordClazz);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 345 -		outputStream.writeObject(schemaString); // support for null</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 346 -		outputStream.writeObject(retractKey);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 347 -		outputStream.writeObject(updateMode);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 348 -	}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 349 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 350 -	@SuppressWarnings(&quot;unchecked&quot;)</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 351 -	private void readObject(ObjectInputStream inputStream) throws ClassNotFoundException, IOException {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 352 -		recordClazz = (Class&lt;? extends SpecificRecord&gt;) inputStream.readObject();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 353 -		schemaString = (String) inputStream.readObject();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 354 -		if (recordClazz != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 355 -			schema = SpecificData.get().getSchema(recordClazz);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 356 -		} else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 357 -			schema = new Schema.Parser().parse(schemaString);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 358 -		}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 359 -		retractKey = (String) inputStream.readObject();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 360 -		updateMode = (String) inputStream.readObject();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 361 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 362 -		datumWriter = new SpecificDatumWriter&lt;&gt;(schema);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 363 -		arrayOutputStream = new ByteArrayOutputStream();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 364 -		encoder = EncoderFactory.get().binaryEncoder(arrayOutputStream, null);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 365 -	}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 366 -}</span></pre></td>
                            <td><pre>   1  /*
   2   * Licensed to the Apache Software Foundation (ASF) under one
   3   * or more contributor license agreements.  See the NOTICE file
   4   * distributed with this work for additional information
   5   * regarding copyright ownership.  The ASF licenses this file
   6   * to you under the Apache License, Version 2.0 (the
   7   * &quot;License&quot;); you may not use this file except in compliance
   8   * with the License.  You may obtain a copy of the License at
   9   *
  10   *     http://www.apache.org/licenses/LICENSE-2.0
  11   *
  12   * Unless required by applicable law or agreed to in writing, software
  13   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15   * See the License for the specific language governing permissions and
  16   * limitations under the License.
  17   */
  18  
  19  package com.dtstack.flink.sql.sink.kafka.serialization;
  20  
  21  import com.dtstack.flink.sql.enums.EUpdateMode;
  22  import org.apache.avro.LogicalType;
  23  import org.apache.avro.LogicalTypes;
  24  import org.apache.avro.Schema;
  25  import org.apache.avro.SchemaParseException;
  26  import org.apache.avro.generic.GenericData;
  27  import org.apache.avro.generic.GenericDatumWriter;
  28  import org.apache.avro.generic.GenericRecord;
  29  import org.apache.avro.generic.IndexedRecord;
  30  import org.apache.avro.io.DatumWriter;
  31  import org.apache.avro.io.Encoder;
  32  import org.apache.avro.io.EncoderFactory;
  33  import org.apache.avro.specific.SpecificData;
  34  import org.apache.avro.specific.SpecificDatumWriter;
  35  import org.apache.avro.specific.SpecificRecord;
  36  import org.apache.avro.util.Utf8;
  37  import org.apache.commons.lang3.StringUtils;
  38  import org.apache.flink.api.common.serialization.SerializationSchema;
  39  import org.apache.flink.table.runtime.types.CRow;
  40  import org.apache.flink.types.Row;
  41  import org.apache.flink.util.Preconditions;
  42  
  43  import java.io.ByteArrayOutputStream;
  44  import java.io.IOException;
  45  import java.io.ObjectInputStream;
  46  import java.io.ObjectOutputStream;
  47  import java.math.BigDecimal;
  48  import java.nio.ByteBuffer;
  49  import java.sql.Date;
  50  import java.sql.Time;
  51  import java.sql.Timestamp;
  52  import java.util.HashMap;
  53  import java.util.List;
  54  import java.util.Map;
  55  import java.util.Objects;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  56 -import java.util.Optional;</span>
  57  import java.util.TimeZone;
  58  import java.util.stream.Collectors;
  59  
  60  /**
  61   * Serialization schema that serializes CROW into Avro bytes.
  62   *
  63   * &lt;p&gt;Serializes objects that are represented in (nested) Flink rows. It support types that
  64   * are compatible with Flink&#x27;s Table &amp; SQL API.
  65   **
  66   * @author  maqi
  67   */
  68  public class AvroCRowSerializationSchema implements SerializationSchema&lt;CRow&gt; {
  69  
  70  	/**
  71  	 * Used for time conversions from SQL types.
  72  	 */
  73  	private static final TimeZone LOCAL_TZ = TimeZone.getDefault();
  74  
  75  	/**
  76  	 * Avro record class for serialization. Might be null if record class is not available.
  77  	 */
  78  	private Class&lt;? extends SpecificRecord&gt; recordClazz;
  79  
  80  	/**
  81  	 * Schema string for deserialization.
  82  	 */
  83  	private String schemaString;
  84  
  85  	/**
  86  	 * Avro serialization schema.
  87  	 */
  88  	private transient Schema schema;
  89  
  90  	/**
  91  	 * Writer to serialize Avro record into a byte array.
  92  	 */
  93  	private transient DatumWriter&lt;IndexedRecord&gt; datumWriter;
  94  
  95  	/**
  96  	 * Output stream to serialize records into byte array.
  97  	 */
  98  	private transient ByteArrayOutputStream arrayOutputStream;
  99  
 100  	/**
 101  	 * Low-level class for serialization of Avro values.
 102  	 */
 103  	private transient Encoder encoder;
 104  
 105  	private String updateMode;
 106  
 107  	private String retractKey = &quot;retract&quot;;
 108  
 109  	/**
 110  	 * Creates an Avro serialization schema for the given specific record class.
 111  	 *
 112  	 * @param recordClazz Avro record class used to serialize Flink&#x27;s row to Avro&#x27;s record
 113  	 */
 114  	public AvroCRowSerializationSchema(Class&lt;? extends SpecificRecord&gt; recordClazz, String updateMode) {
 115  		Preconditions.checkNotNull(recordClazz, &quot;Avro record class must not be null.&quot;);
 116  		this.recordClazz = recordClazz;
 117  		this.schema = SpecificData.get().getSchema(recordClazz);
 118  		this.schemaString = schema.toString();
 119  		this.datumWriter = new SpecificDatumWriter&lt;&gt;(schema);
 120  		this.arrayOutputStream = new ByteArrayOutputStream();
 121  		this.encoder = EncoderFactory.get().binaryEncoder(arrayOutputStream, null);
 122  		this.updateMode = updateMode;
 123  	}
 124  
 125  	/**
 126  	 * Creates an Avro serialization schema for the given Avro schema string.
 127  	 *
 128  	 * @param avroSchemaString Avro schema string used to serialize Flink&#x27;s row to Avro&#x27;s record
 129  	 */
 130  	public AvroCRowSerializationSchema(String avroSchemaString,String updateMode) {
 131  		Preconditions.checkNotNull(avroSchemaString, &quot;Avro schema must not be null.&quot;);
 132  		this.recordClazz = null;
 133  		this.schemaString = avroSchemaString;
 134  		try {
 135  			this.schema = new Schema.Parser().parse(avroSchemaString);
 136  		} catch (SchemaParseException e) {
 137  			throw new IllegalArgumentException(&quot;Could not parse Avro schema string.&quot;, e);
 138  		}
 139  		this.datumWriter = new GenericDatumWriter&lt;&gt;(schema);
 140  		this.arrayOutputStream = new ByteArrayOutputStream();
 141  		this.encoder = EncoderFactory.get().binaryEncoder(arrayOutputStream, null);
 142  		this.updateMode = updateMode;
 143  	}
 144  
 145  	@Override
 146  	public byte[] serialize(CRow crow) {
 147  		try {
 148  			Row row = crow.row();
 149  			boolean change = crow.change();
 150  
 151  			// convert to record
 152  			final GenericRecord record = convertRowToAvroRecord(schema, row);
 153  
 154  			dealRetractField(change, record);
 155  
 156  			arrayOutputStream.reset();
 157  			datumWriter.write(record, encoder);
 158  			encoder.flush();
 159  			return arrayOutputStream.toByteArray();
 160  		} catch (Exception e) {
 161  			throw new RuntimeException(&quot;Failed to serialize row.&quot;, e);
 162  		}
 163  	}
 164  
 165  	protected void dealRetractField(boolean change, GenericRecord record) {
 166  		schema.getFields()
 167  				.stream()
 168  				.filter(field -&gt; StringUtils.equalsIgnoreCase(field.name(), retractKey))
 169  				.findFirst()
 170  				.ifPresent(field -&gt; {
 171  					if (StringUtils.equalsIgnoreCase(updateMode, EUpdateMode.UPSERT.name())) {
 172  						record.put(retractKey, convertFlinkType(field.schema(), change));
 173  					}
 174  				});
 175  	}
 176  
 177  	@Override
 178  	public boolean equals(Object o) {
 179  		if (this == o) {
 180  			return true;
 181  		}
 182  		if (o == null || getClass() != o.getClass()) {
 183  			return false;
 184  		}
 185  		final AvroCRowSerializationSchema that = (AvroCRowSerializationSchema) o;
 186  		return Objects.equals(recordClazz, that.recordClazz) &amp;&amp; Objects.equals(schemaString, that.schemaString);
 187  	}
 188  
 189  	@Override
 190  	public int hashCode() {
 191  		return Objects.hash(recordClazz, schemaString);
 192  	}
 193  
 194  	// --------------------------------------------------------------------------------------------
 195  
 196  	private GenericRecord convertRowToAvroRecord(Schema schema, Row row) {
 197  
 198  		final List&lt;Schema.Field&gt; fields = schema.getFields()
 199  				.stream()
 200  				.filter(field -&gt; !StringUtils.equalsIgnoreCase(field.name(), retractKey))
 201  				.collect(Collectors.toList());
 202  
 203  		final int length = fields.size();
 204  		final GenericRecord record = new GenericData.Record(schema);
 205  		for (int i = 0; i &lt; length; i++) {
 206  			final Schema.Field field = fields.get(i);
 207  			record.put(i, convertFlinkType(field.schema(), row.getField(i)));
 208  		}
 209  		return record;
 210  	}
 211  
 212  	private Object convertFlinkType(Schema schema, Object object) {
 213  		if (object == null) {
 214  			return null;
 215  		}
 216  		switch (schema.getType()) {
 217  			case RECORD:
 218  				if (object instanceof Row) {
 219  					return convertRowToAvroRecord(schema, (Row) object);
 220  				}
 221  				throw new IllegalStateException(&quot;Row expected but was: &quot; + object.getClass());
 222  			case ENUM:
 223  				return new GenericData.EnumSymbol(schema, object.toString());
 224  			case ARRAY:
 225  				final Schema elementSchema = schema.getElementType();
 226  				final Object[] array = (Object[]) object;
 227  				final GenericData.Array&lt;Object&gt; convertedArray = new GenericData.Array&lt;&gt;(array.length, schema);
 228  				for (Object element : array) {
 229  					convertedArray.add(convertFlinkType(elementSchema, element));
 230  				}
 231  				return convertedArray;
 232  			case MAP:
 233  				final Map&lt;?, ?&gt; map = (Map&lt;?, ?&gt;) object;
 234  				final Map&lt;Utf8, Object&gt; convertedMap = new HashMap&lt;&gt;();
 235  				for (Map.Entry&lt;?, ?&gt; entry : map.entrySet()) {
 236  					convertedMap.put(
 237  						new Utf8(entry.getKey().toString()),
 238  						convertFlinkType(schema.getValueType(), entry.getValue()));
 239  				}
 240  				return convertedMap;
 241  			case UNION:
 242  				final List&lt;Schema&gt; types = schema.getTypes();
 243  				final int size = types.size();
 244  				final Schema actualSchema;
 245  				if (size == 2 &amp;&amp; types.get(0).getType() == Schema.Type.NULL) {
 246  					actualSchema = types.get(1);
 247  				} else if (size == 2 &amp;&amp; types.get(1).getType() == Schema.Type.NULL) {
 248  					actualSchema = types.get(0);
 249  				} else if (size == 1) {
 250  					actualSchema = types.get(0);
 251  				} else {
 252  					// generic type
 253  					return object;
 254  				}
 255  				return convertFlinkType(actualSchema, object);
 256  			case FIXED:
 257  				// check for logical type
 258  				if (object instanceof BigDecimal) {
 259  					return new GenericData.Fixed(
 260  						schema,
 261  						convertFromDecimal(schema, (BigDecimal) object));
 262  				}
 263  				return new GenericData.Fixed(schema, (byte[]) object);
 264  			case STRING:
 265  				return new Utf8(object.toString());
 266  			case BYTES:
 267  				// check for logical type
 268  				if (object instanceof BigDecimal) {
 269  					return ByteBuffer.wrap(convertFromDecimal(schema, (BigDecimal) object));
 270  				}
 271  				return ByteBuffer.wrap((byte[]) object);
 272  			case INT:
 273  				// check for logical types
 274  				if (object instanceof Date) {
 275  					return convertFromDate(schema, (Date) object);
 276  				} else if (object instanceof Time) {
 277  					return convertFromTime(schema, (Time) object);
 278  				}
 279  				return object;
 280  			case LONG:
 281  				// check for logical type
 282  				if (object instanceof Timestamp) {
 283  					return convertFromTimestamp(schema, (Timestamp) object);
 284  				}
 285  				return object;
 286  			case FLOAT:
 287  			case DOUBLE:
 288  			case BOOLEAN:
 289  				return object;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 290 +			default:</span>
 291  		}
 292  		throw new RuntimeException(&quot;Unsupported Avro type:&quot; + schema);
 293  	}
 294  
 295  	private byte[] convertFromDecimal(Schema schema, BigDecimal decimal) {
 296  		final LogicalType logicalType = schema.getLogicalType();
 297  		if (logicalType instanceof LogicalTypes.Decimal) {
 298  			final LogicalTypes.Decimal decimalType = (LogicalTypes.Decimal) logicalType;
 299  			// rescale to target type
 300  			final BigDecimal rescaled = decimal.setScale(decimalType.getScale(), BigDecimal.ROUND_UNNECESSARY);
 301  			// byte array must contain the two&#x27;s-complement representation of the
 302  			// unscaled integer value in big-endian byte order
 303  			return decimal.unscaledValue().toByteArray();
 304  		} else {
 305  			throw new RuntimeException(&quot;Unsupported decimal type.&quot;);
 306  		}
 307  	}
 308  
 309  	private int convertFromDate(Schema schema, Date date) {
 310  		final LogicalType logicalType = schema.getLogicalType();
 311  		if (logicalType == LogicalTypes.date()) {
 312  			// adopted from Apache Calcite
 313  			final long time = date.getTime();
 314  			final long converted = time + (long) LOCAL_TZ.getOffset(time);
 315  			return (int) (converted / 86400000L);
 316  		} else {
 317  			throw new RuntimeException(&quot;Unsupported date type.&quot;);
 318  		}
 319  	}
 320  
 321  	private int convertFromTime(Schema schema, Time date) {
 322  		final LogicalType logicalType = schema.getLogicalType();
 323  		if (logicalType == LogicalTypes.timeMillis()) {
 324  			// adopted from Apache Calcite
 325  			final long time = date.getTime();
 326  			final long converted = time + (long) LOCAL_TZ.getOffset(time);
 327  			return (int) (converted % 86400000L);
 328  		} else {
 329  			throw new RuntimeException(&quot;Unsupported time type.&quot;);
 330  		}
 331  	}
 332  
 333  	private long convertFromTimestamp(Schema schema, Timestamp date) {
 334  		final LogicalType logicalType = schema.getLogicalType();
 335  		if (logicalType == LogicalTypes.timestampMillis()) {
 336  			// adopted from Apache Calcite
 337  			final long time = date.getTime();
 338  			return time + (long) LOCAL_TZ.getOffset(time);
 339  		} else {
 340  			throw new RuntimeException(&quot;Unsupported timestamp type.&quot;);
 341  		}
 342  	}
 343  
 344  	private void writeObject(ObjectOutputStream outputStream) throws IOException {
 345  		outputStream.writeObject(recordClazz);
 346  		outputStream.writeObject(schemaString); // support for null
 347  		outputStream.writeObject(retractKey);
 348  		outputStream.writeObject(updateMode);
 349  	}
 350  
 351  	@SuppressWarnings(&quot;unchecked&quot;)
 352  	private void readObject(ObjectInputStream inputStream) throws ClassNotFoundException, IOException {
 353  		recordClazz = (Class&lt;? extends SpecificRecord&gt;) inputStream.readObject();
 354  		schemaString = (String) inputStream.readObject();
 355  		if (recordClazz != null) {
 356  			schema = SpecificData.get().getSchema(recordClazz);
 357  		} else {
 358  			schema = new Schema.Parser().parse(schemaString);
 359  		}
 360  		retractKey = (String) inputStream.readObject();
 361  		updateMode = (String) inputStream.readObject();
 362  
 363  		datumWriter = new SpecificDatumWriter&lt;&gt;(schema);
 364  		arrayOutputStream = new ByteArrayOutputStream();
 365  		encoder = EncoderFactory.get().binaryEncoder(arrayOutputStream, null);
 366  	}
 367  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            