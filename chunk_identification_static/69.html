<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>69</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    69
                    <a href="68.html">prev</a>
                    <a href="70.html">next</a>
                    <a href="69_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    AriaLyy/Aria_99d857f3383c60ae4ae008f74e7d2b32afe9c26a_Aria/src/main/java/com/arialyy/aria/core/AriaManager.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\AriaLyy\Aria show &quot;99d857f3383c60ae4ae008f74e7d2b32afe9c26a:Aria/src/main/java/com/arialyy/aria/core/AriaManager.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\AriaLyy\Aria show &quot;99d857f3383c60ae4ae008f74e7d2b32afe9c26a^1:Aria/src/main/java/com/arialyy/aria/core/AriaManager.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\AriaLyy\Aria show &quot;99d857f3383c60ae4ae008f74e7d2b32afe9c26a^2:Aria/src/main/java/com/arialyy/aria/core/AriaManager.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\AriaLyy\Aria show &quot;41154d47fb8664ddca206122d28b50a6a3b8e9a6:Aria/src/main/java/com/arialyy/aria/core/AriaManager.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[b], [b], [j], [s]], subset: [[b], [bj], [s]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 /*
   2  * Copyright (C) 2016 AriaLyy(https://github.com/AriaLyy/Aria)
   3  *
   4  * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
   5  * you may not use this file except in compliance with the License.
   6  * You may obtain a copy of the License at
   7  *
   8  *      http://www.apache.org/licenses/LICENSE-2.0
   9  *
  10  * Unless required by applicable law or agreed to in writing, software
  11  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  12  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  13  * See the License for the specific language governing permissions and
  14  * limitations under the License.
  15  */
  16 package com.arialyy.aria.core;
  17 
  18 import android.annotation.SuppressLint;
  19 import android.annotation.TargetApi;
  20 import android.app.Activity;
  21 import android.app.Application;
  22 import android.app.Dialog;
  23 import android.app.Service;
  24 import android.content.Context;
  25 import android.os.Build;
  26 import android.os.Bundle;
  27 import android.support.v4.app.Fragment;
  28 import android.text.TextUtils;
  29 import android.util.Log;
  30 import android.widget.PopupWindow;
  31 import com.arialyy.aria.core.download.DownloadEntity;
  32 import com.arialyy.aria.core.download.DownloadReceiver;
  33 import com.arialyy.aria.core.inf.ICmd;
  34 import com.arialyy.aria.core.inf.IReceiver;
  35 import com.arialyy.aria.core.queue.DownloadTaskQueue;
  36 import com.arialyy.aria.core.queue.UploadTaskQueue;
  37 import com.arialyy.aria.core.upload.UploadReceiver;
  38 import com.arialyy.aria.orm.DbEntity;
  39 import com.arialyy.aria.orm.DbUtil;
  40 import com.arialyy.aria.util.CAConfiguration;
  41 import com.arialyy.aria.util.Configuration;
  42 import com.arialyy.aria.util.Speed;
  43 import java.util.ArrayList;
  44 import java.util.HashMap;
  45 import java.util.Iterator;
  46 import java.util.List;
  47 import java.util.Map;
  48 
  49 /**
  50  * Created by lyy on 2016/12/1.
  51  * https://github.com/AriaLyy/Aria
  52  * Aria管理器，任务操作在这里执行
  53  */
  54 @TargetApi(Build.VERSION_CODES.ICE_CREAM_SANDWICH) public class AriaManager {
  55 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  56   private static final    String                  TAG      = &quot;AriaManager&quot;;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  57   private static final    Object                  LOCK     = new Object();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  58   private static volatile AriaManager             INSTANCE = null;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  59   private                 Map&lt;String, AMReceiver&gt; mTargets = new HashMap&lt;&gt;();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  60   private DownloadManager mManager;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  61   private LifeCallback    mLifeCallback;</span>
  62 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  63   private static final String TAG = &quot;AriaManager&quot;;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  64   private static final Object LOCK = new Object();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  65   private static volatile AriaManager INSTANCE = null;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  66   private Map&lt;String, AMReceiver&gt; mTargets = new HashMap&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  67   private DownloadManager mManager;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  68   private LifeCallback mLifeCallback;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  69 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  70   private AriaManager(Context context) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  71     regAppLifeCallback(context);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  72     mManager = DownloadManager.init(context);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  73   }</span>
  74 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  75   private static final String TAG = &quot;AriaManager&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  76   private static final String DOWNLOAD = &quot;_download&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  77   private static final String UPLOAD = &quot;_upload&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  78   private static final Object LOCK = new Object();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  79   @SuppressLint(&quot;StaticFieldLeak&quot;) private static volatile AriaManager INSTANCE = null;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  80   private Map&lt;String, IReceiver&gt; mReceivers = new HashMap&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  81   public static Context APP;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  82   private List&lt;ICmd&gt; mCommands = new ArrayList&lt;&gt;();</span>
  83 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
  84 
  85   private AriaManager(Context context) {
  86     DbUtil.init(context.getApplicationContext());
  87     APP = context.getApplicationContext();
  88     regAppLifeCallback(context);
  89   }
  90 
  91   public static AriaManager getInstance(Context context) {
  92     if (INSTANCE == null) {
  93       synchronized (LOCK) {
  94         INSTANCE = new AriaManager(context);
  95       }
  96     }
  97     return INSTANCE;
  98   }
  99 
 100   public Map&lt;String, IReceiver&gt; getReceiver() {
 101     return mReceivers;
 102   }
 103 
 104   /**
 105    * 设置最大下载速度
 106    */
 107   public void setMaxSpeed(Speed speed) {
 108     Configuration.getInstance().setMaxSpeed(speed);
 109   }
 110 
 111   /**
 112    * 设置命令
 113    */
 114   public AriaManager setCmd(ICmd command) {
 115     mCommands.add(command);
 116     return this;
 117   }
 118 
 119   /**
 120    * 设置一组命令
 121    */
 122   public &lt;T extends ICmd&gt; AriaManager setCmds(List&lt;T&gt; commands) {
 123     if (commands != null &amp;&amp; commands.size() &gt; 0) {
 124       mCommands.addAll(commands);
 125     }
 126     return this;
 127   }
 128 
 129   /**
 130    * 执行所有设置的命令
 131    */
 132   public synchronized void exe() {
 133     for (ICmd command : mCommands) {
 134       command.executeCmd();
 135     }
 136     mCommands.clear();
 137   }
 138 
 139   /**
 140    * 处理下载操作
 141    */
 142   DownloadReceiver download(Object obj) {
 143     IReceiver receiver = mReceivers.get(getKey(true, obj));
 144     if (receiver == null) {
 145       receiver = putReceiver(true, obj);
 146     }
 147     return (receiver instanceof DownloadReceiver) ? (DownloadReceiver) receiver : null;
 148   }
 149 
 150   /**
 151    * 处理上传操作
 152    */
 153   UploadReceiver upload(Object obj) {
 154     IReceiver receiver = mReceivers.get(getKey(false, obj));
 155     if (receiver == null) {
 156       receiver = putReceiver(false, obj);
 157     }
 158     return (receiver instanceof UploadReceiver) ? (UploadReceiver) receiver : null;
 159   }
 160 
 161   /**
 162    * 设置CA证书信息
 163    *
 164    * @param caAlias ca证书别名
 165    * @param caPath assets 文件夹下的ca证书完整路径
 166    */
 167   public void setCAInfo(String caAlias, String caPath) {
 168     if (TextUtils.isEmpty(caAlias)) {
 169       Log.e(TAG, &quot;ca证书别名不能为null&quot;);
 170       return;
 171     } else if (TextUtils.isEmpty(caPath)) {
 172       Log.e(TAG, &quot;ca证书路径不能为null&quot;);
 173       return;
 174     }
 175     CAConfiguration.CA_ALIAS = caAlias;
 176     CAConfiguration.CA_PATH = caPath;
 177   }
 178 
 179   /**
 180    * 设置下载超时时间
 181    */
 182   @Deprecated private AriaManager setTimeOut(int timeOut) {
 183     Configuration.getInstance().setTimeOut(timeOut);
 184     return this;
 185   }
 186 
 187   /**
 188    * 设置失败重试次数
 189    */
 190   public AriaManager setReTryNum(int reTryNum) {
 191     Configuration.getInstance().setReTryNum(reTryNum);
 192     return this;
 193   }
 194 
 195   /**
 196    * 设置失败重试间隔
 197    */
 198   public AriaManager setReTryInterval(int interval) {
 199     Configuration.getInstance().setReTryInterval(interval);
 200     return this;
 201   }
 202 
 203   /**
 204    * 是否打开下载广播
 205    */
 206   public AriaManager openBroadcast(boolean open) {
 207     Configuration.getInstance().setOpenBroadcast(open);
 208     return this;
 209   }
 210 
 211   /**
 212    * 设置最大下载数，最大下载数不能小于1
 213    *
 214    * @param maxDownloadNum 最大下载数
 215    */
 216   public AriaManager setMaxDownloadNum(int maxDownloadNum) {
 217     if (maxDownloadNum &lt; 1) {
 218       Log.w(TAG, &quot;最大任务数不能小于 1&quot;);
 219       return this;
 220     }
 221     DownloadTaskQueue.getInstance().setDownloadNum(maxDownloadNum);
 222     return this;
 223   }
 224 
 225   private IReceiver putReceiver(boolean isDownload, Object obj) {
 226     final String key = getKey(isDownload, obj);
 227     IReceiver receiver = mReceivers.get(key);
 228     final WidgetLiftManager widgetLiftManager = new WidgetLiftManager();
 229     if (obj instanceof Dialog) {
 230       widgetLiftManager.handleDialogLift((Dialog) obj);
 231     } else if (obj instanceof PopupWindow) {
 232       widgetLiftManager.handlePopupWindowLift((PopupWindow) obj);
 233     }
 234 
 235     if (receiver == null) {
 236       if (isDownload) {
 237         DownloadReceiver dReceiver = new DownloadReceiver();
 238         dReceiver.targetName = obj.getClass().getName();
 239         mReceivers.put(key, dReceiver);
 240         receiver = dReceiver;
 241       } else {
 242         UploadReceiver uReceiver = new UploadReceiver();
 243         uReceiver.targetName = obj.getClass().getName();
 244         mReceivers.put(key, uReceiver);
 245         receiver = uReceiver;
 246       }
 247     }
 248     return receiver;
 249   }
 250 
 251   /**
 252    * 根据功能类型和控件类型获取对应的key
 253    */
 254   private String getKey(boolean isDownload, Object obj) {
 255     String clsName = obj.getClass().getName();
 256     String key = &quot;&quot;;
 257     if (!(obj instanceof Activity)) {
 258       if (obj instanceof android.support.v4.app.Fragment) {
 259         key = clsName + &quot;_&quot; + ((Fragment) obj).getActivity().getClass().getName();
 260       } else if (obj instanceof android.app.Fragment) {
 261         key = clsName + &quot;_&quot; + ((android.app.Fragment) obj).getActivity().getClass().getName();
 262       } else if (obj instanceof Dialog) {
 263         Activity activity = ((Dialog) obj).getOwnerActivity();
 264         if (activity != null) {
 265           key = clsName + &quot;_&quot; + activity.getClass().getName();
 266         } else {
 267           key = clsName;
 268         }
 269       } else if (obj instanceof PopupWindow) {
 270         Context context = ((PopupWindow) obj).getContentView().getContext();
 271         if (context instanceof Activity) {
 272           key = clsName + &quot;_&quot; + context.getClass().getName();
 273         } else {
 274           key = clsName;
 275         }
 276 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 277         handlePopupWindowLift((PopupWindow) obj);</span>
 278 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 279         handlePopupWindowLift((PopupWindow) obj);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 280       }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 281     } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 282       key = clsName;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 283     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 284     if (TextUtils.isEmpty(key)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 285       throw new IllegalArgumentException(&quot;未知类型&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 286     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 287     target = mTargets.get(key);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 288     if (target == null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 289       target = new AMReceiver();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 290       target.targetName = obj.getClass().getName();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 291       mTargets.put(key, target);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 292     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 293     return target;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 294   }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 295 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 296   /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 297    * 出来悬浮框取消或dismiss</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 298    */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 299   private void handlePopupWindowLift(PopupWindow popupWindow) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 300     try {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 301       Field dismissField = CommonUtil.getField(popupWindow.getClass(), &quot;mOnDismissListener&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 302       PopupWindow.OnDismissListener listener =</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 303           (PopupWindow.OnDismissListener) dismissField.get(popupWindow);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 304       if (listener != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 305         Log.e(TAG, &quot;你已经对PopupWindow设置了Dismiss事件。为了防止内存泄露，&quot;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 306             + &quot;请在dismiss方法中调用Aria.whit(this).removeSchedulerListener();来注销事件&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 307       } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 308         popupWindow.setOnDismissListener(createPopupWindowListener(popupWindow));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 309       }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 310     } catch (IllegalAccessException e) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 311       e.printStackTrace();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 312     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 313   }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 314 </span>
 315 =======
 316 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 317       } else if (obj instanceof Service) {
 318         key = clsName;
 319       } else if (obj instanceof Application) {
 320         key = clsName;
 321       }
 322     }
 323     if (obj instanceof Activity || obj instanceof Service) {
 324       key = clsName;
 325     } else if (obj instanceof Application) {
 326       key = clsName;
 327     }
 328     if (TextUtils.isEmpty(key)) {
 329       throw new IllegalArgumentException(&quot;未知类型&quot;);
 330     }
 331     key += isDownload ? DOWNLOAD : UPLOAD;
 332     return key;
 333   }
 334 
 335   /**
 336    * 注册APP生命周期回调
 337    */
 338   private void regAppLifeCallback(Context context) {
 339     Context app = context.getApplicationContext();
 340     if (app instanceof Application) {
 341       LifeCallback mLifeCallback = new LifeCallback();
 342       ((Application) app).registerActivityLifecycleCallbacks(mLifeCallback);
 343     }
 344   }
 345 
 346   /**
 347    * onDestroy
 348    */
 349   void destroySchedulerListener(Object obj) {
 350     String clsName = obj.getClass().getName();
 351     for (Iterator&lt;Map.Entry&lt;String, IReceiver&gt;&gt; iter = mReceivers.entrySet().iterator();
 352         iter.hasNext(); ) {
 353       Map.Entry&lt;String, IReceiver&gt; entry = iter.next();
 354       String key = entry.getKey();
 355       if (key.contains(clsName)) {
 356         IReceiver receiver = mReceivers.get(key);
 357         receiver.removeSchedulerListener();
 358         receiver.destroy();
 359         iter.remove();
 360         break;
 361       }
 362     }
 363   }
 364 
 365   /**
 366    * Activity生命周期
 367    */
 368   private class LifeCallback implements Application.ActivityLifecycleCallbacks {
 369 
 370     @Override public void onActivityCreated(Activity activity, Bundle savedInstanceState) {
 371 
 372     }
 373 
 374     @Override public void onActivityStarted(Activity activity) {
 375 
 376     }
 377 
 378     @Override public void onActivityResumed(Activity activity) {
 379 
 380     }
 381 
 382     @Override public void onActivityPaused(Activity activity) {
 383 
 384     }
 385 
 386     @Override public void onActivityStopped(Activity activity) {
 387 
 388     }
 389 
 390     @Override public void onActivitySaveInstanceState(Activity activity, Bundle outState) {
 391 
 392     }
 393 
 394     @Override public void onActivityDestroyed(Activity activity) {
 395       destroySchedulerListener(activity);
 396     }
 397   }
 398 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                            <td><pre>   1 /*
   2  * Copyright (C) 2016 AriaLyy(https://github.com/AriaLyy/Aria)
   3  *
   4  * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
   5  * you may not use this file except in compliance with the License.
   6  * You may obtain a copy of the License at
   7  *
   8  *      http://www.apache.org/licenses/LICENSE-2.0
   9  *
  10  * Unless required by applicable law or agreed to in writing, software
  11  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  12  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  13  * See the License for the specific language governing permissions and
  14  * limitations under the License.
  15  */
  16 package com.arialyy.aria.core;
  17 
  18 import android.annotation.SuppressLint;
  19 import android.annotation.TargetApi;
  20 import android.app.Activity;
  21 import android.app.Application;
  22 import android.app.Dialog;
  23 import android.app.Service;
  24 import android.content.Context;
  25 import android.os.Build;
  26 import android.os.Bundle;
  27 import android.support.v4.app.Fragment;
  28 import android.text.TextUtils;
  29 import android.util.Log;
  30 import android.widget.PopupWindow;
  31 import com.arialyy.aria.core.download.DownloadEntity;
  32 import com.arialyy.aria.core.download.DownloadReceiver;
  33 import com.arialyy.aria.core.inf.ICmd;
  34 import com.arialyy.aria.core.inf.IReceiver;
  35 import com.arialyy.aria.core.queue.DownloadTaskQueue;
  36 import com.arialyy.aria.core.queue.UploadTaskQueue;
  37 import com.arialyy.aria.core.upload.UploadReceiver;
  38 import com.arialyy.aria.orm.DbEntity;
  39 import com.arialyy.aria.orm.DbUtil;
  40 import com.arialyy.aria.util.CAConfiguration;
  41 import com.arialyy.aria.util.Configuration;
  42 import com.arialyy.aria.util.Speed;
  43 import java.util.ArrayList;
  44 import java.util.HashMap;
  45 import java.util.Iterator;
  46 import java.util.List;
  47 import java.util.Map;
  48 
  49 /**
  50  * Created by lyy on 2016/12/1.
  51  * https://github.com/AriaLyy/Aria
  52  * Aria管理器，任务操作在这里执行
  53  */
  54 @TargetApi(Build.VERSION_CODES.ICE_CREAM_SANDWICH) public class AriaManager {
  55   private static final String TAG = &quot;AriaManager&quot;;
  56   private static final String DOWNLOAD = &quot;_download&quot;;
  57   private static final String UPLOAD = &quot;_upload&quot;;
  58   private static final Object LOCK = new Object();
  59   @SuppressLint(&quot;StaticFieldLeak&quot;) private static volatile AriaManager INSTANCE = null;
  60   private Map&lt;String, IReceiver&gt; mReceivers = new HashMap&lt;&gt;();
  61   public static Context APP;
  62   private List&lt;ICmd&gt; mCommands = new ArrayList&lt;&gt;();
  63 
  64   private AriaManager(Context context) {
  65     DbUtil.init(context.getApplicationContext());
  66     APP = context.getApplicationContext();
  67     regAppLifeCallback(context);
  68   }
  69 
  70   public static AriaManager getInstance(Context context) {
  71     if (INSTANCE == null) {
  72       synchronized (LOCK) {
  73         INSTANCE = new AriaManager(context);
  74       }
  75     }
  76     return INSTANCE;
  77   }
  78 
  79   public Map&lt;String, IReceiver&gt; getReceiver() {
  80     return mReceivers;
  81   }
  82 
  83   /**
  84    * 设置最大下载速度
  85    */
  86   public void setMaxSpeed(Speed speed) {
  87     Configuration.getInstance().setMaxSpeed(speed);
  88   }
  89 
  90   /**
  91    * 设置命令
  92    */
  93   public AriaManager setCmd(ICmd command) {
  94     mCommands.add(command);
  95     return this;
  96   }
  97 
  98   /**
  99    * 设置一组命令
 100    */
 101   public &lt;T extends ICmd&gt; AriaManager setCmds(List&lt;T&gt; commands) {
 102     if (commands != null &amp;&amp; commands.size() &gt; 0) {
 103       mCommands.addAll(commands);
 104     }
 105     return this;
 106   }
 107 
 108   /**
 109    * 执行所有设置的命令
 110    */
 111   public synchronized void exe() {
 112     for (ICmd command : mCommands) {
 113       command.executeCmd();
 114     }
 115     mCommands.clear();
 116   }
 117 
 118   /**
 119    * 处理下载操作
 120    */
 121   DownloadReceiver download(Object obj) {
 122     IReceiver receiver = mReceivers.get(getKey(true, obj));
 123     if (receiver == null) {
 124       receiver = putReceiver(true, obj);
 125     }
 126     return (receiver instanceof DownloadReceiver) ? (DownloadReceiver) receiver : null;
 127   }
 128 
 129   /**
 130    * 处理上传操作
 131    */
 132   UploadReceiver upload(Object obj) {
 133     IReceiver receiver = mReceivers.get(getKey(false, obj));
 134     if (receiver == null) {
 135       receiver = putReceiver(false, obj);
 136     }
 137     return (receiver instanceof UploadReceiver) ? (UploadReceiver) receiver : null;
 138   }
 139 
 140   /**
 141    * 设置CA证书信息
 142    *
 143    * @param caAlias ca证书别名
 144    * @param caPath assets 文件夹下的ca证书完整路径
 145    */
 146   public void setCAInfo(String caAlias, String caPath) {
 147     if (TextUtils.isEmpty(caAlias)) {
 148       Log.e(TAG, &quot;ca证书别名不能为null&quot;);
 149       return;
 150     } else if (TextUtils.isEmpty(caPath)) {
 151       Log.e(TAG, &quot;ca证书路径不能为null&quot;);
 152       return;
 153     }
 154     CAConfiguration.CA_ALIAS = caAlias;
 155     CAConfiguration.CA_PATH = caPath;
 156   }
 157 
 158   /**
 159    * 设置下载超时时间
 160    */
 161   @Deprecated private AriaManager setTimeOut(int timeOut) {
 162     Configuration.getInstance().setTimeOut(timeOut);
 163     return this;
 164   }
 165 
 166   /**
 167    * 设置失败重试次数
 168    */
 169   public AriaManager setReTryNum(int reTryNum) {
 170     Configuration.getInstance().setReTryNum(reTryNum);
 171     return this;
 172   }
 173 
 174   /**
 175    * 设置失败重试间隔
 176    */
 177   public AriaManager setReTryInterval(int interval) {
 178     Configuration.getInstance().setReTryInterval(interval);
 179     return this;
 180   }
 181 
 182   /**
 183    * 是否打开下载广播
 184    */
 185   public AriaManager openBroadcast(boolean open) {
 186     Configuration.getInstance().setOpenBroadcast(open);
 187     return this;
 188   }
 189 
 190   /**
 191    * 设置最大下载数，最大下载数不能小于1
 192    *
 193    * @param maxDownloadNum 最大下载数
 194    */
 195   public AriaManager setMaxDownloadNum(int maxDownloadNum) {
 196     if (maxDownloadNum &lt; 1) {
 197       Log.w(TAG, &quot;最大任务数不能小于 1&quot;);
 198       return this;
 199     }
 200     DownloadTaskQueue.getInstance().setDownloadNum(maxDownloadNum);
 201     return this;
 202   }
 203 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 204 private AMReceiver putTarget(Object obj) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 205     String clsName = obj.getClass().getName();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 206     AMReceiver target = null;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 207     String key = &quot;&quot;;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 208     if (!(obj instanceof Activity)) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 209       if (obj instanceof android.support.v4.app.Fragment) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 210         key = clsName + &quot;_&quot; + ((Fragment) obj).getActivity().getClass().getName();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 211       } else if (obj instanceof android.app.Fragment) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 212         key = clsName + &quot;_&quot; + ((android.app.Fragment) obj).getActivity().getClass().getName();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 213       } else if (obj instanceof Dialog) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 214         Activity activity = ((Dialog) obj).getOwnerActivity();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 215         if (activity != null) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 216           key = clsName + &quot;_&quot; + activity.getClass().getName();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 217         } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 218           key = clsName;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 219         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 220         handleDialogLift((Dialog) obj);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 221       } else if (obj instanceof PopupWindow) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 222         Context context = ((PopupWindow) obj).getContentView().getContext();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 223         if (context instanceof Activity) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 224           key = clsName + &quot;_&quot; + context.getClass().getName();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 225         } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 226           key = clsName;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 227         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 228         handlePopupWindowLift((PopupWindow) obj);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 229       } else if (obj instanceof Service) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 230         key = clsName;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 231       } else if (obj instanceof Application) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 232         key = clsName;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 233       }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 234     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 235     if (obj instanceof Activity || obj instanceof Service) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 236       key = clsName;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 237     } else if (obj instanceof Application) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 238       key = clsName;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 239     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 240     if (TextUtils.isEmpty(key)) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 241       throw new IllegalArgumentException(&quot;未知类型&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 242     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 243     target = mTargets.get(key);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 244     if (target == null) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 245       target = new AMReceiver();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 246       target.targetName = obj.getClass().getName();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 247       mTargets.put(key, target);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 248     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 249     return target;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 250   }</span>
 251 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 252 private AMReceiver putTarget(Object obj) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 253     String clsName = obj.getClass().getName();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 254     AMReceiver target = null;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 255     String key = &quot;&quot;;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 256     if (!(obj instanceof Activity)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 257       if (obj instanceof android.support.v4.app.Fragment) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 258         key = clsName + &quot;_&quot; + ((Fragment) obj).getActivity().getClass().getName();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 259       } else if (obj instanceof android.app.Fragment) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 260         key = clsName + &quot;_&quot; + ((android.app.Fragment) obj).getActivity().getClass().getName();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 261       } else if (obj instanceof Dialog) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 262         Activity activity = ((Dialog) obj).getOwnerActivity();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 263         if (activity != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 264           key = clsName + &quot;_&quot; + activity.getClass().getName();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 265         } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 266           key = clsName;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 267         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 268         handleDialogLift((Dialog) obj);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 269       } else if (obj instanceof PopupWindow) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 270         Context context = ((PopupWindow) obj).getContentView().getContext();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 271         if (context instanceof Activity) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 272           key = clsName + &quot;_&quot; + context.getClass().getName();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 273         } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 274           key = clsName;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 275         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 276         handlePopupWindowLift((PopupWindow) obj);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 277       }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 278     } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 279       key = clsName;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 280     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 281     if (TextUtils.isEmpty(key)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 282       throw new IllegalArgumentException(&quot;未知类型&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 283     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 284     target = mTargets.get(key);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 285     if (target == null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 286       target = new AMReceiver();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 287       target.targetName = obj.getClass().getName();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 288       mTargets.put(key, target);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 289     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 290     return target;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 291   }</span>
 292 =======
 293 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 294 
 295 
 296   private IReceiver putReceiver(boolean isDownload, Object obj) {
 297     final String key = getKey(isDownload, obj);
 298     IReceiver receiver = mReceivers.get(key);
 299     final WidgetLiftManager widgetLiftManager = new WidgetLiftManager();
 300     if (obj instanceof Dialog) {
 301       widgetLiftManager.handleDialogLift((Dialog) obj);
 302     } else if (obj instanceof PopupWindow) {
 303       widgetLiftManager.handlePopupWindowLift((PopupWindow) obj);
 304     }
 305 
 306     if (receiver == null) {
 307       if (isDownload) {
 308         DownloadReceiver dReceiver = new DownloadReceiver();
 309         dReceiver.targetName = obj.getClass().getName();
 310         mReceivers.put(key, dReceiver);
 311         receiver = dReceiver;
 312       } else {
 313         UploadReceiver uReceiver = new UploadReceiver();
 314         uReceiver.targetName = obj.getClass().getName();
 315         mReceivers.put(key, uReceiver);
 316         receiver = uReceiver;
 317       }
 318     }
 319     return receiver;
 320   }
 321 
 322   /**
 323    * 根据功能类型和控件类型获取对应的key
 324    */
 325   private String getKey(boolean isDownload, Object obj) {
 326     String clsName = obj.getClass().getName();
 327     String key = &quot;&quot;;
 328     if (!(obj instanceof Activity)) {
 329       if (obj instanceof android.support.v4.app.Fragment) {
 330         key = clsName + &quot;_&quot; + ((Fragment) obj).getActivity().getClass().getName();
 331       } else if (obj instanceof android.app.Fragment) {
 332         key = clsName + &quot;_&quot; + ((android.app.Fragment) obj).getActivity().getClass().getName();
 333       } else if (obj instanceof Dialog) {
 334         Activity activity = ((Dialog) obj).getOwnerActivity();
 335         if (activity != null) {
 336           key = clsName + &quot;_&quot; + activity.getClass().getName();
 337         } else {
 338           key = clsName;
 339         }
 340       } else if (obj instanceof PopupWindow) {
 341         Context context = ((PopupWindow) obj).getContentView().getContext();
 342         if (context instanceof Activity) {
 343           key = clsName + &quot;_&quot; + context.getClass().getName();
 344         } else {
 345           key = clsName;
 346         }
 347       } else if (obj instanceof Service) {
 348         key = clsName;
 349       } else if (obj instanceof Application) {
 350         key = clsName;
 351       }
 352     } else {
 353       key = clsName;
 354     }
 355     if (TextUtils.isEmpty(key)) {
 356       throw new IllegalArgumentException(&quot;未知类型&quot;);
 357     }
 358     key += isDownload ? DOWNLOAD : UPLOAD;
 359     return key;
 360   }
 361 
 362   /**
 363    * 注册APP生命周期回调
 364    */
 365   private void regAppLifeCallback(Context context) {
 366     Context app = context.getApplicationContext();
 367     if (app instanceof Application) {
 368       LifeCallback mLifeCallback = new LifeCallback();
 369       ((Application) app).registerActivityLifecycleCallbacks(mLifeCallback);
 370     }
 371   }
 372 
 373   /**
 374    * onDestroy
 375    */
 376   void destroySchedulerListener(Object obj) {
 377     String clsName = obj.getClass().getName();
 378     for (Iterator&lt;Map.Entry&lt;String, IReceiver&gt;&gt; iter = mReceivers.entrySet().iterator();
 379         iter.hasNext(); ) {
 380       Map.Entry&lt;String, IReceiver&gt; entry = iter.next();
 381       String key = entry.getKey();
 382       if (key.contains(clsName)) {
 383         IReceiver receiver = mReceivers.get(key);
 384         receiver.removeSchedulerListener();
 385         receiver.destroy();
 386         iter.remove();
 387         break;
 388       }
 389     }
 390   }
 391 
 392   /**
 393    * Activity生命周期
 394    */
 395   private class LifeCallback implements Application.ActivityLifecycleCallbacks {
 396 
 397     @Override public void onActivityCreated(Activity activity, Bundle savedInstanceState) {
 398 
 399     }
 400 
 401     @Override public void onActivityStarted(Activity activity) {
 402 
 403     }
 404 
 405     @Override public void onActivityResumed(Activity activity) {
 406 
 407     }
 408 
 409     @Override public void onActivityPaused(Activity activity) {
 410 
 411     }
 412 
 413     @Override public void onActivityStopped(Activity activity) {
 414 
 415     }
 416 
 417     @Override public void onActivitySaveInstanceState(Activity activity, Bundle outState) {
 418 
 419     }
 420 
 421     @Override public void onActivityDestroyed(Activity activity) {
 422       destroySchedulerListener(activity);
 423     }
 424   }
 425 }</pre></td>
                            <td><pre>   1 /*
   2  * Copyright (C) 2016 AriaLyy(https://github.com/AriaLyy/Aria)
   3  *
   4  * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
   5  * you may not use this file except in compliance with the License.
   6  * You may obtain a copy of the License at
   7  *
   8  *      http://www.apache.org/licenses/LICENSE-2.0
   9  *
  10  * Unless required by applicable law or agreed to in writing, software
  11  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  12  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  13  * See the License for the specific language governing permissions and
  14  * limitations under the License.
  15  */
  16 package com.arialyy.aria.core;
  17 
  18 import android.annotation.SuppressLint;
  19 import android.annotation.TargetApi;
  20 import android.app.Activity;
  21 import android.app.Application;
  22 import android.app.Dialog;
  23 import android.app.Service;
  24 import android.content.Context;
  25 import android.os.Build;
  26 import android.os.Bundle;
  27 import android.support.v4.app.Fragment;
  28 import android.text.TextUtils;
  29 import android.util.Log;
  30 import android.widget.PopupWindow;
  31 import com.arialyy.aria.core.download.DownloadEntity;
  32 import com.arialyy.aria.core.download.DownloadReceiver;
  33 import com.arialyy.aria.core.inf.ICmd;
  34 import com.arialyy.aria.core.inf.IReceiver;
  35 import com.arialyy.aria.core.queue.DownloadTaskQueue;
  36 import com.arialyy.aria.core.queue.UploadTaskQueue;
  37 import com.arialyy.aria.core.upload.UploadReceiver;
  38 import com.arialyy.aria.orm.DbEntity;
  39 import com.arialyy.aria.orm.DbUtil;
  40 import com.arialyy.aria.util.CAConfiguration;
  41 import com.arialyy.aria.util.Configuration;
  42 import com.arialyy.aria.util.Speed;
  43 import java.util.ArrayList;
  44 import java.util.HashMap;
  45 import java.util.Iterator;
  46 import java.util.List;
  47 import java.util.Map;
  48 
  49 
  50 /**
  51  * Created by lyy on 2016/12/1.
  52  * https://github.com/AriaLyy/Aria
  53  * Aria管理器，任务操作在这里执行
  54  */
  55 @TargetApi(Build.VERSION_CODES.ICE_CREAM_SANDWICH)
  56 public class AriaManager {
  57   private static final String TAG = &quot;AriaManager&quot;;
  58 
  59   private static final String DOWNLOAD = &quot;_download&quot;;
  60 
  61   private static final String UPLOAD = &quot;_upload&quot;;
  62 
  63   private static final Object LOCK = new Object();
  64 
  65   @SuppressLint(&quot;StaticFieldLeak&quot;)
  66   private static volatile AriaManager INSTANCE = null;
  67 
  68   private Map&lt;String, IReceiver&gt; mReceivers = new HashMap&lt;&gt;();
  69 
  70   public static Context APP;
  71 
  72   private List&lt;ICmd&gt; mCommands = new ArrayList&lt;&gt;();
  73 
  74   private AriaManager(Context context) {
  75     DbUtil.init(context.getApplicationContext());
  76     APP = context.getApplicationContext();
  77     regAppLifeCallback(context);
  78   }
  79 
  80   public static AriaManager getInstance(Context context) {
  81     if (INSTANCE == null) {
  82       synchronized(LOCK) {
  83         INSTANCE = new AriaManager(context);
  84       }
  85     }
  86     return INSTANCE;
  87   }
  88 
  89   public Map&lt;String, IReceiver&gt; getReceiver() {
  90     return mReceivers;
  91   }
  92 
  93   /**
  94    * 设置最大下载速度
  95    */
  96   public void setMaxSpeed(Speed speed) {
  97     Configuration.getInstance().setMaxSpeed(speed);
  98   }
  99 
 100   /**
 101    * 设置命令
 102    */
 103   public AriaManager setCmd(ICmd command) {
 104     mCommands.add(command);
 105     return this;
 106   }
 107 
 108   /**
 109    * 设置一组命令
 110    */
 111   public &lt;T extends ICmd&gt; AriaManager setCmds(List&lt;T&gt; commands) {
 112     if ((commands != null) &amp;&amp; (commands.size() &gt; 0)) {
 113       mCommands.addAll(commands);
 114     }
 115     return this;
 116   }
 117 
 118   /**
 119    * 执行所有设置的命令
 120    */
 121   public synchronized void exe() {
 122     for (ICmd command : mCommands) {
 123       command.executeCmd();
 124     }
 125     mCommands.clear();
 126   }
 127 
 128   /**
 129    * 处理下载操作
 130    */
 131   DownloadReceiver download(Object obj) {
 132     IReceiver receiver = mReceivers.get(getKey(true, obj));
 133     if (receiver == null) {
 134       receiver = putReceiver(true, obj);
 135     }
 136     return receiver instanceof DownloadReceiver ? ((DownloadReceiver) (receiver)) : null;
 137   }
 138 
 139   /**
 140    * 处理上传操作
 141    */
 142   UploadReceiver upload(Object obj) {
 143     IReceiver receiver = mReceivers.get(getKey(false, obj));
 144     if (receiver == null) {
 145       receiver = putReceiver(false, obj);
 146     }
 147     return receiver instanceof UploadReceiver ? ((UploadReceiver) (receiver)) : null;
 148   }
 149 
 150   /**
 151    * 设置CA证书信息
 152    *
 153    * @param caAlias ca证书别名
 154    * @param caPath assets 文件夹下的ca证书完整路径
 155    */
 156   public void setCAInfo(String caAlias, String caPath) {
 157     if (TextUtils.isEmpty(caAlias)) {
 158       Log.e(TAG, &quot;ca证书别名不能为null&quot;);
 159       return;
 160     } else if (TextUtils.isEmpty(caPath)) {
 161       Log.e(TAG, &quot;ca证书路径不能为null&quot;);
 162       return;
 163     }
 164     CAConfiguration.CA_ALIAS = caAlias;
 165     CAConfiguration.CA_PATH = caPath;
 166   }
 167 
 168   /**
 169    * 设置下载超时时间
 170    */
 171   @Deprecated private AriaManager setTimeOut(int timeOut) {
 172     Configuration.getInstance().setTimeOut(timeOut);
 173     return this;
 174   }
 175 
 176   /**
 177    * 设置失败重试次数
 178    */
 179   public AriaManager setReTryNum(int reTryNum) {
 180     Configuration.getInstance().setReTryNum(reTryNum);
 181     return this;
 182   }
 183 
 184   /**
 185    * 设置失败重试间隔
 186    */
 187   public AriaManager setReTryInterval(int interval) {
 188     Configuration.getInstance().setReTryInterval(interval);
 189     return this;
 190   }
 191 
 192   /**
 193    * 是否打开下载广播
 194    */
 195   public AriaManager openBroadcast(boolean open) {
 196     Configuration.getInstance().setOpenBroadcast(open);
 197     return this;
 198   }
 199 
 200   /**
 201    * 设置最大下载数，最大下载数不能小于1
 202    *
 203    * @param maxDownloadNum 最大下载数
 204    */
 205   public AriaManager setMaxDownloadNum(int maxDownloadNum) {
 206     if (maxDownloadNum &lt; 1) {
 207       Log.w(TAG, &quot;最大任务数不能小于 1&quot;);
 208       return this;
 209     }
 210     DownloadTaskQueue.getInstance().setDownloadNum(maxDownloadNum);
 211     return this;
 212   }
 213 
 214   private IReceiver putReceiver(boolean isDownload, Object obj) {
 215     final String key = getKey(isDownload, obj);
 216     IReceiver receiver = mReceivers.get(key);
 217     final WidgetLiftManager widgetLiftManager = new WidgetLiftManager();
 218     if (obj instanceof Dialog) {
 219       widgetLiftManager.handleDialogLift(((Dialog) (obj)));
 220     } else if (obj instanceof PopupWindow) {
 221       widgetLiftManager.handlePopupWindowLift(((PopupWindow) (obj)));
 222     }
 223     if (receiver == null) {
 224       if (isDownload) {
 225         DownloadReceiver dReceiver = new DownloadReceiver();
 226         dReceiver.targetName = obj.getClass().getName();
 227         mReceivers.put(key, dReceiver);
 228         receiver = dReceiver;
 229       } else {
 230         UploadReceiver uReceiver = new UploadReceiver();
 231         uReceiver.targetName = obj.getClass().getName();
 232         mReceivers.put(key, uReceiver);
 233         receiver = uReceiver;
 234       }
 235     }
 236     return receiver;
 237   }
 238 
 239   /**
 240    * 根据功能类型和控件类型获取对应的key
 241    */
 242   private String getKey(boolean isDownload, Object obj) {
 243     String clsName = obj.getClass().getName();
 244     String key = &quot;&quot;;
 245     if (!(obj instanceof Activity)) {
 246       if (obj instanceof Fragment) {
 247         key = (clsName + &quot;_&quot;) + ((Fragment) (obj)).getActivity().getClass().getName();
 248       } else if (obj instanceof android.app.Fragment) {
 249         key = (clsName + &quot;_&quot;) + ((android.app.Fragment) (obj)).getActivity().getClass().getName();
 250       } else if (obj instanceof Dialog) {
 251         Activity activity = ((Dialog) (obj)).getOwnerActivity();
 252         if (activity != null) {
 253           key = (clsName + &quot;_&quot;) + activity.getClass().getName();
 254         } else {
 255           key = clsName;
 256         }
 257       } else if (obj instanceof PopupWindow) {
 258         Context context = ((PopupWindow) (obj)).getContentView().getContext();
 259         if (context instanceof Activity) {
 260           key = (clsName + &quot;_&quot;) + context.getClass().getName();
 261         } else {
 262           key = clsName;
 263         }
 264       } else if (obj instanceof Service) {
 265         key = clsName;
 266       } else if (obj instanceof Application) {
 267 
 268 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 269       key = clsName;</span>
 270 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 271 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 271 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kw🔵</abbr></span>
 272 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 273 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 274         key = clsName;</span>
 275 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 276 
 277       }
 278     }
 279     if ((obj instanceof Activity) || (obj instanceof Service)) {
 280       key = clsName;
 281     } else if (obj instanceof Application) {
 282       key = clsName;
 283     }
 284     if (TextUtils.isEmpty(key)) {
 285       throw new IllegalArgumentException(&quot;未知类型&quot;);
 286     }
 287     key += (isDownload) ? DOWNLOAD : UPLOAD;
 288     return key;
 289   }
 290 
 291   /**
 292    * 注册APP生命周期回调
 293    */
 294   private void regAppLifeCallback(Context context) {
 295     Context app = context.getApplicationContext();
 296     if (app instanceof Application) {
 297       LifeCallback mLifeCallback = new LifeCallback();
 298       ((Application) (app)).registerActivityLifecycleCallbacks(mLifeCallback);
 299     }
 300   }
 301 
 302   /**
 303    * onDestroy
 304    */
 305   void destroySchedulerListener(Object obj) {
 306     String clsName = obj.getClass().getName();
<abbr title=" 307     for (Iterator&lt;Map.Entry&lt;String, IReceiver&gt;&gt; iter = mReceivers.entrySet().iterator(); iter.hasNext();) {"> 307     for (Iterator&lt;Map.Entry&lt;String, IReceiver&gt;&gt; iter = mReceivers.entrySet().iterator(); iter.hasNext();)🔵</abbr>
 308       Map.Entry&lt;String, IReceiver&gt; entry = iter.next();
 309       String key = entry.getKey();
 310       if (key.contains(clsName)) {
 311         IReceiver receiver = mReceivers.get(key);
 312         receiver.removeSchedulerListener();
 313         receiver.destroy();
 314         iter.remove();
 315         break;
 316       }
 317     }
 318   }
 319 
 320   /**
 321    * Activity生命周期
 322    */
 323   private class LifeCallback implements Application.ActivityLifecycleCallbacks {
 324     @Override
 325     public void onActivityCreated(Activity activity, Bundle savedInstanceState) {
 326     }
 327 
 328     @Override
 329     public void onActivityStarted(Activity activity) {
 330     }
 331 
 332     @Override
 333     public void onActivityResumed(Activity activity) {
 334     }
 335 
 336     @Override
 337     public void onActivityPaused(Activity activity) {
 338     }
 339 
 340     @Override
 341     public void onActivityStopped(Activity activity) {
 342     }
 343 
 344     @Override
 345     public void onActivitySaveInstanceState(Activity activity, Bundle outState) {
 346     }
 347 
 348     @Override
 349     public void onActivityDestroyed(Activity activity) {
 350       destroySchedulerListener(activity);
 351     }
 352   }
 353 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  /*
   2   * Copyright (C) 2016 AriaLyy(https://github.com/AriaLyy/Aria)
   3   *
   4   * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
   5   * you may not use this file except in compliance with the License.
   6   * You may obtain a copy of the License at
   7   *
   8   *      http://www.apache.org/licenses/LICENSE-2.0
   9   *
  10   * Unless required by applicable law or agreed to in writing, software
  11   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  12   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  13   * See the License for the specific language governing permissions and
  14   * limitations under the License.
  15   */
  16  package com.arialyy.aria.core;
  17  

  18  import android.annotation.TargetApi;
  19  import android.app.Activity;
  20  import android.app.Application;
  21  import android.app.Dialog;
  22  import android.app.Service;
  23  import android.content.Context;
  24  import android.content.DialogInterface;
  25  import android.os.Build;
  26  import android.os.Bundle;
  27  import android.os.Message;
  28  import android.support.v4.app.Fragment;
  29  import android.text.TextUtils;
  30  import android.util.Log;
  31  import android.widget.PopupWindow;
  32  import com.arialyy.aria.core.command.CmdFactory;









  33  import com.arialyy.aria.util.CAConfiguration;
  34  import com.arialyy.aria.util.CheckUtil;
  35  import com.arialyy.aria.util.CommonUtil;
  36  import com.arialyy.aria.core.command.IDownloadCmd;
  37  import com.arialyy.aria.util.Configuration;
  38  import java.lang.reflect.Field;

  39  import java.util.ArrayList;
  40  import java.util.HashMap;
  41  import java.util.Iterator;
  42  import java.util.List;
  43  import java.util.Map;
  44  import java.util.Set;
  45  
  46  /**
  47   * Created by lyy on 2016/12/1.
  48   * https://github.com/AriaLyy/Aria
  49   * Aria管理器，任务操作在这里执行
  50   */
  51  @TargetApi(Build.VERSION_CODES.ICE_CREAM_SANDWICH) public class AriaManager {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  52 -  private static final String TAG = &quot;AriaManager&quot;;</span>


<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  53 -  private static final Object LOCK = new Object();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  54 -  private static volatile AriaManager INSTANCE = null;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  55 -  private Map&lt;String, AMReceiver&gt; mTargets = new HashMap&lt;&gt;();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  56 +  private static final    String                  TAG      = &quot;AriaManager&quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  57 +  private static final    Object                  LOCK     = new Object();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  58 +  private static volatile AriaManager             INSTANCE = null;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  59 +  private                 Map&lt;String, AMReceiver&gt; mTargets = new HashMap&lt;&gt;();</span>
  60    private DownloadManager mManager;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  61 -  private LifeCallback mLifeCallback;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  62 +  private LifeCallback    mLifeCallback;</span>



  63  
  64    private AriaManager(Context context) {


  65      regAppLifeCallback(context);
  66      mManager = DownloadManager.init(context);
  67    }
  68  
  69    static AriaManager getInstance(Context context) {



  70      if (INSTANCE == null) {
  71        synchronized (LOCK) {
  72          INSTANCE = new AriaManager(context);
  73        }
  74      }
  75      return INSTANCE;
  76    }
  77  
  78    AMReceiver get(Object obj) {
  79      return getTarget(obj);



























































  80    }
  81  
  82    /**
  83     * 设置CA证书信息
  84     *
  85     * @param caAlias ca证书别名
  86     * @param caPath assets 文件夹下的ca证书完整路径
  87     */
  88    public void setCAInfo(String caAlias, String caPath) {
  89      if (TextUtils.isEmpty(caAlias)) {
  90        Log.e(TAG, &quot;ca证书别名不能为null&quot;);
  91        return;
  92      } else if (TextUtils.isEmpty(caPath)) {
  93        Log.e(TAG, &quot;ca证书路径不能为null&quot;);
  94        return;
  95      }
  96      CAConfiguration.CA_ALIAS = caAlias;
  97      CAConfiguration.CA_PATH = caPath;
  98    }
  99  
 100    /**
 101     * 获取下载列表
 102     */
 103    public List&lt;DownloadEntity&gt; getDownloadList() {
 104      return DownloadEntity.findAllData(DownloadEntity.class);
 105    }
 106  
 107    /**
 108     * 通过下载链接获取下载实体
 109     */
 110    public DownloadEntity getDownloadEntity(String downloadUrl) {
 111      CheckUtil.checkDownloadUrl(downloadUrl);
 112      return DownloadEntity.findData(DownloadEntity.class, &quot;downloadUrl=?&quot;, downloadUrl);
 113    }
 114  
 115    /**
 116     * 下载任务是否存在
 117     */
 118    public boolean taskExists(String downloadUrl) {
 119      return DownloadEntity.findData(DownloadEntity.class, &quot;downloadUrl=?&quot;, downloadUrl) != null;
 120    }
 121  
 122    /**
 123     * 停止所有正在执行的任务
 124     */
 125    public void stopAllTask() {
 126      List&lt;DownloadEntity&gt; allEntity = mManager.getAllDownloadEntity();
 127      List&lt;IDownloadCmd&gt; stopCmds = new ArrayList&lt;&gt;();
 128      for (DownloadEntity entity : allEntity) {
 129        if (entity.getState() == DownloadEntity.STATE_DOWNLOAD_ING) {
 130          stopCmds.add(CommonUtil.createCmd(entity, CmdFactory.TASK_STOP));
 131        }
 132      }
 133      mManager.setCmds(stopCmds).exe();
 134    }
 135  
 136    /**
 137     * 设置下载超时时间
 138     */
 139    @Deprecated private AriaManager setTimeOut(int timeOut) {
 140      Configuration.getInstance().setTimeOut(timeOut);
 141      return this;
 142    }
 143  
 144    /**
 145     * 设置下载失败重试次数

 146     */
 147    public AriaManager setReTryNum(int reTryNum) {
 148      Configuration.getInstance().setReTryNum(reTryNum);
 149      return this;
 150    }
 151  
 152    /**
 153     * 设置下载失败重试间隔

 154     */
 155    public AriaManager setReTryInterval(int interval) {
 156      Configuration.getInstance().setReTryInterval(interval);
 157      return this;
 158    }
 159  
 160    /**
 161     * 是否打开下载广播
 162     */
 163    public AriaManager openBroadcast(boolean open) {
 164      Configuration.getInstance().setOpenBroadcast(open);
 165      return this;
 166    }
 167  
 168    /**
 169     * 设置最大下载数，最大下载数不能小于1
 170     *
 171     * @param maxDownloadNum 最大下载数
 172     */
 173    public AriaManager setMaxDownloadNum(int maxDownloadNum) {
 174      if (maxDownloadNum &lt; 1) {
 175        Log.w(TAG, &quot;最大任务数不能小于 1&quot;);
 176        return this;
 177      }
 178      mManager.getTaskQueue().setDownloadNum(maxDownloadNum);
 179      return this;
 180    }
 181  
 182    /**
 183     * 删除所有任务
 184     */
 185    public void cancelAllTask() {
 186      List&lt;DownloadEntity&gt; allEntity = mManager.getAllDownloadEntity();
 187      List&lt;IDownloadCmd&gt; cancelCmds = new ArrayList&lt;&gt;();
 188      for (DownloadEntity entity : allEntity) {
 189        cancelCmds.add(CommonUtil.createCmd(entity, CmdFactory.TASK_CANCEL));
 190      }
 191      mManager.setCmds(cancelCmds).exe();
 192      Set&lt;String&gt; keys = mTargets.keySet();
 193      for (String key : keys) {
 194        AMReceiver target = mTargets.get(key);
 195        target.removeSchedulerListener();
 196        mTargets.remove(key);
 197      }
 198    }
 199  
 200    private AMReceiver putTarget(Object obj) {


































 201      String clsName = obj.getClass().getName();
 202      AMReceiver target = null;
 203      String key = &quot;&quot;;
 204      if (!(obj instanceof Activity)) {
 205        if (obj instanceof android.support.v4.app.Fragment) {
 206          key = clsName + &quot;_&quot; + ((Fragment) obj).getActivity().getClass().getName();
 207        } else if (obj instanceof android.app.Fragment) {
 208          key = clsName + &quot;_&quot; + ((android.app.Fragment) obj).getActivity().getClass().getName();
 209        } else if (obj instanceof Dialog) {
 210          Activity activity = ((Dialog) obj).getOwnerActivity();
 211          if (activity != null) {
 212            key = clsName + &quot;_&quot; + activity.getClass().getName();
 213          } else {
 214            key = clsName;
 215          }
 216          handleDialogLift((Dialog) obj);
 217        } else if (obj instanceof PopupWindow) {
 218          Context context = ((PopupWindow) obj).getContentView().getContext();
 219          if (context instanceof Activity) {
 220            key = clsName + &quot;_&quot; + context.getClass().getName();
 221          } else {
 222            key = clsName;
 223          }
 224          handlePopupWindowLift((PopupWindow) obj);




<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 225 -      }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 226 -    } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 227 +      } else if (obj instanceof Service) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 228 +        key = clsName;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 229 +      } else if (obj instanceof Application) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 230 +        key = clsName;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 231 +      }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 232 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 233 +    if (obj instanceof Activity || obj instanceof Service) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 234 +      key = clsName;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 235 +    } else if (obj instanceof Application) {</span>
 236        key = clsName;
 237      }
 238      if (TextUtils.isEmpty(key)) {
 239        throw new IllegalArgumentException(&quot;未知类型&quot;);
 240      }
 241      target = mTargets.get(key);
 242      if (target == null) {
 243        target = new AMReceiver();
 244        target.targetName = obj.getClass().getName();
 245        mTargets.put(key, target);
 246      }
 247      return target;
 248    }
 249  
 250    /**
 251     * 出来悬浮框取消或dismiss
 252     */
 253    private void handlePopupWindowLift(PopupWindow popupWindow) {
 254      try {
 255        Field dismissField = CommonUtil.getField(popupWindow.getClass(), &quot;mOnDismissListener&quot;);
 256        PopupWindow.OnDismissListener listener =
 257            (PopupWindow.OnDismissListener) dismissField.get(popupWindow);
 258        if (listener != null) {
 259          Log.e(TAG, &quot;你已经对PopupWindow设置了Dismiss事件。为了防止内存泄露，&quot;
 260              + &quot;请在dismiss方法中调用Aria.whit(this).removeSchedulerListener();来注销事件&quot;);
 261        } else {
 262          popupWindow.setOnDismissListener(createPopupWindowListener(popupWindow));
 263        }
 264      } catch (IllegalAccessException e) {
 265        e.printStackTrace();
 266      }
 267    }
 268  
 269    /**
 270     * 创建popupWindow dismiss事件
 271     */
 272    private PopupWindow.OnDismissListener createPopupWindowListener(final PopupWindow popupWindow) {
 273      return new PopupWindow.OnDismissListener() {
 274        @Override public void onDismiss() {
 275          destroySchedulerListener(popupWindow);
 276        }
 277      };
 278    }
 279  
 280    /**
 281     * 处理对话框取消或dismiss
 282     */
 283    private void handleDialogLift(Dialog dialog) {
 284      try {
 285        Field dismissField = CommonUtil.getField(dialog.getClass(), &quot;mDismissMessage&quot;);
 286        Message dismissMsg = (Message) dismissField.get(dialog);
 287        //如果Dialog已经设置Dismiss事件，则查找cancel事件
 288        if (dismissMsg != null) {
 289          Field cancelField = CommonUtil.getField(dialog.getClass(), &quot;mCancelMessage&quot;);
 290          Message cancelMsg = (Message) cancelField.get(dialog);
 291          if (cancelMsg != null) {
 292            Log.e(TAG, &quot;你已经对Dialog设置了Dismiss和cancel事件。为了防止内存泄露，&quot;
 293                + &quot;请在dismiss方法中调用Aria.whit(this).removeSchedulerListener();来注销事件&quot;);
 294          } else {
 295            dialog.setOnCancelListener(createCancelListener());
 296          }
 297        } else {
 298          dialog.setOnDismissListener(createDismissListener());
 299        }
 300      } catch (IllegalAccessException e) {
 301        e.printStackTrace();
 302      }
 303    }
 304  
 305    private AMReceiver getTarget(Object obj) {
 306      AMReceiver target = mTargets.get(obj.getClass().getName());
 307      if (target == null) {
 308        target = putTarget(obj);
 309      }
 310      return target;


 311    }
 312  
 313    /**
 314     * 注册APP生命周期回调
 315     */
 316    private void regAppLifeCallback(Context context) {
 317      Context app = context.getApplicationContext();
 318      if (app instanceof Application) {
 319        mLifeCallback = new LifeCallback();

 320        ((Application) app).registerActivityLifecycleCallbacks(mLifeCallback);
 321      }
 322    }
 323  
 324    /**
 325     * 创建Dialog取消事件
 326     */
 327    private Dialog.OnCancelListener createCancelListener() {
 328      return new Dialog.OnCancelListener() {
 329  
 330        @Override public void onCancel(DialogInterface dialog) {
 331          destroySchedulerListener(dialog);
 332        }
 333      };
 334    }
 335  
 336    /**
 337     * 创建Dialog dismiss取消事件
 338     */
 339    private Dialog.OnDismissListener createDismissListener() {
 340      return new Dialog.OnDismissListener() {
 341  
 342        @Override public void onDismiss(DialogInterface dialog) {
 343          destroySchedulerListener(dialog);
 344        }
 345      };
 346    }
 347  
 348    /**
 349     * onDestroy
 350     */
 351    private void destroySchedulerListener(Object obj) {
 352      Set&lt;String&gt; keys = mTargets.keySet();

 353      String clsName = obj.getClass().getName();
 354      for (Iterator&lt;Map.Entry&lt;String, AMReceiver&gt;&gt; iter = mTargets.entrySet().iterator();

 355          iter.hasNext(); ) {
 356        Map.Entry&lt;String, AMReceiver&gt; entry = iter.next();

 357        String key = entry.getKey();
 358        if (key.equals(clsName) || key.contains(clsName)) {
 359          AMReceiver receiver = mTargets.get(key);
 360          if (receiver.obj != null) {
 361            if (receiver.obj instanceof Application || receiver.obj instanceof Service) break;
 362          }


 363          receiver.removeSchedulerListener();
 364          receiver.destroy();
 365          iter.remove();
 366          break;
 367        }
 368      }
 369    }
 370  
 371    /**
 372     * Activity生命周期
 373     */
 374    private class LifeCallback implements Application.ActivityLifecycleCallbacks {
 375  
 376      @Override public void onActivityCreated(Activity activity, Bundle savedInstanceState) {
 377  
 378      }
 379  
 380      @Override public void onActivityStarted(Activity activity) {
 381  
 382      }
 383  
 384      @Override public void onActivityResumed(Activity activity) {
 385  
 386      }
 387  
 388      @Override public void onActivityPaused(Activity activity) {
 389  
 390      }
 391  
 392      @Override public void onActivityStopped(Activity activity) {
 393  
 394      }
 395  
 396      @Override public void onActivitySaveInstanceState(Activity activity, Bundle outState) {
 397  
 398      }
 399  
 400      @Override public void onActivityDestroyed(Activity activity) {
 401        destroySchedulerListener(activity);
 402      }
 403    }
 404  }</pre></td>
                            <td><pre>   1  /*
   2   * Copyright (C) 2016 AriaLyy(https://github.com/AriaLyy/Aria)
   3   *
   4   * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
   5   * you may not use this file except in compliance with the License.
   6   * You may obtain a copy of the License at
   7   *
   8   *      http://www.apache.org/licenses/LICENSE-2.0
   9   *
  10   * Unless required by applicable law or agreed to in writing, software
  11   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  12   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  13   * See the License for the specific language governing permissions and
  14   * limitations under the License.
  15   */
  16  package com.arialyy.aria.core;
  17  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  18 +import android.annotation.SuppressLint;</span>
  19  import android.annotation.TargetApi;
  20  import android.app.Activity;
  21  import android.app.Application;
  22  import android.app.Dialog;
  23  import android.app.Service;
  24  import android.content.Context;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  25 -import android.content.DialogInterface;</span>
  26  import android.os.Build;
  27  import android.os.Bundle;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  28 -import android.os.Message;</span>
  29  import android.support.v4.app.Fragment;
  30  import android.text.TextUtils;
  31  import android.util.Log;
  32  import android.widget.PopupWindow;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  33 -import com.arialyy.aria.core.command.CmdFactory;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  34 +import com.arialyy.aria.core.download.DownloadEntity;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  35 +import com.arialyy.aria.core.download.DownloadReceiver;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  36 +import com.arialyy.aria.core.inf.ICmd;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  37 +import com.arialyy.aria.core.inf.IReceiver;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  38 +import com.arialyy.aria.core.queue.DownloadTaskQueue;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  39 +import com.arialyy.aria.core.queue.UploadTaskQueue;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  40 +import com.arialyy.aria.core.upload.UploadReceiver;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  41 +import com.arialyy.aria.orm.DbEntity;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  42 +import com.arialyy.aria.orm.DbUtil;</span>
  43  import com.arialyy.aria.util.CAConfiguration;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  44 -import com.arialyy.aria.util.CheckUtil;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  45 -import com.arialyy.aria.util.CommonUtil;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  46 -import com.arialyy.aria.core.command.IDownloadCmd;</span>
  47  import com.arialyy.aria.util.Configuration;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  48 -import java.lang.reflect.Field;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  49 +import com.arialyy.aria.util.Speed;</span>
  50  import java.util.ArrayList;
  51  import java.util.HashMap;
  52  import java.util.Iterator;
  53  import java.util.List;
  54  import java.util.Map;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  55 -import java.util.Set;</span>
  56  
  57  /**
  58   * Created by lyy on 2016/12/1.
  59   * https://github.com/AriaLyy/Aria
  60   * Aria管理器，任务操作在这里执行
  61   */
  62  @TargetApi(Build.VERSION_CODES.ICE_CREAM_SANDWICH) public class AriaManager {
  63    private static final String TAG = &quot;AriaManager&quot;;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  64 +  private static final String DOWNLOAD = &quot;_download&quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  65 +  private static final String UPLOAD = &quot;_upload&quot;;</span>
  66    private static final Object LOCK = new Object();
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  67 -  private static volatile AriaManager INSTANCE = null;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  68 -  private Map&lt;String, AMReceiver&gt; mTargets = new HashMap&lt;&gt;();</span>




<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  69 -  private DownloadManager mManager;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  70 -  private LifeCallback mLifeCallback;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  71 +  @SuppressLint(&quot;StaticFieldLeak&quot;) private static volatile AriaManager INSTANCE = null;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  72 +  private Map&lt;String, IReceiver&gt; mReceivers = new HashMap&lt;&gt;();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  73 +  public static Context APP;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  74 +  private List&lt;ICmd&gt; mCommands = new ArrayList&lt;&gt;();</span>
  75  
  76    private AriaManager(Context context) {
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  77 +    DbUtil.init(context.getApplicationContext());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  78 +    APP = context.getApplicationContext();</span>
  79      regAppLifeCallback(context);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  80 -    mManager = DownloadManager.init(context);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  81 -  }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  82 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  83 -  static AriaManager getInstance(Context context) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  84 +  }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  85 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  86 +  public static AriaManager getInstance(Context context) {</span>
  87      if (INSTANCE == null) {
  88        synchronized (LOCK) {
  89          INSTANCE = new AriaManager(context);
  90        }
  91      }
  92      return INSTANCE;
  93    }
  94  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  95 -  AMReceiver get(Object obj) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  96 -    return getTarget(obj);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  97 +  public Map&lt;String, IReceiver&gt; getReceiver() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  98 +    return mReceivers;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  99 +  }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 100 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 101 +  /**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 102 +   * 设置最大下载速度</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 103 +   */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 104 +  public void setMaxSpeed(Speed speed) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 105 +    Configuration.getInstance().setMaxSpeed(speed);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 106 +  }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 107 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 108 +  /**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 109 +   * 设置命令</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 110 +   */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 111 +  public AriaManager setCmd(ICmd command) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 112 +    mCommands.add(command);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 113 +    return this;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 114 +  }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 115 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 116 +  /**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 117 +   * 设置一组命令</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 118 +   */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 119 +  public &lt;T extends ICmd&gt; AriaManager setCmds(List&lt;T&gt; commands) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 120 +    if (commands != null &amp;&amp; commands.size() &gt; 0) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 121 +      mCommands.addAll(commands);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 122 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 123 +    return this;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 124 +  }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 125 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 126 +  /**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 127 +   * 执行所有设置的命令</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 128 +   */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 129 +  public synchronized void exe() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 130 +    for (ICmd command : mCommands) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 131 +      command.executeCmd();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 132 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 133 +    mCommands.clear();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 134 +  }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 135 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 136 +  /**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 137 +   * 处理下载操作</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 138 +   */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 139 +  DownloadReceiver download(Object obj) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 140 +    IReceiver receiver = mReceivers.get(getKey(true, obj));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 141 +    if (receiver == null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 142 +      receiver = putReceiver(true, obj);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 143 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 144 +    return (receiver instanceof DownloadReceiver) ? (DownloadReceiver) receiver : null;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 145 +  }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 146 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 147 +  /**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 148 +   * 处理上传操作</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 149 +   */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 150 +  UploadReceiver upload(Object obj) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 151 +    IReceiver receiver = mReceivers.get(getKey(false, obj));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 152 +    if (receiver == null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 153 +      receiver = putReceiver(false, obj);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 154 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 155 +    return (receiver instanceof UploadReceiver) ? (UploadReceiver) receiver : null;</span>
 156    }
 157  
 158    /**
 159     * 设置CA证书信息
 160     *
 161     * @param caAlias ca证书别名
 162     * @param caPath assets 文件夹下的ca证书完整路径
 163     */
 164    public void setCAInfo(String caAlias, String caPath) {
 165      if (TextUtils.isEmpty(caAlias)) {
 166        Log.e(TAG, &quot;ca证书别名不能为null&quot;);
 167        return;
 168      } else if (TextUtils.isEmpty(caPath)) {
 169        Log.e(TAG, &quot;ca证书路径不能为null&quot;);
 170        return;
 171      }
 172      CAConfiguration.CA_ALIAS = caAlias;
 173      CAConfiguration.CA_PATH = caPath;
 174    }
 175  
 176    /**
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 177 -   * 获取下载列表</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 178 -   */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 179 -  public List&lt;DownloadEntity&gt; getDownloadList() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 180 -    return DownloadEntity.findAllData(DownloadEntity.class);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 181 -  }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 182 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 183 -  /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 184 -   * 通过下载链接获取下载实体</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 185 -   */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 186 -  public DownloadEntity getDownloadEntity(String downloadUrl) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 187 -    CheckUtil.checkDownloadUrl(downloadUrl);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 188 -    return DownloadEntity.findData(DownloadEntity.class, &quot;downloadUrl=?&quot;, downloadUrl);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 189 -  }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 190 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 191 -  /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 192 -   * 下载任务是否存在</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 193 -   */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 194 -  public boolean taskExists(String downloadUrl) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 195 -    return DownloadEntity.findData(DownloadEntity.class, &quot;downloadUrl=?&quot;, downloadUrl) != null;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 196 -  }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 197 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 198 -  /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 199 -   * 停止所有正在执行的任务</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 200 -   */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 201 -  public void stopAllTask() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 202 -    List&lt;DownloadEntity&gt; allEntity = mManager.getAllDownloadEntity();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 203 -    List&lt;IDownloadCmd&gt; stopCmds = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 204 -    for (DownloadEntity entity : allEntity) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 205 -      if (entity.getState() == DownloadEntity.STATE_DOWNLOAD_ING) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 206 -        stopCmds.add(CommonUtil.createCmd(entity, CmdFactory.TASK_STOP));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 207 -      }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 208 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 209 -    mManager.setCmds(stopCmds).exe();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 210 -  }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 211 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 212 -  /**</span>
 213     * 设置下载超时时间
 214     */
 215    @Deprecated private AriaManager setTimeOut(int timeOut) {
 216      Configuration.getInstance().setTimeOut(timeOut);
 217      return this;
 218    }
 219  
 220    /**
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 221 -   * 设置下载失败重试次数</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 222 +   * 设置失败重试次数</span>
 223     */
 224    public AriaManager setReTryNum(int reTryNum) {
 225      Configuration.getInstance().setReTryNum(reTryNum);
 226      return this;
 227    }
 228  
 229    /**
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 230 -   * 设置下载失败重试间隔</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 231 +   * 设置失败重试间隔</span>
 232     */
 233    public AriaManager setReTryInterval(int interval) {
 234      Configuration.getInstance().setReTryInterval(interval);
 235      return this;
 236    }
 237  
 238    /**
 239     * 是否打开下载广播
 240     */
 241    public AriaManager openBroadcast(boolean open) {
 242      Configuration.getInstance().setOpenBroadcast(open);
 243      return this;
 244    }
 245  
 246    /**
 247     * 设置最大下载数，最大下载数不能小于1
 248     *
 249     * @param maxDownloadNum 最大下载数
 250     */
 251    public AriaManager setMaxDownloadNum(int maxDownloadNum) {
 252      if (maxDownloadNum &lt; 1) {
 253        Log.w(TAG, &quot;最大任务数不能小于 1&quot;);
 254        return this;
 255      }
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 256 -    mManager.getTaskQueue().setDownloadNum(maxDownloadNum);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 257 -    return this;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 258 -  }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 259 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 260 -  /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 261 -   * 删除所有任务</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 262 -   */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 263 -  public void cancelAllTask() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 264 -    List&lt;DownloadEntity&gt; allEntity = mManager.getAllDownloadEntity();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 265 -    List&lt;IDownloadCmd&gt; cancelCmds = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 266 -    for (DownloadEntity entity : allEntity) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 267 -      cancelCmds.add(CommonUtil.createCmd(entity, CmdFactory.TASK_CANCEL));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 268 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 269 -    mManager.setCmds(cancelCmds).exe();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 270 -    Set&lt;String&gt; keys = mTargets.keySet();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 271 -    for (String key : keys) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 272 -      AMReceiver target = mTargets.get(key);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 273 -      target.removeSchedulerListener();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 274 -      mTargets.remove(key);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 275 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 276 -  }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 277 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 278 -  private AMReceiver putTarget(Object obj) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 279 +    DownloadTaskQueue.getInstance().setDownloadNum(maxDownloadNum);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 280 +    return this;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 281 +  }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 282 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 283 +  private IReceiver putReceiver(boolean isDownload, Object obj) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 284 +    final String key = getKey(isDownload, obj);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 285 +    IReceiver receiver = mReceivers.get(key);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 286 +    final WidgetLiftManager widgetLiftManager = new WidgetLiftManager();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 287 +    if (obj instanceof Dialog) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 288 +      widgetLiftManager.handleDialogLift((Dialog) obj);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 289 +    } else if (obj instanceof PopupWindow) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 290 +      widgetLiftManager.handlePopupWindowLift((PopupWindow) obj);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 291 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 292 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 293 +    if (receiver == null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 294 +      if (isDownload) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 295 +        DownloadReceiver dReceiver = new DownloadReceiver();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 296 +        dReceiver.targetName = obj.getClass().getName();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 297 +        mReceivers.put(key, dReceiver);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 298 +        receiver = dReceiver;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 299 +      } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 300 +        UploadReceiver uReceiver = new UploadReceiver();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 301 +        uReceiver.targetName = obj.getClass().getName();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 302 +        mReceivers.put(key, uReceiver);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 303 +        receiver = uReceiver;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 304 +      }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 305 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 306 +    return receiver;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 307 +  }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 308 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 309 +  /**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 310 +   * 根据功能类型和控件类型获取对应的key</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 311 +   */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 312 +  private String getKey(boolean isDownload, Object obj) {</span>
 313      String clsName = obj.getClass().getName();
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 314 -    AMReceiver target = null;</span>
 315      String key = &quot;&quot;;
 316      if (!(obj instanceof Activity)) {
 317        if (obj instanceof android.support.v4.app.Fragment) {
 318          key = clsName + &quot;_&quot; + ((Fragment) obj).getActivity().getClass().getName();
 319        } else if (obj instanceof android.app.Fragment) {
 320          key = clsName + &quot;_&quot; + ((android.app.Fragment) obj).getActivity().getClass().getName();
 321        } else if (obj instanceof Dialog) {
 322          Activity activity = ((Dialog) obj).getOwnerActivity();
 323          if (activity != null) {
 324            key = clsName + &quot;_&quot; + activity.getClass().getName();
 325          } else {
 326            key = clsName;
 327          }
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 328 -        handleDialogLift((Dialog) obj);</span>
 329        } else if (obj instanceof PopupWindow) {
 330          Context context = ((PopupWindow) obj).getContentView().getContext();
 331          if (context instanceof Activity) {
 332            key = clsName + &quot;_&quot; + context.getClass().getName();
 333          } else {
 334            key = clsName;
 335          }
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 336 -        handlePopupWindowLift((PopupWindow) obj);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 337 +      } else if (obj instanceof Service) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 338 +        key = clsName;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 339 +      } else if (obj instanceof Application) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 340 +        key = clsName;</span>
 341        }
 342      } else {









 343        key = clsName;
 344      }
 345      if (TextUtils.isEmpty(key)) {
 346        throw new IllegalArgumentException(&quot;未知类型&quot;);
 347      }
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 348 -    target = mTargets.get(key);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 349 -    if (target == null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 350 -      target = new AMReceiver();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 351 -      target.targetName = obj.getClass().getName();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 352 -      mTargets.put(key, target);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 353 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 354 -    return target;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 355 -  }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 356 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 357 -  /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 358 -   * 出来悬浮框取消或dismiss</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 359 -   */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 360 -  private void handlePopupWindowLift(PopupWindow popupWindow) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 361 -    try {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 362 -      Field dismissField = CommonUtil.getField(popupWindow.getClass(), &quot;mOnDismissListener&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 363 -      PopupWindow.OnDismissListener listener =</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 364 -          (PopupWindow.OnDismissListener) dismissField.get(popupWindow);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 365 -      if (listener != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 366 -        Log.e(TAG, &quot;你已经对PopupWindow设置了Dismiss事件。为了防止内存泄露，&quot;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 367 -            + &quot;请在dismiss方法中调用Aria.whit(this).removeSchedulerListener();来注销事件&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 368 -      } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 369 -        popupWindow.setOnDismissListener(createPopupWindowListener(popupWindow));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 370 -      }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 371 -    } catch (IllegalAccessException e) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 372 -      e.printStackTrace();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 373 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 374 -  }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 375 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 376 -  /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 377 -   * 创建popupWindow dismiss事件</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 378 -   */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 379 -  private PopupWindow.OnDismissListener createPopupWindowListener(final PopupWindow popupWindow) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 380 -    return new PopupWindow.OnDismissListener() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 381 -      @Override public void onDismiss() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 382 -        destroySchedulerListener(popupWindow);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 383 -      }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 384 -    };</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 385 -  }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 386 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 387 -  /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 388 -   * 处理对话框取消或dismiss</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 389 -   */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 390 -  private void handleDialogLift(Dialog dialog) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 391 -    try {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 392 -      Field dismissField = CommonUtil.getField(dialog.getClass(), &quot;mDismissMessage&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 393 -      Message dismissMsg = (Message) dismissField.get(dialog);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 394 -      //如果Dialog已经设置Dismiss事件，则查找cancel事件</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 395 -      if (dismissMsg != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 396 -        Field cancelField = CommonUtil.getField(dialog.getClass(), &quot;mCancelMessage&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 397 -        Message cancelMsg = (Message) cancelField.get(dialog);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 398 -        if (cancelMsg != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 399 -          Log.e(TAG, &quot;你已经对Dialog设置了Dismiss和cancel事件。为了防止内存泄露，&quot;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 400 -              + &quot;请在dismiss方法中调用Aria.whit(this).removeSchedulerListener();来注销事件&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 401 -        } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 402 -          dialog.setOnCancelListener(createCancelListener());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 403 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 404 -      } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 405 -        dialog.setOnDismissListener(createDismissListener());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 406 -      }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 407 -    } catch (IllegalAccessException e) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 408 -      e.printStackTrace();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 409 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 410 -  }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 411 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 412 -  private AMReceiver getTarget(Object obj) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 413 -    AMReceiver target = mTargets.get(obj.getClass().getName());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 414 -    if (target == null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 415 -      target = putTarget(obj);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 416 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 417 -    return target;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 418 +    key += isDownload ? DOWNLOAD : UPLOAD;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 419 +    return key;</span>
 420    }
 421  
 422    /**
 423     * 注册APP生命周期回调
 424     */
 425    private void regAppLifeCallback(Context context) {
 426      Context app = context.getApplicationContext();
 427      if (app instanceof Application) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 428 -      mLifeCallback = new LifeCallback();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 429 +      LifeCallback mLifeCallback = new LifeCallback();</span>
 430        ((Application) app).registerActivityLifecycleCallbacks(mLifeCallback);
 431      }
 432    }
 433  
 434    /**
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 435 -   * 创建Dialog取消事件</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 436 -   */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 437 -  private Dialog.OnCancelListener createCancelListener() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 438 -    return new Dialog.OnCancelListener() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 439 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 440 -      @Override public void onCancel(DialogInterface dialog) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 441 -        destroySchedulerListener(dialog);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 442 -      }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 443 -    };</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 444 -  }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 445 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 446 -  /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 447 -   * 创建Dialog dismiss取消事件</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 448 -   */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 449 -  private Dialog.OnDismissListener createDismissListener() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 450 -    return new Dialog.OnDismissListener() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 451 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 452 -      @Override public void onDismiss(DialogInterface dialog) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 453 -        destroySchedulerListener(dialog);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 454 -      }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 455 -    };</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 456 -  }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 457 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 458 -  /**</span>
 459     * onDestroy
 460     */
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 461 -  private void destroySchedulerListener(Object obj) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 462 -    Set&lt;String&gt; keys = mTargets.keySet();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 463 +  void destroySchedulerListener(Object obj) {</span>
 464      String clsName = obj.getClass().getName();
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 465 -    for (Iterator&lt;Map.Entry&lt;String, AMReceiver&gt;&gt; iter = mTargets.entrySet().iterator();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 466 +    for (Iterator&lt;Map.Entry&lt;String, IReceiver&gt;&gt; iter = mReceivers.entrySet().iterator();</span>
 467          iter.hasNext(); ) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 468 -      Map.Entry&lt;String, AMReceiver&gt; entry = iter.next();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 469 +      Map.Entry&lt;String, IReceiver&gt; entry = iter.next();</span>
 470        String key = entry.getKey();
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 471 -      if (key.equals(clsName) || key.contains(clsName)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 472 -        AMReceiver receiver = mTargets.get(key);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 473 -        if (receiver.obj != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 474 -          if (receiver.obj instanceof Application || receiver.obj instanceof Service) break;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 475 -        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 476 +      if (key.contains(clsName)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 477 +        IReceiver receiver = mReceivers.get(key);</span>
 478          receiver.removeSchedulerListener();
 479          receiver.destroy();
 480          iter.remove();
 481          break;
 482        }
 483      }
 484    }
 485  
 486    /**
 487     * Activity生命周期
 488     */
 489    private class LifeCallback implements Application.ActivityLifecycleCallbacks {
 490  
 491      @Override public void onActivityCreated(Activity activity, Bundle savedInstanceState) {
 492  
 493      }
 494  
 495      @Override public void onActivityStarted(Activity activity) {
 496  
 497      }
 498  
 499      @Override public void onActivityResumed(Activity activity) {
 500  
 501      }
 502  
 503      @Override public void onActivityPaused(Activity activity) {
 504  
 505      }
 506  
 507      @Override public void onActivityStopped(Activity activity) {
 508  
 509      }
 510  
 511      @Override public void onActivitySaveInstanceState(Activity activity, Bundle outState) {
 512  
 513      }
 514  
 515      @Override public void onActivityDestroyed(Activity activity) {
 516        destroySchedulerListener(activity);
 517      }
 518    }
 519  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            