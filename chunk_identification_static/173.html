<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>173</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    173
                    <a href="172.html">prev</a>
                    <a href="174.html">next</a>
                    <a href="173_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    Automattic/simplenote-android_12c60328392c6fd67cc346686fa3e378134e73cf_Simplenote/src/main/java/com/automattic/simplenote/NotesActivity.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;12c60328392c6fd67cc346686fa3e378134e73cf:Simplenote/src/main/java/com/automattic/simplenote/NotesActivity.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;12c60328392c6fd67cc346686fa3e378134e73cf^1:Simplenote/src/main/java/com/automattic/simplenote/NotesActivity.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;12c60328392c6fd67cc346686fa3e378134e73cf^2:Simplenote/src/main/java/com/automattic/simplenote/NotesActivity.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;448dcf036249b943a729aa9c18b62998b9620bfa:Simplenote/src/main/java/com/automattic/simplenote/NotesActivity.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[bj]], subset: [[bj]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 package com.automattic.simplenote;
   2 
   3 import android.app.Activity;
   4 import android.app.AlertDialog;
   5 import android.content.DialogInterface;
   6 import android.content.Intent;
   7 import android.content.SharedPreferences;
   8 import android.content.res.Configuration;
   9 import android.os.AsyncTask;
  10 import android.os.Build;
  11 import android.os.Bundle;
  12 import android.os.Handler;
  13 import android.support.design.widget.NavigationView;
  14 import android.support.v4.app.FragmentManager;
  15 import android.support.v4.app.FragmentTransaction;
  16 import android.support.v4.content.ContextCompat;
  17 import android.support.v4.view.GravityCompat;
  18 import android.support.v4.widget.DrawerLayout;
  19 import android.support.v7.app.ActionBar;
  20 import android.support.v7.app.ActionBarDrawerToggle;
  21 import android.support.v7.app.AppCompatActivity;
  22 import android.support.v7.preference.PreferenceManager;
  23 import android.support.v7.widget.SearchView;
  24 import android.support.v7.widget.Toolbar;
  25 import android.text.Spannable;
  26 import android.text.SpannableString;
  27 import android.text.TextUtils;
  28 import android.view.Menu;
  29 import android.view.MenuInflater;
  30 import android.view.MenuItem;
  31 import android.view.View;
  32 import android.view.WindowInsets;
  33 import android.view.WindowManager;
  34 import android.widget.AdapterView;
  35 import android.widget.LinearLayout;
  36 import android.widget.ListView;
  37 import android.widget.ProgressBar;
  38 
  39 import com.automattic.simplenote.analytics.AnalyticsTracker;
  40 import com.automattic.simplenote.models.Note;
  41 import com.automattic.simplenote.models.Tag;
  42 import com.automattic.simplenote.utils.DisplayUtils;
  43 import com.automattic.simplenote.utils.DrawableUtils;
  44 import com.automattic.simplenote.utils.HtmlCompat;
  45 import com.automattic.simplenote.utils.PrefUtils;
  46 import com.automattic.simplenote.utils.StrUtils;
  47 import com.automattic.simplenote.utils.TagsAdapter;
  48 import com.automattic.simplenote.utils.ThemeUtils;
  49 import com.automattic.simplenote.utils.UndoBarController;
  50 import com.automattic.simplenote.widgets.TypefaceSpan;
  51 import com.simperium.Simperium;
  52 import com.simperium.client.Bucket;
  53 import com.simperium.client.BucketObjectMissingException;
  54 import com.simperium.client.BucketObjectNameInvalid;
  55 import com.simperium.client.Query;
  56 import com.simperium.client.User;
  57 
  58 import org.wordpress.passcodelock.AppLockManager;
  59 
  60 import java.util.ArrayList;
  61 import java.util.Calendar;
  62 import java.util.List;
  63 
  64 import static com.automattic.simplenote.utils.DisplayUtils.disableScreenshotsIfLocked;
  65 
  66 public class NotesActivity extends AppCompatActivity implements
<abbr title="  67         NoteListFragment.Callbacks, User.StatusChangeListener, Simperium.OnUserCreatedListener, UndoBarController.UndoListener,">  67         NoteListFragment.Callbacks, User.StatusChangeListener, Simperium.OnUserCreatedListener, UndoBarCoðŸ”µ</abbr>
  68         Bucket.Listener&lt;Note&gt; {
  69 
  70     public static String TAG_NOTE_LIST = &quot;noteList&quot;;
  71     public static String TAG_NOTE_EDITOR = &quot;noteEditor&quot;;
  72     protected Bucket&lt;Note&gt; mNotesBucket;
  73     protected Bucket&lt;Tag&gt; mTagsBucket;
  74     private int TRASH_SELECTED_ID = 1;
  75     private boolean mIsShowingMarkdown;
  76     private boolean mShouldSelectNewNote;
  77 
  78     private String mTabletSearchQuery;
  79     private UndoBarController mUndoBarController;
  80     private View mFragmentsContainer;
  81     private SearchView mSearchView;
  82     private MenuItem mSearchMenuItem;
  83     private NoteListFragment mNoteListFragment;
  84     private NoteEditorFragment mNoteEditorFragment;
  85     private Note mCurrentNote;
  86     private MenuItem mEmptyTrashMenuItem;
  87 
  88     // Menu drawer
  89     private DrawerLayout mDrawerLayout;
  90     private ListView mDrawerList;
  91     private NavigationView mNavigationView;
  92     private ActionBarDrawerToggle mDrawerToggle;
  93     private TagsAdapter mTagsAdapter;
  94     private TagsAdapter.TagMenuItem mSelectedTag;
  95     // Tags bucket listener
  96     private Bucket.Listener&lt;Tag&gt; mTagsMenuUpdater = new Bucket.Listener&lt;Tag&gt;() {
  97         void updateNavigationDrawer() {
  98             runOnUiThread(new Runnable() {
  99                 public void run() {
 100                     updateNavigationDrawerItems();
 101                 }
 102             });
 103         }
 104 
 105         @Override
 106         public void onSaveObject(Bucket&lt;Tag&gt; bucket, Tag tag) {
 107             updateNavigationDrawer();
 108         }
 109 
 110         @Override
 111         public void onDeleteObject(Bucket&lt;Tag&gt; bucket, Tag tag) {
 112             updateNavigationDrawer();
 113         }
 114 
 115         @Override
 116         public void onNetworkChange(Bucket&lt;Tag&gt; bucket, Bucket.ChangeType type, String key) {
 117             updateNavigationDrawer();
 118         }
 119 
 120         @Override
 121         public void onBeforeUpdateObject(Bucket&lt;Tag&gt; bucket, Tag object) {
 122             // noop
 123         }
 124     };
 125 
 126     @Override
 127     protected void onCreate(Bundle savedInstanceState) {
 128         // On lollipop, configure the translucent status bar
 129         if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.LOLLIPOP) {
 130             getWindow().addFlags(WindowManager.LayoutParams.FLAG_DRAWS_SYSTEM_BAR_BACKGROUNDS);
 131 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 132             getWindow().setStatusBarColor(ContextCompat.getColor(this, android.R.color.transparent));</span>
 133 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 134             getWindow().setStatusBarColor(ContextCompat.getColor(this, R.color.transparent));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 135         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 136 </span>
 137 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 138             getWindow().setStatusBarColor(ContextCompat.getColor(this, R.color.translucent_grey_medium_light));"> 138             getWindow().setStatusBarColor(ContextCompat.getColor(this, R.color.translucent_grey_medium_liðŸ”µ</abbr></span>
 139 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 140         }
 141 
 142         ThemeUtils.setTheme(this);
 143         super.onCreate(savedInstanceState);
 144 
 145         setContentView(R.layout.activity_notes);
 146 
 147         mFragmentsContainer = findViewById(R.id.note_fragment_container);
 148 
 149         Simplenote currentApp = (Simplenote) getApplication();
 150         if (mNotesBucket == null) {
 151             mNotesBucket = currentApp.getNotesBucket();
 152         }
 153 
 154         if (mTagsBucket == null) {
 155             mTagsBucket = currentApp.getTagsBucket();
 156         }
 157 
 158         Toolbar toolbar = findViewById(R.id.toolbar);
 159         setSupportActionBar(toolbar);
 160         configureNavigationDrawer(toolbar);
 161 
 162         if (savedInstanceState == null) {
 163             mNoteListFragment = new NoteListFragment();
 164             FragmentTransaction fragmentTransaction = getSupportFragmentManager().beginTransaction();
 165             fragmentTransaction.add(R.id.note_fragment_container, mNoteListFragment, TAG_NOTE_LIST);
 166             fragmentTransaction.commit();
 167         } else {
<abbr title=" 168             mNoteListFragment = (NoteListFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_LIST);"> 168             mNoteListFragment = (NoteListFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTEðŸ”µ</abbr>
 169         }
 170 
 171         if (DisplayUtils.isLargeScreen(this)) {
 172             if (getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR) != null) {
<abbr title=" 173                 mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR);"> 173                 mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByTag(ðŸ”µ</abbr>
 174             } else if (DisplayUtils.isLandscape(this)) {
 175                 addEditorFragment();
 176             }
 177         }
 178 
 179         // enable ActionBar app icon to behave as action to toggle nav drawer
 180         ActionBar actionBar = getSupportActionBar();
 181         if (actionBar != null) {
 182             actionBar.setDisplayHomeAsUpEnabled(true);
 183             actionBar.setHomeButtonEnabled(true);
 184 
 185             // Add loading indicator to show when indexing
<abbr title=" 186             ProgressBar progressBar = (ProgressBar) getLayoutInflater().inflate(R.layout.progressbar_toolbar, null);"> 186             ProgressBar progressBar = (ProgressBar) getLayoutInflater().inflate(R.layout.progressbar_toolðŸ”µ</abbr>
 187             actionBar.setDisplayShowCustomEnabled(true);
 188             actionBar.setCustomView(progressBar);
 189             setToolbarProgressVisibility(false);
 190         }
 191 
 192         mUndoBarController = new UndoBarController(this);
 193 
 194         // Creates &#x27;Welcome&#x27; note
 195         checkForFirstLaunch();
 196 
 197         checkForSharedContent();
 198 
 199         currentApp.getSimperium().setOnUserCreatedListener(this);
 200         currentApp.getSimperium().setUserStatusChangeListener(this);
 201     }
 202 
 203     @Override
 204     protected void onResume() {
 205         super.onResume();
 206 
 207         // Ensure user has valid authorization
 208         if (userAuthenticationIsInvalid()) {
 209             startLoginActivity(true);
 210         }
 211 
 212         disableScreenshotsIfLocked(this);
 213 
 214         mNotesBucket.start();
 215         mTagsBucket.start();
 216 
 217         mNotesBucket.addOnNetworkChangeListener(this);
 218         mNotesBucket.addOnSaveObjectListener(this);
 219         mNotesBucket.addOnDeleteObjectListener(this);
 220         mTagsBucket.addListener(mTagsMenuUpdater);
 221 
 222         updateNavigationDrawerItems();
 223 
 224         // if the user is not authenticated and the tag doesn&#x27;t exist revert to default drawer selection
 225         if (userIsUnauthorized()) {
 226             if (-1 == mTagsAdapter.getPosition(mSelectedTag)) {
 227                 mSelectedTag = null;
 228                 mDrawerList.setSelection(TagsAdapter.DEFAULT_ITEM_POSITION);
 229             }
 230         }
 231 
 232         setSelectedTagActive();
 233 
 234         if (mCurrentNote != null &amp;&amp; mShouldSelectNewNote) {
 235             onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled());
 236             mShouldSelectNewNote = false;
 237         }
 238 
 239         if (mIsShowingMarkdown) {
 240             setMarkdownShowing(false);
 241         }
 242 
 243     }
 244 
 245     @Override
 246     protected void onPause() {
 247         super.onPause();  // Always call the superclass method first
 248         mTagsBucket.removeListener(mTagsMenuUpdater);
 249         mTagsBucket.stop();
 250 
 251         mNotesBucket.removeOnNetworkChangeListener(this);
 252         mNotesBucket.removeOnSaveObjectListener(this);
 253         mNotesBucket.removeOnDeleteObjectListener(this);
 254         mNotesBucket.stop();
 255     }
 256 
 257     @Override
 258     public void setTitle(CharSequence title) {
 259         if (title == null) {
 260             title = &quot;&quot;;
 261         }
 262 
 263         setTitleWithCustomFont(title);
 264     }
 265 
 266     @Override
 267     public void onBackPressed() {
 268         if (mDrawerLayout != null &amp;&amp; mDrawerLayout.isDrawerOpen(GravityCompat.START)) {
 269             mDrawerLayout.closeDrawer(GravityCompat.START);
 270         } else {
 271             super.onBackPressed();
 272         }
 273     }
 274 
 275     private void setTitleWithCustomFont(CharSequence title) {
 276         if (getSupportActionBar() == null) return;
 277 
 278         // LG devices running 4.1 can&#x27;t handle a custom font in the action bar title
 279         if ((!TextUtils.isEmpty(Build.BRAND) &amp;&amp; Build.BRAND.toLowerCase().contains(&quot;lge&quot;))
 280                 &amp;&amp; Build.VERSION.SDK_INT &lt;= Build.VERSION_CODES.JELLY_BEAN) {
 281             getSupportActionBar().setTitle(title);
 282             return;
 283         }
 284 
 285         SpannableString s = new SpannableString(title);
 286         s.setSpan(new TypefaceSpan(this), 0, s.length(), Spannable.SPAN_EXCLUSIVE_EXCLUSIVE);
 287         getSupportActionBar().setTitle(s);
 288     }
 289 
 290     private void configureNavigationDrawer(Toolbar toolbar) {
 291         mDrawerLayout = findViewById(R.id.drawer_layout);
 292         mDrawerLayout.setDrawerShadow(R.drawable.drawer_shadow, GravityCompat.START);
 293         mNavigationView = findViewById(R.id.navigation_view);
 294         mDrawerList = findViewById(R.id.drawer_list);
 295 
 296         if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.LOLLIPOP) {
 297             mNavigationView.setOnApplyWindowInsetsListener(new View.OnApplyWindowInsetsListener() {
 298                 @Override
 299                 public WindowInsets onApplyWindowInsets(View view, WindowInsets windowInsets) {
 300                     LinearLayout drawerView = findViewById(R.id.drawer_view);
 301                     drawerView.setPadding(
 302                             drawerView.getPaddingLeft(),
 303                             windowInsets.getSystemWindowInsetTop(),
 304                             drawerView.getPaddingRight(),
 305                             drawerView.getPaddingBottom());
 306 
 307                     return windowInsets.consumeSystemWindowInsets();
 308                 }
 309             });
 310         }
 311 
 312         View settingsButton = findViewById(R.id.nav_settings);
 313         settingsButton.setOnClickListener(new View.OnClickListener() {
 314             @Override
 315             public void onClick(View v) {
 316                 Intent i = new Intent(NotesActivity.this, PreferencesActivity.class);
 317                 startActivityForResult(i, Simplenote.INTENT_PREFERENCES);
 318             }
 319         });
 320 
 321         mNavigationView.getLayoutParams().width = ThemeUtils.getOptimalDrawerWidth(this);
 322         mTagsAdapter = new TagsAdapter(this, mNotesBucket, mDrawerList.getHeaderViewsCount());
 323         mDrawerList.setAdapter(mTagsAdapter);
 324         // Set the list&#x27;s click listener
 325         mDrawerList.setOnItemClickListener(new DrawerItemClickListener());
 326 
 327         if (mSelectedTag == null)
 328             mSelectedTag = mTagsAdapter.getDefaultItem();
 329 
 330         mDrawerToggle = new ActionBarDrawerToggle(this, mDrawerLayout, toolbar, R.string.open_drawer,
 331                 R.string.close_drawer) {
 332             public void onDrawerClosed(View view) {
 333                 supportInvalidateOptionsMenu();
 334             }
 335 
 336             public void onDrawerOpened(View drawerView) {
 337                 // noop
 338             }
 339 
 340             @Override
 341             public void onDrawerSlide(View drawerView, float slideOffset) {
 342                 super.onDrawerSlide(drawerView, 0f);
 343             }
 344         };
 345 
 346         mDrawerLayout.addDrawerListener(mDrawerToggle);
 347     }
 348 
 349     private void checkForFirstLaunch() {
 350         if (PrefUtils.getBoolPref(this, PrefUtils.PREF_FIRST_LAUNCH, true)) {
 351             // Create the welcome note
 352             try {
 353                 Note welcomeNote = mNotesBucket.newObject(&quot;welcome-android&quot;);
 354                 welcomeNote.setCreationDate(Calendar.getInstance());
 355                 welcomeNote.setModificationDate(welcomeNote.getCreationDate());
 356                 welcomeNote.setContent(getString(R.string.welcome_note));
 357                 welcomeNote.getTitle();
 358                 welcomeNote.save();
 359             } catch (BucketObjectNameInvalid e) {
 360                 // this won&#x27;t happen because welcome-android is a valid name
 361             }
 362 
 363             SharedPreferences preferences = PreferenceManager.getDefaultSharedPreferences(this);
 364             SharedPreferences.Editor editor = preferences.edit();
 365             editor.putBoolean(PrefUtils.PREF_FIRST_LAUNCH, false);
 366             editor.putBoolean(PrefUtils.PREF_ACCOUNT_REQUIRED, true);
 367             editor.apply();
 368         }
 369     }
 370 
 371     private void checkForSharedContent() {
 372         if (getIntent().hasExtra(Intent.EXTRA_TEXT)) {
 373             // Check share action
 374             Intent intent = getIntent();
 375             String subject = intent.getStringExtra(Intent.EXTRA_SUBJECT);
 376             String text = intent.getStringExtra(Intent.EXTRA_TEXT);
 377 
<abbr title=" 378             // Don&#x27;t add the &#x27;Note to self&#x27; subject or open the note if this was shared from a voice search"> 378             // Don&#x27;t add the &#x27;Note to self&#x27; subject or open the note if this was shared from a voice searðŸ”µ</abbr>
 379             String intentAction = StrUtils.notNullStr(intent.getAction());
 380             boolean isVoiceShare = intentAction.equals(&quot;com.google.android.gm.action.AUTO_SEND&quot;);
 381             if (!TextUtils.isEmpty(text)) {
 382                 if (!TextUtils.isEmpty(subject) &amp;&amp; !isVoiceShare) {
 383                     text = subject + &quot;\n\n&quot; + text;
 384                 }
 385                 Note note = mNotesBucket.newObject();
 386                 note.setCreationDate(Calendar.getInstance());
 387                 note.setModificationDate(note.getCreationDate());
 388                 note.setContent(text);
 389                 note.save();
 390                 setCurrentNote(note);
 391                 mShouldSelectNewNote = true;
 392 
 393                 AnalyticsTracker.track(
 394                         AnalyticsTracker.Stat.LIST_NOTE_CREATED,
 395                         AnalyticsTracker.CATEGORY_NOTE,
 396                         &quot;external_share&quot;
 397                 );
 398 
 399                 if (!DisplayUtils.isLargeScreenLandscape(this)) {
 400                     // Disable the lock screen when sharing content and opening NoteEditorActivity
 401                     // Lock screen activities are enabled again in NoteEditorActivity.onPause()
 402                     if (AppLockManager.getInstance().isAppLockFeatureEnabled()) {
 403                         AppLockManager.getInstance().getAppLock().setExemptActivities(
 404                                 new String[]{&quot;com.automattic.simplenote.NotesActivity&quot;,
 405                                         &quot;com.automattic.simplenote.NoteEditorActivity&quot;});
 406                         AppLockManager.getInstance().getAppLock().setOneTimeTimeout(0);
 407                     }
 408                 }
 409             }
 410         }
 411     }
 412 
 413     private void updateNavigationDrawerItems() {
 414         boolean isAlphaSort = PrefUtils.getBoolPref(this, PrefUtils.PREF_SORT_TAGS_ALPHA);
 415         Bucket.ObjectCursor&lt;Tag&gt; tagCursor;
 416         if (isAlphaSort) {
 417             tagCursor = Tag.allSortedAlphabetically(mTagsBucket).execute();
 418         } else {
 419             tagCursor = Tag.allWithName(mTagsBucket).execute();
 420         }
 421 
 422         mTagsAdapter.changeCursor(tagCursor);
 423     }
 424 
 425     private void setSelectedTagActive() {
 426         if (mSelectedTag == null)
 427             mSelectedTag = mTagsAdapter.getDefaultItem();
 428 
 429         setTitle(mSelectedTag.name);
<abbr title=" 430         mDrawerList.setItemChecked(mTagsAdapter.getPosition(mSelectedTag) + mDrawerList.getHeaderViewsCount(), true);"> 430         mDrawerList.setItemChecked(mTagsAdapter.getPosition(mSelectedTag) + mDrawerList.getHeaderViewsCouðŸ”µ</abbr>
 431     }
 432 
 433     public TagsAdapter.TagMenuItem getSelectedTag() {
 434         if (mSelectedTag == null) {
 435             mSelectedTag = mTagsAdapter.getDefaultItem();
 436         }
 437 
 438         return mSelectedTag;
 439     }
 440 
 441     // Enable or disable the trash action bar button depending on if there are deleted notes or not
 442     public void updateTrashMenuItem() {
 443         if (mEmptyTrashMenuItem == null || mNotesBucket == null)
 444             return;
 445 
 446         // Disable the trash icon if there are no notes trashed.
 447         Query&lt;Note&gt; query = Note.allDeleted(mNotesBucket);
 448         if (query.count() == 0) {
 449             mEmptyTrashMenuItem.setEnabled(false);
 450         } else {
 451             mEmptyTrashMenuItem.setEnabled(true);
 452         }
 453     }
 454 
 455     private void addEditorFragment() {
 456         FragmentManager fm = getSupportFragmentManager();
 457         FragmentTransaction ft = fm.beginTransaction();
 458         mNoteEditorFragment = new NoteEditorFragment();
 459         ft.add(R.id.note_fragment_container, mNoteEditorFragment, TAG_NOTE_EDITOR);
 460         ft.commitAllowingStateLoss();
 461         fm.executePendingTransactions();
 462     }
 463 
 464     private boolean userAccountRequired() {
 465         return PrefUtils.getBoolPref(this, PrefUtils.PREF_ACCOUNT_REQUIRED, false);
 466     }
 467 
 468     /**
 469      * Checks for a previously valid user that is now not authenticated
 470      * Also checks if user account is required (added in version 1.5.6)
 471      *
 472      * @return true if user has invalid authorization
 473      */
 474     private boolean userAuthenticationIsInvalid() {
 475         Simplenote currentApp = (Simplenote) getApplication();
 476         Simperium simperium = currentApp.getSimperium();
 477         User user = simperium.getUser();
 478         boolean isNotAuthorized = user.getStatus().equals(User.Status.NOT_AUTHORIZED);
 479         return (user.hasAccessToken() &amp;&amp; isNotAuthorized) ||
 480                 (userAccountRequired() &amp;&amp; isNotAuthorized);
 481     }
 482 
 483     public boolean userIsUnauthorized() {
 484         Simplenote currentApp = (Simplenote) getApplication();
 485         return currentApp.getSimperium().getUser().getStatus() == User.Status.NOT_AUTHORIZED;
 486     }
 487 
 488     public void setCurrentNote(Note note) {
 489         mCurrentNote = note;
 490     }
 491 
 492     public NoteListFragment getNoteListFragment() {
 493         return mNoteListFragment;
 494     }
 495 
 496     @SuppressWarnings(&quot;ResourceType&quot;)
 497     @Override
 498     public boolean onCreateOptionsMenu(Menu menu) {
 499         super.onCreateOptionsMenu(menu);
 500         MenuInflater inflater = getMenuInflater();
 501         inflater.inflate(R.menu.notes_list, menu);
 502 
 503         // restore the search query if on a landscape tablet
 504         String searchQuery = null;
 505         if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; mSearchView != null)
 506             searchQuery = mSearchView.getQuery().toString();
 507 
 508         mSearchMenuItem = menu.findItem(R.id.menu_search);
 509         mSearchView = (SearchView) mSearchMenuItem.getActionView();
 510 
 511         if (!TextUtils.isEmpty(searchQuery)) {
 512             mSearchView.setQuery(searchQuery, false);
 513             mSearchMenuItem.expandActionView();
 514         } else {
 515             // Workaround for setting the search placeholder text color
 516             String hintHexColor = (ThemeUtils.isLightTheme(this) ?
 517                     getString(R.color.gray_light) :
 518                     getString(R.color.text_preview)).replace(&quot;ff&quot;, &quot;&quot;);
 519             mSearchView.setQueryHint(HtmlCompat.fromHtml(String.format(&quot;&lt;font color=\&quot;%s\&quot;&gt;%s&lt;/font&gt;&quot;,
 520                     hintHexColor,
 521                     getString(R.string.search))));
 522         }
 523 
 524         mSearchView.setOnQueryTextListener(new SearchView.OnQueryTextListener() {
 525             @Override
 526             public boolean onQueryTextChange(String newText) {
 527                 if (mSearchMenuItem.isActionViewExpanded()) {
 528                     getNoteListFragment().searchNotes(newText);
 529                 }
 530                 return true;
 531             }
 532 
 533             @Override
 534             public boolean onQueryTextSubmit(String queryText) {
 535                 getNoteListFragment().searchNotes(queryText);
 536                 return true;
 537             }
 538 
 539         });
 540 
 541         mSearchMenuItem.setOnActionExpandListener(new MenuItem.OnActionExpandListener() {
 542             @Override
 543             public boolean onMenuItemActionExpand(MenuItem menuItem) {
 544                 checkEmptyListText(true);
 545                 if (mNoteListFragment != null) {
 546                     mNoteListFragment.setFloatingActionButtonVisible(false);
 547                 }
 548                 AnalyticsTracker.track(
 549                         AnalyticsTracker.Stat.LIST_NOTES_SEARCHED,
 550                         AnalyticsTracker.CATEGORY_NOTE,
 551                         &quot;action_bar_search_tap&quot;
 552                 );
 553                 return true;
 554             }
 555 
 556             @Override
 557             public boolean onMenuItemActionCollapse(MenuItem menuItem) {
 558                 // Show all notes again
 559                 if (mNoteListFragment != null) {
 560                     mNoteListFragment.setFloatingActionButtonVisible(true);
 561                 }
 562                 mTabletSearchQuery = &quot;&quot;;
 563                 mSearchView.setQuery(&quot;&quot;, false);
 564                 checkEmptyListText(false);
 565                 getNoteListFragment().clearSearch();
 566                 return true;
 567             }
 568         });
 569 
 570         mSearchMenuItem.setOnMenuItemClickListener(new MenuItem.OnMenuItemClickListener() {
 571             @Override
 572             public boolean onMenuItemClick(MenuItem item) {
 573                 if (!mSearchMenuItem.isActionViewExpanded())
 574                     showDetailPlaceholder();
 575                 return false;
 576             }
 577         });
 578 
 579         MenuItem trashItem = menu.findItem(R.id.menu_delete).setTitle(R.string.undelete);
 580         if (mCurrentNote != null &amp;&amp; mCurrentNote.isDeleted()) {
 581             trashItem.setTitle(R.string.undelete);
 582             trashItem.setIcon(R.drawable.ic_trash_restore_24dp);
 583         } else {
 584             trashItem.setTitle(R.string.delete);
 585             trashItem.setIcon(R.drawable.ic_trash_24dp);
 586         }
 587 
 588         if (DisplayUtils.isLargeScreenLandscape(this)) {
 589             // Restore the search query on landscape tablets
 590             if (!TextUtils.isEmpty(mTabletSearchQuery)) {
 591                 mSearchMenuItem.expandActionView();
 592                 mSearchView.setQuery(mTabletSearchQuery, false);
 593                 mSearchView.clearFocus();
 594             }
 595 
 596             if (mCurrentNote != null) {
 597                 menu.findItem(R.id.menu_share).setVisible(true);
 598                 menu.findItem(R.id.menu_view_info).setVisible(true);
 599                 menu.findItem(R.id.menu_checklist).setVisible(true);
 600                 menu.findItem(R.id.menu_history).setVisible(true);
 601                 menu.findItem(R.id.menu_markdown_preview).setVisible(mCurrentNote.isMarkdownEnabled());
 602                 trashItem.setVisible(true);
 603             } else {
 604                 menu.findItem(R.id.menu_share).setVisible(false);
 605                 menu.findItem(R.id.menu_view_info).setVisible(false);
 606                 menu.findItem(R.id.menu_checklist).setVisible(false);
 607                 menu.findItem(R.id.menu_history).setVisible(false);
 608                 menu.findItem(R.id.menu_markdown_preview).setVisible(false);
 609                 trashItem.setVisible(false);
 610             }
 611             menu.findItem(R.id.menu_empty_trash).setVisible(false);
 612         } else {
 613             menu.findItem(R.id.menu_search).setVisible(true);
 614             menu.findItem(R.id.menu_share).setVisible(false);
 615             menu.findItem(R.id.menu_view_info).setVisible(false);
 616             menu.findItem(R.id.menu_checklist).setVisible(false);
 617             menu.findItem(R.id.menu_history).setVisible(false);
 618             menu.findItem(R.id.menu_markdown_preview).setVisible(false);
 619             trashItem.setVisible(false);
 620             menu.findItem(R.id.menu_empty_trash).setVisible(false);
 621         }
 622 
 623         // Are we looking at the trash? Adjust menu accordingly.
 624         if (mDrawerList.getCheckedItemPosition() == TRASH_SELECTED_ID) {
 625             mEmptyTrashMenuItem = menu.findItem(R.id.menu_empty_trash);
 626             mEmptyTrashMenuItem.setVisible(true);
 627 
 628             updateTrashMenuItem();
 629 
 630             menu.findItem(R.id.menu_search).setVisible(false);
 631             menu.findItem(R.id.menu_share).setVisible(false);
 632             menu.findItem(R.id.menu_history).setVisible(false);
 633             menu.findItem(R.id.menu_checklist).setVisible(false);
 634         }
 635 
 636         DrawableUtils.tintMenuWithAttribute(this, menu, R.attr.actionBarTextColor);
 637 
 638         return true;
 639     }
 640 
 641     @Override
 642     public boolean onOptionsItemSelected(MenuItem item) {
 643         if (mDrawerToggle.onOptionsItemSelected(item)) {
 644             return true;
 645         }
 646         switch (item.getItemId()) {
 647             case R.id.menu_markdown_preview:
 648                 if (mIsShowingMarkdown) {
 649                     item.setIcon(R.drawable.ic_preview_24dp);
 650                     item.setTitle(getString(R.string.markdown_show));
 651                     setMarkdownShowing(false);
 652                 } else {
 653                     item.setIcon(R.drawable.ic_preview_stop_24dp);
 654                     item.setTitle(getString(R.string.markdown_hide));
 655                     setMarkdownShowing(true);
 656                 }
 657 
 658                 DrawableUtils.tintMenuItemWithAttribute(this, item, R.attr.actionBarTextColor);
 659 
 660                 return true;
 661             case R.id.menu_delete:
 662                 if (mNoteEditorFragment != null) {
 663                     if (mCurrentNote != null) {
 664                         mCurrentNote.setDeleted(!mCurrentNote.isDeleted());
 665                         mCurrentNote.setModificationDate(Calendar.getInstance());
 666                         mCurrentNote.save();
 667 
 668                         updateViewsAfterTrashAction(mCurrentNote);
 669                     }
 670                 }
 671                 return true;
 672             case R.id.menu_empty_trash:
 673                 AlertDialog.Builder alert = new AlertDialog.Builder(this);
 674 
 675                 alert.setTitle(R.string.empty_trash);
 676                 alert.setMessage(R.string.confirm_empty_trash);
 677                 alert.setPositiveButton(R.string.yes, new DialogInterface.OnClickListener() {
 678                     public void onClick(DialogInterface dialog, int whichButton) {
 679                         new emptyTrashTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR);
 680                         AnalyticsTracker.track(
 681                                 AnalyticsTracker.Stat.LIST_TRASH_EMPTIED,
 682                                 AnalyticsTracker.CATEGORY_NOTE,
 683                                 &quot;overflow_menu&quot;
 684                         );
 685                     }
 686                 });
 687                 alert.setNegativeButton(R.string.no, new DialogInterface.OnClickListener() {
 688                     public void onClick(DialogInterface dialog, int whichButton) {
 689                         // Do nothing, just closing the dialog
 690                     }
 691                 });
 692                 alert.show();
 693                 return true;
 694             case android.R.id.home:
 695                 invalidateOptionsMenu();
 696                 return true;
 697             default:
 698                 return super.onOptionsItemSelected(item);
 699         }
 700     }
 701 
 702     @Override
 703     public boolean onPrepareOptionsMenu(Menu menu) {
 704         MenuItem markdownItem = menu.findItem(R.id.menu_markdown_preview);
 705 
 706         if (mIsShowingMarkdown) {
 707             markdownItem.setIcon(R.drawable.ic_preview_stop_24dp);
 708             markdownItem.setTitle(getString(R.string.markdown_hide));
 709         } else {
 710             markdownItem.setIcon(R.drawable.ic_preview_24dp);
 711             markdownItem.setTitle(getString(R.string.markdown_show));
 712         }
 713 
 714         DrawableUtils.tintMenuItemWithAttribute(this, markdownItem, R.attr.actionBarTextColor);
 715 
 716         return super.onPrepareOptionsMenu(menu);
 717     }
 718 
 719     public void updateViewsAfterTrashAction(Note note) {
 720         if (note == null || isFinishing()) {
 721             return;
 722         }
 723 
 724         if (note.isDeleted()) {
 725             List&lt;String&gt; deletedNoteIds = new ArrayList&lt;&gt;();
 726             deletedNoteIds.add(note.getSimperiumKey());
 727             mUndoBarController.setDeletedNoteIds(deletedNoteIds);
 728             mUndoBarController.showUndoBar(getUndoView(), getString(R.string.note_deleted));
 729             AnalyticsTracker.track(
 730                     AnalyticsTracker.Stat.LIST_NOTE_DELETED,
 731                     AnalyticsTracker.CATEGORY_NOTE,
 732                     &quot;overflow_menu&quot;
 733             );
 734         } else {
 735             AnalyticsTracker.track(
 736                     AnalyticsTracker.Stat.EDITOR_NOTE_RESTORED,
 737                     AnalyticsTracker.CATEGORY_NOTE,
 738                     &quot;overflow_menu&quot;
 739             );
 740         }
 741 
 742         // If we just deleted/restored the active note, show the placeholder
 743         if (mCurrentNote != null &amp;&amp; mCurrentNote.getSimperiumKey().equals(note.getSimperiumKey())) {
 744             showDetailPlaceholder();
 745         }
 746 
 747         NoteListFragment fragment = getNoteListFragment();
 748         if (fragment != null) {
 749             fragment.getPrefs();
 750             fragment.refreshList();
 751         }
 752 
 753         invalidateOptionsMenu();
 754     }
 755 
 756     public void setMarkdownShowing(boolean isMarkdownShowing) {
 757         mIsShowingMarkdown = isMarkdownShowing;
 758         if (mNoteEditorFragment != null) {
 759             if (isMarkdownShowing) {
 760                 mNoteEditorFragment.showMarkdown();
 761             } else {
 762                 mNoteEditorFragment.hideMarkdown();
 763             }
 764         }
 765         invalidateOptionsMenu();
 766     }
 767 
 768     /**
 769      * Callback method from {@link NoteListFragment.Callbacks} indicating that
 770      * the item with the given ID was selected. Used for tablets only.
 771      */
 772     @Override
<abbr title=" 773     public void onNoteSelected(String noteID, int position, String matchOffsets, boolean isMarkdownEnabled) {"> 773     public void onNoteSelected(String noteID, int position, String matchOffsets, boolean isMarkdownEnableðŸ”µ</abbr>
 774         if (!DisplayUtils.isLargeScreenLandscape(this)) {
 775             // Launch the editor activity
 776             Bundle arguments = new Bundle();
 777             arguments.putString(NoteEditorFragment.ARG_ITEM_ID, noteID);
 778             arguments.putBoolean(NoteEditorFragment.ARG_MARKDOWN_ENABLED, isMarkdownEnabled);
 779 
 780             if (matchOffsets != null)
 781                 arguments.putString(NoteEditorFragment.ARG_MATCH_OFFSETS, matchOffsets);
 782 
 783             Intent editNoteIntent = new Intent(this, NoteEditorActivity.class);
 784             editNoteIntent.putExtras(arguments);
 785             startActivityForResult(editNoteIntent, Simplenote.INTENT_EDIT_NOTE);
 786         } else {
 787             mNoteEditorFragment.setNote(noteID, matchOffsets);
 788             getNoteListFragment().setNoteSelected(noteID);
 789 
 790             if (mSearchView != null &amp;&amp; mSearchView.getQuery() != null) {
 791                 mTabletSearchQuery = mSearchView.getQuery().toString();
 792             }
 793 
 794             mNoteEditorFragment.clearMarkdown();
 795 
 796             if (!isMarkdownEnabled &amp;&amp; mIsShowingMarkdown) {
 797                 setMarkdownShowing(false);
 798             }
 799 
 800             invalidateOptionsMenu();
 801         }
 802 
 803         AnalyticsTracker.track(
 804                 AnalyticsTracker.Stat.LIST_NOTE_OPENED,
 805                 AnalyticsTracker.CATEGORY_NOTE,
 806                 &quot;note_list_row_tap&quot;
 807         );
 808     }
 809 
 810     @Override
 811     public void onUserCreated(User user) {
 812         // New account created
 813         AnalyticsTracker.track(
 814                 AnalyticsTracker.Stat.USER_ACCOUNT_CREATED,
 815                 AnalyticsTracker.CATEGORY_USER,
 816                 &quot;account_created_from_login_activity&quot;
 817         );
 818     }
 819 
 820     public void onUserStatusChange(User.Status status) {
 821         switch (status) {
 822             // successfully used access token to connect to simperium bucket
 823             case AUTHORIZED:
 824                 runOnUiThread(new Runnable() {
 825                     @Override
 826                     public void run() {
 827                         if (!mNotesBucket.hasChangeVersion()) {
 828                             setToolbarProgressVisibility(true);
 829                         }
 830                     }
 831                 });
 832                 break;
 833 
 834             // NOT_AUTHORIZED means we attempted to connect but the token was not valid
 835             case NOT_AUTHORIZED:
 836                 runOnUiThread(new Runnable() {
 837                     @Override
 838                     public void run() {
 839                         startLoginActivity(true);
 840                     }
 841                 });
 842                 break;
 843 
<abbr title=" 844             // Default starting state of User, don&#x27;t do anything we allow use of app while not signed in so don&#x27;t do anything"> 844             // Default starting state of User, don&#x27;t do anything we allow use of app while not signed in ðŸ”µ</abbr>
 845             case UNKNOWN:
 846                 break;
 847         }
 848     }
 849 
 850     private void setToolbarProgressVisibility(boolean isVisible) {
 851         if (getSupportActionBar() != null) {
 852             getSupportActionBar().setDisplayShowCustomEnabled(isVisible);
 853         }
 854     }
 855 
 856     public void startLoginActivity(boolean signInFirst) {
 857         // Clear some account-specific prefs
 858         SharedPreferences.Editor editor = PreferenceManager.getDefaultSharedPreferences(this).edit();
 859         editor.remove(PrefUtils.PREF_WP_TOKEN);
 860         editor.remove(PrefUtils.PREF_WORDPRESS_SITES);
 861         editor.apply();
 862 
 863         Intent loginIntent = new Intent(this, SignInActivity.class);
 864         if (signInFirst) {
 865             loginIntent.putExtra(SignInActivity.EXTRA_SIGN_IN_FIRST, true);
 866         }
 867         startActivityForResult(loginIntent, Simperium.SIGNUP_SIGNIN_REQUEST);
 868     }
 869 
 870     @Override
 871     public void recreate() {
 872         Handler handler = new Handler();
 873         handler.post(new Runnable() {
 874             @Override
 875             public void run() {
 876                 NotesActivity.super.recreate();
 877             }
 878         });
 879     }
 880 
 881     @Override
 882     protected void onActivityResult(int requestCode, int resultCode, Intent data) {
 883         super.onActivityResult(requestCode, resultCode, data);
 884         switch (requestCode) {
 885             case Simplenote.INTENT_PREFERENCES:
 886                 if (ThemeUtils.themeWasChanged(data)) {
 887                     // Restart this activity to apply the new theme
 888                     recreate();
 889                     break;
 890                 }
<abbr title=" 891                 // nbradbury - refresh note list when user returns from preferences (in case they changed anything)"> 891                 // nbradbury - refresh note list when user returns from preferences (in case they changedðŸ”µ</abbr>
 892                 invalidateOptionsMenu();
 893                 NoteListFragment fragment = getNoteListFragment();
 894                 if (fragment != null) {
 895                     fragment.getPrefs();
 896                     fragment.refreshList();
 897                 }
 898 
 899                 break;
 900             case Simplenote.INTENT_EDIT_NOTE:
 901                 if (resultCode == RESULT_OK &amp;&amp; data != null) {
 902                     if (data.hasExtra(Simplenote.DELETED_NOTE_ID)) {
 903                         String noteId = data.getStringExtra(Simplenote.DELETED_NOTE_ID);
 904                         if (noteId != null) {
 905                             List&lt;String&gt; deletedNoteIds = new ArrayList&lt;&gt;();
 906                             deletedNoteIds.add(noteId);
 907                             mUndoBarController.setDeletedNoteIds(deletedNoteIds);
<abbr title=" 908                             mUndoBarController.showUndoBar(getUndoView(), getString(R.string.note_deleted));"> 908                             mUndoBarController.showUndoBar(getUndoView(), getString(R.string.note_deletedðŸ”µ</abbr>
 909                         }
<abbr title=" 910                     } else if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; data.hasExtra(Simplenote.SELECTED_NOTE_ID)) {"> 910                     } else if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; data.hasExtra(Simplenote.SELEðŸ”µ</abbr>
 911                         String selectedNoteId = data.getStringExtra(Simplenote.SELECTED_NOTE_ID);
 912                         mNoteListFragment.setNoteSelected(selectedNoteId);
 913                         if (mNoteEditorFragment != null) {
 914                             mNoteEditorFragment.setNote(selectedNoteId);
 915                         }
 916                     }
 917                 }
 918                 break;
 919             case Simperium.SIGNUP_SIGNIN_REQUEST:
 920                 invalidateOptionsMenu();
 921 
 922                 Simplenote app = (Simplenote) getApplication();
 923                 AnalyticsTracker.refreshMetadata(app.getSimperium().getUser().getEmail());
 924 
 925                 AnalyticsTracker.track(
 926                         AnalyticsTracker.Stat.USER_SIGNED_IN,
 927                         AnalyticsTracker.CATEGORY_USER,
 928                         &quot;signed_in_from_login_activity&quot;
 929                 );
 930 
 931                 if (resultCode == Activity.RESULT_CANCELED &amp;&amp; userAuthenticationIsInvalid()) {
 932                     finish();
 933                 }
 934 
 935                 break;
 936         }
 937     }
 938 
 939     @Override
 940     public void onUndo() {
 941         if (mUndoBarController == null) return;
 942 
 943         List&lt;String&gt; deletedNoteIds = mUndoBarController.getDeletedNoteIds();
 944         if (deletedNoteIds != null) {
 945             for (int i = 0; i &lt; deletedNoteIds.size(); i++) {
 946                 Note deletedNote;
 947                 try {
 948                     deletedNote = mNotesBucket.get(deletedNoteIds.get(i));
 949                 } catch (BucketObjectMissingException e) {
 950                     return;
 951                 }
 952                 if (deletedNote != null) {
 953                     deletedNote.setDeleted(false);
 954                     deletedNote.setModificationDate(Calendar.getInstance());
 955                     deletedNote.save();
 956                     NoteListFragment fragment = getNoteListFragment();
 957                     if (fragment != null) {
 958                         fragment.getPrefs();
 959                         fragment.refreshList();
 960                     }
 961                 }
 962             }
 963         }
 964     }
 965 
 966     @Override
 967     protected void onPostCreate(Bundle savedInstanceState) {
 968         super.onPostCreate(savedInstanceState);
 969         // Sync the toggle state after onRestoreInstanceState has occurred.
 970         mDrawerToggle.syncState();
 971     }
 972 
 973     @Override
 974     public void onConfigurationChanged(Configuration newConfig) {
 975         super.onConfigurationChanged(newConfig);
 976 
 977         mDrawerToggle.onConfigurationChanged(newConfig);
 978 
 979         if (DisplayUtils.isLargeScreen(this)) {
 980             mIsShowingMarkdown = false;
 981 
 982             if (newConfig.orientation == Configuration.ORIENTATION_LANDSCAPE) {
 983                 // Add the editor fragment
 984                 if (getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR) != null) {
<abbr title=" 985                     mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR);"> 985                     mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByðŸ”µ</abbr>
 986                 } else if (DisplayUtils.isLandscape(this)) {
 987                     addEditorFragment();
 988                 }
 989                 if (mNoteListFragment != null) {
 990                     mNoteListFragment.setActivateOnItemClick(true);
 991                     mNoteListFragment.setDividerVisible(true);
 992                 }
 993                 // Select the current note on a tablet
 994                 if (mCurrentNote != null)
<abbr title=" 995                     onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled());"> 995                     onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnableðŸ”µ</abbr>
 996                 else {
 997                     mNoteEditorFragment.setPlaceholderVisible(true);
 998                     mNoteListFragment.getListView().clearChoices();
 999                 }
1000                 invalidateOptionsMenu();
1001             }
1002         }
1003 
1004         if (newConfig.orientation == Configuration.ORIENTATION_PORTRAIT &amp;&amp; mNoteEditorFragment != null) {
1005             // Remove the editor fragment when rotating back to portrait
1006             mCurrentNote = null;
1007             if (mNoteListFragment != null) {
1008                 mNoteListFragment.setActivateOnItemClick(false);
1009                 mNoteListFragment.setDividerVisible(false);
1010                 mNoteListFragment.setActivatedPosition(ListView.INVALID_POSITION);
1011                 mNoteListFragment.refreshList();
1012             }
1013             FragmentManager fm = getSupportFragmentManager();
1014             FragmentTransaction ft = fm.beginTransaction();
1015             ft.remove(mNoteEditorFragment);
1016             mNoteEditorFragment = null;
1017             ft.commitAllowingStateLoss();
1018             fm.executePendingTransactions();
1019             invalidateOptionsMenu();
1020         }
1021     }
1022 
1023     public void checkEmptyListText(boolean isSearch) {
1024         if (isSearch) {
<abbr title="1025             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_found) + &quot;&lt;/strong&gt;&quot;);">1025             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_found) + &quot;ðŸ”µ</abbr>
1026             getNoteListFragment().setEmptyListViewClickable(false);
1027         } else if (mDrawerList.getCheckedItemPosition() == TRASH_SELECTED_ID) {
<abbr title="1028             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.trash_is_empty) + &quot;&lt;/strong&gt;&quot;);">1028             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.trash_is_empty) + &quot;ðŸ”µ</abbr>
1029             AnalyticsTracker.track(
1030                     AnalyticsTracker.Stat.LIST_TRASH_VIEWED,
1031                     AnalyticsTracker.CATEGORY_NOTE,
1032                     &quot;trash_filter_selected&quot;
1033             );
1034             getNoteListFragment().setEmptyListViewClickable(false);
1035         } else {
<abbr title="1036             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here) + &quot;&lt;/strong&gt;&lt;br /&gt;&quot; + String.format(getString(R.string.why_not_create_one), &quot;&lt;u&gt;&quot;, &quot;&lt;/u&gt;&quot;));">1036             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here) + &quot;&lt;ðŸ”µ</abbr>
1037             getNoteListFragment().setEmptyListViewClickable(true);
1038         }
1039     }
1040 
1041     public void showDetailPlaceholder() {
1042         if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; mNoteEditorFragment != null) {
1043             mCurrentNote = null;
1044             mNoteEditorFragment.setPlaceholderVisible(true);
1045             mNoteEditorFragment.clearMarkdown();
1046             mNoteEditorFragment.hideMarkdown();
1047             mIsShowingMarkdown = false;
1048         }
1049     }
1050 
1051     public void stopListeningToNotesBucket() {
1052         mNotesBucket.removeOnNetworkChangeListener(this);
1053         mNotesBucket.removeOnSaveObjectListener(this);
1054         mNotesBucket.removeOnDeleteObjectListener(this);
1055     }
1056 
1057     // Returns the appropriate view to show the undo bar within
1058     private View getUndoView() {
1059         View undoView = mFragmentsContainer;
1060         if (!DisplayUtils.isLargeScreenLandscape(this) &amp;&amp;
1061                 getNoteListFragment() != null &amp;&amp;
1062                 getNoteListFragment().getRootView() != null) {
1063             undoView = getNoteListFragment().getRootView();
1064         }
1065 
1066         return undoView;
1067     }
1068 
1069     public void showUndoBarWithNoteIds(List&lt;String&gt; noteIds) {
1070         if (mUndoBarController != null) {
1071             mUndoBarController.setDeletedNoteIds(noteIds);
1072             mUndoBarController.showUndoBar(
1073                     getUndoView(),
<abbr title="1074                     getResources().getQuantityString(R.plurals.trashed_notes, noteIds.size(), noteIds.size())">1074                     getResources().getQuantityString(R.plurals.trashed_notes, noteIds.size(), noteIds.sizðŸ”µ</abbr>
1075             );
1076         }
1077     }
1078 
1079     /* Simperium Bucket Listeners */
1080     // received a change from the network, refresh the list
1081     @Override
1082     public void onNetworkChange(Bucket&lt;Note&gt; bucket, final Bucket.ChangeType type, String key) {
1083         runOnUiThread(new Runnable() {
1084             @Override
1085             public void run() {
1086                 if (type == Bucket.ChangeType.INDEX) {
1087                     setToolbarProgressVisibility(false);
1088                 }
1089                 mNoteListFragment.refreshList();
1090             }
1091         });
1092     }
1093 
1094     @Override
1095     public void onSaveObject(Bucket&lt;Note&gt; bucket, Note object) {
1096         runOnUiThread(new Runnable() {
1097             @Override
1098             public void run() {
1099                 mNoteListFragment.refreshList();
1100             }
1101         });
1102     }
1103 
1104     @Override
1105     public void onDeleteObject(Bucket&lt;Note&gt; bucket, Note object) {
1106         runOnUiThread(new Runnable() {
1107             @Override
1108             public void run() {
1109                 mNoteListFragment.refreshList();
1110             }
1111         });
1112     }
1113 
1114     @Override
1115     public void onBeforeUpdateObject(Bucket&lt;Note&gt; bucket, Note note) {
1116         // noop, NoteEditorFragment will handle this
1117     }
1118 
1119     /* The click listener for ListView in the navigation drawer */
1120     private class DrawerItemClickListener implements ListView.OnItemClickListener {
1121         @Override
1122         public void onItemClick(AdapterView&lt;?&gt; parent, View view, int position, long id) {
1123 
1124             // Adjust for header view
1125             position -= mDrawerList.getHeaderViewsCount();
1126             mSelectedTag = mTagsAdapter.getItem(position);
1127             checkEmptyListText(false);
1128             // Update checked item in navigation drawer and close it
1129             setSelectedTagActive();
1130             mDrawerLayout.closeDrawer(mNavigationView);
1131             updateNavigationDrawerItems();
1132 
1133             // Disable long press on notes if we&#x27;re viewing the trash
1134             if (mDrawerList.getCheckedItemPosition() == TRASH_SELECTED_ID) {
1135                 getNoteListFragment().getListView().setLongClickable(false);
1136             } else {
1137                 getNoteListFragment().getListView().setLongClickable(true);
1138             }
1139 
1140             getNoteListFragment().refreshListFromNavSelect();
1141             if (position &gt; 1) {
1142                 AnalyticsTracker.track(
1143                         AnalyticsTracker.Stat.LIST_TAG_VIEWED,
1144                         AnalyticsTracker.CATEGORY_TAG,
1145                         &quot;selected_tag_in_navigation_drawer&quot;
1146                 );
1147             }
1148         }
1149     }
1150 
1151     private class emptyTrashTask extends AsyncTask&lt;Void, Void, Void&gt; {
1152 
1153         @Override
1154         protected Void doInBackground(Void... voids) {
1155             if (mNotesBucket == null) return null;
1156 
1157             Query&lt;Note&gt; query = Note.allDeleted(mNotesBucket);
1158             Bucket.ObjectCursor c = query.execute();
1159             while (c.moveToNext()) {
1160                 c.getObject().delete();
1161             }
1162 
1163             return null;
1164         }
1165 
1166         @Override
1167         protected void onPostExecute(Void nada) {
1168             showDetailPlaceholder();
1169         }
1170     }
1171 }</pre></td>
                            <td><pre>   1 package com.automattic.simplenote;
   2 
   3 import android.app.Activity;
   4 import android.app.AlertDialog;
   5 import android.content.DialogInterface;
   6 import android.content.Intent;
   7 import android.content.SharedPreferences;
   8 import android.content.res.Configuration;
   9 import android.os.AsyncTask;
  10 import android.os.Build;
  11 import android.os.Bundle;
  12 import android.os.Handler;
  13 import android.support.design.widget.NavigationView;
  14 import android.support.v4.app.FragmentManager;
  15 import android.support.v4.app.FragmentTransaction;
  16 import android.support.v4.content.ContextCompat;
  17 import android.support.v4.view.GravityCompat;
  18 import android.support.v4.widget.DrawerLayout;
  19 import android.support.v7.app.ActionBar;
  20 import android.support.v7.app.ActionBarDrawerToggle;
  21 import android.support.v7.app.AppCompatActivity;
  22 import android.support.v7.preference.PreferenceManager;
  23 import android.support.v7.widget.SearchView;
  24 import android.support.v7.widget.Toolbar;
  25 import android.text.Spannable;
  26 import android.text.SpannableString;
  27 import android.text.TextUtils;
  28 import android.view.Menu;
  29 import android.view.MenuInflater;
  30 import android.view.MenuItem;
  31 import android.view.View;
  32 import android.view.WindowInsets;
  33 import android.view.WindowManager;
  34 import android.widget.AdapterView;
  35 import android.widget.LinearLayout;
  36 import android.widget.ListView;
  37 import android.widget.ProgressBar;
  38 
  39 import com.automattic.simplenote.analytics.AnalyticsTracker;
  40 import com.automattic.simplenote.models.Note;
  41 import com.automattic.simplenote.models.Tag;
  42 import com.automattic.simplenote.utils.DisplayUtils;
  43 import com.automattic.simplenote.utils.DrawableUtils;
  44 import com.automattic.simplenote.utils.HtmlCompat;
  45 import com.automattic.simplenote.utils.PrefUtils;
  46 import com.automattic.simplenote.utils.StrUtils;
  47 import com.automattic.simplenote.utils.TagsAdapter;
  48 import com.automattic.simplenote.utils.ThemeUtils;
  49 import com.automattic.simplenote.utils.UndoBarController;
  50 import com.automattic.simplenote.widgets.TypefaceSpan;
  51 import com.simperium.Simperium;
  52 import com.simperium.client.Bucket;
  53 import com.simperium.client.BucketObjectMissingException;
  54 import com.simperium.client.BucketObjectNameInvalid;
  55 import com.simperium.client.Query;
  56 import com.simperium.client.User;
  57 
  58 import org.wordpress.passcodelock.AppLockManager;
  59 
  60 import java.util.ArrayList;
  61 import java.util.Calendar;
  62 import java.util.List;
  63 
  64 import static com.automattic.simplenote.utils.DisplayUtils.disableScreenshotsIfLocked;
  65 
  66 public class NotesActivity extends AppCompatActivity implements
<abbr title="  67         NoteListFragment.Callbacks, User.StatusChangeListener, Simperium.OnUserCreatedListener, UndoBarController.UndoListener,">  67         NoteListFragment.Callbacks, User.StatusChangeListener, Simperium.OnUserCreatedListener, UndoBarCoðŸ”µ</abbr>
  68         Bucket.Listener&lt;Note&gt; {
  69 
  70     public static String TAG_NOTE_LIST = &quot;noteList&quot;;
  71     public static String TAG_NOTE_EDITOR = &quot;noteEditor&quot;;
  72     protected Bucket&lt;Note&gt; mNotesBucket;
  73     protected Bucket&lt;Tag&gt; mTagsBucket;
  74     private int TRASH_SELECTED_ID = 1;
  75     private boolean mIsShowingMarkdown;
  76     private boolean mShouldSelectNewNote;
  77 
  78     private String mTabletSearchQuery;
  79     private UndoBarController mUndoBarController;
  80     private View mFragmentsContainer;
  81     private SearchView mSearchView;
  82     private MenuItem mSearchMenuItem;
  83     private NoteListFragment mNoteListFragment;
  84     private NoteEditorFragment mNoteEditorFragment;
  85     private Note mCurrentNote;
  86     private MenuItem mEmptyTrashMenuItem;
  87 
  88     // Menu drawer
  89     private DrawerLayout mDrawerLayout;
  90     private ListView mDrawerList;
  91     private NavigationView mNavigationView;
  92     private ActionBarDrawerToggle mDrawerToggle;
  93     private TagsAdapter mTagsAdapter;
  94     private TagsAdapter.TagMenuItem mSelectedTag;
  95     // Tags bucket listener
  96     private Bucket.Listener&lt;Tag&gt; mTagsMenuUpdater = new Bucket.Listener&lt;Tag&gt;() {
  97         void updateNavigationDrawer() {
  98             runOnUiThread(new Runnable() {
  99                 public void run() {
 100                     updateNavigationDrawerItems();
 101                 }
 102             });
 103         }
 104 
 105         @Override
 106         public void onSaveObject(Bucket&lt;Tag&gt; bucket, Tag tag) {
 107             updateNavigationDrawer();
 108         }
 109 
 110         @Override
 111         public void onDeleteObject(Bucket&lt;Tag&gt; bucket, Tag tag) {
 112             updateNavigationDrawer();
 113         }
 114 
 115         @Override
 116         public void onNetworkChange(Bucket&lt;Tag&gt; bucket, Bucket.ChangeType type, String key) {
 117             updateNavigationDrawer();
 118         }
 119 
 120         @Override
 121         public void onBeforeUpdateObject(Bucket&lt;Tag&gt; bucket, Tag object) {
 122             // noop
 123         }
 124     };
 125 
 126     @Override
 127     protected void onCreate(Bundle savedInstanceState) {
 128         // On lollipop, configure the translucent status bar
 129         if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.LOLLIPOP) {
 130             getWindow().addFlags(WindowManager.LayoutParams.FLAG_DRAWS_SYSTEM_BAR_BACKGROUNDS);
 131 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 132             getWindow().setStatusBarColor(ContextCompat.getColor(this, android.R.color.transparent));</span>
 133 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 134             getWindow().setStatusBarColor(ContextCompat.getColor(this, R.color.transparent));</span>
 135 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 136             getWindow().setStatusBarColor(ContextCompat.getColor(this, R.color.translucent_grey_medium_light));"> 136             getWindow().setStatusBarColor(ContextCompat.getColor(this, R.color.translucent_grey_medium_liðŸ”µ</abbr></span>
 137 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 138         }
 139 
 140         ThemeUtils.setTheme(this);
 141         super.onCreate(savedInstanceState);
 142 
 143         setContentView(R.layout.activity_notes);
 144 
 145         mFragmentsContainer = findViewById(R.id.note_fragment_container);
 146 
 147         Simplenote currentApp = (Simplenote) getApplication();
 148         if (mNotesBucket == null) {
 149             mNotesBucket = currentApp.getNotesBucket();
 150         }
 151 
 152         if (mTagsBucket == null) {
 153             mTagsBucket = currentApp.getTagsBucket();
 154         }
 155 
 156         Toolbar toolbar = findViewById(R.id.toolbar);
 157         setSupportActionBar(toolbar);
 158         configureNavigationDrawer(toolbar);
 159 
 160         if (savedInstanceState == null) {
 161             mNoteListFragment = new NoteListFragment();
 162             FragmentTransaction fragmentTransaction = getSupportFragmentManager().beginTransaction();
 163             fragmentTransaction.add(R.id.note_fragment_container, mNoteListFragment, TAG_NOTE_LIST);
 164             fragmentTransaction.commit();
 165         } else {
<abbr title=" 166             mNoteListFragment = (NoteListFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_LIST);"> 166             mNoteListFragment = (NoteListFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTEðŸ”µ</abbr>
 167         }
 168 
 169         if (DisplayUtils.isLargeScreen(this)) {
 170             if (getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR) != null) {
<abbr title=" 171                 mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR);"> 171                 mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByTag(ðŸ”µ</abbr>
 172             } else if (DisplayUtils.isLandscape(this)) {
 173                 addEditorFragment();
 174             }
 175         }
 176 
 177         // enable ActionBar app icon to behave as action to toggle nav drawer
 178         ActionBar actionBar = getSupportActionBar();
 179         if (actionBar != null) {
 180             actionBar.setDisplayHomeAsUpEnabled(true);
 181             actionBar.setHomeButtonEnabled(true);
 182 
 183             // Add loading indicator to show when indexing
<abbr title=" 184             ProgressBar progressBar = (ProgressBar) getLayoutInflater().inflate(R.layout.progressbar_toolbar, null);"> 184             ProgressBar progressBar = (ProgressBar) getLayoutInflater().inflate(R.layout.progressbar_toolðŸ”µ</abbr>
 185             actionBar.setDisplayShowCustomEnabled(true);
 186             actionBar.setCustomView(progressBar);
 187             setToolbarProgressVisibility(false);
 188         }
 189 
 190         mUndoBarController = new UndoBarController(this);
 191 
 192         // Creates &#x27;Welcome&#x27; note
 193         checkForFirstLaunch();
 194 
 195         checkForSharedContent();
 196 
 197         currentApp.getSimperium().setOnUserCreatedListener(this);
 198         currentApp.getSimperium().setUserStatusChangeListener(this);
 199     }
 200 
 201     @Override
 202     protected void onResume() {
 203         super.onResume();
 204 
 205         // Ensure user has valid authorization
 206         if (userAuthenticationIsInvalid()) {
 207             startLoginActivity(true);
 208         }
 209 
 210         disableScreenshotsIfLocked(this);
 211 
 212         mNotesBucket.start();
 213         mTagsBucket.start();
 214 
 215         mNotesBucket.addOnNetworkChangeListener(this);
 216         mNotesBucket.addOnSaveObjectListener(this);
 217         mNotesBucket.addOnDeleteObjectListener(this);
 218         mTagsBucket.addListener(mTagsMenuUpdater);
 219 
 220         updateNavigationDrawerItems();
 221 
 222         // if the user is not authenticated and the tag doesn&#x27;t exist revert to default drawer selection
 223         if (userIsUnauthorized()) {
 224             if (-1 == mTagsAdapter.getPosition(mSelectedTag)) {
 225                 mSelectedTag = null;
 226                 mDrawerList.setSelection(TagsAdapter.DEFAULT_ITEM_POSITION);
 227             }
 228         }
 229 
 230         setSelectedTagActive();
 231 
 232         if (mCurrentNote != null &amp;&amp; mShouldSelectNewNote) {
 233             onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled());
 234             mShouldSelectNewNote = false;
 235         }
 236 
 237         if (mIsShowingMarkdown) {
 238             setMarkdownShowing(false);
 239         }
 240 
 241     }
 242 
 243     @Override
 244     protected void onPause() {
 245         super.onPause();  // Always call the superclass method first
 246         mTagsBucket.removeListener(mTagsMenuUpdater);
 247         mTagsBucket.stop();
 248 
 249         mNotesBucket.removeOnNetworkChangeListener(this);
 250         mNotesBucket.removeOnSaveObjectListener(this);
 251         mNotesBucket.removeOnDeleteObjectListener(this);
 252         mNotesBucket.stop();
 253     }
 254 
 255     @Override
 256     public void setTitle(CharSequence title) {
 257         if (title == null) {
 258             title = &quot;&quot;;
 259         }
 260 
 261         setTitleWithCustomFont(title);
 262     }
 263 
 264     @Override
 265     public void onBackPressed() {
 266         if (mDrawerLayout != null &amp;&amp; mDrawerLayout.isDrawerOpen(GravityCompat.START)) {
 267             mDrawerLayout.closeDrawer(GravityCompat.START);
 268         } else {
 269             super.onBackPressed();
 270         }
 271     }
 272 
 273     private void setTitleWithCustomFont(CharSequence title) {
 274         if (getSupportActionBar() == null) return;
 275 
 276         // LG devices running 4.1 can&#x27;t handle a custom font in the action bar title
 277         if ((!TextUtils.isEmpty(Build.BRAND) &amp;&amp; Build.BRAND.toLowerCase().contains(&quot;lge&quot;))
 278                 &amp;&amp; Build.VERSION.SDK_INT &lt;= Build.VERSION_CODES.JELLY_BEAN) {
 279             getSupportActionBar().setTitle(title);
 280             return;
 281         }
 282 
 283         SpannableString s = new SpannableString(title);
 284         s.setSpan(new TypefaceSpan(this), 0, s.length(), Spannable.SPAN_EXCLUSIVE_EXCLUSIVE);
 285         getSupportActionBar().setTitle(s);
 286     }
 287 
 288     private void configureNavigationDrawer(Toolbar toolbar) {
 289         mDrawerLayout = findViewById(R.id.drawer_layout);
 290         mDrawerLayout.setDrawerShadow(R.drawable.drawer_shadow, GravityCompat.START);
 291         mNavigationView = findViewById(R.id.navigation_view);
 292         mDrawerList = findViewById(R.id.drawer_list);
 293 
 294         if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.LOLLIPOP) {
 295             mNavigationView.setOnApplyWindowInsetsListener(new View.OnApplyWindowInsetsListener() {
 296                 @Override
 297                 public WindowInsets onApplyWindowInsets(View view, WindowInsets windowInsets) {
 298                     LinearLayout drawerView = findViewById(R.id.drawer_view);
 299                     drawerView.setPadding(
 300                             drawerView.getPaddingLeft(),
 301                             windowInsets.getSystemWindowInsetTop(),
 302                             drawerView.getPaddingRight(),
 303                             drawerView.getPaddingBottom());
 304 
 305                     return windowInsets.consumeSystemWindowInsets();
 306                 }
 307             });
 308         }
 309 
 310         View settingsButton = findViewById(R.id.nav_settings);
 311         settingsButton.setOnClickListener(new View.OnClickListener() {
 312             @Override
 313             public void onClick(View v) {
 314                 Intent i = new Intent(NotesActivity.this, PreferencesActivity.class);
 315                 startActivityForResult(i, Simplenote.INTENT_PREFERENCES);
 316             }
 317         });
 318 
 319         mNavigationView.getLayoutParams().width = ThemeUtils.getOptimalDrawerWidth(this);
 320         mTagsAdapter = new TagsAdapter(this, mNotesBucket, mDrawerList.getHeaderViewsCount());
 321         mDrawerList.setAdapter(mTagsAdapter);
 322         // Set the list&#x27;s click listener
 323         mDrawerList.setOnItemClickListener(new DrawerItemClickListener());
 324 
 325         if (mSelectedTag == null)
 326             mSelectedTag = mTagsAdapter.getDefaultItem();
 327 
 328         mDrawerToggle = new ActionBarDrawerToggle(this, mDrawerLayout, toolbar, R.string.open_drawer,
 329                 R.string.close_drawer) {
 330             public void onDrawerClosed(View view) {
 331                 supportInvalidateOptionsMenu();
 332             }
 333 
 334             public void onDrawerOpened(View drawerView) {
 335                 // noop
 336             }
 337 
 338             @Override
 339             public void onDrawerSlide(View drawerView, float slideOffset) {
 340                 super.onDrawerSlide(drawerView, 0f);
 341             }
 342         };
 343 
 344         mDrawerLayout.addDrawerListener(mDrawerToggle);
 345     }
 346 
 347     private void checkForFirstLaunch() {
 348         if (PrefUtils.getBoolPref(this, PrefUtils.PREF_FIRST_LAUNCH, true)) {
 349             // Create the welcome note
 350             try {
 351                 Note welcomeNote = mNotesBucket.newObject(&quot;welcome-android&quot;);
 352                 welcomeNote.setCreationDate(Calendar.getInstance());
 353                 welcomeNote.setModificationDate(welcomeNote.getCreationDate());
 354                 welcomeNote.setContent(getString(R.string.welcome_note));
 355                 welcomeNote.getTitle();
 356                 welcomeNote.save();
 357             } catch (BucketObjectNameInvalid e) {
 358                 // this won&#x27;t happen because welcome-android is a valid name
 359             }
 360 
 361             SharedPreferences preferences = PreferenceManager.getDefaultSharedPreferences(this);
 362             SharedPreferences.Editor editor = preferences.edit();
 363             editor.putBoolean(PrefUtils.PREF_FIRST_LAUNCH, false);
 364             editor.putBoolean(PrefUtils.PREF_ACCOUNT_REQUIRED, true);
 365             editor.apply();
 366         }
 367     }
 368 
 369     private void checkForSharedContent() {
 370         if (getIntent().hasExtra(Intent.EXTRA_TEXT)) {
 371             // Check share action
 372             Intent intent = getIntent();
 373             String subject = intent.getStringExtra(Intent.EXTRA_SUBJECT);
 374             String text = intent.getStringExtra(Intent.EXTRA_TEXT);
 375 
<abbr title=" 376             // Don&#x27;t add the &#x27;Note to self&#x27; subject or open the note if this was shared from a voice search"> 376             // Don&#x27;t add the &#x27;Note to self&#x27; subject or open the note if this was shared from a voice searðŸ”µ</abbr>
 377             String intentAction = StrUtils.notNullStr(intent.getAction());
 378             boolean isVoiceShare = intentAction.equals(&quot;com.google.android.gm.action.AUTO_SEND&quot;);
 379             if (!TextUtils.isEmpty(text)) {
 380                 if (!TextUtils.isEmpty(subject) &amp;&amp; !isVoiceShare) {
 381                     text = subject + &quot;\n\n&quot; + text;
 382                 }
 383                 Note note = mNotesBucket.newObject();
 384                 note.setCreationDate(Calendar.getInstance());
 385                 note.setModificationDate(note.getCreationDate());
 386                 note.setContent(text);
 387                 note.save();
 388                 setCurrentNote(note);
 389                 mShouldSelectNewNote = true;
 390 
 391                 AnalyticsTracker.track(
 392                         AnalyticsTracker.Stat.LIST_NOTE_CREATED,
 393                         AnalyticsTracker.CATEGORY_NOTE,
 394                         &quot;external_share&quot;
 395                 );
 396 
 397                 if (!DisplayUtils.isLargeScreenLandscape(this)) {
 398                     // Disable the lock screen when sharing content and opening NoteEditorActivity
 399                     // Lock screen activities are enabled again in NoteEditorActivity.onPause()
 400                     if (AppLockManager.getInstance().isAppLockFeatureEnabled()) {
 401                         AppLockManager.getInstance().getAppLock().setExemptActivities(
 402                                 new String[]{&quot;com.automattic.simplenote.NotesActivity&quot;,
 403                                         &quot;com.automattic.simplenote.NoteEditorActivity&quot;});
 404                         AppLockManager.getInstance().getAppLock().setOneTimeTimeout(0);
 405                     }
 406                 }
 407             }
 408         }
 409     }
 410 
 411     private void updateNavigationDrawerItems() {
 412         boolean isAlphaSort = PrefUtils.getBoolPref(this, PrefUtils.PREF_SORT_TAGS_ALPHA);
 413         Bucket.ObjectCursor&lt;Tag&gt; tagCursor;
 414         if (isAlphaSort) {
 415             tagCursor = Tag.allSortedAlphabetically(mTagsBucket).execute();
 416         } else {
 417             tagCursor = Tag.allWithName(mTagsBucket).execute();
 418         }
 419 
 420         mTagsAdapter.changeCursor(tagCursor);
 421     }
 422 
 423     private void setSelectedTagActive() {
 424         if (mSelectedTag == null)
 425             mSelectedTag = mTagsAdapter.getDefaultItem();
 426 
 427         setTitle(mSelectedTag.name);
<abbr title=" 428         mDrawerList.setItemChecked(mTagsAdapter.getPosition(mSelectedTag) + mDrawerList.getHeaderViewsCount(), true);"> 428         mDrawerList.setItemChecked(mTagsAdapter.getPosition(mSelectedTag) + mDrawerList.getHeaderViewsCouðŸ”µ</abbr>
 429     }
 430 
 431     public TagsAdapter.TagMenuItem getSelectedTag() {
 432         if (mSelectedTag == null) {
 433             mSelectedTag = mTagsAdapter.getDefaultItem();
 434         }
 435 
 436         return mSelectedTag;
 437     }
 438 
 439     // Enable or disable the trash action bar button depending on if there are deleted notes or not
 440     public void updateTrashMenuItem() {
 441         if (mEmptyTrashMenuItem == null || mNotesBucket == null)
 442             return;
 443 
 444         // Disable the trash icon if there are no notes trashed.
 445         Query&lt;Note&gt; query = Note.allDeleted(mNotesBucket);
 446         if (query.count() == 0) {
 447             mEmptyTrashMenuItem.setEnabled(false);
 448         } else {
 449             mEmptyTrashMenuItem.setEnabled(true);
 450         }
 451     }
 452 
 453     private void addEditorFragment() {
 454         FragmentManager fm = getSupportFragmentManager();
 455         FragmentTransaction ft = fm.beginTransaction();
 456         mNoteEditorFragment = new NoteEditorFragment();
 457         ft.add(R.id.note_fragment_container, mNoteEditorFragment, TAG_NOTE_EDITOR);
 458         ft.commitAllowingStateLoss();
 459         fm.executePendingTransactions();
 460     }
 461 
 462     private boolean userAccountRequired() {
 463         return PrefUtils.getBoolPref(this, PrefUtils.PREF_ACCOUNT_REQUIRED, false);
 464     }
 465 
 466     /**
 467      * Checks for a previously valid user that is now not authenticated
 468      * Also checks if user account is required (added in version 1.5.6)
 469      *
 470      * @return true if user has invalid authorization
 471      */
 472     private boolean userAuthenticationIsInvalid() {
 473         Simplenote currentApp = (Simplenote) getApplication();
 474         Simperium simperium = currentApp.getSimperium();
 475         User user = simperium.getUser();
 476         boolean isNotAuthorized = user.getStatus().equals(User.Status.NOT_AUTHORIZED);
 477         return (user.hasAccessToken() &amp;&amp; isNotAuthorized) ||
 478                 (userAccountRequired() &amp;&amp; isNotAuthorized);
 479     }
 480 
 481     public boolean userIsUnauthorized() {
 482         Simplenote currentApp = (Simplenote) getApplication();
 483         return currentApp.getSimperium().getUser().getStatus() == User.Status.NOT_AUTHORIZED;
 484     }
 485 
 486     public void setCurrentNote(Note note) {
 487         mCurrentNote = note;
 488     }
 489 
 490     public NoteListFragment getNoteListFragment() {
 491         return mNoteListFragment;
 492     }
 493 
 494     @SuppressWarnings(&quot;ResourceType&quot;)
 495     @Override
 496     public boolean onCreateOptionsMenu(Menu menu) {
 497         super.onCreateOptionsMenu(menu);
 498         MenuInflater inflater = getMenuInflater();
 499         inflater.inflate(R.menu.notes_list, menu);
 500 
 501         // restore the search query if on a landscape tablet
 502         String searchQuery = null;
 503         if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; mSearchView != null)
 504             searchQuery = mSearchView.getQuery().toString();
 505 
 506         mSearchMenuItem = menu.findItem(R.id.menu_search);
 507         mSearchView = (SearchView) mSearchMenuItem.getActionView();
 508 
 509         if (!TextUtils.isEmpty(searchQuery)) {
 510             mSearchView.setQuery(searchQuery, false);
 511             mSearchMenuItem.expandActionView();
 512         } else {
 513             // Workaround for setting the search placeholder text color
 514             String hintHexColor = (ThemeUtils.isLightTheme(this) ?
 515                     getString(R.color.gray_light) :
 516                     getString(R.color.text_preview)).replace(&quot;ff&quot;, &quot;&quot;);
 517             mSearchView.setQueryHint(HtmlCompat.fromHtml(String.format(&quot;&lt;font color=\&quot;%s\&quot;&gt;%s&lt;/font&gt;&quot;,
 518                     hintHexColor,
 519                     getString(R.string.search))));
 520         }
 521 
 522         mSearchView.setOnQueryTextListener(new SearchView.OnQueryTextListener() {
 523             @Override
 524             public boolean onQueryTextChange(String newText) {
 525                 if (mSearchMenuItem.isActionViewExpanded()) {
 526                     getNoteListFragment().searchNotes(newText);
 527                 }
 528                 return true;
 529             }
 530 
 531             @Override
 532             public boolean onQueryTextSubmit(String queryText) {
 533                 getNoteListFragment().searchNotes(queryText);
 534                 return true;
 535             }
 536 
 537         });
 538 
 539         mSearchMenuItem.setOnActionExpandListener(new MenuItem.OnActionExpandListener() {
 540             @Override
 541             public boolean onMenuItemActionExpand(MenuItem menuItem) {
 542                 checkEmptyListText(true);
 543                 if (mNoteListFragment != null) {
 544                     mNoteListFragment.setFloatingActionButtonVisible(false);
 545                 }
 546                 AnalyticsTracker.track(
 547                         AnalyticsTracker.Stat.LIST_NOTES_SEARCHED,
 548                         AnalyticsTracker.CATEGORY_NOTE,
 549                         &quot;action_bar_search_tap&quot;
 550                 );
 551                 return true;
 552             }
 553 
 554             @Override
 555             public boolean onMenuItemActionCollapse(MenuItem menuItem) {
 556                 // Show all notes again
 557                 if (mNoteListFragment != null) {
 558                     mNoteListFragment.setFloatingActionButtonVisible(true);
 559                 }
 560                 mTabletSearchQuery = &quot;&quot;;
 561                 mSearchView.setQuery(&quot;&quot;, false);
 562                 checkEmptyListText(false);
 563                 getNoteListFragment().clearSearch();
 564                 return true;
 565             }
 566         });
 567 
 568         mSearchMenuItem.setOnMenuItemClickListener(new MenuItem.OnMenuItemClickListener() {
 569             @Override
 570             public boolean onMenuItemClick(MenuItem item) {
 571                 if (!mSearchMenuItem.isActionViewExpanded())
 572                     showDetailPlaceholder();
 573                 return false;
 574             }
 575         });
 576 
 577         MenuItem trashItem = menu.findItem(R.id.menu_delete).setTitle(R.string.undelete);
 578         if (mCurrentNote != null &amp;&amp; mCurrentNote.isDeleted()) {
 579             trashItem.setTitle(R.string.undelete);
 580             trashItem.setIcon(R.drawable.ic_trash_restore_24dp);
 581         } else {
 582             trashItem.setTitle(R.string.delete);
 583             trashItem.setIcon(R.drawable.ic_trash_24dp);
 584         }
 585 
 586         if (DisplayUtils.isLargeScreenLandscape(this)) {
 587             // Restore the search query on landscape tablets
 588             if (!TextUtils.isEmpty(mTabletSearchQuery)) {
 589                 mSearchMenuItem.expandActionView();
 590                 mSearchView.setQuery(mTabletSearchQuery, false);
 591                 mSearchView.clearFocus();
 592             }
 593 
 594             if (mCurrentNote != null) {
 595                 menu.findItem(R.id.menu_share).setVisible(true);
 596                 menu.findItem(R.id.menu_view_info).setVisible(true);
 597                 menu.findItem(R.id.menu_checklist).setVisible(true);
 598                 menu.findItem(R.id.menu_history).setVisible(true);
 599                 menu.findItem(R.id.menu_markdown_preview).setVisible(mCurrentNote.isMarkdownEnabled());
 600                 trashItem.setVisible(true);
 601             } else {
 602                 menu.findItem(R.id.menu_share).setVisible(false);
 603                 menu.findItem(R.id.menu_view_info).setVisible(false);
 604                 menu.findItem(R.id.menu_checklist).setVisible(false);
 605                 menu.findItem(R.id.menu_history).setVisible(false);
 606                 menu.findItem(R.id.menu_markdown_preview).setVisible(false);
 607                 trashItem.setVisible(false);
 608             }
 609             menu.findItem(R.id.menu_empty_trash).setVisible(false);
 610         } else {
 611             menu.findItem(R.id.menu_search).setVisible(true);
 612             menu.findItem(R.id.menu_share).setVisible(false);
 613             menu.findItem(R.id.menu_view_info).setVisible(false);
 614             menu.findItem(R.id.menu_checklist).setVisible(false);
 615             menu.findItem(R.id.menu_history).setVisible(false);
 616             menu.findItem(R.id.menu_markdown_preview).setVisible(false);
 617             trashItem.setVisible(false);
 618             menu.findItem(R.id.menu_empty_trash).setVisible(false);
 619         }
 620 
 621         // Are we looking at the trash? Adjust menu accordingly.
 622         if (mDrawerList.getCheckedItemPosition() == TRASH_SELECTED_ID) {
 623             mEmptyTrashMenuItem = menu.findItem(R.id.menu_empty_trash);
 624             mEmptyTrashMenuItem.setVisible(true);
 625 
 626             updateTrashMenuItem();
 627 
 628             menu.findItem(R.id.menu_search).setVisible(false);
 629             menu.findItem(R.id.menu_share).setVisible(false);
 630             menu.findItem(R.id.menu_history).setVisible(false);
 631             menu.findItem(R.id.menu_checklist).setVisible(false);
 632         }
 633 
 634         DrawableUtils.tintMenuWithAttribute(this, menu, R.attr.actionBarTextColor);
 635 
 636         return true;
 637     }
 638 
 639     @Override
 640     public boolean onOptionsItemSelected(MenuItem item) {
 641         if (mDrawerToggle.onOptionsItemSelected(item)) {
 642             return true;
 643         }
 644         switch (item.getItemId()) {
 645             case R.id.menu_markdown_preview:
 646                 if (mIsShowingMarkdown) {
 647                     item.setIcon(R.drawable.ic_preview_24dp);
 648                     item.setTitle(getString(R.string.markdown_show));
 649                     setMarkdownShowing(false);
 650                 } else {
 651                     item.setIcon(R.drawable.ic_preview_stop_24dp);
 652                     item.setTitle(getString(R.string.markdown_hide));
 653                     setMarkdownShowing(true);
 654                 }
 655 
 656                 DrawableUtils.tintMenuItemWithAttribute(this, item, R.attr.actionBarTextColor);
 657 
 658                 return true;
 659             case R.id.menu_delete:
 660                 if (mNoteEditorFragment != null) {
 661                     if (mCurrentNote != null) {
 662                         mCurrentNote.setDeleted(!mCurrentNote.isDeleted());
 663                         mCurrentNote.setModificationDate(Calendar.getInstance());
 664                         mCurrentNote.save();
 665 
 666                         updateViewsAfterTrashAction(mCurrentNote);
 667                     }
 668                 }
 669                 return true;
 670             case R.id.menu_empty_trash:
 671                 AlertDialog.Builder alert = new AlertDialog.Builder(this);
 672 
 673                 alert.setTitle(R.string.empty_trash);
 674                 alert.setMessage(R.string.confirm_empty_trash);
 675                 alert.setPositiveButton(R.string.yes, new DialogInterface.OnClickListener() {
 676                     public void onClick(DialogInterface dialog, int whichButton) {
 677                         new emptyTrashTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR);
 678                         AnalyticsTracker.track(
 679                                 AnalyticsTracker.Stat.LIST_TRASH_EMPTIED,
 680                                 AnalyticsTracker.CATEGORY_NOTE,
 681                                 &quot;overflow_menu&quot;
 682                         );
 683                     }
 684                 });
 685                 alert.setNegativeButton(R.string.no, new DialogInterface.OnClickListener() {
 686                     public void onClick(DialogInterface dialog, int whichButton) {
 687                         // Do nothing, just closing the dialog
 688                     }
 689                 });
 690                 alert.show();
 691                 return true;
 692             case android.R.id.home:
 693                 invalidateOptionsMenu();
 694                 return true;
 695             default:
 696                 return super.onOptionsItemSelected(item);
 697         }
 698     }
 699 
 700     @Override
 701     public boolean onPrepareOptionsMenu(Menu menu) {
 702         MenuItem markdownItem = menu.findItem(R.id.menu_markdown_preview);
 703 
 704         if (mIsShowingMarkdown) {
 705             markdownItem.setIcon(R.drawable.ic_preview_stop_24dp);
 706             markdownItem.setTitle(getString(R.string.markdown_hide));
 707         } else {
 708             markdownItem.setIcon(R.drawable.ic_preview_24dp);
 709             markdownItem.setTitle(getString(R.string.markdown_show));
 710         }
 711 
 712         DrawableUtils.tintMenuItemWithAttribute(this, markdownItem, R.attr.actionBarTextColor);
 713 
 714         return super.onPrepareOptionsMenu(menu);
 715     }
 716 
 717     public void updateViewsAfterTrashAction(Note note) {
 718         if (note == null || isFinishing()) {
 719             return;
 720         }
 721 
 722         if (note.isDeleted()) {
 723             List&lt;String&gt; deletedNoteIds = new ArrayList&lt;&gt;();
 724             deletedNoteIds.add(note.getSimperiumKey());
 725             mUndoBarController.setDeletedNoteIds(deletedNoteIds);
 726             mUndoBarController.showUndoBar(getUndoView(), getString(R.string.note_deleted));
 727             AnalyticsTracker.track(
 728                     AnalyticsTracker.Stat.LIST_NOTE_DELETED,
 729                     AnalyticsTracker.CATEGORY_NOTE,
 730                     &quot;overflow_menu&quot;
 731             );
 732         } else {
 733             AnalyticsTracker.track(
 734                     AnalyticsTracker.Stat.EDITOR_NOTE_RESTORED,
 735                     AnalyticsTracker.CATEGORY_NOTE,
 736                     &quot;overflow_menu&quot;
 737             );
 738         }
 739 
 740         // If we just deleted/restored the active note, show the placeholder
 741         if (mCurrentNote != null &amp;&amp; mCurrentNote.getSimperiumKey().equals(note.getSimperiumKey())) {
 742             showDetailPlaceholder();
 743         }
 744 
 745         NoteListFragment fragment = getNoteListFragment();
 746         if (fragment != null) {
 747             fragment.getPrefs();
 748             fragment.refreshList();
 749         }
 750 
 751         invalidateOptionsMenu();
 752     }
 753 
 754     public void setMarkdownShowing(boolean isMarkdownShowing) {
 755         mIsShowingMarkdown = isMarkdownShowing;
 756         if (mNoteEditorFragment != null) {
 757             if (isMarkdownShowing) {
 758                 mNoteEditorFragment.showMarkdown();
 759             } else {
 760                 mNoteEditorFragment.hideMarkdown();
 761             }
 762         }
 763         invalidateOptionsMenu();
 764     }
 765 
 766     /**
 767      * Callback method from {@link NoteListFragment.Callbacks} indicating that
 768      * the item with the given ID was selected. Used for tablets only.
 769      */
 770     @Override
<abbr title=" 771     public void onNoteSelected(String noteID, int position, String matchOffsets, boolean isMarkdownEnabled) {"> 771     public void onNoteSelected(String noteID, int position, String matchOffsets, boolean isMarkdownEnableðŸ”µ</abbr>
 772         if (!DisplayUtils.isLargeScreenLandscape(this)) {
 773             // Launch the editor activity
 774             Bundle arguments = new Bundle();
 775             arguments.putString(NoteEditorFragment.ARG_ITEM_ID, noteID);
 776             arguments.putBoolean(NoteEditorFragment.ARG_MARKDOWN_ENABLED, isMarkdownEnabled);
 777 
 778             if (matchOffsets != null)
 779                 arguments.putString(NoteEditorFragment.ARG_MATCH_OFFSETS, matchOffsets);
 780 
 781             Intent editNoteIntent = new Intent(this, NoteEditorActivity.class);
 782             editNoteIntent.putExtras(arguments);
 783             startActivityForResult(editNoteIntent, Simplenote.INTENT_EDIT_NOTE);
 784         } else {
 785             mNoteEditorFragment.setNote(noteID, matchOffsets);
 786             getNoteListFragment().setNoteSelected(noteID);
 787 
 788             if (mSearchView != null &amp;&amp; mSearchView.getQuery() != null) {
 789                 mTabletSearchQuery = mSearchView.getQuery().toString();
 790             }
 791 
 792             mNoteEditorFragment.clearMarkdown();
 793 
 794             if (!isMarkdownEnabled &amp;&amp; mIsShowingMarkdown) {
 795                 setMarkdownShowing(false);
 796             }
 797 
 798             invalidateOptionsMenu();
 799         }
 800 
 801         AnalyticsTracker.track(
 802                 AnalyticsTracker.Stat.LIST_NOTE_OPENED,
 803                 AnalyticsTracker.CATEGORY_NOTE,
 804                 &quot;note_list_row_tap&quot;
 805         );
 806     }
 807 
 808     @Override
 809     public void onUserCreated(User user) {
 810         // New account created
 811         AnalyticsTracker.track(
 812                 AnalyticsTracker.Stat.USER_ACCOUNT_CREATED,
 813                 AnalyticsTracker.CATEGORY_USER,
 814                 &quot;account_created_from_login_activity&quot;
 815         );
 816     }
 817 
 818     public void onUserStatusChange(User.Status status) {
 819         switch (status) {
 820             // successfully used access token to connect to simperium bucket
 821             case AUTHORIZED:
 822                 runOnUiThread(new Runnable() {
 823                     @Override
 824                     public void run() {
 825                         if (!mNotesBucket.hasChangeVersion()) {
 826                             setToolbarProgressVisibility(true);
 827                         }
 828                     }
 829                 });
 830                 break;
 831 
 832             // NOT_AUTHORIZED means we attempted to connect but the token was not valid
 833             case NOT_AUTHORIZED:
 834                 runOnUiThread(new Runnable() {
 835                     @Override
 836                     public void run() {
 837                         startLoginActivity(true);
 838                     }
 839                 });
 840                 break;
 841 
<abbr title=" 842             // Default starting state of User, don&#x27;t do anything we allow use of app while not signed in so don&#x27;t do anything"> 842             // Default starting state of User, don&#x27;t do anything we allow use of app while not signed in ðŸ”µ</abbr>
 843             case UNKNOWN:
 844                 break;
 845         }
 846     }
 847 
 848     private void setToolbarProgressVisibility(boolean isVisible) {
 849         if (getSupportActionBar() != null) {
 850             getSupportActionBar().setDisplayShowCustomEnabled(isVisible);
 851         }
 852     }
 853 
 854     public void startLoginActivity(boolean signInFirst) {
 855         // Clear some account-specific prefs
 856         SharedPreferences.Editor editor = PreferenceManager.getDefaultSharedPreferences(this).edit();
 857         editor.remove(PrefUtils.PREF_WP_TOKEN);
 858         editor.remove(PrefUtils.PREF_WORDPRESS_SITES);
 859         editor.apply();
 860 
 861         Intent loginIntent = new Intent(this, SignInActivity.class);
 862         if (signInFirst) {
 863             loginIntent.putExtra(SignInActivity.EXTRA_SIGN_IN_FIRST, true);
 864         }
 865         startActivityForResult(loginIntent, Simperium.SIGNUP_SIGNIN_REQUEST);
 866     }
 867 
 868     @Override
 869     public void recreate() {
 870         Handler handler = new Handler();
 871         handler.post(new Runnable() {
 872             @Override
 873             public void run() {
 874                 NotesActivity.super.recreate();
 875             }
 876         });
 877     }
 878 
 879     @Override
 880     protected void onActivityResult(int requestCode, int resultCode, Intent data) {
 881         super.onActivityResult(requestCode, resultCode, data);
 882         switch (requestCode) {
 883             case Simplenote.INTENT_PREFERENCES:
 884                 if (ThemeUtils.themeWasChanged(data)) {
 885                     // Restart this activity to apply the new theme
 886                     recreate();
 887                     break;
 888                 }
<abbr title=" 889                 // nbradbury - refresh note list when user returns from preferences (in case they changed anything)"> 889                 // nbradbury - refresh note list when user returns from preferences (in case they changedðŸ”µ</abbr>
 890                 invalidateOptionsMenu();
 891                 NoteListFragment fragment = getNoteListFragment();
 892                 if (fragment != null) {
 893                     fragment.getPrefs();
 894                     fragment.refreshList();
 895                 }
 896 
 897                 break;
 898             case Simplenote.INTENT_EDIT_NOTE:
 899                 if (resultCode == RESULT_OK &amp;&amp; data != null) {
 900                     if (data.hasExtra(Simplenote.DELETED_NOTE_ID)) {
 901                         String noteId = data.getStringExtra(Simplenote.DELETED_NOTE_ID);
 902                         if (noteId != null) {
 903                             List&lt;String&gt; deletedNoteIds = new ArrayList&lt;&gt;();
 904                             deletedNoteIds.add(noteId);
 905                             mUndoBarController.setDeletedNoteIds(deletedNoteIds);
<abbr title=" 906                             mUndoBarController.showUndoBar(getUndoView(), getString(R.string.note_deleted));"> 906                             mUndoBarController.showUndoBar(getUndoView(), getString(R.string.note_deletedðŸ”µ</abbr>
 907                         }
<abbr title=" 908                     } else if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; data.hasExtra(Simplenote.SELECTED_NOTE_ID)) {"> 908                     } else if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; data.hasExtra(Simplenote.SELEðŸ”µ</abbr>
 909                         String selectedNoteId = data.getStringExtra(Simplenote.SELECTED_NOTE_ID);
 910                         mNoteListFragment.setNoteSelected(selectedNoteId);
 911                         if (mNoteEditorFragment != null) {
 912                             mNoteEditorFragment.setNote(selectedNoteId);
 913                         }
 914                     }
 915                 }
 916                 break;
 917             case Simperium.SIGNUP_SIGNIN_REQUEST:
 918                 invalidateOptionsMenu();
 919 
 920                 Simplenote app = (Simplenote) getApplication();
 921                 AnalyticsTracker.refreshMetadata(app.getSimperium().getUser().getEmail());
 922 
 923                 AnalyticsTracker.track(
 924                         AnalyticsTracker.Stat.USER_SIGNED_IN,
 925                         AnalyticsTracker.CATEGORY_USER,
 926                         &quot;signed_in_from_login_activity&quot;
 927                 );
 928 
 929                 if (resultCode == Activity.RESULT_CANCELED &amp;&amp; userAuthenticationIsInvalid()) {
 930                     finish();
 931                 }
 932 
 933                 break;
 934         }
 935     }
 936 
 937     @Override
 938     public void onUndo() {
 939         if (mUndoBarController == null) return;
 940 
 941         List&lt;String&gt; deletedNoteIds = mUndoBarController.getDeletedNoteIds();
 942         if (deletedNoteIds != null) {
 943             for (int i = 0; i &lt; deletedNoteIds.size(); i++) {
 944                 Note deletedNote;
 945                 try {
 946                     deletedNote = mNotesBucket.get(deletedNoteIds.get(i));
 947                 } catch (BucketObjectMissingException e) {
 948                     return;
 949                 }
 950                 if (deletedNote != null) {
 951                     deletedNote.setDeleted(false);
 952                     deletedNote.setModificationDate(Calendar.getInstance());
 953                     deletedNote.save();
 954                     NoteListFragment fragment = getNoteListFragment();
 955                     if (fragment != null) {
 956                         fragment.getPrefs();
 957                         fragment.refreshList();
 958                     }
 959                 }
 960             }
 961         }
 962     }
 963 
 964     @Override
 965     protected void onPostCreate(Bundle savedInstanceState) {
 966         super.onPostCreate(savedInstanceState);
 967         // Sync the toggle state after onRestoreInstanceState has occurred.
 968         mDrawerToggle.syncState();
 969     }
 970 
 971     @Override
 972     public void onConfigurationChanged(Configuration newConfig) {
 973         super.onConfigurationChanged(newConfig);
 974 
 975         mDrawerToggle.onConfigurationChanged(newConfig);
 976 
 977         if (DisplayUtils.isLargeScreen(this)) {
 978             mIsShowingMarkdown = false;
 979 
 980             if (newConfig.orientation == Configuration.ORIENTATION_LANDSCAPE) {
 981                 // Add the editor fragment
 982                 if (getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR) != null) {
<abbr title=" 983                     mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR);"> 983                     mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByðŸ”µ</abbr>
 984                 } else if (DisplayUtils.isLandscape(this)) {
 985                     addEditorFragment();
 986                 }
 987                 if (mNoteListFragment != null) {
 988                     mNoteListFragment.setActivateOnItemClick(true);
 989                     mNoteListFragment.setDividerVisible(true);
 990                 }
 991                 // Select the current note on a tablet
 992                 if (mCurrentNote != null)
<abbr title=" 993                     onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled());"> 993                     onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnableðŸ”µ</abbr>
 994                 else {
 995                     mNoteEditorFragment.setPlaceholderVisible(true);
 996                     mNoteListFragment.getListView().clearChoices();
 997                 }
 998                 invalidateOptionsMenu();
 999             }
1000         }
1001 
1002         if (newConfig.orientation == Configuration.ORIENTATION_PORTRAIT &amp;&amp; mNoteEditorFragment != null) {
1003             // Remove the editor fragment when rotating back to portrait
1004             mCurrentNote = null;
1005             if (mNoteListFragment != null) {
1006                 mNoteListFragment.setActivateOnItemClick(false);
1007                 mNoteListFragment.setDividerVisible(false);
1008                 mNoteListFragment.setActivatedPosition(ListView.INVALID_POSITION);
1009                 mNoteListFragment.refreshList();
1010             }
1011             FragmentManager fm = getSupportFragmentManager();
1012             FragmentTransaction ft = fm.beginTransaction();
1013             ft.remove(mNoteEditorFragment);
1014             mNoteEditorFragment = null;
1015             ft.commitAllowingStateLoss();
1016             fm.executePendingTransactions();
1017             invalidateOptionsMenu();
1018         }
1019     }
1020 
1021     public void checkEmptyListText(boolean isSearch) {
1022         if (isSearch) {
<abbr title="1023             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_found) + &quot;&lt;/strong&gt;&quot;);">1023             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_found) + &quot;ðŸ”µ</abbr>
1024             getNoteListFragment().setEmptyListViewClickable(false);
1025         } else if (mDrawerList.getCheckedItemPosition() == TRASH_SELECTED_ID) {
<abbr title="1026             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.trash_is_empty) + &quot;&lt;/strong&gt;&quot;);">1026             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.trash_is_empty) + &quot;ðŸ”µ</abbr>
1027             AnalyticsTracker.track(
1028                     AnalyticsTracker.Stat.LIST_TRASH_VIEWED,
1029                     AnalyticsTracker.CATEGORY_NOTE,
1030                     &quot;trash_filter_selected&quot;
1031             );
1032             getNoteListFragment().setEmptyListViewClickable(false);
1033         } else {
<abbr title="1034             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here) + &quot;&lt;/strong&gt;&lt;br /&gt;&quot; + String.format(getString(R.string.why_not_create_one), &quot;&lt;u&gt;&quot;, &quot;&lt;/u&gt;&quot;));">1034             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here) + &quot;&lt;ðŸ”µ</abbr>
1035             getNoteListFragment().setEmptyListViewClickable(true);
1036         }
1037     }
1038 
1039     public void showDetailPlaceholder() {
1040         if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; mNoteEditorFragment != null) {
1041             mCurrentNote = null;
1042             mNoteEditorFragment.setPlaceholderVisible(true);
1043             mNoteEditorFragment.clearMarkdown();
1044             mNoteEditorFragment.hideMarkdown();
1045             mIsShowingMarkdown = false;
1046         }
1047     }
1048 
1049     public void stopListeningToNotesBucket() {
1050         mNotesBucket.removeOnNetworkChangeListener(this);
1051         mNotesBucket.removeOnSaveObjectListener(this);
1052         mNotesBucket.removeOnDeleteObjectListener(this);
1053     }
1054 
1055     // Returns the appropriate view to show the undo bar within
1056     private View getUndoView() {
1057         View undoView = mFragmentsContainer;
1058         if (!DisplayUtils.isLargeScreenLandscape(this) &amp;&amp;
1059                 getNoteListFragment() != null &amp;&amp;
1060                 getNoteListFragment().getRootView() != null) {
1061             undoView = getNoteListFragment().getRootView();
1062         }
1063 
1064         return undoView;
1065     }
1066 
1067     public void showUndoBarWithNoteIds(List&lt;String&gt; noteIds) {
1068         if (mUndoBarController != null) {
1069             mUndoBarController.setDeletedNoteIds(noteIds);
1070             mUndoBarController.showUndoBar(
1071                     getUndoView(),
<abbr title="1072                     getResources().getQuantityString(R.plurals.trashed_notes, noteIds.size(), noteIds.size())">1072                     getResources().getQuantityString(R.plurals.trashed_notes, noteIds.size(), noteIds.sizðŸ”µ</abbr>
1073             );
1074         }
1075     }
1076 
1077     /* Simperium Bucket Listeners */
1078     // received a change from the network, refresh the list
1079     @Override
1080     public void onNetworkChange(Bucket&lt;Note&gt; bucket, final Bucket.ChangeType type, String key) {
1081         runOnUiThread(new Runnable() {
1082             @Override
1083             public void run() {
1084                 if (type == Bucket.ChangeType.INDEX) {
1085                     setToolbarProgressVisibility(false);
1086                 }
1087                 mNoteListFragment.refreshList();
1088             }
1089         });
1090     }
1091 
1092     @Override
1093     public void onSaveObject(Bucket&lt;Note&gt; bucket, Note object) {
1094         runOnUiThread(new Runnable() {
1095             @Override
1096             public void run() {
1097                 mNoteListFragment.refreshList();
1098             }
1099         });
1100     }
1101 
1102     @Override
1103     public void onDeleteObject(Bucket&lt;Note&gt; bucket, Note object) {
1104         runOnUiThread(new Runnable() {
1105             @Override
1106             public void run() {
1107                 mNoteListFragment.refreshList();
1108             }
1109         });
1110     }
1111 
1112     @Override
1113     public void onBeforeUpdateObject(Bucket&lt;Note&gt; bucket, Note note) {
1114         // noop, NoteEditorFragment will handle this
1115     }
1116 
1117     /* The click listener for ListView in the navigation drawer */
1118     private class DrawerItemClickListener implements ListView.OnItemClickListener {
1119         @Override
1120         public void onItemClick(AdapterView&lt;?&gt; parent, View view, int position, long id) {
1121 
1122             // Adjust for header view
1123             position -= mDrawerList.getHeaderViewsCount();
1124             mSelectedTag = mTagsAdapter.getItem(position);
1125             checkEmptyListText(false);
1126             // Update checked item in navigation drawer and close it
1127             setSelectedTagActive();
1128             mDrawerLayout.closeDrawer(mNavigationView);
1129             updateNavigationDrawerItems();
1130 
1131             // Disable long press on notes if we&#x27;re viewing the trash
1132             if (mDrawerList.getCheckedItemPosition() == TRASH_SELECTED_ID) {
1133                 getNoteListFragment().getListView().setLongClickable(false);
1134             } else {
1135                 getNoteListFragment().getListView().setLongClickable(true);
1136             }
1137 
1138             getNoteListFragment().refreshListFromNavSelect();
1139             if (position &gt; 1) {
1140                 AnalyticsTracker.track(
1141                         AnalyticsTracker.Stat.LIST_TAG_VIEWED,
1142                         AnalyticsTracker.CATEGORY_TAG,
1143                         &quot;selected_tag_in_navigation_drawer&quot;
1144                 );
1145             }
1146         }
1147     }
1148 
1149     private class emptyTrashTask extends AsyncTask&lt;Void, Void, Void&gt; {
1150 
1151         @Override
1152         protected Void doInBackground(Void... voids) {
1153             if (mNotesBucket == null) return null;
1154 
1155             Query&lt;Note&gt; query = Note.allDeleted(mNotesBucket);
1156             Bucket.ObjectCursor c = query.execute();
1157             while (c.moveToNext()) {
1158                 c.getObject().delete();
1159             }
1160 
1161             return null;
1162         }
1163 
1164         @Override
1165         protected void onPostExecute(Void nada) {
1166             showDetailPlaceholder();
1167         }
1168     }
1169 }
 </pre></td>
                            <td><pre>   1 package com.automattic.simplenote;
   2 
   3 import android.app.Activity;
   4 import android.app.AlertDialog;
   5 import android.content.DialogInterface;
   6 import android.content.Intent;
   7 import android.content.SharedPreferences;
   8 import android.content.res.Configuration;
   9 import android.os.AsyncTask;
  10 import android.os.Build;
  11 import android.os.Bundle;
  12 import android.os.Handler;
  13 import android.support.design.widget.NavigationView;
  14 import android.support.v4.app.FragmentManager;
  15 import android.support.v4.app.FragmentTransaction;
  16 import android.support.v4.content.ContextCompat;
  17 import android.support.v4.view.GravityCompat;
  18 import android.support.v4.widget.DrawerLayout;
  19 import android.support.v7.app.ActionBar;
  20 import android.support.v7.app.ActionBarDrawerToggle;
  21 import android.support.v7.app.AppCompatActivity;
  22 import android.support.v7.preference.PreferenceManager;
  23 import android.support.v7.widget.SearchView;
  24 import android.support.v7.widget.Toolbar;
  25 import android.text.Spannable;
  26 import android.text.SpannableString;
  27 import android.text.TextUtils;
  28 import android.view.Menu;
  29 import android.view.MenuInflater;
  30 import android.view.MenuItem;
  31 import android.view.View;
  32 import android.view.WindowInsets;
  33 import android.view.WindowManager;
  34 import android.widget.AdapterView;
  35 import android.widget.LinearLayout;
  36 import android.widget.ListView;
  37 import android.widget.ProgressBar;
  38 import com.automattic.simplenote.analytics.AnalyticsTracker;
  39 import com.automattic.simplenote.models.Note;
  40 import com.automattic.simplenote.models.Tag;
  41 import com.automattic.simplenote.utils.DisplayUtils;
  42 import com.automattic.simplenote.utils.DrawableUtils;
  43 import com.automattic.simplenote.utils.HtmlCompat;
  44 import com.automattic.simplenote.utils.PrefUtils;
  45 import com.automattic.simplenote.utils.StrUtils;
  46 import com.automattic.simplenote.utils.TagsAdapter;
  47 import com.automattic.simplenote.utils.ThemeUtils;
  48 import com.automattic.simplenote.utils.UndoBarController;
  49 import com.automattic.simplenote.widgets.TypefaceSpan;
  50 import com.simperium.Simperium;
  51 import com.simperium.client.Bucket;
  52 import com.simperium.client.BucketObjectMissingException;
  53 import com.simperium.client.BucketObjectNameInvalid;
  54 import com.simperium.client.Query;
  55 import com.simperium.client.User;
  56 import java.util.ArrayList;
  57 import java.util.Calendar;
  58 import java.util.List;
  59 import org.wordpress.passcodelock.AppLockManager;
  60 import static com.automattic.simplenote.utils.DisplayUtils.disableScreenshotsIfLocked;
  61 
  62 
<abbr title="  63 public class NotesActivity extends AppCompatActivity implements NoteListFragment.Callbacks , User.StatusChangeListener , Simperium.OnUserCreatedListener , UndoBarController.UndoListener , Bucket.Listener&lt;Note&gt; {">  63 public class NotesActivity extends AppCompatActivity implements NoteListFragment.Callbacks , User.StatusCðŸ”µ</abbr>
  64     public static String TAG_NOTE_LIST = &quot;noteList&quot;;
  65 
  66     public static String TAG_NOTE_EDITOR = &quot;noteEditor&quot;;
  67 
  68     protected Bucket&lt;Note&gt; mNotesBucket;
  69 
  70     protected Bucket&lt;Tag&gt; mTagsBucket;
  71 
  72     private int TRASH_SELECTED_ID = 1;
  73 
  74     private boolean mIsShowingMarkdown;
  75 
  76     private boolean mShouldSelectNewNote;
  77 
  78     private String mTabletSearchQuery;
  79 
  80     private UndoBarController mUndoBarController;
  81 
  82     private View mFragmentsContainer;
  83 
  84     private SearchView mSearchView;
  85 
  86     private MenuItem mSearchMenuItem;
  87 
  88     private NoteListFragment mNoteListFragment;
  89 
  90     private NoteEditorFragment mNoteEditorFragment;
  91 
  92     private Note mCurrentNote;
  93 
  94     private MenuItem mEmptyTrashMenuItem;
  95 
  96     // Menu drawer
  97     // Menu drawer
  98     private DrawerLayout mDrawerLayout;
  99 
 100     private ListView mDrawerList;
 101 
 102     private NavigationView mNavigationView;
 103 
 104     private ActionBarDrawerToggle mDrawerToggle;
 105 
 106     private TagsAdapter mTagsAdapter;
 107 
 108     private TagsAdapter.TagMenuItem mSelectedTag;
 109 
 110     // Tags bucket listener
 111     // Tags bucket listener
 112     private Bucket.Listener&lt;Tag&gt; mTagsMenuUpdater = new Bucket.Listener&lt;Tag&gt;() {
 113         void updateNavigationDrawer() {
 114             runOnUiThread(new Runnable() {
 115                 public void run() {
 116                     updateNavigationDrawerItems();
 117                 }
 118             });
 119         }
 120 
 121         @Override
 122         public void onSaveObject(Bucket&lt;Tag&gt; bucket, Tag tag) {
 123             updateNavigationDrawer();
 124         }
 125 
 126         @Override
 127         public void onDeleteObject(Bucket&lt;Tag&gt; bucket, Tag tag) {
 128             updateNavigationDrawer();
 129         }
 130 
 131         @Override
 132         public void onNetworkChange(Bucket&lt;Tag&gt; bucket, Bucket.ChangeType type, String key) {
 133             updateNavigationDrawer();
 134         }
 135 
 136         @Override
 137         public void onBeforeUpdateObject(Bucket&lt;Tag&gt; bucket, Tag object) {
 138             // noop
 139         }
 140     };
 141 
 142     @Override
 143     protected void onCreate(Bundle savedInstanceState) {
 144         // On lollipop, configure the translucent status bar
 145         if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.LOLLIPOP) {
 146             getWindow().addFlags(WindowManager.LayoutParams.FLAG_DRAWS_SYSTEM_BAR_BACKGROUNDS);
<abbr title=" 147             getWindow().setStatusBarColor(ContextCompat.getColor(this, android.R.color.translucent_grey_medium_light));"> 147             getWindow().setStatusBarColor(ContextCompat.getColor(this, android.R.color.translucent_grey_mðŸ”µ</abbr>
 148         }
 149         ThemeUtils.setTheme(this);
 150         super.onCreate(savedInstanceState);
 151         setContentView(R.layout.activity_notes);
 152         mFragmentsContainer = findViewById(R.id.note_fragment_container);
 153         Simplenote currentApp = ((Simplenote) (getApplication()));
 154         if (mNotesBucket == null) {
 155             mNotesBucket = currentApp.getNotesBucket();
 156         }
 157         if (mTagsBucket == null) {
 158             mTagsBucket = currentApp.getTagsBucket();
 159         }
 160         Toolbar toolbar = findViewById(R.id.toolbar);
 161         setSupportActionBar(toolbar);
 162         configureNavigationDrawer(toolbar);
 163         if (savedInstanceState == null) {
 164             mNoteListFragment = new NoteListFragment();
 165             FragmentTransaction fragmentTransaction = getSupportFragmentManager().beginTransaction();
 166             fragmentTransaction.add(R.id.note_fragment_container, mNoteListFragment, TAG_NOTE_LIST);
 167             fragmentTransaction.commit();
 168         } else {
<abbr title=" 169             mNoteListFragment = ((NoteListFragment) (getSupportFragmentManager().findFragmentByTag(TAG_NOTE_LIST)));"> 169             mNoteListFragment = ((NoteListFragment) (getSupportFragmentManager().findFragmentByTag(TAG_NOðŸ”µ</abbr>
 170         }
 171         if (DisplayUtils.isLargeScreen(this)) {
 172             if (getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR) != null) {
<abbr title=" 173                 mNoteEditorFragment = ((NoteEditorFragment) (getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR)));"> 173                 mNoteEditorFragment = ((NoteEditorFragment) (getSupportFragmentManager().findFragmentByTaðŸ”µ</abbr>
 174             } else if (DisplayUtils.isLandscape(this)) {
 175                 addEditorFragment();
 176             }
 177         }
 178         // enable ActionBar app icon to behave as action to toggle nav drawer
 179         ActionBar actionBar = getSupportActionBar();
 180         if (actionBar != null) {
 181             actionBar.setDisplayHomeAsUpEnabled(true);
 182             actionBar.setHomeButtonEnabled(true);
 183             // Add loading indicator to show when indexing
<abbr title=" 184             ProgressBar progressBar = ((ProgressBar) (getLayoutInflater().inflate(R.layout.progressbar_toolbar, null)));"> 184             ProgressBar progressBar = ((ProgressBar) (getLayoutInflater().inflate(R.layout.progressbar_toðŸ”µ</abbr>
 185             actionBar.setDisplayShowCustomEnabled(true);
 186             actionBar.setCustomView(progressBar);
 187             setToolbarProgressVisibility(false);
 188         }
 189         mUndoBarController = new UndoBarController(this);
 190         // Creates &#x27;Welcome&#x27; note
 191         checkForFirstLaunch();
 192         checkForSharedContent();
 193         currentApp.getSimperium().setOnUserCreatedListener(this);
 194         currentApp.getSimperium().setUserStatusChangeListener(this);
 195     }
 196 
 197     @Override
 198     protected void onResume() {
 199         super.onResume();
 200 
 201         // Ensure user has valid authorization
 202         if (userAuthenticationIsInvalid()) {
 203             startLoginActivity(true);
 204         }
 205 
 206         disableScreenshotsIfLocked(this);
 207 
 208         mNotesBucket.start();
 209         mTagsBucket.start();
 210 
 211         mNotesBucket.addOnNetworkChangeListener(this);
 212         mNotesBucket.addOnSaveObjectListener(this);
 213         mNotesBucket.addOnDeleteObjectListener(this);
 214         mTagsBucket.addListener(mTagsMenuUpdater);
 215 
 216         updateNavigationDrawerItems();
 217 
 218         // if the user is not authenticated and the tag doesn&#x27;t exist revert to default drawer selection
 219         if (userIsUnauthorized()) {
 220             if (-1 == mTagsAdapter.getPosition(mSelectedTag)) {
 221                 mSelectedTag = null;
 222                 mDrawerList.setSelection(TagsAdapter.DEFAULT_ITEM_POSITION);
 223             }
 224         }
 225 
 226         setSelectedTagActive();
 227 
 228         if (mCurrentNote != null &amp;&amp; mShouldSelectNewNote) {
 229             onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled());
 230             mShouldSelectNewNote = false;
 231         }
 232 
 233         if (mIsShowingMarkdown) {
 234             setMarkdownShowing(false);
 235         }
 236 
 237     }
 238 
 239     @Override
 240     protected void onPause() {
 241         super.onPause();  // Always call the superclass method first
 242         mTagsBucket.removeListener(mTagsMenuUpdater);
 243         mTagsBucket.stop();
 244 
 245         mNotesBucket.removeOnNetworkChangeListener(this);
 246         mNotesBucket.removeOnSaveObjectListener(this);
 247         mNotesBucket.removeOnDeleteObjectListener(this);
 248         mNotesBucket.stop();
 249     }
 250 
 251     @Override
 252     public void setTitle(CharSequence title) {
 253         if (title == null) {
 254             title = &quot;&quot;;
 255         }
 256 
 257         setTitleWithCustomFont(title);
 258     }
 259 
 260     @Override
 261     public void onBackPressed() {
 262         if (mDrawerLayout != null &amp;&amp; mDrawerLayout.isDrawerOpen(GravityCompat.START)) {
 263             mDrawerLayout.closeDrawer(GravityCompat.START);
 264         } else {
 265             super.onBackPressed();
 266         }
 267     }
 268 
 269     private void setTitleWithCustomFont(CharSequence title) {
 270         if (getSupportActionBar() == null) return;
 271 
 272         // LG devices running 4.1 can&#x27;t handle a custom font in the action bar title
 273         if ((!TextUtils.isEmpty(Build.BRAND) &amp;&amp; Build.BRAND.toLowerCase().contains(&quot;lge&quot;))
 274                 &amp;&amp; Build.VERSION.SDK_INT &lt;= Build.VERSION_CODES.JELLY_BEAN) {
 275             getSupportActionBar().setTitle(title);
 276             return;
 277         }
 278 
 279         SpannableString s = new SpannableString(title);
 280         s.setSpan(new TypefaceSpan(this), 0, s.length(), Spannable.SPAN_EXCLUSIVE_EXCLUSIVE);
 281         getSupportActionBar().setTitle(s);
 282     }
 283 
 284     private void configureNavigationDrawer(Toolbar toolbar) {
 285         mDrawerLayout = findViewById(R.id.drawer_layout);
 286         mDrawerLayout.setDrawerShadow(R.drawable.drawer_shadow, GravityCompat.START);
 287         mNavigationView = findViewById(R.id.navigation_view);
 288         mDrawerList = findViewById(R.id.drawer_list);
 289         if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.LOLLIPOP) {
 290             mNavigationView.setOnApplyWindowInsetsListener(new View.OnApplyWindowInsetsListener() {
 291                 @Override
 292                 public WindowInsets onApplyWindowInsets(View view, WindowInsets windowInsets) {
 293                     LinearLayout drawerView = findViewById(R.id.drawer_view);
<abbr title=" 294                     drawerView.setPadding(drawerView.getPaddingLeft(), windowInsets.getSystemWindowInsetTop(), drawerView.getPaddingRight(), drawerView.getPaddingBottom());"> 294                     drawerView.setPadding(drawerView.getPaddingLeft(), windowInsets.getSystemWindowInsetTðŸ”µ</abbr>
 295                     return windowInsets.consumeSystemWindowInsets();
 296                 }
 297             });
 298         }
 299         View settingsButton = findViewById(R.id.nav_settings);
 300         settingsButton.setOnClickListener(new View.OnClickListener() {
 301             @Override
 302             public void onClick(View v) {
 303                 Intent i = new Intent(NotesActivity.this, PreferencesActivity.class);
 304                 startActivityForResult(i, Simplenote.INTENT_PREFERENCES);
 305             }
 306         });
 307         mNavigationView.getLayoutParams().width = ThemeUtils.getOptimalDrawerWidth(this);
 308         mTagsAdapter = new TagsAdapter(this, mNotesBucket, mDrawerList.getHeaderViewsCount());
 309         mDrawerList.setAdapter(mTagsAdapter);
 310         // Set the list&#x27;s click listener
 311         mDrawerList.setOnItemClickListener(new DrawerItemClickListener());
 312         if (mSelectedTag == null) {
 313             mSelectedTag = mTagsAdapter.getDefaultItem();
 314         }
<abbr title=" 315         mDrawerToggle = new ActionBarDrawerToggle(this, mDrawerLayout, toolbar, R.string.open_drawer, R.string.close_drawer) {"> 315         mDrawerToggle = new ActionBarDrawerToggle(this, mDrawerLayout, toolbar, R.string.open_drawer, R.sðŸ”µ</abbr>
 316             public void onDrawerClosed(View view) {
 317                 supportInvalidateOptionsMenu();
 318             }
 319 
 320             public void onDrawerOpened(View drawerView) {
 321                 // noop
 322             }
 323 
 324             @Override
 325             public void onDrawerSlide(View drawerView, float slideOffset) {
 326                 super.onDrawerSlide(drawerView, 0.0F);
 327             }
 328         };
 329         mDrawerLayout.addDrawerListener(mDrawerToggle);
 330     }
 331 
 332     private void checkForFirstLaunch() {
 333         if (PrefUtils.getBoolPref(this, PrefUtils.PREF_FIRST_LAUNCH, true)) {
 334             // Create the welcome note
 335             try {
 336                 Note welcomeNote = mNotesBucket.newObject(&quot;welcome-android&quot;);
 337                 welcomeNote.setCreationDate(Calendar.getInstance());
 338                 welcomeNote.setModificationDate(welcomeNote.getCreationDate());
 339                 welcomeNote.setContent(getString(R.string.welcome_note));
 340                 welcomeNote.getTitle();
 341                 welcomeNote.save();
 342             } catch (BucketObjectNameInvalid e) {
 343                 // this won&#x27;t happen because welcome-android is a valid name
 344             }
 345 
 346             SharedPreferences preferences = PreferenceManager.getDefaultSharedPreferences(this);
 347             SharedPreferences.Editor editor = preferences.edit();
 348             editor.putBoolean(PrefUtils.PREF_FIRST_LAUNCH, false);
 349             editor.putBoolean(PrefUtils.PREF_ACCOUNT_REQUIRED, true);
 350             editor.apply();
 351         }
 352     }
 353 
 354     private void checkForSharedContent() {
 355         if (getIntent().hasExtra(Intent.EXTRA_TEXT)) {
 356             // Check share action
 357             Intent intent = getIntent();
 358             String subject = intent.getStringExtra(Intent.EXTRA_SUBJECT);
 359             String text = intent.getStringExtra(Intent.EXTRA_TEXT);
 360 
<abbr title=" 361             // Don&#x27;t add the &#x27;Note to self&#x27; subject or open the note if this was shared from a voice search"> 361             // Don&#x27;t add the &#x27;Note to self&#x27; subject or open the note if this was shared from a voice searðŸ”µ</abbr>
 362             String intentAction = StrUtils.notNullStr(intent.getAction());
 363             boolean isVoiceShare = intentAction.equals(&quot;com.google.android.gm.action.AUTO_SEND&quot;);
 364             if (!TextUtils.isEmpty(text)) {
 365                 if (!TextUtils.isEmpty(subject) &amp;&amp; !isVoiceShare) {
 366                     text = subject + &quot;\n\n&quot; + text;
 367                 }
 368                 Note note = mNotesBucket.newObject();
 369                 note.setCreationDate(Calendar.getInstance());
 370                 note.setModificationDate(note.getCreationDate());
 371                 note.setContent(text);
 372                 note.save();
 373                 setCurrentNote(note);
 374                 mShouldSelectNewNote = true;
 375 
 376                 AnalyticsTracker.track(
 377                         AnalyticsTracker.Stat.LIST_NOTE_CREATED,
 378                         AnalyticsTracker.CATEGORY_NOTE,
 379                         &quot;external_share&quot;
 380                 );
 381 
 382                 if (!DisplayUtils.isLargeScreenLandscape(this)) {
 383                     // Disable the lock screen when sharing content and opening NoteEditorActivity
 384                     // Lock screen activities are enabled again in NoteEditorActivity.onPause()
 385                     if (AppLockManager.getInstance().isAppLockFeatureEnabled()) {
 386                         AppLockManager.getInstance().getAppLock().setExemptActivities(
 387                                 new String[]{&quot;com.automattic.simplenote.NotesActivity&quot;,
 388                                         &quot;com.automattic.simplenote.NoteEditorActivity&quot;});
 389                         AppLockManager.getInstance().getAppLock().setOneTimeTimeout(0);
 390                     }
 391                 }
 392             }
 393         }
 394     }
 395 
 396     private void updateNavigationDrawerItems() {
 397         boolean isAlphaSort = PrefUtils.getBoolPref(this, PrefUtils.PREF_SORT_TAGS_ALPHA);
 398         Bucket.ObjectCursor&lt;Tag&gt; tagCursor;
 399         if (isAlphaSort) {
 400             tagCursor = Tag.allSortedAlphabetically(mTagsBucket).execute();
 401         } else {
 402             tagCursor = Tag.allWithName(mTagsBucket).execute();
 403         }
 404 
 405         mTagsAdapter.changeCursor(tagCursor);
 406     }
 407 
 408     private void setSelectedTagActive() {
 409         if (mSelectedTag == null)
 410             mSelectedTag = mTagsAdapter.getDefaultItem();
 411 
 412         setTitle(mSelectedTag.name);
<abbr title=" 413         mDrawerList.setItemChecked(mTagsAdapter.getPosition(mSelectedTag) + mDrawerList.getHeaderViewsCount(), true);"> 413         mDrawerList.setItemChecked(mTagsAdapter.getPosition(mSelectedTag) + mDrawerList.getHeaderViewsCouðŸ”µ</abbr>
 414     }
 415 
 416     public TagsAdapter.TagMenuItem getSelectedTag() {
 417         if (mSelectedTag == null) {
 418             mSelectedTag = mTagsAdapter.getDefaultItem();
 419         }
 420 
 421         return mSelectedTag;
 422     }
 423 
 424     // Enable or disable the trash action bar button depending on if there are deleted notes or not
 425     public void updateTrashMenuItem() {
 426         if (mEmptyTrashMenuItem == null || mNotesBucket == null)
 427             return;
 428 
 429         // Disable the trash icon if there are no notes trashed.
 430         Query&lt;Note&gt; query = Note.allDeleted(mNotesBucket);
 431         if (query.count() == 0) {
 432             mEmptyTrashMenuItem.setEnabled(false);
 433         } else {
 434             mEmptyTrashMenuItem.setEnabled(true);
 435         }
 436     }
 437 
 438     private void addEditorFragment() {
 439         FragmentManager fm = getSupportFragmentManager();
 440         FragmentTransaction ft = fm.beginTransaction();
 441         mNoteEditorFragment = new NoteEditorFragment();
 442         ft.add(R.id.note_fragment_container, mNoteEditorFragment, TAG_NOTE_EDITOR);
 443         ft.commitAllowingStateLoss();
 444         fm.executePendingTransactions();
 445     }
 446 
 447     private boolean userAccountRequired() {
 448         return PrefUtils.getBoolPref(this, PrefUtils.PREF_ACCOUNT_REQUIRED, false);
 449     }
 450 
 451     /**
 452      * Checks for a previously valid user that is now not authenticated
 453      * Also checks if user account is required (added in version 1.5.6)
 454      *
 455      * @return true if user has invalid authorization
 456      */
 457     private boolean userAuthenticationIsInvalid() {
 458         Simplenote currentApp = (Simplenote) getApplication();
 459         Simperium simperium = currentApp.getSimperium();
 460         User user = simperium.getUser();
 461         boolean isNotAuthorized = user.getStatus().equals(User.Status.NOT_AUTHORIZED);
 462         return (user.hasAccessToken() &amp;&amp; isNotAuthorized) ||
 463                 (userAccountRequired() &amp;&amp; isNotAuthorized);
 464     }
 465 
 466     public boolean userIsUnauthorized() {
 467         Simplenote currentApp = (Simplenote) getApplication();
 468         return currentApp.getSimperium().getUser().getStatus() == User.Status.NOT_AUTHORIZED;
 469     }
 470 
 471     public void setCurrentNote(Note note) {
 472         mCurrentNote = note;
 473     }
 474 
 475     public NoteListFragment getNoteListFragment() {
 476         return mNoteListFragment;
 477     }
 478 
 479     @SuppressWarnings(&quot;ResourceType&quot;)
 480     @Override
 481     public boolean onCreateOptionsMenu(Menu menu) {
 482         super.onCreateOptionsMenu(menu);
 483         MenuInflater inflater = getMenuInflater();
 484         inflater.inflate(R.menu.notes_list, menu);
 485         // restore the search query if on a landscape tablet
 486         String searchQuery = null;
 487         if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; (mSearchView != null)) {
 488             searchQuery = mSearchView.getQuery().toString();
 489         }
 490         mSearchMenuItem = menu.findItem(R.id.menu_search);
 491         mSearchView = ((SearchView) (mSearchMenuItem.getActionView()));
 492         if (!TextUtils.isEmpty(searchQuery)) {
 493             mSearchView.setQuery(searchQuery, false);
 494             mSearchMenuItem.expandActionView();
 495         } else {
 496             // Workaround for setting the search placeholder text color
<abbr title=" 497             String hintHexColor = (ThemeUtils.isLightTheme(this) ? getString(R.color.gray_light) : getString(R.color.text_preview)).replace(&quot;ff&quot;, &quot;&quot;);"> 497             String hintHexColor = (ThemeUtils.isLightTheme(this) ? getString(R.color.gray_light) : getStrðŸ”µ</abbr>
<abbr title=" 498             mSearchView.setQueryHint(HtmlCompat.fromHtml(String.format(&quot;&lt;font color=\&quot;%s\&quot;&gt;%s&lt;/font&gt;&quot;, hintHexColor, getString(R.string.search))));"> 498             mSearchView.setQueryHint(HtmlCompat.fromHtml(String.format(&quot;&lt;font color=\&quot;%s\&quot;&gt;%s&lt;/font&gt;&quot;, hiðŸ”µ</abbr>
 499         }
 500         mSearchView.setOnQueryTextListener(new SearchView.OnQueryTextListener() {
 501             @Override
 502             public boolean onQueryTextChange(String newText) {
 503                 if (mSearchMenuItem.isActionViewExpanded()) {
 504                     getNoteListFragment().searchNotes(newText);
 505                 }
 506                 return true;
 507             }
 508 
 509             @Override
 510             public boolean onQueryTextSubmit(String queryText) {
 511                 getNoteListFragment().searchNotes(queryText);
 512                 return true;
 513             }
 514         });
 515         mSearchMenuItem.setOnActionExpandListener(new MenuItem.OnActionExpandListener() {
 516             @Override
 517             public boolean onMenuItemActionExpand(MenuItem menuItem) {
 518                 checkEmptyListText(true);
 519                 if (mNoteListFragment != null) {
 520                     mNoteListFragment.setFloatingActionButtonVisible(false);
 521                 }
 522                 AnalyticsTracker.track(
 523                         AnalyticsTracker.Stat.LIST_NOTES_SEARCHED,
 524                         AnalyticsTracker.CATEGORY_NOTE,
 525                         &quot;action_bar_search_tap&quot;
 526                 );
 527                 return true;
 528             }
 529 
 530             @Override
 531             public boolean onMenuItemActionCollapse(MenuItem menuItem) {
 532                 // Show all notes again
 533                 if (mNoteListFragment != null) {
 534                     mNoteListFragment.setFloatingActionButtonVisible(true);
 535                 }
 536                 mTabletSearchQuery = &quot;&quot;;
 537                 mSearchView.setQuery(&quot;&quot;, false);
 538                 checkEmptyListText(false);
 539                 getNoteListFragment().clearSearch();
 540                 return true;
 541             }
 542         });
 543         mSearchMenuItem.setOnMenuItemClickListener(new MenuItem.OnMenuItemClickListener() {
 544             @Override
 545             public boolean onMenuItemClick(MenuItem item) {
 546                 if (!mSearchMenuItem.isActionViewExpanded()) {
 547                     showDetailPlaceholder();
 548                 }
 549                 return false;
 550             }
 551         });
 552         MenuItem trashItem = menu.findItem(R.id.menu_delete).setTitle(R.string.undelete);
 553         if ((mCurrentNote != null) &amp;&amp; mCurrentNote.isDeleted()) {
 554             trashItem.setTitle(R.string.undelete);
 555             trashItem.setIcon(R.drawable.ic_trash_restore_24dp);
 556         } else {
 557             trashItem.setTitle(R.string.delete);
 558             trashItem.setIcon(R.drawable.ic_trash_24dp);
 559         }
 560         if (DisplayUtils.isLargeScreenLandscape(this)) {
 561             // Restore the search query on landscape tablets
 562             if (!TextUtils.isEmpty(mTabletSearchQuery)) {
 563                 mSearchMenuItem.expandActionView();
 564                 mSearchView.setQuery(mTabletSearchQuery, false);
 565                 mSearchView.clearFocus();
 566             }
 567             if (mCurrentNote != null) {
 568                 menu.findItem(R.id.menu_share).setVisible(true);
 569                 menu.findItem(R.id.menu_view_info).setVisible(true);
 570                 menu.findItem(R.id.menu_checklist).setVisible(true);
 571                 menu.findItem(R.id.menu_history).setVisible(true);
 572                 menu.findItem(R.id.menu_markdown_preview).setVisible(mCurrentNote.isMarkdownEnabled());
 573                 trashItem.setVisible(true);
 574             } else {
 575                 menu.findItem(R.id.menu_share).setVisible(false);
 576                 menu.findItem(R.id.menu_view_info).setVisible(false);
 577                 menu.findItem(R.id.menu_checklist).setVisible(false);
 578                 menu.findItem(R.id.menu_history).setVisible(false);
 579                 menu.findItem(R.id.menu_markdown_preview).setVisible(false);
 580                 trashItem.setVisible(false);
 581             }
 582             menu.findItem(R.id.menu_empty_trash).setVisible(false);
 583         } else {
 584             menu.findItem(R.id.menu_search).setVisible(true);
 585             menu.findItem(R.id.menu_share).setVisible(false);
 586             menu.findItem(R.id.menu_view_info).setVisible(false);
 587             menu.findItem(R.id.menu_checklist).setVisible(false);
 588             menu.findItem(R.id.menu_history).setVisible(false);
 589             menu.findItem(R.id.menu_markdown_preview).setVisible(false);
 590             trashItem.setVisible(false);
 591             menu.findItem(R.id.menu_empty_trash).setVisible(false);
 592         }
 593         // Are we looking at the trash? Adjust menu accordingly.
 594         if (mDrawerList.getCheckedItemPosition() == TRASH_SELECTED_ID) {
 595             mEmptyTrashMenuItem = menu.findItem(R.id.menu_empty_trash);
 596             mEmptyTrashMenuItem.setVisible(true);
 597             updateTrashMenuItem();
 598             menu.findItem(R.id.menu_search).setVisible(false);
 599             menu.findItem(R.id.menu_share).setVisible(false);
 600             menu.findItem(R.id.menu_history).setVisible(false);
 601             menu.findItem(R.id.menu_checklist).setVisible(false);
 602         }
 603         DrawableUtils.tintMenuWithAttribute(this, menu, R.attr.actionBarTextColor);
 604         return true;
 605     }
 606 
 607     @Override
 608     public boolean onOptionsItemSelected(MenuItem item) {
 609         if (mDrawerToggle.onOptionsItemSelected(item)) {
 610             return true;
 611         }
 612         switch (item.getItemId()) {
 613             case R.id.menu_markdown_preview:
 614                 if (mIsShowingMarkdown) {
 615                     item.setIcon(R.drawable.ic_preview_24dp);
 616                     item.setTitle(getString(R.string.markdown_show));
 617                     setMarkdownShowing(false);
 618                 } else {
 619                     item.setIcon(R.drawable.ic_preview_stop_24dp);
 620                     item.setTitle(getString(R.string.markdown_hide));
 621                     setMarkdownShowing(true);
 622                 }
 623 
 624                 DrawableUtils.tintMenuItemWithAttribute(this, item, R.attr.actionBarTextColor);
 625 
 626                 return true;
 627             case R.id.menu_delete:
 628                 if (mNoteEditorFragment != null) {
 629                     if (mCurrentNote != null) {
 630                         mCurrentNote.setDeleted(!mCurrentNote.isDeleted());
 631                         mCurrentNote.setModificationDate(Calendar.getInstance());
 632                         mCurrentNote.save();
 633 
 634                         updateViewsAfterTrashAction(mCurrentNote);
 635                     }
 636                 }
 637                 return true;
 638             case R.id.menu_empty_trash:
 639                 AlertDialog.Builder alert = new AlertDialog.Builder(this);
 640 
 641                 alert.setTitle(R.string.empty_trash);
 642                 alert.setMessage(R.string.confirm_empty_trash);
 643                 alert.setPositiveButton(R.string.yes, new DialogInterface.OnClickListener() {
 644                     public void onClick(DialogInterface dialog, int whichButton) {
 645                         new emptyTrashTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR);
 646                         AnalyticsTracker.track(
 647                                 AnalyticsTracker.Stat.LIST_TRASH_EMPTIED,
 648                                 AnalyticsTracker.CATEGORY_NOTE,
 649                                 &quot;overflow_menu&quot;
 650                         );
 651                     }
 652                 });
 653                 alert.setNegativeButton(R.string.no, new DialogInterface.OnClickListener() {
 654                     public void onClick(DialogInterface dialog, int whichButton) {
 655                         // Do nothing, just closing the dialog
 656                     }
 657                 });
 658                 alert.show();
 659                 return true;
 660             case android.R.id.home:
 661                 invalidateOptionsMenu();
 662                 return true;
 663             default:
 664                 return super.onOptionsItemSelected(item);
 665         }
 666     }
 667 
 668     @Override
 669     public boolean onPrepareOptionsMenu(Menu menu) {
 670         MenuItem markdownItem = menu.findItem(R.id.menu_markdown_preview);
 671 
 672         if (mIsShowingMarkdown) {
 673             markdownItem.setIcon(R.drawable.ic_preview_stop_24dp);
 674             markdownItem.setTitle(getString(R.string.markdown_hide));
 675         } else {
 676             markdownItem.setIcon(R.drawable.ic_preview_24dp);
 677             markdownItem.setTitle(getString(R.string.markdown_show));
 678         }
 679 
 680         DrawableUtils.tintMenuItemWithAttribute(this, markdownItem, R.attr.actionBarTextColor);
 681 
 682         return super.onPrepareOptionsMenu(menu);
 683     }
 684 
 685     public void updateViewsAfterTrashAction(Note note) {
 686         if (note == null || isFinishing()) {
 687             return;
 688         }
 689 
 690         if (note.isDeleted()) {
 691             List&lt;String&gt; deletedNoteIds = new ArrayList&lt;&gt;();
 692             deletedNoteIds.add(note.getSimperiumKey());
 693             mUndoBarController.setDeletedNoteIds(deletedNoteIds);
 694             mUndoBarController.showUndoBar(getUndoView(), getString(R.string.note_deleted));
 695             AnalyticsTracker.track(
 696                     AnalyticsTracker.Stat.LIST_NOTE_DELETED,
 697                     AnalyticsTracker.CATEGORY_NOTE,
 698                     &quot;overflow_menu&quot;
 699             );
 700         } else {
 701             AnalyticsTracker.track(
 702                     AnalyticsTracker.Stat.EDITOR_NOTE_RESTORED,
 703                     AnalyticsTracker.CATEGORY_NOTE,
 704                     &quot;overflow_menu&quot;
 705             );
 706         }
 707 
 708         // If we just deleted/restored the active note, show the placeholder
 709         if (mCurrentNote != null &amp;&amp; mCurrentNote.getSimperiumKey().equals(note.getSimperiumKey())) {
 710             showDetailPlaceholder();
 711         }
 712 
 713         NoteListFragment fragment = getNoteListFragment();
 714         if (fragment != null) {
 715             fragment.getPrefs();
 716             fragment.refreshList();
 717         }
 718 
 719         invalidateOptionsMenu();
 720     }
 721 
 722     public void setMarkdownShowing(boolean isMarkdownShowing) {
 723         mIsShowingMarkdown = isMarkdownShowing;
 724         if (mNoteEditorFragment != null) {
 725             if (isMarkdownShowing) {
 726                 mNoteEditorFragment.showMarkdown();
 727             } else {
 728                 mNoteEditorFragment.hideMarkdown();
 729             }
 730         }
 731         invalidateOptionsMenu();
 732     }
 733 
 734     /**
 735      * Callback method from {@link NoteListFragment.Callbacks} indicating that
 736      * the item with the given ID was selected. Used for tablets only.
 737      */
 738     @Override
<abbr title=" 739     public void onNoteSelected(String noteID, int position, String matchOffsets, boolean isMarkdownEnabled) {"> 739     public void onNoteSelected(String noteID, int position, String matchOffsets, boolean isMarkdownEnableðŸ”µ</abbr>
 740         if (!DisplayUtils.isLargeScreenLandscape(this)) {
 741             // Launch the editor activity
 742             Bundle arguments = new Bundle();
 743             arguments.putString(NoteEditorFragment.ARG_ITEM_ID, noteID);
 744             arguments.putBoolean(NoteEditorFragment.ARG_MARKDOWN_ENABLED, isMarkdownEnabled);
 745 
 746             if (matchOffsets != null)
 747                 arguments.putString(NoteEditorFragment.ARG_MATCH_OFFSETS, matchOffsets);
 748 
 749             Intent editNoteIntent = new Intent(this, NoteEditorActivity.class);
 750             editNoteIntent.putExtras(arguments);
 751             startActivityForResult(editNoteIntent, Simplenote.INTENT_EDIT_NOTE);
 752         } else {
 753             mNoteEditorFragment.setNote(noteID, matchOffsets);
 754             getNoteListFragment().setNoteSelected(noteID);
 755 
 756             if (mSearchView != null &amp;&amp; mSearchView.getQuery() != null) {
 757                 mTabletSearchQuery = mSearchView.getQuery().toString();
 758             }
 759 
 760             mNoteEditorFragment.clearMarkdown();
 761 
 762             if (!isMarkdownEnabled &amp;&amp; mIsShowingMarkdown) {
 763                 setMarkdownShowing(false);
 764             }
 765 
 766             invalidateOptionsMenu();
 767         }
 768 
 769         AnalyticsTracker.track(
 770                 AnalyticsTracker.Stat.LIST_NOTE_OPENED,
 771                 AnalyticsTracker.CATEGORY_NOTE,
 772                 &quot;note_list_row_tap&quot;
 773         );
 774     }
 775 
 776     @Override
 777     public void onUserCreated(User user) {
 778         // New account created
 779         AnalyticsTracker.track(
 780                 AnalyticsTracker.Stat.USER_ACCOUNT_CREATED,
 781                 AnalyticsTracker.CATEGORY_USER,
 782                 &quot;account_created_from_login_activity&quot;
 783         );
 784     }
 785 
 786     public void onUserStatusChange(User.Status status) {
 787         switch (status) {
 788             // successfully used access token to connect to simperium bucket
 789             case AUTHORIZED:
 790                 runOnUiThread(new Runnable() {
 791                     @Override
 792                     public void run() {
 793                         if (!mNotesBucket.hasChangeVersion()) {
 794                             setToolbarProgressVisibility(true);
 795                         }
 796                     }
 797                 });
 798                 break;
 799 
 800             // NOT_AUTHORIZED means we attempted to connect but the token was not valid
 801             case NOT_AUTHORIZED:
 802                 runOnUiThread(new Runnable() {
 803                     @Override
 804                     public void run() {
 805                         startLoginActivity(true);
 806                     }
 807                 });
 808                 break;
 809 
<abbr title=" 810             // Default starting state of User, don&#x27;t do anything we allow use of app while not signed in so don&#x27;t do anything"> 810             // Default starting state of User, don&#x27;t do anything we allow use of app while not signed in ðŸ”µ</abbr>
 811             case UNKNOWN:
 812                 break;
 813         }
 814     }
 815 
 816     private void setToolbarProgressVisibility(boolean isVisible) {
 817         if (getSupportActionBar() != null) {
 818             getSupportActionBar().setDisplayShowCustomEnabled(isVisible);
 819         }
 820     }
 821 
 822     public void startLoginActivity(boolean signInFirst) {
 823         // Clear some account-specific prefs
 824         SharedPreferences.Editor editor = PreferenceManager.getDefaultSharedPreferences(this).edit();
 825         editor.remove(PrefUtils.PREF_WP_TOKEN);
 826         editor.remove(PrefUtils.PREF_WORDPRESS_SITES);
 827         editor.apply();
 828 
 829         Intent loginIntent = new Intent(this, SignInActivity.class);
 830         if (signInFirst) {
 831             loginIntent.putExtra(SignInActivity.EXTRA_SIGN_IN_FIRST, true);
 832         }
 833         startActivityForResult(loginIntent, Simperium.SIGNUP_SIGNIN_REQUEST);
 834     }
 835 
 836     @Override
 837     public void recreate() {
 838         Handler handler = new Handler();
 839         handler.post(new Runnable() {
 840             @Override
 841             public void run() {
 842                 NotesActivity.super.recreate();
 843             }
 844         });
 845     }
 846 
 847     @Override
 848     protected void onActivityResult(int requestCode, int resultCode, Intent data) {
 849         super.onActivityResult(requestCode, resultCode, data);
 850         switch (requestCode) {
 851             case Simplenote.INTENT_PREFERENCES:
 852                 if (ThemeUtils.themeWasChanged(data)) {
 853                     // Restart this activity to apply the new theme
 854                     recreate();
 855                     break;
 856                 }
<abbr title=" 857                 // nbradbury - refresh note list when user returns from preferences (in case they changed anything)"> 857                 // nbradbury - refresh note list when user returns from preferences (in case they changedðŸ”µ</abbr>
 858                 invalidateOptionsMenu();
 859                 NoteListFragment fragment = getNoteListFragment();
 860                 if (fragment != null) {
 861                     fragment.getPrefs();
 862                     fragment.refreshList();
 863                 }
 864 
 865                 break;
 866             case Simplenote.INTENT_EDIT_NOTE:
 867                 if (resultCode == RESULT_OK &amp;&amp; data != null) {
 868                     if (data.hasExtra(Simplenote.DELETED_NOTE_ID)) {
 869                         String noteId = data.getStringExtra(Simplenote.DELETED_NOTE_ID);
 870                         if (noteId != null) {
 871                             List&lt;String&gt; deletedNoteIds = new ArrayList&lt;&gt;();
 872                             deletedNoteIds.add(noteId);
 873                             mUndoBarController.setDeletedNoteIds(deletedNoteIds);
<abbr title=" 874                             mUndoBarController.showUndoBar(getUndoView(), getString(R.string.note_deleted));"> 874                             mUndoBarController.showUndoBar(getUndoView(), getString(R.string.note_deletedðŸ”µ</abbr>
 875                         }
<abbr title=" 876                     } else if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; data.hasExtra(Simplenote.SELECTED_NOTE_ID)) {"> 876                     } else if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; data.hasExtra(Simplenote.SELEðŸ”µ</abbr>
 877                         String selectedNoteId = data.getStringExtra(Simplenote.SELECTED_NOTE_ID);
 878                         mNoteListFragment.setNoteSelected(selectedNoteId);
 879                         if (mNoteEditorFragment != null) {
 880                             mNoteEditorFragment.setNote(selectedNoteId);
 881                         }
 882                     }
 883                 }
 884                 break;
 885             case Simperium.SIGNUP_SIGNIN_REQUEST:
 886                 invalidateOptionsMenu();
 887 
 888                 Simplenote app = (Simplenote) getApplication();
 889                 AnalyticsTracker.refreshMetadata(app.getSimperium().getUser().getEmail());
 890 
 891                 AnalyticsTracker.track(
 892                         AnalyticsTracker.Stat.USER_SIGNED_IN,
 893                         AnalyticsTracker.CATEGORY_USER,
 894                         &quot;signed_in_from_login_activity&quot;
 895                 );
 896 
 897                 if (resultCode == Activity.RESULT_CANCELED &amp;&amp; userAuthenticationIsInvalid()) {
 898                     finish();
 899                 }
 900 
 901                 break;
 902         }
 903     }
 904 
 905     @Override
 906     public void onUndo() {
 907         if (mUndoBarController == null) return;
 908 
 909         List&lt;String&gt; deletedNoteIds = mUndoBarController.getDeletedNoteIds();
 910         if (deletedNoteIds != null) {
 911             for (int i = 0; i &lt; deletedNoteIds.size(); i++) {
 912                 Note deletedNote;
 913                 try {
 914                     deletedNote = mNotesBucket.get(deletedNoteIds.get(i));
 915                 } catch (BucketObjectMissingException e) {
 916                     return;
 917                 }
 918                 if (deletedNote != null) {
 919                     deletedNote.setDeleted(false);
 920                     deletedNote.setModificationDate(Calendar.getInstance());
 921                     deletedNote.save();
 922                     NoteListFragment fragment = getNoteListFragment();
 923                     if (fragment != null) {
 924                         fragment.getPrefs();
 925                         fragment.refreshList();
 926                     }
 927                 }
 928             }
 929         }
 930     }
 931 
 932     @Override
 933     protected void onPostCreate(Bundle savedInstanceState) {
 934         super.onPostCreate(savedInstanceState);
 935         // Sync the toggle state after onRestoreInstanceState has occurred.
 936         mDrawerToggle.syncState();
 937     }
 938 
 939     @Override
 940     public void onConfigurationChanged(Configuration newConfig) {
 941         super.onConfigurationChanged(newConfig);
 942 
 943         mDrawerToggle.onConfigurationChanged(newConfig);
 944 
 945         if (DisplayUtils.isLargeScreen(this)) {
 946             mIsShowingMarkdown = false;
 947 
 948             if (newConfig.orientation == Configuration.ORIENTATION_LANDSCAPE) {
 949                 // Add the editor fragment
 950                 if (getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR) != null) {
<abbr title=" 951                     mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR);"> 951                     mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByðŸ”µ</abbr>
 952                 } else if (DisplayUtils.isLandscape(this)) {
 953                     addEditorFragment();
 954                 }
 955                 if (mNoteListFragment != null) {
 956                     mNoteListFragment.setActivateOnItemClick(true);
 957                     mNoteListFragment.setDividerVisible(true);
 958                 }
 959                 // Select the current note on a tablet
 960                 if (mCurrentNote != null)
<abbr title=" 961                     onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled());"> 961                     onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnableðŸ”µ</abbr>
 962                 else {
 963                     mNoteEditorFragment.setPlaceholderVisible(true);
 964                     mNoteListFragment.getListView().clearChoices();
 965                 }
 966                 invalidateOptionsMenu();
 967             }
 968         }
 969 
 970         if (newConfig.orientation == Configuration.ORIENTATION_PORTRAIT &amp;&amp; mNoteEditorFragment != null) {
 971             // Remove the editor fragment when rotating back to portrait
 972             mCurrentNote = null;
 973             if (mNoteListFragment != null) {
 974                 mNoteListFragment.setActivateOnItemClick(false);
 975                 mNoteListFragment.setDividerVisible(false);
 976                 mNoteListFragment.setActivatedPosition(ListView.INVALID_POSITION);
 977                 mNoteListFragment.refreshList();
 978             }
 979             FragmentManager fm = getSupportFragmentManager();
 980             FragmentTransaction ft = fm.beginTransaction();
 981             ft.remove(mNoteEditorFragment);
 982             mNoteEditorFragment = null;
 983             ft.commitAllowingStateLoss();
 984             fm.executePendingTransactions();
 985             invalidateOptionsMenu();
 986         }
 987     }
 988 
 989     public void checkEmptyListText(boolean isSearch) {
 990         if (isSearch) {
<abbr title=" 991             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_found) + &quot;&lt;/strong&gt;&quot;);"> 991             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_found) + &quot;ðŸ”µ</abbr>
 992             getNoteListFragment().setEmptyListViewClickable(false);
 993         } else if (mDrawerList.getCheckedItemPosition() == TRASH_SELECTED_ID) {
<abbr title=" 994             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.trash_is_empty) + &quot;&lt;/strong&gt;&quot;);"> 994             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.trash_is_empty) + &quot;ðŸ”µ</abbr>
 995             AnalyticsTracker.track(
 996                     AnalyticsTracker.Stat.LIST_TRASH_VIEWED,
 997                     AnalyticsTracker.CATEGORY_NOTE,
 998                     &quot;trash_filter_selected&quot;
 999             );
1000             getNoteListFragment().setEmptyListViewClickable(false);
1001         } else {
<abbr title="1002             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here) + &quot;&lt;/strong&gt;&lt;br /&gt;&quot; + String.format(getString(R.string.why_not_create_one), &quot;&lt;u&gt;&quot;, &quot;&lt;/u&gt;&quot;));">1002             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here) + &quot;&lt;ðŸ”µ</abbr>
1003             getNoteListFragment().setEmptyListViewClickable(true);
1004         }
1005     }
1006 
1007     public void showDetailPlaceholder() {
1008         if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; mNoteEditorFragment != null) {
1009             mCurrentNote = null;
1010             mNoteEditorFragment.setPlaceholderVisible(true);
1011             mNoteEditorFragment.clearMarkdown();
1012             mNoteEditorFragment.hideMarkdown();
1013             mIsShowingMarkdown = false;
1014         }
1015     }
1016 
1017     public void stopListeningToNotesBucket() {
1018         mNotesBucket.removeOnNetworkChangeListener(this);
1019         mNotesBucket.removeOnSaveObjectListener(this);
1020         mNotesBucket.removeOnDeleteObjectListener(this);
1021     }
1022 
1023     // Returns the appropriate view to show the undo bar within
1024     private View getUndoView() {
1025         View undoView = mFragmentsContainer;
1026         if (!DisplayUtils.isLargeScreenLandscape(this) &amp;&amp;
1027                 getNoteListFragment() != null &amp;&amp;
1028                 getNoteListFragment().getRootView() != null) {
1029             undoView = getNoteListFragment().getRootView();
1030         }
1031 
1032         return undoView;
1033     }
1034 
1035     public void showUndoBarWithNoteIds(List&lt;String&gt; noteIds) {
1036         if (mUndoBarController != null) {
1037             mUndoBarController.setDeletedNoteIds(noteIds);
1038             mUndoBarController.showUndoBar(
1039                     getUndoView(),
<abbr title="1040                     getResources().getQuantityString(R.plurals.trashed_notes, noteIds.size(), noteIds.size())">1040                     getResources().getQuantityString(R.plurals.trashed_notes, noteIds.size(), noteIds.sizðŸ”µ</abbr>
1041             );
1042         }
1043     }
1044 
1045     /* Simperium Bucket Listeners */
1046     // received a change from the network, refresh the list
1047     @Override
1048     public void onNetworkChange(Bucket&lt;Note&gt; bucket, final Bucket.ChangeType type, String key) {
1049         runOnUiThread(new Runnable() {
1050             @Override
1051             public void run() {
1052                 if (type == Bucket.ChangeType.INDEX) {
1053                     setToolbarProgressVisibility(false);
1054                 }
1055                 mNoteListFragment.refreshList();
1056             }
1057         });
1058     }
1059 
1060     @Override
1061     public void onSaveObject(Bucket&lt;Note&gt; bucket, Note object) {
1062         runOnUiThread(new Runnable() {
1063             @Override
1064             public void run() {
1065                 mNoteListFragment.refreshList();
1066             }
1067         });
1068     }
1069 
1070     @Override
1071     public void onDeleteObject(Bucket&lt;Note&gt; bucket, Note object) {
1072         runOnUiThread(new Runnable() {
1073             @Override
1074             public void run() {
1075                 mNoteListFragment.refreshList();
1076             }
1077         });
1078     }
1079 
1080     @Override
1081     public void onBeforeUpdateObject(Bucket&lt;Note&gt; bucket, Note note) {
1082         // noop, NoteEditorFragment will handle this
1083     }
1084 
1085     /* The click listener for ListView in the navigation drawer */
1086     private class DrawerItemClickListener implements ListView.OnItemClickListener {
1087         @Override
1088         public void onItemClick(AdapterView&lt;?&gt; parent, View view, int position, long id) {
1089             // Adjust for header view
1090             position -= mDrawerList.getHeaderViewsCount();
1091             mSelectedTag = mTagsAdapter.getItem(position);
1092             checkEmptyListText(false);
1093             // Update checked item in navigation drawer and close it
1094             setSelectedTagActive();
1095             mDrawerLayout.closeDrawer(mNavigationView);
1096             updateNavigationDrawerItems();
1097             // Disable long press on notes if we&#x27;re viewing the trash
1098             if (mDrawerList.getCheckedItemPosition() == TRASH_SELECTED_ID) {
1099                 getNoteListFragment().getListView().setLongClickable(false);
1100             } else {
1101                 getNoteListFragment().getListView().setLongClickable(true);
1102             }
1103             getNoteListFragment().refreshListFromNavSelect();
1104             if (position &gt; 1) {
<abbr title="1105                 AnalyticsTracker.track(AnalyticsTracker.Stat.LIST_TAG_VIEWED, AnalyticsTracker.CATEGORY_TAG, &quot;selected_tag_in_navigation_drawer&quot;);">1105                 AnalyticsTracker.track(AnalyticsTracker.Stat.LIST_TAG_VIEWED, AnalyticsTracker.CATEGORY_TðŸ”µ</abbr>
1106             }
1107         }
1108     }
1109 
1110     private class emptyTrashTask extends AsyncTask&lt;Void, Void, Void&gt; {
1111         @Override
1112         protected Void doInBackground(Void... voids) {
1113             if (mNotesBucket == null) {
1114                 return null;
1115             }
1116             Query&lt;Note&gt; query = Note.allDeleted(mNotesBucket);
1117             Bucket.ObjectCursor c = query.execute();
1118             while (c.moveToNext()) {
1119                 c.getObject().delete();
1120             }
1121             return null;
1122         }
1123 
1124         @Override
1125         protected void onPostExecute(Void nada) {
1126             showDetailPlaceholder();
1127         }
1128     }
1129 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  package com.automattic.simplenote;
   2  
   3  import android.app.Activity;
   4  import android.app.AlertDialog;
   5  import android.content.DialogInterface;
   6  import android.content.Intent;
   7  import android.content.SharedPreferences;
   8  import android.content.res.Configuration;
   9  import android.os.AsyncTask;
  10  import android.os.Build;
  11  import android.os.Bundle;
  12  import android.os.Handler;
  13  import android.support.design.widget.NavigationView;
  14  import android.support.v4.app.FragmentManager;
  15  import android.support.v4.app.FragmentTransaction;
  16  import android.support.v4.content.ContextCompat;
  17  import android.support.v4.view.GravityCompat;
  18  import android.support.v4.widget.DrawerLayout;
  19  import android.support.v7.app.ActionBar;
  20  import android.support.v7.app.ActionBarDrawerToggle;
  21  import android.support.v7.app.AppCompatActivity;
  22  import android.support.v7.preference.PreferenceManager;
  23  import android.support.v7.widget.SearchView;
  24  import android.support.v7.widget.Toolbar;
  25  import android.text.Spannable;
  26  import android.text.SpannableString;
  27  import android.text.TextUtils;
  28  import android.view.Menu;
  29  import android.view.MenuInflater;
  30  import android.view.MenuItem;
  31  import android.view.View;

  32  import android.view.WindowManager;
  33  import android.widget.AdapterView;

  34  import android.widget.ListView;
  35  import android.widget.ProgressBar;
  36  
  37  import com.automattic.simplenote.analytics.AnalyticsTracker;
  38  import com.automattic.simplenote.models.Note;
  39  import com.automattic.simplenote.models.Tag;
  40  import com.automattic.simplenote.utils.DisplayUtils;
  41  import com.automattic.simplenote.utils.DrawableUtils;
  42  import com.automattic.simplenote.utils.HtmlCompat;
  43  import com.automattic.simplenote.utils.PrefUtils;
  44  import com.automattic.simplenote.utils.StrUtils;
  45  import com.automattic.simplenote.utils.TagsAdapter;
  46  import com.automattic.simplenote.utils.ThemeUtils;
  47  import com.automattic.simplenote.utils.UndoBarController;
  48  import com.automattic.simplenote.widgets.TypefaceSpan;
  49  import com.simperium.Simperium;
  50  import com.simperium.client.Bucket;
  51  import com.simperium.client.BucketObjectMissingException;
  52  import com.simperium.client.BucketObjectNameInvalid;
  53  import com.simperium.client.Query;
  54  import com.simperium.client.User;
  55  
  56  import org.wordpress.passcodelock.AppLockManager;
  57  
  58  import java.util.ArrayList;
  59  import java.util.Calendar;
  60  import java.util.List;
  61  
  62  import static com.automattic.simplenote.utils.DisplayUtils.disableScreenshotsIfLocked;
  63  
  64  public class NotesActivity extends AppCompatActivity implements
<abbr title="  65          NoteListFragment.Callbacks, User.StatusChangeListener, Simperium.OnUserCreatedListener, UndoBarController.UndoListener,">  65          NoteListFragment.Callbacks, User.StatusChangeListener, Simperium.OnUserCreatedListener, UndoBarController.ðŸ”µ</abbr>
  66          Bucket.Listener&lt;Note&gt; {
  67  
  68      public static String TAG_NOTE_LIST = &quot;noteList&quot;;
  69      public static String TAG_NOTE_EDITOR = &quot;noteEditor&quot;;
  70      protected Bucket&lt;Note&gt; mNotesBucket;
  71      protected Bucket&lt;Tag&gt; mTagsBucket;
  72      private int TRASH_SELECTED_ID = 1;
  73      private boolean mIsShowingMarkdown;
  74      private boolean mShouldSelectNewNote;
  75  
  76      private String mTabletSearchQuery;
  77      private UndoBarController mUndoBarController;
  78      private View mFragmentsContainer;
  79      private SearchView mSearchView;
  80      private MenuItem mSearchMenuItem;
  81      private NoteListFragment mNoteListFragment;
  82      private NoteEditorFragment mNoteEditorFragment;
  83      private Note mCurrentNote;
  84      private MenuItem mEmptyTrashMenuItem;
  85  
  86      // Menu drawer
  87      private DrawerLayout mDrawerLayout;
  88      private ListView mDrawerList;
  89      private NavigationView mNavigationView;
  90      private ActionBarDrawerToggle mDrawerToggle;
  91      private TagsAdapter mTagsAdapter;
  92      private TagsAdapter.TagMenuItem mSelectedTag;
  93      // Tags bucket listener
  94      private Bucket.Listener&lt;Tag&gt; mTagsMenuUpdater = new Bucket.Listener&lt;Tag&gt;() {
  95          void updateNavigationDrawer() {
  96              runOnUiThread(new Runnable() {
  97                  public void run() {
  98                      updateNavigationDrawerItems();
  99                  }
 100              });
 101          }
 102  
 103          @Override
 104          public void onSaveObject(Bucket&lt;Tag&gt; bucket, Tag tag) {
 105              updateNavigationDrawer();
 106          }
 107  
 108          @Override
 109          public void onDeleteObject(Bucket&lt;Tag&gt; bucket, Tag tag) {
 110              updateNavigationDrawer();
 111          }
 112  
 113          @Override
 114          public void onNetworkChange(Bucket&lt;Tag&gt; bucket, Bucket.ChangeType type, String key) {
 115              updateNavigationDrawer();
 116          }
 117  
 118          @Override
 119          public void onBeforeUpdateObject(Bucket&lt;Tag&gt; bucket, Tag object) {
 120              // noop
 121          }
 122      };
 123  
 124      @Override
 125      protected void onCreate(Bundle savedInstanceState) {
 126          // On lollipop, configure the translucent status bar
 127          if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.LOLLIPOP) {
 128              getWindow().addFlags(WindowManager.LayoutParams.FLAG_DRAWS_SYSTEM_BAR_BACKGROUNDS);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 129 -            getWindow().setStatusBarColor(ContextCompat.getColor(this, R.color.transparent));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 130 +            getWindow().setStatusBarColor(ContextCompat.getColor(this, android.R.color.transparent));</span>
 131          }
 132  
 133          ThemeUtils.setTheme(this);
 134          super.onCreate(savedInstanceState);
 135  
 136          setContentView(R.layout.activity_notes);
 137  
 138          mFragmentsContainer = findViewById(R.id.note_fragment_container);
 139  
 140          Simplenote currentApp = (Simplenote) getApplication();
 141          if (mNotesBucket == null) {
 142              mNotesBucket = currentApp.getNotesBucket();
 143          }
 144  
 145          if (mTagsBucket == null) {
 146              mTagsBucket = currentApp.getTagsBucket();
 147          }
 148  
 149          Toolbar toolbar = findViewById(R.id.toolbar);
 150          setSupportActionBar(toolbar);
 151          configureNavigationDrawer(toolbar);
 152  
 153          if (savedInstanceState == null) {
 154              mNoteListFragment = new NoteListFragment();
 155              FragmentTransaction fragmentTransaction = getSupportFragmentManager().beginTransaction();
 156              fragmentTransaction.add(R.id.note_fragment_container, mNoteListFragment, TAG_NOTE_LIST);
 157              fragmentTransaction.commit();
 158          } else {
 159              mNoteListFragment = (NoteListFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_LIST);
 160          }
 161  
 162          if (DisplayUtils.isLargeScreen(this)) {
 163              if (getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR) != null) {
<abbr title=" 164                  mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR);"> 164                  mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_ðŸ”µ</abbr>
 165              } else if (DisplayUtils.isLandscape(this)) {
 166                  addEditorFragment();
 167              }
 168          }
 169  
 170          // enable ActionBar app icon to behave as action to toggle nav drawer
 171          ActionBar actionBar = getSupportActionBar();
 172          if (actionBar != null) {
 173              actionBar.setDisplayHomeAsUpEnabled(true);
 174              actionBar.setHomeButtonEnabled(true);
 175  
 176              // Add loading indicator to show when indexing
<abbr title=" 177              ProgressBar progressBar = (ProgressBar) getLayoutInflater().inflate(R.layout.progressbar_toolbar, null);"> 177              ProgressBar progressBar = (ProgressBar) getLayoutInflater().inflate(R.layout.progressbar_toolbar, nullðŸ”µ</abbr>
 178              actionBar.setDisplayShowCustomEnabled(true);
 179              actionBar.setCustomView(progressBar);
 180              setToolbarProgressVisibility(false);
 181          }
 182  
 183          mUndoBarController = new UndoBarController(this);
 184  
 185          // Creates &#x27;Welcome&#x27; note
 186          checkForFirstLaunch();
 187  
 188          checkForSharedContent();
 189  
 190          currentApp.getSimperium().setOnUserCreatedListener(this);
 191          currentApp.getSimperium().setUserStatusChangeListener(this);
 192      }
 193  
 194      @Override
 195      protected void onResume() {
 196          super.onResume();
 197  
 198          // Ensure user has valid authorization
 199          if (userAuthenticationIsInvalid()) {
 200              startLoginActivity(true);
 201          }
 202  
 203          disableScreenshotsIfLocked(this);
 204  
 205          mNotesBucket.start();
 206          mTagsBucket.start();
 207  
 208          mNotesBucket.addOnNetworkChangeListener(this);
 209          mNotesBucket.addOnSaveObjectListener(this);
 210          mNotesBucket.addOnDeleteObjectListener(this);
 211          mTagsBucket.addListener(mTagsMenuUpdater);
 212  
 213          updateNavigationDrawerItems();
 214  
 215          // if the user is not authenticated and the tag doesn&#x27;t exist revert to default drawer selection
 216          if (userIsUnauthorized()) {
 217              if (-1 == mTagsAdapter.getPosition(mSelectedTag)) {
 218                  mSelectedTag = null;
 219                  mDrawerList.setSelection(TagsAdapter.DEFAULT_ITEM_POSITION);
 220              }
 221          }
 222  
 223          setSelectedTagActive();
 224  
 225          if (mCurrentNote != null &amp;&amp; mShouldSelectNewNote) {
 226              onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled());
 227              mShouldSelectNewNote = false;
 228          }
 229  
 230          if (mIsShowingMarkdown) {
 231              setMarkdownShowing(false);
 232          }
 233  
 234      }
 235  
 236      @Override
 237      protected void onPause() {
 238          super.onPause();  // Always call the superclass method first
 239          mTagsBucket.removeListener(mTagsMenuUpdater);
 240          mTagsBucket.stop();
 241  
 242          mNotesBucket.removeOnNetworkChangeListener(this);
 243          mNotesBucket.removeOnSaveObjectListener(this);
 244          mNotesBucket.removeOnDeleteObjectListener(this);
 245          mNotesBucket.stop();
 246      }
 247  
 248      @Override
 249      public void setTitle(CharSequence title) {
 250          if (title == null) {
 251              title = &quot;&quot;;
 252          }
 253  
 254          setTitleWithCustomFont(title);
 255      }
 256  
 257      @Override
 258      public void onBackPressed() {
 259          if (mDrawerLayout != null &amp;&amp; mDrawerLayout.isDrawerOpen(GravityCompat.START)) {
 260              mDrawerLayout.closeDrawer(GravityCompat.START);
 261          } else {
 262              super.onBackPressed();
 263          }
 264      }
 265  
 266      private void setTitleWithCustomFont(CharSequence title) {
 267          if (getSupportActionBar() == null) return;
 268  
 269          // LG devices running 4.1 can&#x27;t handle a custom font in the action bar title
 270          if ((!TextUtils.isEmpty(Build.BRAND) &amp;&amp; Build.BRAND.toLowerCase().contains(&quot;lge&quot;))
 271                  &amp;&amp; Build.VERSION.SDK_INT &lt;= Build.VERSION_CODES.JELLY_BEAN) {
 272              getSupportActionBar().setTitle(title);
 273              return;
 274          }
 275  
 276          SpannableString s = new SpannableString(title);
 277          s.setSpan(new TypefaceSpan(this), 0, s.length(), Spannable.SPAN_EXCLUSIVE_EXCLUSIVE);
 278          getSupportActionBar().setTitle(s);
 279      }
 280  
 281      private void configureNavigationDrawer(Toolbar toolbar) {
 282          mDrawerLayout = findViewById(R.id.drawer_layout);
 283          mDrawerLayout.setDrawerShadow(R.drawable.drawer_shadow, GravityCompat.START);
 284          mNavigationView = findViewById(R.id.navigation_view);
 285          mDrawerList = findViewById(R.id.drawer_list);
















 286  
 287          View settingsButton = findViewById(R.id.nav_settings);
 288          settingsButton.setOnClickListener(new View.OnClickListener() {
 289              @Override
 290              public void onClick(View v) {
 291                  Intent i = new Intent(NotesActivity.this, PreferencesActivity.class);
 292                  startActivityForResult(i, Simplenote.INTENT_PREFERENCES);
 293              }
 294          });
 295  
 296          mNavigationView.getLayoutParams().width = ThemeUtils.getOptimalDrawerWidth(this);
 297          mTagsAdapter = new TagsAdapter(this, mNotesBucket, mDrawerList.getHeaderViewsCount());
 298          mDrawerList.setAdapter(mTagsAdapter);
 299          // Set the list&#x27;s click listener
 300          mDrawerList.setOnItemClickListener(new DrawerItemClickListener());
 301  
 302          if (mSelectedTag == null)
 303              mSelectedTag = mTagsAdapter.getDefaultItem();
 304  
 305          mDrawerToggle = new ActionBarDrawerToggle(this, mDrawerLayout, toolbar, R.string.open_drawer,
 306                  R.string.close_drawer) {
 307              public void onDrawerClosed(View view) {
 308                  supportInvalidateOptionsMenu();
 309              }
 310  
 311              public void onDrawerOpened(View drawerView) {
 312                  // noop
 313              }
 314  
 315              @Override
 316              public void onDrawerSlide(View drawerView, float slideOffset) {
 317                  super.onDrawerSlide(drawerView, 0f);
 318              }
 319          };
 320  
 321          mDrawerLayout.addDrawerListener(mDrawerToggle);
 322      }
 323  
 324      private void checkForFirstLaunch() {
 325          if (PrefUtils.getBoolPref(this, PrefUtils.PREF_FIRST_LAUNCH, true)) {
 326              // Create the welcome note
 327              try {
 328                  Note welcomeNote = mNotesBucket.newObject(&quot;welcome-android&quot;);
 329                  welcomeNote.setCreationDate(Calendar.getInstance());
 330                  welcomeNote.setModificationDate(welcomeNote.getCreationDate());
 331                  welcomeNote.setContent(getString(R.string.welcome_note));
 332                  welcomeNote.getTitle();
 333                  welcomeNote.save();
 334              } catch (BucketObjectNameInvalid e) {
 335                  // this won&#x27;t happen because welcome-android is a valid name
 336              }
 337  
 338              SharedPreferences preferences = PreferenceManager.getDefaultSharedPreferences(this);
 339              SharedPreferences.Editor editor = preferences.edit();
 340              editor.putBoolean(PrefUtils.PREF_FIRST_LAUNCH, false);
 341              editor.putBoolean(PrefUtils.PREF_ACCOUNT_REQUIRED, true);
 342              editor.apply();
 343          }
 344      }
 345  
 346      private void checkForSharedContent() {
 347          if (getIntent().hasExtra(Intent.EXTRA_TEXT)) {
 348              // Check share action
 349              Intent intent = getIntent();
 350              String subject = intent.getStringExtra(Intent.EXTRA_SUBJECT);
 351              String text = intent.getStringExtra(Intent.EXTRA_TEXT);
 352  
 353              // Don&#x27;t add the &#x27;Note to self&#x27; subject or open the note if this was shared from a voice search
 354              String intentAction = StrUtils.notNullStr(intent.getAction());
 355              boolean isVoiceShare = intentAction.equals(&quot;com.google.android.gm.action.AUTO_SEND&quot;);
 356              if (!TextUtils.isEmpty(text)) {
 357                  if (!TextUtils.isEmpty(subject) &amp;&amp; !isVoiceShare) {
 358                      text = subject + &quot;\n\n&quot; + text;
 359                  }
 360                  Note note = mNotesBucket.newObject();
 361                  note.setCreationDate(Calendar.getInstance());
 362                  note.setModificationDate(note.getCreationDate());
 363                  note.setContent(text);
 364                  note.save();
 365                  setCurrentNote(note);
 366                  mShouldSelectNewNote = true;
 367  
 368                  AnalyticsTracker.track(
 369                          AnalyticsTracker.Stat.LIST_NOTE_CREATED,
 370                          AnalyticsTracker.CATEGORY_NOTE,
 371                          &quot;external_share&quot;
 372                  );
 373  
 374                  if (!DisplayUtils.isLargeScreenLandscape(this)) {
 375                      // Disable the lock screen when sharing content and opening NoteEditorActivity
 376                      // Lock screen activities are enabled again in NoteEditorActivity.onPause()
 377                      if (AppLockManager.getInstance().isAppLockFeatureEnabled()) {
 378                          AppLockManager.getInstance().getAppLock().setExemptActivities(
 379                                  new String[]{&quot;com.automattic.simplenote.NotesActivity&quot;,
 380                                          &quot;com.automattic.simplenote.NoteEditorActivity&quot;});
 381                          AppLockManager.getInstance().getAppLock().setOneTimeTimeout(0);
 382                      }
 383                  }
 384              }
 385          }
 386      }
 387  
 388      private void updateNavigationDrawerItems() {
 389          boolean isAlphaSort = PrefUtils.getBoolPref(this, PrefUtils.PREF_SORT_TAGS_ALPHA);
 390          Bucket.ObjectCursor&lt;Tag&gt; tagCursor;
 391          if (isAlphaSort) {
 392              tagCursor = Tag.allSortedAlphabetically(mTagsBucket).execute();
 393          } else {
 394              tagCursor = Tag.allWithName(mTagsBucket).execute();
 395          }
 396  
 397          mTagsAdapter.changeCursor(tagCursor);
 398      }
 399  
 400      private void setSelectedTagActive() {
 401          if (mSelectedTag == null)
 402              mSelectedTag = mTagsAdapter.getDefaultItem();
 403  
 404          setTitle(mSelectedTag.name);
<abbr title=" 405          mDrawerList.setItemChecked(mTagsAdapter.getPosition(mSelectedTag) + mDrawerList.getHeaderViewsCount(), true);"> 405          mDrawerList.setItemChecked(mTagsAdapter.getPosition(mSelectedTag) + mDrawerList.getHeaderViewsCount(), truðŸ”µ</abbr>
 406      }
 407  
 408      public TagsAdapter.TagMenuItem getSelectedTag() {
 409          if (mSelectedTag == null) {
 410              mSelectedTag = mTagsAdapter.getDefaultItem();
 411          }
 412  
 413          return mSelectedTag;
 414      }
 415  
 416      // Enable or disable the trash action bar button depending on if there are deleted notes or not
 417      public void updateTrashMenuItem() {
 418          if (mEmptyTrashMenuItem == null || mNotesBucket == null)
 419              return;
 420  
 421          // Disable the trash icon if there are no notes trashed.
 422          Query&lt;Note&gt; query = Note.allDeleted(mNotesBucket);
 423          if (query.count() == 0) {
 424              mEmptyTrashMenuItem.setEnabled(false);
 425          } else {
 426              mEmptyTrashMenuItem.setEnabled(true);
 427          }
 428      }
 429  
 430      private void addEditorFragment() {
 431          FragmentManager fm = getSupportFragmentManager();
 432          FragmentTransaction ft = fm.beginTransaction();
 433          mNoteEditorFragment = new NoteEditorFragment();
 434          ft.add(R.id.note_fragment_container, mNoteEditorFragment, TAG_NOTE_EDITOR);
 435          ft.commitAllowingStateLoss();
 436          fm.executePendingTransactions();
 437      }
 438  
 439      private boolean userAccountRequired() {
 440          return PrefUtils.getBoolPref(this, PrefUtils.PREF_ACCOUNT_REQUIRED, false);
 441      }
 442  
 443      /**
 444       * Checks for a previously valid user that is now not authenticated
 445       * Also checks if user account is required (added in version 1.5.6)
 446       *
 447       * @return true if user has invalid authorization
 448       */
 449      private boolean userAuthenticationIsInvalid() {
 450          Simplenote currentApp = (Simplenote) getApplication();
 451          Simperium simperium = currentApp.getSimperium();
 452          User user = simperium.getUser();
 453          boolean isNotAuthorized = user.getStatus().equals(User.Status.NOT_AUTHORIZED);
 454          return (user.hasAccessToken() &amp;&amp; isNotAuthorized) ||
 455                  (userAccountRequired() &amp;&amp; isNotAuthorized);
 456      }
 457  
 458      public boolean userIsUnauthorized() {
 459          Simplenote currentApp = (Simplenote) getApplication();
 460          return currentApp.getSimperium().getUser().getStatus() == User.Status.NOT_AUTHORIZED;
 461      }
 462  
 463      public void setCurrentNote(Note note) {
 464          mCurrentNote = note;
 465      }
 466  
 467      public NoteListFragment getNoteListFragment() {
 468          return mNoteListFragment;
 469      }
 470  
 471      @SuppressWarnings(&quot;ResourceType&quot;)
 472      @Override
 473      public boolean onCreateOptionsMenu(Menu menu) {
 474          super.onCreateOptionsMenu(menu);
 475          MenuInflater inflater = getMenuInflater();
 476          inflater.inflate(R.menu.notes_list, menu);
 477  
 478          // restore the search query if on a landscape tablet
 479          String searchQuery = null;
 480          if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; mSearchView != null)
 481              searchQuery = mSearchView.getQuery().toString();
 482  
 483          mSearchMenuItem = menu.findItem(R.id.menu_search);
 484          mSearchView = (SearchView) mSearchMenuItem.getActionView();
 485  
 486          if (!TextUtils.isEmpty(searchQuery)) {
 487              mSearchView.setQuery(searchQuery, false);
 488              mSearchMenuItem.expandActionView();
 489          } else {
 490              // Workaround for setting the search placeholder text color
 491              String hintHexColor = (ThemeUtils.isLightTheme(this) ?
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 492 -                    getString(R.color.simplenote_light_grey) :</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 493 -                    getString(R.color.simplenote_text_preview)).replace(&quot;ff&quot;, &quot;&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 494 +                    getString(R.color.gray_light) :</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 495 +                    getString(R.color.text_preview)).replace(&quot;ff&quot;, &quot;&quot;);</span>
 496              mSearchView.setQueryHint(HtmlCompat.fromHtml(String.format(&quot;&lt;font color=\&quot;%s\&quot;&gt;%s&lt;/font&gt;&quot;,
 497                      hintHexColor,
 498                      getString(R.string.search))));
 499          }
 500  
 501          mSearchView.setOnQueryTextListener(new SearchView.OnQueryTextListener() {
 502              @Override
 503              public boolean onQueryTextChange(String newText) {
 504                  if (mSearchMenuItem.isActionViewExpanded()) {
 505                      getNoteListFragment().searchNotes(newText);
 506                  }
 507                  return true;
 508              }
 509  
 510              @Override
 511              public boolean onQueryTextSubmit(String queryText) {
 512                  getNoteListFragment().searchNotes(queryText);
 513                  return true;
 514              }
 515  
 516          });
 517  
 518          mSearchMenuItem.setOnActionExpandListener(new MenuItem.OnActionExpandListener() {
 519              @Override
 520              public boolean onMenuItemActionExpand(MenuItem menuItem) {
 521                  checkEmptyListText(true);
 522                  if (mNoteListFragment != null) {
 523                      mNoteListFragment.setFloatingActionButtonVisible(false);
 524                  }
 525                  AnalyticsTracker.track(
 526                          AnalyticsTracker.Stat.LIST_NOTES_SEARCHED,
 527                          AnalyticsTracker.CATEGORY_NOTE,
 528                          &quot;action_bar_search_tap&quot;
 529                  );
 530                  return true;
 531              }
 532  
 533              @Override
 534              public boolean onMenuItemActionCollapse(MenuItem menuItem) {
 535                  // Show all notes again
 536                  if (mNoteListFragment != null) {
 537                      mNoteListFragment.setFloatingActionButtonVisible(true);
 538                  }
 539                  mTabletSearchQuery = &quot;&quot;;
 540                  mSearchView.setQuery(&quot;&quot;, false);
 541                  checkEmptyListText(false);
 542                  getNoteListFragment().clearSearch();
 543                  return true;
 544              }
 545          });
 546  
 547          mSearchMenuItem.setOnMenuItemClickListener(new MenuItem.OnMenuItemClickListener() {
 548              @Override
 549              public boolean onMenuItemClick(MenuItem item) {
 550                  if (!mSearchMenuItem.isActionViewExpanded())
 551                      showDetailPlaceholder();
 552                  return false;
 553              }
 554          });
 555  
 556          MenuItem trashItem = menu.findItem(R.id.menu_delete).setTitle(R.string.undelete);
 557          if (mCurrentNote != null &amp;&amp; mCurrentNote.isDeleted()) {
 558              trashItem.setTitle(R.string.undelete);
 559              trashItem.setIcon(R.drawable.ic_trash_restore_24dp);
 560          } else {
 561              trashItem.setTitle(R.string.delete);
 562              trashItem.setIcon(R.drawable.ic_trash_24dp);
 563          }
 564  
 565          if (DisplayUtils.isLargeScreenLandscape(this)) {
 566              // Restore the search query on landscape tablets
 567              if (!TextUtils.isEmpty(mTabletSearchQuery)) {
 568                  mSearchMenuItem.expandActionView();
 569                  mSearchView.setQuery(mTabletSearchQuery, false);
 570                  mSearchView.clearFocus();
 571              }
 572  
 573              if (mCurrentNote != null) {
 574                  menu.findItem(R.id.menu_share).setVisible(true);
 575                  menu.findItem(R.id.menu_view_info).setVisible(true);
 576                  menu.findItem(R.id.menu_checklist).setVisible(true);
 577                  menu.findItem(R.id.menu_history).setVisible(true);
 578                  menu.findItem(R.id.menu_markdown_preview).setVisible(mCurrentNote.isMarkdownEnabled());
 579                  trashItem.setVisible(true);
 580              } else {
 581                  menu.findItem(R.id.menu_share).setVisible(false);
 582                  menu.findItem(R.id.menu_view_info).setVisible(false);
 583                  menu.findItem(R.id.menu_checklist).setVisible(false);
 584                  menu.findItem(R.id.menu_history).setVisible(false);
 585                  menu.findItem(R.id.menu_markdown_preview).setVisible(false);
 586                  trashItem.setVisible(false);
 587              }
 588              menu.findItem(R.id.menu_empty_trash).setVisible(false);
 589          } else {
 590              menu.findItem(R.id.menu_search).setVisible(true);
 591              menu.findItem(R.id.menu_share).setVisible(false);
 592              menu.findItem(R.id.menu_view_info).setVisible(false);
 593              menu.findItem(R.id.menu_checklist).setVisible(false);
 594              menu.findItem(R.id.menu_history).setVisible(false);
 595              menu.findItem(R.id.menu_markdown_preview).setVisible(false);
 596              trashItem.setVisible(false);
 597              menu.findItem(R.id.menu_empty_trash).setVisible(false);
 598          }
 599  
 600          // Are we looking at the trash? Adjust menu accordingly.
 601          if (mDrawerList.getCheckedItemPosition() == TRASH_SELECTED_ID) {
 602              mEmptyTrashMenuItem = menu.findItem(R.id.menu_empty_trash);
 603              mEmptyTrashMenuItem.setVisible(true);
 604  
 605              updateTrashMenuItem();
 606  
 607              menu.findItem(R.id.menu_search).setVisible(false);
 608              menu.findItem(R.id.menu_share).setVisible(false);
 609              menu.findItem(R.id.menu_history).setVisible(false);
 610              menu.findItem(R.id.menu_checklist).setVisible(false);
 611          }
 612  
 613          DrawableUtils.tintMenuWithAttribute(this, menu, R.attr.actionBarTextColor);
 614  
 615          return true;
 616      }
 617  
 618      @Override
 619      public boolean onOptionsItemSelected(MenuItem item) {
 620          if (mDrawerToggle.onOptionsItemSelected(item)) {
 621              return true;
 622          }
 623          switch (item.getItemId()) {
 624              case R.id.menu_markdown_preview:
 625                  if (mIsShowingMarkdown) {
 626                      item.setIcon(R.drawable.ic_preview_24dp);
 627                      item.setTitle(getString(R.string.markdown_show));
 628                      setMarkdownShowing(false);
 629                  } else {
 630                      item.setIcon(R.drawable.ic_preview_stop_24dp);
 631                      item.setTitle(getString(R.string.markdown_hide));
 632                      setMarkdownShowing(true);
 633                  }
 634  
 635                  DrawableUtils.tintMenuItemWithAttribute(this, item, R.attr.actionBarTextColor);
 636  
 637                  return true;
 638              case R.id.menu_delete:
 639                  if (mNoteEditorFragment != null) {
 640                      if (mCurrentNote != null) {
 641                          mCurrentNote.setDeleted(!mCurrentNote.isDeleted());
 642                          mCurrentNote.setModificationDate(Calendar.getInstance());
 643                          mCurrentNote.save();
 644  
 645                          updateViewsAfterTrashAction(mCurrentNote);
 646                      }
 647                  }
 648                  return true;
 649              case R.id.menu_empty_trash:
 650                  AlertDialog.Builder alert = new AlertDialog.Builder(this);
 651  
 652                  alert.setTitle(R.string.empty_trash);
 653                  alert.setMessage(R.string.confirm_empty_trash);
 654                  alert.setPositiveButton(R.string.yes, new DialogInterface.OnClickListener() {
 655                      public void onClick(DialogInterface dialog, int whichButton) {
 656                          new emptyTrashTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR);
 657                          AnalyticsTracker.track(
 658                                  AnalyticsTracker.Stat.LIST_TRASH_EMPTIED,
 659                                  AnalyticsTracker.CATEGORY_NOTE,
 660                                  &quot;overflow_menu&quot;
 661                          );
 662                      }
 663                  });
 664                  alert.setNegativeButton(R.string.no, new DialogInterface.OnClickListener() {
 665                      public void onClick(DialogInterface dialog, int whichButton) {
 666                          // Do nothing, just closing the dialog
 667                      }
 668                  });
 669                  alert.show();
 670                  return true;
 671              case android.R.id.home:
 672                  invalidateOptionsMenu();
 673                  return true;
 674              default:
 675                  return super.onOptionsItemSelected(item);
 676          }
 677      }
 678  
 679      @Override
 680      public boolean onPrepareOptionsMenu(Menu menu) {
 681          MenuItem markdownItem = menu.findItem(R.id.menu_markdown_preview);
 682  
 683          if (mIsShowingMarkdown) {
 684              markdownItem.setIcon(R.drawable.ic_preview_stop_24dp);
 685              markdownItem.setTitle(getString(R.string.markdown_hide));
 686          } else {
 687              markdownItem.setIcon(R.drawable.ic_preview_24dp);
 688              markdownItem.setTitle(getString(R.string.markdown_show));
 689          }
 690  
 691          DrawableUtils.tintMenuItemWithAttribute(this, markdownItem, R.attr.actionBarTextColor);
 692  
 693          return super.onPrepareOptionsMenu(menu);
 694      }
 695  
 696      public void updateViewsAfterTrashAction(Note note) {
 697          if (note == null || isFinishing()) {
 698              return;
 699          }
 700  
 701          if (note.isDeleted()) {
 702              List&lt;String&gt; deletedNoteIds = new ArrayList&lt;&gt;();
 703              deletedNoteIds.add(note.getSimperiumKey());
 704              mUndoBarController.setDeletedNoteIds(deletedNoteIds);
 705              mUndoBarController.showUndoBar(getUndoView(), getString(R.string.note_deleted));
 706              AnalyticsTracker.track(
 707                      AnalyticsTracker.Stat.LIST_NOTE_DELETED,
 708                      AnalyticsTracker.CATEGORY_NOTE,
 709                      &quot;overflow_menu&quot;
 710              );
 711          } else {
 712              AnalyticsTracker.track(
 713                      AnalyticsTracker.Stat.EDITOR_NOTE_RESTORED,
 714                      AnalyticsTracker.CATEGORY_NOTE,
 715                      &quot;overflow_menu&quot;
 716              );
 717          }
 718  
 719          // If we just deleted/restored the active note, show the placeholder
 720          if (mCurrentNote != null &amp;&amp; mCurrentNote.getSimperiumKey().equals(note.getSimperiumKey())) {
 721              showDetailPlaceholder();
 722          }
 723  
 724          NoteListFragment fragment = getNoteListFragment();
 725          if (fragment != null) {
 726              fragment.getPrefs();
 727              fragment.refreshList();
 728          }
 729  
 730          invalidateOptionsMenu();
 731      }
 732  
 733      public void setMarkdownShowing(boolean isMarkdownShowing) {
 734          mIsShowingMarkdown = isMarkdownShowing;
 735          if (mNoteEditorFragment != null) {
 736              if (isMarkdownShowing) {
 737                  mNoteEditorFragment.showMarkdown();
 738              } else {
 739                  mNoteEditorFragment.hideMarkdown();
 740              }
 741          }
 742          invalidateOptionsMenu();
 743      }
 744  
 745      /**
 746       * Callback method from {@link NoteListFragment.Callbacks} indicating that
 747       * the item with the given ID was selected. Used for tablets only.
 748       */
 749      @Override
 750      public void onNoteSelected(String noteID, int position, String matchOffsets, boolean isMarkdownEnabled) {
 751          if (!DisplayUtils.isLargeScreenLandscape(this)) {
 752              // Launch the editor activity
 753              Bundle arguments = new Bundle();
 754              arguments.putString(NoteEditorFragment.ARG_ITEM_ID, noteID);
 755              arguments.putBoolean(NoteEditorFragment.ARG_MARKDOWN_ENABLED, isMarkdownEnabled);
 756  
 757              if (matchOffsets != null)
 758                  arguments.putString(NoteEditorFragment.ARG_MATCH_OFFSETS, matchOffsets);
 759  
 760              Intent editNoteIntent = new Intent(this, NoteEditorActivity.class);
 761              editNoteIntent.putExtras(arguments);
 762              startActivityForResult(editNoteIntent, Simplenote.INTENT_EDIT_NOTE);
 763          } else {
 764              mNoteEditorFragment.setNote(noteID, matchOffsets);
 765              getNoteListFragment().setNoteSelected(noteID);
 766  
 767              if (mSearchView != null &amp;&amp; mSearchView.getQuery() != null) {
 768                  mTabletSearchQuery = mSearchView.getQuery().toString();
 769              }
 770  
 771              mNoteEditorFragment.clearMarkdown();
 772  
 773              if (!isMarkdownEnabled &amp;&amp; mIsShowingMarkdown) {
 774                  setMarkdownShowing(false);
 775              }
 776  
 777              invalidateOptionsMenu();
 778          }
 779  
 780          AnalyticsTracker.track(
 781                  AnalyticsTracker.Stat.LIST_NOTE_OPENED,
 782                  AnalyticsTracker.CATEGORY_NOTE,
 783                  &quot;note_list_row_tap&quot;
 784          );
 785      }
 786  
 787      @Override
 788      public void onUserCreated(User user) {
 789          // New account created
 790          AnalyticsTracker.track(
 791                  AnalyticsTracker.Stat.USER_ACCOUNT_CREATED,
 792                  AnalyticsTracker.CATEGORY_USER,
 793                  &quot;account_created_from_login_activity&quot;
 794          );
 795      }
 796  
 797      public void onUserStatusChange(User.Status status) {
 798          switch (status) {
 799              // successfully used access token to connect to simperium bucket
 800              case AUTHORIZED:
 801                  runOnUiThread(new Runnable() {
 802                      @Override
 803                      public void run() {
 804                          if (!mNotesBucket.hasChangeVersion()) {
 805                              setToolbarProgressVisibility(true);
 806                          }
 807                      }
 808                  });
 809                  break;
 810  
 811              // NOT_AUTHORIZED means we attempted to connect but the token was not valid
 812              case NOT_AUTHORIZED:
 813                  runOnUiThread(new Runnable() {
 814                      @Override
 815                      public void run() {
 816                          startLoginActivity(true);
 817                      }
 818                  });
 819                  break;
 820  
<abbr title=" 821              // Default starting state of User, don&#x27;t do anything we allow use of app while not signed in so don&#x27;t do anything"> 821              // Default starting state of User, don&#x27;t do anything we allow use of app while not signed in so don&#x27;t ðŸ”µ</abbr>
 822              case UNKNOWN:
 823                  break;
 824          }
 825      }
 826  
 827      private void setToolbarProgressVisibility(boolean isVisible) {
 828          if (getSupportActionBar() != null) {
 829              getSupportActionBar().setDisplayShowCustomEnabled(isVisible);
 830          }
 831      }
 832  
 833      public void startLoginActivity(boolean signInFirst) {
 834          // Clear some account-specific prefs
 835          SharedPreferences.Editor editor = PreferenceManager.getDefaultSharedPreferences(this).edit();
 836          editor.remove(PrefUtils.PREF_WP_TOKEN);
 837          editor.remove(PrefUtils.PREF_WORDPRESS_SITES);
 838          editor.apply();
 839  
 840          Intent loginIntent = new Intent(this, SignInActivity.class);
 841          if (signInFirst) {
 842              loginIntent.putExtra(SignInActivity.EXTRA_SIGN_IN_FIRST, true);
 843          }
 844          startActivityForResult(loginIntent, Simperium.SIGNUP_SIGNIN_REQUEST);
 845      }
 846  
 847      @Override
 848      public void recreate() {
 849          Handler handler = new Handler();
 850          handler.post(new Runnable() {
 851              @Override
 852              public void run() {
 853                  NotesActivity.super.recreate();
 854              }
 855          });
 856      }
 857  
 858      @Override
 859      protected void onActivityResult(int requestCode, int resultCode, Intent data) {
 860          super.onActivityResult(requestCode, resultCode, data);
 861          switch (requestCode) {
 862              case Simplenote.INTENT_PREFERENCES:
 863                  if (ThemeUtils.themeWasChanged(data)) {
 864                      // Restart this activity to apply the new theme
 865                      recreate();
 866                      break;
 867                  }
<abbr title=" 868                  // nbradbury - refresh note list when user returns from preferences (in case they changed anything)"> 868                  // nbradbury - refresh note list when user returns from preferences (in case they changed anythingðŸ”µ</abbr>
 869                  invalidateOptionsMenu();
 870                  NoteListFragment fragment = getNoteListFragment();
 871                  if (fragment != null) {
 872                      fragment.getPrefs();
 873                      fragment.refreshList();
 874                  }
 875  
 876                  break;
 877              case Simplenote.INTENT_EDIT_NOTE:
 878                  if (resultCode == RESULT_OK &amp;&amp; data != null) {
 879                      if (data.hasExtra(Simplenote.DELETED_NOTE_ID)) {
 880                          String noteId = data.getStringExtra(Simplenote.DELETED_NOTE_ID);
 881                          if (noteId != null) {
 882                              List&lt;String&gt; deletedNoteIds = new ArrayList&lt;&gt;();
 883                              deletedNoteIds.add(noteId);
 884                              mUndoBarController.setDeletedNoteIds(deletedNoteIds);
 885                              mUndoBarController.showUndoBar(getUndoView(), getString(R.string.note_deleted));
 886                          }
<abbr title=" 887                      } else if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; data.hasExtra(Simplenote.SELECTED_NOTE_ID)) {"> 887                      } else if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; data.hasExtra(Simplenote.SELECTED_NOTEðŸ”µ</abbr>
 888                          String selectedNoteId = data.getStringExtra(Simplenote.SELECTED_NOTE_ID);
 889                          mNoteListFragment.setNoteSelected(selectedNoteId);
 890                          if (mNoteEditorFragment != null) {
 891                              mNoteEditorFragment.setNote(selectedNoteId);
 892                          }
 893                      }
 894                  }
 895                  break;
 896              case Simperium.SIGNUP_SIGNIN_REQUEST:
 897                  invalidateOptionsMenu();
 898  
 899                  Simplenote app = (Simplenote) getApplication();
 900                  AnalyticsTracker.refreshMetadata(app.getSimperium().getUser().getEmail());
 901  
 902                  AnalyticsTracker.track(
 903                          AnalyticsTracker.Stat.USER_SIGNED_IN,
 904                          AnalyticsTracker.CATEGORY_USER,
 905                          &quot;signed_in_from_login_activity&quot;
 906                  );
 907  
 908                  if (resultCode == Activity.RESULT_CANCELED &amp;&amp; userAuthenticationIsInvalid()) {
 909                      finish();
 910                  }
 911  
 912                  break;
 913          }
 914      }
 915  
 916      @Override
 917      public void onUndo() {
 918          if (mUndoBarController == null) return;
 919  
 920          List&lt;String&gt; deletedNoteIds = mUndoBarController.getDeletedNoteIds();
 921          if (deletedNoteIds != null) {
 922              for (int i = 0; i &lt; deletedNoteIds.size(); i++) {
 923                  Note deletedNote;
 924                  try {
 925                      deletedNote = mNotesBucket.get(deletedNoteIds.get(i));
 926                  } catch (BucketObjectMissingException e) {
 927                      return;
 928                  }
 929                  if (deletedNote != null) {
 930                      deletedNote.setDeleted(false);
 931                      deletedNote.setModificationDate(Calendar.getInstance());
 932                      deletedNote.save();
 933                      NoteListFragment fragment = getNoteListFragment();
 934                      if (fragment != null) {
 935                          fragment.getPrefs();
 936                          fragment.refreshList();
 937                      }
 938                  }
 939              }
 940          }
 941      }
 942  
 943      @Override
 944      protected void onPostCreate(Bundle savedInstanceState) {
 945          super.onPostCreate(savedInstanceState);
 946          // Sync the toggle state after onRestoreInstanceState has occurred.
 947          mDrawerToggle.syncState();
 948      }
 949  
 950      @Override
 951      public void onConfigurationChanged(Configuration newConfig) {
 952          super.onConfigurationChanged(newConfig);
 953  
 954          mDrawerToggle.onConfigurationChanged(newConfig);
 955  
 956          if (DisplayUtils.isLargeScreen(this)) {
 957              mIsShowingMarkdown = false;
 958  
 959              if (newConfig.orientation == Configuration.ORIENTATION_LANDSCAPE) {
 960                  // Add the editor fragment
 961                  if (getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR) != null) {
<abbr title=" 962                      mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR);"> 962                      mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByTag(TAG_NðŸ”µ</abbr>
 963                  } else if (DisplayUtils.isLandscape(this)) {
 964                      addEditorFragment();
 965                  }
 966                  if (mNoteListFragment != null) {
 967                      mNoteListFragment.setActivateOnItemClick(true);
 968                      mNoteListFragment.setDividerVisible(true);
 969                  }
 970                  // Select the current note on a tablet
 971                  if (mCurrentNote != null)
 972                      onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled());
 973                  else {
 974                      mNoteEditorFragment.setPlaceholderVisible(true);
 975                      mNoteListFragment.getListView().clearChoices();
 976                  }
 977                  invalidateOptionsMenu();
 978              }
 979          }
 980  
 981          if (newConfig.orientation == Configuration.ORIENTATION_PORTRAIT &amp;&amp; mNoteEditorFragment != null) {
 982              // Remove the editor fragment when rotating back to portrait
 983              mCurrentNote = null;
 984              if (mNoteListFragment != null) {
 985                  mNoteListFragment.setActivateOnItemClick(false);
 986                  mNoteListFragment.setDividerVisible(false);
 987                  mNoteListFragment.setActivatedPosition(ListView.INVALID_POSITION);
 988                  mNoteListFragment.refreshList();
 989              }
 990              FragmentManager fm = getSupportFragmentManager();
 991              FragmentTransaction ft = fm.beginTransaction();
 992              ft.remove(mNoteEditorFragment);
 993              mNoteEditorFragment = null;
 994              ft.commitAllowingStateLoss();
 995              fm.executePendingTransactions();
 996              invalidateOptionsMenu();
 997          }
 998      }
 999  
1000      public void checkEmptyListText(boolean isSearch) {
1001          if (isSearch) {
<abbr title="1002              getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_found) + &quot;&lt;/strong&gt;&quot;);">1002              getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_found) + &quot;&lt;/strong&gt;ðŸ”µ</abbr>
1003              getNoteListFragment().setEmptyListViewClickable(false);
1004          } else if (mDrawerList.getCheckedItemPosition() == TRASH_SELECTED_ID) {
<abbr title="1005              getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.trash_is_empty) + &quot;&lt;/strong&gt;&quot;);">1005              getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.trash_is_empty) + &quot;&lt;/strong&gt;ðŸ”µ</abbr>
1006              AnalyticsTracker.track(
1007                      AnalyticsTracker.Stat.LIST_TRASH_VIEWED,
1008                      AnalyticsTracker.CATEGORY_NOTE,
1009                      &quot;trash_filter_selected&quot;
1010              );
1011              getNoteListFragment().setEmptyListViewClickable(false);
1012          } else {
<abbr title="1013              getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here) + &quot;&lt;/strong&gt;&lt;br /&gt;&quot; + String.format(getString(R.string.why_not_create_one), &quot;&lt;u&gt;&quot;, &quot;&lt;/u&gt;&quot;));">1013              getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here) + &quot;&lt;/strong&gt;&lt;ðŸ”µ</abbr>
1014              getNoteListFragment().setEmptyListViewClickable(true);
1015          }
1016      }
1017  
1018      public void showDetailPlaceholder() {
1019          if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; mNoteEditorFragment != null) {
1020              mCurrentNote = null;
1021              mNoteEditorFragment.setPlaceholderVisible(true);
1022              mNoteEditorFragment.clearMarkdown();
1023              mNoteEditorFragment.hideMarkdown();
1024              mIsShowingMarkdown = false;
1025          }
1026      }
1027  
1028      public void stopListeningToNotesBucket() {
1029          mNotesBucket.removeOnNetworkChangeListener(this);
1030          mNotesBucket.removeOnSaveObjectListener(this);
1031          mNotesBucket.removeOnDeleteObjectListener(this);
1032      }
1033  
1034      // Returns the appropriate view to show the undo bar within
1035      private View getUndoView() {
1036          View undoView = mFragmentsContainer;
1037          if (!DisplayUtils.isLargeScreenLandscape(this) &amp;&amp;
1038                  getNoteListFragment() != null &amp;&amp;
1039                  getNoteListFragment().getRootView() != null) {
1040              undoView = getNoteListFragment().getRootView();
1041          }
1042  
1043          return undoView;
1044      }
1045  
1046      public void showUndoBarWithNoteIds(List&lt;String&gt; noteIds) {
1047          if (mUndoBarController != null) {
1048              mUndoBarController.setDeletedNoteIds(noteIds);
1049              mUndoBarController.showUndoBar(
1050                      getUndoView(),
1051                      getResources().getQuantityString(R.plurals.trashed_notes, noteIds.size(), noteIds.size())
1052              );
1053          }
1054      }
1055  
1056      /* Simperium Bucket Listeners */
1057      // received a change from the network, refresh the list
1058      @Override
1059      public void onNetworkChange(Bucket&lt;Note&gt; bucket, final Bucket.ChangeType type, String key) {
1060          runOnUiThread(new Runnable() {
1061              @Override
1062              public void run() {
1063                  if (type == Bucket.ChangeType.INDEX) {
1064                      setToolbarProgressVisibility(false);
1065                  }
1066                  mNoteListFragment.refreshList();
1067              }
1068          });
1069      }
1070  
1071      @Override
1072      public void onSaveObject(Bucket&lt;Note&gt; bucket, Note object) {
1073          runOnUiThread(new Runnable() {
1074              @Override
1075              public void run() {
1076                  mNoteListFragment.refreshList();
1077              }
1078          });
1079      }
1080  
1081      @Override
1082      public void onDeleteObject(Bucket&lt;Note&gt; bucket, Note object) {
1083          runOnUiThread(new Runnable() {
1084              @Override
1085              public void run() {
1086                  mNoteListFragment.refreshList();
1087              }
1088          });
1089      }
1090  
1091      @Override
1092      public void onBeforeUpdateObject(Bucket&lt;Note&gt; bucket, Note note) {
1093          // noop, NoteEditorFragment will handle this
1094      }
1095  
1096      /* The click listener for ListView in the navigation drawer */
1097      private class DrawerItemClickListener implements ListView.OnItemClickListener {
1098          @Override
1099          public void onItemClick(AdapterView&lt;?&gt; parent, View view, int position, long id) {
1100  
1101              // Adjust for header view
1102              position -= mDrawerList.getHeaderViewsCount();
1103              mSelectedTag = mTagsAdapter.getItem(position);
1104              checkEmptyListText(false);
1105              // Update checked item in navigation drawer and close it
1106              setSelectedTagActive();
1107              mDrawerLayout.closeDrawer(mNavigationView);
1108              updateNavigationDrawerItems();
1109  
1110              // Disable long press on notes if we&#x27;re viewing the trash
1111              if (mDrawerList.getCheckedItemPosition() == TRASH_SELECTED_ID) {
1112                  getNoteListFragment().getListView().setLongClickable(false);
1113              } else {
1114                  getNoteListFragment().getListView().setLongClickable(true);
1115              }
1116  
1117              getNoteListFragment().refreshListFromNavSelect();
1118              if (position &gt; 1) {
1119                  AnalyticsTracker.track(
1120                          AnalyticsTracker.Stat.LIST_TAG_VIEWED,
1121                          AnalyticsTracker.CATEGORY_TAG,
1122                          &quot;selected_tag_in_navigation_drawer&quot;
1123                  );
1124              }
1125          }
1126      }
1127  
1128      private class emptyTrashTask extends AsyncTask&lt;Void, Void, Void&gt; {
1129  
1130          @Override
1131          protected Void doInBackground(Void... voids) {
1132              if (mNotesBucket == null) return null;
1133  
1134              Query&lt;Note&gt; query = Note.allDeleted(mNotesBucket);
1135              Bucket.ObjectCursor c = query.execute();
1136              while (c.moveToNext()) {
1137                  c.getObject().delete();
1138              }
1139  
1140              return null;
1141          }
1142  
1143          @Override
1144          protected void onPostExecute(Void nada) {
1145              showDetailPlaceholder();
1146          }
1147      }
1148  }</pre></td>
                            <td><pre>   1  package com.automattic.simplenote;
   2  
   3  import android.app.Activity;
   4  import android.app.AlertDialog;
   5  import android.content.DialogInterface;
   6  import android.content.Intent;
   7  import android.content.SharedPreferences;
   8  import android.content.res.Configuration;
   9  import android.os.AsyncTask;
  10  import android.os.Build;
  11  import android.os.Bundle;
  12  import android.os.Handler;
  13  import android.support.design.widget.NavigationView;
  14  import android.support.v4.app.FragmentManager;
  15  import android.support.v4.app.FragmentTransaction;
  16  import android.support.v4.content.ContextCompat;
  17  import android.support.v4.view.GravityCompat;
  18  import android.support.v4.widget.DrawerLayout;
  19  import android.support.v7.app.ActionBar;
  20  import android.support.v7.app.ActionBarDrawerToggle;
  21  import android.support.v7.app.AppCompatActivity;
  22  import android.support.v7.preference.PreferenceManager;
  23  import android.support.v7.widget.SearchView;
  24  import android.support.v7.widget.Toolbar;
  25  import android.text.Spannable;
  26  import android.text.SpannableString;
  27  import android.text.TextUtils;
  28  import android.view.Menu;
  29  import android.view.MenuInflater;
  30  import android.view.MenuItem;
  31  import android.view.View;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  32 +import android.view.WindowInsets;</span>
  33  import android.view.WindowManager;
  34  import android.widget.AdapterView;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  35 +import android.widget.LinearLayout;</span>
  36  import android.widget.ListView;
  37  import android.widget.ProgressBar;
  38  
  39  import com.automattic.simplenote.analytics.AnalyticsTracker;
  40  import com.automattic.simplenote.models.Note;
  41  import com.automattic.simplenote.models.Tag;
  42  import com.automattic.simplenote.utils.DisplayUtils;
  43  import com.automattic.simplenote.utils.DrawableUtils;
  44  import com.automattic.simplenote.utils.HtmlCompat;
  45  import com.automattic.simplenote.utils.PrefUtils;
  46  import com.automattic.simplenote.utils.StrUtils;
  47  import com.automattic.simplenote.utils.TagsAdapter;
  48  import com.automattic.simplenote.utils.ThemeUtils;
  49  import com.automattic.simplenote.utils.UndoBarController;
  50  import com.automattic.simplenote.widgets.TypefaceSpan;
  51  import com.simperium.Simperium;
  52  import com.simperium.client.Bucket;
  53  import com.simperium.client.BucketObjectMissingException;
  54  import com.simperium.client.BucketObjectNameInvalid;
  55  import com.simperium.client.Query;
  56  import com.simperium.client.User;
  57  
  58  import org.wordpress.passcodelock.AppLockManager;
  59  
  60  import java.util.ArrayList;
  61  import java.util.Calendar;
  62  import java.util.List;
  63  
  64  import static com.automattic.simplenote.utils.DisplayUtils.disableScreenshotsIfLocked;
  65  
  66  public class NotesActivity extends AppCompatActivity implements
<abbr title="  67          NoteListFragment.Callbacks, User.StatusChangeListener, Simperium.OnUserCreatedListener, UndoBarController.UndoListener,">  67          NoteListFragment.Callbacks, User.StatusChangeListener, Simperium.OnUserCreatedListener, UndoBarController.ðŸ”µ</abbr>
  68          Bucket.Listener&lt;Note&gt; {
  69  
  70      public static String TAG_NOTE_LIST = &quot;noteList&quot;;
  71      public static String TAG_NOTE_EDITOR = &quot;noteEditor&quot;;
  72      protected Bucket&lt;Note&gt; mNotesBucket;
  73      protected Bucket&lt;Tag&gt; mTagsBucket;
  74      private int TRASH_SELECTED_ID = 1;
  75      private boolean mIsShowingMarkdown;
  76      private boolean mShouldSelectNewNote;
  77  
  78      private String mTabletSearchQuery;
  79      private UndoBarController mUndoBarController;
  80      private View mFragmentsContainer;
  81      private SearchView mSearchView;
  82      private MenuItem mSearchMenuItem;
  83      private NoteListFragment mNoteListFragment;
  84      private NoteEditorFragment mNoteEditorFragment;
  85      private Note mCurrentNote;
  86      private MenuItem mEmptyTrashMenuItem;
  87  
  88      // Menu drawer
  89      private DrawerLayout mDrawerLayout;
  90      private ListView mDrawerList;
  91      private NavigationView mNavigationView;
  92      private ActionBarDrawerToggle mDrawerToggle;
  93      private TagsAdapter mTagsAdapter;
  94      private TagsAdapter.TagMenuItem mSelectedTag;
  95      // Tags bucket listener
  96      private Bucket.Listener&lt;Tag&gt; mTagsMenuUpdater = new Bucket.Listener&lt;Tag&gt;() {
  97          void updateNavigationDrawer() {
  98              runOnUiThread(new Runnable() {
  99                  public void run() {
 100                      updateNavigationDrawerItems();
 101                  }
 102              });
 103          }
 104  
 105          @Override
 106          public void onSaveObject(Bucket&lt;Tag&gt; bucket, Tag tag) {
 107              updateNavigationDrawer();
 108          }
 109  
 110          @Override
 111          public void onDeleteObject(Bucket&lt;Tag&gt; bucket, Tag tag) {
 112              updateNavigationDrawer();
 113          }
 114  
 115          @Override
 116          public void onNetworkChange(Bucket&lt;Tag&gt; bucket, Bucket.ChangeType type, String key) {
 117              updateNavigationDrawer();
 118          }
 119  
 120          @Override
 121          public void onBeforeUpdateObject(Bucket&lt;Tag&gt; bucket, Tag object) {
 122              // noop
 123          }
 124      };
 125  
 126      @Override
 127      protected void onCreate(Bundle savedInstanceState) {
 128          // On lollipop, configure the translucent status bar
 129          if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.LOLLIPOP) {
 130              getWindow().addFlags(WindowManager.LayoutParams.FLAG_DRAWS_SYSTEM_BAR_BACKGROUNDS);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 131 -            getWindow().setStatusBarColor(ContextCompat.getColor(this, R.color.transparent));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 132 +            getWindow().setStatusBarColor(ContextCompat.getColor(this, R.color.translucent_grey_medium_light));</span>
 133          }
 134  
 135          ThemeUtils.setTheme(this);
 136          super.onCreate(savedInstanceState);
 137  
 138          setContentView(R.layout.activity_notes);
 139  
 140          mFragmentsContainer = findViewById(R.id.note_fragment_container);
 141  
 142          Simplenote currentApp = (Simplenote) getApplication();
 143          if (mNotesBucket == null) {
 144              mNotesBucket = currentApp.getNotesBucket();
 145          }
 146  
 147          if (mTagsBucket == null) {
 148              mTagsBucket = currentApp.getTagsBucket();
 149          }
 150  
 151          Toolbar toolbar = findViewById(R.id.toolbar);
 152          setSupportActionBar(toolbar);
 153          configureNavigationDrawer(toolbar);
 154  
 155          if (savedInstanceState == null) {
 156              mNoteListFragment = new NoteListFragment();
 157              FragmentTransaction fragmentTransaction = getSupportFragmentManager().beginTransaction();
 158              fragmentTransaction.add(R.id.note_fragment_container, mNoteListFragment, TAG_NOTE_LIST);
 159              fragmentTransaction.commit();
 160          } else {
 161              mNoteListFragment = (NoteListFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_LIST);
 162          }
 163  
 164          if (DisplayUtils.isLargeScreen(this)) {
 165              if (getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR) != null) {
<abbr title=" 166                  mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR);"> 166                  mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_ðŸ”µ</abbr>
 167              } else if (DisplayUtils.isLandscape(this)) {
 168                  addEditorFragment();
 169              }
 170          }
 171  
 172          // enable ActionBar app icon to behave as action to toggle nav drawer
 173          ActionBar actionBar = getSupportActionBar();
 174          if (actionBar != null) {
 175              actionBar.setDisplayHomeAsUpEnabled(true);
 176              actionBar.setHomeButtonEnabled(true);
 177  
 178              // Add loading indicator to show when indexing
<abbr title=" 179              ProgressBar progressBar = (ProgressBar) getLayoutInflater().inflate(R.layout.progressbar_toolbar, null);"> 179              ProgressBar progressBar = (ProgressBar) getLayoutInflater().inflate(R.layout.progressbar_toolbar, nullðŸ”µ</abbr>
 180              actionBar.setDisplayShowCustomEnabled(true);
 181              actionBar.setCustomView(progressBar);
 182              setToolbarProgressVisibility(false);
 183          }
 184  
 185          mUndoBarController = new UndoBarController(this);
 186  
 187          // Creates &#x27;Welcome&#x27; note
 188          checkForFirstLaunch();
 189  
 190          checkForSharedContent();
 191  
 192          currentApp.getSimperium().setOnUserCreatedListener(this);
 193          currentApp.getSimperium().setUserStatusChangeListener(this);
 194      }
 195  
 196      @Override
 197      protected void onResume() {
 198          super.onResume();
 199  
 200          // Ensure user has valid authorization
 201          if (userAuthenticationIsInvalid()) {
 202              startLoginActivity(true);
 203          }
 204  
 205          disableScreenshotsIfLocked(this);
 206  
 207          mNotesBucket.start();
 208          mTagsBucket.start();
 209  
 210          mNotesBucket.addOnNetworkChangeListener(this);
 211          mNotesBucket.addOnSaveObjectListener(this);
 212          mNotesBucket.addOnDeleteObjectListener(this);
 213          mTagsBucket.addListener(mTagsMenuUpdater);
 214  
 215          updateNavigationDrawerItems();
 216  
 217          // if the user is not authenticated and the tag doesn&#x27;t exist revert to default drawer selection
 218          if (userIsUnauthorized()) {
 219              if (-1 == mTagsAdapter.getPosition(mSelectedTag)) {
 220                  mSelectedTag = null;
 221                  mDrawerList.setSelection(TagsAdapter.DEFAULT_ITEM_POSITION);
 222              }
 223          }
 224  
 225          setSelectedTagActive();
 226  
 227          if (mCurrentNote != null &amp;&amp; mShouldSelectNewNote) {
 228              onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled());
 229              mShouldSelectNewNote = false;
 230          }
 231  
 232          if (mIsShowingMarkdown) {
 233              setMarkdownShowing(false);
 234          }
 235  
 236      }
 237  
 238      @Override
 239      protected void onPause() {
 240          super.onPause();  // Always call the superclass method first
 241          mTagsBucket.removeListener(mTagsMenuUpdater);
 242          mTagsBucket.stop();
 243  
 244          mNotesBucket.removeOnNetworkChangeListener(this);
 245          mNotesBucket.removeOnSaveObjectListener(this);
 246          mNotesBucket.removeOnDeleteObjectListener(this);
 247          mNotesBucket.stop();
 248      }
 249  
 250      @Override
 251      public void setTitle(CharSequence title) {
 252          if (title == null) {
 253              title = &quot;&quot;;
 254          }
 255  
 256          setTitleWithCustomFont(title);
 257      }
 258  
 259      @Override
 260      public void onBackPressed() {
 261          if (mDrawerLayout != null &amp;&amp; mDrawerLayout.isDrawerOpen(GravityCompat.START)) {
 262              mDrawerLayout.closeDrawer(GravityCompat.START);
 263          } else {
 264              super.onBackPressed();
 265          }
 266      }
 267  
 268      private void setTitleWithCustomFont(CharSequence title) {
 269          if (getSupportActionBar() == null) return;
 270  
 271          // LG devices running 4.1 can&#x27;t handle a custom font in the action bar title
 272          if ((!TextUtils.isEmpty(Build.BRAND) &amp;&amp; Build.BRAND.toLowerCase().contains(&quot;lge&quot;))
 273                  &amp;&amp; Build.VERSION.SDK_INT &lt;= Build.VERSION_CODES.JELLY_BEAN) {
 274              getSupportActionBar().setTitle(title);
 275              return;
 276          }
 277  
 278          SpannableString s = new SpannableString(title);
 279          s.setSpan(new TypefaceSpan(this), 0, s.length(), Spannable.SPAN_EXCLUSIVE_EXCLUSIVE);
 280          getSupportActionBar().setTitle(s);
 281      }
 282  
 283      private void configureNavigationDrawer(Toolbar toolbar) {
 284          mDrawerLayout = findViewById(R.id.drawer_layout);
 285          mDrawerLayout.setDrawerShadow(R.drawable.drawer_shadow, GravityCompat.START);
 286          mNavigationView = findViewById(R.id.navigation_view);
 287          mDrawerList = findViewById(R.id.drawer_list);
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 288 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 289 +        if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.LOLLIPOP) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 290 +            mNavigationView.setOnApplyWindowInsetsListener(new View.OnApplyWindowInsetsListener() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 291 +                @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 292 +                public WindowInsets onApplyWindowInsets(View view, WindowInsets windowInsets) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 293 +                    LinearLayout drawerView = findViewById(R.id.drawer_view);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 294 +                    drawerView.setPadding(</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 295 +                            drawerView.getPaddingLeft(),</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 296 +                            windowInsets.getSystemWindowInsetTop(),</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 297 +                            drawerView.getPaddingRight(),</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 298 +                            drawerView.getPaddingBottom());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 299 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 300 +                    return windowInsets.consumeSystemWindowInsets();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 301 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 302 +            });</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 303 +        }</span>
 304  
 305          View settingsButton = findViewById(R.id.nav_settings);
 306          settingsButton.setOnClickListener(new View.OnClickListener() {
 307              @Override
 308              public void onClick(View v) {
 309                  Intent i = new Intent(NotesActivity.this, PreferencesActivity.class);
 310                  startActivityForResult(i, Simplenote.INTENT_PREFERENCES);
 311              }
 312          });
 313  
 314          mNavigationView.getLayoutParams().width = ThemeUtils.getOptimalDrawerWidth(this);
 315          mTagsAdapter = new TagsAdapter(this, mNotesBucket, mDrawerList.getHeaderViewsCount());
 316          mDrawerList.setAdapter(mTagsAdapter);
 317          // Set the list&#x27;s click listener
 318          mDrawerList.setOnItemClickListener(new DrawerItemClickListener());
 319  
 320          if (mSelectedTag == null)
 321              mSelectedTag = mTagsAdapter.getDefaultItem();
 322  
 323          mDrawerToggle = new ActionBarDrawerToggle(this, mDrawerLayout, toolbar, R.string.open_drawer,
 324                  R.string.close_drawer) {
 325              public void onDrawerClosed(View view) {
 326                  supportInvalidateOptionsMenu();
 327              }
 328  
 329              public void onDrawerOpened(View drawerView) {
 330                  // noop
 331              }
 332  
 333              @Override
 334              public void onDrawerSlide(View drawerView, float slideOffset) {
 335                  super.onDrawerSlide(drawerView, 0f);
 336              }
 337          };
 338  
 339          mDrawerLayout.addDrawerListener(mDrawerToggle);
 340      }
 341  
 342      private void checkForFirstLaunch() {
 343          if (PrefUtils.getBoolPref(this, PrefUtils.PREF_FIRST_LAUNCH, true)) {
 344              // Create the welcome note
 345              try {
 346                  Note welcomeNote = mNotesBucket.newObject(&quot;welcome-android&quot;);
 347                  welcomeNote.setCreationDate(Calendar.getInstance());
 348                  welcomeNote.setModificationDate(welcomeNote.getCreationDate());
 349                  welcomeNote.setContent(getString(R.string.welcome_note));
 350                  welcomeNote.getTitle();
 351                  welcomeNote.save();
 352              } catch (BucketObjectNameInvalid e) {
 353                  // this won&#x27;t happen because welcome-android is a valid name
 354              }
 355  
 356              SharedPreferences preferences = PreferenceManager.getDefaultSharedPreferences(this);
 357              SharedPreferences.Editor editor = preferences.edit();
 358              editor.putBoolean(PrefUtils.PREF_FIRST_LAUNCH, false);
 359              editor.putBoolean(PrefUtils.PREF_ACCOUNT_REQUIRED, true);
 360              editor.apply();
 361          }
 362      }
 363  
 364      private void checkForSharedContent() {
 365          if (getIntent().hasExtra(Intent.EXTRA_TEXT)) {
 366              // Check share action
 367              Intent intent = getIntent();
 368              String subject = intent.getStringExtra(Intent.EXTRA_SUBJECT);
 369              String text = intent.getStringExtra(Intent.EXTRA_TEXT);
 370  
 371              // Don&#x27;t add the &#x27;Note to self&#x27; subject or open the note if this was shared from a voice search
 372              String intentAction = StrUtils.notNullStr(intent.getAction());
 373              boolean isVoiceShare = intentAction.equals(&quot;com.google.android.gm.action.AUTO_SEND&quot;);
 374              if (!TextUtils.isEmpty(text)) {
 375                  if (!TextUtils.isEmpty(subject) &amp;&amp; !isVoiceShare) {
 376                      text = subject + &quot;\n\n&quot; + text;
 377                  }
 378                  Note note = mNotesBucket.newObject();
 379                  note.setCreationDate(Calendar.getInstance());
 380                  note.setModificationDate(note.getCreationDate());
 381                  note.setContent(text);
 382                  note.save();
 383                  setCurrentNote(note);
 384                  mShouldSelectNewNote = true;
 385  
 386                  AnalyticsTracker.track(
 387                          AnalyticsTracker.Stat.LIST_NOTE_CREATED,
 388                          AnalyticsTracker.CATEGORY_NOTE,
 389                          &quot;external_share&quot;
 390                  );
 391  
 392                  if (!DisplayUtils.isLargeScreenLandscape(this)) {
 393                      // Disable the lock screen when sharing content and opening NoteEditorActivity
 394                      // Lock screen activities are enabled again in NoteEditorActivity.onPause()
 395                      if (AppLockManager.getInstance().isAppLockFeatureEnabled()) {
 396                          AppLockManager.getInstance().getAppLock().setExemptActivities(
 397                                  new String[]{&quot;com.automattic.simplenote.NotesActivity&quot;,
 398                                          &quot;com.automattic.simplenote.NoteEditorActivity&quot;});
 399                          AppLockManager.getInstance().getAppLock().setOneTimeTimeout(0);
 400                      }
 401                  }
 402              }
 403          }
 404      }
 405  
 406      private void updateNavigationDrawerItems() {
 407          boolean isAlphaSort = PrefUtils.getBoolPref(this, PrefUtils.PREF_SORT_TAGS_ALPHA);
 408          Bucket.ObjectCursor&lt;Tag&gt; tagCursor;
 409          if (isAlphaSort) {
 410              tagCursor = Tag.allSortedAlphabetically(mTagsBucket).execute();
 411          } else {
 412              tagCursor = Tag.allWithName(mTagsBucket).execute();
 413          }
 414  
 415          mTagsAdapter.changeCursor(tagCursor);
 416      }
 417  
 418      private void setSelectedTagActive() {
 419          if (mSelectedTag == null)
 420              mSelectedTag = mTagsAdapter.getDefaultItem();
 421  
 422          setTitle(mSelectedTag.name);
<abbr title=" 423          mDrawerList.setItemChecked(mTagsAdapter.getPosition(mSelectedTag) + mDrawerList.getHeaderViewsCount(), true);"> 423          mDrawerList.setItemChecked(mTagsAdapter.getPosition(mSelectedTag) + mDrawerList.getHeaderViewsCount(), truðŸ”µ</abbr>
 424      }
 425  
 426      public TagsAdapter.TagMenuItem getSelectedTag() {
 427          if (mSelectedTag == null) {
 428              mSelectedTag = mTagsAdapter.getDefaultItem();
 429          }
 430  
 431          return mSelectedTag;
 432      }
 433  
 434      // Enable or disable the trash action bar button depending on if there are deleted notes or not
 435      public void updateTrashMenuItem() {
 436          if (mEmptyTrashMenuItem == null || mNotesBucket == null)
 437              return;
 438  
 439          // Disable the trash icon if there are no notes trashed.
 440          Query&lt;Note&gt; query = Note.allDeleted(mNotesBucket);
 441          if (query.count() == 0) {
 442              mEmptyTrashMenuItem.setEnabled(false);
 443          } else {
 444              mEmptyTrashMenuItem.setEnabled(true);
 445          }
 446      }
 447  
 448      private void addEditorFragment() {
 449          FragmentManager fm = getSupportFragmentManager();
 450          FragmentTransaction ft = fm.beginTransaction();
 451          mNoteEditorFragment = new NoteEditorFragment();
 452          ft.add(R.id.note_fragment_container, mNoteEditorFragment, TAG_NOTE_EDITOR);
 453          ft.commitAllowingStateLoss();
 454          fm.executePendingTransactions();
 455      }
 456  
 457      private boolean userAccountRequired() {
 458          return PrefUtils.getBoolPref(this, PrefUtils.PREF_ACCOUNT_REQUIRED, false);
 459      }
 460  
 461      /**
 462       * Checks for a previously valid user that is now not authenticated
 463       * Also checks if user account is required (added in version 1.5.6)
 464       *
 465       * @return true if user has invalid authorization
 466       */
 467      private boolean userAuthenticationIsInvalid() {
 468          Simplenote currentApp = (Simplenote) getApplication();
 469          Simperium simperium = currentApp.getSimperium();
 470          User user = simperium.getUser();
 471          boolean isNotAuthorized = user.getStatus().equals(User.Status.NOT_AUTHORIZED);
 472          return (user.hasAccessToken() &amp;&amp; isNotAuthorized) ||
 473                  (userAccountRequired() &amp;&amp; isNotAuthorized);
 474      }
 475  
 476      public boolean userIsUnauthorized() {
 477          Simplenote currentApp = (Simplenote) getApplication();
 478          return currentApp.getSimperium().getUser().getStatus() == User.Status.NOT_AUTHORIZED;
 479      }
 480  
 481      public void setCurrentNote(Note note) {
 482          mCurrentNote = note;
 483      }
 484  
 485      public NoteListFragment getNoteListFragment() {
 486          return mNoteListFragment;
 487      }
 488  
 489      @SuppressWarnings(&quot;ResourceType&quot;)
 490      @Override
 491      public boolean onCreateOptionsMenu(Menu menu) {
 492          super.onCreateOptionsMenu(menu);
 493          MenuInflater inflater = getMenuInflater();
 494          inflater.inflate(R.menu.notes_list, menu);
 495  
 496          // restore the search query if on a landscape tablet
 497          String searchQuery = null;
 498          if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; mSearchView != null)
 499              searchQuery = mSearchView.getQuery().toString();
 500  
 501          mSearchMenuItem = menu.findItem(R.id.menu_search);
 502          mSearchView = (SearchView) mSearchMenuItem.getActionView();
 503  
 504          if (!TextUtils.isEmpty(searchQuery)) {
 505              mSearchView.setQuery(searchQuery, false);
 506              mSearchMenuItem.expandActionView();
 507          } else {
 508              // Workaround for setting the search placeholder text color
 509              String hintHexColor = (ThemeUtils.isLightTheme(this) ?
 510                      getString(R.color.simplenote_light_grey) :
 511                      getString(R.color.simplenote_text_preview)).replace(&quot;ff&quot;, &quot;&quot;);


 512              mSearchView.setQueryHint(HtmlCompat.fromHtml(String.format(&quot;&lt;font color=\&quot;%s\&quot;&gt;%s&lt;/font&gt;&quot;,
 513                      hintHexColor,
 514                      getString(R.string.search))));
 515          }
 516  
 517          mSearchView.setOnQueryTextListener(new SearchView.OnQueryTextListener() {
 518              @Override
 519              public boolean onQueryTextChange(String newText) {
 520                  if (mSearchMenuItem.isActionViewExpanded()) {
 521                      getNoteListFragment().searchNotes(newText);
 522                  }
 523                  return true;
 524              }
 525  
 526              @Override
 527              public boolean onQueryTextSubmit(String queryText) {
 528                  getNoteListFragment().searchNotes(queryText);
 529                  return true;
 530              }
 531  
 532          });
 533  
 534          mSearchMenuItem.setOnActionExpandListener(new MenuItem.OnActionExpandListener() {
 535              @Override
 536              public boolean onMenuItemActionExpand(MenuItem menuItem) {
 537                  checkEmptyListText(true);
 538                  if (mNoteListFragment != null) {
 539                      mNoteListFragment.setFloatingActionButtonVisible(false);
 540                  }
 541                  AnalyticsTracker.track(
 542                          AnalyticsTracker.Stat.LIST_NOTES_SEARCHED,
 543                          AnalyticsTracker.CATEGORY_NOTE,
 544                          &quot;action_bar_search_tap&quot;
 545                  );
 546                  return true;
 547              }
 548  
 549              @Override
 550              public boolean onMenuItemActionCollapse(MenuItem menuItem) {
 551                  // Show all notes again
 552                  if (mNoteListFragment != null) {
 553                      mNoteListFragment.setFloatingActionButtonVisible(true);
 554                  }
 555                  mTabletSearchQuery = &quot;&quot;;
 556                  mSearchView.setQuery(&quot;&quot;, false);
 557                  checkEmptyListText(false);
 558                  getNoteListFragment().clearSearch();
 559                  return true;
 560              }
 561          });
 562  
 563          mSearchMenuItem.setOnMenuItemClickListener(new MenuItem.OnMenuItemClickListener() {
 564              @Override
 565              public boolean onMenuItemClick(MenuItem item) {
 566                  if (!mSearchMenuItem.isActionViewExpanded())
 567                      showDetailPlaceholder();
 568                  return false;
 569              }
 570          });
 571  
 572          MenuItem trashItem = menu.findItem(R.id.menu_delete).setTitle(R.string.undelete);
 573          if (mCurrentNote != null &amp;&amp; mCurrentNote.isDeleted()) {
 574              trashItem.setTitle(R.string.undelete);
 575              trashItem.setIcon(R.drawable.ic_trash_restore_24dp);
 576          } else {
 577              trashItem.setTitle(R.string.delete);
 578              trashItem.setIcon(R.drawable.ic_trash_24dp);
 579          }
 580  
 581          if (DisplayUtils.isLargeScreenLandscape(this)) {
 582              // Restore the search query on landscape tablets
 583              if (!TextUtils.isEmpty(mTabletSearchQuery)) {
 584                  mSearchMenuItem.expandActionView();
 585                  mSearchView.setQuery(mTabletSearchQuery, false);
 586                  mSearchView.clearFocus();
 587              }
 588  
 589              if (mCurrentNote != null) {
 590                  menu.findItem(R.id.menu_share).setVisible(true);
 591                  menu.findItem(R.id.menu_view_info).setVisible(true);
 592                  menu.findItem(R.id.menu_checklist).setVisible(true);
 593                  menu.findItem(R.id.menu_history).setVisible(true);
 594                  menu.findItem(R.id.menu_markdown_preview).setVisible(mCurrentNote.isMarkdownEnabled());
 595                  trashItem.setVisible(true);
 596              } else {
 597                  menu.findItem(R.id.menu_share).setVisible(false);
 598                  menu.findItem(R.id.menu_view_info).setVisible(false);
 599                  menu.findItem(R.id.menu_checklist).setVisible(false);
 600                  menu.findItem(R.id.menu_history).setVisible(false);
 601                  menu.findItem(R.id.menu_markdown_preview).setVisible(false);
 602                  trashItem.setVisible(false);
 603              }
 604              menu.findItem(R.id.menu_empty_trash).setVisible(false);
 605          } else {
 606              menu.findItem(R.id.menu_search).setVisible(true);
 607              menu.findItem(R.id.menu_share).setVisible(false);
 608              menu.findItem(R.id.menu_view_info).setVisible(false);
 609              menu.findItem(R.id.menu_checklist).setVisible(false);
 610              menu.findItem(R.id.menu_history).setVisible(false);
 611              menu.findItem(R.id.menu_markdown_preview).setVisible(false);
 612              trashItem.setVisible(false);
 613              menu.findItem(R.id.menu_empty_trash).setVisible(false);
 614          }
 615  
 616          // Are we looking at the trash? Adjust menu accordingly.
 617          if (mDrawerList.getCheckedItemPosition() == TRASH_SELECTED_ID) {
 618              mEmptyTrashMenuItem = menu.findItem(R.id.menu_empty_trash);
 619              mEmptyTrashMenuItem.setVisible(true);
 620  
 621              updateTrashMenuItem();
 622  
 623              menu.findItem(R.id.menu_search).setVisible(false);
 624              menu.findItem(R.id.menu_share).setVisible(false);
 625              menu.findItem(R.id.menu_history).setVisible(false);
 626              menu.findItem(R.id.menu_checklist).setVisible(false);
 627          }
 628  
 629          DrawableUtils.tintMenuWithAttribute(this, menu, R.attr.actionBarTextColor);
 630  
 631          return true;
 632      }
 633  
 634      @Override
 635      public boolean onOptionsItemSelected(MenuItem item) {
 636          if (mDrawerToggle.onOptionsItemSelected(item)) {
 637              return true;
 638          }
 639          switch (item.getItemId()) {
 640              case R.id.menu_markdown_preview:
 641                  if (mIsShowingMarkdown) {
 642                      item.setIcon(R.drawable.ic_preview_24dp);
 643                      item.setTitle(getString(R.string.markdown_show));
 644                      setMarkdownShowing(false);
 645                  } else {
 646                      item.setIcon(R.drawable.ic_preview_stop_24dp);
 647                      item.setTitle(getString(R.string.markdown_hide));
 648                      setMarkdownShowing(true);
 649                  }
 650  
 651                  DrawableUtils.tintMenuItemWithAttribute(this, item, R.attr.actionBarTextColor);
 652  
 653                  return true;
 654              case R.id.menu_delete:
 655                  if (mNoteEditorFragment != null) {
 656                      if (mCurrentNote != null) {
 657                          mCurrentNote.setDeleted(!mCurrentNote.isDeleted());
 658                          mCurrentNote.setModificationDate(Calendar.getInstance());
 659                          mCurrentNote.save();
 660  
 661                          updateViewsAfterTrashAction(mCurrentNote);
 662                      }
 663                  }
 664                  return true;
 665              case R.id.menu_empty_trash:
 666                  AlertDialog.Builder alert = new AlertDialog.Builder(this);
 667  
 668                  alert.setTitle(R.string.empty_trash);
 669                  alert.setMessage(R.string.confirm_empty_trash);
 670                  alert.setPositiveButton(R.string.yes, new DialogInterface.OnClickListener() {
 671                      public void onClick(DialogInterface dialog, int whichButton) {
 672                          new emptyTrashTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR);
 673                          AnalyticsTracker.track(
 674                                  AnalyticsTracker.Stat.LIST_TRASH_EMPTIED,
 675                                  AnalyticsTracker.CATEGORY_NOTE,
 676                                  &quot;overflow_menu&quot;
 677                          );
 678                      }
 679                  });
 680                  alert.setNegativeButton(R.string.no, new DialogInterface.OnClickListener() {
 681                      public void onClick(DialogInterface dialog, int whichButton) {
 682                          // Do nothing, just closing the dialog
 683                      }
 684                  });
 685                  alert.show();
 686                  return true;
 687              case android.R.id.home:
 688                  invalidateOptionsMenu();
 689                  return true;
 690              default:
 691                  return super.onOptionsItemSelected(item);
 692          }
 693      }
 694  
 695      @Override
 696      public boolean onPrepareOptionsMenu(Menu menu) {
 697          MenuItem markdownItem = menu.findItem(R.id.menu_markdown_preview);
 698  
 699          if (mIsShowingMarkdown) {
 700              markdownItem.setIcon(R.drawable.ic_preview_stop_24dp);
 701              markdownItem.setTitle(getString(R.string.markdown_hide));
 702          } else {
 703              markdownItem.setIcon(R.drawable.ic_preview_24dp);
 704              markdownItem.setTitle(getString(R.string.markdown_show));
 705          }
 706  
 707          DrawableUtils.tintMenuItemWithAttribute(this, markdownItem, R.attr.actionBarTextColor);
 708  
 709          return super.onPrepareOptionsMenu(menu);
 710      }
 711  
 712      public void updateViewsAfterTrashAction(Note note) {
 713          if (note == null || isFinishing()) {
 714              return;
 715          }
 716  
 717          if (note.isDeleted()) {
 718              List&lt;String&gt; deletedNoteIds = new ArrayList&lt;&gt;();
 719              deletedNoteIds.add(note.getSimperiumKey());
 720              mUndoBarController.setDeletedNoteIds(deletedNoteIds);
 721              mUndoBarController.showUndoBar(getUndoView(), getString(R.string.note_deleted));
 722              AnalyticsTracker.track(
 723                      AnalyticsTracker.Stat.LIST_NOTE_DELETED,
 724                      AnalyticsTracker.CATEGORY_NOTE,
 725                      &quot;overflow_menu&quot;
 726              );
 727          } else {
 728              AnalyticsTracker.track(
 729                      AnalyticsTracker.Stat.EDITOR_NOTE_RESTORED,
 730                      AnalyticsTracker.CATEGORY_NOTE,
 731                      &quot;overflow_menu&quot;
 732              );
 733          }
 734  
 735          // If we just deleted/restored the active note, show the placeholder
 736          if (mCurrentNote != null &amp;&amp; mCurrentNote.getSimperiumKey().equals(note.getSimperiumKey())) {
 737              showDetailPlaceholder();
 738          }
 739  
 740          NoteListFragment fragment = getNoteListFragment();
 741          if (fragment != null) {
 742              fragment.getPrefs();
 743              fragment.refreshList();
 744          }
 745  
 746          invalidateOptionsMenu();
 747      }
 748  
 749      public void setMarkdownShowing(boolean isMarkdownShowing) {
 750          mIsShowingMarkdown = isMarkdownShowing;
 751          if (mNoteEditorFragment != null) {
 752              if (isMarkdownShowing) {
 753                  mNoteEditorFragment.showMarkdown();
 754              } else {
 755                  mNoteEditorFragment.hideMarkdown();
 756              }
 757          }
 758          invalidateOptionsMenu();
 759      }
 760  
 761      /**
 762       * Callback method from {@link NoteListFragment.Callbacks} indicating that
 763       * the item with the given ID was selected. Used for tablets only.
 764       */
 765      @Override
 766      public void onNoteSelected(String noteID, int position, String matchOffsets, boolean isMarkdownEnabled) {
 767          if (!DisplayUtils.isLargeScreenLandscape(this)) {
 768              // Launch the editor activity
 769              Bundle arguments = new Bundle();
 770              arguments.putString(NoteEditorFragment.ARG_ITEM_ID, noteID);
 771              arguments.putBoolean(NoteEditorFragment.ARG_MARKDOWN_ENABLED, isMarkdownEnabled);
 772  
 773              if (matchOffsets != null)
 774                  arguments.putString(NoteEditorFragment.ARG_MATCH_OFFSETS, matchOffsets);
 775  
 776              Intent editNoteIntent = new Intent(this, NoteEditorActivity.class);
 777              editNoteIntent.putExtras(arguments);
 778              startActivityForResult(editNoteIntent, Simplenote.INTENT_EDIT_NOTE);
 779          } else {
 780              mNoteEditorFragment.setNote(noteID, matchOffsets);
 781              getNoteListFragment().setNoteSelected(noteID);
 782  
 783              if (mSearchView != null &amp;&amp; mSearchView.getQuery() != null) {
 784                  mTabletSearchQuery = mSearchView.getQuery().toString();
 785              }
 786  
 787              mNoteEditorFragment.clearMarkdown();
 788  
 789              if (!isMarkdownEnabled &amp;&amp; mIsShowingMarkdown) {
 790                  setMarkdownShowing(false);
 791              }
 792  
 793              invalidateOptionsMenu();
 794          }
 795  
 796          AnalyticsTracker.track(
 797                  AnalyticsTracker.Stat.LIST_NOTE_OPENED,
 798                  AnalyticsTracker.CATEGORY_NOTE,
 799                  &quot;note_list_row_tap&quot;
 800          );
 801      }
 802  
 803      @Override
 804      public void onUserCreated(User user) {
 805          // New account created
 806          AnalyticsTracker.track(
 807                  AnalyticsTracker.Stat.USER_ACCOUNT_CREATED,
 808                  AnalyticsTracker.CATEGORY_USER,
 809                  &quot;account_created_from_login_activity&quot;
 810          );
 811      }
 812  
 813      public void onUserStatusChange(User.Status status) {
 814          switch (status) {
 815              // successfully used access token to connect to simperium bucket
 816              case AUTHORIZED:
 817                  runOnUiThread(new Runnable() {
 818                      @Override
 819                      public void run() {
 820                          if (!mNotesBucket.hasChangeVersion()) {
 821                              setToolbarProgressVisibility(true);
 822                          }
 823                      }
 824                  });
 825                  break;
 826  
 827              // NOT_AUTHORIZED means we attempted to connect but the token was not valid
 828              case NOT_AUTHORIZED:
 829                  runOnUiThread(new Runnable() {
 830                      @Override
 831                      public void run() {
 832                          startLoginActivity(true);
 833                      }
 834                  });
 835                  break;
 836  
<abbr title=" 837              // Default starting state of User, don&#x27;t do anything we allow use of app while not signed in so don&#x27;t do anything"> 837              // Default starting state of User, don&#x27;t do anything we allow use of app while not signed in so don&#x27;t ðŸ”µ</abbr>
 838              case UNKNOWN:
 839                  break;
 840          }
 841      }
 842  
 843      private void setToolbarProgressVisibility(boolean isVisible) {
 844          if (getSupportActionBar() != null) {
 845              getSupportActionBar().setDisplayShowCustomEnabled(isVisible);
 846          }
 847      }
 848  
 849      public void startLoginActivity(boolean signInFirst) {
 850          // Clear some account-specific prefs
 851          SharedPreferences.Editor editor = PreferenceManager.getDefaultSharedPreferences(this).edit();
 852          editor.remove(PrefUtils.PREF_WP_TOKEN);
 853          editor.remove(PrefUtils.PREF_WORDPRESS_SITES);
 854          editor.apply();
 855  
 856          Intent loginIntent = new Intent(this, SignInActivity.class);
 857          if (signInFirst) {
 858              loginIntent.putExtra(SignInActivity.EXTRA_SIGN_IN_FIRST, true);
 859          }
 860          startActivityForResult(loginIntent, Simperium.SIGNUP_SIGNIN_REQUEST);
 861      }
 862  
 863      @Override
 864      public void recreate() {
 865          Handler handler = new Handler();
 866          handler.post(new Runnable() {
 867              @Override
 868              public void run() {
 869                  NotesActivity.super.recreate();
 870              }
 871          });
 872      }
 873  
 874      @Override
 875      protected void onActivityResult(int requestCode, int resultCode, Intent data) {
 876          super.onActivityResult(requestCode, resultCode, data);
 877          switch (requestCode) {
 878              case Simplenote.INTENT_PREFERENCES:
 879                  if (ThemeUtils.themeWasChanged(data)) {
 880                      // Restart this activity to apply the new theme
 881                      recreate();
 882                      break;
 883                  }
<abbr title=" 884                  // nbradbury - refresh note list when user returns from preferences (in case they changed anything)"> 884                  // nbradbury - refresh note list when user returns from preferences (in case they changed anythingðŸ”µ</abbr>
 885                  invalidateOptionsMenu();
 886                  NoteListFragment fragment = getNoteListFragment();
 887                  if (fragment != null) {
 888                      fragment.getPrefs();
 889                      fragment.refreshList();
 890                  }
 891  
 892                  break;
 893              case Simplenote.INTENT_EDIT_NOTE:
 894                  if (resultCode == RESULT_OK &amp;&amp; data != null) {
 895                      if (data.hasExtra(Simplenote.DELETED_NOTE_ID)) {
 896                          String noteId = data.getStringExtra(Simplenote.DELETED_NOTE_ID);
 897                          if (noteId != null) {
 898                              List&lt;String&gt; deletedNoteIds = new ArrayList&lt;&gt;();
 899                              deletedNoteIds.add(noteId);
 900                              mUndoBarController.setDeletedNoteIds(deletedNoteIds);
 901                              mUndoBarController.showUndoBar(getUndoView(), getString(R.string.note_deleted));
 902                          }
<abbr title=" 903                      } else if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; data.hasExtra(Simplenote.SELECTED_NOTE_ID)) {"> 903                      } else if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; data.hasExtra(Simplenote.SELECTED_NOTEðŸ”µ</abbr>
 904                          String selectedNoteId = data.getStringExtra(Simplenote.SELECTED_NOTE_ID);
 905                          mNoteListFragment.setNoteSelected(selectedNoteId);
 906                          if (mNoteEditorFragment != null) {
 907                              mNoteEditorFragment.setNote(selectedNoteId);
 908                          }
 909                      }
 910                  }
 911                  break;
 912              case Simperium.SIGNUP_SIGNIN_REQUEST:
 913                  invalidateOptionsMenu();
 914  
 915                  Simplenote app = (Simplenote) getApplication();
 916                  AnalyticsTracker.refreshMetadata(app.getSimperium().getUser().getEmail());
 917  
 918                  AnalyticsTracker.track(
 919                          AnalyticsTracker.Stat.USER_SIGNED_IN,
 920                          AnalyticsTracker.CATEGORY_USER,
 921                          &quot;signed_in_from_login_activity&quot;
 922                  );
 923  
 924                  if (resultCode == Activity.RESULT_CANCELED &amp;&amp; userAuthenticationIsInvalid()) {
 925                      finish();
 926                  }
 927  
 928                  break;
 929          }
 930      }
 931  
 932      @Override
 933      public void onUndo() {
 934          if (mUndoBarController == null) return;
 935  
 936          List&lt;String&gt; deletedNoteIds = mUndoBarController.getDeletedNoteIds();
 937          if (deletedNoteIds != null) {
 938              for (int i = 0; i &lt; deletedNoteIds.size(); i++) {
 939                  Note deletedNote;
 940                  try {
 941                      deletedNote = mNotesBucket.get(deletedNoteIds.get(i));
 942                  } catch (BucketObjectMissingException e) {
 943                      return;
 944                  }
 945                  if (deletedNote != null) {
 946                      deletedNote.setDeleted(false);
 947                      deletedNote.setModificationDate(Calendar.getInstance());
 948                      deletedNote.save();
 949                      NoteListFragment fragment = getNoteListFragment();
 950                      if (fragment != null) {
 951                          fragment.getPrefs();
 952                          fragment.refreshList();
 953                      }
 954                  }
 955              }
 956          }
 957      }
 958  
 959      @Override
 960      protected void onPostCreate(Bundle savedInstanceState) {
 961          super.onPostCreate(savedInstanceState);
 962          // Sync the toggle state after onRestoreInstanceState has occurred.
 963          mDrawerToggle.syncState();
 964      }
 965  
 966      @Override
 967      public void onConfigurationChanged(Configuration newConfig) {
 968          super.onConfigurationChanged(newConfig);
 969  
 970          mDrawerToggle.onConfigurationChanged(newConfig);
 971  
 972          if (DisplayUtils.isLargeScreen(this)) {
 973              mIsShowingMarkdown = false;
 974  
 975              if (newConfig.orientation == Configuration.ORIENTATION_LANDSCAPE) {
 976                  // Add the editor fragment
 977                  if (getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR) != null) {
<abbr title=" 978                      mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR);"> 978                      mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByTag(TAG_NðŸ”µ</abbr>
 979                  } else if (DisplayUtils.isLandscape(this)) {
 980                      addEditorFragment();
 981                  }
 982                  if (mNoteListFragment != null) {
 983                      mNoteListFragment.setActivateOnItemClick(true);
 984                      mNoteListFragment.setDividerVisible(true);
 985                  }
 986                  // Select the current note on a tablet
 987                  if (mCurrentNote != null)
 988                      onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled());
 989                  else {
 990                      mNoteEditorFragment.setPlaceholderVisible(true);
 991                      mNoteListFragment.getListView().clearChoices();
 992                  }
 993                  invalidateOptionsMenu();
 994              }
 995          }
 996  
 997          if (newConfig.orientation == Configuration.ORIENTATION_PORTRAIT &amp;&amp; mNoteEditorFragment != null) {
 998              // Remove the editor fragment when rotating back to portrait
 999              mCurrentNote = null;
1000              if (mNoteListFragment != null) {
1001                  mNoteListFragment.setActivateOnItemClick(false);
1002                  mNoteListFragment.setDividerVisible(false);
1003                  mNoteListFragment.setActivatedPosition(ListView.INVALID_POSITION);
1004                  mNoteListFragment.refreshList();
1005              }
1006              FragmentManager fm = getSupportFragmentManager();
1007              FragmentTransaction ft = fm.beginTransaction();
1008              ft.remove(mNoteEditorFragment);
1009              mNoteEditorFragment = null;
1010              ft.commitAllowingStateLoss();
1011              fm.executePendingTransactions();
1012              invalidateOptionsMenu();
1013          }
1014      }
1015  
1016      public void checkEmptyListText(boolean isSearch) {
1017          if (isSearch) {
<abbr title="1018              getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_found) + &quot;&lt;/strong&gt;&quot;);">1018              getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_found) + &quot;&lt;/strong&gt;ðŸ”µ</abbr>
1019              getNoteListFragment().setEmptyListViewClickable(false);
1020          } else if (mDrawerList.getCheckedItemPosition() == TRASH_SELECTED_ID) {
<abbr title="1021              getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.trash_is_empty) + &quot;&lt;/strong&gt;&quot;);">1021              getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.trash_is_empty) + &quot;&lt;/strong&gt;ðŸ”µ</abbr>
1022              AnalyticsTracker.track(
1023                      AnalyticsTracker.Stat.LIST_TRASH_VIEWED,
1024                      AnalyticsTracker.CATEGORY_NOTE,
1025                      &quot;trash_filter_selected&quot;
1026              );
1027              getNoteListFragment().setEmptyListViewClickable(false);
1028          } else {
<abbr title="1029              getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here) + &quot;&lt;/strong&gt;&lt;br /&gt;&quot; + String.format(getString(R.string.why_not_create_one), &quot;&lt;u&gt;&quot;, &quot;&lt;/u&gt;&quot;));">1029              getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here) + &quot;&lt;/strong&gt;&lt;ðŸ”µ</abbr>
1030              getNoteListFragment().setEmptyListViewClickable(true);
1031          }
1032      }
1033  
1034      public void showDetailPlaceholder() {
1035          if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; mNoteEditorFragment != null) {
1036              mCurrentNote = null;
1037              mNoteEditorFragment.setPlaceholderVisible(true);
1038              mNoteEditorFragment.clearMarkdown();
1039              mNoteEditorFragment.hideMarkdown();
1040              mIsShowingMarkdown = false;
1041          }
1042      }
1043  
1044      public void stopListeningToNotesBucket() {
1045          mNotesBucket.removeOnNetworkChangeListener(this);
1046          mNotesBucket.removeOnSaveObjectListener(this);
1047          mNotesBucket.removeOnDeleteObjectListener(this);
1048      }
1049  
1050      // Returns the appropriate view to show the undo bar within
1051      private View getUndoView() {
1052          View undoView = mFragmentsContainer;
1053          if (!DisplayUtils.isLargeScreenLandscape(this) &amp;&amp;
1054                  getNoteListFragment() != null &amp;&amp;
1055                  getNoteListFragment().getRootView() != null) {
1056              undoView = getNoteListFragment().getRootView();
1057          }
1058  
1059          return undoView;
1060      }
1061  
1062      public void showUndoBarWithNoteIds(List&lt;String&gt; noteIds) {
1063          if (mUndoBarController != null) {
1064              mUndoBarController.setDeletedNoteIds(noteIds);
1065              mUndoBarController.showUndoBar(
1066                      getUndoView(),
1067                      getResources().getQuantityString(R.plurals.trashed_notes, noteIds.size(), noteIds.size())
1068              );
1069          }
1070      }
1071  
1072      /* Simperium Bucket Listeners */
1073      // received a change from the network, refresh the list
1074      @Override
1075      public void onNetworkChange(Bucket&lt;Note&gt; bucket, final Bucket.ChangeType type, String key) {
1076          runOnUiThread(new Runnable() {
1077              @Override
1078              public void run() {
1079                  if (type == Bucket.ChangeType.INDEX) {
1080                      setToolbarProgressVisibility(false);
1081                  }
1082                  mNoteListFragment.refreshList();
1083              }
1084          });
1085      }
1086  
1087      @Override
1088      public void onSaveObject(Bucket&lt;Note&gt; bucket, Note object) {
1089          runOnUiThread(new Runnable() {
1090              @Override
1091              public void run() {
1092                  mNoteListFragment.refreshList();
1093              }
1094          });
1095      }
1096  
1097      @Override
1098      public void onDeleteObject(Bucket&lt;Note&gt; bucket, Note object) {
1099          runOnUiThread(new Runnable() {
1100              @Override
1101              public void run() {
1102                  mNoteListFragment.refreshList();
1103              }
1104          });
1105      }
1106  
1107      @Override
1108      public void onBeforeUpdateObject(Bucket&lt;Note&gt; bucket, Note note) {
1109          // noop, NoteEditorFragment will handle this
1110      }
1111  
1112      /* The click listener for ListView in the navigation drawer */
1113      private class DrawerItemClickListener implements ListView.OnItemClickListener {
1114          @Override
1115          public void onItemClick(AdapterView&lt;?&gt; parent, View view, int position, long id) {
1116  
1117              // Adjust for header view
1118              position -= mDrawerList.getHeaderViewsCount();
1119              mSelectedTag = mTagsAdapter.getItem(position);
1120              checkEmptyListText(false);
1121              // Update checked item in navigation drawer and close it
1122              setSelectedTagActive();
1123              mDrawerLayout.closeDrawer(mNavigationView);
1124              updateNavigationDrawerItems();
1125  
1126              // Disable long press on notes if we&#x27;re viewing the trash
1127              if (mDrawerList.getCheckedItemPosition() == TRASH_SELECTED_ID) {
1128                  getNoteListFragment().getListView().setLongClickable(false);
1129              } else {
1130                  getNoteListFragment().getListView().setLongClickable(true);
1131              }
1132  
1133              getNoteListFragment().refreshListFromNavSelect();
1134              if (position &gt; 1) {
1135                  AnalyticsTracker.track(
1136                          AnalyticsTracker.Stat.LIST_TAG_VIEWED,
1137                          AnalyticsTracker.CATEGORY_TAG,
1138                          &quot;selected_tag_in_navigation_drawer&quot;
1139                  );
1140              }
1141          }
1142      }
1143  
1144      private class emptyTrashTask extends AsyncTask&lt;Void, Void, Void&gt; {
1145  
1146          @Override
1147          protected Void doInBackground(Void... voids) {
1148              if (mNotesBucket == null) return null;
1149  
1150              Query&lt;Note&gt; query = Note.allDeleted(mNotesBucket);
1151              Bucket.ObjectCursor c = query.execute();
1152              while (c.moveToNext()) {
1153                  c.getObject().delete();
1154              }
1155  
1156              return null;
1157          }
1158  
1159          @Override
1160          protected void onPostExecute(Void nada) {
1161              showDetailPlaceholder();
1162          }
1163      }
1164  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            