<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>526</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    526
                    <a href="525.html">prev</a>
                    <a href="527.html">next</a>
                    <a href="526_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    DTStack/flinkStreamSQL_f05e92b15d5e4c94442e53a9f83e2659c369aa5e_redis5/redis5-side/redis-async-side/src/main/java/com/dtstack/flink/sql/side/redis/RedisAsyncReqRow.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;f05e92b15d5e4c94442e53a9f83e2659c369aa5e:redis5/redis5-side/redis-async-side/src/main/java/com/dtstack/flink/sql/side/redis/RedisAsyncReqRow.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;f05e92b15d5e4c94442e53a9f83e2659c369aa5e^1:redis5/redis5-side/redis-async-side/src/main/java/com/dtstack/flink/sql/side/redis/RedisAsyncReqRow.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;f05e92b15d5e4c94442e53a9f83e2659c369aa5e^2:redis5/redis5-side/redis-async-side/src/main/java/com/dtstack/flink/sql/side/redis/RedisAsyncReqRow.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;14446f4dd844b1bb9da6c412e3556e135bafcba4:redis5/redis5-side/redis-async-side/src/main/java/com/dtstack/flink/sql/side/redis/RedisAsyncReqRow.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[b], [b], [j], [j], [s], [s], [s]], subset: [[bs], [b], [j], [j]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 /*
   2  * Licensed to the Apache Software Foundation (ASF) under one
   3  * or more contributor license agreements.  See the NOTICE file
   4  * distributed with this work for additional information
   5  * regarding copyright ownership.  The ASF licenses this file
   6  * to you under the Apache License, Version 2.0 (the
   7  * &quot;License&quot;); you may not use this file except in compliance
   8  * with the License.  You may obtain a copy of the License at
   9  *
  10  *     http://www.apache.org/licenses/LICENSE-2.0
  11  *
  12  * Unless required by applicable law or agreed to in writing, software
  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15  * See the License for the specific language governing permissions and
  16  * limitations under the License.
  17  */
  18 
  19 package com.dtstack.flink.sql.side.redis;
  20 
  21 import com.dtstack.flink.sql.side.AbstractSideTableInfo;
  22 import com.dtstack.flink.sql.side.BaseAsyncReqRow;
  23 import org.apache.flink.api.java.typeutils.RowTypeInfo;
  24 import org.apache.flink.configuration.Configuration;
  25 import org.apache.flink.streaming.api.functions.async.ResultFuture;
  26 import org.apache.flink.table.runtime.types.CRow;
  27 import org.apache.flink.types.Row;
  28 
  29 import com.dtstack.flink.sql.enums.ECacheContentType;
  30 import com.dtstack.flink.sql.side.CacheMissVal;
  31 import com.dtstack.flink.sql.side.FieldInfo;
  32 import com.dtstack.flink.sql.side.JoinInfo;
  33 import com.dtstack.flink.sql.side.cache.CacheObj;
  34 import com.dtstack.flink.sql.side.redis.enums.RedisType;
  35 import com.dtstack.flink.sql.side.redis.table.RedisSideReqRow;
  36 import com.dtstack.flink.sql.side.redis.table.RedisSideTableInfo;
  37 import io.lettuce.core.RedisClient;
  38 import io.lettuce.core.RedisFuture;
  39 import io.lettuce.core.api.StatefulRedisConnection;
  40 import io.lettuce.core.api.async.RedisHashAsyncCommands;
  41 import io.lettuce.core.api.async.RedisKeyAsyncCommands;
  42 import io.lettuce.core.cluster.RedisClusterClient;
  43 import io.lettuce.core.cluster.api.StatefulRedisClusterConnection;
  44 import org.apache.commons.collections.MapUtils;
  45 import org.apache.commons.lang.StringUtils;
  46 import com.google.common.collect.Maps;
  47 
  48 import java.util.Collections;
  49 import java.util.List;
  50 import java.util.Map;
  51 import java.util.function.Consumer;
  52 /**
  53  * @author yanxi
  54  */
  55 public class RedisAsyncReqRow extends BaseAsyncReqRow {
  56 
  57     private static final long serialVersionUID = -2079908694523987738L;
  58 
  59     private RedisClient redisClient;
  60 
  61     private StatefulRedisConnection&lt;String, String&gt; connection;
  62 
  63     private RedisClusterClient clusterClient;
  64 
  65     private StatefulRedisClusterConnection&lt;String, String&gt; clusterConnection;
  66 
  67     private RedisKeyAsyncCommands&lt;String, String&gt; async;
  68 
  69     private RedisSideTableInfo redisSideTableInfo;
  70 
  71     private RedisSideReqRow redisSideReqRow;
  72 
<abbr title="  73     public RedisAsyncReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, AbstractSideTableInfo sideTableInfo) {">  73     public RedisAsyncReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList,ðŸ”µ</abbr>
  74         super(new RedisAsyncSideInfo(rowTypeInfo, joinInfo, outFieldInfoList, sideTableInfo));
  75         redisSideReqRow = new RedisSideReqRow(super.sideInfo);
  76     }
  77 
  78     @Override
  79     public void open(Configuration parameters) throws Exception {
  80         super.open(parameters);
  81         redisSideTableInfo = (RedisSideTableInfo) sideInfo.getSideTableInfo();
  82         buildRedisClient(redisSideTableInfo);
  83     }
  84 
  85     private void buildRedisClient(RedisSideTableInfo tableInfo){
  86         String url = redisSideTableInfo.getUrl();
  87         String password = redisSideTableInfo.getPassword();
  88         if (password != null){
  89             password = password + &quot;@&quot;;
  90         } else {
  91             password = &quot;&quot;;
  92         }
  93         String database = redisSideTableInfo.getDatabase();
  94         if (database == null){
  95             database = &quot;0&quot;;
  96         }
  97         switch (RedisType.parse(tableInfo.getRedisType())){
  98             case STANDALONE:
  99                 StringBuilder redisUri = new StringBuilder();
 100                 redisUri.append(&quot;redis://&quot;).append(password).append(url).append(&quot;/&quot;).append(database);
 101                 redisClient = RedisClient.create(redisUri.toString());
 102                 connection = redisClient.connect();
 103                 async = connection.async();
 104                 break;
 105             case SENTINEL:
 106                 StringBuilder sentinelUri = new StringBuilder();
 107                 sentinelUri.append(&quot;redis-sentinel://&quot;).append(password)
<abbr title=" 108                         .append(url).append(&quot;/&quot;).append(database).append(&quot;#&quot;).append(redisSideTableInfo.getMasterName());"> 108                         .append(url).append(&quot;/&quot;).append(database).append(&quot;#&quot;).append(redisSideTableInfo.gðŸ”µ</abbr>
 109                 redisClient = RedisClient.create(sentinelUri.toString());
 110                 connection = redisClient.connect();
 111                 async = connection.async();
 112                 break;
 113             case CLUSTER:
 114                 StringBuilder clusterUri = new StringBuilder();
 115                 clusterUri.append(&quot;redis://&quot;).append(password).append(url);
 116                 clusterClient = RedisClusterClient.create(clusterUri.toString());
 117                 clusterConnection = clusterClient.connect();
 118                 async = clusterConnection.async();
 119             default:
 120                 break;
 121         }
 122     }
 123 
 124     @Override
 125     public Row fillData(Row input, Object sideInput) {
 126         return redisSideReqRow.fillData(input, sideInput);
 127     }
 128 
 129     @Override
 130 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 131     public void handleAsyncInvoke(Map&lt;String, Object&gt; inputParams, CRow input, ResultFuture&lt;CRow&gt; resultFuture) throws Exception {"> 131     public void handleAsyncInvoke(Map&lt;String, Object&gt; inputParams, CRow input, ResultFuture&lt;CRow&gt; resultFðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 132         String key = buildCacheKey(inputParams);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 133         Map&lt;String, String&gt; keyValue = Maps.newHashMap();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 134         List&lt;String&gt; value = async.keys(key + &quot;:*&quot;).get();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 135         String[] values = value.toArray(new String[value.size()]);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 136         if (values.length == 0) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 137             dealMissKey(input, resultFuture);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 138         } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 139             RedisFuture&lt;List&lt;KeyValue&lt;String, String&gt;&gt;&gt; future = ((RedisStringAsyncCommands) async).mget(values);"> 139             RedisFuture&lt;List&lt;KeyValue&lt;String, String&gt;&gt;&gt; future = ((RedisStringAsyncCommands) async).mget(ðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 140             future.thenAccept(new Consumer&lt;List&lt;KeyValue&lt;String, String&gt;&gt;&gt;() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 141                 @Override</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 142                 public void accept(List&lt;KeyValue&lt;String, String&gt;&gt; keyValues) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 143                     if (keyValues.size() != 0) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 144                         for (int i = 0; i &lt; keyValues.size(); i++) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 145                             String[] splitKeys = StringUtils.split(keyValues.get(i).getKey(), &quot;:&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 146                             keyValue.put(splitKeys[1], splitKeys[2]);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 147                             keyValue.put(splitKeys[3], keyValues.get(i).getValue());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 148                         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 149                         try {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 150                             Row row = fillData(input.row(), keyValue);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 151                             dealCacheData(key, CacheObj.buildCacheObj(ECacheContentType.MultiLine, keyValue));"> 151                             dealCacheData(key, CacheObj.buildCacheObj(ECacheContentType.MultiLine, keyValðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 152                             resultFuture.complete(Collections.singleton(new CRow(row, input.change())));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 153                         } catch (Exception e) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 154                             dealFillDataError(resultFuture, e, input);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 155                         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 156                     } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 157                         dealMissKey(input, resultFuture);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 158                         dealCacheData(key, CacheMissVal.getMissKeyObj());</span>
 159 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 160     public void asyncInvoke(CRow input, ResultFuture&lt;CRow&gt; resultFuture) throws Exception {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 161         CRow inputCopy = new CRow(input.row(),input.change());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 162         List&lt;String&gt; keyData = Lists.newLinkedList();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 163         for (int i = 0; i &lt; sideInfo.getEqualValIndex().size(); i++) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 164             Integer conValIndex = sideInfo.getEqualValIndex().get(i);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 165             Object equalObj = inputCopy.row().getField(conValIndex);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 166             if(equalObj == null){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 167                 dealMissKey(inputCopy, resultFuture);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 168                 return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 169             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 170             String value = equalObj.toString();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 171             keyData.add(sideInfo.getEqualFieldList().get(i));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 172             keyData.add(value);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 173         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 174 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 175         String key = buildCacheKey(keyData);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 176 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 177         if(openCache()){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 178             CacheObj val = getFromCache(key);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 179             if(val != null){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 180                 if(ECacheContentType.MissVal == val.getType()){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 181                     dealMissKey(inputCopy, resultFuture);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 182                     return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 183                 }else if(ECacheContentType.MultiLine == val.getType()){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 184                     try {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 185                         Row row = fillData(inputCopy.row(), val.getContent());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 186                         resultFuture.complete(Collections.singleton(new CRow(row, input.change())));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 187                     } catch (Exception e) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 188                         dealFillDataError(resultFuture, e, inputCopy);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 189                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 190                 }else{</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 191                     RuntimeException exception = new RuntimeException(&quot;not support cache obj type &quot; + val.getType());"> 191                     RuntimeException exception = new RuntimeException(&quot;not support cache obj type &quot; + valðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 192                     resultFuture.completeExceptionally(exception);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 193                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 194                 return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 195             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 196         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 197 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 198         Map&lt;String, String&gt; keyValue = Maps.newHashMap();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 199         List&lt;String&gt; value = async.keys(key + &quot;:*&quot;).get();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 200         String[] values = value.toArray(new String[value.size()]);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 201         if (values.length == 0) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 202             dealMissKey(inputCopy, resultFuture);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 203         } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 204             RedisFuture&lt;List&lt;KeyValue&lt;String, String&gt;&gt;&gt; future = ((RedisStringAsyncCommands) async).mget(values);"> 204             RedisFuture&lt;List&lt;KeyValue&lt;String, String&gt;&gt;&gt; future = ((RedisStringAsyncCommands) async).mget(ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 205             future.thenAccept(new Consumer&lt;List&lt;KeyValue&lt;String, String&gt;&gt;&gt;() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 206                 @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 207                 public void accept(List&lt;KeyValue&lt;String, String&gt;&gt; keyValues) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 208                     if (keyValues.size() != 0) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 209                         for (int i = 0; i &lt; keyValues.size(); i++) {</span>
 210 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 211     public void asyncInvoke(CRow input, ResultFuture&lt;CRow&gt; resultFuture) throws Exception {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 212         CRow inputCopy = new CRow(input.row(), input.change());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 213         Map&lt;String, Object&gt; refData = Maps.newHashMap();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 214         for (int i = 0; i &lt; sideInfo.getEqualValIndex().size(); i++) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 215             Integer conValIndex = sideInfo.getEqualValIndex().get(i);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 216             Object equalObj = input.row().getField(conValIndex);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 217             if(equalObj == null){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 218                 dealMissKey(inputCopy, resultFuture);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 219                 return;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 220             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 221             refData.put(sideInfo.getEqualFieldList().get(i), equalObj);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 222         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 223 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 224         String key = buildCacheKey(refData);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 225         if(StringUtils.isBlank(key)){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 226             return;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 227         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 228         if(openCache()){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 229             CacheObj val = getFromCache(key);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 230             if(val != null){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 231                 if(ECacheContentType.MissVal == val.getType()){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 232                     dealMissKey(inputCopy, resultFuture);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 233                     return;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 234                 }else if(ECacheContentType.MultiLine == val.getType()){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 235                     try {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 236                         Row row = fillData(input.row(), val.getContent());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 237                         resultFuture.complete(Collections.singleton(new CRow(row, inputCopy.change())));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 238                     } catch (Exception e) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 239                         dealFillDataError(resultFuture, e, inputCopy);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 240                     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 241                 }else{</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 242                     RuntimeException exception = new RuntimeException(&quot;not support cache obj type &quot; + val.getType());"> 242                     RuntimeException exception = new RuntimeException(&quot;not support cache obj type &quot; + valðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 243                     resultFuture.completeExceptionally(exception);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 244                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 245                 return;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 246             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 247         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 248 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 249         RedisFuture&lt;Map&lt;String, String&gt;&gt; future = ((RedisHashAsyncCommands) async).hgetall(key);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 250         future.thenAccept(new Consumer&lt;Map&lt;String, String&gt;&gt;() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 251             @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 252             public void accept(Map&lt;String, String&gt; values) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 253                 if (MapUtils.isNotEmpty(values)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 254                     try {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 255                         Row row = fillData(input.row(), values);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 256                         dealCacheData(key,CacheObj.buildCacheObj(ECacheContentType.MultiLine, values));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 257                         resultFuture.complete(Collections.singleton(new CRow(row, inputCopy.change())));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 258                     } catch (Exception e) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 259                         dealFillDataError(resultFuture, e, inputCopy);</span>
 260 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 261                     }
 262                 } else {
 263                     dealMissKey(inputCopy, resultFuture);
 264                     dealCacheData(key,CacheMissVal.getMissKeyObj());
 265                 }
 266             }
 267         });
 268     }
 269 
 270 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 271     @Override</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 272     public String buildCacheKey(Map&lt;String, Object&gt; inputParams) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 273         String kv = StringUtils.join(inputParams.values(), &quot;:&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 274         String tableName = redisSideTableInfo.getTableName();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 275         StringBuilder preKey =  new StringBuilder();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 276         preKey.append(tableName).append(&quot;:&quot;).append(kv);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 277         return preKey.toString();</span>
 278 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 279                 return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 280             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 281         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 282 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 283         Map&lt;String, String&gt; keyValue = Maps.newHashMap();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 284         List&lt;String&gt; value = async.keys(key + &quot;:*&quot;).get();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 285         String[] values = value.toArray(new String[value.size()]);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 286         if (values.length == 0) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 287             dealMissKey(inputCopy, resultFuture);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 288         } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 289             RedisFuture&lt;List&lt;KeyValue&lt;String, String&gt;&gt;&gt; future = ((RedisStringAsyncCommands) async).mget(values);"> 289             RedisFuture&lt;List&lt;KeyValue&lt;String, String&gt;&gt;&gt; future = ((RedisStringAsyncCommands) async).mget(ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 290             future.thenAccept(new Consumer&lt;List&lt;KeyValue&lt;String, String&gt;&gt;&gt;() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 291                 @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 292                 public void accept(List&lt;KeyValue&lt;String, String&gt;&gt; keyValues) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 293                     if (keyValues.size() != 0) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 294                         for (int i = 0; i &lt; keyValues.size(); i++) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 295                             String[] splitKeys = StringUtils.split(keyValues.get(i).getKey(), &quot;:&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 296                             keyValue.put(splitKeys[1], splitKeys[2]);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 297                             keyValue.put(splitKeys[3], keyValues.get(i).getValue());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 298                         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 299                         try {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 300                             Row row = fillData(inputCopy.row(), keyValue);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 301                             dealCacheData(key, CacheObj.buildCacheObj(ECacheContentType.MultiLine, keyValue));"> 301                             dealCacheData(key, CacheObj.buildCacheObj(ECacheContentType.MultiLine, keyValðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 302                             resultFuture.complete(Collections.singleton(new CRow(row, inputCopy.change())));"> 302                             resultFuture.complete(Collections.singleton(new CRow(row, inputCopy.change())ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 303                         } catch (Exception e) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 304                             dealFillDataError(resultFuture, e, inputCopy);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 305                         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 306                     } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 307                         dealMissKey(inputCopy, resultFuture);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 308                         dealCacheData(key, CacheMissVal.getMissKeyObj());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 309                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 310                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 311             });</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 312         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 313     }</span>
 314 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 315     private String buildCacheKey(Map&lt;String, Object&gt; refData) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 316         StringBuilder keyBuilder = new StringBuilder(redisSideTableInfo.getTableName());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 317         List&lt;String&gt; primaryKeys = redisSideTableInfo.getPrimaryKeys();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 318         for(String primaryKey : primaryKeys){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 319             if(!refData.containsKey(primaryKey)){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 320                 return null;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 321             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 322             keyBuilder.append(&quot;_&quot;).append(refData.get(primaryKey));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 323         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 324         return keyBuilder.toString();</span>
 325 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 326     }
 327 
 328     @Override
 329     public void close() throws Exception {
 330         super.close();
 331         if (connection != null){
 332             connection.close();
 333         }
 334         if (redisClient != null){
 335             redisClient.shutdown();
 336         }
 337         if (clusterConnection != null){
 338             clusterConnection.close();
 339         }
 340         if (clusterClient != null){
 341             clusterClient.shutdown();
 342         }
 343     }
 344 
 345 }</pre></td>
                            <td><pre>   1 /*
   2  * Licensed to the Apache Software Foundation (ASF) under one
   3  * or more contributor license agreements.  See the NOTICE file
   4  * distributed with this work for additional information
   5  * regarding copyright ownership.  The ASF licenses this file
   6  * to you under the Apache License, Version 2.0 (the
   7  * &quot;License&quot;); you may not use this file except in compliance
   8  * with the License.  You may obtain a copy of the License at
   9  *
  10  *     http://www.apache.org/licenses/LICENSE-2.0
  11  *
  12  * Unless required by applicable law or agreed to in writing, software
  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15  * See the License for the specific language governing permissions and
  16  * limitations under the License.
  17  */
  18 
  19 package com.dtstack.flink.sql.side.redis;
  20 
  21 import com.dtstack.flink.sql.side.AbstractSideTableInfo;
  22 import com.dtstack.flink.sql.side.BaseAsyncReqRow;
  23 import org.apache.flink.api.java.typeutils.RowTypeInfo;
  24 import org.apache.flink.configuration.Configuration;
  25 import org.apache.flink.streaming.api.functions.async.ResultFuture;
  26 import org.apache.flink.table.runtime.types.CRow;
  27 import org.apache.flink.types.Row;
  28 
  29 import com.dtstack.flink.sql.enums.ECacheContentType;
  30 import com.dtstack.flink.sql.side.CacheMissVal;
  31 import com.dtstack.flink.sql.side.FieldInfo;
  32 import com.dtstack.flink.sql.side.JoinInfo;
  33 import com.dtstack.flink.sql.side.cache.CacheObj;
  34 import com.dtstack.flink.sql.side.redis.enums.RedisType;
  35 import com.dtstack.flink.sql.side.redis.table.RedisSideReqRow;
  36 import com.dtstack.flink.sql.side.redis.table.RedisSideTableInfo;
  37 import io.lettuce.core.RedisClient;
  38 import io.lettuce.core.RedisFuture;
  39 import io.lettuce.core.api.StatefulRedisConnection;
  40 import io.lettuce.core.api.async.RedisHashAsyncCommands;
  41 import io.lettuce.core.api.async.RedisKeyAsyncCommands;
  42 import io.lettuce.core.cluster.RedisClusterClient;
  43 import io.lettuce.core.cluster.api.StatefulRedisClusterConnection;
  44 import org.apache.commons.collections.MapUtils;
  45 import org.apache.commons.lang.StringUtils;
  46 import com.google.common.collect.Maps;
  47 
  48 import java.util.Collections;
  49 import java.util.List;
  50 import java.util.Map;
  51 import java.util.function.Consumer;
  52 /**
  53  * @author yanxi
  54  */
  55 public class RedisAsyncReqRow extends BaseAsyncReqRow {
  56 
  57     private static final long serialVersionUID = -2079908694523987738L;
  58 
  59     private RedisClient redisClient;
  60 
  61     private StatefulRedisConnection&lt;String, String&gt; connection;
  62 
  63     private RedisClusterClient clusterClient;
  64 
  65     private StatefulRedisClusterConnection&lt;String, String&gt; clusterConnection;
  66 
  67     private RedisKeyAsyncCommands&lt;String, String&gt; async;
  68 
  69     private RedisSideTableInfo redisSideTableInfo;
  70 
  71     private RedisSideReqRow redisSideReqRow;
  72 
<abbr title="  73     public RedisAsyncReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, AbstractSideTableInfo sideTableInfo) {">  73     public RedisAsyncReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList,ðŸ”µ</abbr>
  74         super(new RedisAsyncSideInfo(rowTypeInfo, joinInfo, outFieldInfoList, sideTableInfo));
  75         redisSideReqRow = new RedisSideReqRow(super.sideInfo);
  76     }
  77 
  78     @Override
  79     public void open(Configuration parameters) throws Exception {
  80         super.open(parameters);
  81         redisSideTableInfo = (RedisSideTableInfo) sideInfo.getSideTableInfo();
  82         buildRedisClient(redisSideTableInfo);
  83     }
  84 
  85     private void buildRedisClient(RedisSideTableInfo tableInfo){
  86         String url = redisSideTableInfo.getUrl();
  87         String password = redisSideTableInfo.getPassword();
  88         if (password != null){
  89             password = password + &quot;@&quot;;
  90         } else {
  91             password = &quot;&quot;;
  92         }
  93         String database = redisSideTableInfo.getDatabase();
  94         if (database == null){
  95             database = &quot;0&quot;;
  96         }
  97         switch (RedisType.parse(tableInfo.getRedisType())){
  98             case STANDALONE:
  99                 StringBuilder redisUri = new StringBuilder();
 100                 redisUri.append(&quot;redis://&quot;).append(password).append(url).append(&quot;/&quot;).append(database);
 101                 redisClient = RedisClient.create(redisUri.toString());
 102                 connection = redisClient.connect();
 103                 async = connection.async();
 104                 break;
 105             case SENTINEL:
 106                 StringBuilder sentinelUri = new StringBuilder();
 107                 sentinelUri.append(&quot;redis-sentinel://&quot;).append(password)
<abbr title=" 108                         .append(url).append(&quot;/&quot;).append(database).append(&quot;#&quot;).append(redisSideTableInfo.getMasterName());"> 108                         .append(url).append(&quot;/&quot;).append(database).append(&quot;#&quot;).append(redisSideTableInfo.gðŸ”µ</abbr>
 109                 redisClient = RedisClient.create(sentinelUri.toString());
 110                 connection = redisClient.connect();
 111                 async = connection.async();
 112                 break;
 113             case CLUSTER:
 114                 StringBuilder clusterUri = new StringBuilder();
 115                 clusterUri.append(&quot;redis://&quot;).append(password).append(url);
 116                 clusterClient = RedisClusterClient.create(clusterUri.toString());
 117                 clusterConnection = clusterClient.connect();
 118                 async = clusterConnection.async();
 119             default:
 120                 break;
 121         }
 122     }
 123 
 124     @Override
 125     public Row fillData(Row input, Object sideInput) {
 126         return redisSideReqRow.fillData(input, sideInput);
 127     }
 128 
 129     @Override
<abbr title=" 130     public void handleAsyncInvoke(Map&lt;String, Object&gt; inputParams, CRow input, ResultFuture&lt;CRow&gt; resultFuture) throws Exception {"> 130     public void handleAsyncInvoke(Map&lt;String, Object&gt; inputParams, CRow input, ResultFuture&lt;CRow&gt; resultFðŸ”µ</abbr>
 131         String key = buildCacheKey(inputParams);
 132         Map&lt;String, String&gt; keyValue = Maps.newHashMap();
 133         List&lt;String&gt; value = async.keys(key + &quot;:*&quot;).get();
 134         String[] values = value.toArray(new String[value.size()]);
 135         if (values.length == 0) {
 136             dealMissKey(input, resultFuture);
 137         } else {
<abbr title=" 138             RedisFuture&lt;List&lt;KeyValue&lt;String, String&gt;&gt;&gt; future = ((RedisStringAsyncCommands) async).mget(values);"> 138             RedisFuture&lt;List&lt;KeyValue&lt;String, String&gt;&gt;&gt; future = ((RedisStringAsyncCommands) async).mget(ðŸ”µ</abbr>
 139             future.thenAccept(new Consumer&lt;List&lt;KeyValue&lt;String, String&gt;&gt;&gt;() {
 140                 @Override
 141                 public void accept(List&lt;KeyValue&lt;String, String&gt;&gt; keyValues) {
 142                     if (keyValues.size() != 0) {
 143                         for (int i = 0; i &lt; keyValues.size(); i++) {
 144                             String[] splitKeys = StringUtils.split(keyValues.get(i).getKey(), &quot;:&quot;);
 145                             keyValue.put(splitKeys[1], splitKeys[2]);
 146                             keyValue.put(splitKeys[3], keyValues.get(i).getValue());
 147                         }
 148                         try {
 149                             Row row = fillData(input.row(), keyValue);
<abbr title=" 150                             dealCacheData(key, CacheObj.buildCacheObj(ECacheContentType.MultiLine, keyValue));"> 150                             dealCacheData(key, CacheObj.buildCacheObj(ECacheContentType.MultiLine, keyValðŸ”µ</abbr>
 151                             resultFuture.complete(Collections.singleton(new CRow(row, input.change())));
 152                         } catch (Exception e) {
 153                             dealFillDataError(resultFuture, e, input);
 154                         }
 155                     } else {
 156                         dealMissKey(input, resultFuture);
 157                         dealCacheData(key, CacheMissVal.getMissKeyObj());
 158                     }
 159                 }
 160             });
 161         }
 162     }
 163 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
 164 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 165 @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 166     public void asyncInvoke(CRow input, ResultFuture&lt;CRow&gt; resultFuture) throws Exception {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 167         CRow inputCopy = new CRow(input.row(),input.change());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 168         List&lt;String&gt; keyData = Lists.newLinkedList();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 169         for (int i = 0; i &lt; sideInfo.getEqualValIndex().size(); i++) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 170             Integer conValIndex = sideInfo.getEqualValIndex().get(i);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 171             Object equalObj = inputCopy.row().getField(conValIndex);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 172             if(equalObj == null){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 173                 dealMissKey(inputCopy, resultFuture);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 174                 return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 175             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 176             String value = equalObj.toString();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 177             keyData.add(sideInfo.getEqualFieldList().get(i));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 178             keyData.add(value);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 179         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 180 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 181         String key = buildCacheKey(keyData);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 182 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 183         if(openCache()){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 184             CacheObj val = getFromCache(key);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 185             if(val != null){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 186                 if(ECacheContentType.MissVal == val.getType()){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 187                     dealMissKey(inputCopy, resultFuture);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 188                     return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 189                 }else if(ECacheContentType.MultiLine == val.getType()){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 190                     try {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 191                         Row row = fillData(inputCopy.row(), val.getContent());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 192                         resultFuture.complete(Collections.singleton(new CRow(row, input.change())));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 193                     } catch (Exception e) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 194                         dealFillDataError(resultFuture, e, inputCopy);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 195                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 196                 }else{</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 197                     RuntimeException exception = new RuntimeException(&quot;not support cache obj type &quot; + val.getType());"> 197                     RuntimeException exception = new RuntimeException(&quot;not support cache obj type &quot; + valðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 198                     resultFuture.completeExceptionally(exception);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 199                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 200                 return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 201             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 202         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 203 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 204         Map&lt;String, String&gt; keyValue = Maps.newHashMap();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 205         List&lt;String&gt; value = async.keys(key + &quot;:*&quot;).get();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 206         String[] values = value.toArray(new String[value.size()]);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 207         if (values.length == 0) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 208             dealMissKey(inputCopy, resultFuture);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 209         } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 210             RedisFuture&lt;List&lt;KeyValue&lt;String, String&gt;&gt;&gt; future = ((RedisStringAsyncCommands) async).mget(values);"> 210             RedisFuture&lt;List&lt;KeyValue&lt;String, String&gt;&gt;&gt; future = ((RedisStringAsyncCommands) async).mget(ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 211             future.thenAccept(new Consumer&lt;List&lt;KeyValue&lt;String, String&gt;&gt;&gt;() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 212                 @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 213                 public void accept(List&lt;KeyValue&lt;String, String&gt;&gt; keyValues) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 214                     if (keyValues.size() != 0) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 215                         for (int i = 0; i &lt; keyValues.size(); i++) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 216                             String[] splitKeys = StringUtils.split(keyValues.get(i).getKey(), &quot;:&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 217                             keyValue.put(splitKeys[1], splitKeys[2]);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 218                             keyValue.put(splitKeys[3], keyValues.get(i).getValue());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 219                         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 220                         try {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 221                             Row row = fillData(inputCopy.row(), keyValue);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 222                             dealCacheData(key, CacheObj.buildCacheObj(ECacheContentType.MultiLine, keyValue));"> 222                             dealCacheData(key, CacheObj.buildCacheObj(ECacheContentType.MultiLine, keyValðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 223                             resultFuture.complete(Collections.singleton(new CRow(row, inputCopy.change())));"> 223                             resultFuture.complete(Collections.singleton(new CRow(row, inputCopy.change())ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 224                         } catch (Exception e) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 225                             dealFillDataError(resultFuture, e, inputCopy);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 226                         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 227                     } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 228                         dealMissKey(inputCopy, resultFuture);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 229                         dealCacheData(key, CacheMissVal.getMissKeyObj());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 230                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 231                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 232             });</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 233         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 234     }</span>
 235 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 236 @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 237     public void asyncInvoke(CRow input, ResultFuture&lt;CRow&gt; resultFuture) throws Exception {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 238         CRow inputCopy = new CRow(input.row(), input.change());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 239         Map&lt;String, Object&gt; refData = Maps.newHashMap();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 240         for (int i = 0; i &lt; sideInfo.getEqualValIndex().size(); i++) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 241             Integer conValIndex = sideInfo.getEqualValIndex().get(i);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 242             Object equalObj = input.row().getField(conValIndex);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 243             if(equalObj == null){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 244                 dealMissKey(inputCopy, resultFuture);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 245                 return;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 246             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 247             refData.put(sideInfo.getEqualFieldList().get(i), equalObj);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 248         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 249 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 250         String key = buildCacheKey(refData);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 251         if(StringUtils.isBlank(key)){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 252             return;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 253         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 254         if(openCache()){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 255             CacheObj val = getFromCache(key);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 256             if(val != null){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 257                 if(ECacheContentType.MissVal == val.getType()){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 258                     dealMissKey(inputCopy, resultFuture);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 259                     return;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 260                 }else if(ECacheContentType.MultiLine == val.getType()){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 261                     try {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 262                         Row row = fillData(input.row(), val.getContent());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 263                         resultFuture.complete(Collections.singleton(new CRow(row, inputCopy.change())));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 264                     } catch (Exception e) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 265                         dealFillDataError(resultFuture, e, inputCopy);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 266                     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 267                 }else{</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 268                     RuntimeException exception = new RuntimeException(&quot;not support cache obj type &quot; + val.getType());"> 268                     RuntimeException exception = new RuntimeException(&quot;not support cache obj type &quot; + valðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 269                     resultFuture.completeExceptionally(exception);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 270                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 271                 return;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 272             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 273         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 274 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 275         RedisFuture&lt;Map&lt;String, String&gt;&gt; future = ((RedisHashAsyncCommands) async).hgetall(key);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 276         future.thenAccept(new Consumer&lt;Map&lt;String, String&gt;&gt;() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 277             @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 278             public void accept(Map&lt;String, String&gt; values) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 279                 if (MapUtils.isNotEmpty(values)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 280                     try {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 281                         Row row = fillData(input.row(), values);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 282                         dealCacheData(key,CacheObj.buildCacheObj(ECacheContentType.MultiLine, values));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 283                         resultFuture.complete(Collections.singleton(new CRow(row, inputCopy.change())));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 284                     } catch (Exception e) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 285                         dealFillDataError(resultFuture, e, inputCopy);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 286                     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 287                 } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 288                     dealMissKey(inputCopy, resultFuture);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 289                     dealCacheData(key,CacheMissVal.getMissKeyObj());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 290                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 291             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 292         });</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 293     }</span>
 294 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 295 
 296 
 297 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 298     @Override</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 299     public String buildCacheKey(Map&lt;String, Object&gt; inputParams) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 300         String kv = StringUtils.join(inputParams.values(), &quot;:&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 301         String tableName = redisSideTableInfo.getTableName();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 302         StringBuilder preKey =  new StringBuilder();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 303         preKey.append(tableName).append(&quot;:&quot;).append(kv);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 304         return preKey.toString();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 305     }</span>
 306 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 307     private String buildCacheKey(List&lt;String&gt; keyData) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 308         String kv = String.join(&quot;:&quot;, keyData);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 309         String tableName = redisSideTableInfo.getTableName();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 310         StringBuilder preKey =  new StringBuilder();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 311         preKey.append(tableName).append(&quot;:&quot;).append(kv);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 312         return preKey.toString();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 313     }</span>
 314 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 315 </span>
 316 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 317 
 318     @Override
 319     public void close() throws Exception {
 320         super.close();
 321         if (connection != null){
 322             connection.close();
 323         }
 324         if (redisClient != null){
 325             redisClient.shutdown();
 326         }
 327         if (clusterConnection != null){
 328             clusterConnection.close();
 329         }
 330         if (clusterClient != null){
 331             clusterClient.shutdown();
 332         }
 333     }
 334 
 335 }
 
 
 
 
 
 
 
 
 </pre></td>
                            <td><pre>   1 /*
   2  * Licensed to the Apache Software Foundation (ASF) under one
   3  * or more contributor license agreements.  See the NOTICE file
   4  * distributed with this work for additional information
   5  * regarding copyright ownership.  The ASF licenses this file
   6  * to you under the Apache License, Version 2.0 (the
   7  * &quot;License&quot;); you may not use this file except in compliance
   8  * with the License.  You may obtain a copy of the License at
   9  *
  10  *     http://www.apache.org/licenses/LICENSE-2.0
  11  *
  12  * Unless required by applicable law or agreed to in writing, software
  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15  * See the License for the specific language governing permissions and
  16  * limitations under the License.
  17  */
  18 package com.dtstack.flink.sql.side.redis;
  19 
  20 import com.dtstack.flink.sql.enums.ECacheContentType;
  21 import com.dtstack.flink.sql.side.AbstractSideTableInfo;
  22 import com.dtstack.flink.sql.side.BaseAsyncReqRow;
  23 import com.dtstack.flink.sql.side.CacheMissVal;
  24 import com.dtstack.flink.sql.side.FieldInfo;
  25 import com.dtstack.flink.sql.side.JoinInfo;
  26 import com.dtstack.flink.sql.side.cache.CacheObj;
  27 import com.dtstack.flink.sql.side.redis.enums.RedisType;
  28 import com.dtstack.flink.sql.side.redis.table.RedisSideReqRow;
  29 import com.dtstack.flink.sql.side.redis.table.RedisSideTableInfo;
  30 import com.google.common.collect.Maps;
  31 import io.lettuce.core.RedisClient;
  32 import io.lettuce.core.RedisFuture;
  33 import io.lettuce.core.api.StatefulRedisConnection;
  34 import io.lettuce.core.api.async.RedisHashAsyncCommands;
  35 import io.lettuce.core.api.async.RedisKeyAsyncCommands;
  36 import io.lettuce.core.cluster.RedisClusterClient;
  37 import io.lettuce.core.cluster.api.StatefulRedisClusterConnection;
  38 import java.util.Collections;
  39 import java.util.List;
  40 import java.util.Map;
  41 import java.util.function.Consumer;
  42 import org.apache.commons.collections.MapUtils;
  43 import org.apache.commons.lang.StringUtils;
  44 import org.apache.flink.api.java.typeutils.RowTypeInfo;
  45 import org.apache.flink.configuration.Configuration;
  46 import org.apache.flink.streaming.api.functions.async.ResultFuture;
  47 import org.apache.flink.table.runtime.types.CRow;
  48 import org.apache.flink.types.Row;
  49 
  50 
  51 /**
  52  * @author yanxi
  53  */
  54 public class RedisAsyncReqRow extends BaseAsyncReqRow {
  55     private static final long serialVersionUID = -2079908694523987738L;
  56 
  57     private RedisClient redisClient;
  58 
  59     private StatefulRedisConnection&lt;String, String&gt; connection;
  60 
  61     private RedisClusterClient clusterClient;
  62 
  63     private StatefulRedisClusterConnection&lt;String, String&gt; clusterConnection;
  64 
  65     private RedisKeyAsyncCommands&lt;String, String&gt; async;
  66 
  67     private RedisSideTableInfo redisSideTableInfo;
  68 
  69     private RedisSideReqRow redisSideReqRow;
  70 
<abbr title="  71     public RedisAsyncReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, AbstractSideTableInfo sideTableInfo) {">  71     public RedisAsyncReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList,ðŸ”µ</abbr>
  72         super(new RedisAsyncSideInfo(rowTypeInfo, joinInfo, outFieldInfoList, sideTableInfo));
  73         redisSideReqRow = new RedisSideReqRow(super.sideInfo);
  74     }
  75 
  76     @Override
  77     public void open(Configuration parameters) throws Exception {
  78         super.open(parameters);
  79         redisSideTableInfo = (RedisSideTableInfo) sideInfo.getSideTableInfo();
  80         buildRedisClient(redisSideTableInfo);
  81     }
  82 
  83     private void buildRedisClient(RedisSideTableInfo tableInfo) {
  84         String url = redisSideTableInfo.getUrl();
  85         String password = redisSideTableInfo.getPassword();
  86         if (password != null) {
  87             password = password + &quot;@&quot;;
  88         } else {
  89             password = &quot;&quot;;
  90         }
  91         String database = redisSideTableInfo.getDatabase();
  92         if (database == null) {
  93             database = &quot;0&quot;;
  94         }
  95         switch (RedisType.parse(tableInfo.getRedisType())) {
  96             case STANDALONE :
  97                 StringBuilder redisUri = new StringBuilder();
  98                 redisUri.append(&quot;redis://&quot;).append(password).append(url).append(&quot;/&quot;).append(database);
  99                 redisClient = RedisClient.create(redisUri.toString());
 100                 connection = redisClient.connect();
 101                 async = connection.async();
 102                 break;
 103             case SENTINEL :
 104                 StringBuilder sentinelUri = new StringBuilder();
<abbr title=" 105                 sentinelUri.append(&quot;redis-sentinel://&quot;).append(password).append(url).append(&quot;/&quot;).append(database).append(&quot;#&quot;).append(redisSideTableInfo.getMasterName());"> 105                 sentinelUri.append(&quot;redis-sentinel://&quot;).append(password).append(url).append(&quot;/&quot;).append(dðŸ”µ</abbr>
 106                 redisClient = RedisClient.create(sentinelUri.toString());
 107                 connection = redisClient.connect();
 108                 async = connection.async();
 109                 break;
 110             case CLUSTER :
 111                 StringBuilder clusterUri = new StringBuilder();
 112                 clusterUri.append(&quot;redis://&quot;).append(password).append(url);
 113                 clusterClient = RedisClusterClient.create(clusterUri.toString());
 114                 clusterConnection = clusterClient.connect();
 115                 async = clusterConnection.async();
 116             default :
 117                 break;
 118         }
 119     }
 120 
 121     @Override
 122     public Row fillData(Row input, Object sideInput) {
 123         return redisSideReqRow.fillData(input, sideInput);
 124     }
 125 
 126     @Override
<abbr title=" 127     public void handleAsyncInvoke(Map&lt;String, Object&gt; inputParams, CRow input, ResultFuture&lt;CRow&gt; resultFuture) throws Exception {"> 127     public void handleAsyncInvoke(Map&lt;String, Object&gt; inputParams, CRow input, ResultFuture&lt;CRow&gt; resultFðŸ”µ</abbr>
 128 
 129 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 130         String key = buildCacheKey(inputParams);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 131         Map&lt;String, String&gt; keyValue = Maps.newHashMap();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 132         List&lt;String&gt; value = async.keys(key + &quot;:*&quot;).get();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 133         String[] values = value.toArray(new String[value.size()]);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 134         if (values.length == 0) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 135             dealMissKey(input, resultFuture);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 136         } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 137             RedisFuture&lt;List&lt;KeyValue&lt;String, String&gt;&gt;&gt; future = ((RedisStringAsyncCommands) async).mget(values);"> 137             RedisFuture&lt;List&lt;KeyValue&lt;String, String&gt;&gt;&gt; future = ((RedisStringAsyncCommands) async).mget(ðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 138             future.thenAccept(new Consumer&lt;List&lt;KeyValue&lt;String, String&gt;&gt;&gt;() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 139                 @Override</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 140                 public void accept(List&lt;KeyValue&lt;String, String&gt;&gt; keyValues) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 141                     if (keyValues.size() != 0) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 142                         for (int i = 0; i &lt; keyValues.size(); i++) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 143                             String[] splitKeys = StringUtils.split(keyValues.get(i).getKey(), &quot;:&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 144                             keyValue.put(splitKeys[1], splitKeys[2]);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 145                             keyValue.put(splitKeys[3], keyValues.get(i).getValue());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 146                         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 147                         try {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 148                             Row row = fillData(input.row(), keyValue);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 149                             dealCacheData(key, CacheObj.buildCacheObj(ECacheContentType.MultiLine, keyValue));"> 149                             dealCacheData(key, CacheObj.buildCacheObj(ECacheContentType.MultiLine, keyValðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 150                             resultFuture.complete(Collections.singleton(new CRow(row, input.change())));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 151                         } catch (Exception e) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 152                             dealFillDataError(resultFuture, e, input);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 153                         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 154                     } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 155                         dealMissKey(input, resultFuture);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 156                         dealCacheData(key, CacheMissVal.getMissKeyObj());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 157 </span>
 158 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 159 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 159 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwðŸ”µ</abbr></span>
 160 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 161 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 162         CRow inputCopy = new CRow(input.row(), input.change());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 163         Map&lt;String, Object&gt; refData = Maps.newHashMap();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 164         for (int i = 0; i &lt; sideInfo.getEqualValIndex().size(); i++) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 165             Integer conValIndex = sideInfo.getEqualValIndex().get(i);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 166             Object equalObj = input.row().getField(conValIndex);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 167             if(equalObj == null){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 168                 dealMissKey(inputCopy, resultFuture);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 169                 return;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 170             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 171             refData.put(sideInfo.getEqualFieldList().get(i), equalObj);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 172         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 173 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 174         String key = buildCacheKey(refData);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 175         if(StringUtils.isBlank(key)){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 176             return;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 177         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 178         if(openCache()){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 179             CacheObj val = getFromCache(key);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 180             if(val != null){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 181                 if(ECacheContentType.MissVal == val.getType()){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 182                     dealMissKey(inputCopy, resultFuture);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 183                     return;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 184                 }else if(ECacheContentType.MultiLine == val.getType()){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 185                     try {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 186                         Row row = fillData(input.row(), val.getContent());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 187                         resultFuture.complete(Collections.singleton(new CRow(row, inputCopy.change())));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 188                     } catch (Exception e) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 189                         dealFillDataError(resultFuture, e, inputCopy);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 190                     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 191                 }else{</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 192                     RuntimeException exception = new RuntimeException(&quot;not support cache obj type &quot; + val.getType());"> 192                     RuntimeException exception = new RuntimeException(&quot;not support cache obj type &quot; + valðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 193                     resultFuture.completeExceptionally(exception);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 194                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 195                 return;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 196             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 197         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 198 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 199         RedisFuture&lt;Map&lt;String, String&gt;&gt; future = ((RedisHashAsyncCommands) async).hgetall(key);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 200         future.thenAccept(new Consumer&lt;Map&lt;String, String&gt;&gt;() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 201             @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 202             public void accept(Map&lt;String, String&gt; values) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 203                 if (MapUtils.isNotEmpty(values)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 204                     try {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 205                         Row row = fillData(input.row(), values);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 206                         dealCacheData(key,CacheObj.buildCacheObj(ECacheContentType.MultiLine, values));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 207                         resultFuture.complete(Collections.singleton(new CRow(row, inputCopy.change())));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 208                     } catch (Exception e) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 209                         dealFillDataError(resultFuture, e, inputCopy);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 210 </span>
 211 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 212                     }
 213                 } else {
 214                     dealMissKey(inputCopy, resultFuture);
 215                     dealCacheData(key,CacheMissVal.getMissKeyObj());
 216                 }
 217             }
 218         });
 219     }
 220 
 221     @Override
 222     public String buildCacheKey(Map&lt;String,
 223 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 224 Object</span>
 225 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 226 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 226 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwðŸ”µ</abbr></span>
 227 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 228 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 229 Object</span>
 230 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 231     &gt;
 232 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 233 inputParams</span>
 234 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 235 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 235 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwðŸ”µ</abbr></span>
 236 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 237 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 238 refData</span>
 239 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 240     ) {
 241         StringBuilder keyBuilder = new StringBuilder(redisSideTableInfo.getTableName());
 242         List&lt;String&gt; primaryKeys = redisSideTableInfo.getPrimaryKeys(inputParams.values(), &quot;:&quot;);
 243         for (String primaryKey : primaryKeys) {
 244             if (!refData.containsKey(primaryKey)) {
 245                 return null;
 246             }
 247             keyBuilder.append(&quot;_&quot;).append(refData.get(primaryKey));
 248         }
 249         return keyBuilder.toString();
 250     }
 251 
 252     @Override
 253     public void close() throws Exception {
 254         super.close();
 255         if (connection != null){
 256             connection.close();
 257         }
 258         if (redisClient != null){
 259             redisClient.shutdown();
 260         }
 261         if (clusterConnection != null){
 262             clusterConnection.close();
 263         }
 264         if (clusterClient != null){
 265             clusterClient.shutdown();
 266         }
 267     }
 268 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  /*
   2   * Licensed to the Apache Software Foundation (ASF) under one
   3   * or more contributor license agreements.  See the NOTICE file
   4   * distributed with this work for additional information
   5   * regarding copyright ownership.  The ASF licenses this file
   6   * to you under the Apache License, Version 2.0 (the
   7   * &quot;License&quot;); you may not use this file except in compliance
   8   * with the License.  You may obtain a copy of the License at
   9   *
  10   *     http://www.apache.org/licenses/LICENSE-2.0
  11   *
  12   * Unless required by applicable law or agreed to in writing, software
  13   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15   * See the License for the specific language governing permissions and
  16   * limitations under the License.
  17   */
  18  
  19  package com.dtstack.flink.sql.side.redis;
  20  
  21  import com.dtstack.flink.sql.side.AbstractSideTableInfo;
  22  import com.dtstack.flink.sql.side.BaseAsyncReqRow;
  23  import org.apache.flink.api.java.typeutils.RowTypeInfo;
  24  import org.apache.flink.configuration.Configuration;
  25  import org.apache.flink.streaming.api.functions.async.ResultFuture;
  26  import org.apache.flink.table.runtime.types.CRow;
  27  import org.apache.flink.types.Row;
  28  
  29  import com.dtstack.flink.sql.enums.ECacheContentType;
  30  import com.dtstack.flink.sql.side.CacheMissVal;
  31  import com.dtstack.flink.sql.side.FieldInfo;
  32  import com.dtstack.flink.sql.side.JoinInfo;
  33  import com.dtstack.flink.sql.side.cache.CacheObj;

  34  import com.dtstack.flink.sql.side.redis.table.RedisSideReqRow;
  35  import com.dtstack.flink.sql.side.redis.table.RedisSideTableInfo;
  36  import com.google.common.collect.Lists;
  37  import com.google.common.collect.Maps;
  38  import io.lettuce.core.KeyValue;
  39  import io.lettuce.core.RedisClient;
  40  import io.lettuce.core.RedisFuture;
  41  import io.lettuce.core.api.StatefulRedisConnection;

  42  import io.lettuce.core.api.async.RedisKeyAsyncCommands;
  43  import io.lettuce.core.api.async.RedisStringAsyncCommands;
  44  import io.lettuce.core.cluster.RedisClusterClient;
  45  import io.lettuce.core.cluster.api.StatefulRedisClusterConnection;
  46  import org.apache.commons.lang3.StringUtils;



  47  
  48  import java.util.Collections;
  49  import java.util.List;
  50  import java.util.Map;
  51  import java.util.function.Consumer;
  52  /**
  53   * @author yanxi
  54   */
  55  public class RedisAsyncReqRow extends BaseAsyncReqRow {
  56  
  57      private static final long serialVersionUID = -2079908694523987738L;
  58  
  59      private RedisClient redisClient;
  60  
  61      private StatefulRedisConnection&lt;String, String&gt; connection;
  62  
  63      private RedisClusterClient clusterClient;
  64  
  65      private StatefulRedisClusterConnection&lt;String, String&gt; clusterConnection;
  66  
  67      private RedisKeyAsyncCommands&lt;String, String&gt; async;
  68  
  69      private RedisSideTableInfo redisSideTableInfo;
  70  
  71      private RedisSideReqRow redisSideReqRow;
  72  
<abbr title="  73      public RedisAsyncReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, AbstractSideTableInfo sideTableInfo) {">  73      public RedisAsyncReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, AbstractðŸ”µ</abbr>
  74          super(new RedisAsyncSideInfo(rowTypeInfo, joinInfo, outFieldInfoList, sideTableInfo));
  75          redisSideReqRow = new RedisSideReqRow(super.sideInfo);
  76      }
  77  
  78      @Override
  79      public void open(Configuration parameters) throws Exception {
  80          super.open(parameters);
  81          redisSideTableInfo = (RedisSideTableInfo) sideInfo.getSideTableInfo();
  82          buildRedisClient(redisSideTableInfo);
  83      }
  84  
  85      private void buildRedisClient(RedisSideTableInfo tableInfo){
  86          String url = redisSideTableInfo.getUrl();
  87          String password = redisSideTableInfo.getPassword();
  88          if (password != null){
  89              password = password + &quot;@&quot;;
  90          } else {
  91              password = &quot;&quot;;
  92          }
  93          String database = redisSideTableInfo.getDatabase();
  94          if (database == null){
  95              database = &quot;0&quot;;
  96          }
  97          switch (tableInfo.getRedisType()){
  98              case 1:


  99                  StringBuilder redisUri = new StringBuilder();
 100                  redisUri.append(&quot;redis://&quot;).append(password).append(url).append(&quot;/&quot;).append(database);
 101                  redisClient = RedisClient.create(redisUri.toString());
 102                  connection = redisClient.connect();
 103                  async = connection.async();
 104                  break;
 105              case 2:

 106                  StringBuilder sentinelUri = new StringBuilder();
 107                  sentinelUri.append(&quot;redis-sentinel://&quot;).append(password)
<abbr title=" 108                          .append(url).append(&quot;/&quot;).append(database).append(&quot;#&quot;).append(redisSideTableInfo.getMasterName());"> 108                          .append(url).append(&quot;/&quot;).append(database).append(&quot;#&quot;).append(redisSideTableInfo.getMasterNðŸ”µ</abbr>
 109                  redisClient = RedisClient.create(sentinelUri.toString());
 110                  connection = redisClient.connect();
 111                  async = connection.async();
 112                  break;
 113              case 3:

 114                  StringBuilder clusterUri = new StringBuilder();
 115                  clusterUri.append(&quot;redis://&quot;).append(password).append(url);
 116                  clusterClient = RedisClusterClient.create(clusterUri.toString());
 117                  clusterConnection = clusterClient.connect();
 118                  async = clusterConnection.async();
 119              default:

 120          }
 121      }
 122  
 123      @Override
 124      public Row fillData(Row input, Object sideInput) {
 125          return redisSideReqRow.fillData(input, sideInput);
 126      }
 127  
 128      @Override
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 129 -    public void asyncInvoke(CRow input, ResultFuture&lt;CRow&gt; resultFuture) throws Exception {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 130 -        CRow inputCopy = new CRow(input.row(),input.change());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 131 -        List&lt;String&gt; keyData = Lists.newLinkedList();</span>


<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 132 -        for (int i = 0; i &lt; sideInfo.getEqualValIndex().size(); i++) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 133 -            Integer conValIndex = sideInfo.getEqualValIndex().get(i);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 134 -            Object equalObj = inputCopy.row().getField(conValIndex);</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 135 -            if(equalObj == null){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 136 -                dealMissKey(inputCopy, resultFuture);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 137 -                return;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 138 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 139 -            String value = equalObj.toString();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 140 -            keyData.add(sideInfo.getEqualFieldList().get(i));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 141 -            keyData.add(value);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 142 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 143 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 144 -        String key = buildCacheKey(keyData);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 145 -</span>







<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 146 -        if(openCache()){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 147 -            CacheObj val = getFromCache(key);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 148 -            if(val != null){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 149 -                if(ECacheContentType.MissVal == val.getType()){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 150 -                    dealMissKey(inputCopy, resultFuture);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 151 -                    return;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 152 -                }else if(ECacheContentType.MultiLine == val.getType()){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 153 -                    try {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 154 -                        Row row = fillData(inputCopy.row(), val.getContent());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 155 -                        resultFuture.complete(Collections.singleton(new CRow(row, input.change())));</span>


<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 156 -                    } catch (Exception e) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 157 -                        dealFillDataError(resultFuture, e, inputCopy);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 158 -                    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 159 -                }else{</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 160 -                    RuntimeException exception = new RuntimeException(&quot;not support cache obj type &quot; + val.getType());"> 160 -                    RuntimeException exception = new RuntimeException(&quot;not support cache obj type &quot; + val.getType(ðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 161 -                    resultFuture.completeExceptionally(exception);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 162 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 163 -                return;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 164 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 165 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 166 -</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 167 +    public void handleAsyncInvoke(Map&lt;String, Object&gt; inputParams, CRow input, ResultFuture&lt;CRow&gt; resultFuture) throws Exception {"> 167 +    public void handleAsyncInvoke(Map&lt;String, Object&gt; inputParams, CRow input, ResultFuture&lt;CRow&gt; resultFuture) thðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 168 +        String key = buildCacheKey(inputParams);</span>
 169          Map&lt;String, String&gt; keyValue = Maps.newHashMap();
 170          List&lt;String&gt; value = async.keys(key + &quot;:*&quot;).get();
 171          String[] values = value.toArray(new String[value.size()]);
 172          if (values.length == 0) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 173 -            dealMissKey(inputCopy, resultFuture);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 174 +            dealMissKey(input, resultFuture);</span>
 175          } else {
 176              RedisFuture&lt;List&lt;KeyValue&lt;String, String&gt;&gt;&gt; future = ((RedisStringAsyncCommands) async).mget(values);
 177              future.thenAccept(new Consumer&lt;List&lt;KeyValue&lt;String, String&gt;&gt;&gt;() {
 178                  @Override
 179                  public void accept(List&lt;KeyValue&lt;String, String&gt;&gt; keyValues) {
 180                      if (keyValues.size() != 0) {
 181                          for (int i = 0; i &lt; keyValues.size(); i++) {
 182                              String[] splitKeys = StringUtils.split(keyValues.get(i).getKey(), &quot;:&quot;);
 183                              keyValue.put(splitKeys[1], splitKeys[2]);
 184                              keyValue.put(splitKeys[3], keyValues.get(i).getValue());
 185                          }
 186                          try {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 187 -                            Row row = fillData(inputCopy.row(), keyValue);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 188 +                            Row row = fillData(input.row(), keyValue);</span>
 189                              dealCacheData(key, CacheObj.buildCacheObj(ECacheContentType.MultiLine, keyValue));
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 190 -                            resultFuture.complete(Collections.singleton(new CRow(row, inputCopy.change())));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 191 +                            resultFuture.complete(Collections.singleton(new CRow(row, input.change())));</span>
 192                          } catch (Exception e) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 193 -                            dealFillDataError(resultFuture, e, inputCopy);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 194 +                            dealFillDataError(resultFuture, e, input);</span>
 195                          }
 196                      } else {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 197 -                        dealMissKey(inputCopy, resultFuture);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 198 +                        dealMissKey(input, resultFuture);</span>
 199                          dealCacheData(key, CacheMissVal.getMissKeyObj());











 200                      }



 201                  }
 202              });
 203          }
 204      }
 205  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 206 -    private String buildCacheKey(List&lt;String&gt; keyData) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 207 -        String kv = String.join(&quot;:&quot;, keyData);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 208 +    @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 209 +    public String buildCacheKey(Map&lt;String, Object&gt; inputParams) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 210 +        String kv = StringUtils.join(inputParams.values(), &quot;:&quot;);</span>
 211          String tableName = redisSideTableInfo.getTableName();
 212          StringBuilder preKey =  new StringBuilder();
 213          preKey.append(tableName).append(&quot;:&quot;).append(kv);
 214          return preKey.toString();














 215      }
 216  
 217      @Override
 218      public void close() throws Exception {
 219          super.close();
 220          if (connection != null){
 221              connection.close();
 222          }
 223          if (redisClient != null){
 224              redisClient.shutdown();
 225          }
 226          if (clusterConnection != null){
 227              clusterConnection.close();
 228          }
 229          if (clusterClient != null){
 230              clusterClient.shutdown();
 231          }
 232      }
 233  
 234  }</pre></td>
                            <td><pre>   1  /*
   2   * Licensed to the Apache Software Foundation (ASF) under one
   3   * or more contributor license agreements.  See the NOTICE file
   4   * distributed with this work for additional information
   5   * regarding copyright ownership.  The ASF licenses this file
   6   * to you under the Apache License, Version 2.0 (the
   7   * &quot;License&quot;); you may not use this file except in compliance
   8   * with the License.  You may obtain a copy of the License at
   9   *
  10   *     http://www.apache.org/licenses/LICENSE-2.0
  11   *
  12   * Unless required by applicable law or agreed to in writing, software
  13   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15   * See the License for the specific language governing permissions and
  16   * limitations under the License.
  17   */
  18  
  19  package com.dtstack.flink.sql.side.redis;
  20  
  21  import com.dtstack.flink.sql.side.AbstractSideTableInfo;
  22  import com.dtstack.flink.sql.side.BaseAsyncReqRow;
  23  import org.apache.flink.api.java.typeutils.RowTypeInfo;
  24  import org.apache.flink.configuration.Configuration;
  25  import org.apache.flink.streaming.api.functions.async.ResultFuture;
  26  import org.apache.flink.table.runtime.types.CRow;
  27  import org.apache.flink.types.Row;
  28  
  29  import com.dtstack.flink.sql.enums.ECacheContentType;
  30  import com.dtstack.flink.sql.side.CacheMissVal;
  31  import com.dtstack.flink.sql.side.FieldInfo;
  32  import com.dtstack.flink.sql.side.JoinInfo;
  33  import com.dtstack.flink.sql.side.cache.CacheObj;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  34 +import com.dtstack.flink.sql.side.redis.enums.RedisType;</span>
  35  import com.dtstack.flink.sql.side.redis.table.RedisSideReqRow;
  36  import com.dtstack.flink.sql.side.redis.table.RedisSideTableInfo;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  37 -import com.google.common.collect.Lists;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  38 -import com.google.common.collect.Maps;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  39 -import io.lettuce.core.KeyValue;</span>
  40  import io.lettuce.core.RedisClient;
  41  import io.lettuce.core.RedisFuture;
  42  import io.lettuce.core.api.StatefulRedisConnection;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  43 +import io.lettuce.core.api.async.RedisHashAsyncCommands;</span>
  44  import io.lettuce.core.api.async.RedisKeyAsyncCommands;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  45 -import io.lettuce.core.api.async.RedisStringAsyncCommands;</span>
  46  import io.lettuce.core.cluster.RedisClusterClient;
  47  import io.lettuce.core.cluster.api.StatefulRedisClusterConnection;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  48 -import org.apache.commons.lang3.StringUtils;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  49 +import org.apache.commons.collections.MapUtils;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  50 +import org.apache.commons.lang.StringUtils;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  51 +import com.google.common.collect.Maps;</span>
  52  
  53  import java.util.Collections;
  54  import java.util.List;
  55  import java.util.Map;
  56  import java.util.function.Consumer;
  57  /**
  58   * @author yanxi
  59   */
  60  public class RedisAsyncReqRow extends BaseAsyncReqRow {
  61  
  62      private static final long serialVersionUID = -2079908694523987738L;
  63  
  64      private RedisClient redisClient;
  65  
  66      private StatefulRedisConnection&lt;String, String&gt; connection;
  67  
  68      private RedisClusterClient clusterClient;
  69  
  70      private StatefulRedisClusterConnection&lt;String, String&gt; clusterConnection;
  71  
  72      private RedisKeyAsyncCommands&lt;String, String&gt; async;
  73  
  74      private RedisSideTableInfo redisSideTableInfo;
  75  
  76      private RedisSideReqRow redisSideReqRow;
  77  
<abbr title="  78      public RedisAsyncReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, AbstractSideTableInfo sideTableInfo) {">  78      public RedisAsyncReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, AbstractðŸ”µ</abbr>
  79          super(new RedisAsyncSideInfo(rowTypeInfo, joinInfo, outFieldInfoList, sideTableInfo));
  80          redisSideReqRow = new RedisSideReqRow(super.sideInfo);
  81      }
  82  
  83      @Override
  84      public void open(Configuration parameters) throws Exception {
  85          super.open(parameters);
  86          redisSideTableInfo = (RedisSideTableInfo) sideInfo.getSideTableInfo();
  87          buildRedisClient(redisSideTableInfo);
  88      }
  89  
  90      private void buildRedisClient(RedisSideTableInfo tableInfo){
  91          String url = redisSideTableInfo.getUrl();
  92          String password = redisSideTableInfo.getPassword();
  93          if (password != null){
  94              password = password + &quot;@&quot;;
  95          } else {
  96              password = &quot;&quot;;
  97          }
  98          String database = redisSideTableInfo.getDatabase();
  99          if (database == null){
 100              database = &quot;0&quot;;
 101          }
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 102 -        switch (tableInfo.getRedisType()){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 103 -            case 1:</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 104 +        switch (RedisType.parse(tableInfo.getRedisType())){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 105 +            case STANDALONE:</span>
 106                  StringBuilder redisUri = new StringBuilder();
 107                  redisUri.append(&quot;redis://&quot;).append(password).append(url).append(&quot;/&quot;).append(database);
 108                  redisClient = RedisClient.create(redisUri.toString());
 109                  connection = redisClient.connect();
 110                  async = connection.async();
 111                  break;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 112 -            case 2:</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 113 +            case SENTINEL:</span>
 114                  StringBuilder sentinelUri = new StringBuilder();
 115                  sentinelUri.append(&quot;redis-sentinel://&quot;).append(password)
<abbr title=" 116                          .append(url).append(&quot;/&quot;).append(database).append(&quot;#&quot;).append(redisSideTableInfo.getMasterName());"> 116                          .append(url).append(&quot;/&quot;).append(database).append(&quot;#&quot;).append(redisSideTableInfo.getMasterNðŸ”µ</abbr>
 117                  redisClient = RedisClient.create(sentinelUri.toString());
 118                  connection = redisClient.connect();
 119                  async = connection.async();
 120                  break;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 121 -            case 3:</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 122 +            case CLUSTER:</span>
 123                  StringBuilder clusterUri = new StringBuilder();
 124                  clusterUri.append(&quot;redis://&quot;).append(password).append(url);
 125                  clusterClient = RedisClusterClient.create(clusterUri.toString());
 126                  clusterConnection = clusterClient.connect();
 127                  async = clusterConnection.async();
 128              default:
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 129 +                break;</span>
 130          }
 131      }
 132  
 133      @Override
 134      public Row fillData(Row input, Object sideInput) {
 135          return redisSideReqRow.fillData(input, sideInput);
 136      }
 137  
 138      @Override
 139      public void asyncInvoke(CRow input, ResultFuture&lt;CRow&gt; resultFuture) throws Exception {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 140 -        CRow inputCopy = new CRow(input.row(),input.change());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 141 -        List&lt;String&gt; keyData = Lists.newLinkedList();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 142 +        CRow inputCopy = new CRow(input.row(), input.change());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 143 +        Map&lt;String, Object&gt; refData = Maps.newHashMap();</span>
 144          for (int i = 0; i &lt; sideInfo.getEqualValIndex().size(); i++) {
 145              Integer conValIndex = sideInfo.getEqualValIndex().get(i);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 146 -            Object equalObj = inputCopy.row().getField(conValIndex);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 147 +            Object equalObj = input.row().getField(conValIndex);</span>
 148              if(equalObj == null){
 149                  dealMissKey(inputCopy, resultFuture);
 150                  return;
 151              }
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 152 -            String value = equalObj.toString();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 153 -            keyData.add(sideInfo.getEqualFieldList().get(i));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 154 -            keyData.add(value);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 155 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 156 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 157 -        String key = buildCacheKey(keyData);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 158 -</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 159 +            refData.put(sideInfo.getEqualFieldList().get(i), equalObj);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 160 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 161 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 162 +        String key = buildCacheKey(refData);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 163 +        if(StringUtils.isBlank(key)){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 164 +            return;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 165 +        }</span>
 166          if(openCache()){
 167              CacheObj val = getFromCache(key);
 168              if(val != null){
 169                  if(ECacheContentType.MissVal == val.getType()){
 170                      dealMissKey(inputCopy, resultFuture);
 171                      return;
 172                  }else if(ECacheContentType.MultiLine == val.getType()){
 173                      try {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 174 -                        Row row = fillData(inputCopy.row(), val.getContent());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 175 -                        resultFuture.complete(Collections.singleton(new CRow(row, input.change())));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 176 +                        Row row = fillData(input.row(), val.getContent());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 177 +                        resultFuture.complete(Collections.singleton(new CRow(row, inputCopy.change())));</span>
 178                      } catch (Exception e) {
 179                          dealFillDataError(resultFuture, e, inputCopy);
 180                      }
 181                  }else{
<abbr title=" 182                      RuntimeException exception = new RuntimeException(&quot;not support cache obj type &quot; + val.getType());"> 182                      RuntimeException exception = new RuntimeException(&quot;not support cache obj type &quot; + val.getType(ðŸ”µ</abbr>
 183                      resultFuture.completeExceptionally(exception);
 184                  }
 185                  return;
 186              }
 187          }
 188  


<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 189 -        Map&lt;String, String&gt; keyValue = Maps.newHashMap();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 190 -        List&lt;String&gt; value = async.keys(key + &quot;:*&quot;).get();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 191 -        String[] values = value.toArray(new String[value.size()]);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 192 -        if (values.length == 0) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 193 -            dealMissKey(inputCopy, resultFuture);</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 194 -        } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 195 -            RedisFuture&lt;List&lt;KeyValue&lt;String, String&gt;&gt;&gt; future = ((RedisStringAsyncCommands) async).mget(values);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 196 -            future.thenAccept(new Consumer&lt;List&lt;KeyValue&lt;String, String&gt;&gt;&gt;() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 197 -                @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 198 -                public void accept(List&lt;KeyValue&lt;String, String&gt;&gt; keyValues) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 199 -                    if (keyValues.size() != 0) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 200 -                        for (int i = 0; i &lt; keyValues.size(); i++) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 201 -                            String[] splitKeys = StringUtils.split(keyValues.get(i).getKey(), &quot;:&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 202 -                            keyValue.put(splitKeys[1], splitKeys[2]);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 203 -                            keyValue.put(splitKeys[3], keyValues.get(i).getValue());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 204 -                        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 205 -                        try {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 206 -                            Row row = fillData(inputCopy.row(), keyValue);</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 207 -                            dealCacheData(key, CacheObj.buildCacheObj(ECacheContentType.MultiLine, keyValue));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 208 -                            resultFuture.complete(Collections.singleton(new CRow(row, inputCopy.change())));</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 209 -                        } catch (Exception e) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 210 -                            dealFillDataError(resultFuture, e, inputCopy);</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 211 -                        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 212 -                    } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 213 -                        dealMissKey(inputCopy, resultFuture);</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 214 -                        dealCacheData(key, CacheMissVal.getMissKeyObj());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 215 +        RedisFuture&lt;Map&lt;String, String&gt;&gt; future = ((RedisHashAsyncCommands) async).hgetall(key);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 216 +        future.thenAccept(new Consumer&lt;Map&lt;String, String&gt;&gt;() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 217 +            @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 218 +            public void accept(Map&lt;String, String&gt; values) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 219 +                if (MapUtils.isNotEmpty(values)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 220 +                    try {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 221 +                        Row row = fillData(input.row(), values);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 222 +                        dealCacheData(key,CacheObj.buildCacheObj(ECacheContentType.MultiLine, values));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 223 +                        resultFuture.complete(Collections.singleton(new CRow(row, inputCopy.change())));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 224 +                    } catch (Exception e) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 225 +                        dealFillDataError(resultFuture, e, inputCopy);</span>
 226                      }
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 227 +                } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 228 +                    dealMissKey(inputCopy, resultFuture);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 229 +                    dealCacheData(key,CacheMissVal.getMissKeyObj());</span>
 230                  }
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 231 -            });</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 232 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 233 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 234 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 235 -    private String buildCacheKey(List&lt;String&gt; keyData) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 236 -        String kv = String.join(&quot;:&quot;, keyData);</span>



<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 237 -        String tableName = redisSideTableInfo.getTableName();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 238 -        StringBuilder preKey =  new StringBuilder();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 239 -        preKey.append(tableName).append(&quot;:&quot;).append(kv);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 240 -        return preKey.toString();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 241 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 242 +        });</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 243 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 244 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 245 +    private String buildCacheKey(Map&lt;String, Object&gt; refData) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 246 +        StringBuilder keyBuilder = new StringBuilder(redisSideTableInfo.getTableName());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 247 +        List&lt;String&gt; primaryKeys = redisSideTableInfo.getPrimaryKeys();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 248 +        for(String primaryKey : primaryKeys){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 249 +            if(!refData.containsKey(primaryKey)){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 250 +                return null;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 251 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 252 +            keyBuilder.append(&quot;_&quot;).append(refData.get(primaryKey));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 253 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 254 +        return keyBuilder.toString();</span>
 255      }
 256  
 257      @Override
 258      public void close() throws Exception {
 259          super.close();
 260          if (connection != null){
 261              connection.close();
 262          }
 263          if (redisClient != null){
 264              redisClient.shutdown();
 265          }
 266          if (clusterConnection != null){
 267              clusterConnection.close();
 268          }
 269          if (clusterClient != null){
 270              clusterClient.shutdown();
 271          }
 272      }
 273  
 274  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            