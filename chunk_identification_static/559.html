<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>559</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    559
                    <a href="558.html">prev</a>
                    <a href="560.html">next</a>
                    <a href="559_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    DTStack/flinkStreamSQL_7302b163e73618ae14d90bd0ad9b64f1caf7c884_launcher/src/main/java/com/dtstack/flink/sql/launcher/perjob/PerJobClusterClientBuilder.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;7302b163e73618ae14d90bd0ad9b64f1caf7c884:launcher/src/main/java/com/dtstack/flink/sql/launcher/perjob/PerJobClusterClientBuilder.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;7302b163e73618ae14d90bd0ad9b64f1caf7c884^1:launcher/src/main/java/com/dtstack/flink/sql/launcher/perjob/PerJobClusterClientBuilder.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;7302b163e73618ae14d90bd0ad9b64f1caf7c884^2:launcher/src/main/java/com/dtstack/flink/sql/launcher/perjob/PerJobClusterClientBuilder.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;b259aa5e9ca64e4d07266783ec504a1f5fd6d5ec:launcher/src/main/java/com/dtstack/flink/sql/launcher/perjob/PerJobClusterClientBuilder.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[sbj]], subset: [[sbj]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
   2 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   3 /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   4  * Licensed to the Apache Software Foundation (ASF) under one</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   5  * or more contributor license agreements.  See the NOTICE file</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   6  * distributed with this work for additional information</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   7  * regarding copyright ownership.  The ASF licenses this file</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   8  * to you under the Apache License, Version 2.0 (the</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   9  * &quot;License&quot;); you may not use this file except in compliance</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  10  * with the License.  You may obtain a copy of the License at</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  11  *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  12  * http://www.apache.org/licenses/LICENSE-2.0</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  13  *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  14  * Unless required by applicable law or agreed to in writing, software</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  15  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  16  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  17  * See the License for the specific language governing permissions and</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  18  * limitations under the License.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  19  */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  20 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  21 package com.dtstack.flink.sql.launcher.perjob;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  22 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  23 import com.dtstack.flink.sql.enums.EPluginLoadMode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  24 import com.dtstack.flink.sql.launcher.YarnConfLoader;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  25 import com.dtstack.flink.sql.option.Options;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  26 import org.apache.commons.lang3.StringUtils;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  27 import org.apache.flink.api.common.cache.DistributedCache;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  28 import org.apache.flink.configuration.Configuration;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  29 import com.google.common.base.Strings;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  30 import org.apache.flink.runtime.jobgraph.JobGraph;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  31 import org.apache.flink.runtime.security.SecurityConfiguration;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  32 import org.apache.flink.runtime.security.SecurityUtils;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  33 import org.apache.flink.yarn.AbstractYarnClusterDescriptor;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  34 import org.apache.flink.yarn.YarnClusterDescriptor;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  35 import org.apache.hadoop.fs.Path;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  36 import org.apache.hadoop.security.UserGroupInformation;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  37 import org.apache.hadoop.yarn.client.api.YarnClient;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  38 import org.apache.hadoop.yarn.conf.YarnConfiguration;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  39 import org.slf4j.Logger;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  40 import org.slf4j.LoggerFactory;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  41 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  42 import java.io.File;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  43 import java.io.IOException;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  44 import java.net.MalformedURLException;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  45 import java.net.URL;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  46 import java.util.ArrayList;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  47 import java.util.List;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  48 import java.util.Map;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  49 import java.util.Properties;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  50 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  51 /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  52  * Reason:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  53  * Date: 2018/11/16</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  54  * Company: www.dtstack.com</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  55  * @author xuchao</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  56  */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  57 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  58 public class PerJobClusterClientBuilder {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  59 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  60     private static final Logger LOG = LoggerFactory.getLogger(PerJobClusterClientBuilder.class);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  61 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  62     private static final String DEFAULT_CONF_DIR = &quot;./&quot;;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  63 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  64     private YarnClient yarnClient;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  65 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  66     private YarnConfiguration yarnConf;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  67 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  68     private Configuration flinkConfig;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  69 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="  70     public void init(String yarnConfDir, Configuration flinkConfig, Properties userConf) throws Exception {">  70     public void init(String yarnConfDir, Configuration flinkConfig, Properties userConf) throws Exception🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  71 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  72         if(Strings.isNullOrEmpty(yarnConfDir)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  73             throw new RuntimeException(&quot;parameters of yarn is required&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  74         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  75         userConf.forEach((key, val) -&gt; flinkConfig.setString(key.toString(), val.toString()));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  76         this.flinkConfig = flinkConfig;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  77         SecurityUtils.install(new SecurityConfiguration(flinkConfig));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  78 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  79         yarnConf = YarnConfLoader.getYarnConf(yarnConfDir);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  80         yarnClient = YarnClient.createYarnClient();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  81         yarnClient.init(yarnConf);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  82         yarnClient.start();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  83 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  84         System.out.println(&quot;----init yarn success ----&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  85     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  86 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="  87     public AbstractYarnClusterDescriptor createPerJobClusterDescriptor(String flinkJarPath, Options launcherOptions, JobGraph jobGraph)">  87     public AbstractYarnClusterDescriptor createPerJobClusterDescriptor(String flinkJarPath, Options launc🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  88             throws MalformedURLException {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  89 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="  90         String flinkConf = StringUtils.isEmpty(launcherOptions.getFlinkconf()) ? DEFAULT_CONF_DIR : launcherOptions.getFlinkconf();">  90         String flinkConf = StringUtils.isEmpty(launcherOptions.getFlinkconf()) ? DEFAULT_CONF_DIR : launc🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="  91         AbstractYarnClusterDescriptor clusterDescriptor = getClusterDescriptor(flinkConfig, yarnConf, flinkConf);">  91         AbstractYarnClusterDescriptor clusterDescriptor = getClusterDescriptor(flinkConfig, yarnConf, fli🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  92 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  93         if (StringUtils.isNotBlank(flinkJarPath)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  94             if (!new File(flinkJarPath).exists()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  95                 throw new RuntimeException(&quot;The param &#x27;-flinkJarPath&#x27; ref dir is not exist&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  96             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  97         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  98 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  99         List&lt;File&gt; shipFiles = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 100         if (flinkJarPath != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 101             File[] jars = new File(flinkJarPath).listFiles();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 102             for (File file : jars) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 103                 if (file.toURI().toURL().toString().contains(&quot;flink-dist&quot;)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 104                     clusterDescriptor.setLocalJarPath(new Path(file.toURI().toURL().toString()));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 105                 } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 106                     shipFiles.add(file);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 107                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 108             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 109         } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 110             throw new RuntimeException(&quot;The Flink jar path is null&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 111         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 112         // classpath , all node need contain plugin jar</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 113         String pluginLoadMode = launcherOptions.getPluginLoadMode();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 114         if (StringUtils.equalsIgnoreCase(pluginLoadMode, EPluginLoadMode.CLASSPATH.name())) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 115             fillJobGraphClassPath(jobGraph);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 116         } else if (StringUtils.equalsIgnoreCase(pluginLoadMode, EPluginLoadMode.SHIPFILE.name())) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 117             List&lt;File&gt; pluginPaths = getPluginPathToShipFiles(jobGraph);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 118             shipFiles.addAll(pluginPaths);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 119         } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 120             throw new IllegalArgumentException(&quot;Unsupported plugin loading mode &quot; + pluginLoadMode</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 121                     + &quot; Currently only classpath and shipfile are supported.&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 122         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 123 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 124         clusterDescriptor.addShipFiles(shipFiles);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 125         clusterDescriptor.setName(launcherOptions.getName());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 126         String queue = launcherOptions.getQueue();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 127         if (!Strings.isNullOrEmpty(queue)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 128             clusterDescriptor.setQueue(queue);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 129         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 130         return clusterDescriptor;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 131     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 132 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 133     private static void fillJobGraphClassPath(JobGraph jobGraph) throws MalformedURLException {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 134         Map&lt;String, DistributedCache.DistributedCacheEntry&gt; jobCacheFileConfig = jobGraph.getUserArtifacts();"> 134         Map&lt;String, DistributedCache.DistributedCacheEntry&gt; jobCacheFileConfig = jobGraph.getUserArtifact🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 135         for(Map.Entry&lt;String,  DistributedCache.DistributedCacheEntry&gt; tmp : jobCacheFileConfig.entrySet()){"> 135         for(Map.Entry&lt;String,  DistributedCache.DistributedCacheEntry&gt; tmp : jobCacheFileConfig.entrySet(🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 136             if(tmp.getKey().startsWith(&quot;class_path&quot;)){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 137                 jobGraph.getClasspaths().add(new URL(&quot;file:&quot; + tmp.getValue().filePath));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 138             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 139         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 140     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 141 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 142     private List&lt;File&gt; getPluginPathToShipFiles(JobGraph jobGraph) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 143         List&lt;File&gt; shipFiles = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 144         Map&lt;String, DistributedCache.DistributedCacheEntry&gt; jobCacheFileConfig = jobGraph.getUserArtifacts();"> 144         Map&lt;String, DistributedCache.DistributedCacheEntry&gt; jobCacheFileConfig = jobGraph.getUserArtifact🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 145         for(Map.Entry&lt;String,  DistributedCache.DistributedCacheEntry&gt; tmp : jobCacheFileConfig.entrySet()){"> 145         for(Map.Entry&lt;String,  DistributedCache.DistributedCacheEntry&gt; tmp : jobCacheFileConfig.entrySet(🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 146             if(tmp.getKey().startsWith(&quot;class_path&quot;)){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 147                 shipFiles.add(new File(tmp.getValue().filePath));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 148             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 149         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 150         return shipFiles;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 151     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 152 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 153     private AbstractYarnClusterDescriptor getClusterDescriptor(</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 154             Configuration configuration,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 155             YarnConfiguration yarnConfiguration,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 156             String configurationDirectory) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 157         return new YarnClusterDescriptor(</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 158                 configuration,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 159                 yarnConfiguration,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 160                 configurationDirectory,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 161                 yarnClient,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 162                 false);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 163     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 164 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 165 }</span>
 166 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 167 /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 168  * Licensed to the Apache Software Foundation (ASF) under one</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 169  * or more contributor license agreements.  See the NOTICE file</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 170  * distributed with this work for additional information</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 171  * regarding copyright ownership.  The ASF licenses this file</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 172  * to you under the Apache License, Version 2.0 (the</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 173  * &quot;License&quot;); you may not use this file except in compliance</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 174  * with the License.  You may obtain a copy of the License at</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 175  *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 176  * http://www.apache.org/licenses/LICENSE-2.0</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 177  *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 178  * Unless required by applicable law or agreed to in writing, software</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 179  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 180  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 181  * See the License for the specific language governing permissions and</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 182  * limitations under the License.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 183  */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 184 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 185 package com.dtstack.flink.sql.launcher.perjob;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 186 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 187 import com.dtstack.flink.sql.enums.EPluginLoadMode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 188 import com.dtstack.flink.sql.launcher.YarnConfLoader;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 189 import com.dtstack.flink.sql.option.Options;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 190 import com.esotericsoftware.minlog.Log;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 191 import org.apache.commons.lang3.StringUtils;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 192 import org.apache.flink.api.common.cache.DistributedCache;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 193 import org.apache.flink.configuration.Configuration;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 194 import com.google.common.base.Strings;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 195 import org.apache.flink.runtime.jobgraph.JobGraph;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 196 import org.apache.flink.runtime.security.SecurityConfiguration;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 197 import org.apache.flink.runtime.security.SecurityUtils;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 198 import org.apache.flink.yarn.AbstractYarnClusterDescriptor;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 199 import org.apache.flink.yarn.YarnClusterDescriptor;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 200 import org.apache.hadoop.fs.Path;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 201 import org.apache.hadoop.security.UserGroupInformation;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 202 import org.apache.hadoop.yarn.client.api.YarnClient;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 203 import org.apache.hadoop.yarn.conf.YarnConfiguration;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 204 import org.slf4j.Logger;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 205 import org.slf4j.LoggerFactory;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 206 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 207 import java.io.File;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 208 import java.io.IOException;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 209 import java.net.MalformedURLException;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 210 import java.net.URL;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 211 import java.util.ArrayList;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 212 import java.util.List;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 213 import java.util.Map;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 214 import java.util.Properties;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 215 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 216 /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 217  * Reason:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 218  * Date: 2018/11/16</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 219  * Company: www.dtstack.com</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 220  * @author xuchao</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 221  */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 222 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 223 public class PerJobClusterClientBuilder {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 224 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 225     private static final Logger LOG = LoggerFactory.getLogger(PerJobClusterClientBuilder.class);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 226 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 227     private static final String DEFAULT_CONF_DIR = &quot;./&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 228 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 229     private YarnClient yarnClient;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 230 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 231     private YarnConfiguration yarnConf;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 232 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 233     private Configuration flinkConfig;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 234 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 235     public void init(String yarnConfDir, Configuration flinkConfig, Properties userConf) throws Exception {"> 235     public void init(String yarnConfDir, Configuration flinkConfig, Properties userConf) throws Exception🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 236 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 237         if(Strings.isNullOrEmpty(yarnConfDir)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 238             throw new RuntimeException(&quot;parameters of yarn is required&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 239         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 240         userConf.forEach((key, val) -&gt; flinkConfig.setString(key.toString(), val.toString()));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 241         this.flinkConfig = flinkConfig;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 242         SecurityUtils.install(new SecurityConfiguration(flinkConfig));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 243 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 244         yarnConf = YarnConfLoader.getYarnConf(yarnConfDir);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 245         yarnClient = YarnClient.createYarnClient();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 246         yarnClient.init(yarnConf);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 247         yarnClient.start();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 248 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 249         Log.info(&quot;----init yarn success ----&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 250     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 251 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 252     public AbstractYarnClusterDescriptor createPerJobClusterDescriptor(String flinkJarPath, Options launcherOptions, JobGraph jobGraph)"> 252     public AbstractYarnClusterDescriptor createPerJobClusterDescriptor(String flinkJarPath, Options launc🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 253             throws MalformedURLException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 254 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 255         String flinkConf = StringUtils.isEmpty(launcherOptions.getFlinkconf()) ? DEFAULT_CONF_DIR : launcherOptions.getFlinkconf();"> 255         String flinkConf = StringUtils.isEmpty(launcherOptions.getFlinkconf()) ? DEFAULT_CONF_DIR : launc🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 256         AbstractYarnClusterDescriptor clusterDescriptor = getClusterDescriptor(flinkConfig, yarnConf, flinkConf);"> 256         AbstractYarnClusterDescriptor clusterDescriptor = getClusterDescriptor(flinkConfig, yarnConf, fli🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 257 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 258         if (StringUtils.isNotBlank(flinkJarPath)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 259             if (!new File(flinkJarPath).exists()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 260                 throw new RuntimeException(&quot;The param &#x27;-flinkJarPath&#x27; ref dir is not exist&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 261             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 262         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 263 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 264         List&lt;File&gt; shipFiles = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 265         if (flinkJarPath != null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 266             File[] jars = new File(flinkJarPath).listFiles();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 267             for (File file : jars) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 268                 if (file.toURI().toURL().toString().contains(&quot;flink-dist&quot;)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 269                     clusterDescriptor.setLocalJarPath(new Path(file.toURI().toURL().toString()));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 270                 } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 271                     shipFiles.add(file);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 272                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 273             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 274         } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 275             throw new RuntimeException(&quot;The Flink jar path is null&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 276         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 277         // classpath , all node need contain plugin jar</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 278         String pluginLoadMode = launcherOptions.getPluginLoadMode();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 279         if (StringUtils.equalsIgnoreCase(pluginLoadMode, EPluginLoadMode.CLASSPATH.name())) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 280             fillJobGraphClassPath(jobGraph);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 281         } else if (StringUtils.equalsIgnoreCase(pluginLoadMode, EPluginLoadMode.SHIPFILE.name())) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 282             List&lt;File&gt; pluginPaths = getPluginPathToShipFiles(jobGraph);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 283             shipFiles.addAll(pluginPaths);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 284         } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 285             throw new IllegalArgumentException(&quot;Unsupported plugin loading mode &quot; + pluginLoadMode</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 286                     + &quot; Currently only classpath and shipfile are supported.&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 287         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 288 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 289         clusterDescriptor.addShipFiles(shipFiles);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 290         clusterDescriptor.setName(launcherOptions.getName());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 291         String queue = launcherOptions.getQueue();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 292         if (!Strings.isNullOrEmpty(queue)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 293             clusterDescriptor.setQueue(queue);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 294         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 295         return clusterDescriptor;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 296     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 297 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 298     private static void fillJobGraphClassPath(JobGraph jobGraph) throws MalformedURLException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 299         Map&lt;String, DistributedCache.DistributedCacheEntry&gt; jobCacheFileConfig = jobGraph.getUserArtifacts();"> 299         Map&lt;String, DistributedCache.DistributedCacheEntry&gt; jobCacheFileConfig = jobGraph.getUserArtifact🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 300         for(Map.Entry&lt;String,  DistributedCache.DistributedCacheEntry&gt; tmp : jobCacheFileConfig.entrySet()){"> 300         for(Map.Entry&lt;String,  DistributedCache.DistributedCacheEntry&gt; tmp : jobCacheFileConfig.entrySet(🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 301             if(tmp.getKey().startsWith(&quot;class_path&quot;)){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 302                 jobGraph.getClasspaths().add(new URL(&quot;file:&quot; + tmp.getValue().filePath));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 303             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 304         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 305     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 306 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 307     private List&lt;File&gt; getPluginPathToShipFiles(JobGraph jobGraph) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 308         List&lt;File&gt; shipFiles = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 309         Map&lt;String, DistributedCache.DistributedCacheEntry&gt; jobCacheFileConfig = jobGraph.getUserArtifacts();"> 309         Map&lt;String, DistributedCache.DistributedCacheEntry&gt; jobCacheFileConfig = jobGraph.getUserArtifact🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 310         for(Map.Entry&lt;String,  DistributedCache.DistributedCacheEntry&gt; tmp : jobCacheFileConfig.entrySet()){"> 310         for(Map.Entry&lt;String,  DistributedCache.DistributedCacheEntry&gt; tmp : jobCacheFileConfig.entrySet(🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 311             if(tmp.getKey().startsWith(&quot;class_path&quot;)){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 312                 shipFiles.add(new File(tmp.getValue().filePath));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 313             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 314         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 315         return shipFiles;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 316     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 317 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 318     private AbstractYarnClusterDescriptor getClusterDescriptor(</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 319             Configuration configuration,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 320             YarnConfiguration yarnConfiguration,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 321             String configurationDirectory) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 322         return new YarnClusterDescriptor(</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 323                 configuration,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 324                 yarnConfiguration,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 325                 configurationDirectory,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 326                 yarnClient,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 327                 false);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 328     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 329 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 330 }</span>
 331 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs</pre></td>
                            <td><pre>   1 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
   2 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   3 /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   4  * Licensed to the Apache Software Foundation (ASF) under one</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   5  * or more contributor license agreements.  See the NOTICE file</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   6  * distributed with this work for additional information</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   7  * regarding copyright ownership.  The ASF licenses this file</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   8  * to you under the Apache License, Version 2.0 (the</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   9  * &quot;License&quot;); you may not use this file except in compliance</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  10  * with the License.  You may obtain a copy of the License at</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  11  *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  12  * http://www.apache.org/licenses/LICENSE-2.0</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  13  *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  14  * Unless required by applicable law or agreed to in writing, software</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  15  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  16  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  17  * See the License for the specific language governing permissions and</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  18  * limitations under the License.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  19  */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  20 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  21 package com.dtstack.flink.sql.launcher.perjob;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  22 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  23 import com.dtstack.flink.sql.enums.EPluginLoadMode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  24 import com.dtstack.flink.sql.launcher.YarnConfLoader;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  25 import com.dtstack.flink.sql.option.Options;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  26 import org.apache.commons.lang3.StringUtils;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  27 import org.apache.flink.api.common.cache.DistributedCache;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  28 import org.apache.flink.configuration.Configuration;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  29 import com.google.common.base.Strings;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  30 import org.apache.flink.runtime.jobgraph.JobGraph;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  31 import org.apache.flink.runtime.security.SecurityConfiguration;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  32 import org.apache.flink.runtime.security.SecurityUtils;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  33 import org.apache.flink.yarn.AbstractYarnClusterDescriptor;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  34 import org.apache.flink.yarn.YarnClusterDescriptor;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  35 import org.apache.hadoop.fs.Path;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  36 import org.apache.hadoop.security.UserGroupInformation;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  37 import org.apache.hadoop.yarn.client.api.YarnClient;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  38 import org.apache.hadoop.yarn.conf.YarnConfiguration;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  39 import org.slf4j.Logger;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  40 import org.slf4j.LoggerFactory;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  41 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  42 import java.io.File;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  43 import java.io.IOException;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  44 import java.net.MalformedURLException;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  45 import java.net.URL;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  46 import java.util.ArrayList;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  47 import java.util.List;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  48 import java.util.Map;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  49 import java.util.Properties;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  50 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  51 /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  52  * Reason:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  53  * Date: 2018/11/16</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  54  * Company: www.dtstack.com</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  55  * @author xuchao</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  56  */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  57 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  58 public class PerJobClusterClientBuilder {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  59 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  60     private static final Logger LOG = LoggerFactory.getLogger(PerJobClusterClientBuilder.class);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  61 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  62     private static final String DEFAULT_CONF_DIR = &quot;./&quot;;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  63 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  64     private YarnClient yarnClient;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  65 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  66     private YarnConfiguration yarnConf;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  67 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  68     private Configuration flinkConfig;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  69 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="  70     public void init(String yarnConfDir, Configuration flinkConfig, Properties userConf) throws Exception {">  70     public void init(String yarnConfDir, Configuration flinkConfig, Properties userConf) throws Exception🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  71 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  72         if(Strings.isNullOrEmpty(yarnConfDir)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  73             throw new RuntimeException(&quot;parameters of yarn is required&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  74         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  75         userConf.forEach((key, val) -&gt; flinkConfig.setString(key.toString(), val.toString()));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  76         this.flinkConfig = flinkConfig;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  77         SecurityUtils.install(new SecurityConfiguration(flinkConfig));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  78 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  79         yarnConf = YarnConfLoader.getYarnConf(yarnConfDir);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  80         yarnClient = YarnClient.createYarnClient();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  81         yarnClient.init(yarnConf);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  82         yarnClient.start();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  83 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  84         System.out.println(&quot;----init yarn success ----&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  85     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  86 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="  87     public AbstractYarnClusterDescriptor createPerJobClusterDescriptor(String flinkJarPath, Options launcherOptions, JobGraph jobGraph)">  87     public AbstractYarnClusterDescriptor createPerJobClusterDescriptor(String flinkJarPath, Options launc🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  88             throws MalformedURLException {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  89 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="  90         String flinkConf = StringUtils.isEmpty(launcherOptions.getFlinkconf()) ? DEFAULT_CONF_DIR : launcherOptions.getFlinkconf();">  90         String flinkConf = StringUtils.isEmpty(launcherOptions.getFlinkconf()) ? DEFAULT_CONF_DIR : launc🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="  91         AbstractYarnClusterDescriptor clusterDescriptor = getClusterDescriptor(flinkConfig, yarnConf, flinkConf);">  91         AbstractYarnClusterDescriptor clusterDescriptor = getClusterDescriptor(flinkConfig, yarnConf, fli🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  92 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  93         if (StringUtils.isNotBlank(flinkJarPath)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  94             if (!new File(flinkJarPath).exists()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  95                 throw new RuntimeException(&quot;The param &#x27;-flinkJarPath&#x27; ref dir is not exist&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  96             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  97         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  98 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  99         List&lt;File&gt; shipFiles = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 100         if (flinkJarPath != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 101             File[] jars = new File(flinkJarPath).listFiles();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 102             for (File file : jars) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 103                 if (file.toURI().toURL().toString().contains(&quot;flink-dist&quot;)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 104                     clusterDescriptor.setLocalJarPath(new Path(file.toURI().toURL().toString()));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 105                 } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 106                     shipFiles.add(file);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 107                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 108             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 109         } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 110             throw new RuntimeException(&quot;The Flink jar path is null&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 111         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 112         // classpath , all node need contain plugin jar</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 113         String pluginLoadMode = launcherOptions.getPluginLoadMode();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 114         if (StringUtils.equalsIgnoreCase(pluginLoadMode, EPluginLoadMode.CLASSPATH.name())) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 115             fillJobGraphClassPath(jobGraph);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 116         } else if (StringUtils.equalsIgnoreCase(pluginLoadMode, EPluginLoadMode.SHIPFILE.name())) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 117             List&lt;File&gt; pluginPaths = getPluginPathToShipFiles(jobGraph);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 118             shipFiles.addAll(pluginPaths);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 119         } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 120             throw new IllegalArgumentException(&quot;Unsupported plugin loading mode &quot; + pluginLoadMode</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 121                     + &quot; Currently only classpath and shipfile are supported.&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 122         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 123 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 124         clusterDescriptor.addShipFiles(shipFiles);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 125         clusterDescriptor.setName(launcherOptions.getName());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 126         String queue = launcherOptions.getQueue();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 127         if (!Strings.isNullOrEmpty(queue)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 128             clusterDescriptor.setQueue(queue);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 129         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 130         return clusterDescriptor;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 131     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 132 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 133     private static void fillJobGraphClassPath(JobGraph jobGraph) throws MalformedURLException {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 134         Map&lt;String, DistributedCache.DistributedCacheEntry&gt; jobCacheFileConfig = jobGraph.getUserArtifacts();"> 134         Map&lt;String, DistributedCache.DistributedCacheEntry&gt; jobCacheFileConfig = jobGraph.getUserArtifact🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 135         for(Map.Entry&lt;String,  DistributedCache.DistributedCacheEntry&gt; tmp : jobCacheFileConfig.entrySet()){"> 135         for(Map.Entry&lt;String,  DistributedCache.DistributedCacheEntry&gt; tmp : jobCacheFileConfig.entrySet(🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 136             if(tmp.getKey().startsWith(&quot;class_path&quot;)){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 137                 jobGraph.getClasspaths().add(new URL(&quot;file:&quot; + tmp.getValue().filePath));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 138             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 139         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 140     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 141 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 142     private List&lt;File&gt; getPluginPathToShipFiles(JobGraph jobGraph) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 143         List&lt;File&gt; shipFiles = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 144         Map&lt;String, DistributedCache.DistributedCacheEntry&gt; jobCacheFileConfig = jobGraph.getUserArtifacts();"> 144         Map&lt;String, DistributedCache.DistributedCacheEntry&gt; jobCacheFileConfig = jobGraph.getUserArtifact🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 145         for(Map.Entry&lt;String,  DistributedCache.DistributedCacheEntry&gt; tmp : jobCacheFileConfig.entrySet()){"> 145         for(Map.Entry&lt;String,  DistributedCache.DistributedCacheEntry&gt; tmp : jobCacheFileConfig.entrySet(🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 146             if(tmp.getKey().startsWith(&quot;class_path&quot;)){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 147                 shipFiles.add(new File(tmp.getValue().filePath));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 148             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 149         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 150         return shipFiles;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 151     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 152 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 153     private AbstractYarnClusterDescriptor getClusterDescriptor(</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 154             Configuration configuration,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 155             YarnConfiguration yarnConfiguration,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 156             String configurationDirectory) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 157         return new YarnClusterDescriptor(</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 158                 configuration,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 159                 yarnConfiguration,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 160                 configurationDirectory,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 161                 yarnClient,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 162                 false);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 163     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 164 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 165 }</span>
 166 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 167 /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 168  * Licensed to the Apache Software Foundation (ASF) under one</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 169  * or more contributor license agreements.  See the NOTICE file</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 170  * distributed with this work for additional information</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 171  * regarding copyright ownership.  The ASF licenses this file</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 172  * to you under the Apache License, Version 2.0 (the</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 173  * &quot;License&quot;); you may not use this file except in compliance</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 174  * with the License.  You may obtain a copy of the License at</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 175  *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 176  * http://www.apache.org/licenses/LICENSE-2.0</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 177  *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 178  * Unless required by applicable law or agreed to in writing, software</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 179  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 180  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 181  * See the License for the specific language governing permissions and</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 182  * limitations under the License.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 183  */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 184 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 185 package com.dtstack.flink.sql.launcher.perjob;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 186 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 187 import com.dtstack.flink.sql.enums.EPluginLoadMode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 188 import com.dtstack.flink.sql.launcher.YarnConfLoader;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 189 import com.dtstack.flink.sql.option.Options;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 190 import com.esotericsoftware.minlog.Log;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 191 import org.apache.commons.lang3.StringUtils;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 192 import org.apache.flink.api.common.cache.DistributedCache;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 193 import org.apache.flink.configuration.Configuration;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 194 import com.google.common.base.Strings;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 195 import org.apache.flink.runtime.jobgraph.JobGraph;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 196 import org.apache.flink.runtime.security.SecurityConfiguration;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 197 import org.apache.flink.runtime.security.SecurityUtils;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 198 import org.apache.flink.yarn.AbstractYarnClusterDescriptor;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 199 import org.apache.flink.yarn.YarnClusterDescriptor;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 200 import org.apache.hadoop.fs.Path;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 201 import org.apache.hadoop.security.UserGroupInformation;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 202 import org.apache.hadoop.yarn.client.api.YarnClient;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 203 import org.apache.hadoop.yarn.conf.YarnConfiguration;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 204 import org.slf4j.Logger;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 205 import org.slf4j.LoggerFactory;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 206 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 207 import java.io.File;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 208 import java.io.IOException;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 209 import java.net.MalformedURLException;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 210 import java.net.URL;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 211 import java.util.ArrayList;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 212 import java.util.List;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 213 import java.util.Map;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 214 import java.util.Properties;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 215 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 216 /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 217  * Reason:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 218  * Date: 2018/11/16</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 219  * Company: www.dtstack.com</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 220  * @author xuchao</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 221  */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 222 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 223 public class PerJobClusterClientBuilder {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 224 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 225     private static final Logger LOG = LoggerFactory.getLogger(PerJobClusterClientBuilder.class);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 226 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 227     private static final String DEFAULT_CONF_DIR = &quot;./&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 228 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 229     private YarnClient yarnClient;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 230 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 231     private YarnConfiguration yarnConf;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 232 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 233     private Configuration flinkConfig;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 234 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 235     public void init(String yarnConfDir, Configuration flinkConfig, Properties userConf) throws Exception {"> 235     public void init(String yarnConfDir, Configuration flinkConfig, Properties userConf) throws Exception🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 236 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 237         if(Strings.isNullOrEmpty(yarnConfDir)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 238             throw new RuntimeException(&quot;parameters of yarn is required&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 239         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 240         userConf.forEach((key, val) -&gt; flinkConfig.setString(key.toString(), val.toString()));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 241         this.flinkConfig = flinkConfig;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 242         SecurityUtils.install(new SecurityConfiguration(flinkConfig));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 243 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 244         yarnConf = YarnConfLoader.getYarnConf(yarnConfDir);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 245         yarnClient = YarnClient.createYarnClient();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 246         yarnClient.init(yarnConf);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 247         yarnClient.start();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 248 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 249         Log.info(&quot;----init yarn success ----&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 250     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 251 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 252     public AbstractYarnClusterDescriptor createPerJobClusterDescriptor(String flinkJarPath, Options launcherOptions, JobGraph jobGraph)"> 252     public AbstractYarnClusterDescriptor createPerJobClusterDescriptor(String flinkJarPath, Options launc🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 253             throws MalformedURLException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 254 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 255         String flinkConf = StringUtils.isEmpty(launcherOptions.getFlinkconf()) ? DEFAULT_CONF_DIR : launcherOptions.getFlinkconf();"> 255         String flinkConf = StringUtils.isEmpty(launcherOptions.getFlinkconf()) ? DEFAULT_CONF_DIR : launc🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 256         AbstractYarnClusterDescriptor clusterDescriptor = getClusterDescriptor(flinkConfig, yarnConf, flinkConf);"> 256         AbstractYarnClusterDescriptor clusterDescriptor = getClusterDescriptor(flinkConfig, yarnConf, fli🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 257 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 258         if (StringUtils.isNotBlank(flinkJarPath)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 259             if (!new File(flinkJarPath).exists()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 260                 throw new RuntimeException(&quot;The param &#x27;-flinkJarPath&#x27; ref dir is not exist&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 261             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 262         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 263 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 264         List&lt;File&gt; shipFiles = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 265         if (flinkJarPath != null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 266             File[] jars = new File(flinkJarPath).listFiles();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 267             for (File file : jars) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 268                 if (file.toURI().toURL().toString().contains(&quot;flink-dist&quot;)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 269                     clusterDescriptor.setLocalJarPath(new Path(file.toURI().toURL().toString()));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 270                 } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 271                     shipFiles.add(file);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 272                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 273             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 274         } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 275             throw new RuntimeException(&quot;The Flink jar path is null&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 276         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 277         // classpath , all node need contain plugin jar</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 278         String pluginLoadMode = launcherOptions.getPluginLoadMode();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 279         if (StringUtils.equalsIgnoreCase(pluginLoadMode, EPluginLoadMode.CLASSPATH.name())) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 280             fillJobGraphClassPath(jobGraph);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 281         } else if (StringUtils.equalsIgnoreCase(pluginLoadMode, EPluginLoadMode.SHIPFILE.name())) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 282             List&lt;File&gt; pluginPaths = getPluginPathToShipFiles(jobGraph);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 283             shipFiles.addAll(pluginPaths);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 284         } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 285             throw new IllegalArgumentException(&quot;Unsupported plugin loading mode &quot; + pluginLoadMode</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 286                     + &quot; Currently only classpath and shipfile are supported.&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 287         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 288 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 289         clusterDescriptor.addShipFiles(shipFiles);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 290         clusterDescriptor.setName(launcherOptions.getName());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 291         String queue = launcherOptions.getQueue();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 292         if (!Strings.isNullOrEmpty(queue)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 293             clusterDescriptor.setQueue(queue);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 294         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 295         return clusterDescriptor;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 296     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 297 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 298     private static void fillJobGraphClassPath(JobGraph jobGraph) throws MalformedURLException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 299         Map&lt;String, DistributedCache.DistributedCacheEntry&gt; jobCacheFileConfig = jobGraph.getUserArtifacts();"> 299         Map&lt;String, DistributedCache.DistributedCacheEntry&gt; jobCacheFileConfig = jobGraph.getUserArtifact🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 300         for(Map.Entry&lt;String,  DistributedCache.DistributedCacheEntry&gt; tmp : jobCacheFileConfig.entrySet()){"> 300         for(Map.Entry&lt;String,  DistributedCache.DistributedCacheEntry&gt; tmp : jobCacheFileConfig.entrySet(🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 301             if(tmp.getKey().startsWith(&quot;class_path&quot;)){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 302                 jobGraph.getClasspaths().add(new URL(&quot;file:&quot; + tmp.getValue().filePath));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 303             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 304         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 305     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 306 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 307     private List&lt;File&gt; getPluginPathToShipFiles(JobGraph jobGraph) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 308         List&lt;File&gt; shipFiles = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 309         Map&lt;String, DistributedCache.DistributedCacheEntry&gt; jobCacheFileConfig = jobGraph.getUserArtifacts();"> 309         Map&lt;String, DistributedCache.DistributedCacheEntry&gt; jobCacheFileConfig = jobGraph.getUserArtifact🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 310         for(Map.Entry&lt;String,  DistributedCache.DistributedCacheEntry&gt; tmp : jobCacheFileConfig.entrySet()){"> 310         for(Map.Entry&lt;String,  DistributedCache.DistributedCacheEntry&gt; tmp : jobCacheFileConfig.entrySet(🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 311             if(tmp.getKey().startsWith(&quot;class_path&quot;)){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 312                 shipFiles.add(new File(tmp.getValue().filePath));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 313             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 314         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 315         return shipFiles;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 316     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 317 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 318     private AbstractYarnClusterDescriptor getClusterDescriptor(</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 319             Configuration configuration,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 320             YarnConfiguration yarnConfiguration,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 321             String configurationDirectory) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 322         return new YarnClusterDescriptor(</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 323                 configuration,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 324                 yarnConfiguration,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 325                 configurationDirectory,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 326                 yarnClient,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 327                 false);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 328     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 329 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 330 }</span>
 331 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS</pre></td>
                            <td><pre>   1 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
   2 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="   3 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/">   3 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kw🔵</abbr></span>
   4 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">   5 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">   6 /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">   7  * Licensed to the Apache Software Foundation (ASF) under one</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">   8  * or more contributor license agreements.  See the NOTICE file</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">   9  * distributed with this work for additional information</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  10  * regarding copyright ownership.  The ASF licenses this file</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  11  * to you under the Apache License, Version 2.0 (the</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  12  * &quot;License&quot;); you may not use this file except in compliance</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  13  * with the License.  You may obtain a copy of the License at</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  14  *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  15  * http://www.apache.org/licenses/LICENSE-2.0</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  16  *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  17  * Unless required by applicable law or agreed to in writing, software</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  18  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  19  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  20  * See the License for the specific language governing permissions and</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  21  * limitations under the License.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  22  */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  23 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  24 package com.dtstack.flink.sql.launcher.perjob;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  25 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  26 import com.dtstack.flink.sql.enums.EPluginLoadMode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  27 import com.dtstack.flink.sql.launcher.YarnConfLoader;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  28 import com.dtstack.flink.sql.option.Options;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  29 import com.esotericsoftware.minlog.Log;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  30 import org.apache.commons.lang3.StringUtils;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  31 import org.apache.flink.api.common.cache.DistributedCache;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  32 import org.apache.flink.configuration.Configuration;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  33 import com.google.common.base.Strings;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  34 import org.apache.flink.runtime.jobgraph.JobGraph;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  35 import org.apache.flink.runtime.security.SecurityConfiguration;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  36 import org.apache.flink.runtime.security.SecurityUtils;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  37 import org.apache.flink.yarn.AbstractYarnClusterDescriptor;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  38 import org.apache.flink.yarn.YarnClusterDescriptor;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  39 import org.apache.hadoop.fs.Path;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  40 import org.apache.hadoop.security.UserGroupInformation;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  41 import org.apache.hadoop.yarn.client.api.YarnClient;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  42 import org.apache.hadoop.yarn.conf.YarnConfiguration;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  43 import org.slf4j.Logger;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  44 import org.slf4j.LoggerFactory;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  45 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  46 import java.io.File;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  47 import java.io.IOException;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  48 import java.net.MalformedURLException;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  49 import java.net.URL;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  50 import java.util.ArrayList;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  51 import java.util.List;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  52 import java.util.Map;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  53 import java.util.Properties;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  54 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  55 /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  56  * Reason:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  57  * Date: 2018/11/16</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  58  * Company: www.dtstack.com</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  59  * @author xuchao</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  60  */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  61 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  62 public class PerJobClusterClientBuilder {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  63 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  64     private static final Logger LOG = LoggerFactory.getLogger(PerJobClusterClientBuilder.class);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  65 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  66     private static final String DEFAULT_CONF_DIR = &quot;./&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  67 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  68     private YarnClient yarnClient;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  69 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  70     private YarnConfiguration yarnConf;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  71 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  72     private Configuration flinkConfig;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  73 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title="  74     public void init(String yarnConfDir, Configuration flinkConfig, Properties userConf) throws Exception {">  74     public void init(String yarnConfDir, Configuration flinkConfig, Properties userConf) throws Exception🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  75 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  76         if(Strings.isNullOrEmpty(yarnConfDir)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  77             throw new RuntimeException(&quot;parameters of yarn is required&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  78         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  79         userConf.forEach((key, val) -&gt; flinkConfig.setString(key.toString(), val.toString()));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  80         this.flinkConfig = flinkConfig;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  81         SecurityUtils.install(new SecurityConfiguration(flinkConfig));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  82 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  83         yarnConf = YarnConfLoader.getYarnConf(yarnConfDir);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  84         yarnClient = YarnClient.createYarnClient();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  85         yarnClient.init(yarnConf);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  86         yarnClient.start();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  87 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  88         Log.info(&quot;----init yarn success ----&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  89     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  90 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title="  91     public AbstractYarnClusterDescriptor createPerJobClusterDescriptor(String flinkJarPath, Options launcherOptions, JobGraph jobGraph)">  91     public AbstractYarnClusterDescriptor createPerJobClusterDescriptor(String flinkJarPath, Options launc🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  92             throws MalformedURLException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  93 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title="  94         String flinkConf = StringUtils.isEmpty(launcherOptions.getFlinkconf()) ? DEFAULT_CONF_DIR : launcherOptions.getFlinkconf();">  94         String flinkConf = StringUtils.isEmpty(launcherOptions.getFlinkconf()) ? DEFAULT_CONF_DIR : launc🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title="  95         AbstractYarnClusterDescriptor clusterDescriptor = getClusterDescriptor(flinkConfig, yarnConf, flinkConf);">  95         AbstractYarnClusterDescriptor clusterDescriptor = getClusterDescriptor(flinkConfig, yarnConf, fli🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  96 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  97         if (StringUtils.isNotBlank(flinkJarPath)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  98             if (!new File(flinkJarPath).exists()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  99                 throw new RuntimeException(&quot;The param &#x27;-flinkJarPath&#x27; ref dir is not exist&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 100             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 101         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 102 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 103         List&lt;File&gt; shipFiles = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 104         if (flinkJarPath != null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 105             File[] jars = new File(flinkJarPath).listFiles();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 106             for (File file : jars) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 107                 if (file.toURI().toURL().toString().contains(&quot;flink-dist&quot;)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 108                     clusterDescriptor.setLocalJarPath(new Path(file.toURI().toURL().toString()));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 109                 } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 110                     shipFiles.add(file);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 111                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 112             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 113         } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 114             throw new RuntimeException(&quot;The Flink jar path is null&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 115         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 116         // classpath , all node need contain plugin jar</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 117         String pluginLoadMode = launcherOptions.getPluginLoadMode();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 118         if (StringUtils.equalsIgnoreCase(pluginLoadMode, EPluginLoadMode.CLASSPATH.name())) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 119             fillJobGraphClassPath(jobGraph);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 120         } else if (StringUtils.equalsIgnoreCase(pluginLoadMode, EPluginLoadMode.SHIPFILE.name())) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 121             List&lt;File&gt; pluginPaths = getPluginPathToShipFiles(jobGraph);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 122             shipFiles.addAll(pluginPaths);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 123         } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 124             throw new IllegalArgumentException(&quot;Unsupported plugin loading mode &quot; + pluginLoadMode</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 125                     + &quot; Currently only classpath and shipfile are supported.&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 126         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 127 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 128         clusterDescriptor.addShipFiles(shipFiles);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 129         clusterDescriptor.setName(launcherOptions.getName());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 130         String queue = launcherOptions.getQueue();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 131         if (!Strings.isNullOrEmpty(queue)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 132             clusterDescriptor.setQueue(queue);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 133         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 134         return clusterDescriptor;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 135     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 136 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 137     private static void fillJobGraphClassPath(JobGraph jobGraph) throws MalformedURLException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 138         Map&lt;String, DistributedCache.DistributedCacheEntry&gt; jobCacheFileConfig = jobGraph.getUserArtifacts();"> 138         Map&lt;String, DistributedCache.DistributedCacheEntry&gt; jobCacheFileConfig = jobGraph.getUserArtifact🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 139         for(Map.Entry&lt;String,  DistributedCache.DistributedCacheEntry&gt; tmp : jobCacheFileConfig.entrySet()){"> 139         for(Map.Entry&lt;String,  DistributedCache.DistributedCacheEntry&gt; tmp : jobCacheFileConfig.entrySet(🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 140             if(tmp.getKey().startsWith(&quot;class_path&quot;)){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 141                 jobGraph.getClasspaths().add(new URL(&quot;file:&quot; + tmp.getValue().filePath));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 142             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 143         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 144     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 145 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 146     private List&lt;File&gt; getPluginPathToShipFiles(JobGraph jobGraph) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 147         List&lt;File&gt; shipFiles = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 148         Map&lt;String, DistributedCache.DistributedCacheEntry&gt; jobCacheFileConfig = jobGraph.getUserArtifacts();"> 148         Map&lt;String, DistributedCache.DistributedCacheEntry&gt; jobCacheFileConfig = jobGraph.getUserArtifact🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 149         for(Map.Entry&lt;String,  DistributedCache.DistributedCacheEntry&gt; tmp : jobCacheFileConfig.entrySet()){"> 149         for(Map.Entry&lt;String,  DistributedCache.DistributedCacheEntry&gt; tmp : jobCacheFileConfig.entrySet(🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 150             if(tmp.getKey().startsWith(&quot;class_path&quot;)){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 151                 shipFiles.add(new File(tmp.getValue().filePath));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 152             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 153         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 154         return shipFiles;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 155     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 156 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 157     private AbstractYarnClusterDescriptor getClusterDescriptor(</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 158             Configuration configuration,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 159             YarnConfiguration yarnConfiguration,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 160             String configurationDirectory) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 161         return new YarnClusterDescriptor(</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 162                 configuration,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 163                 yarnConfiguration,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 164                 configurationDirectory,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 165                 yarnClient,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 166                 false);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 167     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 168 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 169 }</span>
 170 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre><span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   1 -/**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   2 - * Licensed to the Apache Software Foundation (ASF) under one</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   3 - * or more contributor license agreements.  See the NOTICE file</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   4 - * distributed with this work for additional information</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   5 - * regarding copyright ownership.  The ASF licenses this file</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   6 - * to you under the Apache License, Version 2.0 (the</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   7 - * &quot;License&quot;); you may not use this file except in compliance</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   8 - * with the License.  You may obtain a copy of the License at</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   9 - *</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  10 - * http://www.apache.org/licenses/LICENSE-2.0</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  11 - *</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  12 - * Unless required by applicable law or agreed to in writing, software</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  13 - * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  14 - * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  15 - * See the License for the specific language governing permissions and</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  16 - * limitations under the License.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  17 - */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  18 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  19 -package com.dtstack.flink.sql.launcher.perjob;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  20 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  21 -import com.dtstack.flink.sql.enums.EPluginLoadMode;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  22 -import com.dtstack.flink.sql.launcher.YarnConfLoader;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  23 -import com.dtstack.flink.sql.option.Options;</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  24 -import org.apache.commons.lang3.StringUtils;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  25 -import org.apache.flink.api.common.cache.DistributedCache;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  26 -import org.apache.flink.configuration.Configuration;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  27 -import com.google.common.base.Strings;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  28 -import org.apache.flink.runtime.jobgraph.JobGraph;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  29 -import org.apache.flink.runtime.security.SecurityConfiguration;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  30 -import org.apache.flink.runtime.security.SecurityUtils;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  31 -import org.apache.flink.yarn.AbstractYarnClusterDescriptor;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  32 -import org.apache.flink.yarn.YarnClusterDescriptor;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  33 -import org.apache.hadoop.fs.Path;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  34 -import org.apache.hadoop.security.UserGroupInformation;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  35 -import org.apache.hadoop.yarn.client.api.YarnClient;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  36 -import org.apache.hadoop.yarn.conf.YarnConfiguration;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  37 -import org.slf4j.Logger;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  38 -import org.slf4j.LoggerFactory;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  39 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  40 -import java.io.File;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  41 -import java.io.IOException;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  42 -import java.net.MalformedURLException;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  43 -import java.net.URL;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  44 -import java.util.ArrayList;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  45 -import java.util.List;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  46 -import java.util.Map;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  47 -import java.util.Properties;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  48 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  49 -/**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  50 - * Reason:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  51 - * Date: 2018/11/16</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  52 - * Company: www.dtstack.com</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  53 - * @author xuchao</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  54 - */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  55 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  56 -public class PerJobClusterClientBuilder {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  57 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  58 -    private static final Logger LOG = LoggerFactory.getLogger(PerJobClusterClientBuilder.class);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  59 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  60 -    private static final String DEFAULT_CONF_DIR = &quot;./&quot;;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  61 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  62 -    private YarnClient yarnClient;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  63 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  64 -    private YarnConfiguration yarnConf;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  65 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  66 -    private Configuration flinkConfig;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  67 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  68 -    public void init(String yarnConfDir, Configuration flinkConfig, Properties userConf) throws Exception {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  69 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  70 -        if(Strings.isNullOrEmpty(yarnConfDir)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  71 -            throw new RuntimeException(&quot;parameters of yarn is required&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  72 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  73 -        userConf.forEach((key, val) -&gt; flinkConfig.setString(key.toString(), val.toString()));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  74 -        this.flinkConfig = flinkConfig;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  75 -        SecurityUtils.install(new SecurityConfiguration(flinkConfig));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  76 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  77 -        yarnConf = YarnConfLoader.getYarnConf(yarnConfDir);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  78 -        yarnClient = YarnClient.createYarnClient();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  79 -        yarnClient.init(yarnConf);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  80 -        yarnClient.start();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  81 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  82 -        System.out.println(&quot;----init yarn success ----&quot;);</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  83 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  84 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title="  85 -    public AbstractYarnClusterDescriptor createPerJobClusterDescriptor(String flinkJarPath, Options launcherOptions, JobGraph jobGraph)">  85 -    public AbstractYarnClusterDescriptor createPerJobClusterDescriptor(String flinkJarPath, Options launcherOption🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  86 -            throws MalformedURLException {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  87 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title="  88 -        String flinkConf = StringUtils.isEmpty(launcherOptions.getFlinkconf()) ? DEFAULT_CONF_DIR : launcherOptions.getFlinkconf();">  88 -        String flinkConf = StringUtils.isEmpty(launcherOptions.getFlinkconf()) ? DEFAULT_CONF_DIR : launcherOption🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  89 -        AbstractYarnClusterDescriptor clusterDescriptor = getClusterDescriptor(flinkConfig, yarnConf, flinkConf);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  90 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  91 -        if (StringUtils.isNotBlank(flinkJarPath)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  92 -            if (!new File(flinkJarPath).exists()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  93 -                throw new RuntimeException(&quot;The param &#x27;-flinkJarPath&#x27; ref dir is not exist&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  94 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  95 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  96 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  97 -        List&lt;File&gt; shipFiles = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  98 -        if (flinkJarPath != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  99 -            File[] jars = new File(flinkJarPath).listFiles();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 100 -            for (File file : jars) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 101 -                if (file.toURI().toURL().toString().contains(&quot;flink-dist&quot;)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 102 -                    clusterDescriptor.setLocalJarPath(new Path(file.toURI().toURL().toString()));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 103 -                } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 104 -                    shipFiles.add(file);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 105 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 106 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 107 -        } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 108 -            throw new RuntimeException(&quot;The Flink jar path is null&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 109 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 110 -        // classpath , all node need contain plugin jar</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 111 -        String pluginLoadMode = launcherOptions.getPluginLoadMode();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 112 -        if (StringUtils.equalsIgnoreCase(pluginLoadMode, EPluginLoadMode.CLASSPATH.name())) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 113 -            fillJobGraphClassPath(jobGraph);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 114 -        } else if (StringUtils.equalsIgnoreCase(pluginLoadMode, EPluginLoadMode.SHIPFILE.name())) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 115 -            List&lt;File&gt; pluginPaths = getPluginPathToShipFiles(jobGraph);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 116 -            shipFiles.addAll(pluginPaths);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 117 -        } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 118 -            throw new IllegalArgumentException(&quot;Unsupported plugin loading mode &quot; + pluginLoadMode</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 119 -                    + &quot; Currently only classpath and shipfile are supported.&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 120 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 121 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 122 -        clusterDescriptor.addShipFiles(shipFiles);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 123 -        clusterDescriptor.setName(launcherOptions.getName());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 124 -        String queue = launcherOptions.getQueue();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 125 -        if (!Strings.isNullOrEmpty(queue)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 126 -            clusterDescriptor.setQueue(queue);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 127 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 128 -        return clusterDescriptor;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 129 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 130 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 131 -    private static void fillJobGraphClassPath(JobGraph jobGraph) throws MalformedURLException {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 132 -        Map&lt;String, DistributedCache.DistributedCacheEntry&gt; jobCacheFileConfig = jobGraph.getUserArtifacts();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 133 -        for(Map.Entry&lt;String,  DistributedCache.DistributedCacheEntry&gt; tmp : jobCacheFileConfig.entrySet()){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 134 -            if(tmp.getKey().startsWith(&quot;class_path&quot;)){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 135 -                jobGraph.getClasspaths().add(new URL(&quot;file:&quot; + tmp.getValue().filePath));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 136 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 137 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 138 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 139 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 140 -    private List&lt;File&gt; getPluginPathToShipFiles(JobGraph jobGraph) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 141 -        List&lt;File&gt; shipFiles = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 142 -        Map&lt;String, DistributedCache.DistributedCacheEntry&gt; jobCacheFileConfig = jobGraph.getUserArtifacts();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 143 -        for(Map.Entry&lt;String,  DistributedCache.DistributedCacheEntry&gt; tmp : jobCacheFileConfig.entrySet()){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 144 -            if(tmp.getKey().startsWith(&quot;class_path&quot;)){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 145 -                shipFiles.add(new File(tmp.getValue().filePath));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 146 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 147 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 148 -        return shipFiles;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 149 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 150 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 151 -    private AbstractYarnClusterDescriptor getClusterDescriptor(</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 152 -            Configuration configuration,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 153 -            YarnConfiguration yarnConfiguration,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 154 -            String configurationDirectory) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 155 -        return new YarnClusterDescriptor(</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 156 -                configuration,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 157 -                yarnConfiguration,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 158 -                configurationDirectory,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 159 -                yarnClient,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 160 -                false);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 161 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 162 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 163 -}</span></pre></td>
                            <td><pre>   1  /**
   2   * Licensed to the Apache Software Foundation (ASF) under one
   3   * or more contributor license agreements.  See the NOTICE file
   4   * distributed with this work for additional information
   5   * regarding copyright ownership.  The ASF licenses this file
   6   * to you under the Apache License, Version 2.0 (the
   7   * &quot;License&quot;); you may not use this file except in compliance
   8   * with the License.  You may obtain a copy of the License at
   9   *
  10   * http://www.apache.org/licenses/LICENSE-2.0
  11   *
  12   * Unless required by applicable law or agreed to in writing, software
  13   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15   * See the License for the specific language governing permissions and
  16   * limitations under the License.
  17   */
  18  
  19  package com.dtstack.flink.sql.launcher.perjob;
  20  
  21  import com.dtstack.flink.sql.enums.EPluginLoadMode;
  22  import com.dtstack.flink.sql.launcher.YarnConfLoader;
  23  import com.dtstack.flink.sql.option.Options;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  24 +import com.esotericsoftware.minlog.Log;</span>
  25  import org.apache.commons.lang3.StringUtils;
  26  import org.apache.flink.api.common.cache.DistributedCache;
  27  import org.apache.flink.configuration.Configuration;
  28  import com.google.common.base.Strings;
  29  import org.apache.flink.runtime.jobgraph.JobGraph;
  30  import org.apache.flink.runtime.security.SecurityConfiguration;
  31  import org.apache.flink.runtime.security.SecurityUtils;
  32  import org.apache.flink.yarn.AbstractYarnClusterDescriptor;
  33  import org.apache.flink.yarn.YarnClusterDescriptor;
  34  import org.apache.hadoop.fs.Path;
  35  import org.apache.hadoop.security.UserGroupInformation;
  36  import org.apache.hadoop.yarn.client.api.YarnClient;
  37  import org.apache.hadoop.yarn.conf.YarnConfiguration;
  38  import org.slf4j.Logger;
  39  import org.slf4j.LoggerFactory;
  40  
  41  import java.io.File;
  42  import java.io.IOException;
  43  import java.net.MalformedURLException;
  44  import java.net.URL;
  45  import java.util.ArrayList;
  46  import java.util.List;
  47  import java.util.Map;
  48  import java.util.Properties;
  49  
  50  /**
  51   * Reason:
  52   * Date: 2018/11/16
  53   * Company: www.dtstack.com
  54   * @author xuchao
  55   */
  56  
  57  public class PerJobClusterClientBuilder {
  58  
  59      private static final Logger LOG = LoggerFactory.getLogger(PerJobClusterClientBuilder.class);
  60  
  61      private static final String DEFAULT_CONF_DIR = &quot;./&quot;;
  62  
  63      private YarnClient yarnClient;
  64  
  65      private YarnConfiguration yarnConf;
  66  
  67      private Configuration flinkConfig;
  68  
  69      public void init(String yarnConfDir, Configuration flinkConfig, Properties userConf) throws Exception {
  70  
  71          if(Strings.isNullOrEmpty(yarnConfDir)) {
  72              throw new RuntimeException(&quot;parameters of yarn is required&quot;);
  73          }
  74          userConf.forEach((key, val) -&gt; flinkConfig.setString(key.toString(), val.toString()));
  75          this.flinkConfig = flinkConfig;
  76          SecurityUtils.install(new SecurityConfiguration(flinkConfig));
  77  
  78          yarnConf = YarnConfLoader.getYarnConf(yarnConfDir);
  79          yarnClient = YarnClient.createYarnClient();
  80          yarnClient.init(yarnConf);
  81          yarnClient.start();
  82  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  83 -        System.out.println(&quot;----init yarn success ----&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  84 +        Log.info(&quot;----init yarn success ----&quot;);</span>
  85      }
  86  
<abbr title="  87      public AbstractYarnClusterDescriptor createPerJobClusterDescriptor(String flinkJarPath, Options launcherOptions, JobGraph jobGraph)">  87      public AbstractYarnClusterDescriptor createPerJobClusterDescriptor(String flinkJarPath, Options launcherOption🔵</abbr>
  88              throws MalformedURLException {
  89  
<abbr title="  90          String flinkConf = StringUtils.isEmpty(launcherOptions.getFlinkconf()) ? DEFAULT_CONF_DIR : launcherOptions.getFlinkconf();">  90          String flinkConf = StringUtils.isEmpty(launcherOptions.getFlinkconf()) ? DEFAULT_CONF_DIR : launcherOption🔵</abbr>
  91          AbstractYarnClusterDescriptor clusterDescriptor = getClusterDescriptor(flinkConfig, yarnConf, flinkConf);
  92  
  93          if (StringUtils.isNotBlank(flinkJarPath)) {
  94              if (!new File(flinkJarPath).exists()) {
  95                  throw new RuntimeException(&quot;The param &#x27;-flinkJarPath&#x27; ref dir is not exist&quot;);
  96              }
  97          }
  98  
  99          List&lt;File&gt; shipFiles = new ArrayList&lt;&gt;();
 100          if (flinkJarPath != null) {
 101              File[] jars = new File(flinkJarPath).listFiles();
 102              for (File file : jars) {
 103                  if (file.toURI().toURL().toString().contains(&quot;flink-dist&quot;)) {
 104                      clusterDescriptor.setLocalJarPath(new Path(file.toURI().toURL().toString()));
 105                  } else {
 106                      shipFiles.add(file);
 107                  }
 108              }
 109          } else {
 110              throw new RuntimeException(&quot;The Flink jar path is null&quot;);
 111          }
 112          // classpath , all node need contain plugin jar
 113          String pluginLoadMode = launcherOptions.getPluginLoadMode();
 114          if (StringUtils.equalsIgnoreCase(pluginLoadMode, EPluginLoadMode.CLASSPATH.name())) {
 115              fillJobGraphClassPath(jobGraph);
 116          } else if (StringUtils.equalsIgnoreCase(pluginLoadMode, EPluginLoadMode.SHIPFILE.name())) {
 117              List&lt;File&gt; pluginPaths = getPluginPathToShipFiles(jobGraph);
 118              shipFiles.addAll(pluginPaths);
 119          } else {
 120              throw new IllegalArgumentException(&quot;Unsupported plugin loading mode &quot; + pluginLoadMode
 121                      + &quot; Currently only classpath and shipfile are supported.&quot;);
 122          }
 123  
 124          clusterDescriptor.addShipFiles(shipFiles);
 125          clusterDescriptor.setName(launcherOptions.getName());
 126          String queue = launcherOptions.getQueue();
 127          if (!Strings.isNullOrEmpty(queue)) {
 128              clusterDescriptor.setQueue(queue);
 129          }
 130          return clusterDescriptor;
 131      }
 132  
 133      private static void fillJobGraphClassPath(JobGraph jobGraph) throws MalformedURLException {
 134          Map&lt;String, DistributedCache.DistributedCacheEntry&gt; jobCacheFileConfig = jobGraph.getUserArtifacts();
 135          for(Map.Entry&lt;String,  DistributedCache.DistributedCacheEntry&gt; tmp : jobCacheFileConfig.entrySet()){
 136              if(tmp.getKey().startsWith(&quot;class_path&quot;)){
 137                  jobGraph.getClasspaths().add(new URL(&quot;file:&quot; + tmp.getValue().filePath));
 138              }
 139          }
 140      }
 141  
 142      private List&lt;File&gt; getPluginPathToShipFiles(JobGraph jobGraph) {
 143          List&lt;File&gt; shipFiles = new ArrayList&lt;&gt;();
 144          Map&lt;String, DistributedCache.DistributedCacheEntry&gt; jobCacheFileConfig = jobGraph.getUserArtifacts();
 145          for(Map.Entry&lt;String,  DistributedCache.DistributedCacheEntry&gt; tmp : jobCacheFileConfig.entrySet()){
 146              if(tmp.getKey().startsWith(&quot;class_path&quot;)){
 147                  shipFiles.add(new File(tmp.getValue().filePath));
 148              }
 149          }
 150          return shipFiles;
 151      }
 152  
 153      private AbstractYarnClusterDescriptor getClusterDescriptor(
 154              Configuration configuration,
 155              YarnConfiguration yarnConfiguration,
 156              String configurationDirectory) {
 157          return new YarnClusterDescriptor(
 158                  configuration,
 159                  yarnConfiguration,
 160                  configurationDirectory,
 161                  yarnClient,
 162                  false);
 163      }
 164  
 165  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            