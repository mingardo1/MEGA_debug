<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>182</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    182
                    <a href="181.html">prev</a>
                    <a href="183.html">next</a>
                    <a href="182_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    BroadleafCommerce/BroadleafCommerce_310203c9852593bd4f07481ea4d693d3096b6994_common/src/main/java/org/broadleafcommerce/common/dao/GenericEntityDaoImpl.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;310203c9852593bd4f07481ea4d693d3096b6994:common/src/main/java/org/broadleafcommerce/common/dao/GenericEntityDaoImpl.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;310203c9852593bd4f07481ea4d693d3096b6994^1:common/src/main/java/org/broadleafcommerce/common/dao/GenericEntityDaoImpl.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;310203c9852593bd4f07481ea4d693d3096b6994^2:common/src/main/java/org/broadleafcommerce/common/dao/GenericEntityDaoImpl.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;c2b9b7cebcb68adf6459f3932383315f3716ab81:common/src/main/java/org/broadleafcommerce/common/dao/GenericEntityDaoImpl.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[b], [sbj], [sbj]], subset: [[b], [sbj], [sbj]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Profile Web
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  * 
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 
  19 package org.broadleafcommerce.common.dao;
  20 
  21 import org.broadleafcommerce.common.persistence.EntityConfiguration;
  22 import org.broadleafcommerce.common.service.PersistenceService;
  23 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  24 import org.broadleafcommerce.common.util.HibernateUtils;</span>
  25 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  26 import org.broadleafcommerce.common.util.StreamingTransactionCapableUtil;</span>
  27 =======
  28 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
  29 import org.broadleafcommerce.common.util.StreamCapableTransactionalOperationAdapter;
  30 import org.broadleafcommerce.common.util.StreamingTransactionCapableUtil;
  31 import org.broadleafcommerce.common.util.TransactionUtils;
  32 import org.broadleafcommerce.common.util.dao.DynamicDaoHelperImpl;
  33 import org.broadleafcommerce.common.util.dao.TypedQueryBuilder;
  34 import org.hibernate.FlushMode;
  35 import org.hibernate.Session;
  36 import org.hibernate.type.AbstractSingleColumnStandardBasicType;
  37 import org.hibernate.type.IntegerType;
  38 import org.hibernate.type.LongType;
  39 import org.springframework.beans.BeansException;
  40 import org.springframework.beans.factory.NoSuchBeanDefinitionException;
  41 import org.springframework.context.ApplicationContext;
  42 import org.springframework.context.ApplicationContextAware;
  43 import org.springframework.stereotype.Repository;
  44 
  45 import java.io.Serializable;
  46 import java.lang.reflect.Field;
  47 import java.util.List;
  48 import java.util.Map;
  49 
  50 import javax.annotation.Resource;
  51 import javax.persistence.EntityManager;
  52 import javax.persistence.PersistenceContext;
  53 import javax.persistence.TypedQuery;
  54 import javax.persistence.criteria.CriteriaBuilder;
  55 import javax.persistence.criteria.CriteriaQuery;
  56 import javax.persistence.criteria.Root;
  57 
  58 
  59 @Repository(&quot;blGenericEntityDao&quot;)
  60 public class GenericEntityDaoImpl implements GenericEntityDao, ApplicationContextAware {
  61 
  62     private static ApplicationContext applicationContext;
  63     private static GenericEntityDaoImpl dao;
  64 
  65     public static GenericEntityDaoImpl getGenericEntityDao() {
  66         if (applicationContext == null) {
  67             return null;
  68         }
  69         if (dao == null) {
  70             dao = (GenericEntityDaoImpl) applicationContext.getBean(&quot;blGenericEntityDao&quot;);
  71         }
  72         return dao;
  73     }
  74 
  75     @PersistenceContext(unitName = &quot;blPU&quot;)
  76     protected EntityManager em;
  77 
  78     @Resource(name=&quot;blPersistenceService&quot;)
  79     protected PersistenceService persistenceService;
  80 
  81     @Resource(name = &quot;blEntityConfiguration&quot;)
  82     protected EntityConfiguration entityConfiguration;
  83 
  84     @Resource(name = &quot;blStreamingTransactionCapableUtil&quot;)
  85     protected StreamingTransactionCapableUtil transactionUtil;
  86 
  87     @Resource(name=&quot;blPersistenceService&quot;)
  88     protected PersistenceService persistenceService;
  89 
  90     protected DynamicDaoHelperImpl daoHelper = new DynamicDaoHelperImpl();
  91 
  92     @Override
  93     public void setApplicationContext(ApplicationContext applicationContext) throws BeansException {
  94         this.applicationContext = applicationContext;
  95     }
  96 
  97     @Override
  98     public &lt;T&gt; T readGenericEntity(Class&lt;T&gt; clazz, Object id) {
  99         clazz = (Class&lt;T&gt;) DynamicDaoHelperImpl.getNonProxyImplementationClassIfNecessary(clazz);
 100 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 101         //We need to get PU dynamically to handle cases when class is not in blPU, e.g ScheduledJobImpl</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 102         EntityManager emForClass = getEntityManager(clazz);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 103         Map&lt;String, Object&gt; md = daoHelper.getIdMetadata(clazz, emForClass);</span>
 104 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 105             id = Long.parseLong(String.valueOf(id));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 106         } else if (type instanceof IntegerType) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 107             id = Integer.parseInt(String.valueOf(id));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 108         }</span>
 109 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 110         EntityManager entityManager = persistenceService.identifyEntityManager(clazz);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 111         Map&lt;String, Object&gt; md = daoHelper.getIdMetadata(clazz, entityManager);</span>
 112 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
<abbr title=" 113         AbstractSingleColumnStandardBasicType type = (AbstractSingleColumnStandardBasicType) md.get(&quot;type&quot;);"> 113         AbstractSingleColumnStandardBasicType type = (AbstractSingleColumnStandardBasicType) md.get(&quot;typeðŸ”µ</abbr>
 114 
 115         if (type instanceof LongType) {
 116             id = Long.parseLong(String.valueOf(id));
 117         } else if (type instanceof IntegerType) {
 118             id = Integer.parseInt(String.valueOf(id));
 119         }
 120 
 121 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 122         return HibernateUtils.deproxy(emForClass.find(clazz, id));</span>
 123 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 124         clazz = (Class&lt;T&gt;) DynamicDaoHelperImpl.getNonProxyImplementationClassIfNecessary(clazz);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 125         TypedQuery&lt;Long&gt; q = new TypedQueryBuilder&lt;T&gt;(clazz, &quot;root&quot;).toCountQuery(em);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 126         return q.getSingleResult();</span>
 127 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 128         return entityManager.find(clazz, id);</span>
 129 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 130     }
 131 
 132     @Override
 133     public &lt;T&gt; Long readCountGenericEntity(Class&lt;T&gt; clazz) {
 134         clazz = (Class&lt;T&gt;) DynamicDaoHelperImpl.getNonProxyImplementationClassIfNecessary(clazz);
<abbr title=" 135         TypedQuery&lt;Long&gt; q = new TypedQueryBuilder&lt;T&gt;(clazz, &quot;root&quot;).toCountQuery(persistenceService.identifyEntityManager(clazz));"> 135         TypedQuery&lt;Long&gt; q = new TypedQueryBuilder&lt;T&gt;(clazz, &quot;root&quot;).toCountQuery(persistenceService.idenðŸ”µ</abbr>
 136         return q.getSingleResult();
 137     }
 138 
 139     @Override
 140     public &lt;T&gt; List&lt;T&gt; readAllGenericEntity(Class&lt;T&gt; clazz, int limit, int offset) {
 141         clazz = (Class&lt;T&gt;) DynamicDaoHelperImpl.getNonProxyImplementationClassIfNecessary(clazz);
<abbr title=" 142         TypedQuery&lt;T&gt; q = new TypedQueryBuilder&lt;T&gt;(clazz, &quot;root&quot;).toQuery(persistenceService.identifyEntityManager(clazz));"> 142         TypedQuery&lt;T&gt; q = new TypedQueryBuilder&lt;T&gt;(clazz, &quot;root&quot;).toQuery(persistenceService.identifyEntiðŸ”µ</abbr>
 143         q.setMaxResults(limit);
 144         q.setFirstResult(offset);
 145         return q.getResultList();
 146     }
 147 
 148     @Override
 149     public &lt;T&gt; List&lt;T&gt; readAllGenericEntity(Class&lt;T&gt; clazz) {
 150         clazz = (Class&lt;T&gt;) DynamicDaoHelperImpl.getNonProxyImplementationClassIfNecessary(clazz);
<abbr title=" 151         TypedQuery&lt;T&gt; q = new TypedQueryBuilder&lt;T&gt;(clazz, &quot;root&quot;).toQuery(persistenceService.identifyEntityManager(clazz));"> 151         TypedQuery&lt;T&gt; q = new TypedQueryBuilder&lt;T&gt;(clazz, &quot;root&quot;).toQuery(persistenceService.identifyEntiðŸ”µ</abbr>
 152         return q.getResultList();
 153     }
 154 
 155     @Override
 156     public List&lt;Long&gt; readAllGenericEntityId(Class&lt;?&gt; clazz) {
 157         clazz = DynamicDaoHelperImpl.getNonProxyImplementationClassIfNecessary(clazz);
 158         EntityManager entityManager = persistenceService.identifyEntityManager(clazz);
 159         CriteriaBuilder builder = entityManager.getCriteriaBuilder();
 160         CriteriaQuery&lt;Long&gt; criteria = builder.createQuery(Long.class);
 161         Root root = criteria.from(clazz);
 162         criteria.select(root.get(getIdField(clazz).getName()).as(Long.class));
 163         criteria.orderBy(builder.asc(root.get(getIdField(clazz).getName())));
 164 
 165         return entityManager.createQuery(criteria).getResultList();
 166     }
 167 
 168     @Override
 169     public Class&lt;?&gt; getImplClass(String className) {
 170         Class&lt;?&gt; clazz = null;
 171         try {
 172             clazz = entityConfiguration.lookupEntityClass(className);
 173         } catch (NoSuchBeanDefinitionException e) {
 174             //do nothing
 175         }
 176         if (clazz == null) {
 177             clazz = getCeilingImplClass(className);
 178         }
 179         return clazz;
 180     }
 181 
 182     @Override
 183     public Class&lt;?&gt; getCeilingImplClass(final String className) {
 184         final Class&lt;?&gt;[] clazz = new Class&lt;?&gt;[1];
 185         try {
 186             clazz[0] = Class.forName(className);
 187         } catch (ClassNotFoundException e) {
 188             throw new RuntimeException(e);
 189         }
<abbr title=" 190         //em.unwrap requires a transactional entity manager. We&#x27;ll only take the hit to start a transaction here if one has not already been started."> 190         //em.unwrap requires a transactional entity manager. We&#x27;ll only take the hit to start a transactiðŸ”µ</abbr>
<abbr title=" 191         transactionUtil.runOptionalTransactionalOperation(new StreamCapableTransactionalOperationAdapter() {"> 191         transactionUtil.runOptionalTransactionalOperation(new StreamCapableTransactionalOperationAdapter(ðŸ”µ</abbr>
 192             @Override
 193             public void execute() throws Throwable {
<abbr title=" 194                 Class&lt;?&gt;[] entitiesFromCeiling = daoHelper.getAllPolymorphicEntitiesFromCeiling(clazz[0], true, true);"> 194                 Class&lt;?&gt;[] entitiesFromCeiling = daoHelper.getAllPolymorphicEntitiesFromCeiling(clazz[0],ðŸ”µ</abbr>
 195                 if (entitiesFromCeiling == null || entitiesFromCeiling.length &lt; 1) {
 196                     clazz[0] = DynamicDaoHelperImpl.getNonProxyImplementationClassIfNecessary(clazz[0]);
<abbr title=" 197                     entitiesFromCeiling = daoHelper.getAllPolymorphicEntitiesFromCeiling(clazz[0], true, true);"> 197                     entitiesFromCeiling = daoHelper.getAllPolymorphicEntitiesFromCeiling(clazz[0], true, ðŸ”µ</abbr>
 198                 }
 199                 if (entitiesFromCeiling == null || entitiesFromCeiling.length &lt; 1) {
<abbr title=" 200                     throw new IllegalArgumentException(String.format(&quot;Unable to find ceiling implementation for the requested class name (%s)&quot;, className));"> 200                     throw new IllegalArgumentException(String.format(&quot;Unable to find ceiling implementatiðŸ”µ</abbr>
 201                 }
 202                 clazz[0] = entitiesFromCeiling[entitiesFromCeiling.length - 1];
 203             }
 204         }, RuntimeException.class, !TransactionUtils.isTransactionalEntityManager(em));
 205         return clazz[0];
 206     }
 207 
 208     @Override
 209     public Serializable getIdentifier(Object entity) {
 210         return daoHelper.getIdentifier(entity);
 211     }
 212 
 213     protected Field getIdField(Class&lt;?&gt; clazz) {
 214         return daoHelper.getIdField(clazz);
 215     }
 216 
 217     @Override
 218     public &lt;T&gt; T save(T object) {
 219         return em.merge(object);
 220     }
 221 
 222     @Override
 223     public void persist(Object object) {
 224         em.persist(object);
 225     }
 226 
 227     @Override
 228     public void remove(Object object) {
 229         em.remove(object);
 230     }
 231 
 232     @Override
 233     public void flush() {
 234         em.flush();
 235     }
 236 
 237     @Override
 238     public void clearAutoFlushMode() {
 239         em.unwrap(Session.class).setHibernateFlushMode(FlushMode.MANUAL);
 240     }
 241 
 242     @Override
 243     public void enableAutoFlushMode() {
 244         em.unwrap(Session.class).setHibernateFlushMode(FlushMode.AUTO);
 245     }
 246 
 247     @Override
 248     public void clear() {
 249         em.clear();
 250     }
 251 
 252     @Override
 253     public boolean sessionContains(Object object) {
 254         return em.contains(object);
 255     }
 256 
 257     @Override
 258     public boolean idAssigned(Object object) {
 259         return getIdentifier(object) != null;
 260     }
 261 
 262     @Override
 263     public EntityManager getEntityManager() {
 264         return em;
 265     }
 266 
 267     protected EntityManager getEntityManager(Class clazz) {
 268         return persistenceService.identifyEntityManager(clazz);
 269     }
 270 }</pre></td>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Profile Web
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  *
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 
  19 package org.broadleafcommerce.common.dao;
  20 
  21 import org.broadleafcommerce.common.persistence.EntityConfiguration;
  22 import org.broadleafcommerce.common.service.PersistenceService;
  23 import org.broadleafcommerce.common.util.HibernateUtils;
  24 import org.broadleafcommerce.common.util.StreamCapableTransactionalOperationAdapter;
  25 import org.broadleafcommerce.common.util.StreamingTransactionCapableUtil;
  26 import org.broadleafcommerce.common.util.TransactionUtils;
  27 import org.broadleafcommerce.common.util.dao.DynamicDaoHelperImpl;
  28 import org.broadleafcommerce.common.util.dao.TypedQueryBuilder;
  29 import org.hibernate.FlushMode;
  30 import org.hibernate.Session;
  31 import org.hibernate.type.AbstractSingleColumnStandardBasicType;
  32 import org.hibernate.type.IntegerType;
  33 import org.hibernate.type.LongType;
  34 import org.springframework.beans.BeansException;
  35 import org.springframework.beans.factory.NoSuchBeanDefinitionException;
  36 import org.springframework.context.ApplicationContext;
  37 import org.springframework.context.ApplicationContextAware;
  38 import org.springframework.stereotype.Repository;
  39 
  40 import java.io.Serializable;
  41 import java.lang.reflect.Field;
  42 import java.util.List;
  43 import java.util.Map;
  44 
  45 import javax.annotation.Resource;
  46 import javax.persistence.EntityManager;
  47 import javax.persistence.PersistenceContext;
  48 import javax.persistence.TypedQuery;
  49 import javax.persistence.criteria.CriteriaBuilder;
  50 import javax.persistence.criteria.CriteriaQuery;
  51 import javax.persistence.criteria.Root;
  52 
  53 
  54 @Repository(&quot;blGenericEntityDao&quot;)
  55 public class GenericEntityDaoImpl implements GenericEntityDao, ApplicationContextAware {
  56 
  57     private static ApplicationContext applicationContext;
  58     private static GenericEntityDaoImpl dao;
  59 
  60     public static GenericEntityDaoImpl getGenericEntityDao() {
  61         if (applicationContext == null) {
  62             return null;
  63         }
  64         if (dao == null) {
  65             dao = (GenericEntityDaoImpl) applicationContext.getBean(&quot;blGenericEntityDao&quot;);
  66         }
  67         return dao;
  68     }
  69 
  70     @PersistenceContext(unitName = &quot;blPU&quot;)
  71     protected EntityManager em;
  72 
  73     @Resource(name = &quot;blEntityConfiguration&quot;)
  74     protected EntityConfiguration entityConfiguration;
  75 
  76     @Resource(name = &quot;blStreamingTransactionCapableUtil&quot;)
  77     protected StreamingTransactionCapableUtil transactionUtil;
  78 
  79     @Resource(name=&quot;blPersistenceService&quot;)
  80     protected PersistenceService persistenceService;
  81 
  82     protected DynamicDaoHelperImpl daoHelper = new DynamicDaoHelperImpl();
  83 
  84     @Override
  85     public void setApplicationContext(ApplicationContext applicationContext) throws BeansException {
  86         this.applicationContext = applicationContext;
  87     }
  88 
  89     @Override
  90     public &lt;T&gt; T readGenericEntity(Class&lt;T&gt; clazz, Object id) {
  91         clazz = (Class&lt;T&gt;) DynamicDaoHelperImpl.getNonProxyImplementationClassIfNecessary(clazz);
  92 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  93         //We need to get PU dynamically to handle cases when class is not in blPU, e.g ScheduledJobImpl</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  94         EntityManager emForClass = getEntityManager(clazz);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  95         Map&lt;String, Object&gt; md = daoHelper.getIdMetadata(clazz, emForClass);</span>
  96 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  97         Map&lt;String, Object&gt; md = daoHelper.getIdMetadata(clazz, em);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="  98         AbstractSingleColumnStandardBasicType type = (AbstractSingleColumnStandardBasicType) md.get(&quot;type&quot;);">  98         AbstractSingleColumnStandardBasicType type = (AbstractSingleColumnStandardBasicType) md.get(&quot;typeðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  99 </span>
 100 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 101         EntityManager entityManager = persistenceService.identifyEntityManager(clazz);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 102         Map&lt;String, Object&gt; md = daoHelper.getIdMetadata(clazz, entityManager);</span>
 103 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
<abbr title=" 104         AbstractSingleColumnStandardBasicType type = (AbstractSingleColumnStandardBasicType) md.get(&quot;type&quot;);"> 104         AbstractSingleColumnStandardBasicType type = (AbstractSingleColumnStandardBasicType) md.get(&quot;typeðŸ”µ</abbr>
 105 
 106         if (type instanceof LongType) {
 107             id = Long.parseLong(String.valueOf(id));
 108         } else if (type instanceof IntegerType) {
 109             id = Integer.parseInt(String.valueOf(id));
 110         }
 111 
 112 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 113         return HibernateUtils.deproxy(emForClass.find(clazz, id));</span>
 114 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 115     }</span>
 116 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 117         return entityManager.find(clazz, id);</span>
 118 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 119     }
 120 
 121     @Override
 122     public &lt;T&gt; Long readCountGenericEntity(Class&lt;T&gt; clazz) {
 123         clazz = (Class&lt;T&gt;) DynamicDaoHelperImpl.getNonProxyImplementationClassIfNecessary(clazz);
<abbr title=" 124         TypedQuery&lt;Long&gt; q = new TypedQueryBuilder&lt;T&gt;(clazz, &quot;root&quot;).toCountQuery(persistenceService.identifyEntityManager(clazz));"> 124         TypedQuery&lt;Long&gt; q = new TypedQueryBuilder&lt;T&gt;(clazz, &quot;root&quot;).toCountQuery(persistenceService.idenðŸ”µ</abbr>
 125         return q.getSingleResult();
 126     }
 127 
 128     @Override
 129     public &lt;T&gt; List&lt;T&gt; readAllGenericEntity(Class&lt;T&gt; clazz, int limit, int offset) {
 130         clazz = (Class&lt;T&gt;) DynamicDaoHelperImpl.getNonProxyImplementationClassIfNecessary(clazz);
<abbr title=" 131         TypedQuery&lt;T&gt; q = new TypedQueryBuilder&lt;T&gt;(clazz, &quot;root&quot;).toQuery(persistenceService.identifyEntityManager(clazz));"> 131         TypedQuery&lt;T&gt; q = new TypedQueryBuilder&lt;T&gt;(clazz, &quot;root&quot;).toQuery(persistenceService.identifyEntiðŸ”µ</abbr>
 132         q.setMaxResults(limit);
 133         q.setFirstResult(offset);
 134         return q.getResultList();
 135     }
 136 
 137     @Override
 138     public &lt;T&gt; List&lt;T&gt; readAllGenericEntity(Class&lt;T&gt; clazz) {
 139         clazz = (Class&lt;T&gt;) DynamicDaoHelperImpl.getNonProxyImplementationClassIfNecessary(clazz);
<abbr title=" 140         TypedQuery&lt;T&gt; q = new TypedQueryBuilder&lt;T&gt;(clazz, &quot;root&quot;).toQuery(persistenceService.identifyEntityManager(clazz));"> 140         TypedQuery&lt;T&gt; q = new TypedQueryBuilder&lt;T&gt;(clazz, &quot;root&quot;).toQuery(persistenceService.identifyEntiðŸ”µ</abbr>
 141         return q.getResultList();
 142     }
 143 
 144     @Override
 145     public List&lt;Long&gt; readAllGenericEntityId(Class&lt;?&gt; clazz) {
 146         clazz = DynamicDaoHelperImpl.getNonProxyImplementationClassIfNecessary(clazz);
 147         EntityManager entityManager = persistenceService.identifyEntityManager(clazz);
 148         CriteriaBuilder builder = entityManager.getCriteriaBuilder();
 149         CriteriaQuery&lt;Long&gt; criteria = builder.createQuery(Long.class);
 150         Root root = criteria.from(clazz);
 151         criteria.select(root.get(getIdField(clazz).getName()).as(Long.class));
 152         criteria.orderBy(builder.asc(root.get(getIdField(clazz).getName())));
 153 
 154         return entityManager.createQuery(criteria).getResultList();
 155     }
 156 
 157     @Override
 158     public Class&lt;?&gt; getImplClass(String className) {
 159         Class&lt;?&gt; clazz = null;
 160         try {
 161             clazz = entityConfiguration.lookupEntityClass(className);
 162         } catch (NoSuchBeanDefinitionException e) {
 163             //do nothing
 164         }
 165         if (clazz == null) {
 166             clazz = getCeilingImplClass(className);
 167         }
 168         return clazz;
 169     }
 170 
 171     @Override
 172     public Class&lt;?&gt; getCeilingImplClass(final String className) {
 173         final Class&lt;?&gt;[] clazz = new Class&lt;?&gt;[1];
 174         try {
 175             clazz[0] = Class.forName(className);
 176         } catch (ClassNotFoundException e) {
 177             throw new RuntimeException(e);
 178         }
<abbr title=" 179         //em.unwrap requires a transactional entity manager. We&#x27;ll only take the hit to start a transaction here if one has not already been started."> 179         //em.unwrap requires a transactional entity manager. We&#x27;ll only take the hit to start a transactiðŸ”µ</abbr>
<abbr title=" 180         transactionUtil.runOptionalTransactionalOperation(new StreamCapableTransactionalOperationAdapter() {"> 180         transactionUtil.runOptionalTransactionalOperation(new StreamCapableTransactionalOperationAdapter(ðŸ”µ</abbr>
 181             @Override
 182             public void execute() throws Throwable {
<abbr title=" 183                 Class&lt;?&gt;[] entitiesFromCeiling = daoHelper.getAllPolymorphicEntitiesFromCeiling(clazz[0], true, true);"> 183                 Class&lt;?&gt;[] entitiesFromCeiling = daoHelper.getAllPolymorphicEntitiesFromCeiling(clazz[0],ðŸ”µ</abbr>
 184                 if (entitiesFromCeiling == null || entitiesFromCeiling.length &lt; 1) {
 185                     clazz[0] = DynamicDaoHelperImpl.getNonProxyImplementationClassIfNecessary(clazz[0]);
<abbr title=" 186                     entitiesFromCeiling = daoHelper.getAllPolymorphicEntitiesFromCeiling(clazz[0], true, true);"> 186                     entitiesFromCeiling = daoHelper.getAllPolymorphicEntitiesFromCeiling(clazz[0], true, ðŸ”µ</abbr>
 187                 }
 188                 if (entitiesFromCeiling == null || entitiesFromCeiling.length &lt; 1) {
<abbr title=" 189                     throw new IllegalArgumentException(String.format(&quot;Unable to find ceiling implementation for the requested class name (%s)&quot;, className));"> 189                     throw new IllegalArgumentException(String.format(&quot;Unable to find ceiling implementatiðŸ”µ</abbr>
 190                 }
 191                 clazz[0] = entitiesFromCeiling[entitiesFromCeiling.length - 1];
 192             }
 193         }, RuntimeException.class, !TransactionUtils.isTransactionalEntityManager(em));
 194         return clazz[0];
 195     }
 196 
 197     @Override
 198     public Serializable getIdentifier(Object entity) {
 199         return daoHelper.getIdentifier(entity);
 200     }
 201 
 202     protected Field getIdField(Class&lt;?&gt; clazz) {
 203         return daoHelper.getIdField(clazz);
 204     }
 205 
 206     @Override
 207     public &lt;T&gt; T save(T object) {
 208         return em.merge(object);
 209     }
 210 
 211     @Override
 212     public void persist(Object object) {
 213         em.persist(object);
 214     }
 215 
 216     @Override
 217     public void remove(Object object) {
 218         em.remove(object);
 219     }
 220 
 221     @Override
 222     public void flush() {
 223         em.flush();
 224     }
 225 
 226     @Override
 227     public void clearAutoFlushMode() {
 228         em.unwrap(Session.class).setHibernateFlushMode(FlushMode.MANUAL);
 229     }
 230 
 231     @Override
 232     public void enableAutoFlushMode() {
 233         em.unwrap(Session.class).setHibernateFlushMode(FlushMode.AUTO);
 234     }
 235 
 236     @Override
 237     public void clear() {
 238         em.clear();
 239     }
 240 
 241     @Override
 242     public boolean sessionContains(Object object) {
 243         return em.contains(object);
 244     }
 245 
 246     @Override
 247     public boolean idAssigned(Object object) {
 248         return getIdentifier(object) != null;
 249     }
 250 
 251     @Override
 252     public EntityManager getEntityManager() {
 253         return em;
 254     }
 255 
 256     protected EntityManager getEntityManager(Class clazz) {
 257         return persistenceService.identifyEntityManager(clazz);
 258     }
 259 }
 
 
 
 
 
 
 
 
 
 </pre></td>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Profile Web
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  *
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.common.dao;
  19 
  20 import java.io.Serializable;
  21 import java.lang.reflect.Field;
  22 import java.util.List;
  23 import java.util.Map;
  24 import javax.annotation.Resource;
  25 import javax.persistence.EntityManager;
  26 import javax.persistence.PersistenceContext;
  27 import javax.persistence.TypedQuery;
  28 import javax.persistence.criteria.CriteriaBuilder;
  29 import javax.persistence.criteria.CriteriaQuery;
  30 import javax.persistence.criteria.Root;
  31 import org.broadleafcommerce.common.persistence.EntityConfiguration;
  32 import org.broadleafcommerce.common.service.PersistenceService;
  33 import org.broadleafcommerce.common.util.HibernateUtils;
  34 import org.broadleafcommerce.common.util.StreamCapableTransactionalOperationAdapter;
  35 import org.broadleafcommerce.common.util.StreamingTransactionCapableUtil;
  36 import org.broadleafcommerce.common.util.TransactionUtils;
  37 import org.broadleafcommerce.common.util.dao.DynamicDaoHelperImpl;
  38 import org.broadleafcommerce.common.util.dao.TypedQueryBuilder;
  39 import org.hibernate.FlushMode;
  40 import org.hibernate.Session;
  41 import org.hibernate.type.AbstractSingleColumnStandardBasicType;
  42 import org.hibernate.type.IntegerType;
  43 import org.hibernate.type.LongType;
  44 import org.springframework.beans.BeansException;
  45 import org.springframework.beans.factory.NoSuchBeanDefinitionException;
  46 import org.springframework.context.ApplicationContext;
  47 import org.springframework.context.ApplicationContextAware;
  48 import org.springframework.stereotype.Repository;
  49 
  50 
  51 @Repository(&quot;blGenericEntityDao&quot;)
  52 public class GenericEntityDaoImpl implements GenericEntityDao, ApplicationContextAware {
  53 
  54     private static ApplicationContext applicationContext;
  55     private static GenericEntityDaoImpl dao;
  56 
  57     public static GenericEntityDaoImpl getGenericEntityDao() {
  58         if (applicationContext == null) {
  59             return null;
  60         }
  61         if (dao == null) {
  62             dao = (GenericEntityDaoImpl) applicationContext.getBean(&quot;blGenericEntityDao&quot;);
  63         }
  64         return dao;
  65     }
  66 
  67     @PersistenceContext(unitName = &quot;blPU&quot;)
  68     protected EntityManager em;
  69 
  70     @Resource(name=&quot;blPersistenceService&quot;)
  71     protected PersistenceService persistenceService;
  72 
  73     @Resource(name = &quot;blEntityConfiguration&quot;)
  74     protected EntityConfiguration entityConfiguration;
  75 
  76     @Resource(name = &quot;blStreamingTransactionCapableUtil&quot;)
  77     protected StreamingTransactionCapableUtil transactionUtil;
  78 
  79     @Resource(name=&quot;blPersistenceService&quot;)
  80     protected PersistenceService persistenceService;
  81 
  82     protected DynamicDaoHelperImpl daoHelper = new DynamicDaoHelperImpl();
  83 
  84     @Override
  85     public void setApplicationContext(ApplicationContext applicationContext) throws BeansException {
  86         this.applicationContext = applicationContext;
  87     }
  88 
  89     @Override
  90     public &lt;T&gt; T readGenericEntity(Class&lt;T&gt; clazz, Object id) {
  91         clazz = (Class&lt;T&gt;) DynamicDaoHelperImpl.getNonProxyImplementationClassIfNecessary(clazz);
  92 
  93 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  94         //We need to get PU dynamically to handle cases when class is not in blPU, e.g ScheduledJobImpl</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  95         EntityManager emForClass = getEntityManager(clazz);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  96         Map&lt;String, Object&gt; md = daoHelper.getIdMetadata(clazz, emForClass);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  97 </span>
  98 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="  99 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/">  99 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwðŸ”µ</abbr></span>
 100 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 101 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 102         EntityManager entityManager = persistenceService.identifyEntityManager(clazz);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 103         Map&lt;String, Object&gt; md = daoHelper.getIdMetadata(clazz, entityManager);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 104 </span>
 105 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
<abbr title=" 106         AbstractSingleColumnStandardBasicType type = (AbstractSingleColumnStandardBasicType) md.get(&quot;type&quot;);"> 106         AbstractSingleColumnStandardBasicType type = (AbstractSingleColumnStandardBasicType) md.get(&quot;typeðŸ”µ</abbr>
 107 
 108         if (type instanceof LongType) {
 109             id = Long.parseLong(String.valueOf(id));
 110         } else if (type instanceof IntegerType) {
 111             id = Integer.parseInt(String.valueOf(id));
 112         }
 113 
 114 
 115 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 116         return HibernateUtils.deproxy(emForClass.find(clazz, id));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 117 </span>
 118 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 119 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 119 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwðŸ”µ</abbr></span>
 120 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 121 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 122         return entityManager.find(clazz, id);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 123 </span>
 124 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 125     }
 126 
 127     @Override
 128     public &lt;T&gt; Long readCountGenericEntity(Class&lt;T&gt; clazz) {
 129         clazz = (Class&lt;T&gt;) DynamicDaoHelperImpl.getNonProxyImplementationClassIfNecessary(clazz);
<abbr title=" 130         TypedQuery&lt;Long&gt; q = new TypedQueryBuilder&lt;T&gt;(clazz, &quot;root&quot;).toCountQuery(persistenceService.identifyEntityManager(clazz));"> 130         TypedQuery&lt;Long&gt; q = new TypedQueryBuilder&lt;T&gt;(clazz, &quot;root&quot;).toCountQuery(persistenceService.idenðŸ”µ</abbr>
 131         return q.getSingleResult();
 132     }
 133 
 134     @Override
 135     public &lt;T&gt; List&lt;T&gt; readAllGenericEntity(Class&lt;T&gt; clazz, int limit, int offset) {
 136         clazz = (Class&lt;T&gt;) DynamicDaoHelperImpl.getNonProxyImplementationClassIfNecessary(clazz);
<abbr title=" 137         TypedQuery&lt;T&gt; q = new TypedQueryBuilder&lt;T&gt;(clazz, &quot;root&quot;).toQuery(persistenceService.identifyEntityManager(clazz));"> 137         TypedQuery&lt;T&gt; q = new TypedQueryBuilder&lt;T&gt;(clazz, &quot;root&quot;).toQuery(persistenceService.identifyEntiðŸ”µ</abbr>
 138         q.setMaxResults(limit);
 139         q.setFirstResult(offset);
 140         return q.getResultList();
 141     }
 142 
 143     @Override
 144     public &lt;T&gt; List&lt;T&gt; readAllGenericEntity(Class&lt;T&gt; clazz) {
 145         clazz = (Class&lt;T&gt;) DynamicDaoHelperImpl.getNonProxyImplementationClassIfNecessary(clazz);
<abbr title=" 146         TypedQuery&lt;T&gt; q = new TypedQueryBuilder&lt;T&gt;(clazz, &quot;root&quot;).toQuery(persistenceService.identifyEntityManager(clazz));"> 146         TypedQuery&lt;T&gt; q = new TypedQueryBuilder&lt;T&gt;(clazz, &quot;root&quot;).toQuery(persistenceService.identifyEntiðŸ”µ</abbr>
 147         return q.getResultList();
 148     }
 149 
 150     @Override
 151     public List&lt;Long&gt; readAllGenericEntityId(Class&lt;?&gt; clazz) {
 152         clazz = DynamicDaoHelperImpl.getNonProxyImplementationClassIfNecessary(clazz);
 153         EntityManager entityManager = persistenceService.identifyEntityManager(clazz);
 154         CriteriaBuilder builder = entityManager.getCriteriaBuilder();
 155         CriteriaQuery&lt;Long&gt; criteria = builder.createQuery(Long.class);
 156         Root root = criteria.from(clazz);
 157         criteria.select(root.get(getIdField(clazz).getName()).as(Long.class));
 158         criteria.orderBy(builder.asc(root.get(getIdField(clazz).getName())));
 159 
 160         return entityManager.createQuery(criteria).getResultList();
 161     }
 162 
 163     @Override
 164     public Class&lt;?&gt; getImplClass(String className) {
 165         Class&lt;?&gt; clazz = null;
 166         try {
 167             clazz = entityConfiguration.lookupEntityClass(className);
 168         } catch (NoSuchBeanDefinitionException e) {
 169             //do nothing
 170         }
 171         if (clazz == null) {
 172             clazz = getCeilingImplClass(className);
 173         }
 174         return clazz;
 175     }
 176 
 177     @Override
 178     public Class&lt;?&gt; getCeilingImplClass(final String className) {
 179         final Class&lt;?&gt;[] clazz = new Class&lt;?&gt;[1];
 180         try {
 181             clazz[0] = Class.forName(className);
 182         } catch (ClassNotFoundException e) {
 183             throw new RuntimeException(e);
 184         }
<abbr title=" 185         //em.unwrap requires a transactional entity manager. We&#x27;ll only take the hit to start a transaction here if one has not already been started."> 185         //em.unwrap requires a transactional entity manager. We&#x27;ll only take the hit to start a transactiðŸ”µ</abbr>
<abbr title=" 186         transactionUtil.runOptionalTransactionalOperation(new StreamCapableTransactionalOperationAdapter() {"> 186         transactionUtil.runOptionalTransactionalOperation(new StreamCapableTransactionalOperationAdapter(ðŸ”µ</abbr>
 187             @Override
 188             public void execute() throws Throwable {
<abbr title=" 189                 Class&lt;?&gt;[] entitiesFromCeiling = daoHelper.getAllPolymorphicEntitiesFromCeiling(clazz[0], true, true);"> 189                 Class&lt;?&gt;[] entitiesFromCeiling = daoHelper.getAllPolymorphicEntitiesFromCeiling(clazz[0],ðŸ”µ</abbr>
 190                 if (entitiesFromCeiling == null || entitiesFromCeiling.length &lt; 1) {
 191                     clazz[0] = DynamicDaoHelperImpl.getNonProxyImplementationClassIfNecessary(clazz[0]);
<abbr title=" 192                     entitiesFromCeiling = daoHelper.getAllPolymorphicEntitiesFromCeiling(clazz[0], true, true);"> 192                     entitiesFromCeiling = daoHelper.getAllPolymorphicEntitiesFromCeiling(clazz[0], true, ðŸ”µ</abbr>
 193                 }
 194                 if (entitiesFromCeiling == null || entitiesFromCeiling.length &lt; 1) {
<abbr title=" 195                     throw new IllegalArgumentException(String.format(&quot;Unable to find ceiling implementation for the requested class name (%s)&quot;, className));"> 195                     throw new IllegalArgumentException(String.format(&quot;Unable to find ceiling implementatiðŸ”µ</abbr>
 196                 }
 197                 clazz[0] = entitiesFromCeiling[entitiesFromCeiling.length - 1];
 198             }
 199         }, RuntimeException.class, !TransactionUtils.isTransactionalEntityManager(em));
 200         return clazz[0];
 201     }
 202 
 203     @Override
 204     public Serializable getIdentifier(Object entity) {
 205         return daoHelper.getIdentifier(entity);
 206     }
 207 
 208     protected Field getIdField(Class&lt;?&gt; clazz) {
 209         return daoHelper.getIdField(clazz);
 210     }
 211 
 212     @Override
 213     public &lt;T&gt; T save(T object) {
 214         return em.merge(object);
 215     }
 216 
 217     @Override
 218     public void persist(Object object) {
 219         em.persist(object);
 220     }
 221 
 222     @Override
 223     public void remove(Object object) {
 224         em.remove(object);
 225     }
 226 
 227     @Override
 228     public void flush() {
 229         em.flush();
 230     }
 231 
 232     @Override
 233     public void clearAutoFlushMode() {
 234         em.unwrap(Session.class).setHibernateFlushMode(FlushMode.MANUAL);
 235     }
 236 
 237     @Override
 238     public void enableAutoFlushMode() {
 239         em.unwrap(Session.class).setHibernateFlushMode(FlushMode.AUTO);
 240     }
 241 
 242     @Override
 243     public void clear() {
 244         em.clear();
 245     }
 246 
 247     @Override
 248     public boolean sessionContains(Object object) {
 249         return em.contains(object);
 250     }
 251 
 252     @Override
 253     public boolean idAssigned(Object object) {
 254         return getIdentifier(object) != null;
 255     }
 256 
 257     @Override
 258     public EntityManager getEntityManager() {
 259         return em;
 260     }
 261 
 262     protected EntityManager getEntityManager(Class clazz) {
 263         return persistenceService.identifyEntityManager(clazz);
 264     }
 265 }
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  /*
   2   * #%L
   3   * BroadleafCommerce Profile Web
   4   * %%
   5   * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6   * %%
   7   * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8   * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9   * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10   * the Broadleaf End User License Agreement (EULA), Version 1.1
  11   * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12   * shall apply.
  13   *
<abbr title="  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr>
  15   * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.
  16   * #L%
  17   */
  18  
  19  package org.broadleafcommerce.common.dao;
  20  
  21  import org.broadleafcommerce.common.persistence.EntityConfiguration;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  22 +import org.broadleafcommerce.common.service.PersistenceService;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  23 +import org.broadleafcommerce.common.util.HibernateUtils;</span>
  24  import org.broadleafcommerce.common.util.StreamCapableTransactionalOperationAdapter;
  25  import org.broadleafcommerce.common.util.StreamingTransactionCapableUtil;
  26  import org.broadleafcommerce.common.util.TransactionUtils;
  27  import org.broadleafcommerce.common.util.dao.DynamicDaoHelperImpl;
  28  import org.broadleafcommerce.common.util.dao.TypedQueryBuilder;
  29  import org.hibernate.FlushMode;
  30  import org.hibernate.Session;
  31  import org.hibernate.type.AbstractSingleColumnStandardBasicType;
  32  import org.hibernate.type.IntegerType;
  33  import org.hibernate.type.LongType;
  34  import org.springframework.beans.BeansException;
  35  import org.springframework.beans.factory.NoSuchBeanDefinitionException;
  36  import org.springframework.context.ApplicationContext;
  37  import org.springframework.context.ApplicationContextAware;
  38  import org.springframework.stereotype.Repository;
  39  
  40  import java.io.Serializable;
  41  import java.lang.reflect.Field;
  42  import java.util.List;
  43  import java.util.Map;
  44  
  45  import javax.annotation.Resource;
  46  import javax.persistence.EntityManager;
  47  import javax.persistence.PersistenceContext;
  48  import javax.persistence.TypedQuery;
  49  import javax.persistence.criteria.CriteriaBuilder;
  50  import javax.persistence.criteria.CriteriaQuery;
  51  import javax.persistence.criteria.Root;
  52  
  53  
  54  @Repository(&quot;blGenericEntityDao&quot;)
  55  public class GenericEntityDaoImpl implements GenericEntityDao, ApplicationContextAware {
  56  
  57      private static ApplicationContext applicationContext;
  58      private static GenericEntityDaoImpl dao;
  59  
  60      public static GenericEntityDaoImpl getGenericEntityDao() {
  61          if (applicationContext == null) {
  62              return null;
  63          }
  64          if (dao == null) {
  65              dao = (GenericEntityDaoImpl) applicationContext.getBean(&quot;blGenericEntityDao&quot;);
  66          }
  67          return dao;
  68      }
  69  
  70      @PersistenceContext(unitName = &quot;blPU&quot;)
  71      protected EntityManager em;
  72  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  73 +    @Resource(name=&quot;blPersistenceService&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  74 +    protected PersistenceService persistenceService;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  75 +</span>
  76      @Resource(name = &quot;blEntityConfiguration&quot;)
  77      protected EntityConfiguration entityConfiguration;
  78  
  79      @Resource(name = &quot;blStreamingTransactionCapableUtil&quot;)
  80      protected StreamingTransactionCapableUtil transactionUtil;
  81  



  82      protected DynamicDaoHelperImpl daoHelper = new DynamicDaoHelperImpl();
  83  
  84      @Override
  85      public void setApplicationContext(ApplicationContext applicationContext) throws BeansException {
  86          this.applicationContext = applicationContext;
  87      }
  88  
  89      @Override
  90      public &lt;T&gt; T readGenericEntity(Class&lt;T&gt; clazz, Object id) {
  91          clazz = (Class&lt;T&gt;) DynamicDaoHelperImpl.getNonProxyImplementationClassIfNecessary(clazz);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  92 -        Map&lt;String, Object&gt; md = daoHelper.getIdMetadata(clazz, em);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  93 +        //We need to get PU dynamically to handle cases when class is not in blPU, e.g ScheduledJobImpl</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  94 +        EntityManager emForClass = getEntityManager(clazz);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  95 +        Map&lt;String, Object&gt; md = daoHelper.getIdMetadata(clazz, emForClass);</span>
  96          AbstractSingleColumnStandardBasicType type = (AbstractSingleColumnStandardBasicType) md.get(&quot;type&quot;);
  97  
  98          if (type instanceof LongType) {
  99              id = Long.parseLong(String.valueOf(id));
 100          } else if (type instanceof IntegerType) {
 101              id = Integer.parseInt(String.valueOf(id));
 102          }
 103  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 104 -        return em.find(clazz, id);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 105 +        return HibernateUtils.deproxy(emForClass.find(clazz, id));</span>
 106      }
 107  
 108      @Override
 109      public &lt;T&gt; Long readCountGenericEntity(Class&lt;T&gt; clazz) {
 110          clazz = (Class&lt;T&gt;) DynamicDaoHelperImpl.getNonProxyImplementationClassIfNecessary(clazz);
 111          TypedQuery&lt;Long&gt; q = new TypedQueryBuilder&lt;T&gt;(clazz, &quot;root&quot;).toCountQuery(em);

 112          return q.getSingleResult();
 113      }
 114  
 115      @Override
 116      public &lt;T&gt; List&lt;T&gt; readAllGenericEntity(Class&lt;T&gt; clazz, int limit, int offset) {
 117          clazz = (Class&lt;T&gt;) DynamicDaoHelperImpl.getNonProxyImplementationClassIfNecessary(clazz);
 118          TypedQuery&lt;T&gt; q = new TypedQueryBuilder&lt;T&gt;(clazz, &quot;root&quot;).toQuery(em);

 119          q.setMaxResults(limit);
 120          q.setFirstResult(offset);
 121          return q.getResultList();
 122      }
 123  
 124      @Override
 125      public &lt;T&gt; List&lt;T&gt; readAllGenericEntity(Class&lt;T&gt; clazz) {
 126          clazz = (Class&lt;T&gt;) DynamicDaoHelperImpl.getNonProxyImplementationClassIfNecessary(clazz);
 127          TypedQuery&lt;T&gt; q = new TypedQueryBuilder&lt;T&gt;(clazz, &quot;root&quot;).toQuery(em);

 128          return q.getResultList();
 129      }
 130  
 131      @Override
 132      public List&lt;Long&gt; readAllGenericEntityId(Class&lt;?&gt; clazz) {
 133          clazz = DynamicDaoHelperImpl.getNonProxyImplementationClassIfNecessary(clazz);
 134          CriteriaBuilder builder = em.getCriteriaBuilder();


 135          CriteriaQuery&lt;Long&gt; criteria = builder.createQuery(Long.class);
 136          Root root = criteria.from(clazz);
 137          criteria.select(root.get(getIdField(clazz).getName()).as(Long.class));
 138          criteria.orderBy(builder.asc(root.get(getIdField(clazz).getName())));
 139  
 140          return em.createQuery(criteria).getResultList();

 141      }
 142  
 143      @Override
 144      public Class&lt;?&gt; getImplClass(String className) {
 145          Class&lt;?&gt; clazz = null;
 146          try {
 147              clazz = entityConfiguration.lookupEntityClass(className);
 148          } catch (NoSuchBeanDefinitionException e) {
 149              //do nothing
 150          }
 151          if (clazz == null) {
 152              clazz = getCeilingImplClass(className);
 153          }
 154          return clazz;
 155      }
 156  
 157      @Override
 158      public Class&lt;?&gt; getCeilingImplClass(final String className) {
 159          final Class&lt;?&gt;[] clazz = new Class&lt;?&gt;[1];
 160          try {
 161              clazz[0] = Class.forName(className);
 162          } catch (ClassNotFoundException e) {
 163              throw new RuntimeException(e);
 164          }
<abbr title=" 165          //em.unwrap requires a transactional entity manager. We&#x27;ll only take the hit to start a transaction here if one has not already been started."> 165          //em.unwrap requires a transactional entity manager. We&#x27;ll only take the hit to start a transaction here iðŸ”µ</abbr>
 166          transactionUtil.runOptionalTransactionalOperation(new StreamCapableTransactionalOperationAdapter() {
 167              @Override
 168              public void execute() throws Throwable {
<abbr title=" 169                  Class&lt;?&gt;[] entitiesFromCeiling = daoHelper.getAllPolymorphicEntitiesFromCeiling(clazz[0], true, true);"> 169                  Class&lt;?&gt;[] entitiesFromCeiling = daoHelper.getAllPolymorphicEntitiesFromCeiling(clazz[0], true, trðŸ”µ</abbr>
 170                  if (entitiesFromCeiling == null || entitiesFromCeiling.length &lt; 1) {
 171                      clazz[0] = DynamicDaoHelperImpl.getNonProxyImplementationClassIfNecessary(clazz[0]);
 172                      entitiesFromCeiling = daoHelper.getAllPolymorphicEntitiesFromCeiling(clazz[0], true, true);
 173                  }
 174                  if (entitiesFromCeiling == null || entitiesFromCeiling.length &lt; 1) {
<abbr title=" 175                      throw new IllegalArgumentException(String.format(&quot;Unable to find ceiling implementation for the requested class name (%s)&quot;, className));"> 175                      throw new IllegalArgumentException(String.format(&quot;Unable to find ceiling implementation for thðŸ”µ</abbr>
 176                  }
 177                  clazz[0] = entitiesFromCeiling[entitiesFromCeiling.length - 1];
 178              }
 179          }, RuntimeException.class, !TransactionUtils.isTransactionalEntityManager(em));
 180          return clazz[0];
 181      }
 182  
 183      @Override
 184      public Serializable getIdentifier(Object entity) {
 185          return daoHelper.getIdentifier(entity);
 186      }
 187  
 188      protected Field getIdField(Class&lt;?&gt; clazz) {
 189          return daoHelper.getIdField(clazz);
 190      }
 191  
 192      @Override
 193      public &lt;T&gt; T save(T object) {
 194          return em.merge(object);
 195      }
 196  
 197      @Override
 198      public void persist(Object object) {
 199          em.persist(object);
 200      }
 201  
 202      @Override
 203      public void remove(Object object) {
 204          em.remove(object);
 205      }
 206  
 207      @Override
 208      public void flush() {
 209          em.flush();
 210      }
 211  
 212      @Override
 213      public void clearAutoFlushMode() {
 214          em.unwrap(Session.class).setHibernateFlushMode(FlushMode.MANUAL);
 215      }
 216  
 217      @Override
 218      public void enableAutoFlushMode() {
 219          em.unwrap(Session.class).setHibernateFlushMode(FlushMode.AUTO);
 220      }
 221  
 222      @Override
 223      public void clear() {
 224          em.clear();
 225      }
 226  
 227      @Override
 228      public boolean sessionContains(Object object) {
 229          return em.contains(object);
 230      }
 231  
 232      @Override
 233      public boolean idAssigned(Object object) {
 234          return getIdentifier(object) != null;
 235      }
 236  
 237      @Override
 238      public EntityManager getEntityManager() {
 239          return em;
 240      }
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 241 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 242 +    protected EntityManager getEntityManager(Class clazz) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 243 +        return persistenceService.identifyEntityManager(clazz);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 244 +    }</span>
 245  }</pre></td>
                            <td><pre>   1  /*
   2   * #%L
   3   * BroadleafCommerce Profile Web
   4   * %%
   5   * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6   * %%
   7   * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8   * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9   * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10   * the Broadleaf End User License Agreement (EULA), Version 1.1
  11   * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12   * shall apply.
  13   *
<abbr title="  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr>
  15   * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.
  16   * #L%
  17   */
  18  
  19  package org.broadleafcommerce.common.dao;
  20  
  21  import org.broadleafcommerce.common.persistence.EntityConfiguration;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  22 +import org.broadleafcommerce.common.service.PersistenceService;</span>

  23  import org.broadleafcommerce.common.util.StreamCapableTransactionalOperationAdapter;
  24  import org.broadleafcommerce.common.util.StreamingTransactionCapableUtil;
  25  import org.broadleafcommerce.common.util.TransactionUtils;
  26  import org.broadleafcommerce.common.util.dao.DynamicDaoHelperImpl;
  27  import org.broadleafcommerce.common.util.dao.TypedQueryBuilder;
  28  import org.hibernate.FlushMode;
  29  import org.hibernate.Session;
  30  import org.hibernate.type.AbstractSingleColumnStandardBasicType;
  31  import org.hibernate.type.IntegerType;
  32  import org.hibernate.type.LongType;
  33  import org.springframework.beans.BeansException;
  34  import org.springframework.beans.factory.NoSuchBeanDefinitionException;
  35  import org.springframework.context.ApplicationContext;
  36  import org.springframework.context.ApplicationContextAware;
  37  import org.springframework.stereotype.Repository;
  38  
  39  import java.io.Serializable;
  40  import java.lang.reflect.Field;
  41  import java.util.List;
  42  import java.util.Map;
  43  
  44  import javax.annotation.Resource;
  45  import javax.persistence.EntityManager;
  46  import javax.persistence.PersistenceContext;
  47  import javax.persistence.TypedQuery;
  48  import javax.persistence.criteria.CriteriaBuilder;
  49  import javax.persistence.criteria.CriteriaQuery;
  50  import javax.persistence.criteria.Root;
  51  
  52  
  53  @Repository(&quot;blGenericEntityDao&quot;)
  54  public class GenericEntityDaoImpl implements GenericEntityDao, ApplicationContextAware {
  55  
  56      private static ApplicationContext applicationContext;
  57      private static GenericEntityDaoImpl dao;
  58  
  59      public static GenericEntityDaoImpl getGenericEntityDao() {
  60          if (applicationContext == null) {
  61              return null;
  62          }
  63          if (dao == null) {
  64              dao = (GenericEntityDaoImpl) applicationContext.getBean(&quot;blGenericEntityDao&quot;);
  65          }
  66          return dao;
  67      }
  68  
  69      @PersistenceContext(unitName = &quot;blPU&quot;)
  70      protected EntityManager em;
  71  



  72      @Resource(name = &quot;blEntityConfiguration&quot;)
  73      protected EntityConfiguration entityConfiguration;
  74  
  75      @Resource(name = &quot;blStreamingTransactionCapableUtil&quot;)
  76      protected StreamingTransactionCapableUtil transactionUtil;
  77  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  78 +    @Resource(name=&quot;blPersistenceService&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  79 +    protected PersistenceService persistenceService;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  80 +</span>
  81      protected DynamicDaoHelperImpl daoHelper = new DynamicDaoHelperImpl();
  82  
  83      @Override
  84      public void setApplicationContext(ApplicationContext applicationContext) throws BeansException {
  85          this.applicationContext = applicationContext;
  86      }
  87  
  88      @Override
  89      public &lt;T&gt; T readGenericEntity(Class&lt;T&gt; clazz, Object id) {
  90          clazz = (Class&lt;T&gt;) DynamicDaoHelperImpl.getNonProxyImplementationClassIfNecessary(clazz);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  91 -        Map&lt;String, Object&gt; md = daoHelper.getIdMetadata(clazz, em);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  92 +        EntityManager entityManager = persistenceService.identifyEntityManager(clazz);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  93 +        Map&lt;String, Object&gt; md = daoHelper.getIdMetadata(clazz, entityManager);</span>

  94          AbstractSingleColumnStandardBasicType type = (AbstractSingleColumnStandardBasicType) md.get(&quot;type&quot;);
  95  
  96          if (type instanceof LongType) {
  97              id = Long.parseLong(String.valueOf(id));
  98          } else if (type instanceof IntegerType) {
  99              id = Integer.parseInt(String.valueOf(id));
 100          }
 101  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 102 -        return em.find(clazz, id);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 103 +        return entityManager.find(clazz, id);</span>
 104      }
 105  
 106      @Override
 107      public &lt;T&gt; Long readCountGenericEntity(Class&lt;T&gt; clazz) {
 108          clazz = (Class&lt;T&gt;) DynamicDaoHelperImpl.getNonProxyImplementationClassIfNecessary(clazz);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 109 -        TypedQuery&lt;Long&gt; q = new TypedQueryBuilder&lt;T&gt;(clazz, &quot;root&quot;).toCountQuery(em);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 110 +        TypedQuery&lt;Long&gt; q = new TypedQueryBuilder&lt;T&gt;(clazz, &quot;root&quot;).toCountQuery(persistenceService.identifyEntityManager(clazz));"> 110 +        TypedQuery&lt;Long&gt; q = new TypedQueryBuilder&lt;T&gt;(clazz, &quot;root&quot;).toCountQuery(persistenceService.identifyEntitðŸ”µ</abbr></span>
 111          return q.getSingleResult();
 112      }
 113  
 114      @Override
 115      public &lt;T&gt; List&lt;T&gt; readAllGenericEntity(Class&lt;T&gt; clazz, int limit, int offset) {
 116          clazz = (Class&lt;T&gt;) DynamicDaoHelperImpl.getNonProxyImplementationClassIfNecessary(clazz);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 117 -        TypedQuery&lt;T&gt; q = new TypedQueryBuilder&lt;T&gt;(clazz, &quot;root&quot;).toQuery(em);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 118 +        TypedQuery&lt;T&gt; q = new TypedQueryBuilder&lt;T&gt;(clazz, &quot;root&quot;).toQuery(persistenceService.identifyEntityManager(clazz));"> 118 +        TypedQuery&lt;T&gt; q = new TypedQueryBuilder&lt;T&gt;(clazz, &quot;root&quot;).toQuery(persistenceService.identifyEntityManagerðŸ”µ</abbr></span>
 119          q.setMaxResults(limit);
 120          q.setFirstResult(offset);
 121          return q.getResultList();
 122      }
 123  
 124      @Override
 125      public &lt;T&gt; List&lt;T&gt; readAllGenericEntity(Class&lt;T&gt; clazz) {
 126          clazz = (Class&lt;T&gt;) DynamicDaoHelperImpl.getNonProxyImplementationClassIfNecessary(clazz);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 127 -        TypedQuery&lt;T&gt; q = new TypedQueryBuilder&lt;T&gt;(clazz, &quot;root&quot;).toQuery(em);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 128 +        TypedQuery&lt;T&gt; q = new TypedQueryBuilder&lt;T&gt;(clazz, &quot;root&quot;).toQuery(persistenceService.identifyEntityManager(clazz));"> 128 +        TypedQuery&lt;T&gt; q = new TypedQueryBuilder&lt;T&gt;(clazz, &quot;root&quot;).toQuery(persistenceService.identifyEntityManagerðŸ”µ</abbr></span>
 129          return q.getResultList();
 130      }
 131  
 132      @Override
 133      public List&lt;Long&gt; readAllGenericEntityId(Class&lt;?&gt; clazz) {
 134          clazz = DynamicDaoHelperImpl.getNonProxyImplementationClassIfNecessary(clazz);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 135 -        CriteriaBuilder builder = em.getCriteriaBuilder();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 136 +        EntityManager entityManager = persistenceService.identifyEntityManager(clazz);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 137 +        CriteriaBuilder builder = entityManager.getCriteriaBuilder();</span>
 138          CriteriaQuery&lt;Long&gt; criteria = builder.createQuery(Long.class);
 139          Root root = criteria.from(clazz);
 140          criteria.select(root.get(getIdField(clazz).getName()).as(Long.class));
 141          criteria.orderBy(builder.asc(root.get(getIdField(clazz).getName())));
 142  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 143 -        return em.createQuery(criteria).getResultList();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 144 +        return entityManager.createQuery(criteria).getResultList();</span>
 145      }
 146  
 147      @Override
 148      public Class&lt;?&gt; getImplClass(String className) {
 149          Class&lt;?&gt; clazz = null;
 150          try {
 151              clazz = entityConfiguration.lookupEntityClass(className);
 152          } catch (NoSuchBeanDefinitionException e) {
 153              //do nothing
 154          }
 155          if (clazz == null) {
 156              clazz = getCeilingImplClass(className);
 157          }
 158          return clazz;
 159      }
 160  
 161      @Override
 162      public Class&lt;?&gt; getCeilingImplClass(final String className) {
 163          final Class&lt;?&gt;[] clazz = new Class&lt;?&gt;[1];
 164          try {
 165              clazz[0] = Class.forName(className);
 166          } catch (ClassNotFoundException e) {
 167              throw new RuntimeException(e);
 168          }
<abbr title=" 169          //em.unwrap requires a transactional entity manager. We&#x27;ll only take the hit to start a transaction here if one has not already been started."> 169          //em.unwrap requires a transactional entity manager. We&#x27;ll only take the hit to start a transaction here iðŸ”µ</abbr>
 170          transactionUtil.runOptionalTransactionalOperation(new StreamCapableTransactionalOperationAdapter() {
 171              @Override
 172              public void execute() throws Throwable {
<abbr title=" 173                  Class&lt;?&gt;[] entitiesFromCeiling = daoHelper.getAllPolymorphicEntitiesFromCeiling(clazz[0], true, true);"> 173                  Class&lt;?&gt;[] entitiesFromCeiling = daoHelper.getAllPolymorphicEntitiesFromCeiling(clazz[0], true, trðŸ”µ</abbr>
 174                  if (entitiesFromCeiling == null || entitiesFromCeiling.length &lt; 1) {
 175                      clazz[0] = DynamicDaoHelperImpl.getNonProxyImplementationClassIfNecessary(clazz[0]);
 176                      entitiesFromCeiling = daoHelper.getAllPolymorphicEntitiesFromCeiling(clazz[0], true, true);
 177                  }
 178                  if (entitiesFromCeiling == null || entitiesFromCeiling.length &lt; 1) {
<abbr title=" 179                      throw new IllegalArgumentException(String.format(&quot;Unable to find ceiling implementation for the requested class name (%s)&quot;, className));"> 179                      throw new IllegalArgumentException(String.format(&quot;Unable to find ceiling implementation for thðŸ”µ</abbr>
 180                  }
 181                  clazz[0] = entitiesFromCeiling[entitiesFromCeiling.length - 1];
 182              }
 183          }, RuntimeException.class, !TransactionUtils.isTransactionalEntityManager(em));
 184          return clazz[0];
 185      }
 186  
 187      @Override
 188      public Serializable getIdentifier(Object entity) {
 189          return daoHelper.getIdentifier(entity);
 190      }
 191  
 192      protected Field getIdField(Class&lt;?&gt; clazz) {
 193          return daoHelper.getIdField(clazz);
 194      }
 195  
 196      @Override
 197      public &lt;T&gt; T save(T object) {
 198          return em.merge(object);
 199      }
 200  
 201      @Override
 202      public void persist(Object object) {
 203          em.persist(object);
 204      }
 205  
 206      @Override
 207      public void remove(Object object) {
 208          em.remove(object);
 209      }
 210  
 211      @Override
 212      public void flush() {
 213          em.flush();
 214      }
 215  
 216      @Override
 217      public void clearAutoFlushMode() {
 218          em.unwrap(Session.class).setHibernateFlushMode(FlushMode.MANUAL);
 219      }
 220  
 221      @Override
 222      public void enableAutoFlushMode() {
 223          em.unwrap(Session.class).setHibernateFlushMode(FlushMode.AUTO);
 224      }
 225  
 226      @Override
 227      public void clear() {
 228          em.clear();
 229      }
 230  
 231      @Override
 232      public boolean sessionContains(Object object) {
 233          return em.contains(object);
 234      }
 235  
 236      @Override
 237      public boolean idAssigned(Object object) {
 238          return getIdentifier(object) != null;
 239      }
 240  
 241      @Override
 242      public EntityManager getEntityManager() {
 243          return em;
 244      }




 245  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            