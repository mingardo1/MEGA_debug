<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>260</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    260
                    <a href="259.html">prev</a>
                    <a href="261.html">next</a>
                    <a href="260_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    Automattic/simplenote-android_f6b200b2a988ba1c8c9bdce1f9018ade9b322480_Simplenote/src/main/java/com/automattic/simplenote/NotesActivity.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;f6b200b2a988ba1c8c9bdce1f9018ade9b322480:Simplenote/src/main/java/com/automattic/simplenote/NotesActivity.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;f6b200b2a988ba1c8c9bdce1f9018ade9b322480^1:Simplenote/src/main/java/com/automattic/simplenote/NotesActivity.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;f6b200b2a988ba1c8c9bdce1f9018ade9b322480^2:Simplenote/src/main/java/com/automattic/simplenote/NotesActivity.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;9e22297053412e6b042d92d1d612bb91cc42a7e0:Simplenote/src/main/java/com/automattic/simplenote/NotesActivity.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[b], [sbj], [sbj], [sbj]], subset: [[b], [sbj], [sbj], [sbj]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 package com.automattic.simplenote;
   2 
   3 import android.app.Activity;
   4 import android.app.AlertDialog;
   5 import android.content.DialogInterface;
   6 import android.content.Intent;
   7 import android.content.SharedPreferences;
   8 import android.content.res.Configuration;
   9 import android.os.AsyncTask;
  10 import android.os.Build;
  11 import android.os.Bundle;
  12 import android.os.Handler;
  13 import android.preference.PreferenceManager;
  14 import android.support.design.widget.NavigationView;
  15 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  16 import android.support.v4.content.ContextCompat;</span>
  17 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  18 import android.preference.PreferenceManager;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  19 import android.support.design.widget.NavigationView;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  20 import android.support.v4.view.GravityCompat;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  21 import android.support.v4.view.MenuItemCompat;</span>
  22 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  23 import android.support.v4.app.FragmentManager;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  24 import android.support.v4.app.FragmentTransaction;</span>
  25 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
  26 import android.support.v4.view.GravityCompat;
  27 import android.support.v4.view.MenuItemCompat;
  28 import android.support.v4.widget.DrawerLayout;
  29 import android.support.v7.app.ActionBar;
  30 import android.support.v7.app.ActionBarDrawerToggle;
  31 import android.support.v7.app.AppCompatActivity;
  32 import android.support.v7.widget.SearchView;
  33 import android.support.v7.widget.Toolbar;
  34 import android.text.Html;
  35 import android.text.Spannable;
  36 import android.text.SpannableString;
  37 import android.text.TextUtils;
  38 import android.view.Menu;
  39 import android.view.MenuInflater;
  40 import android.view.MenuItem;
  41 import android.view.View;
  42 import android.view.WindowManager;
  43 import android.widget.AdapterView;
  44 import android.widget.ListView;
  45 import android.widget.ProgressBar;
  46 import android.widget.TextView;
  47 
  48 import com.automattic.simplenote.analytics.AnalyticsTracker;
  49 import com.automattic.simplenote.models.Note;
  50 import com.automattic.simplenote.models.Tag;
  51 import com.automattic.simplenote.utils.AniUtils;
  52 import com.automattic.simplenote.utils.DisplayUtils;
  53 import com.automattic.simplenote.utils.DrawableUtils;
  54 import com.automattic.simplenote.utils.PrefUtils;
  55 import com.automattic.simplenote.utils.StrUtils;
  56 import com.automattic.simplenote.utils.TagsAdapter;
  57 import com.automattic.simplenote.utils.ThemeUtils;
  58 import com.automattic.simplenote.utils.UndoBarController;
  59 import com.automattic.simplenote.widgets.TypefaceSpan;
  60 import com.simperium.Simperium;
  61 import com.simperium.android.LoginActivity;
  62 import com.simperium.client.Bucket;
  63 import com.simperium.client.BucketObjectMissingException;
  64 import com.simperium.client.BucketObjectNameInvalid;
  65 import com.simperium.client.Query;
  66 import com.simperium.client.User;
  67 
  68 import org.wordpress.passcodelock.AppLockManager;
  69 
  70 import java.util.ArrayList;
  71 import java.util.Calendar;
  72 import java.util.List;
  73 
  74 public class NotesActivity extends AppCompatActivity implements
<abbr title="  75         NoteListFragment.Callbacks, User.StatusChangeListener, Simperium.OnUserCreatedListener, UndoBarController.UndoListener,">  75         NoteListFragment.Callbacks, User.StatusChangeListener, Simperium.OnUserCreatedListener, UndoBarCoðŸ”µ</abbr>
  76         Bucket.Listener&lt;Note&gt; {
  77 
  78     public static String TAG_NOTE_LIST = &quot;noteList&quot;;
  79     public static String TAG_NOTE_EDITOR = &quot;noteEditor&quot;;
  80     private int TRASH_SELECTED_ID = 2;
  81 
  82     private boolean mIsMarkdownEnabledGlobal;
  83     private boolean mIsShowingMarkdown;
  84     private boolean mShouldSelectNewNote;
  85     private String mTabletSearchQuery;
  86     private UndoBarController mUndoBarController;
  87     private View mFragmentsContainer;
  88     private View mWelcomeView;
  89     private SearchView mSearchView;
  90     private MenuItem mSearchMenuItem;
  91     private NoteListFragment mNoteListFragment;
  92     private NoteEditorFragment mNoteEditorFragment;
  93     private Note mCurrentNote;
  94     protected Bucket&lt;Note&gt; mNotesBucket;
  95     protected Bucket&lt;Tag&gt; mTagsBucket;
  96     private MenuItem mEmptyTrashMenuItem;
  97 
  98     // Menu drawer
  99     private DrawerLayout mDrawerLayout;
 100     private ListView mDrawerList;
 101     private NavigationView mNavigationView;
 102     private ActionBarDrawerToggle mDrawerToggle;
 103     private TagsAdapter mTagsAdapter;
 104     private TagsAdapter.TagMenuItem mSelectedTag;
 105 
 106     @Override
 107     protected void onCreate(Bundle savedInstanceState) {
 108         // On lollipop, configure the translucent status bar
 109         if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.LOLLIPOP) {
 110             getWindow().addFlags(WindowManager.LayoutParams.FLAG_DRAWS_SYSTEM_BAR_BACKGROUNDS);
 111             getWindow().setStatusBarColor(ContextCompat.getColor(this, R.color.transparent));
 112         }
 113 
 114         ThemeUtils.setTheme(this);
 115         super.onCreate(savedInstanceState);
 116         setContentView(R.layout.activity_notes);
 117 
 118         mFragmentsContainer = findViewById(R.id.note_fragment_container);
 119 
 120         Simplenote currentApp = (Simplenote) getApplication();
 121         if (mNotesBucket == null) {
 122             mNotesBucket = currentApp.getNotesBucket();
 123         }
 124 
 125         if (mTagsBucket == null) {
 126             mTagsBucket = currentApp.getTagsBucket();
 127         }
 128 
 129         Toolbar toolbar = (Toolbar) findViewById(R.id.toolbar);
 130         setSupportActionBar(toolbar);
 131         configureNavigationDrawer(toolbar);
 132 
 133         if (savedInstanceState == null) {
 134             mNoteListFragment = new NoteListFragment();
 135             FragmentTransaction fragmentTransaction = getSupportFragmentManager().beginTransaction();
 136             fragmentTransaction.add(R.id.note_fragment_container, mNoteListFragment, TAG_NOTE_LIST);
 137             fragmentTransaction.commit();
 138         } else {
<abbr title=" 139             mNoteListFragment = (NoteListFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_LIST);"> 139             mNoteListFragment = (NoteListFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTEðŸ”µ</abbr>
 140         }
 141 
 142         if (DisplayUtils.isLargeScreen(this)) {
 143             if (getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR) != null) {
<abbr title=" 144                 mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR);"> 144                 mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByTag(ðŸ”µ</abbr>
 145             } else if (DisplayUtils.isLandscape(this)) {
 146                 addEditorFragment();
 147             }
 148         }
 149 
 150         // enable ActionBar app icon to behave as action to toggle nav drawer
 151         ActionBar actionBar = getSupportActionBar();
 152         if (actionBar != null) {
 153             actionBar.setDisplayHomeAsUpEnabled(true);
 154             actionBar.setHomeButtonEnabled(true);
 155 
 156             // Add loading indicator to show when indexing
<abbr title=" 157             ProgressBar progressBar = (ProgressBar) getLayoutInflater().inflate(R.layout.progressbar_toolbar, null);"> 157             ProgressBar progressBar = (ProgressBar) getLayoutInflater().inflate(R.layout.progressbar_toolðŸ”µ</abbr>
 158             actionBar.setDisplayShowCustomEnabled(true);
 159             actionBar.setCustomView(progressBar);
 160             setToolbarProgressVisibility(false);
 161         }
 162 
 163         mUndoBarController = new UndoBarController(this);
 164 
 165         // Creates &#x27;Welcome&#x27; note
 166         checkForFirstLaunch();
 167 
 168         checkForSharedContent();
 169 
 170         currentApp.getSimperium().setOnUserCreatedListener(this);
 171         currentApp.getSimperium().setUserStatusChangeListener(this);
 172     }
 173 
 174     @Override
 175     protected void onResume() {
 176         super.onResume();
 177 
 178         // Ensure user has valid authorization
 179         if (userAuthenticationIsInvalid()) {
 180             startLoginActivity(true);
 181         }
 182 
 183         mNotesBucket.start();
 184         mTagsBucket.start();
 185 
 186         mNotesBucket.addOnNetworkChangeListener(this);
 187         mNotesBucket.addOnSaveObjectListener(this);
 188         mNotesBucket.addOnDeleteObjectListener(this);
 189         mTagsBucket.addListener(mTagsMenuUpdater);
 190 
 191         setWelcomeViewVisibility();
 192         updateNavigationDrawerItems();
 193 
 194         // if the user is not authenticated and the tag doesn&#x27;t exist revert to default drawer selection
 195         if (userIsUnauthorized()) {
 196             if (-1 == mTagsAdapter.getPosition(mSelectedTag)) {
 197                 mSelectedTag = null;
 198                 mDrawerList.setSelection(TagsAdapter.DEFAULT_ITEM_POSITION);
 199             }
 200         }
 201 
 202         setSelectedTagActive();
 203 
 204         if (mCurrentNote != null &amp;&amp; mShouldSelectNewNote) {
<abbr title=" 205             onNoteSelected(mCurrentNote.getSimperiumKey(), 0, true, null, mCurrentNote.isMarkdownEnabled());"> 205             onNoteSelected(mCurrentNote.getSimperiumKey(), 0, true, null, mCurrentNote.isMarkdownEnabled(ðŸ”µ</abbr>
 206             mShouldSelectNewNote = false;
 207         }
 208 
<abbr title=" 209         mIsMarkdownEnabledGlobal = PrefUtils.getBoolPref(NotesActivity.this, PrefUtils.PREF_MARKDOWN_ENABLED, false);"> 209         mIsMarkdownEnabledGlobal = PrefUtils.getBoolPref(NotesActivity.this, PrefUtils.PREF_MARKDOWN_ENABðŸ”µ</abbr>
 210     }
 211 
 212     @Override
 213     protected void onPause() {
 214         super.onPause();
 215 
 216         mTagsBucket.removeListener(mTagsMenuUpdater);
 217 
 218         mNotesBucket.removeOnNetworkChangeListener(this);
 219         mNotesBucket.removeOnSaveObjectListener(this);
 220         mNotesBucket.removeOnDeleteObjectListener(this);
 221     }
 222 
 223     @Override
 224     public void setTitle(CharSequence title) {
 225         if (title == null) {
 226             title = &quot;&quot;;
 227         }
 228 
 229         setTitleWithCustomFont(title);
 230     }
 231 
 232     @Override
 233     public void onBackPressed() {
 234         if (mDrawerLayout != null &amp;&amp; mDrawerLayout.isDrawerOpen(GravityCompat.START)) {
 235             mDrawerLayout.closeDrawer(GravityCompat.START);
 236         } else {
 237             super.onBackPressed();
 238         }
 239     }
 240 
 241     private void setTitleWithCustomFont(CharSequence title) {
 242         if (getSupportActionBar() == null) return;
 243 
 244         // LG devices running 4.1 can&#x27;t handle a custom font in the action bar title
 245         if ((!TextUtils.isEmpty(Build.BRAND) &amp;&amp; Build.BRAND.toLowerCase().contains(&quot;lge&quot;))
 246                 &amp;&amp; Build.VERSION.SDK_INT &lt;= Build.VERSION_CODES.JELLY_BEAN) {
 247             getSupportActionBar().setTitle(title);
 248             return;
 249         }
 250 
 251         SpannableString s = new SpannableString(title);
 252         s.setSpan(new TypefaceSpan(this), 0, s.length(), Spannable.SPAN_EXCLUSIVE_EXCLUSIVE);
 253         getSupportActionBar().setTitle(s);
 254     }
 255 
 256     private void configureNavigationDrawer(Toolbar toolbar) {
 257         mDrawerLayout = (DrawerLayout) findViewById(R.id.drawer_layout);
 258         mDrawerLayout.setDrawerShadow(R.drawable.drawer_shadow, GravityCompat.START);
 259         mNavigationView = (NavigationView) findViewById(R.id.navigation_view);
 260         mDrawerList = (ListView) findViewById(R.id.drawer_list);
 261         
 262         // Configure welcome view in the nav drawer
 263         mWelcomeView = mDrawerLayout.findViewById(R.id.welcome_view);
 264         TextView welcomeSignInButton = (TextView)mDrawerLayout.findViewById(R.id.welcome_sign_in_button);
 265         welcomeSignInButton.setOnClickListener(new View.OnClickListener() {
 266             @Override
 267             public void onClick(View v) {
 268                 startLoginActivity(true);
 269             }
 270         });
 271         
 272         TextView welcomeCloseButton = (TextView)mDrawerLayout.findViewById(R.id.welcome_close);
 273                 welcomeCloseButton.setOnClickListener(new View.OnClickListener() {
 274                     @Override
 275                     public void onClick(View v) {
 276                         removeWelcomeView();
 277                     }
 278                 });
 279 
 280         View settingsButton = findViewById(R.id.nav_settings);
 281         settingsButton.setOnClickListener(new View.OnClickListener() {
 282             @Override
 283             public void onClick(View v) {
 284                 Intent i = new Intent(NotesActivity.this, PreferencesActivity.class);
 285                 startActivityForResult(i, Simplenote.INTENT_PREFERENCES);
 286             }
 287         });
 288 
 289         mNavigationView.getLayoutParams().width = ThemeUtils.getOptimalDrawerWidth(this);
 290         mTagsAdapter = new TagsAdapter(this, mNotesBucket, mDrawerList.getHeaderViewsCount());
 291         mDrawerList.setAdapter(mTagsAdapter);
 292         // Set the list&#x27;s click listener
 293         mDrawerList.setOnItemClickListener(new DrawerItemClickListener());
 294 
 295         if (mSelectedTag == null)
 296             mSelectedTag = mTagsAdapter.getDefaultItem();
 297 
 298         mDrawerToggle = new ActionBarDrawerToggle(this, mDrawerLayout, toolbar, R.string.open_drawer,
 299                 R.string.close_drawer) {
 300             public void onDrawerClosed(View view) {
 301                 supportInvalidateOptionsMenu();
 302             }
 303 
 304             public void onDrawerOpened(View drawerView) {
 305                 // noop
 306             }
 307         };
 308 
 309         mDrawerLayout.addDrawerListener(mDrawerToggle);
 310     }
 311 
 312     private void setWelcomeViewVisibility() {
 313         if (mWelcomeView == null) return;
 314         // Hide welcome view if user is signed in or closed the welcome view
 315         if (userIsAuthorized() || PrefUtils.getBoolPref(this, PrefUtils.PREF_APP_TRIAL)) {
 316             mWelcomeView.setVisibility(View.GONE);
 317         } else {
 318             mWelcomeView.setVisibility(View.VISIBLE);
 319             mWelcomeView.setAlpha(1.0f);
 320         }
 321     }
 322 
 323     private void removeWelcomeView() {
 324         if (mWelcomeView == null) return;
 325 
 326         AniUtils.swipeOutToLeft(mWelcomeView);
 327 
 328         // Set preference so the welcome view never shows again
 329         SharedPreferences preferences = PreferenceManager.getDefaultSharedPreferences(this);
 330         SharedPreferences.Editor editor = preferences.edit();
 331         editor.putBoolean(PrefUtils.PREF_APP_TRIAL, true);
 332         editor.apply();
 333     }
 334 
 335     private void checkForFirstLaunch() {
 336         if (PrefUtils.getBoolPref(this, PrefUtils.PREF_FIRST_LAUNCH, true)) {
 337             // Create the welcome note
 338             try {
 339                 Note welcomeNote = mNotesBucket.newObject(&quot;welcome-android&quot;);
 340                 welcomeNote.setCreationDate(Calendar.getInstance());
 341                 welcomeNote.setModificationDate(welcomeNote.getCreationDate());
 342                 welcomeNote.setContent(getString(R.string.welcome_note));
 343                 welcomeNote.getTitle();
 344                 welcomeNote.save();
 345             } catch (BucketObjectNameInvalid e) {
 346                 // this won&#x27;t happen because welcome-android is a valid name
 347             }
 348 
 349             SharedPreferences preferences = PreferenceManager.getDefaultSharedPreferences(this);
 350             SharedPreferences.Editor editor = preferences.edit();
 351             editor.putBoolean(PrefUtils.PREF_FIRST_LAUNCH, false);
 352             editor.apply();
 353         }
 354     }
 355 
 356     private void checkForSharedContent() {
 357         if (getIntent().hasExtra(Intent.EXTRA_TEXT)) {
 358             // Check share action
 359             Intent intent = getIntent();
 360             String subject = intent.getStringExtra(Intent.EXTRA_SUBJECT);
 361             String text = intent.getStringExtra(Intent.EXTRA_TEXT);
 362 
<abbr title=" 363             // Don&#x27;t add the &#x27;Note to self&#x27; subject or open the note if this was shared from a voice search"> 363             // Don&#x27;t add the &#x27;Note to self&#x27; subject or open the note if this was shared from a voice searðŸ”µ</abbr>
 364             String intentAction = StrUtils.notNullStr(intent.getAction());
 365             boolean isVoiceShare = intentAction.equals(&quot;com.google.android.gm.action.AUTO_SEND&quot;);
 366             if (!TextUtils.isEmpty(text)) {
 367                 if (!TextUtils.isEmpty(subject) &amp;&amp; !isVoiceShare) {
 368                     text = subject + &quot;\n\n&quot; + text;
 369                 }
 370                 Note note = mNotesBucket.newObject();
 371                 note.setCreationDate(Calendar.getInstance());
 372                 note.setModificationDate(note.getCreationDate());
 373                 note.setContent(text);
 374                 note.save();
 375                 setCurrentNote(note);
 376 
 377                 if (!isVoiceShare) {
 378                     mShouldSelectNewNote = true;
 379                 }
 380                 AnalyticsTracker.track(
 381                         AnalyticsTracker.Stat.LIST_NOTE_CREATED,
 382                         AnalyticsTracker.CATEGORY_NOTE,
 383                         &quot;external_share&quot;
 384                 );
 385 
 386                 if (!DisplayUtils.isLargeScreenLandscape(this)) {
 387                     // Disable the lock screen when sharing content and opening NoteEditorActivity
 388                     // Lock screen activities are enabled again in NoteEditorActivity.onPause()
 389                     if (AppLockManager.getInstance().isAppLockFeatureEnabled()) {
 390                         AppLockManager.getInstance().getCurrentAppLock().setDisabledActivities(
 391                                 new String[]{&quot;com.automattic.simplenote.NotesActivity&quot;,
 392                                 &quot;com.automattic.simplenote.NoteEditorActivity&quot;});
 393                         AppLockManager.getInstance().getCurrentAppLock().setOneTimeTimeout(0);
 394                     }
 395                 }
 396             }
 397         }
 398     }
 399 
 400     private void updateNavigationDrawerItems() {
 401         Bucket.ObjectCursor&lt;Tag&gt; tagCursor = Tag.allWithCount(mTagsBucket).execute();
 402         mTagsAdapter.changeCursor(tagCursor);
 403     }
 404 
 405     private void setSelectedTagActive() {
 406         if (mSelectedTag == null)
 407             mSelectedTag = mTagsAdapter.getDefaultItem();
 408 
 409         setTitle(mSelectedTag.name);
<abbr title=" 410         mDrawerList.setItemChecked(mTagsAdapter.getPosition(mSelectedTag) + mDrawerList.getHeaderViewsCount(), true);"> 410         mDrawerList.setItemChecked(mTagsAdapter.getPosition(mSelectedTag) + mDrawerList.getHeaderViewsCouðŸ”µ</abbr>
 411     }
 412 
 413     /* The click listener for ListView in the navigation drawer */
 414     private class DrawerItemClickListener implements ListView.OnItemClickListener {
 415         @Override
 416         public void onItemClick(AdapterView&lt;?&gt; parent, View view, int position, long id) {
 417 
 418             // Adjust for header view
 419             position -= mDrawerList.getHeaderViewsCount();
 420             mSelectedTag = mTagsAdapter.getItem(position);
 421             checkEmptyListText(false);
 422             // Update checked item in navigation drawer and close it
 423             setSelectedTagActive();
 424             mDrawerLayout.closeDrawer(mNavigationView);
 425 
 426             // Disable long press on notes if we&#x27;re viewing the trash
 427             if (mDrawerList.getCheckedItemPosition() == TRASH_SELECTED_ID) {
 428                 getNoteListFragment().getListView().setLongClickable(false);
 429             } else {
 430                 getNoteListFragment().getListView().setLongClickable(true);
 431             }
 432 
 433             getNoteListFragment().refreshListFromNavSelect();
 434             if (position &gt; 1) {
 435                 AnalyticsTracker.track(
 436                         AnalyticsTracker.Stat.LIST_TAG_VIEWED,
 437                         AnalyticsTracker.CATEGORY_TAG,
 438                         &quot;selected_tag_in_navigation_drawer&quot;
 439                 );
 440             }
 441         }
 442     }
 443 
 444     public TagsAdapter.TagMenuItem getSelectedTag() {
 445         if (mSelectedTag == null) {
 446             mSelectedTag = mTagsAdapter.getDefaultItem();
 447         }
 448         
 449         return mSelectedTag;
 450     }
 451 
 452     // Enable or disable the trash action bar button depending on if there are deleted notes or not
 453     public void updateTrashMenuItem() {
 454         if (mEmptyTrashMenuItem == null || mNotesBucket == null)
 455             return;
 456 
 457         // Disable the trash icon if there are no notes trashed.
 458         Query&lt;Note&gt; query = Note.allDeleted(mNotesBucket);
 459         if (query.count() == 0) {
 460             mEmptyTrashMenuItem.getIcon().setAlpha(127);
 461             mEmptyTrashMenuItem.setEnabled(false);
 462         } else {
 463             mEmptyTrashMenuItem.getIcon().setAlpha(255);
 464             mEmptyTrashMenuItem.setEnabled(true);
 465         }
 466     }
 467 
 468     private void addEditorFragment() {
 469         FragmentManager fm = getSupportFragmentManager();
 470         FragmentTransaction ft = fm.beginTransaction();
 471         mNoteEditorFragment = new NoteEditorFragment();
 472         ft.add(R.id.note_fragment_container, mNoteEditorFragment, TAG_NOTE_EDITOR);
 473         ft.commitAllowingStateLoss();
 474         fm.executePendingTransactions();
 475     }
 476 
 477     /**
 478      * Checks for a previously valid user that is now not authenticated
 479      *
 480      * @return true if user has invalid authorization
 481      */
 482     private boolean userAuthenticationIsInvalid() {
 483         Simplenote currentApp = (Simplenote) getApplication();
 484         Simperium simperium = currentApp.getSimperium();
 485         User user = simperium.getUser();
 486         return user.hasAccessToken() &amp;&amp; user.getStatus().equals(User.Status.NOT_AUTHORIZED);
 487     }
 488 
 489     private boolean userIsUnauthorized() {
 490         Simplenote currentApp = (Simplenote) getApplication();
 491         return currentApp.getSimperium().getUser().getStatus() == User.Status.NOT_AUTHORIZED;
 492     }
 493 
 494     private boolean userIsAuthorized() {
 495         Simplenote app = (Simplenote) getApplication();
 496         return !app.getSimperium().needsAuthorization();
 497     }
 498 
 499     public void setCurrentNote(Note note) {
 500         mCurrentNote = note;
 501     }
 502 
 503     public NoteListFragment getNoteListFragment() {
 504         return mNoteListFragment;
 505     }
 506 
 507     @SuppressWarnings(&quot;ResourceType&quot;)
 508     @Override
 509     public boolean onCreateOptionsMenu(Menu menu) {
 510         super.onCreateOptionsMenu(menu);
 511         MenuInflater inflater = getMenuInflater();
 512         inflater.inflate(R.menu.notes_list, menu);
 513 
 514         // restore the search query if on a landscape tablet
 515         String searchQuery = null;
 516         if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; mSearchView != null)
 517             searchQuery = mSearchView.getQuery().toString();
 518 
 519         mSearchMenuItem = menu.findItem(R.id.menu_search);
 520         mSearchView = (SearchView) mSearchMenuItem.getActionView();
 521 
 522         if (!TextUtils.isEmpty(searchQuery)) {
 523             mSearchView.setQuery(searchQuery, false);
 524             mSearchMenuItem.expandActionView();
 525         } else {
 526             // Workaround for setting the search placeholder text color
 527             String hintHexColor = (ThemeUtils.isLightTheme(this) ?
 528                     getString(R.color.simplenote_light_grey) :
 529                     getString(R.color.simplenote_text_preview)).replace(&quot;ff&quot;, &quot;&quot;);
 530             mSearchView.setQueryHint(Html.fromHtml(String.format(&quot;&lt;font color=\&quot;%s\&quot;&gt;%s&lt;/font&gt;&quot;,
 531                     hintHexColor,
 532                     getString(R.string.search))));
 533         }
 534 
 535         mSearchView.setOnQueryTextListener(new SearchView.OnQueryTextListener() {
 536             @Override
 537             public boolean onQueryTextChange(String newText) {
 538                 if (mSearchMenuItem.isActionViewExpanded()) {
 539                     getNoteListFragment().searchNotes(newText);
 540                 }
 541                 return true;
 542             }
 543 
 544             @Override
 545             public boolean onQueryTextSubmit(String queryText) {
 546                 getNoteListFragment().searchNotes(queryText);
 547                 return true;
 548             }
 549 
 550         });
 551 
<abbr title=" 552         MenuItemCompat.setOnActionExpandListener(mSearchMenuItem, new MenuItemCompat.OnActionExpandListener() {"> 552         MenuItemCompat.setOnActionExpandListener(mSearchMenuItem, new MenuItemCompat.OnActionExpandListenðŸ”µ</abbr>
 553             @Override
 554             public boolean onMenuItemActionExpand(MenuItem menuItem) {
 555                 checkEmptyListText(true);
 556                 if (mNoteListFragment != null) {
 557                     mNoteListFragment.setFloatingActionButtonVisible(false);
 558                 }
 559                 AnalyticsTracker.track(
 560                         AnalyticsTracker.Stat.LIST_NOTES_SEARCHED,
 561                         AnalyticsTracker.CATEGORY_NOTE,
 562                         &quot;action_bar_search_tap&quot;
 563                 );
 564                 return true;
 565             }
 566 
 567             @Override
 568             public boolean onMenuItemActionCollapse(MenuItem menuItem) {
 569                 // Show all notes again
 570                 if (mNoteListFragment != null) {
 571                     mNoteListFragment.setFloatingActionButtonVisible(true);
 572                 }
 573                 mTabletSearchQuery = &quot;&quot;;
 574                 mSearchView.setQuery(&quot;&quot;, false);
 575                 checkEmptyListText(false);
 576                 getNoteListFragment().clearSearch();
 577                 return true;
 578             }
 579         });
 580 
 581         mSearchMenuItem.setOnMenuItemClickListener(new MenuItem.OnMenuItemClickListener() {
 582             @Override
 583             public boolean onMenuItemClick(MenuItem item) {
 584                 if (!mSearchMenuItem.isActionViewExpanded())
 585                     showDetailPlaceholder();
 586                 return false;
 587             }
 588         });
 589 
 590         MenuItem trashItem = menu.findItem(R.id.menu_delete).setTitle(R.string.undelete);
 591         if (mCurrentNote != null &amp;&amp; mCurrentNote.isDeleted())
 592             trashItem.setTitle(R.string.undelete);
 593         else
 594             trashItem.setTitle(R.string.delete);
 595 
 596         if (DisplayUtils.isLargeScreenLandscape(this)) {
 597             // Restore the search query on landscape tablets
 598             if (!TextUtils.isEmpty(mTabletSearchQuery)) {
 599                 mSearchMenuItem.expandActionView();
 600                 mSearchView.setQuery(mTabletSearchQuery, false);
 601                 mSearchView.clearFocus();
 602             }
 603 
 604             if (mCurrentNote != null) {
 605                 menu.findItem(R.id.menu_share).setVisible(true);
 606                 menu.findItem(R.id.menu_view_info).setVisible(true);
 607 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 608                 menu.findItem(R.id.menu_history).setVisible(true);</span>
 609 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 610 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 611             if (mCurrentNote != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 612                 menu.findItem(R.id.menu_share).setVisible(true);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 613                 menu.findItem(R.id.menu_view_info).setVisible(true);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 614                 trashItem.setVisible(true);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 615             } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 616                 menu.findItem(R.id.menu_share).setVisible(false);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 617                 menu.findItem(R.id.menu_view_info).setVisible(false);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 618                 trashItem.setVisible(false);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 619             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 620             menu.findItem(R.id.menu_empty_trash).setVisible(false);</span>
 621 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 622                 menu.findItem(R.id.menu_markdown_preview).setVisible(mIsMarkdownEnabledGlobal &amp;&amp; mCurrentNote.isMarkdownEnabled());"> 622                 menu.findItem(R.id.menu_markdown_preview).setVisible(mIsMarkdownEnabledGlobal &amp;&amp; mCurrentðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 623                 menu.findItem(R.id.menu_markdown_enable).setVisible(mIsMarkdownEnabledGlobal);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 624                 menu.findItem(R.id.menu_markdown_enable).setChecked(mCurrentNote.isMarkdownEnabled());</span>
 625 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 626                 trashItem.setVisible(true);
 627             } else {
 628                 menu.findItem(R.id.menu_share).setVisible(false);
 629                 menu.findItem(R.id.menu_view_info).setVisible(false);
 630 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 631                 menu.findItem(R.id.menu_history).setVisible(false);</span>
 632 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 633             } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 634                 menu.findItem(R.id.menu_share).setVisible(false);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 635                 menu.findItem(R.id.menu_view_info).setVisible(false);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 636                 trashItem.setVisible(false);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 637             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 638             menu.findItem(R.id.menu_empty_trash).setVisible(false);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 639         } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 640             menu.findItem(R.id.menu_search).setVisible(true);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 641             menu.findItem(R.id.menu_share).setVisible(false);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 642             menu.findItem(R.id.menu_view_info).setVisible(false);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 643             trashItem.setVisible(false);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 644             menu.findItem(R.id.menu_empty_trash).setVisible(false);</span>
 645 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 646                 menu.findItem(R.id.menu_markdown_preview).setVisible(false);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 647                 menu.findItem(R.id.menu_markdown_enable).setVisible(false);</span>
 648 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 649                 trashItem.setVisible(false);
 650             }
 651             menu.findItem(R.id.menu_empty_trash).setVisible(false);
 652         } else {
 653             menu.findItem(R.id.menu_search).setVisible(true);
 654             menu.findItem(R.id.menu_share).setVisible(false);
 655             menu.findItem(R.id.menu_view_info).setVisible(false);
 656 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 657             menu.findItem(R.id.menu_history).setVisible(false);</span>
 658 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 659             menu.findItem(R.id.menu_share).setVisible(false);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 660             menu.findItem(R.id.menu_view_info).setVisible(false);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 661             trashItem.setVisible(false);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 662             menu.findItem(R.id.menu_empty_trash).setVisible(false);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 663         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 664 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 665         // Are we looking at the trash? Adjust menu accordingly.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 666         if (mDrawerList.getCheckedItemPosition() == TRASH_SELECTED_ID) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 667             mEmptyTrashMenuItem = menu.findItem(R.id.menu_empty_trash);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 668             mEmptyTrashMenuItem.setVisible(true);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 669 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 670             updateTrashMenuItem();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 671 </span>
 672 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 673             menu.findItem(R.id.menu_markdown_preview).setVisible(false);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 674             menu.findItem(R.id.menu_markdown_enable).setVisible(false);</span>
 675 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 676             trashItem.setVisible(false);
 677             menu.findItem(R.id.menu_empty_trash).setVisible(false);
 678         }
 679 
 680         // Are we looking at the trash? Adjust menu accordingly.
 681         if (mDrawerList.getCheckedItemPosition() == TRASH_SELECTED_ID) {
 682             mEmptyTrashMenuItem = menu.findItem(R.id.menu_empty_trash);
 683             mEmptyTrashMenuItem.setVisible(true);
 684 
 685             updateTrashMenuItem();
 686 
 687             menu.findItem(R.id.menu_search).setVisible(false);
 688             menu.findItem(R.id.menu_share).setVisible(false);
 689             menu.findItem(R.id.menu_history).setVisible(false);
 690         }
 691 
 692         DrawableUtils.tintMenuWithAttribute(this, menu, R.attr.actionBarTextColor);
 693 
 694         return true;
 695     }
 696 
 697     @Override
 698     public boolean onOptionsItemSelected(MenuItem item) {
 699         if (mDrawerToggle.onOptionsItemSelected(item)) {
 700             return true;
 701         }
 702         switch (item.getItemId()) {
 703 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
 704 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 705                     Intent shareIntent = new Intent(android.content.Intent.ACTION_SEND);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 706                     shareIntent.setType(&quot;text/plain&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 707                     shareIntent.putExtra(android.content.Intent.EXTRA_TEXT, mCurrentNote.getContent());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 708                     startActivity(Intent.createChooser(shareIntent, getResources().getString(R.string.share_note)));"> 708                     startActivity(Intent.createChooser(shareIntent, getResources().getString(R.string.shaðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 709                     AnalyticsTracker.track(</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 710                             AnalyticsTracker.Stat.EDITOR_NOTE_CONTENT_SHARED,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 711                             AnalyticsTracker.CATEGORY_NOTE,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 712                             &quot;action_bar_share_button&quot;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 713                     );</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 714                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 715                 return true;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 716             case R.id.menu_delete:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 717                 if (mNoteEditorFragment != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 718                     if (mCurrentNote != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 719                         mCurrentNote.setDeleted(!mCurrentNote.isDeleted());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 720                         mCurrentNote.setModificationDate(Calendar.getInstance());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 721                         mCurrentNote.save();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 722 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 723                         if (mCurrentNote.isDeleted()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 724                             List&lt;String&gt; deletedNoteIds = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 725                             deletedNoteIds.add(mCurrentNote.getSimperiumKey());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 726                             mUndoBarController.setDeletedNoteIds(deletedNoteIds);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 727                             mUndoBarController.showUndoBar(getUndoView(), getString(R.string.note_deleted), null);"> 727                             mUndoBarController.showUndoBar(getUndoView(), getString(R.string.note_deletedðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 728                             AnalyticsTracker.track(</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 729                                     AnalyticsTracker.Stat.LIST_NOTE_DELETED,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 730                                     AnalyticsTracker.CATEGORY_NOTE,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 731                                     &quot;overflow_menu&quot;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 732                             );</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 733                         } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 734                             AnalyticsTracker.track(</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 735                                     AnalyticsTracker.Stat.EDITOR_NOTE_RESTORED,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 736                                     AnalyticsTracker.CATEGORY_NOTE,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 737                                     &quot;overflow_menu&quot;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 738                             );</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 739                         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 740                         showDetailPlaceholder();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 741                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 742                     NoteListFragment fragment = getNoteListFragment();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 743                     if (fragment != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 744                         fragment.getPrefs();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 745                         fragment.refreshList();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 746                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 747                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 748                 return true;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 749             case R.id.menu_empty_trash:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 750                 AlertDialog.Builder alert = new AlertDialog.Builder(this);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 751 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 752                 alert.setTitle(R.string.empty_trash);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 753                 alert.setMessage(R.string.confirm_empty_trash);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 754                 alert.setPositiveButton(R.string.yes, new DialogInterface.OnClickListener() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 755                     public void onClick(DialogInterface dialog, int whichButton) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 756                         new emptyTrashTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 757                         AnalyticsTracker.track(</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 758                                 AnalyticsTracker.Stat.LIST_TRASH_EMPTIED,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 759                                 AnalyticsTracker.CATEGORY_NOTE,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 760                                 &quot;overflow_menu&quot;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 761                         );</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 762                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 763                 });</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 764                 alert.setNegativeButton(R.string.no, new DialogInterface.OnClickListener() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 765                     public void onClick(DialogInterface dialog, int whichButton) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 766                         // Do nothing, just closing the dialog</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 767                     }</span>
 768 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 769             case R.id.menu_share:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 770                 if (mCurrentNote != null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 771                     Intent shareIntent = new Intent(android.content.Intent.ACTION_SEND);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 772                     shareIntent.setType(&quot;text/plain&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 773                     shareIntent.putExtra(android.content.Intent.EXTRA_TEXT, mCurrentNote.getContent());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 774                     startActivity(Intent.createChooser(shareIntent, getResources().getString(R.string.share_note)));"> 774                     startActivity(Intent.createChooser(shareIntent, getResources().getString(R.string.shaðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 775                     AnalyticsTracker.track(</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 776                             AnalyticsTracker.Stat.EDITOR_NOTE_CONTENT_SHARED,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 777                             AnalyticsTracker.CATEGORY_NOTE,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 778                             &quot;action_bar_share_button&quot;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 779                     );</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 780                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 781                 return true;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 782             case R.id.menu_markdown_preview:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 783                 if (mIsShowingMarkdown) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 784                     if (ThemeUtils.isLightTheme(NotesActivity.this)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 785                         item.setIcon(R.drawable.ic_markdown_grey_outline_24dp);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 786                     } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 787                         item.setIcon(R.drawable.ic_markdown_blue_outline_24dp);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 788                     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 789 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 790                     mNoteEditorFragment.hideMarkdown();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 791                     item.setTitle(getString(R.string.markdown_show));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 792                     mIsShowingMarkdown = false;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 793                 } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 794                     if (ThemeUtils.isLightTheme(NotesActivity.this)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 795                         item.setIcon(R.drawable.ic_markdown_grey_solid_24dp);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 796                     } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 797                         item.setIcon(R.drawable.ic_markdown_blue_solid_24dp);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 798                     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 799 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 800                     mNoteEditorFragment.showMarkdown();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 801                     item.setTitle(getString(R.string.markdown_hide));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 802                     mIsShowingMarkdown = true;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 803                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 804 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 805                 return true;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 806             case R.id.menu_markdown_enable:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 807                 if (mCurrentNote != null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 808                     if (mNoteEditorFragment != null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 809                         mNoteEditorFragment.setMarkdownEnabled(!mCurrentNote.isMarkdownEnabled());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 810                         mNoteEditorFragment.saveNote();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 811                     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 812 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 813                     item.setChecked(!mCurrentNote.isMarkdownEnabled());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 814                     invalidateOptionsMenu();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 815                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 816 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 817                 if (mNoteEditorFragment != null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 818                     mNoteEditorFragment.hideMarkdown();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 819                     mIsShowingMarkdown = false;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 820                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 821 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 822                 return true;</span>
 823 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 824             case R.id.menu_delete:
 825                 if (mNoteEditorFragment != null) {
 826                     if (mCurrentNote != null) {
 827                         mCurrentNote.setDeleted(!mCurrentNote.isDeleted());
 828                         mCurrentNote.setModificationDate(Calendar.getInstance());
 829                         mCurrentNote.save();
 830 
 831                         if (mCurrentNote.isDeleted()) {
 832                             List&lt;String&gt; deletedNoteIds = new ArrayList&lt;&gt;();
 833                             deletedNoteIds.add(mCurrentNote.getSimperiumKey());
 834                             mUndoBarController.setDeletedNoteIds(deletedNoteIds);
<abbr title=" 835                             mUndoBarController.showUndoBar(getUndoView(), getString(R.string.note_deleted), null);"> 835                             mUndoBarController.showUndoBar(getUndoView(), getString(R.string.note_deletedðŸ”µ</abbr>
 836                             AnalyticsTracker.track(
 837                                     AnalyticsTracker.Stat.LIST_NOTE_DELETED,
 838                                     AnalyticsTracker.CATEGORY_NOTE,
 839                                     &quot;overflow_menu&quot;
 840                             );
 841                         } else {
 842                             AnalyticsTracker.track(
 843                                     AnalyticsTracker.Stat.EDITOR_NOTE_RESTORED,
 844                                     AnalyticsTracker.CATEGORY_NOTE,
 845                                     &quot;overflow_menu&quot;
 846                             );
 847                         }
 848                         showDetailPlaceholder();
 849                     }
 850                     NoteListFragment fragment = getNoteListFragment();
 851                     if (fragment != null) {
 852                         fragment.getPrefs();
 853                         fragment.refreshList();
 854                     }
 855                 }
 856                 return true;
 857             case R.id.menu_empty_trash:
 858                 AlertDialog.Builder alert = new AlertDialog.Builder(this);
 859 
 860                 alert.setTitle(R.string.empty_trash);
 861                 alert.setMessage(R.string.confirm_empty_trash);
 862                 alert.setPositiveButton(R.string.yes, new DialogInterface.OnClickListener() {
 863                     public void onClick(DialogInterface dialog, int whichButton) {
 864                         new emptyTrashTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR);
 865                         AnalyticsTracker.track(
 866                                 AnalyticsTracker.Stat.LIST_TRASH_EMPTIED,
 867                                 AnalyticsTracker.CATEGORY_NOTE,
 868                                 &quot;overflow_menu&quot;
 869                         );
 870                     }
 871                 });
 872                 alert.setNegativeButton(R.string.no, new DialogInterface.OnClickListener() {
 873                     public void onClick(DialogInterface dialog, int whichButton) {
 874                         // Do nothing, just closing the dialog
 875                     }
 876                 });
 877                 alert.show();
 878                 return true;
 879             case android.R.id.home:
 880                 invalidateOptionsMenu();
 881                 return true;
 882             default:
 883                 return super.onOptionsItemSelected(item);
 884         }
 885     }
 886 
 887     @Override
 888     public boolean onPrepareOptionsMenu(Menu menu) {
 889         MenuItem markdownItem = menu.findItem(R.id.menu_markdown_preview);
 890 
 891         if (mIsShowingMarkdown) {
 892             if (ThemeUtils.isLightTheme(NotesActivity.this)) {
 893                 markdownItem.setIcon(R.drawable.ic_markdown_grey_solid_24dp);
 894             } else {
 895                 markdownItem.setIcon(R.drawable.ic_markdown_blue_solid_24dp);
 896             }
 897 
 898             markdownItem.setTitle(getString(R.string.markdown_hide));
 899         } else {
 900             if (ThemeUtils.isLightTheme(NotesActivity.this)) {
 901                 markdownItem.setIcon(R.drawable.ic_markdown_grey_outline_24dp);
 902             } else {
 903                 markdownItem.setIcon(R.drawable.ic_markdown_blue_outline_24dp);
 904             }
 905 
 906             markdownItem.setTitle(getString(R.string.markdown_show));
 907         }
 908 
 909         return super.onPrepareOptionsMenu(menu);
 910     }
 911 
 912     /**
 913      * Callback method from {@link NoteListFragment.Callbacks} indicating that
 914      * the item with the given ID was selected. Used for tablets only.
 915      */
 916     @Override
<abbr title=" 917     public void onNoteSelected(String noteID, int position, boolean isNew, String matchOffsets, boolean isMarkdownEnabled) {"> 917     public void onNoteSelected(String noteID, int position, boolean isNew, String matchOffsets, boolean iðŸ”µ</abbr>
 918         if (!DisplayUtils.isLargeScreenLandscape(this)) {
 919             // Launch the editor activity
 920             Bundle arguments = new Bundle();
 921             arguments.putString(NoteEditorFragment.ARG_ITEM_ID, noteID);
 922             arguments.putBoolean(NoteEditorFragment.ARG_NEW_NOTE, isNew);
 923             arguments.putBoolean(NoteEditorFragment.ARG_MARKDOWN_ENABLED, isMarkdownEnabled);
 924 
 925             if (matchOffsets != null)
 926                 arguments.putString(NoteEditorFragment.ARG_MATCH_OFFSETS, matchOffsets);
 927 
 928             Intent editNoteIntent = new Intent(this, NoteEditorActivity.class);
 929             editNoteIntent.putExtras(arguments);
 930             startActivityForResult(editNoteIntent, Simplenote.INTENT_EDIT_NOTE);
 931         } else {
 932             mNoteEditorFragment.setIsNewNote(isNew);
 933             mNoteEditorFragment.setNote(noteID, matchOffsets);
 934             getNoteListFragment().setNoteSelected(noteID);
 935 
 936             if (mSearchView != null &amp;&amp; mSearchView.getQuery() != null) {
 937                 mTabletSearchQuery = mSearchView.getQuery().toString();
 938             }
 939 
 940             mNoteEditorFragment.clearMarkdown();
 941 
 942             if (!isMarkdownEnabled &amp;&amp; mIsShowingMarkdown) {
 943                 mNoteEditorFragment.hideMarkdown();
 944                 mIsShowingMarkdown = false;
 945             }
 946 
 947             invalidateOptionsMenu();
 948         }
 949 
 950         AnalyticsTracker.track(
 951                 AnalyticsTracker.Stat.LIST_NOTE_OPENED,
 952                 AnalyticsTracker.CATEGORY_NOTE,
 953                 &quot;note_list_row_tap&quot;
 954         );
 955     }
 956 
 957     @Override
 958     public void onUserCreated(User user) {
 959         // New account created
 960         AnalyticsTracker.track(
 961                 AnalyticsTracker.Stat.USER_ACCOUNT_CREATED,
 962                 AnalyticsTracker.CATEGORY_USER,
 963                 &quot;account_created_from_login_activity&quot;
 964         );
 965     }
 966 
 967     public void onUserStatusChange(User.Status status) {
 968         switch (status) {
 969             // successfully used access token to connect to simperium bucket
 970             case AUTHORIZED:
 971                 runOnUiThread(new Runnable() {
 972                     @Override
 973                     public void run() {
 974                         if (!mNotesBucket.hasChangeVersion()) {
 975                             setToolbarProgressVisibility(true);
 976                         }
 977                     }
 978                 });
 979                 break;
 980 
 981             // NOT_AUTHORIZED means we attempted to connect but the token was not valid
 982             case NOT_AUTHORIZED:
 983                 runOnUiThread(new Runnable() {
 984                     @Override
 985                     public void run() {
 986                         startLoginActivity(true);
 987                     }
 988                 });
 989                 break;
 990 
<abbr title=" 991             // Default starting state of User, don&#x27;t do anything we allow use of app while not signed in so don&#x27;t do anything"> 991             // Default starting state of User, don&#x27;t do anything we allow use of app while not signed in ðŸ”µ</abbr>
 992             case UNKNOWN:
 993                 break;
 994         }
 995     }
 996 
 997     private void setToolbarProgressVisibility(boolean isVisible) {
 998         if (getSupportActionBar() != null) {
 999             getSupportActionBar().setDisplayShowCustomEnabled(isVisible);
1000         }
1001     }
1002 
1003     public void startLoginActivity(boolean signInFirst) {
1004         Intent loginIntent = new Intent(this, LoginActivity.class);
1005         if (signInFirst)
1006             loginIntent.putExtra(LoginActivity.EXTRA_SIGN_IN_FIRST, true);
1007         startActivityForResult(loginIntent, Simperium.SIGNUP_SIGNIN_REQUEST);
1008     }
1009 
1010     @Override
1011     public void recreate() {
1012         Handler handler = new Handler();
1013         handler.post(new Runnable()
1014         {
1015             @Override
1016             public void run()
1017             {
1018                 if (Build.VERSION.SDK_INT &lt; Build.VERSION_CODES.HONEYCOMB)
1019                 {
1020                     NotesActivity.this.finish();
1021                     NotesActivity.this.startActivity(NotesActivity.this.getIntent());
1022                 } else {
1023                     NotesActivity.super.recreate();
1024                 }
1025             }
1026         });
1027     }
1028 
1029     @Override
1030     protected void onActivityResult(int requestCode, int resultCode, Intent data) {
1031         super.onActivityResult(requestCode, resultCode, data);
1032         switch (requestCode) {
1033             case Simplenote.INTENT_PREFERENCES:
1034                 if (ThemeUtils.themeWasChanged(data)) {
1035                     // Restart this activity to apply the new theme
1036                     recreate();
1037                     break;
1038                 }
<abbr title="1039                 // nbradbury - refresh note list when user returns from preferences (in case they changed anything)">1039                 // nbradbury - refresh note list when user returns from preferences (in case they changedðŸ”µ</abbr>
1040                 invalidateOptionsMenu();
1041                 NoteListFragment fragment = getNoteListFragment();
1042                 if (fragment != null) {
1043                     fragment.getPrefs();
1044                     fragment.refreshList();
1045                 }
1046                 break;
1047             case Simplenote.INTENT_EDIT_NOTE:
<abbr title="1048                 if (resultCode == RESULT_OK &amp;&amp; data != null &amp;&amp; data.hasExtra(Simplenote.DELETED_NOTE_ID)) {">1048                 if (resultCode == RESULT_OK &amp;&amp; data != null &amp;&amp; data.hasExtra(Simplenote.DELETED_NOTE_ID))ðŸ”µ</abbr>
1049                     String noteId = data.getStringExtra(Simplenote.DELETED_NOTE_ID);
1050                     if (noteId != null) {
1051                         List&lt;String&gt; deletedNoteIds = new ArrayList&lt;&gt;();
1052                         deletedNoteIds.add(noteId);
1053                         mUndoBarController.setDeletedNoteIds(deletedNoteIds);
<abbr title="1054                         mUndoBarController.showUndoBar(getUndoView(), getString(R.string.note_deleted), null);">1054                         mUndoBarController.showUndoBar(getUndoView(), getString(R.string.note_deleted), nðŸ”µ</abbr>
1055                     }
1056                 }
1057                 break;
1058             case Simperium.SIGNUP_SIGNIN_REQUEST:
1059                 invalidateOptionsMenu();
1060 
1061                 Simplenote app = (Simplenote)getApplication();
1062                 AnalyticsTracker.refreshMetadata(app.getSimperium().getUser().getEmail());
1063 
1064                 AnalyticsTracker.track(
1065                         AnalyticsTracker.Stat.USER_SIGNED_IN,
1066                         AnalyticsTracker.CATEGORY_USER,
1067                         &quot;signed_in_from_login_activity&quot;
1068                 );
1069 
1070                 if (resultCode == Activity.RESULT_CANCELED &amp;&amp; userAuthenticationIsInvalid()) {
1071                     finish();
1072                 }
1073 
1074                 break;
1075         }
1076     }
1077 
1078     @Override
1079     public void onUndo() {
1080         if (mUndoBarController == null) return;
1081 
1082         List&lt;String&gt; deletedNoteIds = mUndoBarController.getDeletedNoteIds();
1083         if (deletedNoteIds != null) {
1084             for (int i = 0; i &lt; deletedNoteIds.size(); i++) {
1085                 Note deletedNote;
1086                 try {
1087                     deletedNote = mNotesBucket.get(deletedNoteIds.get(i));
1088                 } catch (BucketObjectMissingException e) {
1089                     return;
1090                 }
1091                 if (deletedNote != null) {
1092                     deletedNote.setDeleted(false);
1093                     deletedNote.setModificationDate(Calendar.getInstance());
1094                     deletedNote.save();
1095                     NoteListFragment fragment = getNoteListFragment();
1096                     if (fragment != null) {
1097                         fragment.getPrefs();
1098                         fragment.refreshList();
1099                     }
1100                 }
1101             }
1102         }
1103     }
1104 
1105     @Override
1106     protected void onPostCreate(Bundle savedInstanceState) {
1107         super.onPostCreate(savedInstanceState);
1108         // Sync the toggle state after onRestoreInstanceState has occurred.
1109         mDrawerToggle.syncState();
1110     }
1111 
1112     @Override
1113     public void onConfigurationChanged(Configuration newConfig) {
1114         super.onConfigurationChanged(newConfig);
1115 
1116         mDrawerToggle.onConfigurationChanged(newConfig);
1117 
1118         if (DisplayUtils.isLargeScreen(this)) {
1119             mIsShowingMarkdown = false;
1120 
1121             if (newConfig.orientation == Configuration.ORIENTATION_LANDSCAPE) {
1122                 // Add the editor fragment
1123                 addEditorFragment();
1124                 if (mNoteListFragment != null) {
1125                     mNoteListFragment.setActivateOnItemClick(true);
1126                     mNoteListFragment.setDividerVisible(true);
1127                 }
1128                 // Select the current note on a tablet
1129                 if (mCurrentNote != null)
<abbr title="1130                     onNoteSelected(mCurrentNote.getSimperiumKey(), 0, false, null, mCurrentNote.isMarkdownEnabled());">1130                     onNoteSelected(mCurrentNote.getSimperiumKey(), 0, false, null, mCurrentNote.isMarkdowðŸ”µ</abbr>
1131                 else {
1132                     mNoteEditorFragment.setPlaceholderVisible(true);
1133                     mNoteListFragment.getListView().clearChoices();
1134                 }
1135                 invalidateOptionsMenu();
<abbr title="1136             } else if (newConfig.orientation == Configuration.ORIENTATION_PORTRAIT &amp;&amp; mNoteEditorFragment != null) {">1136             } else if (newConfig.orientation == Configuration.ORIENTATION_PORTRAIT &amp;&amp; mNoteEditorFragmentðŸ”µ</abbr>
1137                 // Remove the editor fragment when rotating back to portrait
1138                 mCurrentNote = null;
1139                 if (mNoteListFragment != null) {
1140                     mNoteListFragment.setActivateOnItemClick(false);
1141                     mNoteListFragment.setDividerVisible(false);
1142                     mNoteListFragment.setActivatedPosition(ListView.INVALID_POSITION);
1143                     mNoteListFragment.refreshList();
1144                 }
1145                 FragmentManager fm = getSupportFragmentManager();
1146                 FragmentTransaction ft = fm.beginTransaction();
1147                 ft.remove(mNoteEditorFragment);
1148                 mNoteEditorFragment = null;
1149                 ft.commitAllowingStateLoss();
1150                 fm.executePendingTransactions();
1151                 invalidateOptionsMenu();
1152             }
1153         }
1154     }
1155 
1156     public void checkEmptyListText(boolean isSearch) {
1157         if (isSearch) {
<abbr title="1158             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_found) + &quot;&lt;/strong&gt;&quot;);">1158             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_found) + &quot;ðŸ”µ</abbr>
1159             getNoteListFragment().setEmptyListViewClickable(false);
1160         } else if (mDrawerList.getCheckedItemPosition() == TRASH_SELECTED_ID) {
<abbr title="1161             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.trash_is_empty) + &quot;&lt;/strong&gt;&quot;);">1161             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.trash_is_empty) + &quot;ðŸ”µ</abbr>
1162             AnalyticsTracker.track(
1163                     AnalyticsTracker.Stat.LIST_TRASH_VIEWED,
1164                     AnalyticsTracker.CATEGORY_NOTE,
1165                     &quot;trash_filter_selected&quot;
1166             );
1167             getNoteListFragment().setEmptyListViewClickable(false);
1168         } else {
<abbr title="1169             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here) + &quot;&lt;/strong&gt;&lt;br /&gt;&quot; + String.format(getString(R.string.why_not_create_one), &quot;&lt;u&gt;&quot;, &quot;&lt;/u&gt;&quot;));">1169             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here) + &quot;&lt;ðŸ”µ</abbr>
1170             getNoteListFragment().setEmptyListViewClickable(true);
1171         }
1172     }
1173 
1174     public void showDetailPlaceholder() {
1175         if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; mNoteEditorFragment != null) {
1176             mCurrentNote = null;
1177             mNoteEditorFragment.setPlaceholderVisible(true);
1178             mNoteEditorFragment.clearMarkdown();
1179             mNoteEditorFragment.hideMarkdown();
1180             mIsShowingMarkdown = false;
1181         }
1182     }
1183 
1184     public void stopListeningToNotesBucket() {
1185         mNotesBucket.removeOnNetworkChangeListener(this);
1186         mNotesBucket.removeOnSaveObjectListener(this);
1187         mNotesBucket.removeOnDeleteObjectListener(this);
1188     }
1189 
1190     // Returns the appropriate view to show the undo bar within
1191     private View getUndoView() {
1192         View undoView = mFragmentsContainer;
1193         if (!DisplayUtils.isLargeScreenLandscape(this) &amp;&amp;
1194                 getNoteListFragment() != null &amp;&amp;
1195                 getNoteListFragment().getRootView() != null) {
1196             undoView = getNoteListFragment().getRootView();
1197         }
1198 
1199         return undoView;
1200     }
1201 
1202     public void showUndoBarWithNoteIds(List&lt;String&gt; noteIds) {
1203         if (mUndoBarController != null) {
1204             mUndoBarController.setDeletedNoteIds(noteIds);
1205             mUndoBarController.showUndoBar(
1206                     getUndoView(),
<abbr title="1207                     getResources().getQuantityString(R.plurals.trashed_notes, noteIds.size(), noteIds.size()),">1207                     getResources().getQuantityString(R.plurals.trashed_notes, noteIds.size(), noteIds.sizðŸ”µ</abbr>
1208                     null
1209             );
1210         }
1211     }
1212 
1213     private class emptyTrashTask extends AsyncTask&lt;Void, Void, Void&gt; {
1214 
1215         @Override
1216         protected Void doInBackground(Void... voids) {
1217             if (mNotesBucket == null) return null;
1218 
1219             Query&lt;Note&gt; query = Note.allDeleted(mNotesBucket);
1220             Bucket.ObjectCursor c = query.execute();
1221             while (c.moveToNext()) {
1222                 c.getObject().delete();
1223             }
1224 
1225             return null;
1226         }
1227 
1228         @Override
1229         protected void onPostExecute(Void nada) {
1230             showDetailPlaceholder();
1231         }
1232     }
1233 
1234 
1235     /* Simperium Bucket Listeners */
1236     // received a change from the network, refresh the list
1237     @Override
1238     public void onNetworkChange(Bucket&lt;Note&gt; bucket, final Bucket.ChangeType type, String key) {
1239         runOnUiThread(new Runnable() {
1240             @Override
1241             public void run() {
1242                 if (type == Bucket.ChangeType.INDEX) {
1243                     setToolbarProgressVisibility(false);
1244                 }
1245                 mNoteListFragment.refreshList();
1246             }
1247         });
1248     }
1249 
1250     @Override
1251     public void onSaveObject(Bucket&lt;Note&gt; bucket, Note object) {
1252         runOnUiThread(new Runnable() {
1253             @Override
1254             public void run() {
1255                 mNoteListFragment.refreshList();
1256             }
1257         });
1258     }
1259 
1260     @Override
1261     public void onDeleteObject(Bucket&lt;Note&gt; bucket, Note object) {
1262         runOnUiThread(new Runnable() {
1263             @Override
1264             public void run() {
1265                 mNoteListFragment.refreshList();
1266             }
1267         });
1268     }
1269 
1270     @Override
1271     public void onBeforeUpdateObject(Bucket&lt;Note&gt; bucket, Note note) {
1272         // noop, NoteEditorFragment will handle this
1273     }
1274 
1275     // Tags bucket listener
1276     private Bucket.Listener&lt;Tag&gt; mTagsMenuUpdater = new Bucket.Listener&lt;Tag&gt;() {
1277         void updateNavigationDrawer() {
1278             runOnUiThread(new Runnable() {
1279                 public void run() {
1280                     updateNavigationDrawerItems();
1281                 }
1282             });
1283         }
1284 
1285         @Override
1286         public void onSaveObject(Bucket&lt;Tag&gt; bucket, Tag tag) {
1287             updateNavigationDrawer();
1288         }
1289 
1290         @Override
1291         public void onDeleteObject(Bucket&lt;Tag&gt; bucket, Tag tag) {
1292             updateNavigationDrawer();
1293         }
1294 
1295         @Override
1296         public void onNetworkChange(Bucket&lt;Tag&gt; bucket, Bucket.ChangeType type, String key) {
1297             updateNavigationDrawer();
1298         }
1299 
1300         @Override
1301         public void onBeforeUpdateObject(Bucket&lt;Tag&gt; bucket, Tag object) {
1302             // noop
1303         }
1304     };
1305 }</pre></td>
                            <td><pre>   1 package com.automattic.simplenote;
   2 
   3 import android.app.Activity;
   4 import android.app.AlertDialog;
   5 import android.content.DialogInterface;
   6 import android.content.Intent;
   7 import android.content.SharedPreferences;
   8 import android.content.res.Configuration;
   9 import android.os.AsyncTask;
  10 import android.os.Build;
  11 import android.os.Bundle;
  12 import android.os.Handler;
  13 import android.preference.PreferenceManager;
  14 import android.support.design.widget.NavigationView;
  15 import android.support.v4.content.ContextCompat;
  16 import android.support.v4.app.FragmentManager;
  17 import android.support.v4.app.FragmentTransaction;
  18 import android.support.v4.view.GravityCompat;
  19 import android.support.v4.view.MenuItemCompat;
  20 import android.support.v4.widget.DrawerLayout;
  21 import android.support.v7.app.ActionBar;
  22 import android.support.v7.app.ActionBarDrawerToggle;
  23 import android.support.v7.app.AppCompatActivity;
  24 import android.support.v7.widget.SearchView;
  25 import android.support.v7.widget.Toolbar;
  26 import android.text.Html;
  27 import android.text.Spannable;
  28 import android.text.SpannableString;
  29 import android.text.TextUtils;
  30 import android.view.Menu;
  31 import android.view.MenuInflater;
  32 import android.view.MenuItem;
  33 import android.view.View;
  34 import android.view.WindowManager;
  35 import android.widget.AdapterView;
  36 import android.widget.ListView;
  37 import android.widget.ProgressBar;
  38 import android.widget.TextView;
  39 
  40 import com.automattic.simplenote.analytics.AnalyticsTracker;
  41 import com.automattic.simplenote.models.Note;
  42 import com.automattic.simplenote.models.Tag;
  43 import com.automattic.simplenote.utils.AniUtils;
  44 import com.automattic.simplenote.utils.DisplayUtils;
  45 import com.automattic.simplenote.utils.DrawableUtils;
  46 import com.automattic.simplenote.utils.PrefUtils;
  47 import com.automattic.simplenote.utils.StrUtils;
  48 import com.automattic.simplenote.utils.TagsAdapter;
  49 import com.automattic.simplenote.utils.ThemeUtils;
  50 import com.automattic.simplenote.utils.UndoBarController;
  51 import com.automattic.simplenote.widgets.TypefaceSpan;
  52 import com.simperium.Simperium;
  53 import com.simperium.android.LoginActivity;
  54 import com.simperium.client.Bucket;
  55 import com.simperium.client.BucketObjectMissingException;
  56 import com.simperium.client.BucketObjectNameInvalid;
  57 import com.simperium.client.Query;
  58 import com.simperium.client.User;
  59 
  60 import org.wordpress.passcodelock.AppLockManager;
  61 
  62 import java.util.ArrayList;
  63 import java.util.Calendar;
  64 import java.util.List;
  65 
  66 public class NotesActivity extends AppCompatActivity implements
<abbr title="  67         NoteListFragment.Callbacks, User.StatusChangeListener, Simperium.OnUserCreatedListener, UndoBarController.UndoListener,">  67         NoteListFragment.Callbacks, User.StatusChangeListener, Simperium.OnUserCreatedListener, UndoBarCoðŸ”µ</abbr>
  68         Bucket.Listener&lt;Note&gt; {
  69 
  70     public static String TAG_NOTE_LIST = &quot;noteList&quot;;
  71     public static String TAG_NOTE_EDITOR = &quot;noteEditor&quot;;
  72     private int TRASH_SELECTED_ID = 2;
  73 
  74     private boolean mIsMarkdownEnabledGlobal;
  75     private boolean mIsShowingMarkdown;
  76     private boolean mShouldSelectNewNote;
  77     private String mTabletSearchQuery;
  78     private UndoBarController mUndoBarController;
  79     private View mFragmentsContainer;
  80     private View mWelcomeView;
  81     private SearchView mSearchView;
  82     private MenuItem mSearchMenuItem;
  83     private NoteListFragment mNoteListFragment;
  84     private NoteEditorFragment mNoteEditorFragment;
  85     private Note mCurrentNote;
  86     protected Bucket&lt;Note&gt; mNotesBucket;
  87     protected Bucket&lt;Tag&gt; mTagsBucket;
  88     private MenuItem mEmptyTrashMenuItem;
  89 
  90     // Menu drawer
  91     private DrawerLayout mDrawerLayout;
  92     private ListView mDrawerList;
  93     private NavigationView mNavigationView;
  94     private ActionBarDrawerToggle mDrawerToggle;
  95     private TagsAdapter mTagsAdapter;
  96     private TagsAdapter.TagMenuItem mSelectedTag;
  97 
  98     @Override
  99     protected void onCreate(Bundle savedInstanceState) {
 100         // On lollipop, configure the translucent status bar
 101         if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.LOLLIPOP) {
 102             getWindow().addFlags(WindowManager.LayoutParams.FLAG_DRAWS_SYSTEM_BAR_BACKGROUNDS);
 103             getWindow().setStatusBarColor(ContextCompat.getColor(this, R.color.transparent));
 104         }
 105 
 106         ThemeUtils.setTheme(this);
 107         super.onCreate(savedInstanceState);
 108         setContentView(R.layout.activity_notes);
 109 
 110         mFragmentsContainer = findViewById(R.id.note_fragment_container);
 111 
 112         Simplenote currentApp = (Simplenote) getApplication();
 113         if (mNotesBucket == null) {
 114             mNotesBucket = currentApp.getNotesBucket();
 115         }
 116 
 117         if (mTagsBucket == null) {
 118             mTagsBucket = currentApp.getTagsBucket();
 119         }
 120 
 121         Toolbar toolbar = (Toolbar) findViewById(R.id.toolbar);
 122         setSupportActionBar(toolbar);
 123         configureNavigationDrawer(toolbar);
 124 
 125         if (savedInstanceState == null) {
 126             mNoteListFragment = new NoteListFragment();
 127             FragmentTransaction fragmentTransaction = getSupportFragmentManager().beginTransaction();
 128             fragmentTransaction.add(R.id.note_fragment_container, mNoteListFragment, TAG_NOTE_LIST);
 129             fragmentTransaction.commit();
 130         } else {
<abbr title=" 131             mNoteListFragment = (NoteListFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_LIST);"> 131             mNoteListFragment = (NoteListFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTEðŸ”µ</abbr>
 132         }
 133 
 134         if (DisplayUtils.isLargeScreen(this)) {
 135             if (getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR) != null) {
<abbr title=" 136                 mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR);"> 136                 mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByTag(ðŸ”µ</abbr>
 137             } else if (DisplayUtils.isLandscape(this)) {
 138                 addEditorFragment();
 139             }
 140         }
 141 
 142         // enable ActionBar app icon to behave as action to toggle nav drawer
 143         ActionBar actionBar = getSupportActionBar();
 144         if (actionBar != null) {
 145             actionBar.setDisplayHomeAsUpEnabled(true);
 146             actionBar.setHomeButtonEnabled(true);
 147 
 148             // Add loading indicator to show when indexing
<abbr title=" 149             ProgressBar progressBar = (ProgressBar) getLayoutInflater().inflate(R.layout.progressbar_toolbar, null);"> 149             ProgressBar progressBar = (ProgressBar) getLayoutInflater().inflate(R.layout.progressbar_toolðŸ”µ</abbr>
 150             actionBar.setDisplayShowCustomEnabled(true);
 151             actionBar.setCustomView(progressBar);
 152             setToolbarProgressVisibility(false);
 153         }
 154 
 155         mUndoBarController = new UndoBarController(this);
 156 
 157         // Creates &#x27;Welcome&#x27; note
 158         checkForFirstLaunch();
 159 
 160         checkForSharedContent();
 161 
 162         currentApp.getSimperium().setOnUserCreatedListener(this);
 163         currentApp.getSimperium().setUserStatusChangeListener(this);
 164     }
 165 
 166     @Override
 167     protected void onResume() {
 168         super.onResume();
 169 
 170         // Ensure user has valid authorization
 171         if (userAuthenticationIsInvalid()) {
 172             startLoginActivity(true);
 173         }
 174 
 175         mNotesBucket.start();
 176         mTagsBucket.start();
 177 
 178         mNotesBucket.addOnNetworkChangeListener(this);
 179         mNotesBucket.addOnSaveObjectListener(this);
 180         mNotesBucket.addOnDeleteObjectListener(this);
 181         mTagsBucket.addListener(mTagsMenuUpdater);
 182 
 183         setWelcomeViewVisibility();
 184         updateNavigationDrawerItems();
 185 
 186         // if the user is not authenticated and the tag doesn&#x27;t exist revert to default drawer selection
 187         if (userIsUnauthorized()) {
 188             if (-1 == mTagsAdapter.getPosition(mSelectedTag)) {
 189                 mSelectedTag = null;
 190                 mDrawerList.setSelection(TagsAdapter.DEFAULT_ITEM_POSITION);
 191             }
 192         }
 193 
 194         setSelectedTagActive();
 195 
 196         if (mCurrentNote != null &amp;&amp; mShouldSelectNewNote) {
<abbr title=" 197             onNoteSelected(mCurrentNote.getSimperiumKey(), 0, true, null, mCurrentNote.isMarkdownEnabled());"> 197             onNoteSelected(mCurrentNote.getSimperiumKey(), 0, true, null, mCurrentNote.isMarkdownEnabled(ðŸ”µ</abbr>
 198             mShouldSelectNewNote = false;
 199         }
 200 
<abbr title=" 201         mIsMarkdownEnabledGlobal = PrefUtils.getBoolPref(NotesActivity.this, PrefUtils.PREF_MARKDOWN_ENABLED, false);"> 201         mIsMarkdownEnabledGlobal = PrefUtils.getBoolPref(NotesActivity.this, PrefUtils.PREF_MARKDOWN_ENABðŸ”µ</abbr>
 202     }
 203 
 204     @Override
 205     protected void onPause() {
 206         super.onPause();
 207 
 208         mTagsBucket.removeListener(mTagsMenuUpdater);
 209 
 210         mNotesBucket.removeOnNetworkChangeListener(this);
 211         mNotesBucket.removeOnSaveObjectListener(this);
 212         mNotesBucket.removeOnDeleteObjectListener(this);
 213     }
 214 
 215     @Override
 216     public void setTitle(CharSequence title) {
 217         if (title == null) {
 218             title = &quot;&quot;;
 219         }
 220 
 221         setTitleWithCustomFont(title);
 222     }
 223 
 224     @Override
 225     public void onBackPressed() {
 226         if (mDrawerLayout != null &amp;&amp; mDrawerLayout.isDrawerOpen(GravityCompat.START)) {
 227             mDrawerLayout.closeDrawer(GravityCompat.START);
 228         } else {
 229             super.onBackPressed();
 230         }
 231     }
 232 
 233     private void setTitleWithCustomFont(CharSequence title) {
 234         if (getSupportActionBar() == null) return;
 235 
 236         // LG devices running 4.1 can&#x27;t handle a custom font in the action bar title
 237         if ((!TextUtils.isEmpty(Build.BRAND) &amp;&amp; Build.BRAND.toLowerCase().contains(&quot;lge&quot;))
 238                 &amp;&amp; Build.VERSION.SDK_INT &lt;= Build.VERSION_CODES.JELLY_BEAN) {
 239             getSupportActionBar().setTitle(title);
 240             return;
 241         }
 242 
 243         SpannableString s = new SpannableString(title);
 244         s.setSpan(new TypefaceSpan(this), 0, s.length(), Spannable.SPAN_EXCLUSIVE_EXCLUSIVE);
 245         getSupportActionBar().setTitle(s);
 246     }
 247 
 248     private void configureNavigationDrawer(Toolbar toolbar) {
 249         mDrawerLayout = (DrawerLayout) findViewById(R.id.drawer_layout);
 250         mDrawerLayout.setDrawerShadow(R.drawable.drawer_shadow, GravityCompat.START);
 251         mNavigationView = (NavigationView) findViewById(R.id.navigation_view);
 252         mDrawerList = (ListView) findViewById(R.id.drawer_list);
 253 
 254         // Configure welcome view in the nav drawer
 255         mWelcomeView = mDrawerLayout.findViewById(R.id.welcome_view);
 256         TextView welcomeSignInButton = (TextView)mDrawerLayout.findViewById(R.id.welcome_sign_in_button);
 257         welcomeSignInButton.setOnClickListener(new View.OnClickListener() {
 258             @Override
 259             public void onClick(View v) {
 260                 startLoginActivity(true);
 261             }
 262         });
 263 
 264         TextView welcomeCloseButton = (TextView)mDrawerLayout.findViewById(R.id.welcome_close);
 265                 welcomeCloseButton.setOnClickListener(new View.OnClickListener() {
 266                     @Override
 267                     public void onClick(View v) {
 268                         removeWelcomeView();
 269                     }
 270                 });
 271 
 272         View settingsButton = findViewById(R.id.nav_settings);
 273         settingsButton.setOnClickListener(new View.OnClickListener() {
 274             @Override
 275             public void onClick(View v) {
 276                 Intent i = new Intent(NotesActivity.this, PreferencesActivity.class);
 277                 startActivityForResult(i, Simplenote.INTENT_PREFERENCES);
 278             }
 279         });
 280 
 281         mNavigationView.getLayoutParams().width = ThemeUtils.getOptimalDrawerWidth(this);
 282         mTagsAdapter = new TagsAdapter(this, mNotesBucket, mDrawerList.getHeaderViewsCount());
 283         mDrawerList.setAdapter(mTagsAdapter);
 284         // Set the list&#x27;s click listener
 285         mDrawerList.setOnItemClickListener(new DrawerItemClickListener());
 286 
 287         if (mSelectedTag == null)
 288             mSelectedTag = mTagsAdapter.getDefaultItem();
 289 
 290         mDrawerToggle = new ActionBarDrawerToggle(this, mDrawerLayout, toolbar, R.string.open_drawer,
 291                 R.string.close_drawer) {
 292             public void onDrawerClosed(View view) {
 293                 supportInvalidateOptionsMenu();
 294             }
 295 
 296             public void onDrawerOpened(View drawerView) {
 297                 // noop
 298             }
 299         };
 300 
 301         mDrawerLayout.addDrawerListener(mDrawerToggle);
 302     }
 303 
 304     private void setWelcomeViewVisibility() {
 305         if (mWelcomeView == null) return;
 306         // Hide welcome view if user is signed in or closed the welcome view
 307         if (userIsAuthorized() || PrefUtils.getBoolPref(this, PrefUtils.PREF_APP_TRIAL)) {
 308             mWelcomeView.setVisibility(View.GONE);
 309         } else {
 310             mWelcomeView.setVisibility(View.VISIBLE);
 311             mWelcomeView.setAlpha(1.0f);
 312         }
 313     }
 314 
 315     private void removeWelcomeView() {
 316         if (mWelcomeView == null) return;
 317 
 318         AniUtils.swipeOutToLeft(mWelcomeView);
 319 
 320         // Set preference so the welcome view never shows again
 321         SharedPreferences preferences = PreferenceManager.getDefaultSharedPreferences(this);
 322         SharedPreferences.Editor editor = preferences.edit();
 323         editor.putBoolean(PrefUtils.PREF_APP_TRIAL, true);
 324         editor.apply();
 325     }
 326 
 327     private void checkForFirstLaunch() {
 328         if (PrefUtils.getBoolPref(this, PrefUtils.PREF_FIRST_LAUNCH, true)) {
 329             // Create the welcome note
 330             try {
 331                 Note welcomeNote = mNotesBucket.newObject(&quot;welcome-android&quot;);
 332                 welcomeNote.setCreationDate(Calendar.getInstance());
 333                 welcomeNote.setModificationDate(welcomeNote.getCreationDate());
 334                 welcomeNote.setContent(getString(R.string.welcome_note));
 335                 welcomeNote.getTitle();
 336                 welcomeNote.save();
 337             } catch (BucketObjectNameInvalid e) {
 338                 // this won&#x27;t happen because welcome-android is a valid name
 339             }
 340 
 341             SharedPreferences preferences = PreferenceManager.getDefaultSharedPreferences(this);
 342             SharedPreferences.Editor editor = preferences.edit();
 343             editor.putBoolean(PrefUtils.PREF_FIRST_LAUNCH, false);
 344             editor.apply();
 345         }
 346     }
 347 
 348     private void checkForSharedContent() {
 349         if (getIntent().hasExtra(Intent.EXTRA_TEXT)) {
 350             // Check share action
 351             Intent intent = getIntent();
 352             String subject = intent.getStringExtra(Intent.EXTRA_SUBJECT);
 353             String text = intent.getStringExtra(Intent.EXTRA_TEXT);
 354 
<abbr title=" 355             // Don&#x27;t add the &#x27;Note to self&#x27; subject or open the note if this was shared from a voice search"> 355             // Don&#x27;t add the &#x27;Note to self&#x27; subject or open the note if this was shared from a voice searðŸ”µ</abbr>
 356             String intentAction = StrUtils.notNullStr(intent.getAction());
 357             boolean isVoiceShare = intentAction.equals(&quot;com.google.android.gm.action.AUTO_SEND&quot;);
 358             if (!TextUtils.isEmpty(text)) {
 359                 if (!TextUtils.isEmpty(subject) &amp;&amp; !isVoiceShare) {
 360                     text = subject + &quot;\n\n&quot; + text;
 361                 }
 362                 Note note = mNotesBucket.newObject();
 363                 note.setCreationDate(Calendar.getInstance());
 364                 note.setModificationDate(note.getCreationDate());
 365                 note.setContent(text);
 366                 note.save();
 367                 setCurrentNote(note);
 368 
 369                 if (!isVoiceShare) {
 370                     mShouldSelectNewNote = true;
 371                 }
 372                 AnalyticsTracker.track(
 373                         AnalyticsTracker.Stat.LIST_NOTE_CREATED,
 374                         AnalyticsTracker.CATEGORY_NOTE,
 375                         &quot;external_share&quot;
 376                 );
 377 
 378                 if (!DisplayUtils.isLargeScreenLandscape(this)) {
 379                     // Disable the lock screen when sharing content and opening NoteEditorActivity
 380                     // Lock screen activities are enabled again in NoteEditorActivity.onPause()
 381                     if (AppLockManager.getInstance().isAppLockFeatureEnabled()) {
 382                         AppLockManager.getInstance().getCurrentAppLock().setDisabledActivities(
 383                                 new String[]{&quot;com.automattic.simplenote.NotesActivity&quot;,
 384                                 &quot;com.automattic.simplenote.NoteEditorActivity&quot;});
 385                         AppLockManager.getInstance().getCurrentAppLock().setOneTimeTimeout(0);
 386                     }
 387                 }
 388             }
 389         }
 390     }
 391 
 392     private void updateNavigationDrawerItems() {
 393         Bucket.ObjectCursor&lt;Tag&gt; tagCursor = Tag.allWithCount(mTagsBucket).execute();
 394         mTagsAdapter.changeCursor(tagCursor);
 395     }
 396 
 397     private void setSelectedTagActive() {
 398         if (mSelectedTag == null)
 399             mSelectedTag = mTagsAdapter.getDefaultItem();
 400 
 401         setTitle(mSelectedTag.name);
<abbr title=" 402         mDrawerList.setItemChecked(mTagsAdapter.getPosition(mSelectedTag) + mDrawerList.getHeaderViewsCount(), true);"> 402         mDrawerList.setItemChecked(mTagsAdapter.getPosition(mSelectedTag) + mDrawerList.getHeaderViewsCouðŸ”µ</abbr>
 403     }
 404 
 405     /* The click listener for ListView in the navigation drawer */
 406     private class DrawerItemClickListener implements ListView.OnItemClickListener {
 407         @Override
 408         public void onItemClick(AdapterView&lt;?&gt; parent, View view, int position, long id) {
 409 
 410             // Adjust for header view
 411             position -= mDrawerList.getHeaderViewsCount();
 412             mSelectedTag = mTagsAdapter.getItem(position);
 413             checkEmptyListText(false);
 414             // Update checked item in navigation drawer and close it
 415             setSelectedTagActive();
 416             mDrawerLayout.closeDrawer(mNavigationView);
 417 
 418             // Disable long press on notes if we&#x27;re viewing the trash
 419             if (mDrawerList.getCheckedItemPosition() == TRASH_SELECTED_ID) {
 420                 getNoteListFragment().getListView().setLongClickable(false);
 421             } else {
 422                 getNoteListFragment().getListView().setLongClickable(true);
 423             }
 424 
 425             getNoteListFragment().refreshListFromNavSelect();
 426             if (position &gt; 1) {
 427                 AnalyticsTracker.track(
 428                         AnalyticsTracker.Stat.LIST_TAG_VIEWED,
 429                         AnalyticsTracker.CATEGORY_TAG,
 430                         &quot;selected_tag_in_navigation_drawer&quot;
 431                 );
 432             }
 433         }
 434     }
 435 
 436     public TagsAdapter.TagMenuItem getSelectedTag() {
 437         if (mSelectedTag == null) {
 438             mSelectedTag = mTagsAdapter.getDefaultItem();
 439         }
 440 
 441         return mSelectedTag;
 442     }
 443 
 444     // Enable or disable the trash action bar button depending on if there are deleted notes or not
 445     public void updateTrashMenuItem() {
 446         if (mEmptyTrashMenuItem == null || mNotesBucket == null)
 447             return;
 448 
 449         // Disable the trash icon if there are no notes trashed.
 450         Query&lt;Note&gt; query = Note.allDeleted(mNotesBucket);
 451         if (query.count() == 0) {
 452             mEmptyTrashMenuItem.getIcon().setAlpha(127);
 453             mEmptyTrashMenuItem.setEnabled(false);
 454         } else {
 455             mEmptyTrashMenuItem.getIcon().setAlpha(255);
 456             mEmptyTrashMenuItem.setEnabled(true);
 457         }
 458     }
 459 
 460     private void addEditorFragment() {
 461         FragmentManager fm = getSupportFragmentManager();
 462         FragmentTransaction ft = fm.beginTransaction();
 463         mNoteEditorFragment = new NoteEditorFragment();
 464         ft.add(R.id.note_fragment_container, mNoteEditorFragment, TAG_NOTE_EDITOR);
 465         ft.commitAllowingStateLoss();
 466         fm.executePendingTransactions();
 467     }
 468 
 469     /**
 470      * Checks for a previously valid user that is now not authenticated
 471      *
 472      * @return true if user has invalid authorization
 473      */
 474     private boolean userAuthenticationIsInvalid() {
 475         Simplenote currentApp = (Simplenote) getApplication();
 476         Simperium simperium = currentApp.getSimperium();
 477         User user = simperium.getUser();
 478         return user.hasAccessToken() &amp;&amp; user.getStatus().equals(User.Status.NOT_AUTHORIZED);
 479     }
 480 
 481     private boolean userIsUnauthorized() {
 482         Simplenote currentApp = (Simplenote) getApplication();
 483         return currentApp.getSimperium().getUser().getStatus() == User.Status.NOT_AUTHORIZED;
 484     }
 485 
 486     private boolean userIsAuthorized() {
 487         Simplenote app = (Simplenote) getApplication();
 488         return !app.getSimperium().needsAuthorization();
 489     }
 490 
 491     public void setCurrentNote(Note note) {
 492         mCurrentNote = note;
 493     }
 494 
 495     public NoteListFragment getNoteListFragment() {
 496         return mNoteListFragment;
 497     }
 498 
 499     @SuppressWarnings(&quot;ResourceType&quot;)
 500     @Override
 501     public boolean onCreateOptionsMenu(Menu menu) {
 502         super.onCreateOptionsMenu(menu);
 503         MenuInflater inflater = getMenuInflater();
 504         inflater.inflate(R.menu.notes_list, menu);
 505 
 506         // restore the search query if on a landscape tablet
 507         String searchQuery = null;
 508         if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; mSearchView != null)
 509             searchQuery = mSearchView.getQuery().toString();
 510 
 511         mSearchMenuItem = menu.findItem(R.id.menu_search);
 512         mSearchView = (SearchView) mSearchMenuItem.getActionView();
 513 
 514         if (!TextUtils.isEmpty(searchQuery)) {
 515             mSearchView.setQuery(searchQuery, false);
 516             mSearchMenuItem.expandActionView();
 517         } else {
 518             // Workaround for setting the search placeholder text color
 519             String hintHexColor = (ThemeUtils.isLightTheme(this) ?
 520                     getString(R.color.simplenote_light_grey) :
 521                     getString(R.color.simplenote_text_preview)).replace(&quot;ff&quot;, &quot;&quot;);
 522             mSearchView.setQueryHint(Html.fromHtml(String.format(&quot;&lt;font color=\&quot;%s\&quot;&gt;%s&lt;/font&gt;&quot;,
 523                     hintHexColor,
 524                     getString(R.string.search))));
 525         }
 526 
 527         mSearchView.setOnQueryTextListener(new SearchView.OnQueryTextListener() {
 528             @Override
 529             public boolean onQueryTextChange(String newText) {
 530                 if (mSearchMenuItem.isActionViewExpanded()) {
 531                     getNoteListFragment().searchNotes(newText);
 532                 }
 533                 return true;
 534             }
 535 
 536             @Override
 537             public boolean onQueryTextSubmit(String queryText) {
 538                 getNoteListFragment().searchNotes(queryText);
 539                 return true;
 540             }
 541 
 542         });
 543 
<abbr title=" 544         MenuItemCompat.setOnActionExpandListener(mSearchMenuItem, new MenuItemCompat.OnActionExpandListener() {"> 544         MenuItemCompat.setOnActionExpandListener(mSearchMenuItem, new MenuItemCompat.OnActionExpandListenðŸ”µ</abbr>
 545             @Override
 546             public boolean onMenuItemActionExpand(MenuItem menuItem) {
 547                 checkEmptyListText(true);
 548                 if (mNoteListFragment != null) {
 549                     mNoteListFragment.setFloatingActionButtonVisible(false);
 550                 }
 551                 AnalyticsTracker.track(
 552                         AnalyticsTracker.Stat.LIST_NOTES_SEARCHED,
 553                         AnalyticsTracker.CATEGORY_NOTE,
 554                         &quot;action_bar_search_tap&quot;
 555                 );
 556                 return true;
 557             }
 558 
 559             @Override
 560             public boolean onMenuItemActionCollapse(MenuItem menuItem) {
 561                 // Show all notes again
 562                 if (mNoteListFragment != null) {
 563                     mNoteListFragment.setFloatingActionButtonVisible(true);
 564                 }
 565                 mTabletSearchQuery = &quot;&quot;;
 566                 mSearchView.setQuery(&quot;&quot;, false);
 567                 checkEmptyListText(false);
 568                 getNoteListFragment().clearSearch();
 569                 return true;
 570             }
 571         });
 572 
 573         mSearchMenuItem.setOnMenuItemClickListener(new MenuItem.OnMenuItemClickListener() {
 574             @Override
 575             public boolean onMenuItemClick(MenuItem item) {
 576                 if (!mSearchMenuItem.isActionViewExpanded())
 577                     showDetailPlaceholder();
 578                 return false;
 579             }
 580         });
 581 
 582         MenuItem trashItem = menu.findItem(R.id.menu_delete).setTitle(R.string.undelete);
 583         if (mCurrentNote != null &amp;&amp; mCurrentNote.isDeleted())
 584             trashItem.setTitle(R.string.undelete);
 585         else
 586             trashItem.setTitle(R.string.delete);
 587 
 588         if (DisplayUtils.isLargeScreenLandscape(this)) {
 589             // Restore the search query on landscape tablets
 590             if (!TextUtils.isEmpty(mTabletSearchQuery)) {
 591                 mSearchMenuItem.expandActionView();
 592                 mSearchView.setQuery(mTabletSearchQuery, false);
 593                 mSearchView.clearFocus();
 594             }
 595 
 596             if (mCurrentNote != null) {
 597                 menu.findItem(R.id.menu_share).setVisible(true);
 598                 menu.findItem(R.id.menu_view_info).setVisible(true);
 599 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 600                 menu.findItem(R.id.menu_history).setVisible(true);</span>
 601 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 602                 trashItem.setVisible(true);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 603             } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 604                 menu.findItem(R.id.menu_share).setVisible(false);</span>
 605 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 606                 menu.findItem(R.id.menu_markdown_preview).setVisible(mIsMarkdownEnabledGlobal &amp;&amp; mCurrentNote.isMarkdownEnabled());"> 606                 menu.findItem(R.id.menu_markdown_preview).setVisible(mIsMarkdownEnabledGlobal &amp;&amp; mCurrentðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 607                 menu.findItem(R.id.menu_markdown_enable).setVisible(mIsMarkdownEnabledGlobal);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 608                 menu.findItem(R.id.menu_markdown_enable).setChecked(mCurrentNote.isMarkdownEnabled());</span>
 609 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 610                 trashItem.setVisible(true);
 611             } else {
 612                 menu.findItem(R.id.menu_share).setVisible(false);
 613                 menu.findItem(R.id.menu_view_info).setVisible(false);
 614 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 615                 menu.findItem(R.id.menu_history).setVisible(false);</span>
 616 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 617             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 618             menu.findItem(R.id.menu_empty_trash).setVisible(false);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 619         } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 620             menu.findItem(R.id.menu_search).setVisible(true);</span>
 621 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 622                 menu.findItem(R.id.menu_markdown_preview).setVisible(false);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 623                 menu.findItem(R.id.menu_markdown_enable).setVisible(false);</span>
 624 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 625                 trashItem.setVisible(false);
 626             }
 627             menu.findItem(R.id.menu_empty_trash).setVisible(false);
 628         } else {
 629             menu.findItem(R.id.menu_search).setVisible(true);
 630             menu.findItem(R.id.menu_share).setVisible(false);
 631             menu.findItem(R.id.menu_view_info).setVisible(false);
 632 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 633             menu.findItem(R.id.menu_history).setVisible(false);</span>
 634 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 635         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 636 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 637         // Are we looking at the trash? Adjust menu accordingly.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 638         if (mDrawerList.getCheckedItemPosition() == TRASH_SELECTED_ID) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 639             mEmptyTrashMenuItem = menu.findItem(R.id.menu_empty_trash);</span>
 640 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 641             menu.findItem(R.id.menu_markdown_preview).setVisible(false);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 642             menu.findItem(R.id.menu_markdown_enable).setVisible(false);</span>
 643 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 644             trashItem.setVisible(false);
 645             menu.findItem(R.id.menu_empty_trash).setVisible(false);
 646         }
 647 
 648         // Are we looking at the trash? Adjust menu accordingly.
 649         if (mDrawerList.getCheckedItemPosition() == TRASH_SELECTED_ID) {
 650             mEmptyTrashMenuItem = menu.findItem(R.id.menu_empty_trash);
 651             mEmptyTrashMenuItem.setVisible(true);
 652 
 653             updateTrashMenuItem();
 654 
 655             menu.findItem(R.id.menu_search).setVisible(false);
 656             menu.findItem(R.id.menu_share).setVisible(false);
 657             menu.findItem(R.id.menu_history).setVisible(false);
 658         }
 659 
 660         DrawableUtils.tintMenuWithAttribute(this, menu, R.attr.actionBarTextColor);
 661 
 662         return true;
 663     }
 664 
 665     @Override
 666     public boolean onOptionsItemSelected(MenuItem item) {
 667         if (mDrawerToggle.onOptionsItemSelected(item)) {
 668             return true;
 669         }
 670         switch (item.getItemId()) {
 671 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
 672 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 673             case R.id.menu_share:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 674                 if (mCurrentNote != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 675                     Intent shareIntent = new Intent(android.content.Intent.ACTION_SEND);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 676                     shareIntent.setType(&quot;text/plain&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 677                     shareIntent.putExtra(android.content.Intent.EXTRA_TEXT, mCurrentNote.getContent());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 678                     startActivity(Intent.createChooser(shareIntent, getResources().getString(R.string.share_note)));"> 678                     startActivity(Intent.createChooser(shareIntent, getResources().getString(R.string.shaðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 679                     AnalyticsTracker.track(</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 680                             AnalyticsTracker.Stat.EDITOR_NOTE_CONTENT_SHARED,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 681                             AnalyticsTracker.CATEGORY_NOTE,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 682                             &quot;action_bar_share_button&quot;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 683                     );</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 684                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 685                 return true;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 686             case R.id.menu_delete:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 687                 if (mNoteEditorFragment != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 688                     if (mCurrentNote != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 689                         mCurrentNote.setDeleted(!mCurrentNote.isDeleted());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 690                         mCurrentNote.setModificationDate(Calendar.getInstance());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 691                         mCurrentNote.save();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 692 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 693                         if (mCurrentNote.isDeleted()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 694                             List&lt;String&gt; deletedNoteIds = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 695                             deletedNoteIds.add(mCurrentNote.getSimperiumKey());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 696                             mUndoBarController.setDeletedNoteIds(deletedNoteIds);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 697                             mUndoBarController.showUndoBar(getUndoView(), getString(R.string.note_deleted), null);"> 697                             mUndoBarController.showUndoBar(getUndoView(), getString(R.string.note_deletedðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 698                             AnalyticsTracker.track(</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 699                                     AnalyticsTracker.Stat.LIST_NOTE_DELETED,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 700                                     AnalyticsTracker.CATEGORY_NOTE,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 701                                     &quot;overflow_menu&quot;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 702                             );</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 703                         } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 704                             AnalyticsTracker.track(</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 705                                     AnalyticsTracker.Stat.EDITOR_NOTE_RESTORED,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 706                                     AnalyticsTracker.CATEGORY_NOTE,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 707                                     &quot;overflow_menu&quot;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 708                             );</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 709                         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 710                         showDetailPlaceholder();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 711                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 712                     NoteListFragment fragment = getNoteListFragment();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 713                     if (fragment != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 714                         fragment.getPrefs();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 715                         fragment.refreshList();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 716                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 717                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 718                 return true;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 719             case R.id.menu_empty_trash:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 720                 AlertDialog.Builder alert = new AlertDialog.Builder(this);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 721 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 722                 alert.setTitle(R.string.empty_trash);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 723                 alert.setMessage(R.string.confirm_empty_trash);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 724                 alert.setPositiveButton(R.string.yes, new DialogInterface.OnClickListener() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 725                     public void onClick(DialogInterface dialog, int whichButton) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 726                         new emptyTrashTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR);</span>
 727 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 728             case R.id.menu_share:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 729                 if (mCurrentNote != null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 730                     Intent shareIntent = new Intent(android.content.Intent.ACTION_SEND);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 731                     shareIntent.setType(&quot;text/plain&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 732                     shareIntent.putExtra(android.content.Intent.EXTRA_TEXT, mCurrentNote.getContent());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 733                     startActivity(Intent.createChooser(shareIntent, getResources().getString(R.string.share_note)));"> 733                     startActivity(Intent.createChooser(shareIntent, getResources().getString(R.string.shaðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 734                     AnalyticsTracker.track(</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 735                             AnalyticsTracker.Stat.EDITOR_NOTE_CONTENT_SHARED,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 736                             AnalyticsTracker.CATEGORY_NOTE,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 737                             &quot;action_bar_share_button&quot;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 738                     );</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 739                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 740                 return true;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 741             case R.id.menu_markdown_preview:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 742                 if (mIsShowingMarkdown) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 743                     if (ThemeUtils.isLightTheme(NotesActivity.this)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 744                         item.setIcon(R.drawable.ic_markdown_grey_outline_24dp);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 745                     } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 746                         item.setIcon(R.drawable.ic_markdown_blue_outline_24dp);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 747                     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 748 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 749                     mNoteEditorFragment.hideMarkdown();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 750                     item.setTitle(getString(R.string.markdown_show));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 751                     mIsShowingMarkdown = false;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 752                 } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 753                     if (ThemeUtils.isLightTheme(NotesActivity.this)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 754                         item.setIcon(R.drawable.ic_markdown_grey_solid_24dp);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 755                     } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 756                         item.setIcon(R.drawable.ic_markdown_blue_solid_24dp);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 757                     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 758 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 759                     mNoteEditorFragment.showMarkdown();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 760                     item.setTitle(getString(R.string.markdown_hide));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 761                     mIsShowingMarkdown = true;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 762                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 763 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 764                 return true;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 765             case R.id.menu_markdown_enable:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 766                 if (mCurrentNote != null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 767                     if (mNoteEditorFragment != null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 768                         mNoteEditorFragment.setMarkdownEnabled(!mCurrentNote.isMarkdownEnabled());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 769                         mNoteEditorFragment.saveNote();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 770                     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 771 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 772                     item.setChecked(!mCurrentNote.isMarkdownEnabled());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 773                     invalidateOptionsMenu();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 774                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 775 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 776                 if (mNoteEditorFragment != null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 777                     mNoteEditorFragment.hideMarkdown();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 778                     mIsShowingMarkdown = false;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 779                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 780 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 781                 return true;</span>
 782 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 783             case R.id.menu_delete:
 784                 if (mNoteEditorFragment != null) {
 785                     if (mCurrentNote != null) {
 786                         mCurrentNote.setDeleted(!mCurrentNote.isDeleted());
 787                         mCurrentNote.setModificationDate(Calendar.getInstance());
 788                         mCurrentNote.save();
 789 
 790                         if (mCurrentNote.isDeleted()) {
 791                             List&lt;String&gt; deletedNoteIds = new ArrayList&lt;&gt;();
 792                             deletedNoteIds.add(mCurrentNote.getSimperiumKey());
 793                             mUndoBarController.setDeletedNoteIds(deletedNoteIds);
<abbr title=" 794                             mUndoBarController.showUndoBar(getUndoView(), getString(R.string.note_deleted), null);"> 794                             mUndoBarController.showUndoBar(getUndoView(), getString(R.string.note_deletedðŸ”µ</abbr>
 795                             AnalyticsTracker.track(
 796                                     AnalyticsTracker.Stat.LIST_NOTE_DELETED,
 797                                     AnalyticsTracker.CATEGORY_NOTE,
 798                                     &quot;overflow_menu&quot;
 799                             );
 800                         } else {
 801                             AnalyticsTracker.track(
 802                                     AnalyticsTracker.Stat.EDITOR_NOTE_RESTORED,
 803                                     AnalyticsTracker.CATEGORY_NOTE,
 804                                     &quot;overflow_menu&quot;
 805                             );
 806                         }
 807                         showDetailPlaceholder();
 808                     }
 809                     NoteListFragment fragment = getNoteListFragment();
 810                     if (fragment != null) {
 811                         fragment.getPrefs();
 812                         fragment.refreshList();
 813                     }
 814                 }
 815                 return true;
 816             case R.id.menu_empty_trash:
 817                 AlertDialog.Builder alert = new AlertDialog.Builder(this);
 818 
 819                 alert.setTitle(R.string.empty_trash);
 820                 alert.setMessage(R.string.confirm_empty_trash);
 821                 alert.setPositiveButton(R.string.yes, new DialogInterface.OnClickListener() {
 822                     public void onClick(DialogInterface dialog, int whichButton) {
 823                         new emptyTrashTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR);
 824                         AnalyticsTracker.track(
 825                                 AnalyticsTracker.Stat.LIST_TRASH_EMPTIED,
 826                                 AnalyticsTracker.CATEGORY_NOTE,
 827                                 &quot;overflow_menu&quot;
 828                         );
 829                     }
 830                 });
 831                 alert.setNegativeButton(R.string.no, new DialogInterface.OnClickListener() {
 832                     public void onClick(DialogInterface dialog, int whichButton) {
 833                         // Do nothing, just closing the dialog
 834                     }
 835                 });
 836                 alert.show();
 837                 return true;
 838             case android.R.id.home:
 839                 invalidateOptionsMenu();
 840                 return true;
 841             default:
 842                 return super.onOptionsItemSelected(item);
 843         }
 844     }
 845 
 846     /**
 847      * Callback method from {@link NoteListFragment.Callbacks} indicating that
 848      * the item with the given ID was selected. Used for tablets only.
 849      */
 850     @Override
<abbr title=" 851     public void onNoteSelected(String noteID, int position, boolean isNew, String matchOffsets, boolean isMarkdownEnabled) {"> 851     public void onNoteSelected(String noteID, int position, boolean isNew, String matchOffsets, boolean iðŸ”µ</abbr>
 852         if (!DisplayUtils.isLargeScreenLandscape(this)) {
 853             // Launch the editor activity
 854             Bundle arguments = new Bundle();
 855             arguments.putString(NoteEditorFragment.ARG_ITEM_ID, noteID);
 856             arguments.putBoolean(NoteEditorFragment.ARG_NEW_NOTE, isNew);
 857             arguments.putBoolean(NoteEditorFragment.ARG_MARKDOWN_ENABLED, isMarkdownEnabled);
 858 
 859             if (matchOffsets != null)
 860                 arguments.putString(NoteEditorFragment.ARG_MATCH_OFFSETS, matchOffsets);
 861 
 862             Intent editNoteIntent = new Intent(this, NoteEditorActivity.class);
 863             editNoteIntent.putExtras(arguments);
 864             startActivityForResult(editNoteIntent, Simplenote.INTENT_EDIT_NOTE);
 865         } else {
 866             mNoteEditorFragment.setIsNewNote(isNew);
 867             mNoteEditorFragment.setNote(noteID, matchOffsets);
 868             getNoteListFragment().setNoteSelected(noteID);
 869 
 870             if (mSearchView != null &amp;&amp; mSearchView.getQuery() != null) {
 871                 mTabletSearchQuery = mSearchView.getQuery().toString();
 872             }
 873 
 874             mNoteEditorFragment.clearMarkdown();
 875 
 876             if (!isMarkdownEnabled &amp;&amp; mIsShowingMarkdown) {
 877                 mNoteEditorFragment.hideMarkdown();
 878                 mIsShowingMarkdown = false;
 879             }
 880 
 881             invalidateOptionsMenu();
 882         }
 883 
 884         AnalyticsTracker.track(
 885                 AnalyticsTracker.Stat.LIST_NOTE_OPENED,
 886                 AnalyticsTracker.CATEGORY_NOTE,
 887                 &quot;note_list_row_tap&quot;
 888         );
 889     }
 890 
 891     @Override
 892     public boolean onPrepareOptionsMenu(Menu menu) {
 893         MenuItem markdownItem = menu.findItem(R.id.menu_markdown_preview);
 894 
 895         if (mIsShowingMarkdown) {
 896             if (ThemeUtils.isLightTheme(NotesActivity.this)) {
 897                 markdownItem.setIcon(R.drawable.ic_markdown_grey_solid_24dp);
 898             } else {
 899                 markdownItem.setIcon(R.drawable.ic_markdown_blue_solid_24dp);
 900             }
 901 
 902             markdownItem.setTitle(getString(R.string.markdown_hide));
 903         } else {
 904             if (ThemeUtils.isLightTheme(NotesActivity.this)) {
 905                 markdownItem.setIcon(R.drawable.ic_markdown_grey_outline_24dp);
 906             } else {
 907                 markdownItem.setIcon(R.drawable.ic_markdown_blue_outline_24dp);
 908             }
 909 
 910             markdownItem.setTitle(getString(R.string.markdown_show));
 911         }
 912 
 913         return super.onPrepareOptionsMenu(menu);
 914     }
 915 
 916     @Override
 917     public void onUserCreated(User user) {
 918         // New account created
 919         AnalyticsTracker.track(
 920                 AnalyticsTracker.Stat.USER_ACCOUNT_CREATED,
 921                 AnalyticsTracker.CATEGORY_USER,
 922                 &quot;account_created_from_login_activity&quot;
 923         );
 924     }
 925 
 926     public void onUserStatusChange(User.Status status) {
 927         switch (status) {
 928             // successfully used access token to connect to simperium bucket
 929             case AUTHORIZED:
 930                 runOnUiThread(new Runnable() {
 931                     @Override
 932                     public void run() {
 933                         if (!mNotesBucket.hasChangeVersion()) {
 934                             setToolbarProgressVisibility(true);
 935                         }
 936                     }
 937                 });
 938                 break;
 939 
 940             // NOT_AUTHORIZED means we attempted to connect but the token was not valid
 941             case NOT_AUTHORIZED:
 942                 runOnUiThread(new Runnable() {
 943                     @Override
 944                     public void run() {
 945                         startLoginActivity(true);
 946                     }
 947                 });
 948                 break;
 949 
<abbr title=" 950             // Default starting state of User, don&#x27;t do anything we allow use of app while not signed in so don&#x27;t do anything"> 950             // Default starting state of User, don&#x27;t do anything we allow use of app while not signed in ðŸ”µ</abbr>
 951             case UNKNOWN:
 952                 break;
 953         }
 954     }
 955 
 956     private void setToolbarProgressVisibility(boolean isVisible) {
 957         if (getSupportActionBar() != null) {
 958             getSupportActionBar().setDisplayShowCustomEnabled(isVisible);
 959         }
 960     }
 961 
 962     public void startLoginActivity(boolean signInFirst) {
 963         Intent loginIntent = new Intent(this, LoginActivity.class);
 964         if (signInFirst)
 965             loginIntent.putExtra(LoginActivity.EXTRA_SIGN_IN_FIRST, true);
 966         startActivityForResult(loginIntent, Simperium.SIGNUP_SIGNIN_REQUEST);
 967     }
 968 
 969     @Override
 970     public void recreate() {
 971         Handler handler = new Handler();
 972         handler.post(new Runnable()
 973         {
 974             @Override
 975             public void run()
 976             {
 977                 if (Build.VERSION.SDK_INT &lt; Build.VERSION_CODES.HONEYCOMB)
 978                 {
 979                     NotesActivity.this.finish();
 980                     NotesActivity.this.startActivity(NotesActivity.this.getIntent());
 981                 } else {
 982                     NotesActivity.super.recreate();
 983                 }
 984             }
 985         });
 986     }
 987 
 988     @Override
 989     protected void onActivityResult(int requestCode, int resultCode, Intent data) {
 990         super.onActivityResult(requestCode, resultCode, data);
 991         switch (requestCode) {
 992             case Simplenote.INTENT_PREFERENCES:
 993                 if (ThemeUtils.themeWasChanged(data)) {
 994                     // Restart this activity to apply the new theme
 995                     recreate();
 996                     break;
 997                 }
<abbr title=" 998                 // nbradbury - refresh note list when user returns from preferences (in case they changed anything)"> 998                 // nbradbury - refresh note list when user returns from preferences (in case they changedðŸ”µ</abbr>
 999                 invalidateOptionsMenu();
1000                 NoteListFragment fragment = getNoteListFragment();
1001                 if (fragment != null) {
1002                     fragment.getPrefs();
1003                     fragment.refreshList();
1004                 }
1005                 break;
1006             case Simplenote.INTENT_EDIT_NOTE:
<abbr title="1007                 if (resultCode == RESULT_OK &amp;&amp; data != null &amp;&amp; data.hasExtra(Simplenote.DELETED_NOTE_ID)) {">1007                 if (resultCode == RESULT_OK &amp;&amp; data != null &amp;&amp; data.hasExtra(Simplenote.DELETED_NOTE_ID))ðŸ”µ</abbr>
1008                     String noteId = data.getStringExtra(Simplenote.DELETED_NOTE_ID);
1009                     if (noteId != null) {
1010                         List&lt;String&gt; deletedNoteIds = new ArrayList&lt;&gt;();
1011                         deletedNoteIds.add(noteId);
1012                         mUndoBarController.setDeletedNoteIds(deletedNoteIds);
<abbr title="1013                         mUndoBarController.showUndoBar(getUndoView(), getString(R.string.note_deleted), null);">1013                         mUndoBarController.showUndoBar(getUndoView(), getString(R.string.note_deleted), nðŸ”µ</abbr>
1014                     }
1015                 }
1016                 break;
1017             case Simperium.SIGNUP_SIGNIN_REQUEST:
1018                 invalidateOptionsMenu();
1019 
1020                 Simplenote app = (Simplenote)getApplication();
1021                 AnalyticsTracker.refreshMetadata(app.getSimperium().getUser().getEmail());
1022 
1023                 AnalyticsTracker.track(
1024                         AnalyticsTracker.Stat.USER_SIGNED_IN,
1025                         AnalyticsTracker.CATEGORY_USER,
1026                         &quot;signed_in_from_login_activity&quot;
1027                 );
1028 
1029                 if (resultCode == Activity.RESULT_CANCELED &amp;&amp; userAuthenticationIsInvalid()) {
1030                     finish();
1031                 }
1032 
1033                 break;
1034         }
1035     }
1036 
1037     @Override
1038     public void onUndo() {
1039         if (mUndoBarController == null) return;
1040 
1041         List&lt;String&gt; deletedNoteIds = mUndoBarController.getDeletedNoteIds();
1042         if (deletedNoteIds != null) {
1043             for (int i = 0; i &lt; deletedNoteIds.size(); i++) {
1044                 Note deletedNote;
1045                 try {
1046                     deletedNote = mNotesBucket.get(deletedNoteIds.get(i));
1047                 } catch (BucketObjectMissingException e) {
1048                     return;
1049                 }
1050                 if (deletedNote != null) {
1051                     deletedNote.setDeleted(false);
1052                     deletedNote.setModificationDate(Calendar.getInstance());
1053                     deletedNote.save();
1054                     NoteListFragment fragment = getNoteListFragment();
1055                     if (fragment != null) {
1056                         fragment.getPrefs();
1057                         fragment.refreshList();
1058                     }
1059                 }
1060             }
1061         }
1062     }
1063 
1064     @Override
1065     protected void onPostCreate(Bundle savedInstanceState) {
1066         super.onPostCreate(savedInstanceState);
1067         // Sync the toggle state after onRestoreInstanceState has occurred.
1068         mDrawerToggle.syncState();
1069     }
1070 
1071     @Override
1072     public void onConfigurationChanged(Configuration newConfig) {
1073         super.onConfigurationChanged(newConfig);
1074 
1075         mDrawerToggle.onConfigurationChanged(newConfig);
1076 
1077         if (DisplayUtils.isLargeScreen(this)) {
1078             mIsShowingMarkdown = false;
1079 
1080             if (newConfig.orientation == Configuration.ORIENTATION_LANDSCAPE) {
1081                 // Add the editor fragment
1082                 addEditorFragment();
1083                 if (mNoteListFragment != null) {
1084                     mNoteListFragment.setActivateOnItemClick(true);
1085                     mNoteListFragment.setDividerVisible(true);
1086                 }
1087                 // Select the current note on a tablet
1088                 if (mCurrentNote != null)
<abbr title="1089                     onNoteSelected(mCurrentNote.getSimperiumKey(), 0, false, null, mCurrentNote.isMarkdownEnabled());">1089                     onNoteSelected(mCurrentNote.getSimperiumKey(), 0, false, null, mCurrentNote.isMarkdowðŸ”µ</abbr>
1090                 else {
1091                     mNoteEditorFragment.setPlaceholderVisible(true);
1092                     mNoteListFragment.getListView().clearChoices();
1093                 }
1094                 invalidateOptionsMenu();
<abbr title="1095             } else if (newConfig.orientation == Configuration.ORIENTATION_PORTRAIT &amp;&amp; mNoteEditorFragment != null) {">1095             } else if (newConfig.orientation == Configuration.ORIENTATION_PORTRAIT &amp;&amp; mNoteEditorFragmentðŸ”µ</abbr>
1096                 // Remove the editor fragment when rotating back to portrait
1097                 mCurrentNote = null;
1098                 if (mNoteListFragment != null) {
1099                     mNoteListFragment.setActivateOnItemClick(false);
1100                     mNoteListFragment.setDividerVisible(false);
1101                     mNoteListFragment.setActivatedPosition(ListView.INVALID_POSITION);
1102                     mNoteListFragment.refreshList();
1103                 }
1104                 FragmentManager fm = getSupportFragmentManager();
1105                 FragmentTransaction ft = fm.beginTransaction();
1106                 ft.remove(mNoteEditorFragment);
1107                 mNoteEditorFragment = null;
1108                 ft.commitAllowingStateLoss();
1109                 fm.executePendingTransactions();
1110                 invalidateOptionsMenu();
1111             }
1112         }
1113     }
1114 
1115     public void checkEmptyListText(boolean isSearch) {
1116         if (isSearch) {
<abbr title="1117             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_found) + &quot;&lt;/strong&gt;&quot;);">1117             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_found) + &quot;ðŸ”µ</abbr>
1118             getNoteListFragment().setEmptyListViewClickable(false);
1119         } else if (mDrawerList.getCheckedItemPosition() == TRASH_SELECTED_ID) {
<abbr title="1120             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.trash_is_empty) + &quot;&lt;/strong&gt;&quot;);">1120             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.trash_is_empty) + &quot;ðŸ”µ</abbr>
1121             AnalyticsTracker.track(
1122                     AnalyticsTracker.Stat.LIST_TRASH_VIEWED,
1123                     AnalyticsTracker.CATEGORY_NOTE,
1124                     &quot;trash_filter_selected&quot;
1125             );
1126             getNoteListFragment().setEmptyListViewClickable(false);
1127         } else {
<abbr title="1128             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here) + &quot;&lt;/strong&gt;&lt;br /&gt;&quot; + String.format(getString(R.string.why_not_create_one), &quot;&lt;u&gt;&quot;, &quot;&lt;/u&gt;&quot;));">1128             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here) + &quot;&lt;ðŸ”µ</abbr>
1129             getNoteListFragment().setEmptyListViewClickable(true);
1130         }
1131     }
1132 
1133     public void showDetailPlaceholder() {
1134         if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; mNoteEditorFragment != null) {
1135             mCurrentNote = null;
1136             mNoteEditorFragment.setPlaceholderVisible(true);
1137             mNoteEditorFragment.clearMarkdown();
1138             mNoteEditorFragment.hideMarkdown();
1139             mIsShowingMarkdown = false;
1140         }
1141     }
1142 
1143     public void stopListeningToNotesBucket() {
1144         mNotesBucket.removeOnNetworkChangeListener(this);
1145         mNotesBucket.removeOnSaveObjectListener(this);
1146         mNotesBucket.removeOnDeleteObjectListener(this);
1147     }
1148 
1149     // Returns the appropriate view to show the undo bar within
1150     private View getUndoView() {
1151         View undoView = mFragmentsContainer;
1152         if (!DisplayUtils.isLargeScreenLandscape(this) &amp;&amp;
1153                 getNoteListFragment() != null &amp;&amp;
1154                 getNoteListFragment().getRootView() != null) {
1155             undoView = getNoteListFragment().getRootView();
1156         }
1157 
1158         return undoView;
1159     }
1160 
1161     public void showUndoBarWithNoteIds(List&lt;String&gt; noteIds) {
1162         if (mUndoBarController != null) {
1163             mUndoBarController.setDeletedNoteIds(noteIds);
1164             mUndoBarController.showUndoBar(
1165                     getUndoView(),
<abbr title="1166                     getResources().getQuantityString(R.plurals.trashed_notes, noteIds.size(), noteIds.size()),">1166                     getResources().getQuantityString(R.plurals.trashed_notes, noteIds.size(), noteIds.sizðŸ”µ</abbr>
1167                     null
1168             );
1169         }
1170     }
1171 
1172     private class emptyTrashTask extends AsyncTask&lt;Void, Void, Void&gt; {
1173 
1174         @Override
1175         protected Void doInBackground(Void... voids) {
1176             if (mNotesBucket == null) return null;
1177 
1178             Query&lt;Note&gt; query = Note.allDeleted(mNotesBucket);
1179             Bucket.ObjectCursor c = query.execute();
1180             while (c.moveToNext()) {
1181                 c.getObject().delete();
1182             }
1183 
1184             return null;
1185         }
1186 
1187         @Override
1188         protected void onPostExecute(Void nada) {
1189             showDetailPlaceholder();
1190         }
1191     }
1192 
1193 
1194     /* Simperium Bucket Listeners */
1195     // received a change from the network, refresh the list
1196     @Override
1197     public void onNetworkChange(Bucket&lt;Note&gt; bucket, final Bucket.ChangeType type, String key) {
1198         runOnUiThread(new Runnable() {
1199             @Override
1200             public void run() {
1201                 if (type == Bucket.ChangeType.INDEX) {
1202                     setToolbarProgressVisibility(false);
1203                 }
1204                 mNoteListFragment.refreshList();
1205             }
1206         });
1207     }
1208 
1209     @Override
1210     public void onSaveObject(Bucket&lt;Note&gt; bucket, Note object) {
1211         runOnUiThread(new Runnable() {
1212             @Override
1213             public void run() {
1214                 mNoteListFragment.refreshList();
1215             }
1216         });
1217     }
1218 
1219     @Override
1220     public void onDeleteObject(Bucket&lt;Note&gt; bucket, Note object) {
1221         runOnUiThread(new Runnable() {
1222             @Override
1223             public void run() {
1224                 mNoteListFragment.refreshList();
1225             }
1226         });
1227     }
1228 
1229     @Override
1230     public void onBeforeUpdateObject(Bucket&lt;Note&gt; bucket, Note note) {
1231         // noop, NoteEditorFragment will handle this
1232     }
1233 
1234     // Tags bucket listener
1235     private Bucket.Listener&lt;Tag&gt; mTagsMenuUpdater = new Bucket.Listener&lt;Tag&gt;() {
1236         void updateNavigationDrawer() {
1237             runOnUiThread(new Runnable() {
1238                 public void run() {
1239                     updateNavigationDrawerItems();
1240                 }
1241             });
1242         }
1243 
1244         @Override
1245         public void onSaveObject(Bucket&lt;Tag&gt; bucket, Tag tag) {
1246             updateNavigationDrawer();
1247         }
1248 
1249         @Override
1250         public void onDeleteObject(Bucket&lt;Tag&gt; bucket, Tag tag) {
1251             updateNavigationDrawer();
1252         }
1253 
1254         @Override
1255         public void onNetworkChange(Bucket&lt;Tag&gt; bucket, Bucket.ChangeType type, String key) {
1256             updateNavigationDrawer();
1257         }
1258 
1259         @Override
1260         public void onBeforeUpdateObject(Bucket&lt;Tag&gt; bucket, Tag object) {
1261             // noop
1262         }
1263     };
1264 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                            <td><pre>   1 package com.automattic.simplenote;
   2 
   3 import android.app.Activity;
   4 import android.app.AlertDialog;
   5 import android.content.DialogInterface;
   6 import android.content.Intent;
   7 import android.content.SharedPreferences;
   8 import android.content.res.Configuration;
   9 import android.os.AsyncTask;
  10 import android.os.Build;
  11 import android.os.Bundle;
  12 import android.os.Handler;
  13 import android.preference.PreferenceManager;
  14 import android.support.design.widget.NavigationView;
  15 import android.support.v4.app.FragmentManager;
  16 import android.support.v4.app.FragmentTransaction;
  17 import android.support.v4.content.ContextCompat;
  18 import android.support.v4.view.GravityCompat;
  19 import android.support.v4.view.MenuItemCompat;
  20 import android.support.v4.widget.DrawerLayout;
  21 import android.support.v7.app.ActionBar;
  22 import android.support.v7.app.ActionBarDrawerToggle;
  23 import android.support.v7.app.AppCompatActivity;
  24 import android.support.v7.widget.SearchView;
  25 import android.support.v7.widget.Toolbar;
  26 import android.text.Html;
  27 import android.text.Spannable;
  28 import android.text.SpannableString;
  29 import android.text.TextUtils;
  30 import android.view.Menu;
  31 import android.view.MenuInflater;
  32 import android.view.MenuItem;
  33 import android.view.View;
  34 import android.view.WindowManager;
  35 import android.widget.AdapterView;
  36 import android.widget.ListView;
  37 import android.widget.ProgressBar;
  38 import android.widget.TextView;
  39 import com.automattic.simplenote.analytics.AnalyticsTracker;
  40 import com.automattic.simplenote.models.Note;
  41 import com.automattic.simplenote.models.Tag;
  42 import com.automattic.simplenote.utils.AniUtils;
  43 import com.automattic.simplenote.utils.DisplayUtils;
  44 import com.automattic.simplenote.utils.DrawableUtils;
  45 import com.automattic.simplenote.utils.PrefUtils;
  46 import com.automattic.simplenote.utils.StrUtils;
  47 import com.automattic.simplenote.utils.TagsAdapter;
  48 import com.automattic.simplenote.utils.ThemeUtils;
  49 import com.automattic.simplenote.utils.UndoBarController;
  50 import com.automattic.simplenote.widgets.TypefaceSpan;
  51 import com.simperium.Simperium;
  52 import com.simperium.android.LoginActivity;
  53 import com.simperium.client.Bucket;
  54 import com.simperium.client.BucketObjectMissingException;
  55 import com.simperium.client.BucketObjectNameInvalid;
  56 import com.simperium.client.Query;
  57 import com.simperium.client.User;
  58 import java.util.ArrayList;
  59 import java.util.Calendar;
  60 import java.util.List;
  61 import org.wordpress.passcodelock.AppLockManager;
  62 
  63 
<abbr title="  64 public class NotesActivity extends AppCompatActivity implements NoteListFragment.Callbacks , User.StatusChangeListener , Simperium.OnUserCreatedListener , UndoBarController.UndoListener , Bucket.Listener&lt;Note&gt; {">  64 public class NotesActivity extends AppCompatActivity implements NoteListFragment.Callbacks , User.StatusCðŸ”µ</abbr>
  65     public static String TAG_NOTE_LIST = &quot;noteList&quot;;
  66 
  67     public static String TAG_NOTE_EDITOR = &quot;noteEditor&quot;;
  68 
  69     private int TRASH_SELECTED_ID = 2;
  70 
  71     private boolean mIsMarkdownEnabledGlobal;
  72 
  73     private boolean mIsShowingMarkdown;
  74 
  75     private boolean mShouldSelectNewNote;
  76 
  77     private String mTabletSearchQuery;
  78 
  79     private UndoBarController mUndoBarController;
  80 
  81     private View mFragmentsContainer;
  82 
  83     private View mWelcomeView;
  84 
  85     private SearchView mSearchView;
  86 
  87     private MenuItem mSearchMenuItem;
  88 
  89     private NoteListFragment mNoteListFragment;
  90 
  91     private NoteEditorFragment mNoteEditorFragment;
  92 
  93     private Note mCurrentNote;
  94 
  95     protected Bucket&lt;Note&gt; mNotesBucket;
  96 
  97     protected Bucket&lt;Tag&gt; mTagsBucket;
  98 
  99     private MenuItem mEmptyTrashMenuItem;
 100 
 101     // Menu drawer
 102     // Menu drawer
 103     private DrawerLayout mDrawerLayout;
 104 
 105     private ListView mDrawerList;
 106 
 107     private NavigationView mNavigationView;
 108 
 109     private ActionBarDrawerToggle mDrawerToggle;
 110 
 111     private TagsAdapter mTagsAdapter;
 112 
 113     private TagsAdapter.TagMenuItem mSelectedTag;
 114 
 115     @Override
 116     protected void onCreate(Bundle savedInstanceState) {
 117         // On lollipop, configure the translucent status bar
 118         if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.LOLLIPOP) {
 119             getWindow().addFlags(WindowManager.LayoutParams.FLAG_DRAWS_SYSTEM_BAR_BACKGROUNDS);
 120             getWindow().setStatusBarColor(ContextCompat.getColor(this, R.color.transparent));
 121         }
 122         ThemeUtils.setTheme(this);
 123         super.onCreate(savedInstanceState);
 124         setContentView(R.layout.activity_notes);
 125         mFragmentsContainer = findViewById(R.id.note_fragment_container);
 126         Simplenote currentApp = ((Simplenote) (getApplication()));
 127         if (mNotesBucket == null) {
 128             mNotesBucket = currentApp.getNotesBucket();
 129         }
 130         if (mTagsBucket == null) {
 131             mTagsBucket = currentApp.getTagsBucket();
 132         }
 133         Toolbar toolbar = ((Toolbar) (findViewById(R.id.toolbar)));
 134         setSupportActionBar(toolbar);
 135         configureNavigationDrawer(toolbar);
 136         if (savedInstanceState == null) {
 137             mNoteListFragment = new NoteListFragment();
 138             FragmentTransaction fragmentTransaction = getSupportFragmentManager().beginTransaction();
 139             fragmentTransaction.add(R.id.note_fragment_container, mNoteListFragment, TAG_NOTE_LIST);
 140             fragmentTransaction.commit();
 141         } else {
<abbr title=" 142             mNoteListFragment = ((NoteListFragment) (getSupportFragmentManager().findFragmentByTag(TAG_NOTE_LIST)));"> 142             mNoteListFragment = ((NoteListFragment) (getSupportFragmentManager().findFragmentByTag(TAG_NOðŸ”µ</abbr>
 143         }
 144         if (DisplayUtils.isLargeScreen(this)) {
 145             if (getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR) != null) {
<abbr title=" 146                 mNoteEditorFragment = ((NoteEditorFragment) (getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR)));"> 146                 mNoteEditorFragment = ((NoteEditorFragment) (getSupportFragmentManager().findFragmentByTaðŸ”µ</abbr>
 147             } else if (DisplayUtils.isLandscape(this)) {
 148                 addEditorFragment();
 149             }
 150         }
 151         // enable ActionBar app icon to behave as action to toggle nav drawer
 152         ActionBar actionBar = getSupportActionBar();
 153         if (actionBar != null) {
 154             actionBar.setDisplayHomeAsUpEnabled(true);
 155             actionBar.setHomeButtonEnabled(true);
 156             // Add loading indicator to show when indexing
<abbr title=" 157             ProgressBar progressBar = ((ProgressBar) (getLayoutInflater().inflate(R.layout.progressbar_toolbar, null)));"> 157             ProgressBar progressBar = ((ProgressBar) (getLayoutInflater().inflate(R.layout.progressbar_toðŸ”µ</abbr>
 158             actionBar.setDisplayShowCustomEnabled(true);
 159             actionBar.setCustomView(progressBar);
 160             setToolbarProgressVisibility(false);
 161         }
 162         mUndoBarController = new UndoBarController(this);
 163         // Creates &#x27;Welcome&#x27; note
 164         checkForFirstLaunch();
 165         checkForSharedContent();
 166         currentApp.getSimperium().setOnUserCreatedListener(this);
 167         currentApp.getSimperium().setUserStatusChangeListener(this);
 168     }
 169 
 170     @Override
 171     protected void onResume() {
 172         super.onResume();
 173         // Ensure user has valid authorization
 174         if (userAuthenticationIsInvalid()) {
 175             startLoginActivity(true);
 176         }
 177         mNotesBucket.start();
 178         mTagsBucket.start();
 179         mNotesBucket.addOnNetworkChangeListener(this);
 180         mNotesBucket.addOnSaveObjectListener(this);
 181         mNotesBucket.addOnDeleteObjectListener(this);
 182         mTagsBucket.addListener(mTagsMenuUpdater);
 183         setWelcomeViewVisibility();
 184         updateNavigationDrawerItems();
 185         // if the user is not authenticated and the tag doesn&#x27;t exist revert to default drawer selection
 186         if (userIsUnauthorized()) {
 187             if ((-1) == mTagsAdapter.getPosition(mSelectedTag)) {
 188                 mSelectedTag = null;
 189                 mDrawerList.setSelection(TagsAdapter.DEFAULT_ITEM_POSITION);
 190             }
 191         }
 192         setSelectedTagActive();
 193         if ((mCurrentNote != null) &amp;&amp; mShouldSelectNewNote) {
<abbr title=" 194             onNoteSelected(mCurrentNote.getSimperiumKey(), 0, true, null, mCurrentNote.isMarkdownEnabled());"> 194             onNoteSelected(mCurrentNote.getSimperiumKey(), 0, true, null, mCurrentNote.isMarkdownEnabled(ðŸ”µ</abbr>
 195             mShouldSelectNewNote = false;
 196         }
 197         mIsMarkdownEnabledGlobal = PrefUtils.getBoolPref(this, PrefUtils.PREF_MARKDOWN_ENABLED, false);
 198     }
 199 
 200     @Override
 201     protected void onPause() {
 202         super.onPause();
 203 
 204         mTagsBucket.removeListener(mTagsMenuUpdater);
 205 
 206         mNotesBucket.removeOnNetworkChangeListener(this);
 207         mNotesBucket.removeOnSaveObjectListener(this);
 208         mNotesBucket.removeOnDeleteObjectListener(this);
 209     }
 210 
 211     @Override
 212     public void setTitle(CharSequence title) {
 213         if (title == null) {
 214             title = &quot;&quot;;
 215         }
 216 
 217         setTitleWithCustomFont(title);
 218     }
 219 
 220     @Override
 221     public void onBackPressed() {
 222         if (mDrawerLayout != null &amp;&amp; mDrawerLayout.isDrawerOpen(GravityCompat.START)) {
 223             mDrawerLayout.closeDrawer(GravityCompat.START);
 224         } else {
 225             super.onBackPressed();
 226         }
 227     }
 228 
 229     private void setTitleWithCustomFont(CharSequence title) {
 230         if (getSupportActionBar() == null) return;
 231 
 232         // LG devices running 4.1 can&#x27;t handle a custom font in the action bar title
 233         if ((!TextUtils.isEmpty(Build.BRAND) &amp;&amp; Build.BRAND.toLowerCase().contains(&quot;lge&quot;))
 234                 &amp;&amp; Build.VERSION.SDK_INT &lt;= Build.VERSION_CODES.JELLY_BEAN) {
 235             getSupportActionBar().setTitle(title);
 236             return;
 237         }
 238 
 239         SpannableString s = new SpannableString(title);
 240         s.setSpan(new TypefaceSpan(this), 0, s.length(), Spannable.SPAN_EXCLUSIVE_EXCLUSIVE);
 241         getSupportActionBar().setTitle(s);
 242     }
 243 
 244     private void configureNavigationDrawer(Toolbar toolbar) {
 245         mDrawerLayout = ((DrawerLayout) (findViewById(R.id.drawer_layout)));
 246         mDrawerLayout.setDrawerShadow(R.drawable.drawer_shadow, GravityCompat.START);
 247         mNavigationView = ((NavigationView) (findViewById(R.id.navigation_view)));
 248         mDrawerList = ((ListView) (findViewById(R.id.drawer_list)));
 249         // Configure welcome view in the nav drawer
 250         mWelcomeView = mDrawerLayout.findViewById(R.id.welcome_view);
<abbr title=" 251         TextView welcomeSignInButton = ((TextView) (mDrawerLayout.findViewById(R.id.welcome_sign_in_button)));"> 251         TextView welcomeSignInButton = ((TextView) (mDrawerLayout.findViewById(R.id.welcome_sign_in_buttoðŸ”µ</abbr>
 252         welcomeSignInButton.setOnClickListener(new View.OnClickListener() {
 253             @Override
 254             public void onClick(View v) {
 255                 startLoginActivity(true);
 256             }
 257         });
 258         TextView welcomeCloseButton = ((TextView) (mDrawerLayout.findViewById(R.id.welcome_close)));
 259         welcomeCloseButton.setOnClickListener(new View.OnClickListener() {
 260             @Override
 261             public void onClick(View v) {
 262                 removeWelcomeView();
 263             }
 264         });
 265         View settingsButton = findViewById(R.id.nav_settings);
 266         settingsButton.setOnClickListener(new View.OnClickListener() {
 267             @Override
 268             public void onClick(View v) {
 269                 Intent i = new Intent(NotesActivity.this, PreferencesActivity.class);
 270                 startActivityForResult(i, Simplenote.INTENT_PREFERENCES);
 271             }
 272         });
 273         mNavigationView.getLayoutParams().width = ThemeUtils.getOptimalDrawerWidth(this);
 274         mTagsAdapter = new TagsAdapter(this, mNotesBucket, mDrawerList.getHeaderViewsCount());
 275         mDrawerList.setAdapter(mTagsAdapter);
 276         // Set the list&#x27;s click listener
 277         mDrawerList.setOnItemClickListener(new DrawerItemClickListener());
 278         if (mSelectedTag == null) {
 279             mSelectedTag = mTagsAdapter.getDefaultItem();
 280         }
<abbr title=" 281         mDrawerToggle = new ActionBarDrawerToggle(this, mDrawerLayout, toolbar, R.string.open_drawer, R.string.close_drawer) {"> 281         mDrawerToggle = new ActionBarDrawerToggle(this, mDrawerLayout, toolbar, R.string.open_drawer, R.sðŸ”µ</abbr>
 282             public void onDrawerClosed(View view) {
 283                 supportInvalidateOptionsMenu();
 284             }
 285 
 286             public void onDrawerOpened(View drawerView) {
 287                 // noop
 288             }
 289         };
 290         mDrawerLayout.addDrawerListener(mDrawerToggle);
 291     }
 292 
 293     private void setWelcomeViewVisibility() {
 294         if (mWelcomeView == null) return;
 295         // Hide welcome view if user is signed in or closed the welcome view
 296         if (userIsAuthorized() || PrefUtils.getBoolPref(this, PrefUtils.PREF_APP_TRIAL)) {
 297             mWelcomeView.setVisibility(View.GONE);
 298         } else {
 299             mWelcomeView.setVisibility(View.VISIBLE);
 300             mWelcomeView.setAlpha(1.0f);
 301         }
 302     }
 303 
 304     private void removeWelcomeView() {
 305         if (mWelcomeView == null) return;
 306 
 307         AniUtils.swipeOutToLeft(mWelcomeView);
 308 
 309         // Set preference so the welcome view never shows again
 310         SharedPreferences preferences = PreferenceManager.getDefaultSharedPreferences(this);
 311         SharedPreferences.Editor editor = preferences.edit();
 312         editor.putBoolean(PrefUtils.PREF_APP_TRIAL, true);
 313         editor.apply();
 314     }
 315 
 316     private void checkForFirstLaunch() {
 317         if (PrefUtils.getBoolPref(this, PrefUtils.PREF_FIRST_LAUNCH, true)) {
 318             // Create the welcome note
 319             try {
 320                 Note welcomeNote = mNotesBucket.newObject(&quot;welcome-android&quot;);
 321                 welcomeNote.setCreationDate(Calendar.getInstance());
 322                 welcomeNote.setModificationDate(welcomeNote.getCreationDate());
 323                 welcomeNote.setContent(getString(R.string.welcome_note));
 324                 welcomeNote.getTitle();
 325                 welcomeNote.save();
 326             } catch (BucketObjectNameInvalid e) {
 327                 // this won&#x27;t happen because welcome-android is a valid name
 328             }
 329 
 330             SharedPreferences preferences = PreferenceManager.getDefaultSharedPreferences(this);
 331             SharedPreferences.Editor editor = preferences.edit();
 332             editor.putBoolean(PrefUtils.PREF_FIRST_LAUNCH, false);
 333             editor.apply();
 334         }
 335     }
 336 
 337     private void checkForSharedContent() {
 338         if (getIntent().hasExtra(Intent.EXTRA_TEXT)) {
 339             // Check share action
 340             Intent intent = getIntent();
 341             String subject = intent.getStringExtra(Intent.EXTRA_SUBJECT);
 342             String text = intent.getStringExtra(Intent.EXTRA_TEXT);
 343 
<abbr title=" 344             // Don&#x27;t add the &#x27;Note to self&#x27; subject or open the note if this was shared from a voice search"> 344             // Don&#x27;t add the &#x27;Note to self&#x27; subject or open the note if this was shared from a voice searðŸ”µ</abbr>
 345             String intentAction = StrUtils.notNullStr(intent.getAction());
 346             boolean isVoiceShare = intentAction.equals(&quot;com.google.android.gm.action.AUTO_SEND&quot;);
 347             if (!TextUtils.isEmpty(text)) {
 348                 if (!TextUtils.isEmpty(subject) &amp;&amp; !isVoiceShare) {
 349                     text = subject + &quot;\n\n&quot; + text;
 350                 }
 351                 Note note = mNotesBucket.newObject();
 352                 note.setCreationDate(Calendar.getInstance());
 353                 note.setModificationDate(note.getCreationDate());
 354                 note.setContent(text);
 355                 note.save();
 356                 setCurrentNote(note);
 357 
 358                 if (!isVoiceShare) {
 359                     mShouldSelectNewNote = true;
 360                 }
 361                 AnalyticsTracker.track(
 362                         AnalyticsTracker.Stat.LIST_NOTE_CREATED,
 363                         AnalyticsTracker.CATEGORY_NOTE,
 364                         &quot;external_share&quot;
 365                 );
 366 
 367                 if (!DisplayUtils.isLargeScreenLandscape(this)) {
 368                     // Disable the lock screen when sharing content and opening NoteEditorActivity
 369                     // Lock screen activities are enabled again in NoteEditorActivity.onPause()
 370                     if (AppLockManager.getInstance().isAppLockFeatureEnabled()) {
 371                         AppLockManager.getInstance().getCurrentAppLock().setDisabledActivities(
 372                                 new String[]{&quot;com.automattic.simplenote.NotesActivity&quot;,
 373                                 &quot;com.automattic.simplenote.NoteEditorActivity&quot;});
 374                         AppLockManager.getInstance().getCurrentAppLock().setOneTimeTimeout(0);
 375                     }
 376                 }
 377             }
 378         }
 379     }
 380 
 381     private void updateNavigationDrawerItems() {
 382         Bucket.ObjectCursor&lt;Tag&gt; tagCursor = Tag.allWithCount(mTagsBucket).execute();
 383         mTagsAdapter.changeCursor(tagCursor);
 384     }
 385 
 386     private void setSelectedTagActive() {
 387         if (mSelectedTag == null)
 388             mSelectedTag = mTagsAdapter.getDefaultItem();
 389 
 390         setTitle(mSelectedTag.name);
<abbr title=" 391         mDrawerList.setItemChecked(mTagsAdapter.getPosition(mSelectedTag) + mDrawerList.getHeaderViewsCount(), true);"> 391         mDrawerList.setItemChecked(mTagsAdapter.getPosition(mSelectedTag) + mDrawerList.getHeaderViewsCouðŸ”µ</abbr>
 392     }
 393 
 394     /* The click listener for ListView in the navigation drawer */
 395     private class DrawerItemClickListener implements ListView.OnItemClickListener {
 396         @Override
 397         public void onItemClick(AdapterView&lt;?&gt; parent, View view, int position, long id) {
 398             // Adjust for header view
 399             position -= mDrawerList.getHeaderViewsCount();
 400             mSelectedTag = mTagsAdapter.getItem(position);
 401             checkEmptyListText(false);
 402             // Update checked item in navigation drawer and close it
 403             setSelectedTagActive();
 404             mDrawerLayout.closeDrawer(mNavigationView);
 405             // Disable long press on notes if we&#x27;re viewing the trash
 406             if (mDrawerList.getCheckedItemPosition() == TRASH_SELECTED_ID) {
 407                 getNoteListFragment().getListView().setLongClickable(false);
 408             } else {
 409                 getNoteListFragment().getListView().setLongClickable(true);
 410             }
 411             getNoteListFragment().refreshListFromNavSelect();
 412             if (position &gt; 1) {
<abbr title=" 413                 AnalyticsTracker.track(AnalyticsTracker.Stat.LIST_TAG_VIEWED, AnalyticsTracker.CATEGORY_TAG, &quot;selected_tag_in_navigation_drawer&quot;);"> 413                 AnalyticsTracker.track(AnalyticsTracker.Stat.LIST_TAG_VIEWED, AnalyticsTracker.CATEGORY_TðŸ”µ</abbr>
 414             }
 415         }
 416     }
 417 
 418     public TagsAdapter.TagMenuItem getSelectedTag() {
 419         if (mSelectedTag == null) {
 420             mSelectedTag = mTagsAdapter.getDefaultItem();
 421         }
 422 
 423         return mSelectedTag;
 424     }
 425 
 426     // Enable or disable the trash action bar button depending on if there are deleted notes or not
 427     public void updateTrashMenuItem() {
 428         if (mEmptyTrashMenuItem == null || mNotesBucket == null)
 429             return;
 430 
 431         // Disable the trash icon if there are no notes trashed.
 432         Query&lt;Note&gt; query = Note.allDeleted(mNotesBucket);
 433         if (query.count() == 0) {
 434             mEmptyTrashMenuItem.getIcon().setAlpha(127);
 435             mEmptyTrashMenuItem.setEnabled(false);
 436         } else {
 437             mEmptyTrashMenuItem.getIcon().setAlpha(255);
 438             mEmptyTrashMenuItem.setEnabled(true);
 439         }
 440     }
 441 
 442     private void addEditorFragment() {
 443         FragmentManager fm = getSupportFragmentManager();
 444         FragmentTransaction ft = fm.beginTransaction();
 445         mNoteEditorFragment = new NoteEditorFragment();
 446         ft.add(R.id.note_fragment_container, mNoteEditorFragment, TAG_NOTE_EDITOR);
 447         ft.commitAllowingStateLoss();
 448         fm.executePendingTransactions();
 449     }
 450 
 451     /**
 452      * Checks for a previously valid user that is now not authenticated
 453      *
 454      * @return true if user has invalid authorization
 455      */
 456     private boolean userAuthenticationIsInvalid() {
 457         Simplenote currentApp = (Simplenote) getApplication();
 458         Simperium simperium = currentApp.getSimperium();
 459         User user = simperium.getUser();
 460         return user.hasAccessToken() &amp;&amp; user.getStatus().equals(User.Status.NOT_AUTHORIZED);
 461     }
 462 
 463     private boolean userIsUnauthorized() {
 464         Simplenote currentApp = (Simplenote) getApplication();
 465         return currentApp.getSimperium().getUser().getStatus() == User.Status.NOT_AUTHORIZED;
 466     }
 467 
 468     private boolean userIsAuthorized() {
 469         Simplenote app = (Simplenote) getApplication();
 470         return !app.getSimperium().needsAuthorization();
 471     }
 472 
 473     public void setCurrentNote(Note note) {
 474         mCurrentNote = note;
 475     }
 476 
 477     public NoteListFragment getNoteListFragment() {
 478         return mNoteListFragment;
 479     }
 480 
 481     @SuppressWarnings(&quot;ResourceType&quot;)
 482     @Override
 483     public boolean onCreateOptionsMenu(Menu menu) {
 484         super.onCreateOptionsMenu(menu);
 485         MenuInflater inflater = getMenuInflater();
 486         inflater.inflate(R.menu.notes_list, menu);
 487         // restore the search query if on a landscape tablet
 488         String searchQuery = null;
 489         if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; (mSearchView != null)) {
 490             searchQuery = mSearchView.getQuery().toString();
 491         }
 492         mSearchMenuItem = menu.findItem(R.id.menu_search);
 493         mSearchView = ((SearchView) (mSearchMenuItem.getActionView()));
 494         if (!TextUtils.isEmpty(searchQuery)) {
 495             mSearchView.setQuery(searchQuery, false);
 496             mSearchMenuItem.expandActionView();
 497         } else {
 498             // Workaround for setting the search placeholder text color
<abbr title=" 499             String hintHexColor = (ThemeUtils.isLightTheme(this) ? getString(R.color.simplenote_light_grey) : getString(R.color.simplenote_text_preview)).replace(&quot;ff&quot;, &quot;&quot;);"> 499             String hintHexColor = (ThemeUtils.isLightTheme(this) ? getString(R.color.simplenote_light_greðŸ”µ</abbr>
<abbr title=" 500             mSearchView.setQueryHint(Html.fromHtml(String.format(&quot;&lt;font color=\&quot;%s\&quot;&gt;%s&lt;/font&gt;&quot;, hintHexColor, getString(R.string.search))));"> 500             mSearchView.setQueryHint(Html.fromHtml(String.format(&quot;&lt;font color=\&quot;%s\&quot;&gt;%s&lt;/font&gt;&quot;, hintHexCðŸ”µ</abbr>
 501         }
 502         mSearchView.setOnQueryTextListener(new SearchView.OnQueryTextListener() {
 503             @Override
 504             public boolean onQueryTextChange(String newText) {
 505                 if (mSearchMenuItem.isActionViewExpanded()) {
 506                     getNoteListFragment().searchNotes(newText);
 507                 }
 508                 return true;
 509             }
 510 
 511             @Override
 512             public boolean onQueryTextSubmit(String queryText) {
 513                 getNoteListFragment().searchNotes(queryText);
 514                 return true;
 515             }
 516         });
<abbr title=" 517         MenuItemCompat.setOnActionExpandListener(mSearchMenuItem, new MenuItemCompat.OnActionExpandListener() {"> 517         MenuItemCompat.setOnActionExpandListener(mSearchMenuItem, new MenuItemCompat.OnActionExpandListenðŸ”µ</abbr>
 518             @Override
 519             public boolean onMenuItemActionExpand(MenuItem menuItem) {
 520                 checkEmptyListText(true);
 521                 if (mNoteListFragment != null) {
 522                     mNoteListFragment.setFloatingActionButtonVisible(false);
 523                 }
<abbr title=" 524                 AnalyticsTracker.track(AnalyticsTracker.Stat.LIST_NOTES_SEARCHED, AnalyticsTracker.CATEGORY_NOTE, &quot;action_bar_search_tap&quot;);"> 524                 AnalyticsTracker.track(AnalyticsTracker.Stat.LIST_NOTES_SEARCHED, AnalyticsTracker.CATEGOðŸ”µ</abbr>
 525                 return true;
 526             }
 527 
 528             @Override
 529             public boolean onMenuItemActionCollapse(MenuItem menuItem) {
 530                 // Show all notes again
 531                 if (mNoteListFragment != null) {
 532                     mNoteListFragment.setFloatingActionButtonVisible(true);
 533                 }
 534                 mTabletSearchQuery = &quot;&quot;;
 535                 mSearchView.setQuery(&quot;&quot;, false);
 536                 checkEmptyListText(false);
 537                 getNoteListFragment().clearSearch();
 538                 return true;
 539             }
 540         });
 541         mSearchMenuItem.setOnMenuItemClickListener(new MenuItem.OnMenuItemClickListener() {
 542             @Override
 543             public boolean onMenuItemClick(MenuItem item) {
 544                 if (!mSearchMenuItem.isActionViewExpanded()) {
 545                     showDetailPlaceholder();
 546                 }
 547                 return false;
 548             }
 549         });
 550         MenuItem trashItem = menu.findItem(R.id.menu_delete).setTitle(R.string.undelete);
 551         if ((mCurrentNote != null) &amp;&amp; mCurrentNote.isDeleted()) {
 552             trashItem.setTitle(R.string.undelete);
 553         } else {
 554             trashItem.setTitle(R.string.delete);
 555         }
 556         if (DisplayUtils.isLargeScreenLandscape(this)) {
 557             // Restore the search query on landscape tablets
 558             if (!TextUtils.isEmpty(mTabletSearchQuery)) {
 559                 mSearchMenuItem.expandActionView();
 560                 mSearchView.setQuery(mTabletSearchQuery, false);
 561                 mSearchView.clearFocus();
 562             }
 563             if (mCurrentNote != null) {
 564                 menu.findItem(R.id.menu_share).setVisible(true);
 565                 menu.findItem(R.id.menu_view_info).setVisible(true);
 566 
 567 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 568                 menu.findItem(R.id.menu_history).setVisible(true);</span>
 569 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 570 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 570 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwðŸ”µ</abbr></span>
 571 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 572 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 573                 menu.findItem(R.id.menu_markdown_preview).setVisible(mIsMarkdownEnabledGlobal &amp;&amp; mCurrentNote.isMarkdownEnabled());"> 573                 menu.findItem(R.id.menu_markdown_preview).setVisible(mIsMarkdownEnabledGlobal &amp;&amp; mCurrentðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 574                 menu.findItem(R.id.menu_markdown_enable).setVisible(mIsMarkdownEnabledGlobal);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 575                 menu.findItem(R.id.menu_markdown_enable).setChecked(mCurrentNote.isMarkdownEnabled());</span>
 576 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 577 
 578                 trashItem.setVisible(true);
 579             } else {
 580                 menu.findItem(R.id.menu_share).setVisible(false);
 581                 menu.findItem(R.id.menu_view_info).setVisible(false);
 582 
 583 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 584                 menu.findItem(R.id.menu_history).setVisible(false);</span>
 585 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 586 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 586 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwðŸ”µ</abbr></span>
 587 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 588 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 589                 menu.findItem(R.id.menu_markdown_preview).setVisible(false);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 590                 menu.findItem(R.id.menu_markdown_enable).setVisible(false);</span>
 591 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 592 
 593                 trashItem.setVisible(false);
 594             }
 595             menu.findItem(R.id.menu_empty_trash).setVisible(false);
 596         } else {
 597             menu.findItem(R.id.menu_search).setVisible(true);
 598             menu.findItem(R.id.menu_share).setVisible(false);
 599             menu.findItem(R.id.menu_view_info).setVisible(false);
 600 
 601 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 602             menu.findItem(R.id.menu_history).setVisible(false);</span>
 603 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 604 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 604 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwðŸ”µ</abbr></span>
 605 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 606 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 607             menu.findItem(R.id.menu_markdown_preview).setVisible(false);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 608             menu.findItem(R.id.menu_markdown_enable).setVisible(false);</span>
 609 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 610 
 611             trashItem.setVisible(false);
 612             menu.findItem(R.id.menu_empty_trash).setVisible(false);
 613         }
 614         // Are we looking at the trash? Adjust menu accordingly.
 615         if (mDrawerList.getCheckedItemPosition() == TRASH_SELECTED_ID) {
 616             mEmptyTrashMenuItem = menu.findItem(R.id.menu_empty_trash);
 617             mEmptyTrashMenuItem.setVisible(true);
 618             updateTrashMenuItem();
 619             menu.findItem(R.id.menu_search).setVisible(false);
 620             menu.findItem(R.id.menu_share).setVisible(false);
 621             menu.findItem(R.id.menu_history).setVisible(false);
 622         }
 623         DrawableUtils.tintMenuWithAttribute(this, menu, R.attr.actionBarTextColor);
 624         return true;
 625     }
 626 
 627     @Override
 628     public boolean onOptionsItemSelected(MenuItem item) {
 629         if (mDrawerToggle.onOptionsItemSelected(item)) {
 630             return true;
 631         }
 632         switch (item.getItemId()) {
 633 
 634 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 635 </span>
 636 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 637 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 637 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwðŸ”µ</abbr></span>
 638 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 639 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 640             case R.id.menu_share:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 641                 if (mCurrentNote != null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 642                     Intent shareIntent = new Intent(android.content.Intent.ACTION_SEND);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 643                     shareIntent.setType(&quot;text/plain&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 644                     shareIntent.putExtra(android.content.Intent.EXTRA_TEXT, mCurrentNote.getContent());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 645                     startActivity(Intent.createChooser(shareIntent, getResources().getString(R.string.share_note)));"> 645                     startActivity(Intent.createChooser(shareIntent, getResources().getString(R.string.shaðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 646                     AnalyticsTracker.track(</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 647                             AnalyticsTracker.Stat.EDITOR_NOTE_CONTENT_SHARED,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 648                             AnalyticsTracker.CATEGORY_NOTE,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 649                             &quot;action_bar_share_button&quot;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 650                     );</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 651                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 652                 return true;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 653             case R.id.menu_markdown_preview:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 654                 if (mIsShowingMarkdown) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 655                     if (ThemeUtils.isLightTheme(NotesActivity.this)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 656                         item.setIcon(R.drawable.ic_markdown_grey_outline_24dp);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 657                     } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 658                         item.setIcon(R.drawable.ic_markdown_blue_outline_24dp);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 659                     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 660 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 661                     mNoteEditorFragment.hideMarkdown();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 662                     item.setTitle(getString(R.string.markdown_show));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 663                     mIsShowingMarkdown = false;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 664                 } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 665                     if (ThemeUtils.isLightTheme(NotesActivity.this)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 666                         item.setIcon(R.drawable.ic_markdown_grey_solid_24dp);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 667                     } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 668                         item.setIcon(R.drawable.ic_markdown_blue_solid_24dp);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 669                     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 670 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 671                     mNoteEditorFragment.showMarkdown();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 672                     item.setTitle(getString(R.string.markdown_hide));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 673                     mIsShowingMarkdown = true;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 674                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 675 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 676                 return true;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 677             case R.id.menu_markdown_enable:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 678                 if (mCurrentNote != null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 679                     if (mNoteEditorFragment != null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 680                         mNoteEditorFragment.setMarkdownEnabled(!mCurrentNote.isMarkdownEnabled());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 681                         mNoteEditorFragment.saveNote();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 682                     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 683 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 684                     item.setChecked(!mCurrentNote.isMarkdownEnabled());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 685                     invalidateOptionsMenu();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 686                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 687 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 688                 if (mNoteEditorFragment != null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 689                     mNoteEditorFragment.hideMarkdown();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 690                     mIsShowingMarkdown = false;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 691                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 692 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 693                 return true;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 694 </span>
 695 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 696             case R.id.menu_delete:
 697                 if (mNoteEditorFragment != null) {
 698                     if (mCurrentNote != null) {
 699                         mCurrentNote.setDeleted(!mCurrentNote.isDeleted());
 700                         mCurrentNote.setModificationDate(Calendar.getInstance());
 701                         mCurrentNote.save();
 702 
 703                         if (mCurrentNote.isDeleted()) {
 704                             List&lt;String&gt; deletedNoteIds = new ArrayList&lt;&gt;();
 705                             deletedNoteIds.add(mCurrentNote.getSimperiumKey());
 706                             mUndoBarController.setDeletedNoteIds(deletedNoteIds);
<abbr title=" 707                             mUndoBarController.showUndoBar(getUndoView(), getString(R.string.note_deleted), null);"> 707                             mUndoBarController.showUndoBar(getUndoView(), getString(R.string.note_deletedðŸ”µ</abbr>
 708                             AnalyticsTracker.track(
 709                                     AnalyticsTracker.Stat.LIST_NOTE_DELETED,
 710                                     AnalyticsTracker.CATEGORY_NOTE,
 711                                     &quot;overflow_menu&quot;
 712                             );
 713                         } else {
 714                             AnalyticsTracker.track(
 715                                     AnalyticsTracker.Stat.EDITOR_NOTE_RESTORED,
 716                                     AnalyticsTracker.CATEGORY_NOTE,
 717                                     &quot;overflow_menu&quot;
 718                             );
 719                         }
 720                         showDetailPlaceholder();
 721                     }
 722                     NoteListFragment fragment = getNoteListFragment();
 723                     if (fragment != null) {
 724                         fragment.getPrefs();
 725                         fragment.refreshList();
 726                     }
 727                 }
 728                 return true;
 729             case R.id.menu_empty_trash:
 730                 AlertDialog.Builder alert = new AlertDialog.Builder(this);
 731 
 732                 alert.setTitle(R.string.empty_trash);
 733                 alert.setMessage(R.string.confirm_empty_trash);
 734                 alert.setPositiveButton(R.string.yes, new DialogInterface.OnClickListener() {
 735                     public void onClick(DialogInterface dialog, int whichButton) {
 736                         new emptyTrashTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR);
 737                         AnalyticsTracker.track(
 738                                 AnalyticsTracker.Stat.LIST_TRASH_EMPTIED,
 739                                 AnalyticsTracker.CATEGORY_NOTE,
 740                                 &quot;overflow_menu&quot;
 741                         );
 742                     }
 743                 });
 744                 alert.setNegativeButton(R.string.no, new DialogInterface.OnClickListener() {
 745                     public void onClick(DialogInterface dialog, int whichButton) {
 746                         // Do nothing, just closing the dialog
 747                     }
 748                 });
 749                 alert.show();
 750                 return true;
 751             case android.R.id.home:
 752                 invalidateOptionsMenu();
 753                 return true;
 754             default:
 755                 return super.onOptionsItemSelected(item);
 756         }
 757     }
 758 
 759     @Override
 760     public boolean onPrepareOptionsMenu(Menu menu) {
 761         MenuItem markdownItem = menu.findItem(R.id.menu_markdown_preview);
 762 
 763         if (mIsShowingMarkdown) {
 764             if (ThemeUtils.isLightTheme(NotesActivity.this)) {
 765                 markdownItem.setIcon(R.drawable.ic_markdown_grey_solid_24dp);
 766             } else {
 767                 markdownItem.setIcon(R.drawable.ic_markdown_blue_solid_24dp);
 768             }
 769 
 770             markdownItem.setTitle(getString(R.string.markdown_hide));
 771         } else {
 772             if (ThemeUtils.isLightTheme(NotesActivity.this)) {
 773                 markdownItem.setIcon(R.drawable.ic_markdown_grey_outline_24dp);
 774             } else {
 775                 markdownItem.setIcon(R.drawable.ic_markdown_blue_outline_24dp);
 776             }
 777 
 778             markdownItem.setTitle(getString(R.string.markdown_show));
 779         }
 780 
 781         return super.onPrepareOptionsMenu(menu);
 782     }
 783 
 784     /**
 785      * Callback method from {@link NoteListFragment.Callbacks} indicating that
 786      * the item with the given ID was selected. Used for tablets only.
 787      */
 788     @Override
<abbr title=" 789     public void onNoteSelected(String noteID, int position, boolean isNew, String matchOffsets, boolean isMarkdownEnabled) {"> 789     public void onNoteSelected(String noteID, int position, boolean isNew, String matchOffsets, boolean iðŸ”µ</abbr>
 790         if (!DisplayUtils.isLargeScreenLandscape(this)) {
 791             // Launch the editor activity
 792             Bundle arguments = new Bundle();
 793             arguments.putString(NoteEditorFragment.ARG_ITEM_ID, noteID);
 794             arguments.putBoolean(NoteEditorFragment.ARG_NEW_NOTE, isNew);
 795             arguments.putBoolean(NoteEditorFragment.ARG_MARKDOWN_ENABLED, isMarkdownEnabled);
 796             if (matchOffsets != null) {
 797                 arguments.putString(NoteEditorFragment.ARG_MATCH_OFFSETS, matchOffsets);
 798             }
 799             Intent editNoteIntent = new Intent(this, NoteEditorActivity.class);
 800             editNoteIntent.putExtras(arguments);
 801             startActivityForResult(editNoteIntent, Simplenote.INTENT_EDIT_NOTE);
 802         } else {
 803             mNoteEditorFragment.setIsNewNote(isNew);
 804             mNoteEditorFragment.setNote(noteID, matchOffsets);
 805             getNoteListFragment().setNoteSelected(noteID);
 806             if ((mSearchView != null) &amp;&amp; (mSearchView.getQuery() != null)) {
 807                 mTabletSearchQuery = mSearchView.getQuery().toString();
 808             }
 809             mNoteEditorFragment.clearMarkdown();
 810             if ((!isMarkdownEnabled) &amp;&amp; mIsShowingMarkdown) {
 811                 mNoteEditorFragment.hideMarkdown();
 812                 mIsShowingMarkdown = false;
 813             }
 814             invalidateOptionsMenu();
 815         }
<abbr title=" 816         AnalyticsTracker.track(AnalyticsTracker.Stat.LIST_NOTE_OPENED, AnalyticsTracker.CATEGORY_NOTE, &quot;note_list_row_tap&quot;);"> 816         AnalyticsTracker.track(AnalyticsTracker.Stat.LIST_NOTE_OPENED, AnalyticsTracker.CATEGORY_NOTE, &quot;nðŸ”µ</abbr>
 817     }
 818 
 819     @Override
 820     public void onUserCreated(User user) {
 821         // New account created
 822         AnalyticsTracker.track(
 823                 AnalyticsTracker.Stat.USER_ACCOUNT_CREATED,
 824                 AnalyticsTracker.CATEGORY_USER,
 825                 &quot;account_created_from_login_activity&quot;
 826         );
 827     }
 828 
 829     public void onUserStatusChange(User.Status status) {
 830         switch (status) {
 831             // successfully used access token to connect to simperium bucket
 832             case AUTHORIZED:
 833                 runOnUiThread(new Runnable() {
 834                     @Override
 835                     public void run() {
 836                         if (!mNotesBucket.hasChangeVersion()) {
 837                             setToolbarProgressVisibility(true);
 838                         }
 839                     }
 840                 });
 841                 break;
 842 
 843             // NOT_AUTHORIZED means we attempted to connect but the token was not valid
 844             case NOT_AUTHORIZED:
 845                 runOnUiThread(new Runnable() {
 846                     @Override
 847                     public void run() {
 848                         startLoginActivity(true);
 849                     }
 850                 });
 851                 break;
 852 
<abbr title=" 853             // Default starting state of User, don&#x27;t do anything we allow use of app while not signed in so don&#x27;t do anything"> 853             // Default starting state of User, don&#x27;t do anything we allow use of app while not signed in ðŸ”µ</abbr>
 854             case UNKNOWN:
 855                 break;
 856         }
 857     }
 858 
 859     private void setToolbarProgressVisibility(boolean isVisible) {
 860         if (getSupportActionBar() != null) {
 861             getSupportActionBar().setDisplayShowCustomEnabled(isVisible);
 862         }
 863     }
 864 
 865     public void startLoginActivity(boolean signInFirst) {
 866         Intent loginIntent = new Intent(this, LoginActivity.class);
 867         if (signInFirst)
 868             loginIntent.putExtra(LoginActivity.EXTRA_SIGN_IN_FIRST, true);
 869         startActivityForResult(loginIntent, Simperium.SIGNUP_SIGNIN_REQUEST);
 870     }
 871 
 872     @Override
 873     public void recreate() {
 874         Handler handler = new Handler();
 875         handler.post(new Runnable()
 876         {
 877             @Override
 878             public void run()
 879             {
 880                 if (Build.VERSION.SDK_INT &lt; Build.VERSION_CODES.HONEYCOMB)
 881                 {
 882                     NotesActivity.this.finish();
 883                     NotesActivity.this.startActivity(NotesActivity.this.getIntent());
 884                 } else {
 885                     NotesActivity.super.recreate();
 886                 }
 887             }
 888         });
 889     }
 890 
 891     @Override
 892     protected void onActivityResult(int requestCode, int resultCode, Intent data) {
 893         super.onActivityResult(requestCode, resultCode, data);
 894         switch (requestCode) {
 895             case Simplenote.INTENT_PREFERENCES :
 896                 if (ThemeUtils.themeWasChanged(data)) {
 897                     // Restart this activity to apply the new theme
 898                     recreate();
 899                     break;
 900                 }
<abbr title=" 901                 // nbradbury - refresh note list when user returns from preferences (in case they changed anything)"> 901                 // nbradbury - refresh note list when user returns from preferences (in case they changedðŸ”µ</abbr>
 902                 invalidateOptionsMenu();
 903                 NoteListFragment fragment = getNoteListFragment();
 904                 if (fragment != null) {
 905                     fragment.getPrefs();
 906                     fragment.refreshList();
 907                 }
 908                 break;
 909             case Simplenote.INTENT_EDIT_NOTE :
<abbr title=" 910                 if (((resultCode == RESULT_OK) &amp;&amp; (data != null)) &amp;&amp; data.hasExtra(Simplenote.DELETED_NOTE_ID)) {"> 910                 if (((resultCode == RESULT_OK) &amp;&amp; (data != null)) &amp;&amp; data.hasExtra(Simplenote.DELETED_NOTðŸ”µ</abbr>
 911                     String noteId = data.getStringExtra(Simplenote.DELETED_NOTE_ID);
 912                     if (noteId != null) {
 913                         List&lt;String&gt; deletedNoteIds = new ArrayList&lt;&gt;();
 914                         deletedNoteIds.add(noteId);
 915                         mUndoBarController.setDeletedNoteIds(deletedNoteIds);
<abbr title=" 916                         mUndoBarController.showUndoBar(getUndoView(), getString(R.string.note_deleted), null);"> 916                         mUndoBarController.showUndoBar(getUndoView(), getString(R.string.note_deleted), nðŸ”µ</abbr>
 917                     }
 918                 }
 919                 break;
 920             case Simperium.SIGNUP_SIGNIN_REQUEST :
 921                 invalidateOptionsMenu();
 922                 Simplenote app = ((Simplenote) (getApplication()));
 923                 AnalyticsTracker.refreshMetadata(app.getSimperium().getUser().getEmail());
<abbr title=" 924                 AnalyticsTracker.track(AnalyticsTracker.Stat.USER_SIGNED_IN, AnalyticsTracker.CATEGORY_USER, &quot;signed_in_from_login_activity&quot;);"> 924                 AnalyticsTracker.track(AnalyticsTracker.Stat.USER_SIGNED_IN, AnalyticsTracker.CATEGORY_USðŸ”µ</abbr>
 925                 if ((resultCode == Activity.RESULT_CANCELED) &amp;&amp; userAuthenticationIsInvalid()) {
 926                     finish();
 927                 }
 928                 break;
 929         }
 930     }
 931 
 932     @Override
 933     public void onUndo() {
 934         if (mUndoBarController == null) return;
 935 
 936         List&lt;String&gt; deletedNoteIds = mUndoBarController.getDeletedNoteIds();
 937         if (deletedNoteIds != null) {
 938             for (int i = 0; i &lt; deletedNoteIds.size(); i++) {
 939                 Note deletedNote;
 940                 try {
 941                     deletedNote = mNotesBucket.get(deletedNoteIds.get(i));
 942                 } catch (BucketObjectMissingException e) {
 943                     return;
 944                 }
 945                 if (deletedNote != null) {
 946                     deletedNote.setDeleted(false);
 947                     deletedNote.setModificationDate(Calendar.getInstance());
 948                     deletedNote.save();
 949                     NoteListFragment fragment = getNoteListFragment();
 950                     if (fragment != null) {
 951                         fragment.getPrefs();
 952                         fragment.refreshList();
 953                     }
 954                 }
 955             }
 956         }
 957     }
 958 
 959     @Override
 960     protected void onPostCreate(Bundle savedInstanceState) {
 961         super.onPostCreate(savedInstanceState);
 962         // Sync the toggle state after onRestoreInstanceState has occurred.
 963         mDrawerToggle.syncState();
 964     }
 965 
 966     @Override
 967     public void onConfigurationChanged(Configuration newConfig) {
 968         super.onConfigurationChanged(newConfig);
 969         mDrawerToggle.onConfigurationChanged(newConfig);
 970         if (DisplayUtils.isLargeScreen(this)) {
 971             mIsShowingMarkdown = false;
 972             if (newConfig.orientation == Configuration.ORIENTATION_LANDSCAPE) {
 973                 // Add the editor fragment
 974                 addEditorFragment();
 975                 if (mNoteListFragment != null) {
 976                     mNoteListFragment.setActivateOnItemClick(true);
 977                     mNoteListFragment.setDividerVisible(true);
 978                 }
 979                 // Select the current note on a tablet
 980                 if (mCurrentNote != null) {
<abbr title=" 981                     onNoteSelected(mCurrentNote.getSimperiumKey(), 0, false, null, mCurrentNote.isMarkdownEnabled());"> 981                     onNoteSelected(mCurrentNote.getSimperiumKey(), 0, false, null, mCurrentNote.isMarkdowðŸ”µ</abbr>
 982                 } else {
 983                     mNoteEditorFragment.setPlaceholderVisible(true);
 984                     mNoteListFragment.getListView().clearChoices();
 985                 }
 986                 invalidateOptionsMenu();
<abbr title=" 987             } else if ((newConfig.orientation == Configuration.ORIENTATION_PORTRAIT) &amp;&amp; (mNoteEditorFragment != null)) {"> 987             } else if ((newConfig.orientation == Configuration.ORIENTATION_PORTRAIT) &amp;&amp; (mNoteEditorFragmðŸ”µ</abbr>
 988                 // Remove the editor fragment when rotating back to portrait
 989                 mCurrentNote = null;
 990                 if (mNoteListFragment != null) {
 991                     mNoteListFragment.setActivateOnItemClick(false);
 992                     mNoteListFragment.setDividerVisible(false);
 993                     mNoteListFragment.setActivatedPosition(ListView.INVALID_POSITION);
 994                     mNoteListFragment.refreshList();
 995                 }
 996                 FragmentManager fm = getSupportFragmentManager();
 997                 FragmentTransaction ft = fm.beginTransaction();
 998                 ft.remove(mNoteEditorFragment);
 999                 mNoteEditorFragment = null;
1000                 ft.commitAllowingStateLoss();
1001                 fm.executePendingTransactions();
1002                 invalidateOptionsMenu();
1003             }
1004         }
1005     }
1006 
1007     public void checkEmptyListText(boolean isSearch) {
1008         if (isSearch) {
<abbr title="1009             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_found) + &quot;&lt;/strong&gt;&quot;);">1009             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_found) + &quot;ðŸ”µ</abbr>
1010             getNoteListFragment().setEmptyListViewClickable(false);
1011         } else if (mDrawerList.getCheckedItemPosition() == TRASH_SELECTED_ID) {
<abbr title="1012             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.trash_is_empty) + &quot;&lt;/strong&gt;&quot;);">1012             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.trash_is_empty) + &quot;ðŸ”µ</abbr>
1013             AnalyticsTracker.track(
1014                     AnalyticsTracker.Stat.LIST_TRASH_VIEWED,
1015                     AnalyticsTracker.CATEGORY_NOTE,
1016                     &quot;trash_filter_selected&quot;
1017             );
1018             getNoteListFragment().setEmptyListViewClickable(false);
1019         } else {
<abbr title="1020             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here) + &quot;&lt;/strong&gt;&lt;br /&gt;&quot; + String.format(getString(R.string.why_not_create_one), &quot;&lt;u&gt;&quot;, &quot;&lt;/u&gt;&quot;));">1020             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here) + &quot;&lt;ðŸ”µ</abbr>
1021             getNoteListFragment().setEmptyListViewClickable(true);
1022         }
1023     }
1024 
1025     public void showDetailPlaceholder() {
1026         if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; (mNoteEditorFragment != null)) {
1027             mCurrentNote = null;
1028             mNoteEditorFragment.setPlaceholderVisible(true);
1029             mNoteEditorFragment.clearMarkdown();
1030             mNoteEditorFragment.hideMarkdown();
1031             mIsShowingMarkdown = false;
1032         }
1033     }
1034 
1035     public void stopListeningToNotesBucket() {
1036         mNotesBucket.removeOnNetworkChangeListener(this);
1037         mNotesBucket.removeOnSaveObjectListener(this);
1038         mNotesBucket.removeOnDeleteObjectListener(this);
1039     }
1040 
1041     // Returns the appropriate view to show the undo bar within
1042     private View getUndoView() {
1043         View undoView = mFragmentsContainer;
1044         if (!DisplayUtils.isLargeScreenLandscape(this) &amp;&amp;
1045                 getNoteListFragment() != null &amp;&amp;
1046                 getNoteListFragment().getRootView() != null) {
1047             undoView = getNoteListFragment().getRootView();
1048         }
1049 
1050         return undoView;
1051     }
1052 
1053     public void showUndoBarWithNoteIds(List&lt;String&gt; noteIds) {
1054         if (mUndoBarController != null) {
1055             mUndoBarController.setDeletedNoteIds(noteIds);
1056             mUndoBarController.showUndoBar(
1057                     getUndoView(),
<abbr title="1058                     getResources().getQuantityString(R.plurals.trashed_notes, noteIds.size(), noteIds.size()),">1058                     getResources().getQuantityString(R.plurals.trashed_notes, noteIds.size(), noteIds.sizðŸ”µ</abbr>
1059                     null
1060             );
1061         }
1062     }
1063 
1064     private class emptyTrashTask extends AsyncTask&lt;Void, Void, Void&gt; {
1065         @Override
1066         protected Void doInBackground(Void... voids) {
1067             if (mNotesBucket == null) {
1068                 return null;
1069             }
1070             Query&lt;Note&gt; query = Note.allDeleted(mNotesBucket);
1071             Bucket.ObjectCursor c = query.execute();
1072             while (c.moveToNext()) {
1073                 c.getObject().delete();
1074             }
1075             return null;
1076         }
1077 
1078         @Override
1079         protected void onPostExecute(Void nada) {
1080             showDetailPlaceholder();
1081         }
1082     }
1083 
1084     /* Simperium Bucket Listeners */
1085     // received a change from the network, refresh the list
1086     @Override
1087     public void onNetworkChange(Bucket&lt;Note&gt; bucket, final Bucket.ChangeType type, String key) {
1088         runOnUiThread(new Runnable() {
1089             @Override
1090             public void run() {
1091                 if (type == Bucket.ChangeType.INDEX) {
1092                     setToolbarProgressVisibility(false);
1093                 }
1094                 mNoteListFragment.refreshList();
1095             }
1096         });
1097     }
1098 
1099     @Override
1100     public void onSaveObject(Bucket&lt;Note&gt; bucket, Note object) {
1101         runOnUiThread(new Runnable() {
1102             @Override
1103             public void run() {
1104                 mNoteListFragment.refreshList();
1105             }
1106         });
1107     }
1108 
1109     @Override
1110     public void onDeleteObject(Bucket&lt;Note&gt; bucket, Note object) {
1111         runOnUiThread(new Runnable() {
1112             @Override
1113             public void run() {
1114                 mNoteListFragment.refreshList();
1115             }
1116         });
1117     }
1118 
1119     @Override
1120     public void onBeforeUpdateObject(Bucket&lt;Note&gt; bucket, Note note) {
1121         // noop, NoteEditorFragment will handle this
1122     }
1123 
1124     // Tags bucket listener
1125     // Tags bucket listener
1126     private Bucket.Listener&lt;Tag&gt; mTagsMenuUpdater = new Bucket.Listener&lt;Tag&gt;() {
1127         void updateNavigationDrawer() {
1128             runOnUiThread(new Runnable() {
1129                 public void run() {
1130                     updateNavigationDrawerItems();
1131                 }
1132             });
1133         }
1134 
1135         @Override
1136         public void onSaveObject(Bucket&lt;Tag&gt; bucket, Tag tag) {
1137             updateNavigationDrawer();
1138         }
1139 
1140         @Override
1141         public void onDeleteObject(Bucket&lt;Tag&gt; bucket, Tag tag) {
1142             updateNavigationDrawer();
1143         }
1144 
1145         @Override
1146         public void onNetworkChange(Bucket&lt;Tag&gt; bucket, Bucket.ChangeType type, String key) {
1147             updateNavigationDrawer();
1148         }
1149 
1150         @Override
1151         public void onBeforeUpdateObject(Bucket&lt;Tag&gt; bucket, Tag object) {
1152             // noop
1153         }
1154     };
1155 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  package com.automattic.simplenote;
   2  
   3  import android.app.Activity;
   4  import android.app.AlertDialog;
   5  import android.app.FragmentManager;
   6  import android.app.FragmentTransaction;
   7  import android.content.DialogInterface;
   8  import android.content.Intent;
   9  import android.content.SharedPreferences;
  10  import android.content.res.Configuration;
  11  import android.os.AsyncTask;
  12  import android.os.Build;
  13  import android.os.Bundle;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  14 +import android.os.Handler;</span>
  15  import android.preference.PreferenceManager;
  16  import android.support.design.widget.NavigationView;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  17 +import android.support.v4.content.ContextCompat;</span>

  18  import android.support.v4.view.GravityCompat;
  19  import android.support.v4.view.MenuItemCompat;
  20  import android.support.v4.widget.DrawerLayout;
  21  import android.support.v7.app.ActionBar;
  22  import android.support.v7.app.ActionBarDrawerToggle;
  23  import android.support.v7.app.AppCompatActivity;
  24  import android.support.v7.widget.SearchView;
  25  import android.support.v7.widget.Toolbar;
  26  import android.text.Html;
  27  import android.text.Spannable;
  28  import android.text.SpannableString;
  29  import android.text.TextUtils;
  30  import android.view.Menu;
  31  import android.view.MenuInflater;
  32  import android.view.MenuItem;
  33  import android.view.View;
  34  import android.view.WindowManager;
  35  import android.widget.AdapterView;
  36  import android.widget.ListView;
  37  import android.widget.ProgressBar;
  38  import android.widget.TextView;
  39  
  40  import com.automattic.simplenote.analytics.AnalyticsTracker;
  41  import com.automattic.simplenote.models.Note;
  42  import com.automattic.simplenote.models.Tag;
  43  import com.automattic.simplenote.utils.AniUtils;
  44  import com.automattic.simplenote.utils.DisplayUtils;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  45 +import com.automattic.simplenote.utils.DrawableUtils;</span>
  46  import com.automattic.simplenote.utils.PrefUtils;
  47  import com.automattic.simplenote.utils.StrUtils;
  48  import com.automattic.simplenote.utils.TagsAdapter;
  49  import com.automattic.simplenote.utils.ThemeUtils;
  50  import com.automattic.simplenote.utils.UndoBarController;
  51  import com.automattic.simplenote.widgets.TypefaceSpan;
  52  import com.simperium.Simperium;
  53  import com.simperium.android.LoginActivity;
  54  import com.simperium.client.Bucket;
  55  import com.simperium.client.BucketObjectMissingException;
  56  import com.simperium.client.BucketObjectNameInvalid;
  57  import com.simperium.client.Query;
  58  import com.simperium.client.User;
  59  
  60  import org.wordpress.passcodelock.AppLockManager;
  61  
  62  import java.util.ArrayList;
  63  import java.util.Calendar;
  64  import java.util.List;
  65  
  66  public class NotesActivity extends AppCompatActivity implements
<abbr title="  67          NoteListFragment.Callbacks, User.StatusChangeListener, Simperium.OnUserCreatedListener, UndoBarController.UndoListener,">  67          NoteListFragment.Callbacks, User.StatusChangeListener, Simperium.OnUserCreatedListener, UndoBarController.ðŸ”µ</abbr>
  68          Bucket.Listener&lt;Note&gt; {
  69  
  70      public static String TAG_NOTE_LIST = &quot;noteList&quot;;
  71      public static String TAG_NOTE_EDITOR = &quot;noteEditor&quot;;
  72      private int TRASH_SELECTED_ID = 2;
  73  


  74      private boolean mShouldSelectNewNote;
  75      private String mTabletSearchQuery;
  76      private UndoBarController mUndoBarController;
  77      private View mFragmentsContainer;
  78      private View mWelcomeView;
  79      private SearchView mSearchView;
  80      private MenuItem mSearchMenuItem;
  81      private NoteListFragment mNoteListFragment;
  82      private NoteEditorFragment mNoteEditorFragment;
  83      private Note mCurrentNote;
  84      protected Bucket&lt;Note&gt; mNotesBucket;
  85      protected Bucket&lt;Tag&gt; mTagsBucket;
  86      private MenuItem mEmptyTrashMenuItem;
  87  
  88      // Menu drawer
  89      private DrawerLayout mDrawerLayout;
  90      private ListView mDrawerList;
  91      private NavigationView mNavigationView;
  92      private ActionBarDrawerToggle mDrawerToggle;
  93      private TagsAdapter mTagsAdapter;
  94      private TagsAdapter.TagMenuItem mSelectedTag;
  95  
  96      @Override
  97      protected void onCreate(Bundle savedInstanceState) {
  98          // On lollipop, configure the translucent status bar
  99          if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.LOLLIPOP) {
 100              getWindow().addFlags(WindowManager.LayoutParams.FLAG_DRAWS_SYSTEM_BAR_BACKGROUNDS);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 101 -            getWindow().setStatusBarColor(getResources().getColor(R.color.transparent));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 102 +            getWindow().setStatusBarColor(ContextCompat.getColor(this, R.color.transparent));</span>
 103          }
 104  
 105          ThemeUtils.setTheme(this);
 106          super.onCreate(savedInstanceState);
 107          setContentView(R.layout.activity_notes);
 108  
 109          mFragmentsContainer = findViewById(R.id.note_fragment_container);
 110  
 111          Simplenote currentApp = (Simplenote) getApplication();
 112          if (mNotesBucket == null) {
 113              mNotesBucket = currentApp.getNotesBucket();
 114          }
 115  
 116          if (mTagsBucket == null) {
 117              mTagsBucket = currentApp.getTagsBucket();
 118          }
 119  
 120          Toolbar toolbar = (Toolbar) findViewById(R.id.toolbar);
 121          setSupportActionBar(toolbar);
 122          configureNavigationDrawer(toolbar);
 123  
 124          if (savedInstanceState == null) {
 125              mNoteListFragment = new NoteListFragment();
 126              FragmentTransaction fragmentTransaction = getFragmentManager().beginTransaction();

 127              fragmentTransaction.add(R.id.note_fragment_container, mNoteListFragment, TAG_NOTE_LIST);
 128              fragmentTransaction.commit();
 129          } else {
 130              mNoteListFragment = (NoteListFragment) getFragmentManager().findFragmentByTag(TAG_NOTE_LIST);

 131          }
 132  
 133          if (DisplayUtils.isLargeScreen(this)) {
 134              if (getFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR) != null) {
<abbr title=" 135                  mNoteEditorFragment = (NoteEditorFragment) getFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR);"> 135                  mNoteEditorFragment = (NoteEditorFragment) getFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR)ðŸ”µ</abbr>


 136              } else if (DisplayUtils.isLandscape(this)) {
 137                  addEditorFragment();
 138              }
 139          }
 140  
 141          // enable ActionBar app icon to behave as action to toggle nav drawer
 142          ActionBar actionBar = getSupportActionBar();
 143          if (actionBar != null) {
 144              actionBar.setDisplayHomeAsUpEnabled(true);
 145              actionBar.setHomeButtonEnabled(true);
 146  
 147              // Add loading indicator to show when indexing
<abbr title=" 148              ProgressBar progressBar = (ProgressBar) getLayoutInflater().inflate(R.layout.progressbar_toolbar, null);"> 148              ProgressBar progressBar = (ProgressBar) getLayoutInflater().inflate(R.layout.progressbar_toolbar, nullðŸ”µ</abbr>
 149              actionBar.setDisplayShowCustomEnabled(true);
 150              actionBar.setCustomView(progressBar);
 151              setToolbarProgressVisibility(false);
 152          }
 153  
 154          mUndoBarController = new UndoBarController(this);
 155  
 156          // Creates &#x27;Welcome&#x27; note
 157          checkForFirstLaunch();
 158  
 159          checkForSharedContent();
 160  
 161          currentApp.getSimperium().setOnUserCreatedListener(this);
 162          currentApp.getSimperium().setUserStatusChangeListener(this);
 163      }
 164  
 165      @Override
 166      protected void onResume() {
 167          super.onResume();
 168  
 169          // Ensure user has valid authorization
 170          if (userAuthenticationIsInvalid()) {
 171              startLoginActivity(true);
 172          }
 173  
 174          mNotesBucket.start();
 175          mTagsBucket.start();
 176  
 177          mNotesBucket.addOnNetworkChangeListener(this);
 178          mNotesBucket.addOnSaveObjectListener(this);
 179          mNotesBucket.addOnDeleteObjectListener(this);
 180          mTagsBucket.addListener(mTagsMenuUpdater);
 181  
 182          setWelcomeViewVisibility();
 183          updateNavigationDrawerItems();
 184  
 185          // if the user is not authenticated and the tag doesn&#x27;t exist revert to default drawer selection
 186          if (userIsUnauthorized()) {
 187              if (-1 == mTagsAdapter.getPosition(mSelectedTag)) {
 188                  mSelectedTag = null;
 189                  mDrawerList.setSelection(TagsAdapter.DEFAULT_ITEM_POSITION);
 190              }
 191          }
 192  
 193          setSelectedTagActive();
 194  
 195          if (mCurrentNote != null &amp;&amp; mShouldSelectNewNote) {
 196              onNoteSelected(mCurrentNote.getSimperiumKey(), 0, true, null);

 197              mShouldSelectNewNote = false;
 198          }


 199      }
 200  
 201      @Override
 202      protected void onPause() {
 203          super.onPause();
 204  
 205          mTagsBucket.removeListener(mTagsMenuUpdater);
 206  
 207          mNotesBucket.removeOnNetworkChangeListener(this);
 208          mNotesBucket.removeOnSaveObjectListener(this);
 209          mNotesBucket.removeOnDeleteObjectListener(this);
 210      }
 211  
 212      @Override
 213      public void setTitle(CharSequence title) {
 214          if (title == null) {
 215              title = &quot;&quot;;
 216          }
 217  
 218          setTitleWithCustomFont(title);
 219      }
 220  
 221      @Override
 222      public void onBackPressed() {
 223          if (mDrawerLayout != null &amp;&amp; mDrawerLayout.isDrawerOpen(GravityCompat.START)) {
 224              mDrawerLayout.closeDrawer(GravityCompat.START);
 225          } else {
 226              super.onBackPressed();
 227          }
 228      }
 229  
 230      private void setTitleWithCustomFont(CharSequence title) {
 231          if (getSupportActionBar() == null) return;
 232  
 233          // LG devices running 4.1 can&#x27;t handle a custom font in the action bar title
 234          if ((!TextUtils.isEmpty(Build.BRAND) &amp;&amp; Build.BRAND.toLowerCase().contains(&quot;lge&quot;))
 235                  &amp;&amp; Build.VERSION.SDK_INT &lt;= Build.VERSION_CODES.JELLY_BEAN) {
 236              getSupportActionBar().setTitle(title);
 237              return;
 238          }
 239  
 240          SpannableString s = new SpannableString(title);
 241          s.setSpan(new TypefaceSpan(this), 0, s.length(), Spannable.SPAN_EXCLUSIVE_EXCLUSIVE);
 242          getSupportActionBar().setTitle(s);
 243      }
 244  
 245      private void configureNavigationDrawer(Toolbar toolbar) {
 246          mDrawerLayout = (DrawerLayout) findViewById(R.id.drawer_layout);
 247          mDrawerLayout.setDrawerShadow(R.drawable.drawer_shadow, GravityCompat.START);
 248          mNavigationView = (NavigationView) findViewById(R.id.navigation_view);
 249          mDrawerList = (ListView) findViewById(R.id.drawer_list);
 250  
 251          // Configure welcome view in the nav drawer
 252          mWelcomeView = mDrawerLayout.findViewById(R.id.welcome_view);
 253          TextView welcomeSignInButton = (TextView)mDrawerLayout.findViewById(R.id.welcome_sign_in_button);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 254 -        welcomeSignInButton.setText(StrUtils.setTextToUpperCaseAndBold(getString(R.string.sign_in)));</span>
 255          welcomeSignInButton.setOnClickListener(new View.OnClickListener() {
 256              @Override
 257              public void onClick(View v) {
 258                  startLoginActivity(true);
 259              }
 260          });
 261  
 262          TextView welcomeCloseButton = (TextView)mDrawerLayout.findViewById(R.id.welcome_close);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 263 -        welcomeCloseButton.setText(StrUtils.setTextToUpperCaseAndBold(getString(R.string.dismiss)));</span>
 264                  welcomeCloseButton.setOnClickListener(new View.OnClickListener() {
 265                      @Override
 266                      public void onClick(View v) {
 267                          removeWelcomeView();
 268                      }
 269                  });
 270  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 271 -        if (mDrawerList.getHeaderViewsCount() == 0) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 272 -            View headerView = getLayoutInflater().inflate(R.layout.nav_drawer_header, null);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 273 -            mDrawerList.addHeaderView(headerView, null, false);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 274 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 275 -</span>
 276          View settingsButton = findViewById(R.id.nav_settings);
 277          settingsButton.setOnClickListener(new View.OnClickListener() {
 278              @Override
 279              public void onClick(View v) {
 280                  Intent i = new Intent(NotesActivity.this, PreferencesActivity.class);
 281                  startActivityForResult(i, Simplenote.INTENT_PREFERENCES);
 282              }
 283          });
 284  
 285          mNavigationView.getLayoutParams().width = ThemeUtils.getOptimalDrawerWidth(this);
 286          mTagsAdapter = new TagsAdapter(this, mNotesBucket, mDrawerList.getHeaderViewsCount());
 287          mDrawerList.setAdapter(mTagsAdapter);
 288          // Set the list&#x27;s click listener
 289          mDrawerList.setOnItemClickListener(new DrawerItemClickListener());
 290  
 291          if (mSelectedTag == null)
 292              mSelectedTag = mTagsAdapter.getDefaultItem();
 293  
 294          mDrawerToggle = new ActionBarDrawerToggle(this, mDrawerLayout, toolbar, R.string.open_drawer,
 295                  R.string.close_drawer) {
 296              public void onDrawerClosed(View view) {
 297                  supportInvalidateOptionsMenu();
 298              }
 299  
 300              public void onDrawerOpened(View drawerView) {
 301                  // noop
 302              }
 303          };
 304  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 305 -        mDrawerLayout.setDrawerListener(mDrawerToggle);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 306 +        mDrawerLayout.addDrawerListener(mDrawerToggle);</span>
 307      }
 308  
 309      private void setWelcomeViewVisibility() {
 310          if (mWelcomeView == null) return;
 311          // Hide welcome view if user is signed in or closed the welcome view
 312          if (userIsAuthorized() || PrefUtils.getBoolPref(this, PrefUtils.PREF_APP_TRIAL)) {
 313              mWelcomeView.setVisibility(View.GONE);
 314          } else {
 315              mWelcomeView.setVisibility(View.VISIBLE);
 316              mWelcomeView.setAlpha(1.0f);
 317          }
 318      }
 319  
 320      private void removeWelcomeView() {
 321          if (mWelcomeView == null) return;
 322  
 323          AniUtils.swipeOutToLeft(mWelcomeView);
 324  
 325          // Set preference so the welcome view never shows again
 326          SharedPreferences preferences = PreferenceManager.getDefaultSharedPreferences(this);
 327          SharedPreferences.Editor editor = preferences.edit();
 328          editor.putBoolean(PrefUtils.PREF_APP_TRIAL, true);
 329          editor.apply();
 330      }
 331  
 332      private void checkForFirstLaunch() {
 333          if (PrefUtils.getBoolPref(this, PrefUtils.PREF_FIRST_LAUNCH, true)) {
 334              // Create the welcome note
 335              try {
 336                  Note welcomeNote = mNotesBucket.newObject(&quot;welcome-android&quot;);
 337                  welcomeNote.setCreationDate(Calendar.getInstance());
 338                  welcomeNote.setModificationDate(welcomeNote.getCreationDate());
 339                  welcomeNote.setContent(getString(R.string.welcome_note));
 340                  welcomeNote.getTitle();
 341                  welcomeNote.save();
 342              } catch (BucketObjectNameInvalid e) {
 343                  // this won&#x27;t happen because welcome-android is a valid name
 344              }
 345  
 346              SharedPreferences preferences = PreferenceManager.getDefaultSharedPreferences(this);
 347              SharedPreferences.Editor editor = preferences.edit();
 348              editor.putBoolean(PrefUtils.PREF_FIRST_LAUNCH, false);
 349              editor.apply();
 350          }
 351      }
 352  
 353      private void checkForSharedContent() {
 354          if (getIntent().hasExtra(Intent.EXTRA_TEXT)) {
 355              // Check share action
 356              Intent intent = getIntent();
 357              String subject = intent.getStringExtra(Intent.EXTRA_SUBJECT);
 358              String text = intent.getStringExtra(Intent.EXTRA_TEXT);
 359  
 360              // Don&#x27;t add the &#x27;Note to self&#x27; subject or open the note if this was shared from a voice search
 361              String intentAction = StrUtils.notNullStr(intent.getAction());
 362              boolean isVoiceShare = intentAction.equals(&quot;com.google.android.gm.action.AUTO_SEND&quot;);
 363              if (!TextUtils.isEmpty(text)) {
 364                  if (!TextUtils.isEmpty(subject) &amp;&amp; !isVoiceShare) {
 365                      text = subject + &quot;\n\n&quot; + text;
 366                  }
 367                  Note note = mNotesBucket.newObject();
 368                  note.setCreationDate(Calendar.getInstance());
 369                  note.setModificationDate(note.getCreationDate());
 370                  note.setContent(text);
 371                  note.save();
 372                  setCurrentNote(note);
 373  
 374                  if (!isVoiceShare) {
 375                      mShouldSelectNewNote = true;
 376                  }
 377                  AnalyticsTracker.track(
 378                          AnalyticsTracker.Stat.LIST_NOTE_CREATED,
 379                          AnalyticsTracker.CATEGORY_NOTE,
 380                          &quot;external_share&quot;
 381                  );
 382  
 383                  if (!DisplayUtils.isLargeScreenLandscape(this)) {
 384                      // Disable the lock screen when sharing content and opening NoteEditorActivity
 385                      // Lock screen activities are enabled again in NoteEditorActivity.onPause()
 386                      if (AppLockManager.getInstance().isAppLockFeatureEnabled()) {
 387                          AppLockManager.getInstance().getCurrentAppLock().setDisabledActivities(
 388                                  new String[]{&quot;com.automattic.simplenote.NotesActivity&quot;,
 389                                  &quot;com.automattic.simplenote.NoteEditorActivity&quot;});
 390                          AppLockManager.getInstance().getCurrentAppLock().setOneTimeTimeout(0);
 391                      }
 392                  }
 393              }
 394          }
 395      }
 396  
 397      private void updateNavigationDrawerItems() {
 398          Bucket.ObjectCursor&lt;Tag&gt; tagCursor = Tag.allWithCount(mTagsBucket).execute();
 399          mTagsAdapter.changeCursor(tagCursor);
 400      }
 401  
 402      private void setSelectedTagActive() {
 403          if (mSelectedTag == null)
 404              mSelectedTag = mTagsAdapter.getDefaultItem();
 405  
 406          setTitle(mSelectedTag.name);
<abbr title=" 407          mDrawerList.setItemChecked(mTagsAdapter.getPosition(mSelectedTag) + mDrawerList.getHeaderViewsCount(), true);"> 407          mDrawerList.setItemChecked(mTagsAdapter.getPosition(mSelectedTag) + mDrawerList.getHeaderViewsCount(), truðŸ”µ</abbr>
 408      }
 409  
 410      /* The click listener for ListView in the navigation drawer */
 411      private class DrawerItemClickListener implements ListView.OnItemClickListener {
 412          @Override
 413          public void onItemClick(AdapterView&lt;?&gt; parent, View view, int position, long id) {
 414  
 415              // Adjust for header view
 416              position -= mDrawerList.getHeaderViewsCount();
 417              mSelectedTag = mTagsAdapter.getItem(position);
 418              checkEmptyListText(false);
 419              // Update checked item in navigation drawer and close it
 420              setSelectedTagActive();
 421              mDrawerLayout.closeDrawer(mNavigationView);
 422  
 423              // Disable long press on notes if we&#x27;re viewing the trash
 424              if (mDrawerList.getCheckedItemPosition() == TRASH_SELECTED_ID) {
 425                  getNoteListFragment().getListView().setLongClickable(false);
 426              } else {
 427                  getNoteListFragment().getListView().setLongClickable(true);
 428              }
 429  
 430              getNoteListFragment().refreshListFromNavSelect();
 431              if (position &gt; 1) {
 432                  AnalyticsTracker.track(
 433                          AnalyticsTracker.Stat.LIST_TAG_VIEWED,
 434                          AnalyticsTracker.CATEGORY_TAG,
 435                          &quot;selected_tag_in_navigation_drawer&quot;
 436                  );
 437              }
 438          }
 439      }
 440  
 441      public TagsAdapter.TagMenuItem getSelectedTag() {
 442          if (mSelectedTag == null) {
 443              mSelectedTag = mTagsAdapter.getDefaultItem();
 444          }
 445  
 446          return mSelectedTag;
 447      }
 448  
 449      // Enable or disable the trash action bar button depending on if there are deleted notes or not
 450      public void updateTrashMenuItem() {
 451          if (mEmptyTrashMenuItem == null || mNotesBucket == null)
 452              return;
 453  
 454          // Disable the trash icon if there are no notes trashed.
 455          Query&lt;Note&gt; query = Note.allDeleted(mNotesBucket);
 456          if (query.count() == 0) {
 457              mEmptyTrashMenuItem.getIcon().setAlpha(127);
 458              mEmptyTrashMenuItem.setEnabled(false);
 459          } else {
 460              mEmptyTrashMenuItem.getIcon().setAlpha(255);
 461              mEmptyTrashMenuItem.setEnabled(true);
 462          }
 463      }
 464  
 465      private void addEditorFragment() {
 466          FragmentManager fm = getFragmentManager();

 467          FragmentTransaction ft = fm.beginTransaction();
 468          mNoteEditorFragment = new NoteEditorFragment();
 469          ft.add(R.id.note_fragment_container, mNoteEditorFragment, TAG_NOTE_EDITOR);
 470          ft.commitAllowingStateLoss();
 471          fm.executePendingTransactions();
 472      }
 473  
 474      /**
 475       * Checks for a previously valid user that is now not authenticated
 476       *
 477       * @return true if user has invalid authorization
 478       */
 479      private boolean userAuthenticationIsInvalid() {
 480          Simplenote currentApp = (Simplenote) getApplication();
 481          Simperium simperium = currentApp.getSimperium();
 482          User user = simperium.getUser();
 483          return user.hasAccessToken() &amp;&amp; user.getStatus().equals(User.Status.NOT_AUTHORIZED);
 484      }
 485  
 486      private boolean userIsUnauthorized() {
 487          Simplenote currentApp = (Simplenote) getApplication();
 488          return currentApp.getSimperium().getUser().getStatus() == User.Status.NOT_AUTHORIZED;
 489      }
 490  
 491      private boolean userIsAuthorized() {
 492          Simplenote app = (Simplenote) getApplication();
 493          return !app.getSimperium().needsAuthorization();
 494      }
 495  
 496      public void setCurrentNote(Note note) {
 497          mCurrentNote = note;
 498      }
 499  
 500      public NoteListFragment getNoteListFragment() {
 501          return mNoteListFragment;
 502      }
 503  
 504      @SuppressWarnings(&quot;ResourceType&quot;)
 505      @Override
 506      public boolean onCreateOptionsMenu(Menu menu) {
 507          super.onCreateOptionsMenu(menu);
 508          MenuInflater inflater = getMenuInflater();
 509          inflater.inflate(R.menu.notes_list, menu);
 510  
 511          // restore the search query if on a landscape tablet
 512          String searchQuery = null;
 513          if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; mSearchView != null)
 514              searchQuery = mSearchView.getQuery().toString();
 515  
 516          mSearchMenuItem = menu.findItem(R.id.menu_search);
 517          mSearchView = (SearchView) mSearchMenuItem.getActionView();
 518  
 519          if (!TextUtils.isEmpty(searchQuery)) {
 520              mSearchView.setQuery(searchQuery, false);
 521              mSearchMenuItem.expandActionView();
 522          } else {
 523              // Workaround for setting the search placeholder text color
 524              String hintHexColor = (ThemeUtils.isLightTheme(this) ?
 525                      getString(R.color.simplenote_light_grey) :
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 526 -                    getString(R.color.simplenote_dark_text_preview)).replace(&quot;ff&quot;, &quot;&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 527 +                    getString(R.color.simplenote_text_preview)).replace(&quot;ff&quot;, &quot;&quot;);</span>
 528              mSearchView.setQueryHint(Html.fromHtml(String.format(&quot;&lt;font color=\&quot;%s\&quot;&gt;%s&lt;/font&gt;&quot;,
 529                      hintHexColor,
 530                      getString(R.string.search))));
 531          }
 532  
 533          mSearchView.setOnQueryTextListener(new SearchView.OnQueryTextListener() {
 534              @Override
 535              public boolean onQueryTextChange(String newText) {
 536                  if (mSearchMenuItem.isActionViewExpanded()) {
 537                      getNoteListFragment().searchNotes(newText);
 538                  }
 539                  return true;
 540              }
 541  
 542              @Override
 543              public boolean onQueryTextSubmit(String queryText) {
 544                  getNoteListFragment().searchNotes(queryText);
 545                  return true;
 546              }
 547  
 548          });
 549  
 550          MenuItemCompat.setOnActionExpandListener(mSearchMenuItem, new MenuItemCompat.OnActionExpandListener() {
 551              @Override
 552              public boolean onMenuItemActionExpand(MenuItem menuItem) {
 553                  checkEmptyListText(true);
 554                  if (mNoteListFragment != null) {
 555                      mNoteListFragment.setFloatingActionButtonVisible(false);
 556                  }
 557                  AnalyticsTracker.track(
 558                          AnalyticsTracker.Stat.LIST_NOTES_SEARCHED,
 559                          AnalyticsTracker.CATEGORY_NOTE,
 560                          &quot;action_bar_search_tap&quot;
 561                  );
 562                  return true;
 563              }
 564  
 565              @Override
 566              public boolean onMenuItemActionCollapse(MenuItem menuItem) {
 567                  // Show all notes again
 568                  if (mNoteListFragment != null) {
 569                      mNoteListFragment.setFloatingActionButtonVisible(true);
 570                  }
 571                  mTabletSearchQuery = &quot;&quot;;
 572                  mSearchView.setQuery(&quot;&quot;, false);
 573                  checkEmptyListText(false);
 574                  getNoteListFragment().clearSearch();
 575                  return true;
 576              }
 577          });
 578  
 579          mSearchMenuItem.setOnMenuItemClickListener(new MenuItem.OnMenuItemClickListener() {
 580              @Override
 581              public boolean onMenuItemClick(MenuItem item) {
 582                  if (!mSearchMenuItem.isActionViewExpanded())
 583                      showDetailPlaceholder();
 584                  return false;
 585              }
 586          });
 587  
 588          MenuItem trashItem = menu.findItem(R.id.menu_delete).setTitle(R.string.undelete);
 589          if (mCurrentNote != null &amp;&amp; mCurrentNote.isDeleted())
 590              trashItem.setTitle(R.string.undelete);
 591          else
 592              trashItem.setTitle(R.string.delete);
 593  
 594          if (DisplayUtils.isLargeScreenLandscape(this)) {
 595              // Restore the search query on landscape tablets
 596              if (!TextUtils.isEmpty(mTabletSearchQuery)) {
 597                  mSearchMenuItem.expandActionView();
 598                  mSearchView.setQuery(mTabletSearchQuery, false);
 599                  mSearchView.clearFocus();
 600              }
 601  
 602              if (mCurrentNote != null) {
 603                  menu.findItem(R.id.menu_share).setVisible(true);
 604                  menu.findItem(R.id.menu_view_info).setVisible(true);
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 605 +                menu.findItem(R.id.menu_history).setVisible(true);</span>


 606                  trashItem.setVisible(true);
 607              } else {
 608                  menu.findItem(R.id.menu_share).setVisible(false);
 609                  menu.findItem(R.id.menu_view_info).setVisible(false);
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 610 +                menu.findItem(R.id.menu_history).setVisible(false);</span>

 611                  trashItem.setVisible(false);
 612              }
 613              menu.findItem(R.id.menu_empty_trash).setVisible(false);
 614          } else {
 615              menu.findItem(R.id.menu_search).setVisible(true);
 616              menu.findItem(R.id.menu_share).setVisible(false);
 617              menu.findItem(R.id.menu_view_info).setVisible(false);
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 618 +            menu.findItem(R.id.menu_history).setVisible(false);</span>

 619              trashItem.setVisible(false);
 620              menu.findItem(R.id.menu_empty_trash).setVisible(false);
 621          }
 622  
 623          // Are we looking at the trash? Adjust menu accordingly.
 624          if (mDrawerList.getCheckedItemPosition() == TRASH_SELECTED_ID) {
 625              mEmptyTrashMenuItem = menu.findItem(R.id.menu_empty_trash);
 626              mEmptyTrashMenuItem.setVisible(true);
 627  
 628              updateTrashMenuItem();
 629  
 630              menu.findItem(R.id.menu_search).setVisible(false);
 631              menu.findItem(R.id.menu_share).setVisible(false);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 632 -        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 633 +            menu.findItem(R.id.menu_history).setVisible(false);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 634 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 635 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 636 +        DrawableUtils.tintMenuWithAttribute(this, menu, R.attr.actionBarTextColor);</span>
 637  
 638          return true;
 639      }
 640  
 641      @Override
 642      public boolean onOptionsItemSelected(MenuItem item) {
 643          if (mDrawerToggle.onOptionsItemSelected(item)) {
 644              return true;
 645          }
 646          switch (item.getItemId()) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 647 -            case R.id.menu_share:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 648 -                if (mCurrentNote != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 649 -                    Intent shareIntent = new Intent(android.content.Intent.ACTION_SEND);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 650 -                    shareIntent.setType(&quot;text/plain&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 651 -                    shareIntent.putExtra(android.content.Intent.EXTRA_TEXT, mCurrentNote.getContent());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 652 -                    startActivity(Intent.createChooser(shareIntent, getResources().getString(R.string.share_note)));"> 652 -                    startActivity(Intent.createChooser(shareIntent, getResources().getString(R.string.share_note))ðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 653 -                    AnalyticsTracker.track(</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 654 -                            AnalyticsTracker.Stat.EDITOR_NOTE_CONTENT_SHARED,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 655 -                            AnalyticsTracker.CATEGORY_NOTE,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 656 -                            &quot;action_bar_share_button&quot;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 657 -                    );</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 658 -                }</span>









































<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 659 -                return true;</span>
 660              case R.id.menu_delete:
 661                  if (mNoteEditorFragment != null) {
 662                      if (mCurrentNote != null) {
 663                          mCurrentNote.setDeleted(!mCurrentNote.isDeleted());
 664                          mCurrentNote.setModificationDate(Calendar.getInstance());
 665                          mCurrentNote.save();
 666  
 667                          if (mCurrentNote.isDeleted()) {
 668                              List&lt;String&gt; deletedNoteIds = new ArrayList&lt;&gt;();
 669                              deletedNoteIds.add(mCurrentNote.getSimperiumKey());
 670                              mUndoBarController.setDeletedNoteIds(deletedNoteIds);
 671                              mUndoBarController.showUndoBar(getUndoView(), getString(R.string.note_deleted), null);
 672                              AnalyticsTracker.track(
 673                                      AnalyticsTracker.Stat.LIST_NOTE_DELETED,
 674                                      AnalyticsTracker.CATEGORY_NOTE,
 675                                      &quot;overflow_menu&quot;
 676                              );
 677                          } else {
 678                              AnalyticsTracker.track(
 679                                      AnalyticsTracker.Stat.EDITOR_NOTE_RESTORED,
 680                                      AnalyticsTracker.CATEGORY_NOTE,
 681                                      &quot;overflow_menu&quot;
 682                              );
 683                          }
 684                          showDetailPlaceholder();
 685                      }
 686                      NoteListFragment fragment = getNoteListFragment();
 687                      if (fragment != null) {
 688                          fragment.getPrefs();
 689                          fragment.refreshList();
 690                      }
 691                  }
 692                  return true;
 693              case R.id.menu_empty_trash:
 694                  AlertDialog.Builder alert = new AlertDialog.Builder(this);
 695  
 696                  alert.setTitle(R.string.empty_trash);
 697                  alert.setMessage(R.string.confirm_empty_trash);
 698                  alert.setPositiveButton(R.string.yes, new DialogInterface.OnClickListener() {
 699                      public void onClick(DialogInterface dialog, int whichButton) {
 700                          new emptyTrashTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR);
 701                          AnalyticsTracker.track(
 702                                  AnalyticsTracker.Stat.LIST_TRASH_EMPTIED,
 703                                  AnalyticsTracker.CATEGORY_NOTE,
 704                                  &quot;overflow_menu&quot;
 705                          );
 706                      }
 707                  });
 708                  alert.setNegativeButton(R.string.no, new DialogInterface.OnClickListener() {
 709                      public void onClick(DialogInterface dialog, int whichButton) {
 710                          // Do nothing, just closing the dialog
 711                      }
 712                  });
 713                  alert.show();
 714                  return true;
 715              case android.R.id.home:
 716                  invalidateOptionsMenu();
 717                  return true;
 718              default:
 719                  return super.onOptionsItemSelected(item);
 720          }
 721      }
 722  

























 723      /**
 724       * Callback method from {@link NoteListFragment.Callbacks} indicating that
 725       * the item with the given ID was selected. Used for tablets only.
 726       */
 727      @Override
 728      public void onNoteSelected(String noteID, int position, boolean isNew, String matchOffsets) {

 729          if (!DisplayUtils.isLargeScreenLandscape(this)) {
 730              // Launch the editor activity
 731              Bundle arguments = new Bundle();
 732              arguments.putString(NoteEditorFragment.ARG_ITEM_ID, noteID);
 733              arguments.putBoolean(NoteEditorFragment.ARG_NEW_NOTE, isNew);

 734  
 735              if (matchOffsets != null)
 736                  arguments.putString(NoteEditorFragment.ARG_MATCH_OFFSETS, matchOffsets);
 737  
 738              Intent editNoteIntent = new Intent(this, NoteEditorActivity.class);
 739              editNoteIntent.putExtras(arguments);
 740              startActivityForResult(editNoteIntent, Simplenote.INTENT_EDIT_NOTE);
 741          } else {
 742              mNoteEditorFragment.setIsNewNote(isNew);
 743              mNoteEditorFragment.setNote(noteID, matchOffsets);
 744              getNoteListFragment().setNoteSelected(noteID);

 745              if (mSearchView != null &amp;&amp; mSearchView.getQuery() != null) {
 746                  mTabletSearchQuery = mSearchView.getQuery().toString();
 747              }








 748              invalidateOptionsMenu();
 749          }
 750  
 751          AnalyticsTracker.track(
 752                  AnalyticsTracker.Stat.LIST_NOTE_OPENED,
 753                  AnalyticsTracker.CATEGORY_NOTE,
 754                  &quot;note_list_row_tap&quot;
 755          );
 756      }
 757  
 758      @Override
 759      public void onUserCreated(User user) {
 760          // New account created
 761          AnalyticsTracker.track(
 762                  AnalyticsTracker.Stat.USER_ACCOUNT_CREATED,
 763                  AnalyticsTracker.CATEGORY_USER,
 764                  &quot;account_created_from_login_activity&quot;
 765          );
 766      }
 767  
 768      public void onUserStatusChange(User.Status status) {
 769          switch (status) {
 770              // successfully used access token to connect to simperium bucket
 771              case AUTHORIZED:
 772                  runOnUiThread(new Runnable() {
 773                      @Override
 774                      public void run() {
 775                          if (!mNotesBucket.hasChangeVersion()) {
 776                              setToolbarProgressVisibility(true);
 777                          }
 778                      }
 779                  });
 780                  break;
 781  
 782              // NOT_AUTHORIZED means we attempted to connect but the token was not valid
 783              case NOT_AUTHORIZED:
 784                  runOnUiThread(new Runnable() {
 785                      @Override
 786                      public void run() {
 787                          startLoginActivity(true);
 788                      }
 789                  });
 790                  break;
 791  
<abbr title=" 792              // Default starting state of User, don&#x27;t do anything we allow use of app while not signed in so don&#x27;t do anything"> 792              // Default starting state of User, don&#x27;t do anything we allow use of app while not signed in so don&#x27;t ðŸ”µ</abbr>
 793              case UNKNOWN:
 794                  break;
 795          }
 796      }
 797  
 798      private void setToolbarProgressVisibility(boolean isVisible) {
 799          if (getSupportActionBar() != null) {
 800              getSupportActionBar().setDisplayShowCustomEnabled(isVisible);
 801          }
 802      }
 803  
 804      public void startLoginActivity(boolean signInFirst) {
 805          Intent loginIntent = new Intent(this, LoginActivity.class);
 806          if (signInFirst)
 807              loginIntent.putExtra(LoginActivity.EXTRA_SIGN_IN_FIRST, true);
 808          startActivityForResult(loginIntent, Simperium.SIGNUP_SIGNIN_REQUEST);
 809      }
 810  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 811 +    @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 812 +    public void recreate() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 813 +        Handler handler = new Handler();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 814 +        handler.post(new Runnable()</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 815 +        {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 816 +            @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 817 +            public void run()</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 818 +            {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 819 +                if (Build.VERSION.SDK_INT &lt; Build.VERSION_CODES.HONEYCOMB)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 820 +                {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 821 +                    NotesActivity.this.finish();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 822 +                    NotesActivity.this.startActivity(NotesActivity.this.getIntent());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 823 +                } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 824 +                    NotesActivity.super.recreate();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 825 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 826 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 827 +        });</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 828 +    }</span>
 829  
 830      @Override
 831      protected void onActivityResult(int requestCode, int resultCode, Intent data) {
 832          super.onActivityResult(requestCode, resultCode, data);
 833          switch (requestCode) {
 834              case Simplenote.INTENT_PREFERENCES:
 835                  if (ThemeUtils.themeWasChanged(data)) {
 836                      // Restart this activity to apply the new theme
 837                      recreate();
 838                      break;
 839                  }
<abbr title=" 840                  // nbradbury - refresh note list when user returns from preferences (in case they changed anything)"> 840                  // nbradbury - refresh note list when user returns from preferences (in case they changed anythingðŸ”µ</abbr>
 841                  invalidateOptionsMenu();
 842                  NoteListFragment fragment = getNoteListFragment();
 843                  if (fragment != null) {
 844                      fragment.getPrefs();
 845                      fragment.refreshList();
 846                  }
 847                  break;
 848              case Simplenote.INTENT_EDIT_NOTE:
 849                  if (resultCode == RESULT_OK &amp;&amp; data != null &amp;&amp; data.hasExtra(Simplenote.DELETED_NOTE_ID)) {
 850                      String noteId = data.getStringExtra(Simplenote.DELETED_NOTE_ID);
 851                      if (noteId != null) {
 852                          List&lt;String&gt; deletedNoteIds = new ArrayList&lt;&gt;();
 853                          deletedNoteIds.add(noteId);
 854                          mUndoBarController.setDeletedNoteIds(deletedNoteIds);
 855                          mUndoBarController.showUndoBar(getUndoView(), getString(R.string.note_deleted), null);
 856                      }
 857                  }
 858                  break;
 859              case Simperium.SIGNUP_SIGNIN_REQUEST:
 860                  invalidateOptionsMenu();
 861  
 862                  Simplenote app = (Simplenote)getApplication();
 863                  AnalyticsTracker.refreshMetadata(app.getSimperium().getUser().getEmail());
 864  
 865                  AnalyticsTracker.track(
 866                          AnalyticsTracker.Stat.USER_SIGNED_IN,
 867                          AnalyticsTracker.CATEGORY_USER,
 868                          &quot;signed_in_from_login_activity&quot;
 869                  );
 870  
 871                  if (resultCode == Activity.RESULT_CANCELED &amp;&amp; userAuthenticationIsInvalid()) {
 872                      finish();
 873                  }
 874  
 875                  break;
 876          }
 877      }
 878  
 879      @Override
 880      public void onUndo() {
 881          if (mUndoBarController == null) return;
 882  
 883          List&lt;String&gt; deletedNoteIds = mUndoBarController.getDeletedNoteIds();
 884          if (deletedNoteIds != null) {
 885              for (int i = 0; i &lt; deletedNoteIds.size(); i++) {
 886                  Note deletedNote;
 887                  try {
 888                      deletedNote = mNotesBucket.get(deletedNoteIds.get(i));
 889                  } catch (BucketObjectMissingException e) {
 890                      return;
 891                  }
 892                  if (deletedNote != null) {
 893                      deletedNote.setDeleted(false);
 894                      deletedNote.setModificationDate(Calendar.getInstance());
 895                      deletedNote.save();
 896                      NoteListFragment fragment = getNoteListFragment();
 897                      if (fragment != null) {
 898                          fragment.getPrefs();
 899                          fragment.refreshList();
 900                      }
 901                  }
 902              }
 903          }
 904      }
 905  
 906      @Override
 907      protected void onPostCreate(Bundle savedInstanceState) {
 908          super.onPostCreate(savedInstanceState);
 909          // Sync the toggle state after onRestoreInstanceState has occurred.
 910          mDrawerToggle.syncState();
 911      }
 912  
 913      @Override
 914      public void onConfigurationChanged(Configuration newConfig) {
 915          super.onConfigurationChanged(newConfig);
 916  
 917          mDrawerToggle.onConfigurationChanged(newConfig);
 918  
 919          if (DisplayUtils.isLargeScreen(this)) {


 920              if (newConfig.orientation == Configuration.ORIENTATION_LANDSCAPE) {
 921                  // Add the editor fragment
 922                  addEditorFragment();
 923                  if (mNoteListFragment != null) {
 924                      mNoteListFragment.setActivateOnItemClick(true);
 925                      mNoteListFragment.setDividerVisible(true);
 926                  }
 927                  // Select the current note on a tablet
 928                  if (mCurrentNote != null)
 929                      onNoteSelected(mCurrentNote.getSimperiumKey(), 0, false, null);

 930                  else {
 931                      mNoteEditorFragment.setPlaceholderVisible(true);
 932                      mNoteListFragment.getListView().clearChoices();
 933                  }
 934                  invalidateOptionsMenu();
<abbr title=" 935              } else if (newConfig.orientation == Configuration.ORIENTATION_PORTRAIT &amp;&amp; mNoteEditorFragment != null) {"> 935              } else if (newConfig.orientation == Configuration.ORIENTATION_PORTRAIT &amp;&amp; mNoteEditorFragment != null)ðŸ”µ</abbr>
 936                  // Remove the editor fragment when rotating back to portrait
 937                  mCurrentNote = null;
 938                  if (mNoteListFragment != null) {
 939                      mNoteListFragment.setActivateOnItemClick(false);
 940                      mNoteListFragment.setDividerVisible(false);
 941                      mNoteListFragment.setActivatedPosition(ListView.INVALID_POSITION);
 942                      mNoteListFragment.refreshList();
 943                  }
 944                  FragmentManager fm = getFragmentManager();

 945                  FragmentTransaction ft = fm.beginTransaction();
 946                  ft.remove(mNoteEditorFragment);
 947                  mNoteEditorFragment = null;
 948                  ft.commitAllowingStateLoss();
 949                  fm.executePendingTransactions();
 950                  invalidateOptionsMenu();
 951              }
 952          }
 953      }
 954  
 955      public void checkEmptyListText(boolean isSearch) {
 956          if (isSearch) {
<abbr title=" 957              getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_found) + &quot;&lt;/strong&gt;&quot;);"> 957              getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_found) + &quot;&lt;/strong&gt;ðŸ”µ</abbr>
 958              getNoteListFragment().setEmptyListViewClickable(false);
 959          } else if (mDrawerList.getCheckedItemPosition() == TRASH_SELECTED_ID) {
<abbr title=" 960              getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.trash_is_empty) + &quot;&lt;/strong&gt;&quot;);"> 960              getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.trash_is_empty) + &quot;&lt;/strong&gt;ðŸ”µ</abbr>
 961              AnalyticsTracker.track(
 962                      AnalyticsTracker.Stat.LIST_TRASH_VIEWED,
 963                      AnalyticsTracker.CATEGORY_NOTE,
 964                      &quot;trash_filter_selected&quot;
 965              );
 966              getNoteListFragment().setEmptyListViewClickable(false);
 967          } else {
<abbr title=" 968              getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here) + &quot;&lt;/strong&gt;&lt;br /&gt;&quot; + String.format(getString(R.string.why_not_create_one), &quot;&lt;u&gt;&quot;, &quot;&lt;/u&gt;&quot;));"> 968              getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here) + &quot;&lt;/strong&gt;&lt;ðŸ”µ</abbr>
 969              getNoteListFragment().setEmptyListViewClickable(true);
 970          }
 971      }
 972  
 973      public void showDetailPlaceholder() {
 974          if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; mNoteEditorFragment != null) {
 975              mCurrentNote = null;
 976              mNoteEditorFragment.setPlaceholderVisible(true);



 977          }
 978      }
 979  
 980      public void stopListeningToNotesBucket() {
 981          mNotesBucket.removeOnNetworkChangeListener(this);
 982          mNotesBucket.removeOnSaveObjectListener(this);
 983          mNotesBucket.removeOnDeleteObjectListener(this);
 984      }
 985  
 986      // Returns the appropriate view to show the undo bar within
 987      private View getUndoView() {
 988          View undoView = mFragmentsContainer;
 989          if (!DisplayUtils.isLargeScreenLandscape(this) &amp;&amp;
 990                  getNoteListFragment() != null &amp;&amp;
 991                  getNoteListFragment().getRootView() != null) {
 992              undoView = getNoteListFragment().getRootView();
 993          }
 994  
 995          return undoView;
 996      }
 997  
 998      public void showUndoBarWithNoteIds(List&lt;String&gt; noteIds) {
 999          if (mUndoBarController != null) {
1000              mUndoBarController.setDeletedNoteIds(noteIds);
1001              mUndoBarController.showUndoBar(
1002                      getUndoView(),
1003                      getResources().getQuantityString(R.plurals.trashed_notes, noteIds.size(), noteIds.size()),
1004                      null
1005              );
1006          }
1007      }
1008  
1009      private class emptyTrashTask extends AsyncTask&lt;Void, Void, Void&gt; {
1010  
1011          @Override
1012          protected Void doInBackground(Void... voids) {
1013              if (mNotesBucket == null) return null;
1014  
1015              Query&lt;Note&gt; query = Note.allDeleted(mNotesBucket);
1016              Bucket.ObjectCursor c = query.execute();
1017              while (c.moveToNext()) {
1018                  c.getObject().delete();
1019              }
1020  
1021              return null;
1022          }
1023  
1024          @Override
1025          protected void onPostExecute(Void nada) {
1026              showDetailPlaceholder();
1027          }
1028      }
1029  
1030  
1031      /* Simperium Bucket Listeners */
1032      // received a change from the network, refresh the list
1033      @Override
1034      public void onNetworkChange(Bucket&lt;Note&gt; bucket, final Bucket.ChangeType type, String key) {
1035          runOnUiThread(new Runnable() {
1036              @Override
1037              public void run() {
1038                  if (type == Bucket.ChangeType.INDEX) {
1039                      setToolbarProgressVisibility(false);
1040                  }
1041                  mNoteListFragment.refreshList();
1042              }
1043          });
1044      }
1045  
1046      @Override
1047      public void onSaveObject(Bucket&lt;Note&gt; bucket, Note object) {
1048          runOnUiThread(new Runnable() {
1049              @Override
1050              public void run() {
1051                  mNoteListFragment.refreshList();
1052              }
1053          });
1054      }
1055  
1056      @Override
1057      public void onDeleteObject(Bucket&lt;Note&gt; bucket, Note object) {
1058          runOnUiThread(new Runnable() {
1059              @Override
1060              public void run() {
1061                  mNoteListFragment.refreshList();
1062              }
1063          });
1064      }
1065  
1066      @Override
1067      public void onBeforeUpdateObject(Bucket&lt;Note&gt; bucket, Note note) {
1068          // noop, NoteEditorFragment will handle this
1069      }
1070  
1071      // Tags bucket listener
1072      private Bucket.Listener&lt;Tag&gt; mTagsMenuUpdater = new Bucket.Listener&lt;Tag&gt;() {
1073          void updateNavigationDrawer() {
1074              runOnUiThread(new Runnable() {
1075                  public void run() {
1076                      updateNavigationDrawerItems();
1077                  }
1078              });
1079          }
1080  
1081          @Override
1082          public void onSaveObject(Bucket&lt;Tag&gt; bucket, Tag tag) {
1083              updateNavigationDrawer();
1084          }
1085  
1086          @Override
1087          public void onDeleteObject(Bucket&lt;Tag&gt; bucket, Tag tag) {
1088              updateNavigationDrawer();
1089          }
1090  
1091          @Override
1092          public void onNetworkChange(Bucket&lt;Tag&gt; bucket, Bucket.ChangeType type, String key) {
1093              updateNavigationDrawer();
1094          }
1095  
1096          @Override
1097          public void onBeforeUpdateObject(Bucket&lt;Tag&gt; bucket, Tag object) {
1098              // noop
1099          }
1100      };
1101  }</pre></td>
                            <td><pre>   1  package com.automattic.simplenote;
   2  
   3  import android.app.Activity;
   4  import android.app.AlertDialog;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   5 -import android.app.FragmentManager;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   6 -import android.app.FragmentTransaction;</span>
   7  import android.content.DialogInterface;
   8  import android.content.Intent;
   9  import android.content.SharedPreferences;
  10  import android.content.res.Configuration;
  11  import android.os.AsyncTask;
  12  import android.os.Build;
  13  import android.os.Bundle;

  14  import android.preference.PreferenceManager;
  15  import android.support.design.widget.NavigationView;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  16 +import android.support.v4.app.FragmentManager;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  17 +import android.support.v4.app.FragmentTransaction;</span>
  18  import android.support.v4.view.GravityCompat;
  19  import android.support.v4.view.MenuItemCompat;
  20  import android.support.v4.widget.DrawerLayout;
  21  import android.support.v7.app.ActionBar;
  22  import android.support.v7.app.ActionBarDrawerToggle;
  23  import android.support.v7.app.AppCompatActivity;
  24  import android.support.v7.widget.SearchView;
  25  import android.support.v7.widget.Toolbar;
  26  import android.text.Html;
  27  import android.text.Spannable;
  28  import android.text.SpannableString;
  29  import android.text.TextUtils;
  30  import android.view.Menu;
  31  import android.view.MenuInflater;
  32  import android.view.MenuItem;
  33  import android.view.View;
  34  import android.view.WindowManager;
  35  import android.widget.AdapterView;
  36  import android.widget.ListView;
  37  import android.widget.ProgressBar;
  38  import android.widget.TextView;
  39  
  40  import com.automattic.simplenote.analytics.AnalyticsTracker;
  41  import com.automattic.simplenote.models.Note;
  42  import com.automattic.simplenote.models.Tag;
  43  import com.automattic.simplenote.utils.AniUtils;
  44  import com.automattic.simplenote.utils.DisplayUtils;

  45  import com.automattic.simplenote.utils.PrefUtils;
  46  import com.automattic.simplenote.utils.StrUtils;
  47  import com.automattic.simplenote.utils.TagsAdapter;
  48  import com.automattic.simplenote.utils.ThemeUtils;
  49  import com.automattic.simplenote.utils.UndoBarController;
  50  import com.automattic.simplenote.widgets.TypefaceSpan;
  51  import com.simperium.Simperium;
  52  import com.simperium.android.LoginActivity;
  53  import com.simperium.client.Bucket;
  54  import com.simperium.client.BucketObjectMissingException;
  55  import com.simperium.client.BucketObjectNameInvalid;
  56  import com.simperium.client.Query;
  57  import com.simperium.client.User;
  58  
  59  import org.wordpress.passcodelock.AppLockManager;
  60  
  61  import java.util.ArrayList;
  62  import java.util.Calendar;
  63  import java.util.List;
  64  
  65  public class NotesActivity extends AppCompatActivity implements
<abbr title="  66          NoteListFragment.Callbacks, User.StatusChangeListener, Simperium.OnUserCreatedListener, UndoBarController.UndoListener,">  66          NoteListFragment.Callbacks, User.StatusChangeListener, Simperium.OnUserCreatedListener, UndoBarController.ðŸ”µ</abbr>
  67          Bucket.Listener&lt;Note&gt; {
  68  
  69      public static String TAG_NOTE_LIST = &quot;noteList&quot;;
  70      public static String TAG_NOTE_EDITOR = &quot;noteEditor&quot;;
  71      private int TRASH_SELECTED_ID = 2;
  72  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  73 +    private boolean mIsMarkdownEnabledGlobal;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  74 +    private boolean mIsShowingMarkdown;</span>
  75      private boolean mShouldSelectNewNote;
  76      private String mTabletSearchQuery;
  77      private UndoBarController mUndoBarController;
  78      private View mFragmentsContainer;
  79      private View mWelcomeView;
  80      private SearchView mSearchView;
  81      private MenuItem mSearchMenuItem;
  82      private NoteListFragment mNoteListFragment;
  83      private NoteEditorFragment mNoteEditorFragment;
  84      private Note mCurrentNote;
  85      protected Bucket&lt;Note&gt; mNotesBucket;
  86      protected Bucket&lt;Tag&gt; mTagsBucket;
  87      private MenuItem mEmptyTrashMenuItem;
  88  
  89      // Menu drawer
  90      private DrawerLayout mDrawerLayout;
  91      private ListView mDrawerList;
  92      private NavigationView mNavigationView;
  93      private ActionBarDrawerToggle mDrawerToggle;
  94      private TagsAdapter mTagsAdapter;
  95      private TagsAdapter.TagMenuItem mSelectedTag;
  96  
  97      @Override
  98      protected void onCreate(Bundle savedInstanceState) {
  99          // On lollipop, configure the translucent status bar
 100          if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.LOLLIPOP) {
 101              getWindow().addFlags(WindowManager.LayoutParams.FLAG_DRAWS_SYSTEM_BAR_BACKGROUNDS);
 102              getWindow().setStatusBarColor(getResources().getColor(R.color.transparent));

 103          }
 104  
 105          ThemeUtils.setTheme(this);
 106          super.onCreate(savedInstanceState);
 107          setContentView(R.layout.activity_notes);
 108  
 109          mFragmentsContainer = findViewById(R.id.note_fragment_container);
 110  
 111          Simplenote currentApp = (Simplenote) getApplication();
 112          if (mNotesBucket == null) {
 113              mNotesBucket = currentApp.getNotesBucket();
 114          }
 115  
 116          if (mTagsBucket == null) {
 117              mTagsBucket = currentApp.getTagsBucket();
 118          }
 119  
 120          Toolbar toolbar = (Toolbar) findViewById(R.id.toolbar);
 121          setSupportActionBar(toolbar);
 122          configureNavigationDrawer(toolbar);
 123  
 124          if (savedInstanceState == null) {
 125              mNoteListFragment = new NoteListFragment();
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 126 -            FragmentTransaction fragmentTransaction = getFragmentManager().beginTransaction();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 127 +            FragmentTransaction fragmentTransaction = getSupportFragmentManager().beginTransaction();</span>
 128              fragmentTransaction.add(R.id.note_fragment_container, mNoteListFragment, TAG_NOTE_LIST);
 129              fragmentTransaction.commit();
 130          } else {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 131 -            mNoteListFragment = (NoteListFragment) getFragmentManager().findFragmentByTag(TAG_NOTE_LIST);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 132 +            mNoteListFragment = (NoteListFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_LIST);</span>
 133          }
 134  
 135          if (DisplayUtils.isLargeScreen(this)) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 136 -            if (getFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR) != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 137 -                mNoteEditorFragment = (NoteEditorFragment) getFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR);"> 137 -                mNoteEditorFragment = (NoteEditorFragment) getFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR)ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 138 +            if (getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR) != null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 139 +                mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR);"> 139 +                mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_ðŸ”µ</abbr></span>
 140              } else if (DisplayUtils.isLandscape(this)) {
 141                  addEditorFragment();
 142              }
 143          }
 144  
 145          // enable ActionBar app icon to behave as action to toggle nav drawer
 146          ActionBar actionBar = getSupportActionBar();
 147          if (actionBar != null) {
 148              actionBar.setDisplayHomeAsUpEnabled(true);
 149              actionBar.setHomeButtonEnabled(true);
 150  
 151              // Add loading indicator to show when indexing
<abbr title=" 152              ProgressBar progressBar = (ProgressBar) getLayoutInflater().inflate(R.layout.progressbar_toolbar, null);"> 152              ProgressBar progressBar = (ProgressBar) getLayoutInflater().inflate(R.layout.progressbar_toolbar, nullðŸ”µ</abbr>
 153              actionBar.setDisplayShowCustomEnabled(true);
 154              actionBar.setCustomView(progressBar);
 155              setToolbarProgressVisibility(false);
 156          }
 157  
 158          mUndoBarController = new UndoBarController(this);
 159  
 160          // Creates &#x27;Welcome&#x27; note
 161          checkForFirstLaunch();
 162  
 163          checkForSharedContent();
 164  
 165          currentApp.getSimperium().setOnUserCreatedListener(this);
 166          currentApp.getSimperium().setUserStatusChangeListener(this);
 167      }
 168  
 169      @Override
 170      protected void onResume() {
 171          super.onResume();
 172  
 173          // Ensure user has valid authorization
 174          if (userAuthenticationIsInvalid()) {
 175              startLoginActivity(true);
 176          }
 177  
 178          mNotesBucket.start();
 179          mTagsBucket.start();
 180  
 181          mNotesBucket.addOnNetworkChangeListener(this);
 182          mNotesBucket.addOnSaveObjectListener(this);
 183          mNotesBucket.addOnDeleteObjectListener(this);
 184          mTagsBucket.addListener(mTagsMenuUpdater);
 185  
 186          setWelcomeViewVisibility();
 187          updateNavigationDrawerItems();
 188  
 189          // if the user is not authenticated and the tag doesn&#x27;t exist revert to default drawer selection
 190          if (userIsUnauthorized()) {
 191              if (-1 == mTagsAdapter.getPosition(mSelectedTag)) {
 192                  mSelectedTag = null;
 193                  mDrawerList.setSelection(TagsAdapter.DEFAULT_ITEM_POSITION);
 194              }
 195          }
 196  
 197          setSelectedTagActive();
 198  
 199          if (mCurrentNote != null &amp;&amp; mShouldSelectNewNote) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 200 -            onNoteSelected(mCurrentNote.getSimperiumKey(), 0, true, null);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 201 +            onNoteSelected(mCurrentNote.getSimperiumKey(), 0, true, null, mCurrentNote.isMarkdownEnabled());</span>
 202              mShouldSelectNewNote = false;
 203          }
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 204 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 205 +        mIsMarkdownEnabledGlobal = PrefUtils.getBoolPref(NotesActivity.this, PrefUtils.PREF_MARKDOWN_ENABLED, false);"> 205 +        mIsMarkdownEnabledGlobal = PrefUtils.getBoolPref(NotesActivity.this, PrefUtils.PREF_MARKDOWN_ENABLED, falsðŸ”µ</abbr></span>
 206      }
 207  
 208      @Override
 209      protected void onPause() {
 210          super.onPause();
 211  
 212          mTagsBucket.removeListener(mTagsMenuUpdater);
 213  
 214          mNotesBucket.removeOnNetworkChangeListener(this);
 215          mNotesBucket.removeOnSaveObjectListener(this);
 216          mNotesBucket.removeOnDeleteObjectListener(this);
 217      }
 218  
 219      @Override
 220      public void setTitle(CharSequence title) {
 221          if (title == null) {
 222              title = &quot;&quot;;
 223          }
 224  
 225          setTitleWithCustomFont(title);
 226      }
 227  
 228      @Override
 229      public void onBackPressed() {
 230          if (mDrawerLayout != null &amp;&amp; mDrawerLayout.isDrawerOpen(GravityCompat.START)) {
 231              mDrawerLayout.closeDrawer(GravityCompat.START);
 232          } else {
 233              super.onBackPressed();
 234          }
 235      }
 236  
 237      private void setTitleWithCustomFont(CharSequence title) {
 238          if (getSupportActionBar() == null) return;
 239  
 240          // LG devices running 4.1 can&#x27;t handle a custom font in the action bar title
 241          if ((!TextUtils.isEmpty(Build.BRAND) &amp;&amp; Build.BRAND.toLowerCase().contains(&quot;lge&quot;))
 242                  &amp;&amp; Build.VERSION.SDK_INT &lt;= Build.VERSION_CODES.JELLY_BEAN) {
 243              getSupportActionBar().setTitle(title);
 244              return;
 245          }
 246  
 247          SpannableString s = new SpannableString(title);
 248          s.setSpan(new TypefaceSpan(this), 0, s.length(), Spannable.SPAN_EXCLUSIVE_EXCLUSIVE);
 249          getSupportActionBar().setTitle(s);
 250      }
 251  
 252      private void configureNavigationDrawer(Toolbar toolbar) {
 253          mDrawerLayout = (DrawerLayout) findViewById(R.id.drawer_layout);
 254          mDrawerLayout.setDrawerShadow(R.drawable.drawer_shadow, GravityCompat.START);
 255          mNavigationView = (NavigationView) findViewById(R.id.navigation_view);
 256          mDrawerList = (ListView) findViewById(R.id.drawer_list);
 257  
 258          // Configure welcome view in the nav drawer
 259          mWelcomeView = mDrawerLayout.findViewById(R.id.welcome_view);
 260          TextView welcomeSignInButton = (TextView)mDrawerLayout.findViewById(R.id.welcome_sign_in_button);
 261          welcomeSignInButton.setText(StrUtils.setTextToUpperCaseAndBold(getString(R.string.sign_in)));
 262          welcomeSignInButton.setOnClickListener(new View.OnClickListener() {
 263              @Override
 264              public void onClick(View v) {
 265                  startLoginActivity(true);
 266              }
 267          });
 268  
 269          TextView welcomeCloseButton = (TextView)mDrawerLayout.findViewById(R.id.welcome_close);
 270          welcomeCloseButton.setText(StrUtils.setTextToUpperCaseAndBold(getString(R.string.dismiss)));
 271                  welcomeCloseButton.setOnClickListener(new View.OnClickListener() {
 272                      @Override
 273                      public void onClick(View v) {
 274                          removeWelcomeView();
 275                      }
 276                  });
 277  
 278          if (mDrawerList.getHeaderViewsCount() == 0) {
 279              View headerView = getLayoutInflater().inflate(R.layout.nav_drawer_header, null);
 280              mDrawerList.addHeaderView(headerView, null, false);
 281          }
 282  
 283          View settingsButton = findViewById(R.id.nav_settings);
 284          settingsButton.setOnClickListener(new View.OnClickListener() {
 285              @Override
 286              public void onClick(View v) {
 287                  Intent i = new Intent(NotesActivity.this, PreferencesActivity.class);
 288                  startActivityForResult(i, Simplenote.INTENT_PREFERENCES);
 289              }
 290          });
 291  
 292          mNavigationView.getLayoutParams().width = ThemeUtils.getOptimalDrawerWidth(this);
 293          mTagsAdapter = new TagsAdapter(this, mNotesBucket, mDrawerList.getHeaderViewsCount());
 294          mDrawerList.setAdapter(mTagsAdapter);
 295          // Set the list&#x27;s click listener
 296          mDrawerList.setOnItemClickListener(new DrawerItemClickListener());
 297  
 298          if (mSelectedTag == null)
 299              mSelectedTag = mTagsAdapter.getDefaultItem();
 300  
 301          mDrawerToggle = new ActionBarDrawerToggle(this, mDrawerLayout, toolbar, R.string.open_drawer,
 302                  R.string.close_drawer) {
 303              public void onDrawerClosed(View view) {
 304                  supportInvalidateOptionsMenu();
 305              }
 306  
 307              public void onDrawerOpened(View drawerView) {
 308                  // noop
 309              }
 310          };
 311  
 312          mDrawerLayout.setDrawerListener(mDrawerToggle);

 313      }
 314  
 315      private void setWelcomeViewVisibility() {
 316          if (mWelcomeView == null) return;
 317          // Hide welcome view if user is signed in or closed the welcome view
 318          if (userIsAuthorized() || PrefUtils.getBoolPref(this, PrefUtils.PREF_APP_TRIAL)) {
 319              mWelcomeView.setVisibility(View.GONE);
 320          } else {
 321              mWelcomeView.setVisibility(View.VISIBLE);
 322              mWelcomeView.setAlpha(1.0f);
 323          }
 324      }
 325  
 326      private void removeWelcomeView() {
 327          if (mWelcomeView == null) return;
 328  
 329          AniUtils.swipeOutToLeft(mWelcomeView);
 330  
 331          // Set preference so the welcome view never shows again
 332          SharedPreferences preferences = PreferenceManager.getDefaultSharedPreferences(this);
 333          SharedPreferences.Editor editor = preferences.edit();
 334          editor.putBoolean(PrefUtils.PREF_APP_TRIAL, true);
 335          editor.apply();
 336      }
 337  
 338      private void checkForFirstLaunch() {
 339          if (PrefUtils.getBoolPref(this, PrefUtils.PREF_FIRST_LAUNCH, true)) {
 340              // Create the welcome note
 341              try {
 342                  Note welcomeNote = mNotesBucket.newObject(&quot;welcome-android&quot;);
 343                  welcomeNote.setCreationDate(Calendar.getInstance());
 344                  welcomeNote.setModificationDate(welcomeNote.getCreationDate());
 345                  welcomeNote.setContent(getString(R.string.welcome_note));
 346                  welcomeNote.getTitle();
 347                  welcomeNote.save();
 348              } catch (BucketObjectNameInvalid e) {
 349                  // this won&#x27;t happen because welcome-android is a valid name
 350              }
 351  
 352              SharedPreferences preferences = PreferenceManager.getDefaultSharedPreferences(this);
 353              SharedPreferences.Editor editor = preferences.edit();
 354              editor.putBoolean(PrefUtils.PREF_FIRST_LAUNCH, false);
 355              editor.apply();
 356          }
 357      }
 358  
 359      private void checkForSharedContent() {
 360          if (getIntent().hasExtra(Intent.EXTRA_TEXT)) {
 361              // Check share action
 362              Intent intent = getIntent();
 363              String subject = intent.getStringExtra(Intent.EXTRA_SUBJECT);
 364              String text = intent.getStringExtra(Intent.EXTRA_TEXT);
 365  
 366              // Don&#x27;t add the &#x27;Note to self&#x27; subject or open the note if this was shared from a voice search
 367              String intentAction = StrUtils.notNullStr(intent.getAction());
 368              boolean isVoiceShare = intentAction.equals(&quot;com.google.android.gm.action.AUTO_SEND&quot;);
 369              if (!TextUtils.isEmpty(text)) {
 370                  if (!TextUtils.isEmpty(subject) &amp;&amp; !isVoiceShare) {
 371                      text = subject + &quot;\n\n&quot; + text;
 372                  }
 373                  Note note = mNotesBucket.newObject();
 374                  note.setCreationDate(Calendar.getInstance());
 375                  note.setModificationDate(note.getCreationDate());
 376                  note.setContent(text);
 377                  note.save();
 378                  setCurrentNote(note);
 379  
 380                  if (!isVoiceShare) {
 381                      mShouldSelectNewNote = true;
 382                  }
 383                  AnalyticsTracker.track(
 384                          AnalyticsTracker.Stat.LIST_NOTE_CREATED,
 385                          AnalyticsTracker.CATEGORY_NOTE,
 386                          &quot;external_share&quot;
 387                  );
 388  
 389                  if (!DisplayUtils.isLargeScreenLandscape(this)) {
 390                      // Disable the lock screen when sharing content and opening NoteEditorActivity
 391                      // Lock screen activities are enabled again in NoteEditorActivity.onPause()
 392                      if (AppLockManager.getInstance().isAppLockFeatureEnabled()) {
 393                          AppLockManager.getInstance().getCurrentAppLock().setDisabledActivities(
 394                                  new String[]{&quot;com.automattic.simplenote.NotesActivity&quot;,
 395                                  &quot;com.automattic.simplenote.NoteEditorActivity&quot;});
 396                          AppLockManager.getInstance().getCurrentAppLock().setOneTimeTimeout(0);
 397                      }
 398                  }
 399              }
 400          }
 401      }
 402  
 403      private void updateNavigationDrawerItems() {
 404          Bucket.ObjectCursor&lt;Tag&gt; tagCursor = Tag.allWithCount(mTagsBucket).execute();
 405          mTagsAdapter.changeCursor(tagCursor);
 406      }
 407  
 408      private void setSelectedTagActive() {
 409          if (mSelectedTag == null)
 410              mSelectedTag = mTagsAdapter.getDefaultItem();
 411  
 412          setTitle(mSelectedTag.name);
<abbr title=" 413          mDrawerList.setItemChecked(mTagsAdapter.getPosition(mSelectedTag) + mDrawerList.getHeaderViewsCount(), true);"> 413          mDrawerList.setItemChecked(mTagsAdapter.getPosition(mSelectedTag) + mDrawerList.getHeaderViewsCount(), truðŸ”µ</abbr>
 414      }
 415  
 416      /* The click listener for ListView in the navigation drawer */
 417      private class DrawerItemClickListener implements ListView.OnItemClickListener {
 418          @Override
 419          public void onItemClick(AdapterView&lt;?&gt; parent, View view, int position, long id) {
 420  
 421              // Adjust for header view
 422              position -= mDrawerList.getHeaderViewsCount();
 423              mSelectedTag = mTagsAdapter.getItem(position);
 424              checkEmptyListText(false);
 425              // Update checked item in navigation drawer and close it
 426              setSelectedTagActive();
 427              mDrawerLayout.closeDrawer(mNavigationView);
 428  
 429              // Disable long press on notes if we&#x27;re viewing the trash
 430              if (mDrawerList.getCheckedItemPosition() == TRASH_SELECTED_ID) {
 431                  getNoteListFragment().getListView().setLongClickable(false);
 432              } else {
 433                  getNoteListFragment().getListView().setLongClickable(true);
 434              }
 435  
 436              getNoteListFragment().refreshListFromNavSelect();
 437              if (position &gt; 1) {
 438                  AnalyticsTracker.track(
 439                          AnalyticsTracker.Stat.LIST_TAG_VIEWED,
 440                          AnalyticsTracker.CATEGORY_TAG,
 441                          &quot;selected_tag_in_navigation_drawer&quot;
 442                  );
 443              }
 444          }
 445      }
 446  
 447      public TagsAdapter.TagMenuItem getSelectedTag() {
 448          if (mSelectedTag == null) {
 449              mSelectedTag = mTagsAdapter.getDefaultItem();
 450          }
 451  
 452          return mSelectedTag;
 453      }
 454  
 455      // Enable or disable the trash action bar button depending on if there are deleted notes or not
 456      public void updateTrashMenuItem() {
 457          if (mEmptyTrashMenuItem == null || mNotesBucket == null)
 458              return;
 459  
 460          // Disable the trash icon if there are no notes trashed.
 461          Query&lt;Note&gt; query = Note.allDeleted(mNotesBucket);
 462          if (query.count() == 0) {
 463              mEmptyTrashMenuItem.getIcon().setAlpha(127);
 464              mEmptyTrashMenuItem.setEnabled(false);
 465          } else {
 466              mEmptyTrashMenuItem.getIcon().setAlpha(255);
 467              mEmptyTrashMenuItem.setEnabled(true);
 468          }
 469      }
 470  
 471      private void addEditorFragment() {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 472 -        FragmentManager fm = getFragmentManager();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 473 +        FragmentManager fm = getSupportFragmentManager();</span>
 474          FragmentTransaction ft = fm.beginTransaction();
 475          mNoteEditorFragment = new NoteEditorFragment();
 476          ft.add(R.id.note_fragment_container, mNoteEditorFragment, TAG_NOTE_EDITOR);
 477          ft.commitAllowingStateLoss();
 478          fm.executePendingTransactions();
 479      }
 480  
 481      /**
 482       * Checks for a previously valid user that is now not authenticated
 483       *
 484       * @return true if user has invalid authorization
 485       */
 486      private boolean userAuthenticationIsInvalid() {
 487          Simplenote currentApp = (Simplenote) getApplication();
 488          Simperium simperium = currentApp.getSimperium();
 489          User user = simperium.getUser();
 490          return user.hasAccessToken() &amp;&amp; user.getStatus().equals(User.Status.NOT_AUTHORIZED);
 491      }
 492  
 493      private boolean userIsUnauthorized() {
 494          Simplenote currentApp = (Simplenote) getApplication();
 495          return currentApp.getSimperium().getUser().getStatus() == User.Status.NOT_AUTHORIZED;
 496      }
 497  
 498      private boolean userIsAuthorized() {
 499          Simplenote app = (Simplenote) getApplication();
 500          return !app.getSimperium().needsAuthorization();
 501      }
 502  
 503      public void setCurrentNote(Note note) {
 504          mCurrentNote = note;
 505      }
 506  
 507      public NoteListFragment getNoteListFragment() {
 508          return mNoteListFragment;
 509      }
 510  
 511      @SuppressWarnings(&quot;ResourceType&quot;)
 512      @Override
 513      public boolean onCreateOptionsMenu(Menu menu) {
 514          super.onCreateOptionsMenu(menu);
 515          MenuInflater inflater = getMenuInflater();
 516          inflater.inflate(R.menu.notes_list, menu);
 517  
 518          // restore the search query if on a landscape tablet
 519          String searchQuery = null;
 520          if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; mSearchView != null)
 521              searchQuery = mSearchView.getQuery().toString();
 522  
 523          mSearchMenuItem = menu.findItem(R.id.menu_search);
 524          mSearchView = (SearchView) mSearchMenuItem.getActionView();
 525  
 526          if (!TextUtils.isEmpty(searchQuery)) {
 527              mSearchView.setQuery(searchQuery, false);
 528              mSearchMenuItem.expandActionView();
 529          } else {
 530              // Workaround for setting the search placeholder text color
 531              String hintHexColor = (ThemeUtils.isLightTheme(this) ?
 532                      getString(R.color.simplenote_light_grey) :
 533                      getString(R.color.simplenote_dark_text_preview)).replace(&quot;ff&quot;, &quot;&quot;);

 534              mSearchView.setQueryHint(Html.fromHtml(String.format(&quot;&lt;font color=\&quot;%s\&quot;&gt;%s&lt;/font&gt;&quot;,
 535                      hintHexColor,
 536                      getString(R.string.search))));
 537          }
 538  
 539          mSearchView.setOnQueryTextListener(new SearchView.OnQueryTextListener() {
 540              @Override
 541              public boolean onQueryTextChange(String newText) {
 542                  if (mSearchMenuItem.isActionViewExpanded()) {
 543                      getNoteListFragment().searchNotes(newText);
 544                  }
 545                  return true;
 546              }
 547  
 548              @Override
 549              public boolean onQueryTextSubmit(String queryText) {
 550                  getNoteListFragment().searchNotes(queryText);
 551                  return true;
 552              }
 553  
 554          });
 555  
 556          MenuItemCompat.setOnActionExpandListener(mSearchMenuItem, new MenuItemCompat.OnActionExpandListener() {
 557              @Override
 558              public boolean onMenuItemActionExpand(MenuItem menuItem) {
 559                  checkEmptyListText(true);
 560                  if (mNoteListFragment != null) {
 561                      mNoteListFragment.setFloatingActionButtonVisible(false);
 562                  }
 563                  AnalyticsTracker.track(
 564                          AnalyticsTracker.Stat.LIST_NOTES_SEARCHED,
 565                          AnalyticsTracker.CATEGORY_NOTE,
 566                          &quot;action_bar_search_tap&quot;
 567                  );
 568                  return true;
 569              }
 570  
 571              @Override
 572              public boolean onMenuItemActionCollapse(MenuItem menuItem) {
 573                  // Show all notes again
 574                  if (mNoteListFragment != null) {
 575                      mNoteListFragment.setFloatingActionButtonVisible(true);
 576                  }
 577                  mTabletSearchQuery = &quot;&quot;;
 578                  mSearchView.setQuery(&quot;&quot;, false);
 579                  checkEmptyListText(false);
 580                  getNoteListFragment().clearSearch();
 581                  return true;
 582              }
 583          });
 584  
 585          mSearchMenuItem.setOnMenuItemClickListener(new MenuItem.OnMenuItemClickListener() {
 586              @Override
 587              public boolean onMenuItemClick(MenuItem item) {
 588                  if (!mSearchMenuItem.isActionViewExpanded())
 589                      showDetailPlaceholder();
 590                  return false;
 591              }
 592          });
 593  
 594          MenuItem trashItem = menu.findItem(R.id.menu_delete).setTitle(R.string.undelete);
 595          if (mCurrentNote != null &amp;&amp; mCurrentNote.isDeleted())
 596              trashItem.setTitle(R.string.undelete);
 597          else
 598              trashItem.setTitle(R.string.delete);
 599  
 600          if (DisplayUtils.isLargeScreenLandscape(this)) {
 601              // Restore the search query on landscape tablets
 602              if (!TextUtils.isEmpty(mTabletSearchQuery)) {
 603                  mSearchMenuItem.expandActionView();
 604                  mSearchView.setQuery(mTabletSearchQuery, false);
 605                  mSearchView.clearFocus();
 606              }
 607  
 608              if (mCurrentNote != null) {
 609                  menu.findItem(R.id.menu_share).setVisible(true);
 610                  menu.findItem(R.id.menu_view_info).setVisible(true);
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 611 +                menu.findItem(R.id.menu_markdown_preview).setVisible(mIsMarkdownEnabledGlobal &amp;&amp; mCurrentNote.isMarkdownEnabled());"> 611 +                menu.findItem(R.id.menu_markdown_preview).setVisible(mIsMarkdownEnabledGlobal &amp;&amp; mCurrentNote.isMaðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 612 +                menu.findItem(R.id.menu_markdown_enable).setVisible(mIsMarkdownEnabledGlobal);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 613 +                menu.findItem(R.id.menu_markdown_enable).setChecked(mCurrentNote.isMarkdownEnabled());</span>
 614                  trashItem.setVisible(true);
 615              } else {
 616                  menu.findItem(R.id.menu_share).setVisible(false);
 617                  menu.findItem(R.id.menu_view_info).setVisible(false);
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 618 +                menu.findItem(R.id.menu_markdown_preview).setVisible(false);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 619 +                menu.findItem(R.id.menu_markdown_enable).setVisible(false);</span>
 620                  trashItem.setVisible(false);
 621              }
 622              menu.findItem(R.id.menu_empty_trash).setVisible(false);
 623          } else {
 624              menu.findItem(R.id.menu_search).setVisible(true);
 625              menu.findItem(R.id.menu_share).setVisible(false);
 626              menu.findItem(R.id.menu_view_info).setVisible(false);
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 627 +            menu.findItem(R.id.menu_markdown_preview).setVisible(false);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 628 +            menu.findItem(R.id.menu_markdown_enable).setVisible(false);</span>
 629              trashItem.setVisible(false);
 630              menu.findItem(R.id.menu_empty_trash).setVisible(false);
 631          }
 632  
 633          // Are we looking at the trash? Adjust menu accordingly.
 634          if (mDrawerList.getCheckedItemPosition() == TRASH_SELECTED_ID) {
 635              mEmptyTrashMenuItem = menu.findItem(R.id.menu_empty_trash);
 636              mEmptyTrashMenuItem.setVisible(true);
 637  
 638              updateTrashMenuItem();
 639  
 640              menu.findItem(R.id.menu_search).setVisible(false);
 641              menu.findItem(R.id.menu_share).setVisible(false);
 642          }




 643  
 644          return true;
 645      }
 646  
 647      @Override
 648      public boolean onOptionsItemSelected(MenuItem item) {
 649          if (mDrawerToggle.onOptionsItemSelected(item)) {
 650              return true;
 651          }
 652          switch (item.getItemId()) {
 653              case R.id.menu_share:
 654                  if (mCurrentNote != null) {
 655                      Intent shareIntent = new Intent(android.content.Intent.ACTION_SEND);
 656                      shareIntent.setType(&quot;text/plain&quot;);
 657                      shareIntent.putExtra(android.content.Intent.EXTRA_TEXT, mCurrentNote.getContent());
<abbr title=" 658                      startActivity(Intent.createChooser(shareIntent, getResources().getString(R.string.share_note)));"> 658                      startActivity(Intent.createChooser(shareIntent, getResources().getString(R.string.share_note))ðŸ”µ</abbr>
 659                      AnalyticsTracker.track(
 660                              AnalyticsTracker.Stat.EDITOR_NOTE_CONTENT_SHARED,
 661                              AnalyticsTracker.CATEGORY_NOTE,
 662                              &quot;action_bar_share_button&quot;
 663                      );
 664                  }
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 665 +                return true;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 666 +            case R.id.menu_markdown_preview:</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 667 +                if (mIsShowingMarkdown) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 668 +                    if (ThemeUtils.isLightTheme(NotesActivity.this)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 669 +                        item.setIcon(R.drawable.ic_markdown_grey_outline_24dp);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 670 +                    } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 671 +                        item.setIcon(R.drawable.ic_markdown_blue_outline_24dp);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 672 +                    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 673 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 674 +                    mNoteEditorFragment.hideMarkdown();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 675 +                    item.setTitle(getString(R.string.markdown_show));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 676 +                    mIsShowingMarkdown = false;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 677 +                } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 678 +                    if (ThemeUtils.isLightTheme(NotesActivity.this)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 679 +                        item.setIcon(R.drawable.ic_markdown_grey_solid_24dp);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 680 +                    } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 681 +                        item.setIcon(R.drawable.ic_markdown_blue_solid_24dp);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 682 +                    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 683 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 684 +                    mNoteEditorFragment.showMarkdown();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 685 +                    item.setTitle(getString(R.string.markdown_hide));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 686 +                    mIsShowingMarkdown = true;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 687 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 688 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 689 +                return true;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 690 +            case R.id.menu_markdown_enable:</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 691 +                if (mCurrentNote != null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 692 +                    if (mNoteEditorFragment != null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 693 +                        mNoteEditorFragment.setMarkdownEnabled(!mCurrentNote.isMarkdownEnabled());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 694 +                        mNoteEditorFragment.saveNote();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 695 +                    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 696 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 697 +                    item.setChecked(!mCurrentNote.isMarkdownEnabled());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 698 +                    invalidateOptionsMenu();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 699 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 700 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 701 +                if (mNoteEditorFragment != null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 702 +                    mNoteEditorFragment.hideMarkdown();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 703 +                    mIsShowingMarkdown = false;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 704 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 705 +</span>
 706                  return true;
 707              case R.id.menu_delete:
 708                  if (mNoteEditorFragment != null) {
 709                      if (mCurrentNote != null) {
 710                          mCurrentNote.setDeleted(!mCurrentNote.isDeleted());
 711                          mCurrentNote.setModificationDate(Calendar.getInstance());
 712                          mCurrentNote.save();
 713  
 714                          if (mCurrentNote.isDeleted()) {
 715                              List&lt;String&gt; deletedNoteIds = new ArrayList&lt;&gt;();
 716                              deletedNoteIds.add(mCurrentNote.getSimperiumKey());
 717                              mUndoBarController.setDeletedNoteIds(deletedNoteIds);
 718                              mUndoBarController.showUndoBar(getUndoView(), getString(R.string.note_deleted), null);
 719                              AnalyticsTracker.track(
 720                                      AnalyticsTracker.Stat.LIST_NOTE_DELETED,
 721                                      AnalyticsTracker.CATEGORY_NOTE,
 722                                      &quot;overflow_menu&quot;
 723                              );
 724                          } else {
 725                              AnalyticsTracker.track(
 726                                      AnalyticsTracker.Stat.EDITOR_NOTE_RESTORED,
 727                                      AnalyticsTracker.CATEGORY_NOTE,
 728                                      &quot;overflow_menu&quot;
 729                              );
 730                          }
 731                          showDetailPlaceholder();
 732                      }
 733                      NoteListFragment fragment = getNoteListFragment();
 734                      if (fragment != null) {
 735                          fragment.getPrefs();
 736                          fragment.refreshList();
 737                      }
 738                  }
 739                  return true;
 740              case R.id.menu_empty_trash:
 741                  AlertDialog.Builder alert = new AlertDialog.Builder(this);
 742  
 743                  alert.setTitle(R.string.empty_trash);
 744                  alert.setMessage(R.string.confirm_empty_trash);
 745                  alert.setPositiveButton(R.string.yes, new DialogInterface.OnClickListener() {
 746                      public void onClick(DialogInterface dialog, int whichButton) {
 747                          new emptyTrashTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR);
 748                          AnalyticsTracker.track(
 749                                  AnalyticsTracker.Stat.LIST_TRASH_EMPTIED,
 750                                  AnalyticsTracker.CATEGORY_NOTE,
 751                                  &quot;overflow_menu&quot;
 752                          );
 753                      }
 754                  });
 755                  alert.setNegativeButton(R.string.no, new DialogInterface.OnClickListener() {
 756                      public void onClick(DialogInterface dialog, int whichButton) {
 757                          // Do nothing, just closing the dialog
 758                      }
 759                  });
 760                  alert.show();
 761                  return true;
 762              case android.R.id.home:
 763                  invalidateOptionsMenu();
 764                  return true;
 765              default:
 766                  return super.onOptionsItemSelected(item);
 767          }
 768      }
 769  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 770 +    @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 771 +    public boolean onPrepareOptionsMenu(Menu menu) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 772 +        MenuItem markdownItem = menu.findItem(R.id.menu_markdown_preview);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 773 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 774 +        if (mIsShowingMarkdown) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 775 +            if (ThemeUtils.isLightTheme(NotesActivity.this)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 776 +                markdownItem.setIcon(R.drawable.ic_markdown_grey_solid_24dp);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 777 +            } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 778 +                markdownItem.setIcon(R.drawable.ic_markdown_blue_solid_24dp);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 779 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 780 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 781 +            markdownItem.setTitle(getString(R.string.markdown_hide));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 782 +        } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 783 +            if (ThemeUtils.isLightTheme(NotesActivity.this)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 784 +                markdownItem.setIcon(R.drawable.ic_markdown_grey_outline_24dp);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 785 +            } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 786 +                markdownItem.setIcon(R.drawable.ic_markdown_blue_outline_24dp);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 787 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 788 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 789 +            markdownItem.setTitle(getString(R.string.markdown_show));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 790 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 791 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 792 +        return super.onPrepareOptionsMenu(menu);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 793 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 794 +</span>
 795      /**
 796       * Callback method from {@link NoteListFragment.Callbacks} indicating that
 797       * the item with the given ID was selected. Used for tablets only.
 798       */
 799      @Override
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 800 -    public void onNoteSelected(String noteID, int position, boolean isNew, String matchOffsets) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 801 +    public void onNoteSelected(String noteID, int position, boolean isNew, String matchOffsets, boolean isMarkdownEnabled) {"> 801 +    public void onNoteSelected(String noteID, int position, boolean isNew, String matchOffsets, boolean isMarkdownðŸ”µ</abbr></span>
 802          if (!DisplayUtils.isLargeScreenLandscape(this)) {
 803              // Launch the editor activity
 804              Bundle arguments = new Bundle();
 805              arguments.putString(NoteEditorFragment.ARG_ITEM_ID, noteID);
 806              arguments.putBoolean(NoteEditorFragment.ARG_NEW_NOTE, isNew);
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 807 +            arguments.putBoolean(NoteEditorFragment.ARG_MARKDOWN_ENABLED, isMarkdownEnabled);</span>
 808  
 809              if (matchOffsets != null)
 810                  arguments.putString(NoteEditorFragment.ARG_MATCH_OFFSETS, matchOffsets);
 811  
 812              Intent editNoteIntent = new Intent(this, NoteEditorActivity.class);
 813              editNoteIntent.putExtras(arguments);
 814              startActivityForResult(editNoteIntent, Simplenote.INTENT_EDIT_NOTE);
 815          } else {
 816              mNoteEditorFragment.setIsNewNote(isNew);
 817              mNoteEditorFragment.setNote(noteID, matchOffsets);
 818              getNoteListFragment().setNoteSelected(noteID);
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 819 +</span>
 820              if (mSearchView != null &amp;&amp; mSearchView.getQuery() != null) {
 821                  mTabletSearchQuery = mSearchView.getQuery().toString();
 822              }
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 823 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 824 +            mNoteEditorFragment.clearMarkdown();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 825 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 826 +            if (!isMarkdownEnabled &amp;&amp; mIsShowingMarkdown) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 827 +                mNoteEditorFragment.hideMarkdown();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 828 +                mIsShowingMarkdown = false;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 829 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 830 +</span>
 831              invalidateOptionsMenu();
 832          }
 833  
 834          AnalyticsTracker.track(
 835                  AnalyticsTracker.Stat.LIST_NOTE_OPENED,
 836                  AnalyticsTracker.CATEGORY_NOTE,
 837                  &quot;note_list_row_tap&quot;
 838          );
 839      }
 840  
 841      @Override
 842      public void onUserCreated(User user) {
 843          // New account created
 844          AnalyticsTracker.track(
 845                  AnalyticsTracker.Stat.USER_ACCOUNT_CREATED,
 846                  AnalyticsTracker.CATEGORY_USER,
 847                  &quot;account_created_from_login_activity&quot;
 848          );
 849      }
 850  
 851      public void onUserStatusChange(User.Status status) {
 852          switch (status) {
 853              // successfully used access token to connect to simperium bucket
 854              case AUTHORIZED:
 855                  runOnUiThread(new Runnable() {
 856                      @Override
 857                      public void run() {
 858                          if (!mNotesBucket.hasChangeVersion()) {
 859                              setToolbarProgressVisibility(true);
 860                          }
 861                      }
 862                  });
 863                  break;
 864  
 865              // NOT_AUTHORIZED means we attempted to connect but the token was not valid
 866              case NOT_AUTHORIZED:
 867                  runOnUiThread(new Runnable() {
 868                      @Override
 869                      public void run() {
 870                          startLoginActivity(true);
 871                      }
 872                  });
 873                  break;
 874  
<abbr title=" 875              // Default starting state of User, don&#x27;t do anything we allow use of app while not signed in so don&#x27;t do anything"> 875              // Default starting state of User, don&#x27;t do anything we allow use of app while not signed in so don&#x27;t ðŸ”µ</abbr>
 876              case UNKNOWN:
 877                  break;
 878          }
 879      }
 880  
 881      private void setToolbarProgressVisibility(boolean isVisible) {
 882          if (getSupportActionBar() != null) {
 883              getSupportActionBar().setDisplayShowCustomEnabled(isVisible);
 884          }
 885      }
 886  
 887      public void startLoginActivity(boolean signInFirst) {
 888          Intent loginIntent = new Intent(this, LoginActivity.class);
 889          if (signInFirst)
 890              loginIntent.putExtra(LoginActivity.EXTRA_SIGN_IN_FIRST, true);
 891          startActivityForResult(loginIntent, Simperium.SIGNUP_SIGNIN_REQUEST);
 892      }
 893  


















 894  
 895      @Override
 896      protected void onActivityResult(int requestCode, int resultCode, Intent data) {
 897          super.onActivityResult(requestCode, resultCode, data);
 898          switch (requestCode) {
 899              case Simplenote.INTENT_PREFERENCES:
 900                  if (ThemeUtils.themeWasChanged(data)) {
 901                      // Restart this activity to apply the new theme
 902                      recreate();
 903                      break;
 904                  }
<abbr title=" 905                  // nbradbury - refresh note list when user returns from preferences (in case they changed anything)"> 905                  // nbradbury - refresh note list when user returns from preferences (in case they changed anythingðŸ”µ</abbr>
 906                  invalidateOptionsMenu();
 907                  NoteListFragment fragment = getNoteListFragment();
 908                  if (fragment != null) {
 909                      fragment.getPrefs();
 910                      fragment.refreshList();
 911                  }
 912                  break;
 913              case Simplenote.INTENT_EDIT_NOTE:
 914                  if (resultCode == RESULT_OK &amp;&amp; data != null &amp;&amp; data.hasExtra(Simplenote.DELETED_NOTE_ID)) {
 915                      String noteId = data.getStringExtra(Simplenote.DELETED_NOTE_ID);
 916                      if (noteId != null) {
 917                          List&lt;String&gt; deletedNoteIds = new ArrayList&lt;&gt;();
 918                          deletedNoteIds.add(noteId);
 919                          mUndoBarController.setDeletedNoteIds(deletedNoteIds);
 920                          mUndoBarController.showUndoBar(getUndoView(), getString(R.string.note_deleted), null);
 921                      }
 922                  }
 923                  break;
 924              case Simperium.SIGNUP_SIGNIN_REQUEST:
 925                  invalidateOptionsMenu();
 926  
 927                  Simplenote app = (Simplenote)getApplication();
 928                  AnalyticsTracker.refreshMetadata(app.getSimperium().getUser().getEmail());
 929  
 930                  AnalyticsTracker.track(
 931                          AnalyticsTracker.Stat.USER_SIGNED_IN,
 932                          AnalyticsTracker.CATEGORY_USER,
 933                          &quot;signed_in_from_login_activity&quot;
 934                  );
 935  
 936                  if (resultCode == Activity.RESULT_CANCELED &amp;&amp; userAuthenticationIsInvalid()) {
 937                      finish();
 938                  }
 939  
 940                  break;
 941          }
 942      }
 943  
 944      @Override
 945      public void onUndo() {
 946          if (mUndoBarController == null) return;
 947  
 948          List&lt;String&gt; deletedNoteIds = mUndoBarController.getDeletedNoteIds();
 949          if (deletedNoteIds != null) {
 950              for (int i = 0; i &lt; deletedNoteIds.size(); i++) {
 951                  Note deletedNote;
 952                  try {
 953                      deletedNote = mNotesBucket.get(deletedNoteIds.get(i));
 954                  } catch (BucketObjectMissingException e) {
 955                      return;
 956                  }
 957                  if (deletedNote != null) {
 958                      deletedNote.setDeleted(false);
 959                      deletedNote.setModificationDate(Calendar.getInstance());
 960                      deletedNote.save();
 961                      NoteListFragment fragment = getNoteListFragment();
 962                      if (fragment != null) {
 963                          fragment.getPrefs();
 964                          fragment.refreshList();
 965                      }
 966                  }
 967              }
 968          }
 969      }
 970  
 971      @Override
 972      protected void onPostCreate(Bundle savedInstanceState) {
 973          super.onPostCreate(savedInstanceState);
 974          // Sync the toggle state after onRestoreInstanceState has occurred.
 975          mDrawerToggle.syncState();
 976      }
 977  
 978      @Override
 979      public void onConfigurationChanged(Configuration newConfig) {
 980          super.onConfigurationChanged(newConfig);
 981  
 982          mDrawerToggle.onConfigurationChanged(newConfig);
 983  
 984          if (DisplayUtils.isLargeScreen(this)) {
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 985 +            mIsShowingMarkdown = false;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 986 +</span>
 987              if (newConfig.orientation == Configuration.ORIENTATION_LANDSCAPE) {
 988                  // Add the editor fragment
 989                  addEditorFragment();
 990                  if (mNoteListFragment != null) {
 991                      mNoteListFragment.setActivateOnItemClick(true);
 992                      mNoteListFragment.setDividerVisible(true);
 993                  }
 994                  // Select the current note on a tablet
 995                  if (mCurrentNote != null)
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 996 -                    onNoteSelected(mCurrentNote.getSimperiumKey(), 0, false, null);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 997 +                    onNoteSelected(mCurrentNote.getSimperiumKey(), 0, false, null, mCurrentNote.isMarkdownEnabled());"> 997 +                    onNoteSelected(mCurrentNote.getSimperiumKey(), 0, false, null, mCurrentNote.isMarkdownEnabled(ðŸ”µ</abbr></span>
 998                  else {
 999                      mNoteEditorFragment.setPlaceholderVisible(true);
1000                      mNoteListFragment.getListView().clearChoices();
1001                  }
1002                  invalidateOptionsMenu();
<abbr title="1003              } else if (newConfig.orientation == Configuration.ORIENTATION_PORTRAIT &amp;&amp; mNoteEditorFragment != null) {">1003              } else if (newConfig.orientation == Configuration.ORIENTATION_PORTRAIT &amp;&amp; mNoteEditorFragment != null)ðŸ”µ</abbr>
1004                  // Remove the editor fragment when rotating back to portrait
1005                  mCurrentNote = null;
1006                  if (mNoteListFragment != null) {
1007                      mNoteListFragment.setActivateOnItemClick(false);
1008                      mNoteListFragment.setDividerVisible(false);
1009                      mNoteListFragment.setActivatedPosition(ListView.INVALID_POSITION);
1010                      mNoteListFragment.refreshList();
1011                  }
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1012 -                FragmentManager fm = getFragmentManager();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1013 +                FragmentManager fm = getSupportFragmentManager();</span>
1014                  FragmentTransaction ft = fm.beginTransaction();
1015                  ft.remove(mNoteEditorFragment);
1016                  mNoteEditorFragment = null;
1017                  ft.commitAllowingStateLoss();
1018                  fm.executePendingTransactions();
1019                  invalidateOptionsMenu();
1020              }
1021          }
1022      }
1023  
1024      public void checkEmptyListText(boolean isSearch) {
1025          if (isSearch) {
<abbr title="1026              getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_found) + &quot;&lt;/strong&gt;&quot;);">1026              getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_found) + &quot;&lt;/strong&gt;ðŸ”µ</abbr>
1027              getNoteListFragment().setEmptyListViewClickable(false);
1028          } else if (mDrawerList.getCheckedItemPosition() == TRASH_SELECTED_ID) {
<abbr title="1029              getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.trash_is_empty) + &quot;&lt;/strong&gt;&quot;);">1029              getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.trash_is_empty) + &quot;&lt;/strong&gt;ðŸ”µ</abbr>
1030              AnalyticsTracker.track(
1031                      AnalyticsTracker.Stat.LIST_TRASH_VIEWED,
1032                      AnalyticsTracker.CATEGORY_NOTE,
1033                      &quot;trash_filter_selected&quot;
1034              );
1035              getNoteListFragment().setEmptyListViewClickable(false);
1036          } else {
<abbr title="1037              getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here) + &quot;&lt;/strong&gt;&lt;br /&gt;&quot; + String.format(getString(R.string.why_not_create_one), &quot;&lt;u&gt;&quot;, &quot;&lt;/u&gt;&quot;));">1037              getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here) + &quot;&lt;/strong&gt;&lt;ðŸ”µ</abbr>
1038              getNoteListFragment().setEmptyListViewClickable(true);
1039          }
1040      }
1041  
1042      public void showDetailPlaceholder() {
1043          if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; mNoteEditorFragment != null) {
1044              mCurrentNote = null;
1045              mNoteEditorFragment.setPlaceholderVisible(true);
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1046 +            mNoteEditorFragment.clearMarkdown();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1047 +            mNoteEditorFragment.hideMarkdown();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1048 +            mIsShowingMarkdown = false;</span>
1049          }
1050      }
1051  
1052      public void stopListeningToNotesBucket() {
1053          mNotesBucket.removeOnNetworkChangeListener(this);
1054          mNotesBucket.removeOnSaveObjectListener(this);
1055          mNotesBucket.removeOnDeleteObjectListener(this);
1056      }
1057  
1058      // Returns the appropriate view to show the undo bar within
1059      private View getUndoView() {
1060          View undoView = mFragmentsContainer;
1061          if (!DisplayUtils.isLargeScreenLandscape(this) &amp;&amp;
1062                  getNoteListFragment() != null &amp;&amp;
1063                  getNoteListFragment().getRootView() != null) {
1064              undoView = getNoteListFragment().getRootView();
1065          }
1066  
1067          return undoView;
1068      }
1069  
1070      public void showUndoBarWithNoteIds(List&lt;String&gt; noteIds) {
1071          if (mUndoBarController != null) {
1072              mUndoBarController.setDeletedNoteIds(noteIds);
1073              mUndoBarController.showUndoBar(
1074                      getUndoView(),
1075                      getResources().getQuantityString(R.plurals.trashed_notes, noteIds.size(), noteIds.size()),
1076                      null
1077              );
1078          }
1079      }
1080  
1081      private class emptyTrashTask extends AsyncTask&lt;Void, Void, Void&gt; {
1082  
1083          @Override
1084          protected Void doInBackground(Void... voids) {
1085              if (mNotesBucket == null) return null;
1086  
1087              Query&lt;Note&gt; query = Note.allDeleted(mNotesBucket);
1088              Bucket.ObjectCursor c = query.execute();
1089              while (c.moveToNext()) {
1090                  c.getObject().delete();
1091              }
1092  
1093              return null;
1094          }
1095  
1096          @Override
1097          protected void onPostExecute(Void nada) {
1098              showDetailPlaceholder();
1099          }
1100      }
1101  
1102  
1103      /* Simperium Bucket Listeners */
1104      // received a change from the network, refresh the list
1105      @Override
1106      public void onNetworkChange(Bucket&lt;Note&gt; bucket, final Bucket.ChangeType type, String key) {
1107          runOnUiThread(new Runnable() {
1108              @Override
1109              public void run() {
1110                  if (type == Bucket.ChangeType.INDEX) {
1111                      setToolbarProgressVisibility(false);
1112                  }
1113                  mNoteListFragment.refreshList();
1114              }
1115          });
1116      }
1117  
1118      @Override
1119      public void onSaveObject(Bucket&lt;Note&gt; bucket, Note object) {
1120          runOnUiThread(new Runnable() {
1121              @Override
1122              public void run() {
1123                  mNoteListFragment.refreshList();
1124              }
1125          });
1126      }
1127  
1128      @Override
1129      public void onDeleteObject(Bucket&lt;Note&gt; bucket, Note object) {
1130          runOnUiThread(new Runnable() {
1131              @Override
1132              public void run() {
1133                  mNoteListFragment.refreshList();
1134              }
1135          });
1136      }
1137  
1138      @Override
1139      public void onBeforeUpdateObject(Bucket&lt;Note&gt; bucket, Note note) {
1140          // noop, NoteEditorFragment will handle this
1141      }
1142  
1143      // Tags bucket listener
1144      private Bucket.Listener&lt;Tag&gt; mTagsMenuUpdater = new Bucket.Listener&lt;Tag&gt;() {
1145          void updateNavigationDrawer() {
1146              runOnUiThread(new Runnable() {
1147                  public void run() {
1148                      updateNavigationDrawerItems();
1149                  }
1150              });
1151          }
1152  
1153          @Override
1154          public void onSaveObject(Bucket&lt;Tag&gt; bucket, Tag tag) {
1155              updateNavigationDrawer();
1156          }
1157  
1158          @Override
1159          public void onDeleteObject(Bucket&lt;Tag&gt; bucket, Tag tag) {
1160              updateNavigationDrawer();
1161          }
1162  
1163          @Override
1164          public void onNetworkChange(Bucket&lt;Tag&gt; bucket, Bucket.ChangeType type, String key) {
1165              updateNavigationDrawer();
1166          }
1167  
1168          @Override
1169          public void onBeforeUpdateObject(Bucket&lt;Tag&gt; bucket, Tag object) {
1170              // noop
1171          }
1172      };
1173  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            