<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>251</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    251
                    <a href="250.html">prev</a>
                    <a href="252.html">next</a>
                    <a href="251_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    Automattic/simplenote-android_ba199f73e69d9f16d30c878cfd5beca6386aeede_src/com/automattic/simplenote/NoteEditorFragment.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;ba199f73e69d9f16d30c878cfd5beca6386aeede:src/com/automattic/simplenote/NoteEditorFragment.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;ba199f73e69d9f16d30c878cfd5beca6386aeede^1:src/com/automattic/simplenote/NoteEditorFragment.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;ba199f73e69d9f16d30c878cfd5beca6386aeede^2:src/com/automattic/simplenote/NoteEditorFragment.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;f69ab0e3b7d8571323286de72e22f00463f544e8:src/com/automattic/simplenote/NoteEditorFragment.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[bs], [b], [s]], subset: [[bs], [bs]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 package com.automattic.simplenote;
   2 
   3 import java.util.ArrayList;
   4 import java.util.Arrays;
   5 import java.util.Calendar;
   6 import java.util.List;
   7 
   8 import android.app.Fragment;
   9 import android.content.Context;
  10 import android.os.Bundle;
  11 import android.os.Handler;
  12 import android.text.Editable;
  13 import android.text.SpannableString;
  14 import android.text.Spanned;
  15 import android.text.TextUtils;
  16 import android.text.TextWatcher;
  17 import android.util.Log;
  18 import android.view.LayoutInflater;
  19 import android.view.View;
  20 import android.view.ViewGroup;
  21 import android.view.inputmethod.InputMethodManager;
  22 import android.widget.ArrayAdapter;
  23 import android.widget.EditText;
  24 import android.widget.LinearLayout;
  25 import android.widget.MultiAutoCompleteTextView.Tokenizer;
  26 import android.widget.ToggleButton;
  27 
  28 import com.automattic.simplenote.models.Note;
  29 import com.automattic.simplenote.models.Tag;
  30 import com.automattic.simplenote.utils.TagsMultiAutoCompleteTextView;
  31 import com.automattic.simplenote.utils.TagsMultiAutoCompleteTextView.OnTagAddedListener;
  32 import com.simperium.client.Bucket;
  33 import com.simperium.client.Bucket.ObjectCursor;
  34 import com.simperium.client.BucketObjectMissingException;
  35 
  36 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  37 public class NoteEditorFragment extends Fragment implements TextWatcher, OnTagAddedListener {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  38 	/**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  39 	 * The fragment argument representing the item ID that this fragment</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  40 	 * represents.</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  41 	 */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  42 	public static final String ARG_ITEM_ID = &quot;item_id&quot;;</span>
  43 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  44 public class NoteEditorFragment extends Fragment implements TextWatcher {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  45 	/**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  46 	 * The fragment argument representing the item ID that this fragment</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  47 	 * represents.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  48 	 */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  49 	public static final String ARG_ITEM_ID = &quot;item_id&quot;;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  50     private static final int AUTOSAVE_DELAY_MILLIS = 2000;</span>
  51 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  52 public class NoteEditorFragment extends Fragment implements TextWatcher {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  53     /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  54      * The fragment argument representing the item ID that this fragment</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  55      * represents.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  56      */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  57     public static final String ARG_ITEM_ID = &quot;item_id&quot;;</span>
  58 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
  59     private static final int AUTOSAVE_DELAY_MILLIS = 2000;
  60 
  61     /**
  62      * The dummy content this fragment is presenting.
  63      */
  64     private Note mNote;
  65     private EditText mContentEditText;
  66     private TagsMultiAutoCompleteTextView mTagView;
  67     private ToggleButton mPinButton;
  68     private boolean mShowNoteTitle;
  69     private Handler mAutoSaveHandler;
  70     private LinearLayout mPlaceholderView;
  71 
  72     /**
  73      * Mandatory empty constructor for the fragment manager to instantiate the
  74      * fragment (e.g. upon screen orientation changes).
  75      */
  76     public NoteEditorFragment() {
  77     }
  78 
  79     @Override
  80     public void onCreate(Bundle savedInstanceState) {
  81         super.onCreate(savedInstanceState);
  82 
  83         if (getArguments() != null &amp;&amp; getArguments().containsKey(ARG_ITEM_ID)) {
  84             Simplenote application = (Simplenote) getActivity().getApplication();
  85             Bucket&lt;Note&gt; notesBucket = application.getNotesBucket();
  86             String key = getArguments().getString(ARG_ITEM_ID);
  87             try {
  88                 mNote = notesBucket.get(key);
  89             } catch (BucketObjectMissingException e) {
  90                 // TODO: Handle a missing note
  91             }
  92         }
  93 
  94         if (!((NotesActivity) getActivity()).isLargeScreenLandscape())
  95             mShowNoteTitle = true;
  96 
  97         mAutoSaveHandler = new Handler();
  98 
  99     }
 100 
 101     @Override
 102     public View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {
 103         View rootView = inflater.inflate(R.layout.fragment_note_editor, container, false);
 104         mContentEditText = ((EditText) rootView.findViewById(R.id.note_content));
 105         mContentEditText.addTextChangedListener(this);
 106         mTagView = (TagsMultiAutoCompleteTextView) rootView.findViewById(R.id.tag_view);
 107         mTagView.setTokenizer(new SpaceTokenizer());
 108 
 109         mPinButton = (ToggleButton) rootView.findViewById(R.id.pinButton);
 110         mPlaceholderView = (LinearLayout) rootView.findViewById(R.id.placeholder);
 111         if (!((NotesActivity) getActivity()).isLargeScreen())
 112             mPlaceholderView.setVisibility(View.GONE);
 113 
 114 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 115 		refreshContent();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 116 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 117 		return rootView;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 118 	}</span>
 119 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 120         Simplenote simplenote = (Simplenote)getActivity().getApplication();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 121         Bucket&lt;Tag&gt; tagBucket = simplenote.getTagsBucket();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 122         ObjectCursor&lt;Tag&gt; tagsCursor = tagBucket.query().orderByKey().execute();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 123 		String[] allTags = new String[tagsCursor.getCount()];</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 124         while (tagsCursor.moveToNext()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 125             allTags[tagsCursor.getPosition()] = tagsCursor.getObject().getName();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 126         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 127         tagsCursor.close();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 128         ArrayAdapter&lt;String&gt; adapter = new ArrayAdapter&lt;String&gt;(getActivity(),</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 129                 android.R.layout.simple_dropdown_item_1line, allTags);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 130         mTagView.setAdapter(adapter);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 131         mTagView.setTokenizer(new SpaceTokenizer());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 132         </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 133 		return rootView;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 134 	}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 135 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 136     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 137     public void onResume() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 138         super.onResume();</span>
 139 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 140         refreshContent();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 141 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 142         // Populate tag list</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 143         Simplenote simplenote = (Simplenote) getActivity().getApplication();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 144         Bucket&lt;Tag&gt; tagBucket = simplenote.getTagsBucket();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 145         ObjectCursor&lt;Tag&gt; tagsCursor = tagBucket.query().orderByKey().execute();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 146         String[] allTags = new String[tagsCursor.getCount()];</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 147         while (tagsCursor.moveToNext()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 148             allTags[tagsCursor.getPosition()] = tagsCursor.getObject().getName();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 149         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 150         tagsCursor.close();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 151         ArrayAdapter&lt;String&gt; adapter = new ArrayAdapter&lt;String&gt;(getActivity(),</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 152                 android.R.layout.simple_dropdown_item_1line, allTags);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 153         mTagView.setAdapter(adapter);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 154         mTagView.setTokenizer(new SpaceTokenizer());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 155 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 156         return rootView;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 157     }</span>
 158 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 159 
 160     @Override
 161     public void onResume() {
 162         super.onResume();
 163         mTagView.setOnTagAddedListener(this);
 164         if (mNote != null &amp;&amp; mNote.getContent().isEmpty()) {
 165             // Show soft keyboard
 166             mContentEditText.requestFocus();
 167 
<abbr title=" 168             InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemService(Context.INPUT_METHOD_SERVICE);"> 168             InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemService(C🔵</abbr>
 169             if (inputMethodManager != null)
 170                 inputMethodManager.showSoftInput(mContentEditText, 0);
 171         }
 172     }
 173 
 174     @Override
 175     public void onPause() {
 176         saveAndSyncNote();
 177         mTagView.setOnTagAddedListener(null);
 178         // Hide soft keyboard
<abbr title=" 179         InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemService(Context.INPUT_METHOD_SERVICE);"> 179         InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemService(Conte🔵</abbr>
 180         if (inputMethodManager != null)
 181             inputMethodManager.hideSoftInputFromWindow(mContentEditText.getWindowToken(), 0);
 182 
 183         if (mAutoSaveHandler != null)
 184             mAutoSaveHandler.removeCallbacks(autoSaveRunnable);
 185 
 186         super.onPause();
 187     }
 188 
 189     public void setNote(Note note) {
 190         mPlaceholderView.setVisibility(View.GONE);
 191 
 192         // If we have a note already (on a tablet in landscape), save the note.
 193         if (mNote != null)
 194             saveAndSyncNote();
 195 
 196         mNote = note;
 197         refreshContent();
 198     }
 199 
 200     public void refreshContent() {
 201         if (mNote != null) {
 202             Log.v(&quot;Simplenote&quot;, &quot;refreshing content&quot;);
 203             // Restore the cursor position if possible.
<abbr title=" 204             int cursorPosition = newCursorLocation(mNote.getContent(), mContentEditText.getText().toString(), mContentEditText.getSelectionEnd());"> 204             int cursorPosition = newCursorLocation(mNote.getContent(), mContentEditText.getText().toStrin🔵</abbr>
 205             mContentEditText.setText(mNote.getContent());
 206             if (mContentEditText.hasFocus() &amp;&amp; cursorPosition != mContentEditText.getSelectionEnd())
 207                 mContentEditText.setSelection(cursorPosition);
 208 
 209             mPinButton.setChecked(mNote.isPinned());
 210 
 211             setActionBarTitle();
 212 
 213             updateTagList();
 214         }
 215     }
 216 
 217     public void updateTagList(){
 218         // Populate this note&#x27;s tags in the tagView
 219         mTagView.setChips(mNote.getTagString());
 220         
 221 		// Populate tag list
 222         Simplenote simplenote = (Simplenote)getActivity().getApplication();
 223         Bucket&lt;Tag&gt; tagBucket = simplenote.getTagsBucket();
 224         ObjectCursor&lt;Tag&gt; tagsCursor = tagBucket.query().orderByKey().execute();
 225         List&lt;String&gt; allTags = new ArrayList&lt;String&gt;(tagsCursor.getCount());
 226         while (tagsCursor.moveToNext()) {
 227             Tag tag = tagsCursor.getObject();
 228             if (!mNote.hasTag(tag)) allTags.add(tag.getName());
 229         }
 230         tagsCursor.close();
 231         ArrayAdapter&lt;String&gt; adapter = new ArrayAdapter&lt;String&gt;(getActivity(),
 232                 android.R.layout.simple_dropdown_item_1line, allTags);
 233         mTagView.setAdapter(adapter);
 234     }
 235 
 236     private void setActionBarTitle() {
 237         if (mShowNoteTitle) {
 238             if (mNote.getTitle() != null &amp;&amp; !mNote.getTitle().equals(&quot;&quot;))
 239                 getActivity().getActionBar().setTitle(mNote.getTitle());
 240             else
 241                 getActivity().getActionBar().setTitle(R.string.new_note);
 242         }
 243     }
 244 
 245     int newCursorLocation(String newText, String oldText, int cursorLocation) {
 246         // Ported from the iOS app :)
 247         // Cases:
 248         // 0. All text after cursor (and possibly more) was removed ==&gt; put cursor at end
 249         // 1. Text was added after the cursor ==&gt; no change
 250         // 2. Text was added before the cursor ==&gt; location advances
 251         // 3. Text was removed after the cursor ==&gt; no change
 252         // 4. Text was removed before the cursor ==&gt; location retreats
 253         // 5. Text was added/removed on both sides of the cursor ==&gt; not handled
 254 
 255         int newCursorLocation = cursorLocation;
 256 
 257         int deltaLength = newText.length() - oldText.length();
 258 
 259         // Case 0
 260         if (newText.length() &lt; cursorLocation)
 261             return newText.length();
 262 
 263         boolean beforeCursorMatches = false;
 264         boolean afterCursorMatches = false;
 265 
 266         try {
<abbr title=" 267             beforeCursorMatches = oldText.substring(0, cursorLocation).equals(newText.substring(0, cursorLocation));"> 267             beforeCursorMatches = oldText.substring(0, cursorLocation).equals(newText.substring(0, cursor🔵</abbr>
<abbr title=" 268             afterCursorMatches = oldText.substring(cursorLocation, oldText.length()).equals(newText.substring(cursorLocation + deltaLength, newText.length()));"> 268             afterCursorMatches = oldText.substring(cursorLocation, oldText.length()).equals(newText.subst🔵</abbr>
 269         } catch (Exception e) {
 270             e.printStackTrace();
 271         }
 272 
 273         // Cases 2 and 4
 274         if (!beforeCursorMatches &amp;&amp; afterCursorMatches)
 275             newCursorLocation += deltaLength;
 276 
 277         // Cases 1, 3 and 5 have no change
 278         return newCursorLocation;
 279     }
 280 
 281     private Runnable autoSaveRunnable = new Runnable() {
 282         @Override
 283         public void run() {
 284             saveAndSyncNote();
 285         }
 286     };
 287 
 288     @Override
 289     public void onTagsChanged(String tagString){
 290         mNote.setTagString(tagString);
 291         mNote.setModificationDate(Calendar.getInstance());
 292         updateTagList();
 293         mNote.save();
 294 
 295     }
 296 
 297     @Override
 298     public void beforeTextChanged(CharSequence charSequence, int i, int i2, int i3) {
 299         // Unused
 300     }
 301 
 302     @Override
 303     public void afterTextChanged(Editable editable) {
 304         // Unused
 305 
 306     }
 307 
 308     @Override
 309     public void onTextChanged(CharSequence charSequence, int i, int i2, int i3) {
 310 
 311         // When text changes, start timer that will fire after AUTOSAVE_DELAY_MILLIS passes
 312 
 313         if (mAutoSaveHandler != null) {
 314             mAutoSaveHandler.removeCallbacks(autoSaveRunnable);
 315             mAutoSaveHandler.postDelayed(autoSaveRunnable, AUTOSAVE_DELAY_MILLIS);
 316         }
 317     }
 318 
 319     private void saveAndSyncNote() {
 320         if (mNote == null)
 321             return;
 322 
 323         String content = mContentEditText.getText().toString();
 324         if (mNote.hasChanges(content, mPinButton.isChecked())) {
 325             mNote.setContent(content);
 326             mNote.setTagString(mTagView.getText().toString());
 327             mNote.setModificationDate(Calendar.getInstance());
 328             mNote.setPinned(mPinButton.isChecked());
 329             mNote.save();
 330         }
 331 
 332         setActionBarTitle();
 333 
 334         Log.v(&quot;Simplenote&quot;, &quot;autosaving note&quot;);
 335     }
 336 
 337     public void setPlaceholderVisible(boolean isVisible) {
 338         if (isVisible) {
 339             mNote = null;
 340             mContentEditText.setText(&quot;&quot;);
 341             mTagView.setText(&quot;&quot;);
 342             if (mPlaceholderView != null)
 343                 mPlaceholderView.setVisibility(View.VISIBLE);
 344         } else {
 345             if (mPlaceholderView != null)
 346                 mPlaceholderView.setVisibility(View.GONE);
 347         }
 348     }
 349 
 350     // Use spaces in tag autocompletion list
<abbr title=" 351     // From http://stackoverflow.com/questions/3482981/how-to-replace-the-comma-with-a-space-when-i-use-the-multiautocompletetextview"> 351     // From http://stackoverflow.com/questions/3482981/how-to-replace-the-comma-with-a-space-when-i-use-t🔵</abbr>
 352     public class SpaceTokenizer implements Tokenizer {
 353 
 354         public int findTokenStart(CharSequence text, int cursor) {
 355             int i = cursor;
 356 
 357             while (i &gt; 0 &amp;&amp; text.charAt(i - 1) != &#x27; &#x27;) {
 358                 i--;
 359             }
 360             while (i &lt; cursor &amp;&amp; text.charAt(i) == &#x27; &#x27;) {
 361                 i++;
 362             }
 363 
 364             return i;
 365         }
 366 
 367         public int findTokenEnd(CharSequence text, int cursor) {
 368             int i = cursor;
 369             int len = text.length();
 370 
 371             while (i &lt; len) {
 372                 if (text.charAt(i) == &#x27; &#x27;) {
 373                     return i;
 374                 } else {
 375                     i++;
 376                 }
 377             }
 378 
 379             return len;
 380         }
 381 
 382         public CharSequence terminateToken(CharSequence text) {
 383             int i = text.length();
 384 
 385             while (i &gt; 0 &amp;&amp; text.charAt(i - 1) == &#x27; &#x27;) {
 386                 i--;
 387             }
 388 
 389             if (i &gt; 0 &amp;&amp; text.charAt(i - 1) == &#x27; &#x27;) {
 390                 return text;
 391             } else {
 392                 if (text instanceof Spanned) {
 393                     SpannableString sp = new SpannableString(text + &quot; &quot;);
 394                     TextUtils.copySpansFrom((Spanned) text, 0, text.length(),
 395                             Object.class, sp, 0);
 396                     return sp;
 397                 } else {
 398                     return text + &quot; &quot;;
 399                 }
 400             }
 401         }
 402     }
 403 }</pre></td>
                            <td><pre>   1 package com.automattic.simplenote;
   2 
   3 import java.util.ArrayList;
   4 import java.util.Arrays;
   5 import java.util.Calendar;
   6 import java.util.List;
   7 
   8 import android.app.Fragment;
   9 import android.content.Context;
  10 import android.os.Bundle;
  11 import android.os.Handler;
  12 import android.text.Editable;
  13 import android.text.SpannableString;
  14 import android.text.Spanned;
  15 import android.text.TextUtils;
  16 import android.text.TextWatcher;
  17 import android.util.Log;
  18 import android.view.LayoutInflater;
  19 import android.view.View;
  20 import android.view.ViewGroup;
  21 import android.view.inputmethod.InputMethodManager;
  22 import android.widget.ArrayAdapter;
  23 import android.widget.EditText;
  24 import android.widget.LinearLayout;
  25 import android.widget.MultiAutoCompleteTextView.Tokenizer;
  26 import android.widget.ToggleButton;
  27 
  28 import com.automattic.simplenote.models.Note;
  29 import com.automattic.simplenote.models.Tag;
  30 import com.automattic.simplenote.utils.TagsMultiAutoCompleteTextView;
  31 import com.automattic.simplenote.utils.TagsMultiAutoCompleteTextView.OnTagAddedListener;
  32 import com.simperium.client.Bucket;
  33 import com.simperium.client.Bucket.ObjectCursor;
  34 import com.simperium.client.BucketObjectMissingException;
  35 
  36 public class NoteEditorFragment extends Fragment implements TextWatcher, OnTagAddedListener {
  37     /**
  38      * The fragment argument representing the item ID that this fragment
  39      * represents.
  40      */
  41     public static final String ARG_ITEM_ID = &quot;item_id&quot;;
  42     private static final int AUTOSAVE_DELAY_MILLIS = 2000;
  43 
  44     /**
  45      * The dummy content this fragment is presenting.
  46      */
  47     private Note mNote;
  48     private EditText mContentEditText;
  49     private TagsMultiAutoCompleteTextView mTagView;
  50     private ToggleButton mPinButton;
  51     private boolean mShowNoteTitle;
  52     private Handler mAutoSaveHandler;
  53     private LinearLayout mPlaceholderView;
  54 
  55     /**
  56      * Mandatory empty constructor for the fragment manager to instantiate the
  57      * fragment (e.g. upon screen orientation changes).
  58      */
  59     public NoteEditorFragment() {
  60 	}
  61 
  62     @Override
  63 	public void onCreate(Bundle savedInstanceState) {
  64 		super.onCreate(savedInstanceState);
  65 
  66 		if (getArguments() != null &amp;&amp; getArguments().containsKey(ARG_ITEM_ID)) {
  67 	        Simplenote application = (Simplenote)getActivity().getApplication();
  68 			Bucket&lt;Note&gt; notesBucket = application.getNotesBucket();
  69 			String key = getArguments().getString(ARG_ITEM_ID);
  70 			try {
  71     			mNote = notesBucket.get(key);
  72 			} catch (BucketObjectMissingException e) {
  73 				// TODO: Handle a missing note
  74 			}
  75 		}
  76 
  77         if (!((NotesActivity) getActivity()).isLargeScreenLandscape())
  78             mShowNoteTitle = true;
  79 
  80         mAutoSaveHandler = new Handler();
  81 
  82 	}
  83 
  84     @Override
  85 	public View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {
  86 		View rootView = inflater.inflate(R.layout.fragment_note_editor, container, false);
  87 		mContentEditText = ((EditText) rootView.findViewById(R.id.note_content));
  88         mContentEditText.addTextChangedListener(this);
  89         mTagView = (TagsMultiAutoCompleteTextView) rootView.findViewById(R.id.tag_view);
  90         mTagView.setTokenizer(new SpaceTokenizer());
  91 
  92         mPinButton = (ToggleButton) rootView.findViewById(R.id.pinButton);
  93         mPlaceholderView = (LinearLayout) rootView.findViewById(R.id.placeholder);
  94         if (!((NotesActivity) getActivity()).isLargeScreen())
  95             mPlaceholderView.setVisibility(View.GONE);
  96 
  97 		refreshContent();
  98 
  99 		return rootView;
 100 	}
 101 
 102     @Override
 103     public void onResume() {
 104         super.onResume();
 105         mTagView.setOnTagAddedListener(this);
 106         if (mNote != null &amp;&amp; mNote.getContent().isEmpty()) {
 107             // Show soft keyboard
 108             mContentEditText.requestFocus();
 109 
<abbr title=" 110             InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemService(Context.INPUT_METHOD_SERVICE);"> 110             InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemService(C🔵</abbr>
 111             if (inputMethodManager != null)
 112                 inputMethodManager.showSoftInput(mContentEditText, 0);
 113         }
 114     }
 115 
 116     @Override
 117     public void onPause() {
 118         saveAndSyncNote();
 119         mTagView.setOnTagAddedListener(null);
 120         // Hide soft keyboard
<abbr title=" 121         InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemService(Context.INPUT_METHOD_SERVICE);"> 121         InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemService(Conte🔵</abbr>
 122         if (inputMethodManager != null)
 123             inputMethodManager.hideSoftInputFromWindow(mContentEditText.getWindowToken(), 0);
 124 
 125         if (mAutoSaveHandler != null)
 126             mAutoSaveHandler.removeCallbacks(autoSaveRunnable);
 127 
 128         super.onPause();
 129     }
 130 
 131     public void setNote(Note note) {
 132         mPlaceholderView.setVisibility(View.GONE);
 133 
 134         // If we have a note already (on a tablet in landscape), save the note.
 135         if (mNote != null)
 136             saveAndSyncNote();
 137 
 138         mNote = note;
 139         refreshContent();
 140     }
 141 
 142     public void refreshContent() {
 143         if (mNote != null) {
 144             Log.v(&quot;Simplenote&quot;, &quot;refreshing content&quot;);
 145             // Restore the cursor position if possible.
<abbr title=" 146             int cursorPosition = newCursorLocation(mNote.getContent(), mContentEditText.getText().toString(), mContentEditText.getSelectionEnd());"> 146             int cursorPosition = newCursorLocation(mNote.getContent(), mContentEditText.getText().toStrin🔵</abbr>
 147             mContentEditText.setText(mNote.getContent());
 148             if (mContentEditText.hasFocus() &amp;&amp; cursorPosition != mContentEditText.getSelectionEnd())
 149                 mContentEditText.setSelection(cursorPosition);
 150 
 151             mPinButton.setChecked(mNote.isPinned());
 152 
 153             setActionBarTitle();
 154 
 155             updateTagList();
 156         }
 157     }
 158 
 159     public void updateTagList(){
 160         // Populate this note&#x27;s tags in the tagView
 161         mTagView.setChips(mNote.getTagString());
 162 
 163 		// Populate tag list
 164         Simplenote simplenote = (Simplenote)getActivity().getApplication();
 165         Bucket&lt;Tag&gt; tagBucket = simplenote.getTagsBucket();
 166         ObjectCursor&lt;Tag&gt; tagsCursor = tagBucket.query().orderByKey().execute();
 167         List&lt;String&gt; allTags = new ArrayList&lt;String&gt;(tagsCursor.getCount());
 168         while (tagsCursor.moveToNext()) {
 169             Tag tag = tagsCursor.getObject();
 170             if (!mNote.hasTag(tag)) allTags.add(tag.getName());
 171         }
 172         tagsCursor.close();
 173         ArrayAdapter&lt;String&gt; adapter = new ArrayAdapter&lt;String&gt;(getActivity(),
 174                 android.R.layout.simple_dropdown_item_1line, allTags);
 175         mTagView.setAdapter(adapter);
 176     }
 177 
 178     private void setActionBarTitle() {
 179         if (mShowNoteTitle) {
 180             if (mNote.getTitle() != null &amp;&amp; !mNote.getTitle().equals(&quot;&quot;))
 181                 getActivity().getActionBar().setTitle(mNote.getTitle());
 182             else
 183                 getActivity().getActionBar().setTitle(R.string.new_note);
 184         }
 185     }
 186 
 187     int newCursorLocation(String newText, String oldText, int cursorLocation) {
 188         // Ported from the iOS app :)
 189         // Cases:
 190         // 0. All text after cursor (and possibly more) was removed ==&gt; put cursor at end
 191         // 1. Text was added after the cursor ==&gt; no change
 192         // 2. Text was added before the cursor ==&gt; location advances
 193         // 3. Text was removed after the cursor ==&gt; no change
 194         // 4. Text was removed before the cursor ==&gt; location retreats
 195         // 5. Text was added/removed on both sides of the cursor ==&gt; not handled
 196 
 197         int newCursorLocation = cursorLocation;
 198 
 199         int deltaLength = newText.length() - oldText.length();
 200 
 201         // Case 0
 202         if (newText.length() &lt; cursorLocation)
 203             return newText.length();
 204 
 205         boolean beforeCursorMatches = false;
 206         boolean afterCursorMatches = false;
 207 
 208         try {
<abbr title=" 209             beforeCursorMatches = oldText.substring(0, cursorLocation).equals(newText.substring(0, cursorLocation));"> 209             beforeCursorMatches = oldText.substring(0, cursorLocation).equals(newText.substring(0, cursor🔵</abbr>
<abbr title=" 210             afterCursorMatches = oldText.substring(cursorLocation, oldText.length()).equals(newText.substring(cursorLocation + deltaLength, newText.length()));"> 210             afterCursorMatches = oldText.substring(cursorLocation, oldText.length()).equals(newText.subst🔵</abbr>
 211         } catch (Exception e) {
 212             e.printStackTrace();
 213         }
 214 
 215         // Cases 2 and 4
 216         if (!beforeCursorMatches &amp;&amp; afterCursorMatches)
 217             newCursorLocation += deltaLength;
 218 
 219         // Cases 1, 3 and 5 have no change
 220         return newCursorLocation;
 221     }
 222 
 223     private Runnable autoSaveRunnable = new Runnable() {
 224         @Override
 225         public void run() {
 226             saveAndSyncNote();
 227         }
 228     };
 229 
 230     @Override
 231     public void onTagsChanged(String tagString){
 232         mNote.setTagString(tagString);
 233         mNote.setModificationDate(Calendar.getInstance());
 234         updateTagList();
 235         mNote.save();
 236 
 237     }
 238 
 239     @Override
 240     public void beforeTextChanged(CharSequence charSequence, int i, int i2, int i3) {
 241         // Unused
 242     }
 243 
 244     @Override
 245     public void afterTextChanged(Editable editable) {
 246         // Unused
 247 
 248     }
 249 
 250     @Override
 251     public void onTextChanged(CharSequence charSequence, int i, int i2, int i3) {
 252 
 253         // When text changes, start timer that will fire after AUTOSAVE_DELAY_MILLIS passes
 254 
 255         if (mAutoSaveHandler != null) {
 256             mAutoSaveHandler.removeCallbacks(autoSaveRunnable);
 257             mAutoSaveHandler.postDelayed(autoSaveRunnable, AUTOSAVE_DELAY_MILLIS);
 258         }
 259     }
 260 
 261     private void saveAndSyncNote() {
 262         if (mNote == null)
 263             return;
 264 
 265         String content = mContentEditText.getText().toString();
 266         if (mNote.hasChanges(content, mPinButton.isChecked())) {
 267             mNote.setContent(content);
 268             mNote.setTagString(mTagView.getText().toString());
 269             mNote.setModificationDate(Calendar.getInstance());
 270             mNote.setPinned(mPinButton.isChecked());
 271             mNote.save();
 272         }
 273 
 274         setActionBarTitle();
 275 
 276         Log.v(&quot;Simplenote&quot;, &quot;autosaving note&quot;);
 277     }
 278 
 279     public void setPlaceholderVisible(boolean isVisible) {
 280         if (isVisible) {
 281             mNote = null;
 282             mContentEditText.setText(&quot;&quot;);
 283             mTagView.setText(&quot;&quot;);
 284             if (mPlaceholderView != null)
 285                 mPlaceholderView.setVisibility(View.VISIBLE);
 286         } else {
 287             if (mPlaceholderView != null)
 288                 mPlaceholderView.setVisibility(View.GONE);
 289         }
 290     }
 291 
 292     // Use spaces in tag autocompletion list
<abbr title=" 293     // From http://stackoverflow.com/questions/3482981/how-to-replace-the-comma-with-a-space-when-i-use-the-multiautocompletetextview"> 293     // From http://stackoverflow.com/questions/3482981/how-to-replace-the-comma-with-a-space-when-i-use-t🔵</abbr>
 294     public class SpaceTokenizer implements Tokenizer {
 295 
 296         public int findTokenStart(CharSequence text, int cursor) {
 297 			int i = cursor;
 298 
 299 			while (i &gt; 0 &amp;&amp; text.charAt(i - 1) != &#x27; &#x27;) {
 300 			    i--;
 301 			}
 302 			while (i &lt; cursor &amp;&amp; text.charAt(i) == &#x27; &#x27;) {
 303 			    i++;
 304 			}
 305 
 306 			return i;
 307 		}
 308 
 309         public int findTokenEnd(CharSequence text, int cursor) {
 310 			int i = cursor;
 311 			int len = text.length();
 312 
 313 			while (i &lt; len) {
 314 			    if (text.charAt(i) == &#x27; &#x27;) {
 315 			        return i;
 316 			    } else {
 317 			        i++;
 318 			    }
 319 			}
 320 
 321 			return len;
 322 		}
 323 
 324         public CharSequence terminateToken(CharSequence text) {
 325 			int i = text.length();
 326 
 327 			while (i &gt; 0 &amp;&amp; text.charAt(i - 1) == &#x27; &#x27;) {
 328 			    i--;
 329 			}
 330 
 331 			if (i &gt; 0 &amp;&amp; text.charAt(i - 1) == &#x27; &#x27;) {
 332 			    return text;
 333 			} else {
 334 			    if (text instanceof Spanned) {
 335 			        SpannableString sp = new SpannableString(text + &quot; &quot;);
 336 			        TextUtils.copySpansFrom((Spanned) text, 0, text.length(),
 337 			                Object.class, sp, 0);
 338 			        return sp;
 339 			    } else {
 340 			        return text + &quot; &quot;;
 341 			    }
 342 			}
 343 		}
 344     }
 345 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                            <td><pre>   1 package com.automattic.simplenote;
   2 
   3 import android.app.Fragment;
   4 import android.content.Context;
   5 import android.os.Bundle;
   6 import android.os.Handler;
   7 import android.text.Editable;
   8 import android.text.SpannableString;
   9 import android.text.Spanned;
  10 import android.text.TextUtils;
  11 import android.text.TextWatcher;
  12 import android.util.Log;
  13 import android.view.LayoutInflater;
  14 import android.view.View;
  15 import android.view.ViewGroup;
  16 import android.view.inputmethod.InputMethodManager;
  17 import android.widget.ArrayAdapter;
  18 import android.widget.EditText;
  19 import android.widget.LinearLayout;
  20 import android.widget.MultiAutoCompleteTextView.Tokenizer;
  21 import android.widget.ToggleButton;
  22 import com.automattic.simplenote.models.Note;
  23 import com.automattic.simplenote.models.Tag;
  24 import com.automattic.simplenote.utils.TagsMultiAutoCompleteTextView.OnTagAddedListener;
  25 import com.automattic.simplenote.utils.TagsMultiAutoCompleteTextView;
  26 import com.simperium.client.Bucket.ObjectCursor;
  27 import com.simperium.client.Bucket;
  28 import com.simperium.client.BucketObjectMissingException;
  29 import java.util.ArrayList;
  30 import java.util.Arrays;
  31 import java.util.Calendar;
  32 import java.util.List;
  33 
  34 
  35 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  36 public class NoteEditorFragment extends Fragment implements TextWatcher, OnTagAddedListener {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  37 	/**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  38 	 * The fragment argument representing the item ID that this fragment</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  39 	 * represents.</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  40 	 */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  41 	public static final String ARG_ITEM_ID = &quot;item_id&quot;;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  42 </span>
  43 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="  44 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/">  44 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kw🔵</abbr></span>
  45 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  46 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  47 public class NoteEditorFragment extends Fragment implements TextWatcher {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  48     /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  49      * The fragment argument representing the item ID that this fragment</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  50      * represents.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  51      */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  52     public static final String ARG_ITEM_ID = &quot;item_id&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  53 </span>
  54 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
  55     private static final int AUTOSAVE_DELAY_MILLIS = 2000;
  56 
  57     /**
  58      * The dummy content this fragment is presenting.
  59      */
  60     private Note mNote;
  61     private EditText mContentEditText;
  62     private TagsMultiAutoCompleteTextView mTagView;
  63     private ToggleButton mPinButton;
  64     private boolean mShowNoteTitle;
  65     private Handler mAutoSaveHandler;
  66     private LinearLayout mPlaceholderView;
  67 
  68     /**
  69      * Mandatory empty constructor for the fragment manager to instantiate the
  70      * fragment (e.g. upon screen orientation changes).
  71      */
  72     public NoteEditorFragment() {
  73     }
  74 
  75     @Override
  76     public void onCreate(Bundle savedInstanceState) {
  77         super.onCreate(savedInstanceState);
  78 
  79         if (getArguments() != null &amp;&amp; getArguments().containsKey(ARG_ITEM_ID)) {
  80             Simplenote application = (Simplenote) getActivity().getApplication();
  81             Bucket&lt;Note&gt; notesBucket = application.getNotesBucket();
  82             String key = getArguments().getString(ARG_ITEM_ID);
  83             try {
  84                 mNote = notesBucket.get(key);
  85             } catch (BucketObjectMissingException e) {
  86                 // TODO: Handle a missing note
  87             }
  88         }
  89 
  90         if (!((NotesActivity) getActivity()).isLargeScreenLandscape())
  91             mShowNoteTitle = true;
  92 
  93         mAutoSaveHandler = new Handler();
  94 
  95     }
  96 
  97     @Override
  98     public View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {
  99         View rootView = inflater.inflate(R.layout.fragment_note_editor, container, false);
 100         mContentEditText = ((EditText) rootView.findViewById(R.id.note_content));
 101         mContentEditText.addTextChangedListener(this);
 102         mTagView = (TagsMultiAutoCompleteTextView) rootView.findViewById(R.id.tag_view);
 103         mTagView.setTokenizer(new SpaceTokenizer());
 104 
 105         mPinButton = (ToggleButton) rootView.findViewById(R.id.pinButton);
 106         mPlaceholderView = (LinearLayout) rootView.findViewById(R.id.placeholder);
 107         if (!((NotesActivity) getActivity()).isLargeScreen())
 108             mPlaceholderView.setVisibility(View.GONE);
 109 
 110         refreshContent();
 111 
 112 
 113 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 114 		return rootView;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 115 	}</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 116 </span>
 117 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 118 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 118 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kw🔵</abbr></span>
 119 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 120 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 121         // Populate tag list</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 122         Simplenote simplenote = (Simplenote) getActivity().getApplication();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 123         Bucket&lt;Tag&gt; tagBucket = simplenote.getTagsBucket();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 124         ObjectCursor&lt;Tag&gt; tagsCursor = tagBucket.query().orderByKey().execute();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 125         String[] allTags = new String[tagsCursor.getCount()];</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 126         while (tagsCursor.moveToNext()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 127             allTags[tagsCursor.getPosition()] = tagsCursor.getObject().getName();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 128         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 129         tagsCursor.close();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 130         ArrayAdapter&lt;String&gt; adapter = new ArrayAdapter&lt;String&gt;(getActivity(),</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 131                 android.R.layout.simple_dropdown_item_1line, allTags);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 132         mTagView.setAdapter(adapter);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 133         mTagView.setTokenizer(new SpaceTokenizer());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 134 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 135         return rootView;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 136     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 137 </span>
 138 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 139 
 140     @Override
 141     public void onResume() {
 142         super.onResume();
 143         mTagView.setOnTagAddedListener(this);
 144         if (mNote != null &amp;&amp; mNote.getContent().isEmpty()) {
 145             // Show soft keyboard
 146             mContentEditText.requestFocus();
 147 
<abbr title=" 148             InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemService(Context.INPUT_METHOD_SERVICE);"> 148             InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemService(C🔵</abbr>
 149             if (inputMethodManager != null)
 150                 inputMethodManager.showSoftInput(mContentEditText, 0);
 151         }
 152     }
 153 
 154     @Override
 155     public void onPause() {
 156         saveAndSyncNote();
 157         mTagView.setOnTagAddedListener(null);
 158         // Hide soft keyboard
<abbr title=" 159         InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemService(Context.INPUT_METHOD_SERVICE);"> 159         InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemService(Conte🔵</abbr>
 160         if (inputMethodManager != null)
 161             inputMethodManager.hideSoftInputFromWindow(mContentEditText.getWindowToken(), 0);
 162 
 163         if (mAutoSaveHandler != null)
 164             mAutoSaveHandler.removeCallbacks(autoSaveRunnable);
 165 
 166         super.onPause();
 167     }
 168 
 169     public void setNote(Note note) {
 170         mPlaceholderView.setVisibility(View.GONE);
 171 
 172         // If we have a note already (on a tablet in landscape), save the note.
 173         if (mNote != null)
 174             saveAndSyncNote();
 175 
 176         mNote = note;
 177         refreshContent();
 178     }
 179 
 180     public void refreshContent() {
 181         if (mNote != null) {
 182             Log.v(&quot;Simplenote&quot;, &quot;refreshing content&quot;);
 183             // Restore the cursor position if possible.
<abbr title=" 184             int cursorPosition = newCursorLocation(mNote.getContent(), mContentEditText.getText().toString(), mContentEditText.getSelectionEnd());"> 184             int cursorPosition = newCursorLocation(mNote.getContent(), mContentEditText.getText().toStrin🔵</abbr>
 185             mContentEditText.setText(mNote.getContent());
 186             if (mContentEditText.hasFocus() &amp;&amp; cursorPosition != mContentEditText.getSelectionEnd())
 187                 mContentEditText.setSelection(cursorPosition);
 188 
 189             mPinButton.setChecked(mNote.isPinned());
 190 
 191             setActionBarTitle();
 192 
 193             updateTagList();
 194         }
 195     }
 196 
 197     public void updateTagList(){
 198         // Populate this note&#x27;s tags in the tagView
 199         mTagView.setChips(mNote.getTagString());
 200 
 201 		// Populate tag list
 202         Simplenote simplenote = (Simplenote)getActivity().getApplication();
 203         Bucket&lt;Tag&gt; tagBucket = simplenote.getTagsBucket();
 204         ObjectCursor&lt;Tag&gt; tagsCursor = tagBucket.query().orderByKey().execute();
 205         List&lt;String&gt; allTags = new ArrayList&lt;String&gt;(tagsCursor.getCount());
 206         while (tagsCursor.moveToNext()) {
 207             Tag tag = tagsCursor.getObject();
 208             if (!mNote.hasTag(tag)) allTags.add(tag.getName());
 209         }
 210         tagsCursor.close();
 211         ArrayAdapter&lt;String&gt; adapter = new ArrayAdapter&lt;String&gt;(getActivity(),
 212                 android.R.layout.simple_dropdown_item_1line, allTags);
 213         mTagView.setAdapter(adapter);
 214     }
 215 
 216     private void setActionBarTitle() {
 217         if (mShowNoteTitle) {
 218             if (mNote.getTitle() != null &amp;&amp; !mNote.getTitle().equals(&quot;&quot;))
 219                 getActivity().getActionBar().setTitle(mNote.getTitle());
 220             else
 221                 getActivity().getActionBar().setTitle(R.string.new_note);
 222         }
 223     }
 224 
 225     int newCursorLocation(String newText, String oldText, int cursorLocation) {
 226         // Ported from the iOS app :)
 227         // Cases:
 228         // 0. All text after cursor (and possibly more) was removed ==&gt; put cursor at end
 229         // 1. Text was added after the cursor ==&gt; no change
 230         // 2. Text was added before the cursor ==&gt; location advances
 231         // 3. Text was removed after the cursor ==&gt; no change
 232         // 4. Text was removed before the cursor ==&gt; location retreats
 233         // 5. Text was added/removed on both sides of the cursor ==&gt; not handled
 234 
 235         int newCursorLocation = cursorLocation;
 236 
 237         int deltaLength = newText.length() - oldText.length();
 238 
 239         // Case 0
 240         if (newText.length() &lt; cursorLocation)
 241             return newText.length();
 242 
 243         boolean beforeCursorMatches = false;
 244         boolean afterCursorMatches = false;
 245 
 246         try {
<abbr title=" 247             beforeCursorMatches = oldText.substring(0, cursorLocation).equals(newText.substring(0, cursorLocation));"> 247             beforeCursorMatches = oldText.substring(0, cursorLocation).equals(newText.substring(0, cursor🔵</abbr>
<abbr title=" 248             afterCursorMatches = oldText.substring(cursorLocation, oldText.length()).equals(newText.substring(cursorLocation + deltaLength, newText.length()));"> 248             afterCursorMatches = oldText.substring(cursorLocation, oldText.length()).equals(newText.subst🔵</abbr>
 249         } catch (Exception e) {
 250             e.printStackTrace();
 251         }
 252 
 253         // Cases 2 and 4
 254         if (!beforeCursorMatches &amp;&amp; afterCursorMatches)
 255             newCursorLocation += deltaLength;
 256 
 257         // Cases 1, 3 and 5 have no change
 258         return newCursorLocation;
 259     }
 260 
 261     private Runnable autoSaveRunnable = new Runnable() {
 262         @Override
 263         public void run() {
 264             saveAndSyncNote();
 265         }
 266     };
 267 
 268     @Override
 269     public void onTagsChanged(String tagString){
 270         mNote.setTagString(tagString);
 271         mNote.setModificationDate(Calendar.getInstance());
 272         updateTagList();
 273         mNote.save();
 274 
 275     }
 276 
 277     @Override
 278     public void beforeTextChanged(CharSequence charSequence, int i, int i2, int i3) {
 279         // Unused
 280     }
 281 
 282     @Override
 283     public void afterTextChanged(Editable editable) {
 284         // Unused
 285 
 286     }
 287 
 288     @Override
 289     public void onTextChanged(CharSequence charSequence, int i, int i2, int i3) {
 290 
 291         // When text changes, start timer that will fire after AUTOSAVE_DELAY_MILLIS passes
 292 
 293         if (mAutoSaveHandler != null) {
 294             mAutoSaveHandler.removeCallbacks(autoSaveRunnable);
 295             mAutoSaveHandler.postDelayed(autoSaveRunnable, AUTOSAVE_DELAY_MILLIS);
 296         }
 297     }
 298 
 299     private void saveAndSyncNote() {
 300         if (mNote == null)
 301             return;
 302 
 303         String content = mContentEditText.getText().toString();
 304         if (mNote.hasChanges(content, mPinButton.isChecked())) {
 305             mNote.setContent(content);
 306             mNote.setTagString(mTagView.getText().toString());
 307             mNote.setModificationDate(Calendar.getInstance());
 308             mNote.setPinned(mPinButton.isChecked());
 309             mNote.save();
 310         }
 311 
 312         setActionBarTitle();
 313 
 314         Log.v(&quot;Simplenote&quot;, &quot;autosaving note&quot;);
 315     }
 316 
 317     public void setPlaceholderVisible(boolean isVisible) {
 318         if (isVisible) {
 319             mNote = null;
 320             mContentEditText.setText(&quot;&quot;);
 321             mTagView.setText(&quot;&quot;);
 322             if (mPlaceholderView != null)
 323                 mPlaceholderView.setVisibility(View.VISIBLE);
 324         } else {
 325             if (mPlaceholderView != null)
 326                 mPlaceholderView.setVisibility(View.GONE);
 327         }
 328     }
 329 
 330     // Use spaces in tag autocompletion list
<abbr title=" 331     // From http://stackoverflow.com/questions/3482981/how-to-replace-the-comma-with-a-space-when-i-use-the-multiautocompletetextview"> 331     // From http://stackoverflow.com/questions/3482981/how-to-replace-the-comma-with-a-space-when-i-use-t🔵</abbr>
 332     public class SpaceTokenizer implements Tokenizer {
 333 
 334         public int findTokenStart(CharSequence text, int cursor) {
 335             int i = cursor;
 336 
 337             while (i &gt; 0 &amp;&amp; text.charAt(i - 1) != &#x27; &#x27;) {
 338                 i--;
 339             }
 340             while (i &lt; cursor &amp;&amp; text.charAt(i) == &#x27; &#x27;) {
 341                 i++;
 342             }
 343 
 344             return i;
 345         }
 346 
 347         public int findTokenEnd(CharSequence text, int cursor) {
 348             int i = cursor;
 349             int len = text.length();
 350 
 351             while (i &lt; len) {
 352                 if (text.charAt(i) == &#x27; &#x27;) {
 353                     return i;
 354                 } else {
 355                     i++;
 356                 }
 357             }
 358 
 359             return len;
 360         }
 361 
 362         public CharSequence terminateToken(CharSequence text) {
 363             int i = text.length();
 364 
 365             while (i &gt; 0 &amp;&amp; text.charAt(i - 1) == &#x27; &#x27;) {
 366                 i--;
 367             }
 368 
 369             if (i &gt; 0 &amp;&amp; text.charAt(i - 1) == &#x27; &#x27;) {
 370                 return text;
 371             } else {
 372                 if (text instanceof Spanned) {
 373                     SpannableString sp = new SpannableString(text + &quot; &quot;);
 374                     TextUtils.copySpansFrom((Spanned) text, 0, text.length(),
 375                             Object.class, sp, 0);
 376                     return sp;
 377                 } else {
 378                     return text + &quot; &quot;;
 379                 }
 380             }
 381         }
 382     }
 383 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  package com.automattic.simplenote;
   2  
   3  import java.util.ArrayList;
   4  import java.util.Arrays;
   5  import java.util.Calendar;
   6  import java.util.List;
   7  
   8  import android.app.Fragment;
   9  import android.content.Context;
  10  import android.os.Bundle;
  11  import android.os.Handler;
  12  import android.text.Editable;
  13  import android.text.SpannableString;
  14  import android.text.Spanned;
  15  import android.text.TextUtils;
  16  import android.text.TextWatcher;
  17  import android.util.Log;
  18  import android.view.LayoutInflater;
  19  import android.view.View;
  20  import android.view.ViewGroup;
  21  import android.view.inputmethod.InputMethodManager;
  22  import android.widget.ArrayAdapter;
  23  import android.widget.EditText;

  24  import android.widget.MultiAutoCompleteTextView.Tokenizer;
  25  import android.widget.TextView;
  26  import android.widget.ToggleButton;
  27  
  28  import com.automattic.simplenote.models.Note;
  29  import com.automattic.simplenote.models.Tag;
  30  import com.automattic.simplenote.utils.TagsMultiAutoCompleteTextView;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  31 +import com.automattic.simplenote.utils.TagsMultiAutoCompleteTextView.OnTagAddedListener;</span>
  32  import com.simperium.client.Bucket;
  33  import com.simperium.client.Bucket.ObjectCursor;
  34  import com.simperium.client.BucketObjectMissingException;
  35  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  36 -public class NoteEditorFragment extends Fragment implements TextWatcher {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  37 +public class NoteEditorFragment extends Fragment implements TextWatcher, OnTagAddedListener {</span>
  38  	/**
  39  	 * The fragment argument representing the item ID that this fragment
  40  	 * represents.
  41  	 */
  42  	public static final String ARG_ITEM_ID = &quot;item_id&quot;;





  43      private static final int AUTOSAVE_DELAY_MILLIS = 2000;
  44  
  45  	/**
  46  	 * The dummy content this fragment is presenting.
  47  	 */
  48  	private Note mNote;
  49  	private EditText mContentEditText;
  50  	private TagsMultiAutoCompleteTextView mTagView;






  51      private ToggleButton mPinButton;
  52      private boolean mShowNoteTitle;
  53      private Handler mAutoSaveHandler;
  54  
  55  	/**
  56  	 * Mandatory empty constructor for the fragment manager to instantiate the
  57  	 * fragment (e.g. upon screen orientation changes).
  58  	 */
  59  	public NoteEditorFragment() {
  60  	}
  61  
  62  	@Override
  63  	public void onCreate(Bundle savedInstanceState) {
  64  		super.onCreate(savedInstanceState);
  65  
  66  		if (getArguments() != null &amp;&amp; getArguments().containsKey(ARG_ITEM_ID)) {
  67  	        Simplenote application = (Simplenote)getActivity().getApplication();
  68  			Bucket&lt;Note&gt; notesBucket = application.getNotesBucket();
  69  			String key = getArguments().getString(ARG_ITEM_ID);
  70  			try {
  71      			mNote = notesBucket.get(key);
  72  			} catch (BucketObjectMissingException e) {
  73  				// TODO: Handle a missing note
  74  			}
  75  		}
  76  
  77          if (!((NotesActivity)getActivity()).isTwoPane())

























  78              mShowNoteTitle = true;
  79  
  80          mAutoSaveHandler = new Handler();
  81  
  82  	}
  83  
  84      @Override
  85  	public View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {
  86  		View rootView = inflater.inflate(R.layout.fragment_note_editor, container, false);
  87  		mContentEditText = ((EditText) rootView.findViewById(R.id.note_content));






  88          mContentEditText.addTextChangedListener(this);
  89          mTagView = (TagsMultiAutoCompleteTextView) rootView.findViewById(R.id.tag_view);
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  90 +        mTagView.setTokenizer(new SpaceTokenizer());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  91 +</span>
  92          mPinButton = (ToggleButton) rootView.findViewById(R.id.pinButton);
  93  
  94  		refreshContent();
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  95 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  96 -		// Populate tag list</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  97 -        Simplenote simplenote = (Simplenote)getActivity().getApplication();</span>








<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  98 -        Bucket&lt;Tag&gt; tagBucket = simplenote.getTagsBucket();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  99 -        ObjectCursor&lt;Tag&gt; tagsCursor = tagBucket.query().orderByKey().execute();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 100 -		String[] allTags = new String[tagsCursor.getCount()];</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 101 -        while (tagsCursor.moveToNext()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 102 -            allTags[tagsCursor.getPosition()] = tagsCursor.getObject().getName();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 103 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 104 -        tagsCursor.close();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 105 -        ArrayAdapter&lt;String&gt; adapter = new ArrayAdapter&lt;String&gt;(getActivity(),</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 106 -                android.R.layout.simple_dropdown_item_1line, allTags);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 107 -        mTagView.setAdapter(adapter);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 108 -        mTagView.setTokenizer(new SpaceTokenizer());</span>
 109  
 110  		return rootView;
 111  	}


 112  
 113      @Override
 114      public void onResume() {
 115          super.onResume();
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 116 -</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 117 +        mTagView.setOnTagAddedListener(this);</span>
 118          if (mNote != null &amp;&amp; mNote.getContent().isEmpty()) {
 119              // Show soft keyboard
 120              mContentEditText.requestFocus();
 121  
<abbr title=" 122              InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemService(Context.INPUT_METHOD_SERVICE);"> 122              InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemService(Context.IN🔵</abbr>
 123              if (inputMethodManager != null)
 124                  inputMethodManager.showSoftInput(mContentEditText, 0);
 125          }
 126      }
 127  
 128      @Override
 129      public void onPause() {
 130          saveAndSyncNote();
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 131 -</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 132 +        mTagView.setOnTagAddedListener(null);</span>
 133          // Hide soft keyboard
<abbr title=" 134          InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemService(Context.INPUT_METHOD_SERVICE);"> 134          InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemService(Context.INPUT_🔵</abbr>
 135          if (inputMethodManager != null)
 136              inputMethodManager.hideSoftInputFromWindow(mContentEditText.getWindowToken(), 0);
 137  
 138          if (mAutoSaveHandler != null)
 139              mAutoSaveHandler.removeCallbacks(autoSaveRunnable);
 140  
 141          super.onPause();
 142      }
 143  
 144      public void setNote(Note note) {


 145          // If we have a note already (on a tablet in landscape), save the note.
 146          if (mNote != null)
 147              saveAndSyncNote();
 148  
 149          mNote = note;
 150          refreshContent();
 151      }
 152  
 153      public void refreshContent() {
 154          if (mNote != null) {
 155              Log.v(&quot;Simplenote&quot;, &quot;refreshing content&quot;);
 156              // Restore the cursor position if possible.
<abbr title=" 157              int cursorPosition = newCursorLocation(mNote.getContent(), mContentEditText.getText().toString(), mContentEditText.getSelectionEnd());"> 157              int cursorPosition = newCursorLocation(mNote.getContent(), mContentEditText.getText().toString(), mCon🔵</abbr>
 158              mContentEditText.setText(mNote.getContent());
 159              if (mContentEditText.hasFocus() &amp;&amp; cursorPosition != mContentEditText.getSelectionEnd())
 160                  mContentEditText.setSelection(cursorPosition);
 161  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 162 -            // Populate this note&#x27;s tags in the tagView - TODO: nbradbury - for a large list of tags, using a StringBuilder here would be more efficient"> 162 -            // Populate this note&#x27;s tags in the tagView - TODO: nbradbury - for a large list of tags, using a Stri🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 163 -            String tagListString = &quot;&quot;;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 164 -            for (String tag : mNote.getTags())</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 165 -                tagListString += tag + &quot; &quot;;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 166 -            mTagView.setText(tagListString);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 167 -            mTagView.setChips();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 168 -</span>
 169              mPinButton.setChecked(mNote.isPinned());
 170  
 171              setActionBarTitle();
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 172 -        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 173 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 174 +            updateTagList();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 175 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 176 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 177 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 178 +    public void updateTagList(){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 179 +        // Populate this note&#x27;s tags in the tagView</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 180 +        mTagView.setChips(mNote.getTagString());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 181 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 182 +		// Populate tag list</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 183 +        Simplenote simplenote = (Simplenote)getActivity().getApplication();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 184 +        Bucket&lt;Tag&gt; tagBucket = simplenote.getTagsBucket();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 185 +        ObjectCursor&lt;Tag&gt; tagsCursor = tagBucket.query().orderByKey().execute();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 186 +        List&lt;String&gt; allTags = new ArrayList&lt;String&gt;(tagsCursor.getCount());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 187 +        while (tagsCursor.moveToNext()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 188 +            Tag tag = tagsCursor.getObject();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 189 +            if (!mNote.hasTag(tag)) allTags.add(tag.getName());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 190 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 191 +        tagsCursor.close();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 192 +        ArrayAdapter&lt;String&gt; adapter = new ArrayAdapter&lt;String&gt;(getActivity(),</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 193 +                android.R.layout.simple_dropdown_item_1line, allTags);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 194 +        mTagView.setAdapter(adapter);</span>
 195      }
 196  
 197      private void setActionBarTitle() {
 198          if (mShowNoteTitle) {
 199              if (mNote.getTitle() != null &amp;&amp; !mNote.getTitle().equals(&quot;&quot;))
 200                  getActivity().getActionBar().setTitle(mNote.getTitle());
 201              else
 202                  getActivity().getActionBar().setTitle(R.string.new_note);
 203          }
 204      }
 205  
 206      int newCursorLocation(String newText, String oldText, int cursorLocation) {
 207          // Ported from the iOS app :)
 208          // Cases:
 209          // 0. All text after cursor (and possibly more) was removed ==&gt; put cursor at end
 210          // 1. Text was added after the cursor ==&gt; no change
 211          // 2. Text was added before the cursor ==&gt; location advances
 212          // 3. Text was removed after the cursor ==&gt; no change
 213          // 4. Text was removed before the cursor ==&gt; location retreats
 214          // 5. Text was added/removed on both sides of the cursor ==&gt; not handled
 215  
 216          int newCursorLocation = cursorLocation;
 217  
 218          int deltaLength = newText.length() - oldText.length();
 219  
 220          // Case 0
 221          if (newText.length() &lt; cursorLocation)
 222              return newText.length();
 223  
 224          boolean beforeCursorMatches = false;
 225          boolean afterCursorMatches = false;
 226  
 227          try {
<abbr title=" 228              beforeCursorMatches = oldText.substring(0, cursorLocation).equals(newText.substring(0, cursorLocation));"> 228              beforeCursorMatches = oldText.substring(0, cursorLocation).equals(newText.substring(0, cursorLocation)🔵</abbr>
<abbr title=" 229              afterCursorMatches = oldText.substring(cursorLocation, oldText.length()).equals(newText.substring(cursorLocation + deltaLength, newText.length()));"> 229              afterCursorMatches = oldText.substring(cursorLocation, oldText.length()).equals(newText.substring(curs🔵</abbr>
 230          } catch (Exception e) {
 231              e.printStackTrace();
 232          }
 233  
 234          // Cases 2 and 4
 235          if (!beforeCursorMatches &amp;&amp; afterCursorMatches)
 236              newCursorLocation += deltaLength;
 237  
 238          // Cases 1, 3 and 5 have no change
 239          return newCursorLocation;
 240      }
 241  
 242      private Runnable autoSaveRunnable = new Runnable() {
 243          @Override
 244          public void run() {
 245              saveAndSyncNote();
 246          }
 247      };
 248  
 249      @Override
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 250 +    public void onTagsChanged(String tagString){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 251 +        mNote.setTagString(tagString);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 252 +        mNote.setModificationDate(Calendar.getInstance());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 253 +        updateTagList();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 254 +        mNote.save();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 255 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 256 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 257 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 258 +    @Override</span>
 259      public void beforeTextChanged(CharSequence charSequence, int i, int i2, int i3) {
 260          // Unused
 261      }
 262  
 263      @Override
 264      public void afterTextChanged(Editable editable) {
 265          // Unused
 266  
 267      }
 268  
 269      @Override
 270      public void onTextChanged(CharSequence charSequence, int i, int i2, int i3) {
 271  
 272          // When text changes, start timer that will fire after AUTOSAVE_DELAY_MILLIS passes
 273  
 274          if (mAutoSaveHandler != null) {
 275              mAutoSaveHandler.removeCallbacks(autoSaveRunnable);
 276              mAutoSaveHandler.postDelayed(autoSaveRunnable, AUTOSAVE_DELAY_MILLIS);
 277          }
 278      }
 279  
 280      private void saveAndSyncNote() {
 281          if (mNote == null)
 282              return;
 283  
 284          String content = mContentEditText.getText().toString();
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 285 -        String tagString = mTagView.getText().toString().trim();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 286 -        List&lt;String&gt; tagList = Arrays.asList(tagString.split(&quot; &quot;));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 287 -        ArrayList&lt;String&gt; tags = tagString.equals(&quot;&quot;) ? new ArrayList&lt;String&gt;() : new ArrayList&lt;String&gt;(tagList);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 288 -        if (mNote.hasChanges(content, tags, mPinButton.isChecked())) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 289 +        if (mNote.hasChanges(content, mPinButton.isChecked())) {</span>
 290              mNote.setContent(content);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 291 -            mNote.setTags(tags);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 292 +            mNote.setTagString(mTagView.getText().toString());</span>
 293              mNote.setModificationDate(Calendar.getInstance());
 294              mNote.setPinned(mPinButton.isChecked());
 295              mNote.save();
 296          }
 297  
 298          setActionBarTitle();
 299  
 300          Log.v(&quot;Simplenote&quot;, &quot;autosaving note&quot;);
 301      }
 302  













 303      // Use spaces in tag autocompletion list
<abbr title=" 304  	// From http://stackoverflow.com/questions/3482981/how-to-replace-the-comma-with-a-space-when-i-use-the-multiautocompletetextview"> 304  	// From http://stackoverflow.com/questions/3482981/how-to-replace-the-comma-with-a-space-when-i-use-the-multiauto🔵</abbr>
 305  	public class SpaceTokenizer implements Tokenizer {
 306  
 307  		public int findTokenStart(CharSequence text, int cursor) {
 308  			int i = cursor;
 309  
 310  			while (i &gt; 0 &amp;&amp; text.charAt(i - 1) != &#x27; &#x27;) {
 311  			    i--;
 312  			}
 313  			while (i &lt; cursor &amp;&amp; text.charAt(i) == &#x27; &#x27;) {
 314  			    i++;
 315  			}
 316  
 317  			return i;
 318  		}
 319  
 320  		public int findTokenEnd(CharSequence text, int cursor) {
 321  			int i = cursor;
 322  			int len = text.length();
 323  
 324  			while (i &lt; len) {
 325  			    if (text.charAt(i) == &#x27; &#x27;) {
 326  			        return i;
 327  			    } else {
 328  			        i++;
 329  			    }
 330  			}
 331  
 332  			return len;
 333  		}
 334  
 335  		public CharSequence terminateToken(CharSequence text) {
 336  			int i = text.length();
 337  
 338  			while (i &gt; 0 &amp;&amp; text.charAt(i - 1) == &#x27; &#x27;) {
 339  			    i--;
 340  			}
 341  
 342  			if (i &gt; 0 &amp;&amp; text.charAt(i - 1) == &#x27; &#x27;) {
 343  			    return text;
 344  			} else {
 345  			    if (text instanceof Spanned) {
 346  			        SpannableString sp = new SpannableString(text + &quot; &quot;);
 347  			        TextUtils.copySpansFrom((Spanned) text, 0, text.length(),
 348  			                Object.class, sp, 0);
 349  			        return sp;
 350  			    } else {
 351  			        return text + &quot; &quot;;
 352  			    }
 353  			}
 354  		}
 355  	}




















































 356  }</pre></td>
                            <td><pre>   1  package com.automattic.simplenote;
   2  
   3  import java.util.ArrayList;
   4  import java.util.Arrays;
   5  import java.util.Calendar;
   6  import java.util.List;
   7  
   8  import android.app.Fragment;
   9  import android.content.Context;
  10  import android.os.Bundle;
  11  import android.os.Handler;
  12  import android.text.Editable;
  13  import android.text.SpannableString;
  14  import android.text.Spanned;
  15  import android.text.TextUtils;
  16  import android.text.TextWatcher;
  17  import android.util.Log;
  18  import android.view.LayoutInflater;
  19  import android.view.View;
  20  import android.view.ViewGroup;
  21  import android.view.inputmethod.InputMethodManager;
  22  import android.widget.ArrayAdapter;
  23  import android.widget.EditText;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  24 +import android.widget.LinearLayout;</span>
  25  import android.widget.MultiAutoCompleteTextView.Tokenizer;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  26 -import android.widget.TextView;</span>
  27  import android.widget.ToggleButton;
  28  
  29  import com.automattic.simplenote.models.Note;
  30  import com.automattic.simplenote.models.Tag;
  31  import com.automattic.simplenote.utils.TagsMultiAutoCompleteTextView;

  32  import com.simperium.client.Bucket;
  33  import com.simperium.client.Bucket.ObjectCursor;
  34  import com.simperium.client.BucketObjectMissingException;
  35  
  36  public class NoteEditorFragment extends Fragment implements TextWatcher {

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  37 -	/**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  38 -	 * The fragment argument representing the item ID that this fragment</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  39 -	 * represents.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  40 -	 */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  41 -	public static final String ARG_ITEM_ID = &quot;item_id&quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  42 +    /**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  43 +     * The fragment argument representing the item ID that this fragment</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  44 +     * represents.</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  45 +     */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  46 +    public static final String ARG_ITEM_ID = &quot;item_id&quot;;</span>
  47      private static final int AUTOSAVE_DELAY_MILLIS = 2000;
  48  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  49 -	/**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  50 -	 * The dummy content this fragment is presenting.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  51 -	 */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  52 -	private Note mNote;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  53 -	private EditText mContentEditText;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  54 -	private TagsMultiAutoCompleteTextView mTagView;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  55 +    /**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  56 +     * The dummy content this fragment is presenting.</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  57 +     */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  58 +    private Note mNote;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  59 +    private EditText mContentEditText;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  60 +    private TagsMultiAutoCompleteTextView mTagView;</span>
  61      private ToggleButton mPinButton;
  62      private boolean mShowNoteTitle;
  63      private Handler mAutoSaveHandler;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  64 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  65 -	/**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  66 -	 * Mandatory empty constructor for the fragment manager to instantiate the</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  67 -	 * fragment (e.g. upon screen orientation changes).</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  68 -	 */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  69 -	public NoteEditorFragment() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  70 -	}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  71 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  72 -	@Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  73 -	public void onCreate(Bundle savedInstanceState) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  74 -		super.onCreate(savedInstanceState);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  75 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  76 -		if (getArguments() != null &amp;&amp; getArguments().containsKey(ARG_ITEM_ID)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  77 -	        Simplenote application = (Simplenote)getActivity().getApplication();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  78 -			Bucket&lt;Note&gt; notesBucket = application.getNotesBucket();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  79 -			String key = getArguments().getString(ARG_ITEM_ID);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  80 -			try {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  81 -    			mNote = notesBucket.get(key);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  82 -			} catch (BucketObjectMissingException e) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  83 -				// TODO: Handle a missing note</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  84 -			}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  85 -		}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  86 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  87 -        if (!((NotesActivity)getActivity()).isTwoPane())</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  88 +    private LinearLayout mPlaceholderView;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  89 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  90 +    /**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  91 +     * Mandatory empty constructor for the fragment manager to instantiate the</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  92 +     * fragment (e.g. upon screen orientation changes).</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  93 +     */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  94 +    public NoteEditorFragment() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  95 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  96 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  97 +    @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  98 +    public void onCreate(Bundle savedInstanceState) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  99 +        super.onCreate(savedInstanceState);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 100 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 101 +        if (getArguments() != null &amp;&amp; getArguments().containsKey(ARG_ITEM_ID)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 102 +            Simplenote application = (Simplenote) getActivity().getApplication();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 103 +            Bucket&lt;Note&gt; notesBucket = application.getNotesBucket();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 104 +            String key = getArguments().getString(ARG_ITEM_ID);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 105 +            try {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 106 +                mNote = notesBucket.get(key);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 107 +            } catch (BucketObjectMissingException e) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 108 +                // TODO: Handle a missing note</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 109 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 110 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 111 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 112 +        if (!((NotesActivity) getActivity()).isLargeScreenLandscape())</span>
 113              mShowNoteTitle = true;
 114  
 115          mAutoSaveHandler = new Handler();
 116  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 117 -	}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 118 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 119 -    @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 120 -	public View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 121 -		View rootView = inflater.inflate(R.layout.fragment_note_editor, container, false);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 122 -		mContentEditText = ((EditText) rootView.findViewById(R.id.note_content));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 123 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 124 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 125 +    @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 126 +    public View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 127 +        View rootView = inflater.inflate(R.layout.fragment_note_editor, container, false);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 128 +        mContentEditText = ((EditText) rootView.findViewById(R.id.note_content));</span>
 129          mContentEditText.addTextChangedListener(this);
 130          mTagView = (TagsMultiAutoCompleteTextView) rootView.findViewById(R.id.tag_view);


 131          mPinButton = (ToggleButton) rootView.findViewById(R.id.pinButton);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 132 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 133 -		refreshContent();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 134 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 135 -		// Populate tag list</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 136 -        Simplenote simplenote = (Simplenote)getActivity().getApplication();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 137 +        mPlaceholderView = (LinearLayout) rootView.findViewById(R.id.placeholder);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 138 +        if (!((NotesActivity) getActivity()).isLargeScreen())</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 139 +            mPlaceholderView.setVisibility(View.GONE);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 140 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 141 +        refreshContent();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 142 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 143 +        // Populate tag list</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 144 +        Simplenote simplenote = (Simplenote) getActivity().getApplication();</span>
 145          Bucket&lt;Tag&gt; tagBucket = simplenote.getTagsBucket();
 146          ObjectCursor&lt;Tag&gt; tagsCursor = tagBucket.query().orderByKey().execute();
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 147 -		String[] allTags = new String[tagsCursor.getCount()];</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 148 +        String[] allTags = new String[tagsCursor.getCount()];</span>
 149          while (tagsCursor.moveToNext()) {
 150              allTags[tagsCursor.getPosition()] = tagsCursor.getObject().getName();
 151          }
 152          tagsCursor.close();
 153          ArrayAdapter&lt;String&gt; adapter = new ArrayAdapter&lt;String&gt;(getActivity(),
 154                  android.R.layout.simple_dropdown_item_1line, allTags);
 155          mTagView.setAdapter(adapter);
 156          mTagView.setTokenizer(new SpaceTokenizer());
 157  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 158 -		return rootView;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 159 -	}</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 160 +        return rootView;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 161 +    }</span>
 162  
 163      @Override
 164      public void onResume() {
 165          super.onResume();
 166  

 167          if (mNote != null &amp;&amp; mNote.getContent().isEmpty()) {
 168              // Show soft keyboard
 169              mContentEditText.requestFocus();
 170  
<abbr title=" 171              InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemService(Context.INPUT_METHOD_SERVICE);"> 171              InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemService(Context.IN🔵</abbr>
 172              if (inputMethodManager != null)
 173                  inputMethodManager.showSoftInput(mContentEditText, 0);
 174          }
 175      }
 176  
 177      @Override
 178      public void onPause() {
 179          saveAndSyncNote();
 180  

 181          // Hide soft keyboard
<abbr title=" 182          InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemService(Context.INPUT_METHOD_SERVICE);"> 182          InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemService(Context.INPUT_🔵</abbr>
 183          if (inputMethodManager != null)
 184              inputMethodManager.hideSoftInputFromWindow(mContentEditText.getWindowToken(), 0);
 185  
 186          if (mAutoSaveHandler != null)
 187              mAutoSaveHandler.removeCallbacks(autoSaveRunnable);
 188  
 189          super.onPause();
 190      }
 191  
 192      public void setNote(Note note) {
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 193 +        mPlaceholderView.setVisibility(View.GONE);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 194 +</span>
 195          // If we have a note already (on a tablet in landscape), save the note.
 196          if (mNote != null)
 197              saveAndSyncNote();
 198  
 199          mNote = note;
 200          refreshContent();
 201      }
 202  
 203      public void refreshContent() {
 204          if (mNote != null) {
 205              Log.v(&quot;Simplenote&quot;, &quot;refreshing content&quot;);
 206              // Restore the cursor position if possible.
<abbr title=" 207              int cursorPosition = newCursorLocation(mNote.getContent(), mContentEditText.getText().toString(), mContentEditText.getSelectionEnd());"> 207              int cursorPosition = newCursorLocation(mNote.getContent(), mContentEditText.getText().toString(), mCon🔵</abbr>
 208              mContentEditText.setText(mNote.getContent());
 209              if (mContentEditText.hasFocus() &amp;&amp; cursorPosition != mContentEditText.getSelectionEnd())
 210                  mContentEditText.setSelection(cursorPosition);
 211  
<abbr title=" 212              // Populate this note&#x27;s tags in the tagView - TODO: nbradbury - for a large list of tags, using a StringBuilder here would be more efficient"> 212              // Populate this note&#x27;s tags in the tagView - TODO: nbradbury - for a large list of tags, using a Stri🔵</abbr>
 213              String tagListString = &quot;&quot;;
 214              for (String tag : mNote.getTags())
 215                  tagListString += tag + &quot; &quot;;
 216              mTagView.setText(tagListString);
 217              mTagView.setChips();
 218  
 219              mPinButton.setChecked(mNote.isPinned());
 220  
 221              setActionBarTitle();
 222          }






















 223      }
 224  
 225      private void setActionBarTitle() {
 226          if (mShowNoteTitle) {
 227              if (mNote.getTitle() != null &amp;&amp; !mNote.getTitle().equals(&quot;&quot;))
 228                  getActivity().getActionBar().setTitle(mNote.getTitle());
 229              else
 230                  getActivity().getActionBar().setTitle(R.string.new_note);
 231          }
 232      }
 233  
 234      int newCursorLocation(String newText, String oldText, int cursorLocation) {
 235          // Ported from the iOS app :)
 236          // Cases:
 237          // 0. All text after cursor (and possibly more) was removed ==&gt; put cursor at end
 238          // 1. Text was added after the cursor ==&gt; no change
 239          // 2. Text was added before the cursor ==&gt; location advances
 240          // 3. Text was removed after the cursor ==&gt; no change
 241          // 4. Text was removed before the cursor ==&gt; location retreats
 242          // 5. Text was added/removed on both sides of the cursor ==&gt; not handled
 243  
 244          int newCursorLocation = cursorLocation;
 245  
 246          int deltaLength = newText.length() - oldText.length();
 247  
 248          // Case 0
 249          if (newText.length() &lt; cursorLocation)
 250              return newText.length();
 251  
 252          boolean beforeCursorMatches = false;
 253          boolean afterCursorMatches = false;
 254  
 255          try {
<abbr title=" 256              beforeCursorMatches = oldText.substring(0, cursorLocation).equals(newText.substring(0, cursorLocation));"> 256              beforeCursorMatches = oldText.substring(0, cursorLocation).equals(newText.substring(0, cursorLocation)🔵</abbr>
<abbr title=" 257              afterCursorMatches = oldText.substring(cursorLocation, oldText.length()).equals(newText.substring(cursorLocation + deltaLength, newText.length()));"> 257              afterCursorMatches = oldText.substring(cursorLocation, oldText.length()).equals(newText.substring(curs🔵</abbr>
 258          } catch (Exception e) {
 259              e.printStackTrace();
 260          }
 261  
 262          // Cases 2 and 4
 263          if (!beforeCursorMatches &amp;&amp; afterCursorMatches)
 264              newCursorLocation += deltaLength;
 265  
 266          // Cases 1, 3 and 5 have no change
 267          return newCursorLocation;
 268      }
 269  
 270      private Runnable autoSaveRunnable = new Runnable() {
 271          @Override
 272          public void run() {
 273              saveAndSyncNote();
 274          }
 275      };
 276  
 277      @Override









 278      public void beforeTextChanged(CharSequence charSequence, int i, int i2, int i3) {
 279          // Unused
 280      }
 281  
 282      @Override
 283      public void afterTextChanged(Editable editable) {
 284          // Unused
 285  
 286      }
 287  
 288      @Override
 289      public void onTextChanged(CharSequence charSequence, int i, int i2, int i3) {
 290  
 291          // When text changes, start timer that will fire after AUTOSAVE_DELAY_MILLIS passes
 292  
 293          if (mAutoSaveHandler != null) {
 294              mAutoSaveHandler.removeCallbacks(autoSaveRunnable);
 295              mAutoSaveHandler.postDelayed(autoSaveRunnable, AUTOSAVE_DELAY_MILLIS);
 296          }
 297      }
 298  
 299      private void saveAndSyncNote() {
 300          if (mNote == null)
 301              return;
 302  
 303          String content = mContentEditText.getText().toString();
 304          String tagString = mTagView.getText().toString().trim();
 305          List&lt;String&gt; tagList = Arrays.asList(tagString.split(&quot; &quot;));
 306          ArrayList&lt;String&gt; tags = tagString.equals(&quot;&quot;) ? new ArrayList&lt;String&gt;() : new ArrayList&lt;String&gt;(tagList);
 307          if (mNote.hasChanges(content, tags, mPinButton.isChecked())) {

 308              mNote.setContent(content);
 309              mNote.setTags(tags);

 310              mNote.setModificationDate(Calendar.getInstance());
 311              mNote.setPinned(mPinButton.isChecked());
 312              mNote.save();
 313          }
 314  
 315          setActionBarTitle();
 316  
 317          Log.v(&quot;Simplenote&quot;, &quot;autosaving note&quot;);
 318      }
 319  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 320 +    public void setPlaceholderVisible(boolean isVisible) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 321 +        if (isVisible) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 322 +            mNote = null;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 323 +            mContentEditText.setText(&quot;&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 324 +            mTagView.setText(&quot;&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 325 +            if (mPlaceholderView != null)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 326 +                mPlaceholderView.setVisibility(View.VISIBLE);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 327 +        } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 328 +            if (mPlaceholderView != null)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 329 +                mPlaceholderView.setVisibility(View.GONE);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 330 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 331 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 332 +</span>
 333      // Use spaces in tag autocompletion list
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 334 -	// From http://stackoverflow.com/questions/3482981/how-to-replace-the-comma-with-a-space-when-i-use-the-multiautocompletetextview"> 334 -	// From http://stackoverflow.com/questions/3482981/how-to-replace-the-comma-with-a-space-when-i-use-the-multiauto🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 335 -	public class SpaceTokenizer implements Tokenizer {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 336 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 337 -		public int findTokenStart(CharSequence text, int cursor) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 338 -			int i = cursor;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 339 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 340 -			while (i &gt; 0 &amp;&amp; text.charAt(i - 1) != &#x27; &#x27;) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 341 -			    i--;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 342 -			}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 343 -			while (i &lt; cursor &amp;&amp; text.charAt(i) == &#x27; &#x27;) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 344 -			    i++;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 345 -			}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 346 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 347 -			return i;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 348 -		}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 349 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 350 -		public int findTokenEnd(CharSequence text, int cursor) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 351 -			int i = cursor;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 352 -			int len = text.length();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 353 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 354 -			while (i &lt; len) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 355 -			    if (text.charAt(i) == &#x27; &#x27;) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 356 -			        return i;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 357 -			    } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 358 -			        i++;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 359 -			    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 360 -			}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 361 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 362 -			return len;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 363 -		}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 364 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 365 -		public CharSequence terminateToken(CharSequence text) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 366 -			int i = text.length();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 367 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 368 -			while (i &gt; 0 &amp;&amp; text.charAt(i - 1) == &#x27; &#x27;) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 369 -			    i--;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 370 -			}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 371 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 372 -			if (i &gt; 0 &amp;&amp; text.charAt(i - 1) == &#x27; &#x27;) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 373 -			    return text;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 374 -			} else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 375 -			    if (text instanceof Spanned) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 376 -			        SpannableString sp = new SpannableString(text + &quot; &quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 377 -			        TextUtils.copySpansFrom((Spanned) text, 0, text.length(),</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 378 -			                Object.class, sp, 0);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 379 -			        return sp;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 380 -			    } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 381 -			        return text + &quot; &quot;;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 382 -			    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 383 -			}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 384 -		}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 385 -	}</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 386 +    // From http://stackoverflow.com/questions/3482981/how-to-replace-the-comma-with-a-space-when-i-use-the-multiautocompletetextview"> 386 +    // From http://stackoverflow.com/questions/3482981/how-to-replace-the-comma-with-a-space-when-i-use-the-multia🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 387 +    public class SpaceTokenizer implements Tokenizer {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 388 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 389 +        public int findTokenStart(CharSequence text, int cursor) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 390 +            int i = cursor;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 391 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 392 +            while (i &gt; 0 &amp;&amp; text.charAt(i - 1) != &#x27; &#x27;) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 393 +                i--;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 394 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 395 +            while (i &lt; cursor &amp;&amp; text.charAt(i) == &#x27; &#x27;) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 396 +                i++;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 397 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 398 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 399 +            return i;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 400 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 401 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 402 +        public int findTokenEnd(CharSequence text, int cursor) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 403 +            int i = cursor;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 404 +            int len = text.length();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 405 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 406 +            while (i &lt; len) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 407 +                if (text.charAt(i) == &#x27; &#x27;) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 408 +                    return i;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 409 +                } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 410 +                    i++;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 411 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 412 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 413 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 414 +            return len;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 415 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 416 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 417 +        public CharSequence terminateToken(CharSequence text) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 418 +            int i = text.length();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 419 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 420 +            while (i &gt; 0 &amp;&amp; text.charAt(i - 1) == &#x27; &#x27;) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 421 +                i--;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 422 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 423 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 424 +            if (i &gt; 0 &amp;&amp; text.charAt(i - 1) == &#x27; &#x27;) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 425 +                return text;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 426 +            } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 427 +                if (text instanceof Spanned) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 428 +                    SpannableString sp = new SpannableString(text + &quot; &quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 429 +                    TextUtils.copySpansFrom((Spanned) text, 0, text.length(),</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 430 +                            Object.class, sp, 0);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 431 +                    return sp;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 432 +                } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 433 +                    return text + &quot; &quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 434 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 435 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 436 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 437 +    }</span>
 438  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            