<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>6</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        .highlighted {
                            background-color: rgba(177, 82, 227, 0.85) !important;
                        }
                    </style>
                    <script>
                        function enter(c) {
                            const lines = document.getElementsByClassName(c);
                            for (let i = 0; i < lines.length; i++) {
                               lines.item(i).classList.add('highlighted');
                            }
                        }
                        function out(c) {
                            const lines = document.getElementsByClassName(c);
                            for (let i = 0; i < lines.length; i++) {
                               lines.item(i).classList.remove('highlighted');
                            }
                        }
                    </script>
              </head>
              <body>
                <span style="height: 4vh">
                    6
                    <a href="5.html">prev</a>
                    <a href="7.html">next</a>
                    <a href="6_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    AriaLyy/Aria_102d3ba0f641e26d0a6e82b0506f600ea40244dd_PublicComponent/src/main/java/com/arialyy/aria/core/common/RecordHandler.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\AriaLyy\Aria show &quot;102d3ba0f641e26d0a6e82b0506f600ea40244dd:PublicComponent/src/main/java/com/arialyy/aria/core/common/RecordHandler.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\AriaLyy\Aria show &quot;102d3ba0f641e26d0a6e82b0506f600ea40244dd^1:PublicComponent/src/main/java/com/arialyy/aria/core/common/RecordHandler.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\AriaLyy\Aria show &quot;102d3ba0f641e26d0a6e82b0506f600ea40244dd^2:PublicComponent/src/main/java/com/arialyy/aria/core/common/RecordHandler.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\AriaLyy\Aria show &quot;0cb5d3e68461842509c569f76610654b8d5e6298:PublicComponent/src/main/java/com/arialyy/aria/core/common/RecordHandler.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[b], [bj]], subset: [[b], [bj]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre><span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style="">   1 /*                                                                                                       </span>
<span class="-4176855950178531235" onmouseenter="enter('-4176855950178531235');" onmouseout="out('-4176855950178531235');" style="">   2  * Copyright (C) 2016 AriaLyy(https://github.com/AriaLyy/Aria)                                           </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">   3  *                                                                                                       </span>
<span class="-7144700690364548245" onmouseenter="enter('-7144700690364548245');" onmouseout="out('-7144700690364548245');" style="">   4  * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);                                       </span>
<span class="-6614298523444173250" onmouseenter="enter('-6614298523444173250');" onmouseout="out('-6614298523444173250');" style="">   5  * you may not use this file except in compliance with the License.                                      </span>
<span class="-4753901504248728101" onmouseenter="enter('-4753901504248728101');" onmouseout="out('-4753901504248728101');" style="">   6  * You may obtain a copy of the License at                                                               </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">   7  *                                                                                                       </span>
<span class="-763207030729826407" onmouseenter="enter('-763207030729826407');" onmouseout="out('-763207030729826407');" style="">   8  *      http://www.apache.org/licenses/LICENSE-2.0                                                       </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">   9  *                                                                                                       </span>
<span class="2557607632756179983" onmouseenter="enter('2557607632756179983');" onmouseout="out('2557607632756179983');" style="">  10  * Unless required by applicable law or agreed to in writing, software                                   </span>
<span class="-9189129105512731955" onmouseenter="enter('-9189129105512731955');" onmouseout="out('-9189129105512731955');" style="">  11  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,                                     </span>
<span class="5781161717946418340" onmouseenter="enter('5781161717946418340');" onmouseout="out('5781161717946418340');" style="">  12  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.                              </span>
<span class="1761562277992059393" onmouseenter="enter('1761562277992059393');" onmouseout="out('1761562277992059393');" style="">  13  * See the License for the specific language governing permissions and                                   </span>
<span class="7217408601297779962" onmouseenter="enter('7217408601297779962');" onmouseout="out('7217408601297779962');" style="">  14  * limitations under the License.                                                                        </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  15  */                                                                                                      </span>
<span class="-5592048915404489240" onmouseenter="enter('-5592048915404489240');" onmouseout="out('-5592048915404489240');" style="">  16 package com.arialyy.aria.core.common;                                                                    </span>
<span  style="">  17                                                                                                          </span>
<span class="7150685219957576571" onmouseenter="enter('7150685219957576571');" onmouseout="out('7150685219957576571');" style="">  18 import com.arialyy.aria.core.TaskRecord;                                                                 </span>
<span class="-7662986158836731995" onmouseenter="enter('-7662986158836731995');" onmouseout="out('-7662986158836731995');" style="">  19 import com.arialyy.aria.core.ThreadRecord;                                                               </span>
<span class="1932658903610588883" onmouseenter="enter('1932658903610588883');" onmouseout="out('1932658903610588883');" style="">  20 import com.arialyy.aria.core.download.DownloadEntity;                                                    </span>
<span class="-3079874842134488668" onmouseenter="enter('-3079874842134488668');" onmouseout="out('-3079874842134488668');" style="">  21 import com.arialyy.aria.core.loader.ILoaderVisitor;                                                      </span>
<span class="-9014417511727405835" onmouseenter="enter('-9014417511727405835');" onmouseout="out('-9014417511727405835');" style="">  22 import com.arialyy.aria.core.loader.IRecordHandler;                                                      </span>
<span class="-5831681804875068292" onmouseenter="enter('-5831681804875068292');" onmouseout="out('-5831681804875068292');" style="">  23 import com.arialyy.aria.core.upload.UploadEntity;                                                        </span>
<span class="-2181497863142513098" onmouseenter="enter('-2181497863142513098');" onmouseout="out('-2181497863142513098');" style="">  24 import com.arialyy.aria.core.wrapper.AbsTaskWrapper;                                                     </span>
<span class="2481088621669901079" onmouseenter="enter('2481088621669901079');" onmouseout="out('2481088621669901079');" style="">  25 import com.arialyy.aria.core.wrapper.ITaskWrapper;                                                       </span>
<span class="-4361229816664464434" onmouseenter="enter('-4361229816664464434');" onmouseout="out('-4361229816664464434');" style="">  26 import com.arialyy.aria.core.wrapper.RecordWrapper;                                                      </span>
<span class="-4499301116755301031" onmouseenter="enter('-4499301116755301031');" onmouseout="out('-4499301116755301031');" style="">  27 import com.arialyy.aria.orm.DbEntity;                                                                    </span>
<span class="-3586495952513455611" onmouseenter="enter('-3586495952513455611');" onmouseout="out('-3586495952513455611');" style="">  28 import com.arialyy.aria.util.ALog;                                                                       </span>
<span class="-3106139894727218967" onmouseenter="enter('-3106139894727218967');" onmouseout="out('-3106139894727218967');" style="">  29 import com.arialyy.aria.util.CommonUtil;                                                                 </span>
<span class="-5216410147421847074" onmouseenter="enter('-5216410147421847074');" onmouseout="out('-5216410147421847074');" style="">  30 import com.arialyy.aria.util.DbDataHelper;                                                               </span>
<span class="-563266023018163236" onmouseenter="enter('-563266023018163236');" onmouseout="out('-563266023018163236');" style="">  31 import com.arialyy.aria.util.FileUtil;                                                                   </span>
<span class="-3926401431737521278" onmouseenter="enter('-3926401431737521278');" onmouseout="out('-3926401431737521278');" style="">  32 import java.io.File;                                                                                     </span>
<span class="-1320562196372945707" onmouseenter="enter('-1320562196372945707');" onmouseout="out('-1320562196372945707');" style="">  33 import java.util.HashSet;                                                                                </span>
<span class="-1786020958497218848" onmouseenter="enter('-1786020958497218848');" onmouseout="out('-1786020958497218848');" style="">  34 import java.util.List;                                                                                   </span>
<span class="1689171550873420012" onmouseenter="enter('1689171550873420012');" onmouseout="out('1689171550873420012');" style="">  35 import java.util.Properties;                                                                             </span>
<span class="3384353015976675773" onmouseenter="enter('3384353015976675773');" onmouseout="out('3384353015976675773');" style="">  36 import java.util.Set;                                                                                    </span>
<span  style="">  37                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  38 /**                                                                                                      </span>
<span class="2736882465778481894" onmouseenter="enter('2736882465778481894');" onmouseout="out('2736882465778481894');" style="">  39  * 处理任务记录，分配线程区间                                                                                         </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  40  */                                                                                                      </span>
<span class="4487114878540249679" onmouseenter="enter('4487114878540249679');" onmouseout="out('4487114878540249679');" style="">  41 public abstract class RecordHandler implements IRecordHandler {                                          </span>
<span class="-6385414676469589348" onmouseenter="enter('-6385414676469589348');" onmouseout="out('-6385414676469589348');" style="">  42   protected final String TAG = CommonUtil.getClassName(this);                                            </span>
<span  style="">  43                                                                                                          </span>
<span class="-6913167534336436900" onmouseenter="enter('-6913167534336436900');" onmouseout="out('-6913167534336436900');" style="">  44   @Deprecated private File mConfigFile;                                                                  </span>
<span class="-8877097513462838969" onmouseenter="enter('-8877097513462838969');" onmouseout="out('-8877097513462838969');" style="">  45   private TaskRecord mTaskRecord;                                                                        </span>
<span class="-8022183237541885590" onmouseenter="enter('-8022183237541885590');" onmouseout="out('-8022183237541885590');" style="">  46   private AbsTaskWrapper mTaskWrapper;                                                                   </span>
<span class="-2477248167481204479" onmouseenter="enter('-2477248167481204479');" onmouseout="out('-2477248167481204479');" style="">  47   private AbsNormalEntity mEntity;                                                                       </span>
<span  style="">  48                                                                                                          </span>
<span class="-4800954456425527235" onmouseenter="enter('-4800954456425527235');" onmouseout="out('-4800954456425527235');" style="">  49   public RecordHandler(AbsTaskWrapper wrapper) {                                                         </span>
<span class="-4483703319181095288" onmouseenter="enter('-4483703319181095288');" onmouseout="out('-4483703319181095288');" style="">  50     mTaskWrapper = wrapper;                                                                              </span>
<span class="-2477156305516257248" onmouseenter="enter('-2477156305516257248');" onmouseout="out('-2477156305516257248');" style="">  51     mEntity = (AbsNormalEntity) mTaskWrapper.getEntity();                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  52   }                                                                                                      </span>
<span  style="">  53                                                                                                          </span>
<span class="-8652295380638743348" onmouseenter="enter('-8652295380638743348');" onmouseout="out('-8652295380638743348');" style="">  54   public AbsTaskWrapper getWrapper() {                                                                   </span>
<span class="-6199220384104149910" onmouseenter="enter('-6199220384104149910');" onmouseout="out('-6199220384104149910');" style="">  55     return mTaskWrapper;                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  56   }                                                                                                      </span>
<span  style="">  57                                                                                                          </span>
<span class="-3197578047902101869" onmouseenter="enter('-3197578047902101869');" onmouseout="out('-3197578047902101869');" style="">  58   public AbsNormalEntity getEntity() {                                                                   </span>
<span class="-2978486956956616380" onmouseenter="enter('-2978486956956616380');" onmouseout="out('-2978486956956616380');" style="">  59     return mEntity;                                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  60   }                                                                                                      </span>
<span  style="">  61                                                                                                          </span>
<span class="1941248740392522719" onmouseenter="enter('1941248740392522719');" onmouseout="out('1941248740392522719');" style="">  62   @Override public void onPre() {                                                                        </span>
<span  style="">  63                                                                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  64   }                                                                                                      </span>
<span  style="">  65                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  66   /**                                                                                                    </span>
<span class="-4523044754040360039" onmouseenter="enter('-4523044754040360039');" onmouseout="out('-4523044754040360039');" style="">  67    * 获取任务记录，如果任务记录存在，检查任务记录                                                                              </span>
<span class="-994801055868135316" onmouseenter="enter('-994801055868135316');" onmouseout="out('-994801055868135316');" style="">  68    * 检查记录 对于分块任务： 子分块不存在或被删除，子线程将重新下载                                                                    </span>
<span class="-5335970434013572058" onmouseenter="enter('-5335970434013572058');" onmouseout="out('-5335970434013572058');" style="">  69    * 对于普通任务： 预下载文件不存在，则任务任务呗删除                                                                           </span>
<span class="6742381731051832150" onmouseenter="enter('6742381731051832150');" onmouseout="out('6742381731051832150');" style="">  70    * 如果任务记录不存在或线程记录不存在，初始化记录                                                                             </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  71    *                                                                                                     </span>
<span class="2644027277083576426" onmouseenter="enter('2644027277083576426');" onmouseout="out('2644027277083576426');" style="">  72    * @return 任务记录                                                                                        </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  73    */                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style="">  74   @Override                                                                                              </span>
<span class="1066955891247002122" onmouseenter="enter('1066955891247002122');" onmouseout="out('1066955891247002122');" style="">  75   public TaskRecord getRecord() {                                                                        </span>
<span class="-5297450492380711808" onmouseenter="enter('-5297450492380711808');" onmouseout="out('-5297450492380711808');" style="">  76     mConfigFile = new File(CommonUtil.getFileConfigPath(false, mEntity.getFileName()));                  </span>
<span class="4951157766975006439" onmouseenter="enter('4951157766975006439');" onmouseout="out('4951157766975006439');" style="">  77     if (mConfigFile.exists()) {                                                                          </span>
<span class="7932310618145443523" onmouseenter="enter('7932310618145443523');" onmouseout="out('7932310618145443523');" style="">  78       convertDb();                                                                                       </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style="">  79     } else {                                                                                             </span>
<span class="5012053197150764509" onmouseenter="enter('5012053197150764509');" onmouseout="out('5012053197150764509');" style="">  80       onPre();                                                                                           </span>
<span class="-4126650542682918148" onmouseenter="enter('-4126650542682918148');" onmouseout="out('-4126650542682918148');" style="">  81       mTaskRecord = DbDataHelper.getTaskRecord(getFilePath(), mEntity.getTaskType());                    </span>
<span class="4057372030095958349" onmouseenter="enter('4057372030095958349');" onmouseout="out('4057372030095958349');" style="">  82       if (mTaskRecord == null) {                                                                         </span>
<span class="-4667942192763773056" onmouseenter="enter('-4667942192763773056');" onmouseout="out('-4667942192763773056');" style="">  83 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours                                                                             </span>
<span class="7671762782338977921" onmouseenter="enter('7671762782338977921');" onmouseout="out('7671762782338977921');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  84         if (!new File(getFilePath()).exists()) {                                                         </span>
<span class="158751631392391592" onmouseenter="enter('158751631392391592');" onmouseout="out('158751631392391592');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  85           FileUtil.createFile(getFilePath());                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  86         }                                                                                                </span>
<span class="6741223626729319096" onmouseenter="enter('6741223626729319096');" onmouseout="out('6741223626729319096');" style="">  87 ||||||| GitAnalyzerPlus_base                                                                             </span>
<span class="574535391222419428" onmouseenter="enter('574535391222419428');" onmouseout="out('574535391222419428');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  88         if (!new File(getFilePath()).exists()){                                                          </span>
<span class="158751631392391592" onmouseenter="enter('158751631392391592');" onmouseout="out('158751631392391592');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  89           FileUtil.createFile(getFilePath());                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  90         }                                                                                                </span>
<span class="-6736410795519637054" onmouseenter="enter('-6736410795519637054');" onmouseout="out('-6736410795519637054');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  91         initRecord(true);                                                                                </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  92       } else {                                                                                           </span>
<span class="-4007091416322407417" onmouseenter="enter('-4007091416322407417');" onmouseout="out('-4007091416322407417');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  93         File file = new File(mTaskRecord.filePath);                                                      </span>
<span class="4133240422546463755" onmouseenter="enter('4133240422546463755');" onmouseout="out('4133240422546463755');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  94         if (!file.exists()) {                                                                            </span>
<span class="8386365718316155314" onmouseenter="enter('8386365718316155314');" onmouseout="out('8386365718316155314');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  95           ALog.w(TAG, String.format(&quot;文件【%s】不存在，重新分配线程区间&quot;, mTaskRecord.filePath));                        </span>
<span class="3147181738283157854" onmouseenter="enter('3147181738283157854');" onmouseout="out('3147181738283157854');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  96           DbEntity.deleteData(ThreadRecord.class, &quot;taskKey=?&quot;, mTaskRecord.filePath);                    </span>
<span class="5854365307602457529" onmouseenter="enter('5854365307602457529');" onmouseout="out('5854365307602457529');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  97           mTaskRecord.threadRecords.clear();                                                             </span>
<span class="3796057323931724632" onmouseenter="enter('3796057323931724632');" onmouseout="out('3796057323931724632');" style="">  98 =======                                                                                                  </span>
<span class="-1382546150375666264" onmouseenter="enter('-1382546150375666264');" onmouseout="out('-1382546150375666264');" style="">  99 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs                                                                           </span>
<span class="-6736410795519637054" onmouseenter="enter('-6736410795519637054');" onmouseout="out('-6736410795519637054');" style=""> 100         initRecord(true);                                                                                </span>
<span class="-4667942192763773056" onmouseenter="enter('-4667942192763773056');" onmouseout="out('-4667942192763773056');" style=""> 101 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours                                                                             </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 102       } else {                                                                                           </span>
<span class="-4007091416322407417" onmouseenter="enter('-4007091416322407417');" onmouseout="out('-4007091416322407417');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 103         File file = new File(mTaskRecord.filePath);                                                      </span>
<span class="4133240422546463755" onmouseenter="enter('4133240422546463755');" onmouseout="out('4133240422546463755');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 104         if (!file.exists()) {                                                                            </span>
<span class="8386365718316155314" onmouseenter="enter('8386365718316155314');" onmouseout="out('8386365718316155314');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 105           ALog.w(TAG, String.format(&quot;文件【%s】不存在，重新分配线程区间&quot;, mTaskRecord.filePath));                        </span>
<span class="3147181738283157854" onmouseenter="enter('3147181738283157854');" onmouseout="out('3147181738283157854');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 106           DbEntity.deleteData(ThreadRecord.class, &quot;taskKey=?&quot;, mTaskRecord.filePath);                    </span>
<span class="5854365307602457529" onmouseenter="enter('5854365307602457529');" onmouseout="out('5854365307602457529');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 107           mTaskRecord.threadRecords.clear();                                                             </span>
<span class="-7640715801341958211" onmouseenter="enter('-7640715801341958211');" onmouseout="out('-7640715801341958211');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 108           mTaskRecord.threadNum = initTaskThreadNum();                                                   </span>
<span class="-3891780371452029435" onmouseenter="enter('-3891780371452029435');" onmouseout="out('-3891780371452029435');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 109           initRecord(false);                                                                             </span>
<span class="-7115068008347678823" onmouseenter="enter('-7115068008347678823');" onmouseout="out('-7115068008347678823');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 110         } else if (mTaskRecord.threadRecords == null || mTaskRecord.threadRecords.isEmpty()) {           </span>
<span class="-7640715801341958211" onmouseenter="enter('-7640715801341958211');" onmouseout="out('-7640715801341958211');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 111           mTaskRecord.threadNum = initTaskThreadNum();                                                   </span>
<span class="-3891780371452029435" onmouseenter="enter('-3891780371452029435');" onmouseout="out('-3891780371452029435');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 112           initRecord(false);                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 113         }                                                                                                </span>
<span class="6741223626729319096" onmouseenter="enter('6741223626729319096');" onmouseout="out('6741223626729319096');" style=""> 114 ||||||| GitAnalyzerPlus_base                                                                             </span>
<span class="158751631392391592" onmouseenter="enter('158751631392391592');" onmouseout="out('158751631392391592');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 115           FileUtil.createFile(getFilePath());                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 116         }                                                                                                </span>
<span class="-6736410795519637054" onmouseenter="enter('-6736410795519637054');" onmouseout="out('-6736410795519637054');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 117         initRecord(true);                                                                                </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 118       } else {                                                                                           </span>
<span class="-4007091416322407417" onmouseenter="enter('-4007091416322407417');" onmouseout="out('-4007091416322407417');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 119         File file = new File(mTaskRecord.filePath);                                                      </span>
<span class="4133240422546463755" onmouseenter="enter('4133240422546463755');" onmouseout="out('4133240422546463755');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 120         if (!file.exists()) {                                                                            </span>
<span class="8386365718316155314" onmouseenter="enter('8386365718316155314');" onmouseout="out('8386365718316155314');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 121           ALog.w(TAG, String.format(&quot;文件【%s】不存在，重新分配线程区间&quot;, mTaskRecord.filePath));                        </span>
<span class="3147181738283157854" onmouseenter="enter('3147181738283157854');" onmouseout="out('3147181738283157854');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 122           DbEntity.deleteData(ThreadRecord.class, &quot;taskKey=?&quot;, mTaskRecord.filePath);                    </span>
<span class="5854365307602457529" onmouseenter="enter('5854365307602457529');" onmouseout="out('5854365307602457529');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 123           mTaskRecord.threadRecords.clear();                                                             </span>
<span class="7876801457309202704" onmouseenter="enter('7876801457309202704');" onmouseout="out('7876801457309202704');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 124           mTaskRecord.threadNum = mAdapter.initTaskThreadNum();                                          </span>
<span class="-3891780371452029435" onmouseenter="enter('-3891780371452029435');" onmouseout="out('-3891780371452029435');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 125           initRecord(false);                                                                             </span>
<span class="-7115068008347678823" onmouseenter="enter('-7115068008347678823');" onmouseout="out('-7115068008347678823');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 126         } else if (mTaskRecord.threadRecords == null || mTaskRecord.threadRecords.isEmpty()) {           </span>
<span class="7876801457309202704" onmouseenter="enter('7876801457309202704');" onmouseout="out('7876801457309202704');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 127           mTaskRecord.threadNum = mAdapter.initTaskThreadNum();                                          </span>
<span class="-3891780371452029435" onmouseenter="enter('-3891780371452029435');" onmouseout="out('-3891780371452029435');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 128           initRecord(false);                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 129         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 130       }                                                                                                  </span>
<span class="5534914312730067566" onmouseenter="enter('5534914312730067566');" onmouseout="out('5534914312730067566');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 131       mAdapter.handlerTaskRecord(mTaskRecord);                                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 132     }                                                                                                    </span>
<span class="-4447853798640415053" onmouseenter="enter('-4447853798640415053');" onmouseout="out('-4447853798640415053');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 133     saveRecord();                                                                                        </span>
<span class="2589344107322293803" onmouseenter="enter('2589344107322293803');" onmouseout="out('2589344107322293803');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 134     return mTaskRecord;                                                                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 135   }                                                                                                      </span>
<span  style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 136                                                                                                          </span>
<span class="3796057323931724632" onmouseenter="enter('3796057323931724632');" onmouseout="out('3796057323931724632');" style=""> 137 =======                                                                                                  </span>
<span class="-1382546150375666264" onmouseenter="enter('-1382546150375666264');" onmouseout="out('-1382546150375666264');" style=""> 138 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs                                                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 139       }                                                                                                  </span>
<span class="2603181800050683167" onmouseenter="enter('2603181800050683167');" onmouseout="out('2603181800050683167');" style=""> 140       handlerTaskRecord(mTaskRecord);                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 141     }                                                                                                    </span>
<span class="-4447853798640415053" onmouseenter="enter('-4447853798640415053');" onmouseout="out('-4447853798640415053');" style=""> 142     saveRecord();                                                                                        </span>
<span class="2589344107322293803" onmouseenter="enter('2589344107322293803');" onmouseout="out('2589344107322293803');" style=""> 143     return mTaskRecord;                                                                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 144   }                                                                                                      </span>
<span  style=""> 145                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 146   /**                                                                                                    </span>
<span class="4426545154492852727" onmouseenter="enter('4426545154492852727');" onmouseout="out('4426545154492852727');" style=""> 147    * convertDb 是兼容性代码 从3.4.1开始，线程配置信息将存储在数据库中。 将配置文件的内容复制到数据库中，并将配置文件删除                                  </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 148    */                                                                                                    </span>
<span class="14298455509427519" onmouseenter="enter('14298455509427519');" onmouseout="out('14298455509427519');" style=""> 149   private void convertDb() {                                                                             </span>
<span class="-4598298306615401010" onmouseenter="enter('-4598298306615401010');" onmouseout="out('-4598298306615401010');" style=""> 150     List&lt;RecordWrapper&gt; records =                                                                        </span>
<span class="-4738968014729726274" onmouseenter="enter('-4738968014729726274');" onmouseout="out('-4738968014729726274');" style=""> 151         DbEntity.findRelationData(RecordWrapper.class, &quot;TaskRecord.filePath=?&quot;,                          </span>
<span class="1664646851824584272" onmouseenter="enter('1664646851824584272');" onmouseout="out('1664646851824584272');" style=""> 152             getFilePath());                                                                              </span>
<span class="-376648440877788579" onmouseenter="enter('-376648440877788579');" onmouseout="out('-376648440877788579');" style=""> 153     if (records == null || records.size() == 0) {                                                        </span>
<span class="1734928994769379059" onmouseenter="enter('1734928994769379059');" onmouseout="out('1734928994769379059');" style=""> 154       Properties pro = FileUtil.loadConfig(mConfigFile);                                                 </span>
<span class="-681137634566379888" onmouseenter="enter('-681137634566379888');" onmouseout="out('-681137634566379888');" style=""> 155       if (pro.isEmpty()) {                                                                               </span>
<span class="6270101186355835075" onmouseenter="enter('6270101186355835075');" onmouseout="out('6270101186355835075');" style=""> 156         ALog.d(TAG, &quot;老版本的线程记录为空，任务为新任务&quot;);                                                                </span>
<span class="-6736410795519637054" onmouseenter="enter('-6736410795519637054');" onmouseout="out('-6736410795519637054');" style=""> 157         initRecord(true);                                                                                </span>
<span class="4043029072030362567" onmouseenter="enter('4043029072030362567');" onmouseout="out('4043029072030362567');" style=""> 158         return;                                                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 159       }                                                                                                  </span>
<span  style=""> 160                                                                                                          </span>
<span class="-4092719147494026286" onmouseenter="enter('-4092719147494026286');" onmouseout="out('-4092719147494026286');" style=""> 161       Set&lt;Object&gt; keys = pro.keySet();                                                                   </span>
<span class="7117164647387083506" onmouseenter="enter('7117164647387083506');" onmouseout="out('7117164647387083506');" style=""> 162       // 老版本记录是5s存一次，但是5s中内，如果线程执行完成，record记录是没有的，只有state记录...                                           </span>
<span class="8442347856216504710" onmouseenter="enter('8442347856216504710');" onmouseout="out('8442347856216504710');" style=""> 163       // 第一步应该是record 和 state去重取正确的线程数                                                                   </span>
<span class="3880560860847601414" onmouseenter="enter('3880560860847601414');" onmouseout="out('3880560860847601414');" style=""> 164       Set&lt;Integer&gt; set = new HashSet&lt;&gt;();                                                                </span>
<span class="-5644624400733519290" onmouseenter="enter('-5644624400733519290');" onmouseout="out('-5644624400733519290');" style=""> 165       for (Object key : keys) {                                                                          </span>
<span class="-90111359741489740" onmouseenter="enter('-90111359741489740');" onmouseout="out('-90111359741489740');" style=""> 166         String str = String.valueOf(key);                                                                </span>
<span class="4809237278425345525" onmouseenter="enter('4809237278425345525');" onmouseout="out('4809237278425345525');" style=""> 167         int i = Integer.parseInt(str.substring(str.length() - 1));                                       </span>
<span class="5139166377005733880" onmouseenter="enter('5139166377005733880');" onmouseout="out('5139166377005733880');" style=""> 168         set.add(i);                                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 169       }                                                                                                  </span>
<span class="1773727540275693887" onmouseenter="enter('1773727540275693887');" onmouseout="out('1773727540275693887');" style=""> 170       int threadNum = set.size();                                                                        </span>
<span class="1658307869252768908" onmouseenter="enter('1658307869252768908');" onmouseout="out('1658307869252768908');" style=""> 171       if (threadNum == 0) {                                                                              </span>
<span class="1148319986505262760" onmouseenter="enter('1148319986505262760');" onmouseout="out('1148319986505262760');" style=""> 172         ALog.d(TAG, &quot;线程数为空，任务为新任务&quot;);                                                                     </span>
<span class="-6736410795519637054" onmouseenter="enter('-6736410795519637054');" onmouseout="out('-6736410795519637054');" style=""> 173         initRecord(true);                                                                                </span>
<span class="4043029072030362567" onmouseenter="enter('4043029072030362567');" onmouseout="out('4043029072030362567');" style=""> 174         return;                                                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 175       }                                                                                                  </span>
<span class="7955340223234605" onmouseenter="enter('7955340223234605');" onmouseout="out('7955340223234605');" style=""> 176       mTaskWrapper.setNewTask(false);                                                                    </span>
<span class="-1821078783357105510" onmouseenter="enter('-1821078783357105510');" onmouseout="out('-1821078783357105510');" style=""> 177       mTaskRecord = createTaskRecord(threadNum);                                                         </span>
<span class="7633421891114459750" onmouseenter="enter('7633421891114459750');" onmouseout="out('7633421891114459750');" style=""> 178       mTaskRecord.isBlock = false;                                                                       </span>
<span class="3855509751077495513" onmouseenter="enter('3855509751077495513');" onmouseout="out('3855509751077495513');" style=""> 179       File tempFile = new File(getFilePath());                                                           </span>
<span class="92058997093189211" onmouseenter="enter('92058997093189211');" onmouseout="out('92058997093189211');" style=""> 180       for (int i = 0; i &lt; threadNum; i++) {                                                              </span>
<span class="1846142719149590893" onmouseenter="enter('1846142719149590893');" onmouseout="out('1846142719149590893');" style=""> 181         ThreadRecord tRecord = new ThreadRecord();                                                       </span>
<span class="3723169099876741000" onmouseenter="enter('3723169099876741000');" onmouseout="out('3723169099876741000');" style=""> 182         tRecord.taskKey = mTaskRecord.filePath;                                                          </span>
<span class="5678090729290962283" onmouseenter="enter('5678090729290962283');" onmouseout="out('5678090729290962283');" style=""> 183         Object state = pro.getProperty(tempFile.getName() + STATE + i);                                  </span>
<span class="8491464740929708384" onmouseenter="enter('8491464740929708384');" onmouseout="out('8491464740929708384');" style=""> 184         Object record = pro.getProperty(tempFile.getName() + RECORD + i);                                </span>
<span class="-1417732743646819816" onmouseenter="enter('-1417732743646819816');" onmouseout="out('-1417732743646819816');" style=""> 185         if (state != null &amp;&amp; Integer.parseInt(String.valueOf(state)) == 1) {                             </span>
<span class="-5900743039323389312" onmouseenter="enter('-5900743039323389312');" onmouseout="out('-5900743039323389312');" style=""> 186           tRecord.isComplete = true;                                                                     </span>
<span class="-6362435147834875541" onmouseenter="enter('-6362435147834875541');" onmouseout="out('-6362435147834875541');" style=""> 187           continue;                                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 188         }                                                                                                </span>
<span class="2652986304939921073" onmouseenter="enter('2652986304939921073');" onmouseout="out('2652986304939921073');" style=""> 189         if (record != null) {                                                                            </span>
<span class="7355303051831508853" onmouseenter="enter('7355303051831508853');" onmouseout="out('7355303051831508853');" style=""> 190           long temp = Long.parseLong(String.valueOf(record));                                            </span>
<span class="6949017848225026676" onmouseenter="enter('6949017848225026676');" onmouseout="out('6949017848225026676');" style=""> 191           tRecord.startLocation = temp &gt; 0 ? temp : 0;                                                   </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 192         } else {                                                                                         </span>
<span class="-2463924567028920967" onmouseenter="enter('-2463924567028920967');" onmouseout="out('-2463924567028920967');" style=""> 193           tRecord.startLocation = 0;                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 194         }                                                                                                </span>
<span class="-6865700341156428088" onmouseenter="enter('-6865700341156428088');" onmouseout="out('-6865700341156428088');" style=""> 195         mTaskRecord.threadRecords.add(tRecord);                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 196       }                                                                                                  </span>
<span class="4367383752983568604" onmouseenter="enter('4367383752983568604');" onmouseout="out('4367383752983568604');" style=""> 197       FileUtil.deleteFile(mConfigFile);                                                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 198     }                                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 199   }                                                                                                      </span>
<span  style=""> 200                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 201   /**                                                                                                    </span>
<span class="8463391589973071562" onmouseenter="enter('8463391589973071562');" onmouseout="out('8463391589973071562');" style=""> 202    * 初始化任务记录，分配线程区间，如果任务记录不存在，则创建新的任务记录                                                                  </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 203    *                                                                                                     </span>
<span class="-3744851117936265295" onmouseenter="enter('-3744851117936265295');" onmouseout="out('-3744851117936265295');" style=""> 204    * @param newRecord {@code true} 需要创建新{@link TaskRecord}                                               </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 205    */                                                                                                    </span>
<span class="1766652104121073893" onmouseenter="enter('1766652104121073893');" onmouseout="out('1766652104121073893');" style=""> 206   private void initRecord(boolean newRecord) {                                                           </span>
<span class="6048435392166168608" onmouseenter="enter('6048435392166168608');" onmouseout="out('6048435392166168608');" style=""> 207     if (newRecord) {                                                                                     </span>
<span class="3987778045821889500" onmouseenter="enter('3987778045821889500');" onmouseout="out('3987778045821889500');" style=""> 208       mTaskRecord = createTaskRecord(initTaskThreadNum());                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 209     }                                                                                                    </span>
<span class="-1512381015788610352" onmouseenter="enter('-1512381015788610352');" onmouseout="out('-1512381015788610352');" style=""> 210     mTaskWrapper.setNewTask(true);                                                                       </span>
<span class="-3721642619055872692" onmouseenter="enter('-3721642619055872692');" onmouseout="out('-3721642619055872692');" style=""> 211     int requestType = mTaskWrapper.getRequestType();                                                     </span>
<span class="3748431468753436023" onmouseenter="enter('3748431468753436023');" onmouseout="out('3748431468753436023');" style=""> 212     if (requestType == ITaskWrapper.M3U8_LIVE) {                                                         </span>
<span class="4043029072030362567" onmouseenter="enter('4043029072030362567');" onmouseout="out('4043029072030362567');" style=""> 213       return;                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 214     }                                                                                                    </span>
<span class="1600220578687832077" onmouseenter="enter('1600220578687832077');" onmouseout="out('1600220578687832077');" style=""> 215     long blockSize = mEntity.getFileSize() / mTaskRecord.threadNum;                                      </span>
<span class="-4436010189640816687" onmouseenter="enter('-4436010189640816687');" onmouseout="out('-4436010189640816687');" style=""> 216     // 处理线程区间记录                                                                                          </span>
<span class="-8559683407759389663" onmouseenter="enter('-8559683407759389663');" onmouseout="out('-8559683407759389663');" style=""> 217     for (int i = 0; i &lt; mTaskRecord.threadNum; i++) {                                                    </span>
<span class="-2965725495076654490" onmouseenter="enter('-2965725495076654490');" onmouseout="out('-2965725495076654490');" style=""> 218       long startL = i * blockSize, endL = (i + 1) * blockSize;                                           </span>
<span class="5894722016696267883" onmouseenter="enter('5894722016696267883');" onmouseout="out('5894722016696267883');" style=""> 219       ThreadRecord tr = createThreadRecord(mTaskRecord, i, startL, endL);                                </span>
<span class="-6805201278378671560" onmouseenter="enter('-6805201278378671560');" onmouseout="out('-6805201278378671560');" style=""> 220       mTaskRecord.threadRecords.add(tr);                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 221     }                                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 222   }                                                                                                      </span>
<span  style=""> 223                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 224   /**                                                                                                    </span>
<span class="-8991940256279851469" onmouseenter="enter('-8991940256279851469');" onmouseout="out('-8991940256279851469');" style=""> 225    * 保存任务记录                                                                                              </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 226    */                                                                                                    </span>
<span class="1188287987342183098" onmouseenter="enter('1188287987342183098');" onmouseout="out('1188287987342183098');" style=""> 227   private void saveRecord() {                                                                            </span>
<span class="323794376596875286" onmouseenter="enter('323794376596875286');" onmouseout="out('323794376596875286');" style=""> 228     mTaskRecord.threadNum = mTaskRecord.threadRecords.size();                                            </span>
<span class="345625468264837114" onmouseenter="enter('345625468264837114');" onmouseout="out('345625468264837114');" style=""> 229     mTaskRecord.save();                                                                                  </span>
<span class="-3701039002002731049" onmouseenter="enter('-3701039002002731049');" onmouseout="out('-3701039002002731049');" style=""> 230     if (mTaskRecord.threadRecords != null &amp;&amp; !mTaskRecord.threadRecords.isEmpty()) {                     </span>
<span class="2432664825672590881" onmouseenter="enter('2432664825672590881');" onmouseout="out('2432664825672590881');" style=""> 231       DbEntity.saveAll(mTaskRecord.threadRecords);                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 232     }                                                                                                    </span>
<span class="-1161286805066448242" onmouseenter="enter('-1161286805066448242');" onmouseout="out('-1161286805066448242');" style=""> 233     ALog.d(TAG, String.format(&quot;保存记录，线程记录数：%s&quot;, mTaskRecord.threadRecords.size()));                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 234   }                                                                                                      </span>
<span  style=""> 235                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 236   /**                                                                                                    </span>
<span class="-5152727538261600286" onmouseenter="enter('-5152727538261600286');" onmouseout="out('-5152727538261600286');" style=""> 237    * 获取任务路径                                                                                              </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 238    *                                                                                                     </span>
<span class="-2815134136997967815" onmouseenter="enter('-2815134136997967815');" onmouseout="out('-2815134136997967815');" style=""> 239    * @return 任务文件路径                                                                                      </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 240    */                                                                                                    </span>
<span class="-8326432688154281329" onmouseenter="enter('-8326432688154281329');" onmouseout="out('-8326432688154281329');" style=""> 241   private String getFilePath() {                                                                         </span>
<span class="4415201624474066138" onmouseenter="enter('4415201624474066138');" onmouseout="out('4415201624474066138');" style=""> 242     if (mEntity instanceof DownloadEntity) {                                                             </span>
<span class="-8422380947915573606" onmouseenter="enter('-8422380947915573606');" onmouseout="out('-8422380947915573606');" style=""> 243       return ((DownloadEntity) mTaskWrapper.getEntity()).getFilePath();                                  </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 244     } else {                                                                                             </span>
<span class="-2519282598545089845" onmouseenter="enter('-2519282598545089845');" onmouseout="out('-2519282598545089845');" style=""> 245       return ((UploadEntity) mTaskWrapper.getEntity()).getFilePath();                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 246     }                                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 247   }                                                                                                      </span>
<span  style=""> 248                                                                                                          </span>
<span class="4486979386009511061" onmouseenter="enter('4486979386009511061');" onmouseout="out('4486979386009511061');" style=""> 249   @Override public void accept(ILoaderVisitor visitor) {                                                 </span>
<span class="-5407432854577292854" onmouseenter="enter('-5407432854577292854');" onmouseout="out('-5407432854577292854');" style=""> 250     visitor.addComponent(this);                                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 251   }                                                                                                      </span>
<span  style=""> 252                                                                                                          </span>
<span class="5822606900778148603" onmouseenter="enter('5822606900778148603');" onmouseout="out('5822606900778148603');" style=""> 253   @Override public boolean checkTaskCompleted() {                                                        </span>
<span class="7676423467312835669" onmouseenter="enter('7676423467312835669');" onmouseout="out('7676423467312835669');" style=""> 254     if (mTaskRecord == null                                                                              </span>
<span class="-5287811101982291105" onmouseenter="enter('-5287811101982291105');" onmouseout="out('-5287811101982291105');" style=""> 255         || mTaskRecord.threadRecords == null                                                             </span>
<span class="-3537982277811084340" onmouseenter="enter('-3537982277811084340');" onmouseout="out('-3537982277811084340');" style=""> 256         || mTaskRecord.threadRecords.isEmpty()) {                                                        </span>
<span class="-5432226360745882584" onmouseenter="enter('-5432226360745882584');" onmouseout="out('-5432226360745882584');" style=""> 257       return false;                                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 258     }                                                                                                    </span>
<span class="4151685609487095982" onmouseenter="enter('4151685609487095982');" onmouseout="out('4151685609487095982');" style=""> 259     int completeNum = 0;                                                                                 </span>
<span class="-7590052688485059950" onmouseenter="enter('-7590052688485059950');" onmouseout="out('-7590052688485059950');" style=""> 260     for (ThreadRecord tr : mTaskRecord.threadRecords) {                                                  </span>
<span class="-6249885869558348483" onmouseenter="enter('-6249885869558348483');" onmouseout="out('-6249885869558348483');" style=""> 261       if (tr.isComplete) {                                                                               </span>
<span class="-1832473639842396112" onmouseenter="enter('-1832473639842396112');" onmouseout="out('-1832473639842396112');" style=""> 262         completeNum++;                                                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 263       }                                                                                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 264     }                                                                                                    </span>
<span class="-3614550293302262544" onmouseenter="enter('-3614550293302262544');" onmouseout="out('-3614550293302262544');" style=""> 265     return completeNum != 0 &amp;&amp; completeNum == mTaskRecord.threadNum;                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 266   }                                                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 267 }                                                                                                        </span></pre></td>
                            <td><pre><span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style="">   1 /*                                                                                                       </span>
<span class="-4176855950178531235" onmouseenter="enter('-4176855950178531235');" onmouseout="out('-4176855950178531235');" style="">   2  * Copyright (C) 2016 AriaLyy(https://github.com/AriaLyy/Aria)                                           </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">   3  *                                                                                                       </span>
<span class="-7144700690364548245" onmouseenter="enter('-7144700690364548245');" onmouseout="out('-7144700690364548245');" style="">   4  * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);                                       </span>
<span class="-6614298523444173250" onmouseenter="enter('-6614298523444173250');" onmouseout="out('-6614298523444173250');" style="">   5  * you may not use this file except in compliance with the License.                                      </span>
<span class="-4753901504248728101" onmouseenter="enter('-4753901504248728101');" onmouseout="out('-4753901504248728101');" style="">   6  * You may obtain a copy of the License at                                                               </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">   7  *                                                                                                       </span>
<span class="-763207030729826407" onmouseenter="enter('-763207030729826407');" onmouseout="out('-763207030729826407');" style="">   8  *      http://www.apache.org/licenses/LICENSE-2.0                                                       </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">   9  *                                                                                                       </span>
<span class="2557607632756179983" onmouseenter="enter('2557607632756179983');" onmouseout="out('2557607632756179983');" style="">  10  * Unless required by applicable law or agreed to in writing, software                                   </span>
<span class="-9189129105512731955" onmouseenter="enter('-9189129105512731955');" onmouseout="out('-9189129105512731955');" style="">  11  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,                                     </span>
<span class="5781161717946418340" onmouseenter="enter('5781161717946418340');" onmouseout="out('5781161717946418340');" style="">  12  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.                              </span>
<span class="1761562277992059393" onmouseenter="enter('1761562277992059393');" onmouseout="out('1761562277992059393');" style="">  13  * See the License for the specific language governing permissions and                                   </span>
<span class="7217408601297779962" onmouseenter="enter('7217408601297779962');" onmouseout="out('7217408601297779962');" style="">  14  * limitations under the License.                                                                        </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  15  */                                                                                                      </span>
<span class="-5592048915404489240" onmouseenter="enter('-5592048915404489240');" onmouseout="out('-5592048915404489240');" style="">  16 package com.arialyy.aria.core.common;                                                                    </span>
<span  style="">  17                                                                                                          </span>
<span class="7150685219957576571" onmouseenter="enter('7150685219957576571');" onmouseout="out('7150685219957576571');" style="">  18 import com.arialyy.aria.core.TaskRecord;                                                                 </span>
<span class="-7662986158836731995" onmouseenter="enter('-7662986158836731995');" onmouseout="out('-7662986158836731995');" style="">  19 import com.arialyy.aria.core.ThreadRecord;                                                               </span>
<span class="1932658903610588883" onmouseenter="enter('1932658903610588883');" onmouseout="out('1932658903610588883');" style="">  20 import com.arialyy.aria.core.download.DownloadEntity;                                                    </span>
<span class="-3079874842134488668" onmouseenter="enter('-3079874842134488668');" onmouseout="out('-3079874842134488668');" style="">  21 import com.arialyy.aria.core.loader.ILoaderVisitor;                                                      </span>
<span class="-9014417511727405835" onmouseenter="enter('-9014417511727405835');" onmouseout="out('-9014417511727405835');" style="">  22 import com.arialyy.aria.core.loader.IRecordHandler;                                                      </span>
<span class="-5831681804875068292" onmouseenter="enter('-5831681804875068292');" onmouseout="out('-5831681804875068292');" style="">  23 import com.arialyy.aria.core.upload.UploadEntity;                                                        </span>
<span class="-2181497863142513098" onmouseenter="enter('-2181497863142513098');" onmouseout="out('-2181497863142513098');" style="">  24 import com.arialyy.aria.core.wrapper.AbsTaskWrapper;                                                     </span>
<span class="2481088621669901079" onmouseenter="enter('2481088621669901079');" onmouseout="out('2481088621669901079');" style="">  25 import com.arialyy.aria.core.wrapper.ITaskWrapper;                                                       </span>
<span class="-4361229816664464434" onmouseenter="enter('-4361229816664464434');" onmouseout="out('-4361229816664464434');" style="">  26 import com.arialyy.aria.core.wrapper.RecordWrapper;                                                      </span>
<span class="-4499301116755301031" onmouseenter="enter('-4499301116755301031');" onmouseout="out('-4499301116755301031');" style="">  27 import com.arialyy.aria.orm.DbEntity;                                                                    </span>
<span class="-3586495952513455611" onmouseenter="enter('-3586495952513455611');" onmouseout="out('-3586495952513455611');" style="">  28 import com.arialyy.aria.util.ALog;                                                                       </span>
<span class="-3106139894727218967" onmouseenter="enter('-3106139894727218967');" onmouseout="out('-3106139894727218967');" style="">  29 import com.arialyy.aria.util.CommonUtil;                                                                 </span>
<span class="-5216410147421847074" onmouseenter="enter('-5216410147421847074');" onmouseout="out('-5216410147421847074');" style="">  30 import com.arialyy.aria.util.DbDataHelper;                                                               </span>
<span class="-563266023018163236" onmouseenter="enter('-563266023018163236');" onmouseout="out('-563266023018163236');" style="">  31 import com.arialyy.aria.util.FileUtil;                                                                   </span>
<span class="-3926401431737521278" onmouseenter="enter('-3926401431737521278');" onmouseout="out('-3926401431737521278');" style="">  32 import java.io.File;                                                                                     </span>
<span class="-1320562196372945707" onmouseenter="enter('-1320562196372945707');" onmouseout="out('-1320562196372945707');" style="">  33 import java.util.HashSet;                                                                                </span>
<span class="-1786020958497218848" onmouseenter="enter('-1786020958497218848');" onmouseout="out('-1786020958497218848');" style="">  34 import java.util.List;                                                                                   </span>
<span class="1689171550873420012" onmouseenter="enter('1689171550873420012');" onmouseout="out('1689171550873420012');" style="">  35 import java.util.Properties;                                                                             </span>
<span class="3384353015976675773" onmouseenter="enter('3384353015976675773');" onmouseout="out('3384353015976675773');" style="">  36 import java.util.Set;                                                                                    </span>
<span  style="">  37                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  38 /**                                                                                                      </span>
<span class="2736882465778481894" onmouseenter="enter('2736882465778481894');" onmouseout="out('2736882465778481894');" style="">  39  * 处理任务记录，分配线程区间                                                                                         </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  40  */                                                                                                      </span>
<span class="4487114878540249679" onmouseenter="enter('4487114878540249679');" onmouseout="out('4487114878540249679');" style="">  41 public abstract class RecordHandler implements IRecordHandler {                                          </span>
<span class="-6385414676469589348" onmouseenter="enter('-6385414676469589348');" onmouseout="out('-6385414676469589348');" style="">  42   protected final String TAG = CommonUtil.getClassName(this);                                            </span>
<span  style="">  43                                                                                                          </span>
<span class="-6913167534336436900" onmouseenter="enter('-6913167534336436900');" onmouseout="out('-6913167534336436900');" style="">  44   @Deprecated private File mConfigFile;                                                                  </span>
<span class="-8877097513462838969" onmouseenter="enter('-8877097513462838969');" onmouseout="out('-8877097513462838969');" style="">  45   private TaskRecord mTaskRecord;                                                                        </span>
<span class="-8022183237541885590" onmouseenter="enter('-8022183237541885590');" onmouseout="out('-8022183237541885590');" style="">  46   private AbsTaskWrapper mTaskWrapper;                                                                   </span>
<span class="-2477248167481204479" onmouseenter="enter('-2477248167481204479');" onmouseout="out('-2477248167481204479');" style="">  47   private AbsNormalEntity mEntity;                                                                       </span>
<span  style="">  48                                                                                                          </span>
<span class="-4800954456425527235" onmouseenter="enter('-4800954456425527235');" onmouseout="out('-4800954456425527235');" style="">  49   public RecordHandler(AbsTaskWrapper wrapper) {                                                         </span>
<span class="-4483703319181095288" onmouseenter="enter('-4483703319181095288');" onmouseout="out('-4483703319181095288');" style="">  50     mTaskWrapper = wrapper;                                                                              </span>
<span class="-2477156305516257248" onmouseenter="enter('-2477156305516257248');" onmouseout="out('-2477156305516257248');" style="">  51     mEntity = (AbsNormalEntity) mTaskWrapper.getEntity();                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  52   }                                                                                                      </span>
<span  style="">  53                                                                                                          </span>
<span class="-8652295380638743348" onmouseenter="enter('-8652295380638743348');" onmouseout="out('-8652295380638743348');" style="">  54   public AbsTaskWrapper getWrapper() {                                                                   </span>
<span class="-6199220384104149910" onmouseenter="enter('-6199220384104149910');" onmouseout="out('-6199220384104149910');" style="">  55     return mTaskWrapper;                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  56   }                                                                                                      </span>
<span  style="">  57                                                                                                          </span>
<span class="-3197578047902101869" onmouseenter="enter('-3197578047902101869');" onmouseout="out('-3197578047902101869');" style="">  58   public AbsNormalEntity getEntity() {                                                                   </span>
<span class="-2978486956956616380" onmouseenter="enter('-2978486956956616380');" onmouseout="out('-2978486956956616380');" style="">  59     return mEntity;                                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  60   }                                                                                                      </span>
<span  style="">  61                                                                                                          </span>
<span class="1941248740392522719" onmouseenter="enter('1941248740392522719');" onmouseout="out('1941248740392522719');" style="">  62   @Override public void onPre() {                                                                        </span>
<span  style="">  63                                                                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  64   }                                                                                                      </span>
<span  style="">  65                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  66   /**                                                                                                    </span>
<span class="-4523044754040360039" onmouseenter="enter('-4523044754040360039');" onmouseout="out('-4523044754040360039');" style="">  67    * 获取任务记录，如果任务记录存在，检查任务记录                                                                              </span>
<span class="-994801055868135316" onmouseenter="enter('-994801055868135316');" onmouseout="out('-994801055868135316');" style="">  68    * 检查记录 对于分块任务： 子分块不存在或被删除，子线程将重新下载                                                                    </span>
<span class="-5335970434013572058" onmouseenter="enter('-5335970434013572058');" onmouseout="out('-5335970434013572058');" style="">  69    * 对于普通任务： 预下载文件不存在，则任务任务呗删除                                                                           </span>
<span class="6742381731051832150" onmouseenter="enter('6742381731051832150');" onmouseout="out('6742381731051832150');" style="">  70    * 如果任务记录不存在或线程记录不存在，初始化记录                                                                             </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  71    *                                                                                                     </span>
<span class="2644027277083576426" onmouseenter="enter('2644027277083576426');" onmouseout="out('2644027277083576426');" style="">  72    * @return 任务记录                                                                                        </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  73    */                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style="">  74   @Override                                                                                              </span>
<span class="1066955891247002122" onmouseenter="enter('1066955891247002122');" onmouseout="out('1066955891247002122');" style="">  75   public TaskRecord getRecord() {                                                                        </span>
<span class="-5297450492380711808" onmouseenter="enter('-5297450492380711808');" onmouseout="out('-5297450492380711808');" style="">  76     mConfigFile = new File(CommonUtil.getFileConfigPath(false, mEntity.getFileName()));                  </span>
<span class="4951157766975006439" onmouseenter="enter('4951157766975006439');" onmouseout="out('4951157766975006439');" style="">  77     if (mConfigFile.exists()) {                                                                          </span>
<span class="7932310618145443523" onmouseenter="enter('7932310618145443523');" onmouseout="out('7932310618145443523');" style="">  78       convertDb();                                                                                       </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style="">  79     } else {                                                                                             </span>
<span class="5012053197150764509" onmouseenter="enter('5012053197150764509');" onmouseout="out('5012053197150764509');" style="">  80       onPre();                                                                                           </span>
<span class="-4126650542682918148" onmouseenter="enter('-4126650542682918148');" onmouseout="out('-4126650542682918148');" style="">  81       mTaskRecord = DbDataHelper.getTaskRecord(getFilePath(), mEntity.getTaskType());                    </span>
<span class="4057372030095958349" onmouseenter="enter('4057372030095958349');" onmouseout="out('4057372030095958349');" style="">  82       if (mTaskRecord == null) {                                                                         </span>
<span class="-6736410795519637054" onmouseenter="enter('-6736410795519637054');" onmouseout="out('-6736410795519637054');" style="">  83         initRecord(true);                                                                                </span>
<span class="7598536375028459133" onmouseenter="enter('7598536375028459133');" onmouseout="out('7598536375028459133');" style="">  84 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE                                                                                             </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  85       } else {                                                                                           </span>
<span class="-4007091416322407417" onmouseenter="enter('-4007091416322407417');" onmouseout="out('-4007091416322407417');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  86         File file = new File(mTaskRecord.filePath);                                                      </span>
<span class="4133240422546463755" onmouseenter="enter('4133240422546463755');" onmouseout="out('4133240422546463755');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  87         if (!file.exists()) {                                                                            </span>
<span class="8386365718316155314" onmouseenter="enter('8386365718316155314');" onmouseout="out('8386365718316155314');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  88           ALog.w(TAG, String.format(&quot;文件【%s】不存在，重新分配线程区间&quot;, mTaskRecord.filePath));                        </span>
<span class="3147181738283157854" onmouseenter="enter('3147181738283157854');" onmouseout="out('3147181738283157854');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  89           DbEntity.deleteData(ThreadRecord.class, &quot;taskKey=?&quot;, mTaskRecord.filePath);                    </span>
<span class="5854365307602457529" onmouseenter="enter('5854365307602457529');" onmouseout="out('5854365307602457529');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  90           mTaskRecord.threadRecords.clear();                                                             </span>
<span class="-7640715801341958211" onmouseenter="enter('-7640715801341958211');" onmouseout="out('-7640715801341958211');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  91           mTaskRecord.threadNum = initTaskThreadNum();                                                   </span>
<span class="-3891780371452029435" onmouseenter="enter('-3891780371452029435');" onmouseout="out('-3891780371452029435');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  92           initRecord(false);                                                                             </span>
<span class="-7115068008347678823" onmouseenter="enter('-7115068008347678823');" onmouseout="out('-7115068008347678823');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  93         } else if (mTaskRecord.threadRecords == null || mTaskRecord.threadRecords.isEmpty()) {           </span>
<span class="-7640715801341958211" onmouseenter="enter('-7640715801341958211');" onmouseout="out('-7640715801341958211');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  94           mTaskRecord.threadNum = initTaskThreadNum();                                                   </span>
<span class="-3891780371452029435" onmouseenter="enter('-3891780371452029435');" onmouseout="out('-3891780371452029435');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  95           initRecord(false);                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  96         }                                                                                                </span>
<span class="7991106586064342212" onmouseenter="enter('7991106586064342212');" onmouseout="out('7991106586064342212');" style="">  97 ||||||| BASE                                                                                             </span>
<span class="158751631392391592" onmouseenter="enter('158751631392391592');" onmouseout="out('158751631392391592');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  98           FileUtil.createFile(getFilePath());                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  99         }                                                                                                </span>
<span class="-6736410795519637054" onmouseenter="enter('-6736410795519637054');" onmouseout="out('-6736410795519637054');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 100         initRecord(true);                                                                                </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 101       } else {                                                                                           </span>
<span class="-4007091416322407417" onmouseenter="enter('-4007091416322407417');" onmouseout="out('-4007091416322407417');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 102         File file = new File(mTaskRecord.filePath);                                                      </span>
<span class="4133240422546463755" onmouseenter="enter('4133240422546463755');" onmouseout="out('4133240422546463755');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 103         if (!file.exists()) {                                                                            </span>
<span class="8386365718316155314" onmouseenter="enter('8386365718316155314');" onmouseout="out('8386365718316155314');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 104           ALog.w(TAG, String.format(&quot;文件【%s】不存在，重新分配线程区间&quot;, mTaskRecord.filePath));                        </span>
<span class="3147181738283157854" onmouseenter="enter('3147181738283157854');" onmouseout="out('3147181738283157854');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 105           DbEntity.deleteData(ThreadRecord.class, &quot;taskKey=?&quot;, mTaskRecord.filePath);                    </span>
<span class="5854365307602457529" onmouseenter="enter('5854365307602457529');" onmouseout="out('5854365307602457529');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 106           mTaskRecord.threadRecords.clear();                                                             </span>
<span class="7876801457309202704" onmouseenter="enter('7876801457309202704');" onmouseout="out('7876801457309202704');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 107           mTaskRecord.threadNum = mAdapter.initTaskThreadNum();                                          </span>
<span class="-3891780371452029435" onmouseenter="enter('-3891780371452029435');" onmouseout="out('-3891780371452029435');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 108           initRecord(false);                                                                             </span>
<span class="-7115068008347678823" onmouseenter="enter('-7115068008347678823');" onmouseout="out('-7115068008347678823');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 109         } else if (mTaskRecord.threadRecords == null || mTaskRecord.threadRecords.isEmpty()) {           </span>
<span class="7876801457309202704" onmouseenter="enter('7876801457309202704');" onmouseout="out('7876801457309202704');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 110           mTaskRecord.threadNum = mAdapter.initTaskThreadNum();                                          </span>
<span class="-3891780371452029435" onmouseenter="enter('-3891780371452029435');" onmouseout="out('-3891780371452029435');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 111           initRecord(false);                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 112         }                                                                                                </span>
<span class="3796057323931724632" onmouseenter="enter('3796057323931724632');" onmouseout="out('3796057323931724632');" style=""> 113 =======                                                                                                  </span>
<span class="-5027112130205478640" onmouseenter="enter('-5027112130205478640');" onmouseout="out('-5027112130205478640');" style=""> 114 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 115       }                                                                                                  </span>
<span class="2603181800050683167" onmouseenter="enter('2603181800050683167');" onmouseout="out('2603181800050683167');" style=""> 116       handlerTaskRecord(mTaskRecord);                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 117     }                                                                                                    </span>
<span class="-4447853798640415053" onmouseenter="enter('-4447853798640415053');" onmouseout="out('-4447853798640415053');" style=""> 118     saveRecord();                                                                                        </span>
<span class="2589344107322293803" onmouseenter="enter('2589344107322293803');" onmouseout="out('2589344107322293803');" style=""> 119     return mTaskRecord;                                                                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 120   }                                                                                                      </span>
<span  style=""> 121                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 122   /**                                                                                                    </span>
<span class="4426545154492852727" onmouseenter="enter('4426545154492852727');" onmouseout="out('4426545154492852727');" style=""> 123    * convertDb 是兼容性代码 从3.4.1开始，线程配置信息将存储在数据库中。 将配置文件的内容复制到数据库中，并将配置文件删除                                  </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 124    */                                                                                                    </span>
<span class="14298455509427519" onmouseenter="enter('14298455509427519');" onmouseout="out('14298455509427519');" style=""> 125   private void convertDb() {                                                                             </span>
<span class="-4598298306615401010" onmouseenter="enter('-4598298306615401010');" onmouseout="out('-4598298306615401010');" style=""> 126     List&lt;RecordWrapper&gt; records =                                                                        </span>
<span class="-4738968014729726274" onmouseenter="enter('-4738968014729726274');" onmouseout="out('-4738968014729726274');" style=""> 127         DbEntity.findRelationData(RecordWrapper.class, &quot;TaskRecord.filePath=?&quot;,                          </span>
<span class="1664646851824584272" onmouseenter="enter('1664646851824584272');" onmouseout="out('1664646851824584272');" style=""> 128             getFilePath());                                                                              </span>
<span class="-376648440877788579" onmouseenter="enter('-376648440877788579');" onmouseout="out('-376648440877788579');" style=""> 129     if (records == null || records.size() == 0) {                                                        </span>
<span class="1734928994769379059" onmouseenter="enter('1734928994769379059');" onmouseout="out('1734928994769379059');" style=""> 130       Properties pro = FileUtil.loadConfig(mConfigFile);                                                 </span>
<span class="-681137634566379888" onmouseenter="enter('-681137634566379888');" onmouseout="out('-681137634566379888');" style=""> 131       if (pro.isEmpty()) {                                                                               </span>
<span class="6270101186355835075" onmouseenter="enter('6270101186355835075');" onmouseout="out('6270101186355835075');" style=""> 132         ALog.d(TAG, &quot;老版本的线程记录为空，任务为新任务&quot;);                                                                </span>
<span class="-6736410795519637054" onmouseenter="enter('-6736410795519637054');" onmouseout="out('-6736410795519637054');" style=""> 133         initRecord(true);                                                                                </span>
<span class="4043029072030362567" onmouseenter="enter('4043029072030362567');" onmouseout="out('4043029072030362567');" style=""> 134         return;                                                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 135       }                                                                                                  </span>
<span  style=""> 136                                                                                                          </span>
<span class="-4092719147494026286" onmouseenter="enter('-4092719147494026286');" onmouseout="out('-4092719147494026286');" style=""> 137       Set&lt;Object&gt; keys = pro.keySet();                                                                   </span>
<span class="7117164647387083506" onmouseenter="enter('7117164647387083506');" onmouseout="out('7117164647387083506');" style=""> 138       // 老版本记录是5s存一次，但是5s中内，如果线程执行完成，record记录是没有的，只有state记录...                                           </span>
<span class="8442347856216504710" onmouseenter="enter('8442347856216504710');" onmouseout="out('8442347856216504710');" style=""> 139       // 第一步应该是record 和 state去重取正确的线程数                                                                   </span>
<span class="3880560860847601414" onmouseenter="enter('3880560860847601414');" onmouseout="out('3880560860847601414');" style=""> 140       Set&lt;Integer&gt; set = new HashSet&lt;&gt;();                                                                </span>
<span class="-5644624400733519290" onmouseenter="enter('-5644624400733519290');" onmouseout="out('-5644624400733519290');" style=""> 141       for (Object key : keys) {                                                                          </span>
<span class="-90111359741489740" onmouseenter="enter('-90111359741489740');" onmouseout="out('-90111359741489740');" style=""> 142         String str = String.valueOf(key);                                                                </span>
<span class="4809237278425345525" onmouseenter="enter('4809237278425345525');" onmouseout="out('4809237278425345525');" style=""> 143         int i = Integer.parseInt(str.substring(str.length() - 1));                                       </span>
<span class="5139166377005733880" onmouseenter="enter('5139166377005733880');" onmouseout="out('5139166377005733880');" style=""> 144         set.add(i);                                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 145       }                                                                                                  </span>
<span class="1773727540275693887" onmouseenter="enter('1773727540275693887');" onmouseout="out('1773727540275693887');" style=""> 146       int threadNum = set.size();                                                                        </span>
<span class="1658307869252768908" onmouseenter="enter('1658307869252768908');" onmouseout="out('1658307869252768908');" style=""> 147       if (threadNum == 0) {                                                                              </span>
<span class="1148319986505262760" onmouseenter="enter('1148319986505262760');" onmouseout="out('1148319986505262760');" style=""> 148         ALog.d(TAG, &quot;线程数为空，任务为新任务&quot;);                                                                     </span>
<span class="-6736410795519637054" onmouseenter="enter('-6736410795519637054');" onmouseout="out('-6736410795519637054');" style=""> 149         initRecord(true);                                                                                </span>
<span class="4043029072030362567" onmouseenter="enter('4043029072030362567');" onmouseout="out('4043029072030362567');" style=""> 150         return;                                                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 151       }                                                                                                  </span>
<span class="7955340223234605" onmouseenter="enter('7955340223234605');" onmouseout="out('7955340223234605');" style=""> 152       mTaskWrapper.setNewTask(false);                                                                    </span>
<span class="-1821078783357105510" onmouseenter="enter('-1821078783357105510');" onmouseout="out('-1821078783357105510');" style=""> 153       mTaskRecord = createTaskRecord(threadNum);                                                         </span>
<span class="7633421891114459750" onmouseenter="enter('7633421891114459750');" onmouseout="out('7633421891114459750');" style=""> 154       mTaskRecord.isBlock = false;                                                                       </span>
<span class="3855509751077495513" onmouseenter="enter('3855509751077495513');" onmouseout="out('3855509751077495513');" style=""> 155       File tempFile = new File(getFilePath());                                                           </span>
<span class="92058997093189211" onmouseenter="enter('92058997093189211');" onmouseout="out('92058997093189211');" style=""> 156       for (int i = 0; i &lt; threadNum; i++) {                                                              </span>
<span class="1846142719149590893" onmouseenter="enter('1846142719149590893');" onmouseout="out('1846142719149590893');" style=""> 157         ThreadRecord tRecord = new ThreadRecord();                                                       </span>
<span class="3723169099876741000" onmouseenter="enter('3723169099876741000');" onmouseout="out('3723169099876741000');" style=""> 158         tRecord.taskKey = mTaskRecord.filePath;                                                          </span>
<span class="5678090729290962283" onmouseenter="enter('5678090729290962283');" onmouseout="out('5678090729290962283');" style=""> 159         Object state = pro.getProperty(tempFile.getName() + STATE + i);                                  </span>
<span class="8491464740929708384" onmouseenter="enter('8491464740929708384');" onmouseout="out('8491464740929708384');" style=""> 160         Object record = pro.getProperty(tempFile.getName() + RECORD + i);                                </span>
<span class="-1417732743646819816" onmouseenter="enter('-1417732743646819816');" onmouseout="out('-1417732743646819816');" style=""> 161         if (state != null &amp;&amp; Integer.parseInt(String.valueOf(state)) == 1) {                             </span>
<span class="-5900743039323389312" onmouseenter="enter('-5900743039323389312');" onmouseout="out('-5900743039323389312');" style=""> 162           tRecord.isComplete = true;                                                                     </span>
<span class="-6362435147834875541" onmouseenter="enter('-6362435147834875541');" onmouseout="out('-6362435147834875541');" style=""> 163           continue;                                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 164         }                                                                                                </span>
<span class="2652986304939921073" onmouseenter="enter('2652986304939921073');" onmouseout="out('2652986304939921073');" style=""> 165         if (record != null) {                                                                            </span>
<span class="7355303051831508853" onmouseenter="enter('7355303051831508853');" onmouseout="out('7355303051831508853');" style=""> 166           long temp = Long.parseLong(String.valueOf(record));                                            </span>
<span class="6949017848225026676" onmouseenter="enter('6949017848225026676');" onmouseout="out('6949017848225026676');" style=""> 167           tRecord.startLocation = temp &gt; 0 ? temp : 0;                                                   </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 168         } else {                                                                                         </span>
<span class="-2463924567028920967" onmouseenter="enter('-2463924567028920967');" onmouseout="out('-2463924567028920967');" style=""> 169           tRecord.startLocation = 0;                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 170         }                                                                                                </span>
<span class="-6865700341156428088" onmouseenter="enter('-6865700341156428088');" onmouseout="out('-6865700341156428088');" style=""> 171         mTaskRecord.threadRecords.add(tRecord);                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 172       }                                                                                                  </span>
<span class="4367383752983568604" onmouseenter="enter('4367383752983568604');" onmouseout="out('4367383752983568604');" style=""> 173       FileUtil.deleteFile(mConfigFile);                                                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 174     }                                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 175   }                                                                                                      </span>
<span  style=""> 176                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 177   /**                                                                                                    </span>
<span class="8463391589973071562" onmouseenter="enter('8463391589973071562');" onmouseout="out('8463391589973071562');" style=""> 178    * 初始化任务记录，分配线程区间，如果任务记录不存在，则创建新的任务记录                                                                  </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 179    *                                                                                                     </span>
<span class="-3744851117936265295" onmouseenter="enter('-3744851117936265295');" onmouseout="out('-3744851117936265295');" style=""> 180    * @param newRecord {@code true} 需要创建新{@link TaskRecord}                                               </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 181    */                                                                                                    </span>
<span class="1766652104121073893" onmouseenter="enter('1766652104121073893');" onmouseout="out('1766652104121073893');" style=""> 182   private void initRecord(boolean newRecord) {                                                           </span>
<span class="6048435392166168608" onmouseenter="enter('6048435392166168608');" onmouseout="out('6048435392166168608');" style=""> 183     if (newRecord) {                                                                                     </span>
<span class="3987778045821889500" onmouseenter="enter('3987778045821889500');" onmouseout="out('3987778045821889500');" style=""> 184       mTaskRecord = createTaskRecord(initTaskThreadNum());                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 185     }                                                                                                    </span>
<span class="-1512381015788610352" onmouseenter="enter('-1512381015788610352');" onmouseout="out('-1512381015788610352');" style=""> 186     mTaskWrapper.setNewTask(true);                                                                       </span>
<span class="-3721642619055872692" onmouseenter="enter('-3721642619055872692');" onmouseout="out('-3721642619055872692');" style=""> 187     int requestType = mTaskWrapper.getRequestType();                                                     </span>
<span class="3748431468753436023" onmouseenter="enter('3748431468753436023');" onmouseout="out('3748431468753436023');" style=""> 188     if (requestType == ITaskWrapper.M3U8_LIVE) {                                                         </span>
<span class="4043029072030362567" onmouseenter="enter('4043029072030362567');" onmouseout="out('4043029072030362567');" style=""> 189       return;                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 190     }                                                                                                    </span>
<span class="1600220578687832077" onmouseenter="enter('1600220578687832077');" onmouseout="out('1600220578687832077');" style=""> 191     long blockSize = mEntity.getFileSize() / mTaskRecord.threadNum;                                      </span>
<span class="-4436010189640816687" onmouseenter="enter('-4436010189640816687');" onmouseout="out('-4436010189640816687');" style=""> 192     // 处理线程区间记录                                                                                          </span>
<span class="-8559683407759389663" onmouseenter="enter('-8559683407759389663');" onmouseout="out('-8559683407759389663');" style=""> 193     for (int i = 0; i &lt; mTaskRecord.threadNum; i++) {                                                    </span>
<span class="-2965725495076654490" onmouseenter="enter('-2965725495076654490');" onmouseout="out('-2965725495076654490');" style=""> 194       long startL = i * blockSize, endL = (i + 1) * blockSize;                                           </span>
<span class="5894722016696267883" onmouseenter="enter('5894722016696267883');" onmouseout="out('5894722016696267883');" style=""> 195       ThreadRecord tr = createThreadRecord(mTaskRecord, i, startL, endL);                                </span>
<span class="-6805201278378671560" onmouseenter="enter('-6805201278378671560');" onmouseout="out('-6805201278378671560');" style=""> 196       mTaskRecord.threadRecords.add(tr);                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 197     }                                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 198   }                                                                                                      </span>
<span  style=""> 199                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 200   /**                                                                                                    </span>
<span class="-8991940256279851469" onmouseenter="enter('-8991940256279851469');" onmouseout="out('-8991940256279851469');" style=""> 201    * 保存任务记录                                                                                              </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 202    */                                                                                                    </span>
<span class="1188287987342183098" onmouseenter="enter('1188287987342183098');" onmouseout="out('1188287987342183098');" style=""> 203   private void saveRecord() {                                                                            </span>
<span class="323794376596875286" onmouseenter="enter('323794376596875286');" onmouseout="out('323794376596875286');" style=""> 204     mTaskRecord.threadNum = mTaskRecord.threadRecords.size();                                            </span>
<span class="345625468264837114" onmouseenter="enter('345625468264837114');" onmouseout="out('345625468264837114');" style=""> 205     mTaskRecord.save();                                                                                  </span>
<span class="-3701039002002731049" onmouseenter="enter('-3701039002002731049');" onmouseout="out('-3701039002002731049');" style=""> 206     if (mTaskRecord.threadRecords != null &amp;&amp; !mTaskRecord.threadRecords.isEmpty()) {                     </span>
<span class="2432664825672590881" onmouseenter="enter('2432664825672590881');" onmouseout="out('2432664825672590881');" style=""> 207       DbEntity.saveAll(mTaskRecord.threadRecords);                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 208     }                                                                                                    </span>
<span class="-1161286805066448242" onmouseenter="enter('-1161286805066448242');" onmouseout="out('-1161286805066448242');" style=""> 209     ALog.d(TAG, String.format(&quot;保存记录，线程记录数：%s&quot;, mTaskRecord.threadRecords.size()));                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 210   }                                                                                                      </span>
<span  style=""> 211                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 212   /**                                                                                                    </span>
<span class="-5152727538261600286" onmouseenter="enter('-5152727538261600286');" onmouseout="out('-5152727538261600286');" style=""> 213    * 获取任务路径                                                                                              </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 214    *                                                                                                     </span>
<span class="-2815134136997967815" onmouseenter="enter('-2815134136997967815');" onmouseout="out('-2815134136997967815');" style=""> 215    * @return 任务文件路径                                                                                      </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 216    */                                                                                                    </span>
<span class="-8326432688154281329" onmouseenter="enter('-8326432688154281329');" onmouseout="out('-8326432688154281329');" style=""> 217   private String getFilePath() {                                                                         </span>
<span class="4415201624474066138" onmouseenter="enter('4415201624474066138');" onmouseout="out('4415201624474066138');" style=""> 218     if (mEntity instanceof DownloadEntity) {                                                             </span>
<span class="-8422380947915573606" onmouseenter="enter('-8422380947915573606');" onmouseout="out('-8422380947915573606');" style=""> 219       return ((DownloadEntity) mTaskWrapper.getEntity()).getFilePath();                                  </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 220     } else {                                                                                             </span>
<span class="-2519282598545089845" onmouseenter="enter('-2519282598545089845');" onmouseout="out('-2519282598545089845');" style=""> 221       return ((UploadEntity) mTaskWrapper.getEntity()).getFilePath();                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 222     }                                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 223   }                                                                                                      </span>
<span  style=""> 224                                                                                                          </span>
<span class="4486979386009511061" onmouseenter="enter('4486979386009511061');" onmouseout="out('4486979386009511061');" style=""> 225   @Override public void accept(ILoaderVisitor visitor) {                                                 </span>
<span class="-5407432854577292854" onmouseenter="enter('-5407432854577292854');" onmouseout="out('-5407432854577292854');" style=""> 226     visitor.addComponent(this);                                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 227   }                                                                                                      </span>
<span  style=""> 228                                                                                                          </span>
<span class="5822606900778148603" onmouseenter="enter('5822606900778148603');" onmouseout="out('5822606900778148603');" style=""> 229   @Override public boolean checkTaskCompleted() {                                                        </span>
<span class="7676423467312835669" onmouseenter="enter('7676423467312835669');" onmouseout="out('7676423467312835669');" style=""> 230     if (mTaskRecord == null                                                                              </span>
<span class="-5287811101982291105" onmouseenter="enter('-5287811101982291105');" onmouseout="out('-5287811101982291105');" style=""> 231         || mTaskRecord.threadRecords == null                                                             </span>
<span class="-3537982277811084340" onmouseenter="enter('-3537982277811084340');" onmouseout="out('-3537982277811084340');" style=""> 232         || mTaskRecord.threadRecords.isEmpty()) {                                                        </span>
<span class="-5432226360745882584" onmouseenter="enter('-5432226360745882584');" onmouseout="out('-5432226360745882584');" style=""> 233       return false;                                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 234     }                                                                                                    </span>
<span class="4151685609487095982" onmouseenter="enter('4151685609487095982');" onmouseout="out('4151685609487095982');" style=""> 235     int completeNum = 0;                                                                                 </span>
<span class="-7590052688485059950" onmouseenter="enter('-7590052688485059950');" onmouseout="out('-7590052688485059950');" style=""> 236     for (ThreadRecord tr : mTaskRecord.threadRecords) {                                                  </span>
<span class="-6249885869558348483" onmouseenter="enter('-6249885869558348483');" onmouseout="out('-6249885869558348483');" style=""> 237       if (tr.isComplete) {                                                                               </span>
<span class="-1832473639842396112" onmouseenter="enter('-1832473639842396112');" onmouseout="out('-1832473639842396112');" style=""> 238         completeNum++;                                                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 239       }                                                                                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 240     }                                                                                                    </span>
<span class="-3614550293302262544" onmouseenter="enter('-3614550293302262544');" onmouseout="out('-3614550293302262544');" style=""> 241     return completeNum != 0 &amp;&amp; completeNum == mTaskRecord.threadNum;                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 242   }                                                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 243 }                                                                                                        </span>






















</pre></td>
                            <td><pre><span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style="">   1 /*                                                                                                       </span>
<span class="-4176855950178531235" onmouseenter="enter('-4176855950178531235');" onmouseout="out('-4176855950178531235');" style="">   2  * Copyright (C) 2016 AriaLyy(https://github.com/AriaLyy/Aria)                                           </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">   3  *                                                                                                       </span>
<span class="-7144700690364548245" onmouseenter="enter('-7144700690364548245');" onmouseout="out('-7144700690364548245');" style="">   4  * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);                                       </span>
<span class="-6614298523444173250" onmouseenter="enter('-6614298523444173250');" onmouseout="out('-6614298523444173250');" style="">   5  * you may not use this file except in compliance with the License.                                      </span>
<span class="-4753901504248728101" onmouseenter="enter('-4753901504248728101');" onmouseout="out('-4753901504248728101');" style="">   6  * You may obtain a copy of the License at                                                               </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">   7  *                                                                                                       </span>
<span class="-763207030729826407" onmouseenter="enter('-763207030729826407');" onmouseout="out('-763207030729826407');" style="">   8  *      http://www.apache.org/licenses/LICENSE-2.0                                                       </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">   9  *                                                                                                       </span>
<span class="2557607632756179983" onmouseenter="enter('2557607632756179983');" onmouseout="out('2557607632756179983');" style="">  10  * Unless required by applicable law or agreed to in writing, software                                   </span>
<span class="-9189129105512731955" onmouseenter="enter('-9189129105512731955');" onmouseout="out('-9189129105512731955');" style="">  11  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,                                     </span>
<span class="5781161717946418340" onmouseenter="enter('5781161717946418340');" onmouseout="out('5781161717946418340');" style="">  12  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.                              </span>
<span class="1761562277992059393" onmouseenter="enter('1761562277992059393');" onmouseout="out('1761562277992059393');" style="">  13  * See the License for the specific language governing permissions and                                   </span>
<span class="7217408601297779962" onmouseenter="enter('7217408601297779962');" onmouseout="out('7217408601297779962');" style="">  14  * limitations under the License.                                                                        </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  15  */                                                                                                      </span>
<span class="-5592048915404489240" onmouseenter="enter('-5592048915404489240');" onmouseout="out('-5592048915404489240');" style="">  16 package com.arialyy.aria.core.common;                                                                    </span>
<span  style="">  17                                                                                                          </span>
<span class="7150685219957576571" onmouseenter="enter('7150685219957576571');" onmouseout="out('7150685219957576571');" style="">  18 import com.arialyy.aria.core.TaskRecord;                                                                 </span>
<span class="-7662986158836731995" onmouseenter="enter('-7662986158836731995');" onmouseout="out('-7662986158836731995');" style="">  19 import com.arialyy.aria.core.ThreadRecord;                                                               </span>
<span class="1932658903610588883" onmouseenter="enter('1932658903610588883');" onmouseout="out('1932658903610588883');" style="">  20 import com.arialyy.aria.core.download.DownloadEntity;                                                    </span>
<span class="-3079874842134488668" onmouseenter="enter('-3079874842134488668');" onmouseout="out('-3079874842134488668');" style="">  21 import com.arialyy.aria.core.loader.ILoaderVisitor;                                                      </span>
<span class="-9014417511727405835" onmouseenter="enter('-9014417511727405835');" onmouseout="out('-9014417511727405835');" style="">  22 import com.arialyy.aria.core.loader.IRecordHandler;                                                      </span>
<span class="-5831681804875068292" onmouseenter="enter('-5831681804875068292');" onmouseout="out('-5831681804875068292');" style="">  23 import com.arialyy.aria.core.upload.UploadEntity;                                                        </span>
<span class="-2181497863142513098" onmouseenter="enter('-2181497863142513098');" onmouseout="out('-2181497863142513098');" style="">  24 import com.arialyy.aria.core.wrapper.AbsTaskWrapper;                                                     </span>
<span class="2481088621669901079" onmouseenter="enter('2481088621669901079');" onmouseout="out('2481088621669901079');" style="">  25 import com.arialyy.aria.core.wrapper.ITaskWrapper;                                                       </span>
<span class="-4361229816664464434" onmouseenter="enter('-4361229816664464434');" onmouseout="out('-4361229816664464434');" style="">  26 import com.arialyy.aria.core.wrapper.RecordWrapper;                                                      </span>
<span class="-4499301116755301031" onmouseenter="enter('-4499301116755301031');" onmouseout="out('-4499301116755301031');" style="">  27 import com.arialyy.aria.orm.DbEntity;                                                                    </span>
<span class="-3586495952513455611" onmouseenter="enter('-3586495952513455611');" onmouseout="out('-3586495952513455611');" style="">  28 import com.arialyy.aria.util.ALog;                                                                       </span>
<span class="-3106139894727218967" onmouseenter="enter('-3106139894727218967');" onmouseout="out('-3106139894727218967');" style="">  29 import com.arialyy.aria.util.CommonUtil;                                                                 </span>
<span class="-5216410147421847074" onmouseenter="enter('-5216410147421847074');" onmouseout="out('-5216410147421847074');" style="">  30 import com.arialyy.aria.util.DbDataHelper;                                                               </span>
<span class="-563266023018163236" onmouseenter="enter('-563266023018163236');" onmouseout="out('-563266023018163236');" style="">  31 import com.arialyy.aria.util.FileUtil;                                                                   </span>
<span class="-3926401431737521278" onmouseenter="enter('-3926401431737521278');" onmouseout="out('-3926401431737521278');" style="">  32 import java.io.File;                                                                                     </span>
<span class="-1320562196372945707" onmouseenter="enter('-1320562196372945707');" onmouseout="out('-1320562196372945707');" style="">  33 import java.util.HashSet;                                                                                </span>
<span class="-1786020958497218848" onmouseenter="enter('-1786020958497218848');" onmouseout="out('-1786020958497218848');" style="">  34 import java.util.List;                                                                                   </span>
<span class="1689171550873420012" onmouseenter="enter('1689171550873420012');" onmouseout="out('1689171550873420012');" style="">  35 import java.util.Properties;                                                                             </span>
<span class="3384353015976675773" onmouseenter="enter('3384353015976675773');" onmouseout="out('3384353015976675773');" style="">  36 import java.util.Set;                                                                                    </span>
<span  style="">  37                                                                                                          </span>
<span  style="">  38                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  39 /**                                                                                                      </span>
<span class="2736882465778481894" onmouseenter="enter('2736882465778481894');" onmouseout="out('2736882465778481894');" style="">  40  * 处理任务记录，分配线程区间                                                                                         </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  41  */                                                                                                      </span>
<span class="4487114878540249679" onmouseenter="enter('4487114878540249679');" onmouseout="out('4487114878540249679');" style="">  42 public abstract class RecordHandler implements IRecordHandler {                                          </span>
<span class="-6385414676469589348" onmouseenter="enter('-6385414676469589348');" onmouseout="out('-6385414676469589348');" style="">  43   protected final String TAG = CommonUtil.getClassName(this);                                            </span>
<span  style="">  44                                                                                                          </span>
<span class="-6913167534336436900" onmouseenter="enter('-6913167534336436900');" onmouseout="out('-6913167534336436900');" style="">  45   @Deprecated private File mConfigFile;                                                                  </span>
<span  style="">  46                                                                                                          </span>
<span class="-8877097513462838969" onmouseenter="enter('-8877097513462838969');" onmouseout="out('-8877097513462838969');" style="">  47   private TaskRecord mTaskRecord;                                                                        </span>
<span  style="">  48                                                                                                          </span>
<span class="-8022183237541885590" onmouseenter="enter('-8022183237541885590');" onmouseout="out('-8022183237541885590');" style="">  49   private AbsTaskWrapper mTaskWrapper;                                                                   </span>
<span  style="">  50                                                                                                          </span>
<span class="-2477248167481204479" onmouseenter="enter('-2477248167481204479');" onmouseout="out('-2477248167481204479');" style="">  51   private AbsNormalEntity mEntity;                                                                       </span>
<span  style="">  52                                                                                                          </span>
<span class="-4800954456425527235" onmouseenter="enter('-4800954456425527235');" onmouseout="out('-4800954456425527235');" style="">  53   public RecordHandler(AbsTaskWrapper wrapper) {                                                         </span>
<span class="-4483703319181095288" onmouseenter="enter('-4483703319181095288');" onmouseout="out('-4483703319181095288');" style="">  54     mTaskWrapper = wrapper;                                                                              </span>
<span class="8427113411089340440" onmouseenter="enter('8427113411089340440');" onmouseout="out('8427113411089340440');" style="">  55     mEntity = ((AbsNormalEntity) (mTaskWrapper.getEntity()));                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  56   }                                                                                                      </span>
<span  style="">  57                                                                                                          </span>
<span class="-8652295380638743348" onmouseenter="enter('-8652295380638743348');" onmouseout="out('-8652295380638743348');" style="">  58   public AbsTaskWrapper getWrapper() {                                                                   </span>
<span class="-6199220384104149910" onmouseenter="enter('-6199220384104149910');" onmouseout="out('-6199220384104149910');" style="">  59     return mTaskWrapper;                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  60   }                                                                                                      </span>
<span  style="">  61                                                                                                          </span>
<span class="-3197578047902101869" onmouseenter="enter('-3197578047902101869');" onmouseout="out('-3197578047902101869');" style="">  62   public AbsNormalEntity getEntity() {                                                                   </span>
<span class="-2978486956956616380" onmouseenter="enter('-2978486956956616380');" onmouseout="out('-2978486956956616380');" style="">  63     return mEntity;                                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  64   }                                                                                                      </span>
<span  style="">  65                                                                                                          </span>
<span class="1941248740392522719" onmouseenter="enter('1941248740392522719');" onmouseout="out('1941248740392522719');" style="">  66   @Override public void onPre() {                                                                        </span>
<span  style="">  67                                                                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  68   }                                                                                                      </span>
<span  style="">  69                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  70   /**                                                                                                    </span>
<span class="-4523044754040360039" onmouseenter="enter('-4523044754040360039');" onmouseout="out('-4523044754040360039');" style="">  71    * 获取任务记录，如果任务记录存在，检查任务记录                                                                              </span>
<span class="-994801055868135316" onmouseenter="enter('-994801055868135316');" onmouseout="out('-994801055868135316');" style="">  72    * 检查记录 对于分块任务： 子分块不存在或被删除，子线程将重新下载                                                                    </span>
<span class="-5335970434013572058" onmouseenter="enter('-5335970434013572058');" onmouseout="out('-5335970434013572058');" style="">  73    * 对于普通任务： 预下载文件不存在，则任务任务呗删除                                                                           </span>
<span class="6742381731051832150" onmouseenter="enter('6742381731051832150');" onmouseout="out('6742381731051832150');" style="">  74    * 如果任务记录不存在或线程记录不存在，初始化记录                                                                             </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  75    *                                                                                                     </span>
<span class="2644027277083576426" onmouseenter="enter('2644027277083576426');" onmouseout="out('2644027277083576426');" style="">  76    * @return 任务记录                                                                                        </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  77    */                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style="">  78   @Override                                                                                              </span>
<span class="1066955891247002122" onmouseenter="enter('1066955891247002122');" onmouseout="out('1066955891247002122');" style="">  79   public TaskRecord getRecord() {                                                                        </span>
<span class="-5297450492380711808" onmouseenter="enter('-5297450492380711808');" onmouseout="out('-5297450492380711808');" style="">  80     mConfigFile = new File(CommonUtil.getFileConfigPath(false, mEntity.getFileName()));                  </span>
<span class="4951157766975006439" onmouseenter="enter('4951157766975006439');" onmouseout="out('4951157766975006439');" style="">  81     if (mConfigFile.exists()) {                                                                          </span>
<span class="7932310618145443523" onmouseenter="enter('7932310618145443523');" onmouseout="out('7932310618145443523');" style="">  82       convertDb();                                                                                       </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style="">  83     } else {                                                                                             </span>
<span class="5012053197150764509" onmouseenter="enter('5012053197150764509');" onmouseout="out('5012053197150764509');" style="">  84       onPre();                                                                                           </span>
<span class="-4126650542682918148" onmouseenter="enter('-4126650542682918148');" onmouseout="out('-4126650542682918148');" style="">  85       mTaskRecord = DbDataHelper.getTaskRecord(getFilePath(), mEntity.getTaskType());                    </span>
<span class="4057372030095958349" onmouseenter="enter('4057372030095958349');" onmouseout="out('4057372030095958349');" style="">  86       if (mTaskRecord == null) {                                                                         </span>
<span class="-6736410795519637054" onmouseenter="enter('-6736410795519637054');" onmouseout="out('-6736410795519637054');" style="">  87         initRecord(true);                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  88       }                                                                                                  </span>
<span class="2603181800050683167" onmouseenter="enter('2603181800050683167');" onmouseout="out('2603181800050683167');" style="">  89       handlerTaskRecord(mTaskRecord);                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  90     }                                                                                                    </span>
<span class="-4447853798640415053" onmouseenter="enter('-4447853798640415053');" onmouseout="out('-4447853798640415053');" style="">  91     saveRecord();                                                                                        </span>
<span class="2589344107322293803" onmouseenter="enter('2589344107322293803');" onmouseout="out('2589344107322293803');" style="">  92     return mTaskRecord;                                                                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  93   }                                                                                                      </span>
<span  style="">  94                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  95   /**                                                                                                    </span>
<span class="4426545154492852727" onmouseenter="enter('4426545154492852727');" onmouseout="out('4426545154492852727');" style="">  96    * convertDb 是兼容性代码 从3.4.1开始，线程配置信息将存储在数据库中。 将配置文件的内容复制到数据库中，并将配置文件删除                                  </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  97    */                                                                                                    </span>
<span class="14298455509427519" onmouseenter="enter('14298455509427519');" onmouseout="out('14298455509427519');" style="">  98   private void convertDb() {                                                                             </span>
<span class="-6953199364570575829" onmouseenter="enter('-6953199364570575829');" onmouseout="out('-6953199364570575829');" style=""><abbr title="  99     List&lt;RecordWrapper&gt; records = DbEntity.findRelationData(RecordWrapper.class, &quot;TaskRecord.filePath=?&quot;, getFilePath());">  99     List&lt;RecordWrapper&gt; records = DbEntity.findRelationData(RecordWrapper.class, &quot;TaskRecord.filePath=?&quot;,🔵</abbr></span>
<span class="7278848626178308451" onmouseenter="enter('7278848626178308451');" onmouseout="out('7278848626178308451');" style=""> 100     if ((records == null) || (records.size() == 0)) {                                                    </span>
<span class="1734928994769379059" onmouseenter="enter('1734928994769379059');" onmouseout="out('1734928994769379059');" style=""> 101       Properties pro = FileUtil.loadConfig(mConfigFile);                                                 </span>
<span class="-681137634566379888" onmouseenter="enter('-681137634566379888');" onmouseout="out('-681137634566379888');" style=""> 102       if (pro.isEmpty()) {                                                                               </span>
<span class="6270101186355835075" onmouseenter="enter('6270101186355835075');" onmouseout="out('6270101186355835075');" style=""> 103         ALog.d(TAG, &quot;老版本的线程记录为空，任务为新任务&quot;);                                                                </span>
<span class="-6736410795519637054" onmouseenter="enter('-6736410795519637054');" onmouseout="out('-6736410795519637054');" style=""> 104         initRecord(true);                                                                                </span>
<span class="4043029072030362567" onmouseenter="enter('4043029072030362567');" onmouseout="out('4043029072030362567');" style=""> 105         return;                                                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 106       }                                                                                                  </span>
<span class="-4092719147494026286" onmouseenter="enter('-4092719147494026286');" onmouseout="out('-4092719147494026286');" style=""> 107       Set&lt;Object&gt; keys = pro.keySet();                                                                   </span>
<span class="7117164647387083506" onmouseenter="enter('7117164647387083506');" onmouseout="out('7117164647387083506');" style=""> 108       // 老版本记录是5s存一次，但是5s中内，如果线程执行完成，record记录是没有的，只有state记录...                                           </span>
<span class="8442347856216504710" onmouseenter="enter('8442347856216504710');" onmouseout="out('8442347856216504710');" style=""> 109       // 第一步应该是record 和 state去重取正确的线程数                                                                   </span>
<span class="3880560860847601414" onmouseenter="enter('3880560860847601414');" onmouseout="out('3880560860847601414');" style=""> 110       Set&lt;Integer&gt; set = new HashSet&lt;&gt;();                                                                </span>
<span class="-5644624400733519290" onmouseenter="enter('-5644624400733519290');" onmouseout="out('-5644624400733519290');" style=""> 111       for (Object key : keys) {                                                                          </span>
<span class="-90111359741489740" onmouseenter="enter('-90111359741489740');" onmouseout="out('-90111359741489740');" style=""> 112         String str = String.valueOf(key);                                                                </span>
<span class="4809237278425345525" onmouseenter="enter('4809237278425345525');" onmouseout="out('4809237278425345525');" style=""> 113         int i = Integer.parseInt(str.substring(str.length() - 1));                                       </span>
<span class="5139166377005733880" onmouseenter="enter('5139166377005733880');" onmouseout="out('5139166377005733880');" style=""> 114         set.add(i);                                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 115       }                                                                                                  </span>
<span class="1773727540275693887" onmouseenter="enter('1773727540275693887');" onmouseout="out('1773727540275693887');" style=""> 116       int threadNum = set.size();                                                                        </span>
<span class="1658307869252768908" onmouseenter="enter('1658307869252768908');" onmouseout="out('1658307869252768908');" style=""> 117       if (threadNum == 0) {                                                                              </span>
<span class="1148319986505262760" onmouseenter="enter('1148319986505262760');" onmouseout="out('1148319986505262760');" style=""> 118         ALog.d(TAG, &quot;线程数为空，任务为新任务&quot;);                                                                     </span>
<span class="-6736410795519637054" onmouseenter="enter('-6736410795519637054');" onmouseout="out('-6736410795519637054');" style=""> 119         initRecord(true);                                                                                </span>
<span class="4043029072030362567" onmouseenter="enter('4043029072030362567');" onmouseout="out('4043029072030362567');" style=""> 120         return;                                                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 121       }                                                                                                  </span>
<span class="7955340223234605" onmouseenter="enter('7955340223234605');" onmouseout="out('7955340223234605');" style=""> 122       mTaskWrapper.setNewTask(false);                                                                    </span>
<span class="-1821078783357105510" onmouseenter="enter('-1821078783357105510');" onmouseout="out('-1821078783357105510');" style=""> 123       mTaskRecord = createTaskRecord(threadNum);                                                         </span>
<span class="7633421891114459750" onmouseenter="enter('7633421891114459750');" onmouseout="out('7633421891114459750');" style=""> 124       mTaskRecord.isBlock = false;                                                                       </span>
<span class="3855509751077495513" onmouseenter="enter('3855509751077495513');" onmouseout="out('3855509751077495513');" style=""> 125       File tempFile = new File(getFilePath());                                                           </span>
<span class="92058997093189211" onmouseenter="enter('92058997093189211');" onmouseout="out('92058997093189211');" style=""> 126       for (int i = 0; i &lt; threadNum; i++) {                                                              </span>
<span class="1846142719149590893" onmouseenter="enter('1846142719149590893');" onmouseout="out('1846142719149590893');" style=""> 127         ThreadRecord tRecord = new ThreadRecord();                                                       </span>
<span class="3723169099876741000" onmouseenter="enter('3723169099876741000');" onmouseout="out('3723169099876741000');" style=""> 128         tRecord.taskKey = mTaskRecord.filePath;                                                          </span>
<span class="-4767534231008311294" onmouseenter="enter('-4767534231008311294');" onmouseout="out('-4767534231008311294');" style=""> 129         Object state = pro.getProperty((tempFile.getName() + STATE) + i);                                </span>
<span class="4338664947864463930" onmouseenter="enter('4338664947864463930');" onmouseout="out('4338664947864463930');" style=""> 130         Object record = pro.getProperty((tempFile.getName() + RECORD) + i);                              </span>
<span class="1026644309865482777" onmouseenter="enter('1026644309865482777');" onmouseout="out('1026644309865482777');" style=""> 131         if ((state != null) &amp;&amp; (Integer.parseInt(String.valueOf(state)) == 1)) {                         </span>
<span class="-5900743039323389312" onmouseenter="enter('-5900743039323389312');" onmouseout="out('-5900743039323389312');" style=""> 132           tRecord.isComplete = true;                                                                     </span>
<span class="-6362435147834875541" onmouseenter="enter('-6362435147834875541');" onmouseout="out('-6362435147834875541');" style=""> 133           continue;                                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 134         }                                                                                                </span>
<span class="2652986304939921073" onmouseenter="enter('2652986304939921073');" onmouseout="out('2652986304939921073');" style=""> 135         if (record != null) {                                                                            </span>
<span class="7355303051831508853" onmouseenter="enter('7355303051831508853');" onmouseout="out('7355303051831508853');" style=""> 136           long temp = Long.parseLong(String.valueOf(record));                                            </span>
<span class="-219197065740086809" onmouseenter="enter('-219197065740086809');" onmouseout="out('-219197065740086809');" style=""> 137           tRecord.startLocation = (temp &gt; 0) ? temp : 0;                                                 </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 138         } else {                                                                                         </span>
<span class="-2463924567028920967" onmouseenter="enter('-2463924567028920967');" onmouseout="out('-2463924567028920967');" style=""> 139           tRecord.startLocation = 0;                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 140         }                                                                                                </span>
<span class="-6865700341156428088" onmouseenter="enter('-6865700341156428088');" onmouseout="out('-6865700341156428088');" style=""> 141         mTaskRecord.threadRecords.add(tRecord);                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 142       }                                                                                                  </span>
<span class="4367383752983568604" onmouseenter="enter('4367383752983568604');" onmouseout="out('4367383752983568604');" style=""> 143       FileUtil.deleteFile(mConfigFile);                                                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 144     }                                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 145   }                                                                                                      </span>
<span  style=""> 146                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 147   /**                                                                                                    </span>
<span class="8463391589973071562" onmouseenter="enter('8463391589973071562');" onmouseout="out('8463391589973071562');" style=""> 148    * 初始化任务记录，分配线程区间，如果任务记录不存在，则创建新的任务记录                                                                  </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 149    *                                                                                                     </span>
<span class="-3744851117936265295" onmouseenter="enter('-3744851117936265295');" onmouseout="out('-3744851117936265295');" style=""> 150    * @param newRecord {@code true} 需要创建新{@link TaskRecord}                                               </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 151    */                                                                                                    </span>
<span class="1766652104121073893" onmouseenter="enter('1766652104121073893');" onmouseout="out('1766652104121073893');" style=""> 152   private void initRecord(boolean newRecord) {                                                           </span>
<span class="6048435392166168608" onmouseenter="enter('6048435392166168608');" onmouseout="out('6048435392166168608');" style=""> 153     if (newRecord) {                                                                                     </span>
<span class="3987778045821889500" onmouseenter="enter('3987778045821889500');" onmouseout="out('3987778045821889500');" style=""> 154       mTaskRecord = createTaskRecord(initTaskThreadNum());                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 155     }                                                                                                    </span>
<span class="-1512381015788610352" onmouseenter="enter('-1512381015788610352');" onmouseout="out('-1512381015788610352');" style=""> 156     mTaskWrapper.setNewTask(true);                                                                       </span>
<span class="-3721642619055872692" onmouseenter="enter('-3721642619055872692');" onmouseout="out('-3721642619055872692');" style=""> 157     int requestType = mTaskWrapper.getRequestType();                                                     </span>
<span class="3748431468753436023" onmouseenter="enter('3748431468753436023');" onmouseout="out('3748431468753436023');" style=""> 158     if (requestType == ITaskWrapper.M3U8_LIVE) {                                                         </span>
<span class="4043029072030362567" onmouseenter="enter('4043029072030362567');" onmouseout="out('4043029072030362567');" style=""> 159       return;                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 160     }                                                                                                    </span>
<span class="1600220578687832077" onmouseenter="enter('1600220578687832077');" onmouseout="out('1600220578687832077');" style=""> 161     long blockSize = mEntity.getFileSize() / mTaskRecord.threadNum;                                      </span>
<span class="-4436010189640816687" onmouseenter="enter('-4436010189640816687');" onmouseout="out('-4436010189640816687');" style=""> 162     // 处理线程区间记录                                                                                          </span>
<span class="-8559683407759389663" onmouseenter="enter('-8559683407759389663');" onmouseout="out('-8559683407759389663');" style=""> 163     for (int i = 0; i &lt; mTaskRecord.threadNum; i++) {                                                    </span>
<span class="7621964356592003253" onmouseenter="enter('7621964356592003253');" onmouseout="out('7621964356592003253');" style=""> 164       long startL = i * blockSize;                                                                       </span>
<span class="6763390455321275778" onmouseenter="enter('6763390455321275778');" onmouseout="out('6763390455321275778');" style=""> 165       long endL = (i + 1) * blockSize;                                                                   </span>
<span class="5894722016696267883" onmouseenter="enter('5894722016696267883');" onmouseout="out('5894722016696267883');" style=""> 166       ThreadRecord tr = createThreadRecord(mTaskRecord, i, startL, endL);                                </span>
<span class="-6805201278378671560" onmouseenter="enter('-6805201278378671560');" onmouseout="out('-6805201278378671560');" style=""> 167       mTaskRecord.threadRecords.add(tr);                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 168     }                                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 169   }                                                                                                      </span>
<span  style=""> 170                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 171   /**                                                                                                    </span>
<span class="-8991940256279851469" onmouseenter="enter('-8991940256279851469');" onmouseout="out('-8991940256279851469');" style=""> 172    * 保存任务记录                                                                                              </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 173    */                                                                                                    </span>
<span class="1188287987342183098" onmouseenter="enter('1188287987342183098');" onmouseout="out('1188287987342183098');" style=""> 174   private void saveRecord() {                                                                            </span>
<span class="323794376596875286" onmouseenter="enter('323794376596875286');" onmouseout="out('323794376596875286');" style=""> 175     mTaskRecord.threadNum = mTaskRecord.threadRecords.size();                                            </span>
<span class="345625468264837114" onmouseenter="enter('345625468264837114');" onmouseout="out('345625468264837114');" style=""> 176     mTaskRecord.save();                                                                                  </span>
<span class="-3701039002002731049" onmouseenter="enter('-3701039002002731049');" onmouseout="out('-3701039002002731049');" style=""> 177     if (mTaskRecord.threadRecords != null &amp;&amp; !mTaskRecord.threadRecords.isEmpty()) {                     </span>
<span class="2432664825672590881" onmouseenter="enter('2432664825672590881');" onmouseout="out('2432664825672590881');" style=""> 178       DbEntity.saveAll(mTaskRecord.threadRecords);                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 179     }                                                                                                    </span>
<span class="-1161286805066448242" onmouseenter="enter('-1161286805066448242');" onmouseout="out('-1161286805066448242');" style=""> 180     ALog.d(TAG, String.format(&quot;保存记录，线程记录数：%s&quot;, mTaskRecord.threadRecords.size()));                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 181   }                                                                                                      </span>
<span  style=""> 182                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 183   /**                                                                                                    </span>
<span class="-5152727538261600286" onmouseenter="enter('-5152727538261600286');" onmouseout="out('-5152727538261600286');" style=""> 184    * 获取任务路径                                                                                              </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 185    *                                                                                                     </span>
<span class="-2815134136997967815" onmouseenter="enter('-2815134136997967815');" onmouseout="out('-2815134136997967815');" style=""> 186    * @return 任务文件路径                                                                                      </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 187    */                                                                                                    </span>
<span class="-8326432688154281329" onmouseenter="enter('-8326432688154281329');" onmouseout="out('-8326432688154281329');" style=""> 188   private String getFilePath() {                                                                         </span>
<span class="4415201624474066138" onmouseenter="enter('4415201624474066138');" onmouseout="out('4415201624474066138');" style=""> 189     if (mEntity instanceof DownloadEntity) {                                                             </span>
<span class="-8422380947915573606" onmouseenter="enter('-8422380947915573606');" onmouseout="out('-8422380947915573606');" style=""> 190       return ((DownloadEntity) mTaskWrapper.getEntity()).getFilePath();                                  </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 191     } else {                                                                                             </span>
<span class="-2519282598545089845" onmouseenter="enter('-2519282598545089845');" onmouseout="out('-2519282598545089845');" style=""> 192       return ((UploadEntity) mTaskWrapper.getEntity()).getFilePath();                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 193     }                                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 194   }                                                                                                      </span>
<span  style=""> 195                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 196   @Override                                                                                              </span>
<span class="634606438038095608" onmouseenter="enter('634606438038095608');" onmouseout="out('634606438038095608');" style=""> 197   public void accept(ILoaderVisitor visitor) {                                                           </span>
<span class="-5407432854577292854" onmouseenter="enter('-5407432854577292854');" onmouseout="out('-5407432854577292854');" style=""> 198     visitor.addComponent(this);                                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 199   }                                                                                                      </span>
<span  style=""> 200                                                                                                          </span>
<span class="5822606900778148603" onmouseenter="enter('5822606900778148603');" onmouseout="out('5822606900778148603');" style=""> 201   @Override public boolean checkTaskCompleted() {                                                        </span>
<span class="7676423467312835669" onmouseenter="enter('7676423467312835669');" onmouseout="out('7676423467312835669');" style=""> 202     if (mTaskRecord == null                                                                              </span>
<span class="-5287811101982291105" onmouseenter="enter('-5287811101982291105');" onmouseout="out('-5287811101982291105');" style=""> 203         || mTaskRecord.threadRecords == null                                                             </span>
<span class="-3537982277811084340" onmouseenter="enter('-3537982277811084340');" onmouseout="out('-3537982277811084340');" style=""> 204         || mTaskRecord.threadRecords.isEmpty()) {                                                        </span>
<span class="-5432226360745882584" onmouseenter="enter('-5432226360745882584');" onmouseout="out('-5432226360745882584');" style=""> 205       return false;                                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 206     }                                                                                                    </span>
<span class="4151685609487095982" onmouseenter="enter('4151685609487095982');" onmouseout="out('4151685609487095982');" style=""> 207     int completeNum = 0;                                                                                 </span>
<span class="-7590052688485059950" onmouseenter="enter('-7590052688485059950');" onmouseout="out('-7590052688485059950');" style=""> 208     for (ThreadRecord tr : mTaskRecord.threadRecords) {                                                  </span>
<span class="-6249885869558348483" onmouseenter="enter('-6249885869558348483');" onmouseout="out('-6249885869558348483');" style=""> 209       if (tr.isComplete) {                                                                               </span>
<span class="-1832473639842396112" onmouseenter="enter('-1832473639842396112');" onmouseout="out('-1832473639842396112');" style=""> 210         completeNum++;                                                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 211       }                                                                                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 212     }                                                                                                    </span>
<span class="-3614550293302262544" onmouseenter="enter('-3614550293302262544');" onmouseout="out('-3614550293302262544');" style=""> 213     return completeNum != 0 &amp;&amp; completeNum == mTaskRecord.threadNum;                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 214   }                                                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 215 }                                                                                                        </span>


















































</pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre><span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style="">   1  /*                                                                                                                </span>
<span class="-4176855950178531235" onmouseenter="enter('-4176855950178531235');" onmouseout="out('-4176855950178531235');" style="">   2   * Copyright (C) 2016 AriaLyy(https://github.com/AriaLyy/Aria)                                                    </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">   3   *                                                                                                                </span>
<span class="-7144700690364548245" onmouseenter="enter('-7144700690364548245');" onmouseout="out('-7144700690364548245');" style="">   4   * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);                                                </span>
<span class="-6614298523444173250" onmouseenter="enter('-6614298523444173250');" onmouseout="out('-6614298523444173250');" style="">   5   * you may not use this file except in compliance with the License.                                               </span>
<span class="-4753901504248728101" onmouseenter="enter('-4753901504248728101');" onmouseout="out('-4753901504248728101');" style="">   6   * You may obtain a copy of the License at                                                                        </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">   7   *                                                                                                                </span>
<span class="-763207030729826407" onmouseenter="enter('-763207030729826407');" onmouseout="out('-763207030729826407');" style="">   8   *      http://www.apache.org/licenses/LICENSE-2.0                                                                </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">   9   *                                                                                                                </span>
<span class="2557607632756179983" onmouseenter="enter('2557607632756179983');" onmouseout="out('2557607632756179983');" style="">  10   * Unless required by applicable law or agreed to in writing, software                                            </span>
<span class="-9189129105512731955" onmouseenter="enter('-9189129105512731955');" onmouseout="out('-9189129105512731955');" style="">  11   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,                                              </span>
<span class="5781161717946418340" onmouseenter="enter('5781161717946418340');" onmouseout="out('5781161717946418340');" style="">  12   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.                                       </span>
<span class="1761562277992059393" onmouseenter="enter('1761562277992059393');" onmouseout="out('1761562277992059393');" style="">  13   * See the License for the specific language governing permissions and                                            </span>
<span class="7217408601297779962" onmouseenter="enter('7217408601297779962');" onmouseout="out('7217408601297779962');" style="">  14   * limitations under the License.                                                                                 </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  15   */                                                                                                               </span>
<span class="-5592048915404489240" onmouseenter="enter('-5592048915404489240');" onmouseout="out('-5592048915404489240');" style="">  16  package com.arialyy.aria.core.common;                                                                             </span>
<span  style="">  17                                                                                                                    </span>
<span class="7150685219957576571" onmouseenter="enter('7150685219957576571');" onmouseout="out('7150685219957576571');" style="">  18  import com.arialyy.aria.core.TaskRecord;                                                                          </span>
<span class="-7662986158836731995" onmouseenter="enter('-7662986158836731995');" onmouseout="out('-7662986158836731995');" style="">  19  import com.arialyy.aria.core.ThreadRecord;                                                                        </span>
<span class="1932658903610588883" onmouseenter="enter('1932658903610588883');" onmouseout="out('1932658903610588883');" style="">  20  import com.arialyy.aria.core.download.DownloadEntity;                                                             </span>
<span class="-6660438116294188466" onmouseenter="enter('-6660438116294188466');" onmouseout="out('-6660438116294188466');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  21 -import com.arialyy.aria.core.inf.IRecordHandler;                                                                  </span>
<span class="6596076366739461251" onmouseenter="enter('6596076366739461251');" onmouseout="out('6596076366739461251');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  22 -import com.arialyy.aria.core.inf.IRecordHandlerAdapter;                                                           </span>
<span class="-3079874842134488668" onmouseenter="enter('-3079874842134488668');" onmouseout="out('-3079874842134488668');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  23 +import com.arialyy.aria.core.loader.ILoaderVisitor;                                                               </span>
<span class="-9014417511727405835" onmouseenter="enter('-9014417511727405835');" onmouseout="out('-9014417511727405835');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  24 +import com.arialyy.aria.core.loader.IRecordHandler;                                                               </span>
<span class="-5831681804875068292" onmouseenter="enter('-5831681804875068292');" onmouseout="out('-5831681804875068292');" style="">  25  import com.arialyy.aria.core.upload.UploadEntity;                                                                 </span>
<span class="-2181497863142513098" onmouseenter="enter('-2181497863142513098');" onmouseout="out('-2181497863142513098');" style="">  26  import com.arialyy.aria.core.wrapper.AbsTaskWrapper;                                                              </span>
<span class="2481088621669901079" onmouseenter="enter('2481088621669901079');" onmouseout="out('2481088621669901079');" style="">  27  import com.arialyy.aria.core.wrapper.ITaskWrapper;                                                                </span>
<span class="-4361229816664464434" onmouseenter="enter('-4361229816664464434');" onmouseout="out('-4361229816664464434');" style="">  28  import com.arialyy.aria.core.wrapper.RecordWrapper;                                                               </span>
<span class="-4499301116755301031" onmouseenter="enter('-4499301116755301031');" onmouseout="out('-4499301116755301031');" style="">  29  import com.arialyy.aria.orm.DbEntity;                                                                             </span>
<span class="-3586495952513455611" onmouseenter="enter('-3586495952513455611');" onmouseout="out('-3586495952513455611');" style="">  30  import com.arialyy.aria.util.ALog;                                                                                </span>
<span class="-3106139894727218967" onmouseenter="enter('-3106139894727218967');" onmouseout="out('-3106139894727218967');" style="">  31  import com.arialyy.aria.util.CommonUtil;                                                                          </span>
<span class="-5216410147421847074" onmouseenter="enter('-5216410147421847074');" onmouseout="out('-5216410147421847074');" style="">  32  import com.arialyy.aria.util.DbDataHelper;                                                                        </span>
<span class="-563266023018163236" onmouseenter="enter('-563266023018163236');" onmouseout="out('-563266023018163236');" style="">  33  import com.arialyy.aria.util.FileUtil;                                                                            </span>
<span class="-3926401431737521278" onmouseenter="enter('-3926401431737521278');" onmouseout="out('-3926401431737521278');" style="">  34  import java.io.File;                                                                                              </span>
<span class="-1320562196372945707" onmouseenter="enter('-1320562196372945707');" onmouseout="out('-1320562196372945707');" style="">  35  import java.util.HashSet;                                                                                         </span>
<span class="-1786020958497218848" onmouseenter="enter('-1786020958497218848');" onmouseout="out('-1786020958497218848');" style="">  36  import java.util.List;                                                                                            </span>
<span class="1689171550873420012" onmouseenter="enter('1689171550873420012');" onmouseout="out('1689171550873420012');" style="">  37  import java.util.Properties;                                                                                      </span>
<span class="3384353015976675773" onmouseenter="enter('3384353015976675773');" onmouseout="out('3384353015976675773');" style="">  38  import java.util.Set;                                                                                             </span>
<span  style="">  39                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  40  /**                                                                                                               </span>
<span class="2736882465778481894" onmouseenter="enter('2736882465778481894');" onmouseout="out('2736882465778481894');" style="">  41   * 处理任务记录，分配线程区间                                                                                                  </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  42   */                                                                                                               </span>
<span class="-7787161997225496484" onmouseenter="enter('-7787161997225496484');" onmouseout="out('-7787161997225496484');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  43 -public class RecordHandler implements IRecordHandler {                                                            </span>
<span class="3291406156585340518" onmouseenter="enter('3291406156585340518');" onmouseout="out('3291406156585340518');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  44 -  private final String TAG = &quot;RecordHandler&quot;;                                                                     </span>
<span class="4487114878540249679" onmouseenter="enter('4487114878540249679');" onmouseout="out('4487114878540249679');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  45 +public abstract class RecordHandler implements IRecordHandler {                                                   </span>
<span class="-6385414676469589348" onmouseenter="enter('-6385414676469589348');" onmouseout="out('-6385414676469589348');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  46 +  protected final String TAG = CommonUtil.getClassName(this);                                                     </span>
<span  style="">  47                                                                                                                    </span>
<span class="-6913167534336436900" onmouseenter="enter('-6913167534336436900');" onmouseout="out('-6913167534336436900');" style="">  48    @Deprecated private File mConfigFile;                                                                           </span>
<span class="-8877097513462838969" onmouseenter="enter('-8877097513462838969');" onmouseout="out('-8877097513462838969');" style="">  49    private TaskRecord mTaskRecord;                                                                                 </span>
<span class="-8022183237541885590" onmouseenter="enter('-8022183237541885590');" onmouseout="out('-8022183237541885590');" style="">  50    private AbsTaskWrapper mTaskWrapper;                                                                            </span>
<span class="-2477248167481204479" onmouseenter="enter('-2477248167481204479');" onmouseout="out('-2477248167481204479');" style="">  51    private AbsNormalEntity mEntity;                                                                                </span>
<span class="-1669965154521629443" onmouseenter="enter('-1669965154521629443');" onmouseout="out('-1669965154521629443');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  52 -  private IRecordHandlerAdapter mAdapter;                                                                         </span>
<span  style="">  53                                                                                                                    </span>
<span class="-4800954456425527235" onmouseenter="enter('-4800954456425527235');" onmouseout="out('-4800954456425527235');" style="">  54    public RecordHandler(AbsTaskWrapper wrapper) {                                                                  </span>
<span class="-4483703319181095288" onmouseenter="enter('-4483703319181095288');" onmouseout="out('-4483703319181095288');" style="">  55      mTaskWrapper = wrapper;                                                                                       </span>
<span class="-2477156305516257248" onmouseenter="enter('-2477156305516257248');" onmouseout="out('-2477156305516257248');" style="">  56      mEntity = (AbsNormalEntity) mTaskWrapper.getEntity();                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  57    }                                                                                                               </span>
<span  style="">  58                                                                                                                    </span>
<span class="3305577849379453561" onmouseenter="enter('3305577849379453561');" onmouseout="out('3305577849379453561');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  59 -  public void setAdapter(IRecordHandlerAdapter mAdapter) {                                                        </span>
<span class="-2226079758135238337" onmouseenter="enter('-2226079758135238337');" onmouseout="out('-2226079758135238337');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  60 -    this.mAdapter = mAdapter;                                                                                     </span>
<span class="-8652295380638743348" onmouseenter="enter('-8652295380638743348');" onmouseout="out('-8652295380638743348');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  61 +  public AbsTaskWrapper getWrapper() {                                                                            </span>
<span class="-6199220384104149910" onmouseenter="enter('-6199220384104149910');" onmouseout="out('-6199220384104149910');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  62 +    return mTaskWrapper;                                                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  63 +  }                                                                                                               </span>
<span  style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  64 +                                                                                                                  </span>
<span class="-3197578047902101869" onmouseenter="enter('-3197578047902101869');" onmouseout="out('-3197578047902101869');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  65 +  public AbsNormalEntity getEntity() {                                                                            </span>
<span class="-2978486956956616380" onmouseenter="enter('-2978486956956616380');" onmouseout="out('-2978486956956616380');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  66 +    return mEntity;                                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  67 +  }                                                                                                               </span>
<span  style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  68 +                                                                                                                  </span>
<span class="1941248740392522719" onmouseenter="enter('1941248740392522719');" onmouseout="out('1941248740392522719');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  69 +  @Override public void onPre() {                                                                                 </span>
<span  style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  70 +                                                                                                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  71    }                                                                                                               </span>
<span  style="">  72                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  73    /**                                                                                                             </span>
<span class="-4523044754040360039" onmouseenter="enter('-4523044754040360039');" onmouseout="out('-4523044754040360039');" style="">  74     * 获取任务记录，如果任务记录存在，检查任务记录                                                                                       </span>
<span class="-994801055868135316" onmouseenter="enter('-994801055868135316');" onmouseout="out('-994801055868135316');" style="">  75     * 检查记录 对于分块任务： 子分块不存在或被删除，子线程将重新下载                                                                             </span>
<span class="-5335970434013572058" onmouseenter="enter('-5335970434013572058');" onmouseout="out('-5335970434013572058');" style="">  76     * 对于普通任务： 预下载文件不存在，则任务任务呗删除                                                                                    </span>
<span class="6742381731051832150" onmouseenter="enter('6742381731051832150');" onmouseout="out('6742381731051832150');" style="">  77     * 如果任务记录不存在或线程记录不存在，初始化记录                                                                                      </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  78     *                                                                                                              </span>
<span class="2644027277083576426" onmouseenter="enter('2644027277083576426');" onmouseout="out('2644027277083576426');" style="">  79     * @return 任务记录                                                                                                 </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  80     */                                                                                                             </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style="">  81    @Override                                                                                                       </span>
<span class="1066955891247002122" onmouseenter="enter('1066955891247002122');" onmouseout="out('1066955891247002122');" style="">  82    public TaskRecord getRecord() {                                                                                 </span>
<span class="-5297450492380711808" onmouseenter="enter('-5297450492380711808');" onmouseout="out('-5297450492380711808');" style="">  83      mConfigFile = new File(CommonUtil.getFileConfigPath(false, mEntity.getFileName()));                           </span>
<span class="4951157766975006439" onmouseenter="enter('4951157766975006439');" onmouseout="out('4951157766975006439');" style="">  84      if (mConfigFile.exists()) {                                                                                   </span>
<span class="7932310618145443523" onmouseenter="enter('7932310618145443523');" onmouseout="out('7932310618145443523');" style="">  85        convertDb();                                                                                                </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style="">  86      } else {                                                                                                      </span>
<span class="7296682852134477027" onmouseenter="enter('7296682852134477027');" onmouseout="out('7296682852134477027');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  87 -      mAdapter.onPre();                                                                                           </span>
<span class="5012053197150764509" onmouseenter="enter('5012053197150764509');" onmouseout="out('5012053197150764509');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  88 +      onPre();                                                                                                    </span>
<span class="-4126650542682918148" onmouseenter="enter('-4126650542682918148');" onmouseout="out('-4126650542682918148');" style="">  89        mTaskRecord = DbDataHelper.getTaskRecord(getFilePath(), mEntity.getTaskType());                             </span>
<span class="4057372030095958349" onmouseenter="enter('4057372030095958349');" onmouseout="out('4057372030095958349');" style="">  90        if (mTaskRecord == null) {                                                                                  </span>
<span class="574535391222419428" onmouseenter="enter('574535391222419428');" onmouseout="out('574535391222419428');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  91 -        if (!new File(getFilePath()).exists()){                                                                   </span>
<span class="7671762782338977921" onmouseenter="enter('7671762782338977921');" onmouseout="out('7671762782338977921');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  92 +        if (!new File(getFilePath()).exists()) {                                                                  </span>
<span class="158751631392391592" onmouseenter="enter('158751631392391592');" onmouseout="out('158751631392391592');" style="">  93            FileUtil.createFile(getFilePath());                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  94          }                                                                                                         </span>
<span class="-6736410795519637054" onmouseenter="enter('-6736410795519637054');" onmouseout="out('-6736410795519637054');" style="">  95          initRecord(true);                                                                                         </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style="">  96        } else {                                                                                                    </span>
<span class="-4007091416322407417" onmouseenter="enter('-4007091416322407417');" onmouseout="out('-4007091416322407417');" style="">  97          File file = new File(mTaskRecord.filePath);                                                               </span>
<span class="4133240422546463755" onmouseenter="enter('4133240422546463755');" onmouseout="out('4133240422546463755');" style="">  98          if (!file.exists()) {                                                                                     </span>
<span class="8386365718316155314" onmouseenter="enter('8386365718316155314');" onmouseout="out('8386365718316155314');" style="">  99            ALog.w(TAG, String.format(&quot;文件【%s】不存在，重新分配线程区间&quot;, mTaskRecord.filePath));                                 </span>
<span class="3147181738283157854" onmouseenter="enter('3147181738283157854');" onmouseout="out('3147181738283157854');" style=""> 100            DbEntity.deleteData(ThreadRecord.class, &quot;taskKey=?&quot;, mTaskRecord.filePath);                             </span>
<span class="5854365307602457529" onmouseenter="enter('5854365307602457529');" onmouseout="out('5854365307602457529');" style=""> 101            mTaskRecord.threadRecords.clear();                                                                      </span>
<span class="7876801457309202704" onmouseenter="enter('7876801457309202704');" onmouseout="out('7876801457309202704');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 102 -          mTaskRecord.threadNum = mAdapter.initTaskThreadNum();                                                   </span>
<span class="-7640715801341958211" onmouseenter="enter('-7640715801341958211');" onmouseout="out('-7640715801341958211');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 103 +          mTaskRecord.threadNum = initTaskThreadNum();                                                            </span>
<span class="-3891780371452029435" onmouseenter="enter('-3891780371452029435');" onmouseout="out('-3891780371452029435');" style=""> 104            initRecord(false);                                                                                      </span>
<span class="-7115068008347678823" onmouseenter="enter('-7115068008347678823');" onmouseout="out('-7115068008347678823');" style=""> 105          } else if (mTaskRecord.threadRecords == null || mTaskRecord.threadRecords.isEmpty()) {                    </span>
<span class="7876801457309202704" onmouseenter="enter('7876801457309202704');" onmouseout="out('7876801457309202704');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 106 -          mTaskRecord.threadNum = mAdapter.initTaskThreadNum();                                                   </span>
<span class="-7640715801341958211" onmouseenter="enter('-7640715801341958211');" onmouseout="out('-7640715801341958211');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 107 +          mTaskRecord.threadNum = initTaskThreadNum();                                                            </span>
<span class="-3891780371452029435" onmouseenter="enter('-3891780371452029435');" onmouseout="out('-3891780371452029435');" style=""> 108            initRecord(false);                                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 109          }                                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 110        }                                                                                                           </span>
<span class="5534914312730067566" onmouseenter="enter('5534914312730067566');" onmouseout="out('5534914312730067566');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 111 -      mAdapter.handlerTaskRecord(mTaskRecord);                                                                    </span>
<span class="2603181800050683167" onmouseenter="enter('2603181800050683167');" onmouseout="out('2603181800050683167');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 112 +      handlerTaskRecord(mTaskRecord);                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 113      }                                                                                                             </span>
<span class="-4447853798640415053" onmouseenter="enter('-4447853798640415053');" onmouseout="out('-4447853798640415053');" style=""> 114      saveRecord();                                                                                                 </span>
<span class="2589344107322293803" onmouseenter="enter('2589344107322293803');" onmouseout="out('2589344107322293803');" style=""> 115      return mTaskRecord;                                                                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 116    }                                                                                                               </span>
<span  style=""> 117                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 118    /**                                                                                                             </span>
<span class="4426545154492852727" onmouseenter="enter('4426545154492852727');" onmouseout="out('4426545154492852727');" style=""> 119     * convertDb 是兼容性代码 从3.4.1开始，线程配置信息将存储在数据库中。 将配置文件的内容复制到数据库中，并将配置文件删除                                           </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 120     */                                                                                                             </span>
<span class="14298455509427519" onmouseenter="enter('14298455509427519');" onmouseout="out('14298455509427519');" style=""> 121    private void convertDb() {                                                                                      </span>
<span class="-4598298306615401010" onmouseenter="enter('-4598298306615401010');" onmouseout="out('-4598298306615401010');" style=""> 122      List&lt;RecordWrapper&gt; records =                                                                                 </span>
<span class="-4738968014729726274" onmouseenter="enter('-4738968014729726274');" onmouseout="out('-4738968014729726274');" style=""> 123          DbEntity.findRelationData(RecordWrapper.class, &quot;TaskRecord.filePath=?&quot;,                                   </span>
<span class="1664646851824584272" onmouseenter="enter('1664646851824584272');" onmouseout="out('1664646851824584272');" style=""> 124              getFilePath());                                                                                       </span>
<span class="-376648440877788579" onmouseenter="enter('-376648440877788579');" onmouseout="out('-376648440877788579');" style=""> 125      if (records == null || records.size() == 0) {                                                                 </span>
<span class="1734928994769379059" onmouseenter="enter('1734928994769379059');" onmouseout="out('1734928994769379059');" style=""> 126        Properties pro = FileUtil.loadConfig(mConfigFile);                                                          </span>
<span class="-681137634566379888" onmouseenter="enter('-681137634566379888');" onmouseout="out('-681137634566379888');" style=""> 127        if (pro.isEmpty()) {                                                                                        </span>
<span class="6270101186355835075" onmouseenter="enter('6270101186355835075');" onmouseout="out('6270101186355835075');" style=""> 128          ALog.d(TAG, &quot;老版本的线程记录为空，任务为新任务&quot;);                                                                         </span>
<span class="-6736410795519637054" onmouseenter="enter('-6736410795519637054');" onmouseout="out('-6736410795519637054');" style=""> 129          initRecord(true);                                                                                         </span>
<span class="4043029072030362567" onmouseenter="enter('4043029072030362567');" onmouseout="out('4043029072030362567');" style=""> 130          return;                                                                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 131        }                                                                                                           </span>
<span  style=""> 132                                                                                                                    </span>
<span class="-4092719147494026286" onmouseenter="enter('-4092719147494026286');" onmouseout="out('-4092719147494026286');" style=""> 133        Set&lt;Object&gt; keys = pro.keySet();                                                                            </span>
<span class="7117164647387083506" onmouseenter="enter('7117164647387083506');" onmouseout="out('7117164647387083506');" style=""> 134        // 老版本记录是5s存一次，但是5s中内，如果线程执行完成，record记录是没有的，只有state记录...                                                    </span>
<span class="8442347856216504710" onmouseenter="enter('8442347856216504710');" onmouseout="out('8442347856216504710');" style=""> 135        // 第一步应该是record 和 state去重取正确的线程数                                                                            </span>
<span class="3880560860847601414" onmouseenter="enter('3880560860847601414');" onmouseout="out('3880560860847601414');" style=""> 136        Set&lt;Integer&gt; set = new HashSet&lt;&gt;();                                                                         </span>
<span class="-5644624400733519290" onmouseenter="enter('-5644624400733519290');" onmouseout="out('-5644624400733519290');" style=""> 137        for (Object key : keys) {                                                                                   </span>
<span class="-90111359741489740" onmouseenter="enter('-90111359741489740');" onmouseout="out('-90111359741489740');" style=""> 138          String str = String.valueOf(key);                                                                         </span>
<span class="4809237278425345525" onmouseenter="enter('4809237278425345525');" onmouseout="out('4809237278425345525');" style=""> 139          int i = Integer.parseInt(str.substring(str.length() - 1));                                                </span>
<span class="5139166377005733880" onmouseenter="enter('5139166377005733880');" onmouseout="out('5139166377005733880');" style=""> 140          set.add(i);                                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 141        }                                                                                                           </span>
<span class="1773727540275693887" onmouseenter="enter('1773727540275693887');" onmouseout="out('1773727540275693887');" style=""> 142        int threadNum = set.size();                                                                                 </span>
<span class="1658307869252768908" onmouseenter="enter('1658307869252768908');" onmouseout="out('1658307869252768908');" style=""> 143        if (threadNum == 0) {                                                                                       </span>
<span class="1148319986505262760" onmouseenter="enter('1148319986505262760');" onmouseout="out('1148319986505262760');" style=""> 144          ALog.d(TAG, &quot;线程数为空，任务为新任务&quot;);                                                                              </span>
<span class="-6736410795519637054" onmouseenter="enter('-6736410795519637054');" onmouseout="out('-6736410795519637054');" style=""> 145          initRecord(true);                                                                                         </span>
<span class="4043029072030362567" onmouseenter="enter('4043029072030362567');" onmouseout="out('4043029072030362567');" style=""> 146          return;                                                                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 147        }                                                                                                           </span>
<span class="7955340223234605" onmouseenter="enter('7955340223234605');" onmouseout="out('7955340223234605');" style=""> 148        mTaskWrapper.setNewTask(false);                                                                             </span>
<span class="5491689444108456019" onmouseenter="enter('5491689444108456019');" onmouseout="out('5491689444108456019');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 149 -      mTaskRecord = mAdapter.createTaskRecord(threadNum);                                                         </span>
<span class="-1821078783357105510" onmouseenter="enter('-1821078783357105510');" onmouseout="out('-1821078783357105510');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 150 +      mTaskRecord = createTaskRecord(threadNum);                                                                  </span>
<span class="7633421891114459750" onmouseenter="enter('7633421891114459750');" onmouseout="out('7633421891114459750');" style=""> 151        mTaskRecord.isBlock = false;                                                                                </span>
<span class="3855509751077495513" onmouseenter="enter('3855509751077495513');" onmouseout="out('3855509751077495513');" style=""> 152        File tempFile = new File(getFilePath());                                                                    </span>
<span class="92058997093189211" onmouseenter="enter('92058997093189211');" onmouseout="out('92058997093189211');" style=""> 153        for (int i = 0; i &lt; threadNum; i++) {                                                                       </span>
<span class="1846142719149590893" onmouseenter="enter('1846142719149590893');" onmouseout="out('1846142719149590893');" style=""> 154          ThreadRecord tRecord = new ThreadRecord();                                                                </span>
<span class="3723169099876741000" onmouseenter="enter('3723169099876741000');" onmouseout="out('3723169099876741000');" style=""> 155          tRecord.taskKey = mTaskRecord.filePath;                                                                   </span>
<span class="5678090729290962283" onmouseenter="enter('5678090729290962283');" onmouseout="out('5678090729290962283');" style=""> 156          Object state = pro.getProperty(tempFile.getName() + STATE + i);                                           </span>
<span class="8491464740929708384" onmouseenter="enter('8491464740929708384');" onmouseout="out('8491464740929708384');" style=""> 157          Object record = pro.getProperty(tempFile.getName() + RECORD + i);                                         </span>
<span class="-1417732743646819816" onmouseenter="enter('-1417732743646819816');" onmouseout="out('-1417732743646819816');" style=""> 158          if (state != null &amp;&amp; Integer.parseInt(String.valueOf(state)) == 1) {                                      </span>
<span class="-5900743039323389312" onmouseenter="enter('-5900743039323389312');" onmouseout="out('-5900743039323389312');" style=""> 159            tRecord.isComplete = true;                                                                              </span>
<span class="-6362435147834875541" onmouseenter="enter('-6362435147834875541');" onmouseout="out('-6362435147834875541');" style=""> 160            continue;                                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 161          }                                                                                                         </span>
<span class="2652986304939921073" onmouseenter="enter('2652986304939921073');" onmouseout="out('2652986304939921073');" style=""> 162          if (record != null) {                                                                                     </span>
<span class="7355303051831508853" onmouseenter="enter('7355303051831508853');" onmouseout="out('7355303051831508853');" style=""> 163            long temp = Long.parseLong(String.valueOf(record));                                                     </span>
<span class="6949017848225026676" onmouseenter="enter('6949017848225026676');" onmouseout="out('6949017848225026676');" style=""> 164            tRecord.startLocation = temp &gt; 0 ? temp : 0;                                                            </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 165          } else {                                                                                                  </span>
<span class="-2463924567028920967" onmouseenter="enter('-2463924567028920967');" onmouseout="out('-2463924567028920967');" style=""> 166            tRecord.startLocation = 0;                                                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 167          }                                                                                                         </span>
<span class="-6865700341156428088" onmouseenter="enter('-6865700341156428088');" onmouseout="out('-6865700341156428088');" style=""> 168          mTaskRecord.threadRecords.add(tRecord);                                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 169        }                                                                                                           </span>
<span class="4367383752983568604" onmouseenter="enter('4367383752983568604');" onmouseout="out('4367383752983568604');" style=""> 170        FileUtil.deleteFile(mConfigFile);                                                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 171      }                                                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 172    }                                                                                                               </span>
<span  style=""> 173                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 174    /**                                                                                                             </span>
<span class="8463391589973071562" onmouseenter="enter('8463391589973071562');" onmouseout="out('8463391589973071562');" style=""> 175     * 初始化任务记录，分配线程区间，如果任务记录不存在，则创建新的任务记录                                                                           </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 176     *                                                                                                              </span>
<span class="-3744851117936265295" onmouseenter="enter('-3744851117936265295');" onmouseout="out('-3744851117936265295');" style=""> 177     * @param newRecord {@code true} 需要创建新{@link TaskRecord}                                                        </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 178     */                                                                                                             </span>
<span class="1766652104121073893" onmouseenter="enter('1766652104121073893');" onmouseout="out('1766652104121073893');" style=""> 179    private void initRecord(boolean newRecord) {                                                                    </span>
<span class="6048435392166168608" onmouseenter="enter('6048435392166168608');" onmouseout="out('6048435392166168608');" style=""> 180      if (newRecord) {                                                                                              </span>
<span class="3042121584580047914" onmouseenter="enter('3042121584580047914');" onmouseout="out('3042121584580047914');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 181 -      mTaskRecord = mAdapter.createTaskRecord(mAdapter.initTaskThreadNum());                                      </span>
<span class="3987778045821889500" onmouseenter="enter('3987778045821889500');" onmouseout="out('3987778045821889500');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 182 +      mTaskRecord = createTaskRecord(initTaskThreadNum());                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 183      }                                                                                                             </span>
<span class="-1512381015788610352" onmouseenter="enter('-1512381015788610352');" onmouseout="out('-1512381015788610352');" style=""> 184      mTaskWrapper.setNewTask(true);                                                                                </span>
<span class="-3721642619055872692" onmouseenter="enter('-3721642619055872692');" onmouseout="out('-3721642619055872692');" style=""> 185      int requestType = mTaskWrapper.getRequestType();                                                              </span>
<span class="3748431468753436023" onmouseenter="enter('3748431468753436023');" onmouseout="out('3748431468753436023');" style=""> 186      if (requestType == ITaskWrapper.M3U8_LIVE) {                                                                  </span>
<span class="4043029072030362567" onmouseenter="enter('4043029072030362567');" onmouseout="out('4043029072030362567');" style=""> 187        return;                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 188      }                                                                                                             </span>
<span class="1600220578687832077" onmouseenter="enter('1600220578687832077');" onmouseout="out('1600220578687832077');" style=""> 189      long blockSize = mEntity.getFileSize() / mTaskRecord.threadNum;                                               </span>
<span class="-4436010189640816687" onmouseenter="enter('-4436010189640816687');" onmouseout="out('-4436010189640816687');" style=""> 190      // 处理线程区间记录                                                                                                   </span>
<span class="-8559683407759389663" onmouseenter="enter('-8559683407759389663');" onmouseout="out('-8559683407759389663');" style=""> 191      for (int i = 0; i &lt; mTaskRecord.threadNum; i++) {                                                             </span>
<span class="-2965725495076654490" onmouseenter="enter('-2965725495076654490');" onmouseout="out('-2965725495076654490');" style=""> 192        long startL = i * blockSize, endL = (i + 1) * blockSize;                                                    </span>
<span class="-8537254312133948488" onmouseenter="enter('-8537254312133948488');" onmouseout="out('-8537254312133948488');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 193 -      ThreadRecord tr = mAdapter.createThreadRecord(mTaskRecord, i, startL, endL);                                </span>
<span class="5894722016696267883" onmouseenter="enter('5894722016696267883');" onmouseout="out('5894722016696267883');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 194 +      ThreadRecord tr = createThreadRecord(mTaskRecord, i, startL, endL);                                         </span>
<span class="-6805201278378671560" onmouseenter="enter('-6805201278378671560');" onmouseout="out('-6805201278378671560');" style=""> 195        mTaskRecord.threadRecords.add(tr);                                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 196      }                                                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 197    }                                                                                                               </span>
<span  style=""> 198                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 199    /**                                                                                                             </span>
<span class="-8991940256279851469" onmouseenter="enter('-8991940256279851469');" onmouseout="out('-8991940256279851469');" style=""> 200     * 保存任务记录                                                                                                       </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 201     */                                                                                                             </span>
<span class="1188287987342183098" onmouseenter="enter('1188287987342183098');" onmouseout="out('1188287987342183098');" style=""> 202    private void saveRecord() {                                                                                     </span>
<span class="323794376596875286" onmouseenter="enter('323794376596875286');" onmouseout="out('323794376596875286');" style=""> 203      mTaskRecord.threadNum = mTaskRecord.threadRecords.size();                                                     </span>
<span class="345625468264837114" onmouseenter="enter('345625468264837114');" onmouseout="out('345625468264837114');" style=""> 204      mTaskRecord.save();                                                                                           </span>
<span class="-3701039002002731049" onmouseenter="enter('-3701039002002731049');" onmouseout="out('-3701039002002731049');" style=""> 205      if (mTaskRecord.threadRecords != null &amp;&amp; !mTaskRecord.threadRecords.isEmpty()) {                              </span>
<span class="2432664825672590881" onmouseenter="enter('2432664825672590881');" onmouseout="out('2432664825672590881');" style=""> 206        DbEntity.saveAll(mTaskRecord.threadRecords);                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 207      }                                                                                                             </span>
<span class="-1161286805066448242" onmouseenter="enter('-1161286805066448242');" onmouseout="out('-1161286805066448242');" style=""> 208      ALog.d(TAG, String.format(&quot;保存记录，线程记录数：%s&quot;, mTaskRecord.threadRecords.size()));                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 209    }                                                                                                               </span>
<span  style=""> 210                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 211    /**                                                                                                             </span>
<span class="-5152727538261600286" onmouseenter="enter('-5152727538261600286');" onmouseout="out('-5152727538261600286');" style=""> 212     * 获取任务路径                                                                                                       </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 213     *                                                                                                              </span>
<span class="-2815134136997967815" onmouseenter="enter('-2815134136997967815');" onmouseout="out('-2815134136997967815');" style=""> 214     * @return 任务文件路径                                                                                               </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 215     */                                                                                                             </span>
<span class="-8326432688154281329" onmouseenter="enter('-8326432688154281329');" onmouseout="out('-8326432688154281329');" style=""> 216    private String getFilePath() {                                                                                  </span>
<span class="4415201624474066138" onmouseenter="enter('4415201624474066138');" onmouseout="out('4415201624474066138');" style=""> 217      if (mEntity instanceof DownloadEntity) {                                                                      </span>
<span class="-8422380947915573606" onmouseenter="enter('-8422380947915573606');" onmouseout="out('-8422380947915573606');" style=""> 218        return ((DownloadEntity) mTaskWrapper.getEntity()).getFilePath();                                           </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 219      } else {                                                                                                      </span>
<span class="-2519282598545089845" onmouseenter="enter('-2519282598545089845');" onmouseout="out('-2519282598545089845');" style=""> 220        return ((UploadEntity) mTaskWrapper.getEntity()).getFilePath();                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 221      }                                                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 222    }                                                                                                               </span>
<span  style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 223 +                                                                                                                  </span>
<span class="4486979386009511061" onmouseenter="enter('4486979386009511061');" onmouseout="out('4486979386009511061');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 224 +  @Override public void accept(ILoaderVisitor visitor) {                                                          </span>
<span class="-5407432854577292854" onmouseenter="enter('-5407432854577292854');" onmouseout="out('-5407432854577292854');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 225 +    visitor.addComponent(this);                                                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 226 +  }                                                                                                               </span>
<span  style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 227 +                                                                                                                  </span>
<span class="5822606900778148603" onmouseenter="enter('5822606900778148603');" onmouseout="out('5822606900778148603');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 228 +  @Override public boolean checkTaskCompleted() {                                                                 </span>
<span class="7676423467312835669" onmouseenter="enter('7676423467312835669');" onmouseout="out('7676423467312835669');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 229 +    if (mTaskRecord == null                                                                                       </span>
<span class="-5287811101982291105" onmouseenter="enter('-5287811101982291105');" onmouseout="out('-5287811101982291105');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 230 +        || mTaskRecord.threadRecords == null                                                                      </span>
<span class="-3537982277811084340" onmouseenter="enter('-3537982277811084340');" onmouseout="out('-3537982277811084340');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 231 +        || mTaskRecord.threadRecords.isEmpty()) {                                                                 </span>
<span class="-5432226360745882584" onmouseenter="enter('-5432226360745882584');" onmouseout="out('-5432226360745882584');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 232 +      return false;                                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 233 +    }                                                                                                             </span>
<span class="4151685609487095982" onmouseenter="enter('4151685609487095982');" onmouseout="out('4151685609487095982');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 234 +    int completeNum = 0;                                                                                          </span>
<span class="-7590052688485059950" onmouseenter="enter('-7590052688485059950');" onmouseout="out('-7590052688485059950');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 235 +    for (ThreadRecord tr : mTaskRecord.threadRecords) {                                                           </span>
<span class="-6249885869558348483" onmouseenter="enter('-6249885869558348483');" onmouseout="out('-6249885869558348483');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 236 +      if (tr.isComplete) {                                                                                        </span>
<span class="-1832473639842396112" onmouseenter="enter('-1832473639842396112');" onmouseout="out('-1832473639842396112');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 237 +        completeNum++;                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 238 +      }                                                                                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 239 +    }                                                                                                             </span>
<span class="-3614550293302262544" onmouseenter="enter('-3614550293302262544');" onmouseout="out('-3614550293302262544');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 240 +    return completeNum != 0 &amp;&amp; completeNum == mTaskRecord.threadNum;                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 241 +  }                                                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 242  }                                                                                                                 </span></pre></td>
                            <td><pre><span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style="">   1  /*                                                                                                                </span>
<span class="-4176855950178531235" onmouseenter="enter('-4176855950178531235');" onmouseout="out('-4176855950178531235');" style="">   2   * Copyright (C) 2016 AriaLyy(https://github.com/AriaLyy/Aria)                                                    </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">   3   *                                                                                                                </span>
<span class="-7144700690364548245" onmouseenter="enter('-7144700690364548245');" onmouseout="out('-7144700690364548245');" style="">   4   * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);                                                </span>
<span class="-6614298523444173250" onmouseenter="enter('-6614298523444173250');" onmouseout="out('-6614298523444173250');" style="">   5   * you may not use this file except in compliance with the License.                                               </span>
<span class="-4753901504248728101" onmouseenter="enter('-4753901504248728101');" onmouseout="out('-4753901504248728101');" style="">   6   * You may obtain a copy of the License at                                                                        </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">   7   *                                                                                                                </span>
<span class="-763207030729826407" onmouseenter="enter('-763207030729826407');" onmouseout="out('-763207030729826407');" style="">   8   *      http://www.apache.org/licenses/LICENSE-2.0                                                                </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">   9   *                                                                                                                </span>
<span class="2557607632756179983" onmouseenter="enter('2557607632756179983');" onmouseout="out('2557607632756179983');" style="">  10   * Unless required by applicable law or agreed to in writing, software                                            </span>
<span class="-9189129105512731955" onmouseenter="enter('-9189129105512731955');" onmouseout="out('-9189129105512731955');" style="">  11   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,                                              </span>
<span class="5781161717946418340" onmouseenter="enter('5781161717946418340');" onmouseout="out('5781161717946418340');" style="">  12   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.                                       </span>
<span class="1761562277992059393" onmouseenter="enter('1761562277992059393');" onmouseout="out('1761562277992059393');" style="">  13   * See the License for the specific language governing permissions and                                            </span>
<span class="7217408601297779962" onmouseenter="enter('7217408601297779962');" onmouseout="out('7217408601297779962');" style="">  14   * limitations under the License.                                                                                 </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  15   */                                                                                                               </span>
<span class="-5592048915404489240" onmouseenter="enter('-5592048915404489240');" onmouseout="out('-5592048915404489240');" style="">  16  package com.arialyy.aria.core.common;                                                                             </span>
<span  style="">  17                                                                                                                    </span>
<span class="7150685219957576571" onmouseenter="enter('7150685219957576571');" onmouseout="out('7150685219957576571');" style="">  18  import com.arialyy.aria.core.TaskRecord;                                                                          </span>
<span class="-7662986158836731995" onmouseenter="enter('-7662986158836731995');" onmouseout="out('-7662986158836731995');" style="">  19  import com.arialyy.aria.core.ThreadRecord;                                                                        </span>
<span class="1932658903610588883" onmouseenter="enter('1932658903610588883');" onmouseout="out('1932658903610588883');" style="">  20  import com.arialyy.aria.core.download.DownloadEntity;                                                             </span>
<span class="-6660438116294188466" onmouseenter="enter('-6660438116294188466');" onmouseout="out('-6660438116294188466');" style="">  21  import com.arialyy.aria.core.inf.IRecordHandler;                                                                  </span>
<span class="6596076366739461251" onmouseenter="enter('6596076366739461251');" onmouseout="out('6596076366739461251');" style="">  22  import com.arialyy.aria.core.inf.IRecordHandlerAdapter;                                                           </span>


<span class="-5831681804875068292" onmouseenter="enter('-5831681804875068292');" onmouseout="out('-5831681804875068292');" style="">  23  import com.arialyy.aria.core.upload.UploadEntity;                                                                 </span>
<span class="-2181497863142513098" onmouseenter="enter('-2181497863142513098');" onmouseout="out('-2181497863142513098');" style="">  24  import com.arialyy.aria.core.wrapper.AbsTaskWrapper;                                                              </span>
<span class="2481088621669901079" onmouseenter="enter('2481088621669901079');" onmouseout="out('2481088621669901079');" style="">  25  import com.arialyy.aria.core.wrapper.ITaskWrapper;                                                                </span>
<span class="-4361229816664464434" onmouseenter="enter('-4361229816664464434');" onmouseout="out('-4361229816664464434');" style="">  26  import com.arialyy.aria.core.wrapper.RecordWrapper;                                                               </span>
<span class="-4499301116755301031" onmouseenter="enter('-4499301116755301031');" onmouseout="out('-4499301116755301031');" style="">  27  import com.arialyy.aria.orm.DbEntity;                                                                             </span>
<span class="-3586495952513455611" onmouseenter="enter('-3586495952513455611');" onmouseout="out('-3586495952513455611');" style="">  28  import com.arialyy.aria.util.ALog;                                                                                </span>
<span class="-3106139894727218967" onmouseenter="enter('-3106139894727218967');" onmouseout="out('-3106139894727218967');" style="">  29  import com.arialyy.aria.util.CommonUtil;                                                                          </span>
<span class="-5216410147421847074" onmouseenter="enter('-5216410147421847074');" onmouseout="out('-5216410147421847074');" style="">  30  import com.arialyy.aria.util.DbDataHelper;                                                                        </span>
<span class="-563266023018163236" onmouseenter="enter('-563266023018163236');" onmouseout="out('-563266023018163236');" style="">  31  import com.arialyy.aria.util.FileUtil;                                                                            </span>
<span class="-3926401431737521278" onmouseenter="enter('-3926401431737521278');" onmouseout="out('-3926401431737521278');" style="">  32  import java.io.File;                                                                                              </span>
<span class="-1320562196372945707" onmouseenter="enter('-1320562196372945707');" onmouseout="out('-1320562196372945707');" style="">  33  import java.util.HashSet;                                                                                         </span>
<span class="-1786020958497218848" onmouseenter="enter('-1786020958497218848');" onmouseout="out('-1786020958497218848');" style="">  34  import java.util.List;                                                                                            </span>
<span class="1689171550873420012" onmouseenter="enter('1689171550873420012');" onmouseout="out('1689171550873420012');" style="">  35  import java.util.Properties;                                                                                      </span>
<span class="3384353015976675773" onmouseenter="enter('3384353015976675773');" onmouseout="out('3384353015976675773');" style="">  36  import java.util.Set;                                                                                             </span>
<span  style="">  37                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  38  /**                                                                                                               </span>
<span class="2736882465778481894" onmouseenter="enter('2736882465778481894');" onmouseout="out('2736882465778481894');" style="">  39   * 处理任务记录，分配线程区间                                                                                                  </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  40   */                                                                                                               </span>
<span class="-7787161997225496484" onmouseenter="enter('-7787161997225496484');" onmouseout="out('-7787161997225496484');" style="">  41  public class RecordHandler implements IRecordHandler {                                                            </span>
<span class="3291406156585340518" onmouseenter="enter('3291406156585340518');" onmouseout="out('3291406156585340518');" style="">  42    private final String TAG = &quot;RecordHandler&quot;;                                                                     </span>


<span  style="">  43                                                                                                                    </span>
<span class="-6913167534336436900" onmouseenter="enter('-6913167534336436900');" onmouseout="out('-6913167534336436900');" style="">  44    @Deprecated private File mConfigFile;                                                                           </span>
<span class="-8877097513462838969" onmouseenter="enter('-8877097513462838969');" onmouseout="out('-8877097513462838969');" style="">  45    private TaskRecord mTaskRecord;                                                                                 </span>
<span class="-8022183237541885590" onmouseenter="enter('-8022183237541885590');" onmouseout="out('-8022183237541885590');" style="">  46    private AbsTaskWrapper mTaskWrapper;                                                                            </span>
<span class="-2477248167481204479" onmouseenter="enter('-2477248167481204479');" onmouseout="out('-2477248167481204479');" style="">  47    private AbsNormalEntity mEntity;                                                                                </span>
<span class="-1669965154521629443" onmouseenter="enter('-1669965154521629443');" onmouseout="out('-1669965154521629443');" style="">  48    private IRecordHandlerAdapter mAdapter;                                                                         </span>
<span  style="">  49                                                                                                                    </span>
<span class="-4800954456425527235" onmouseenter="enter('-4800954456425527235');" onmouseout="out('-4800954456425527235');" style="">  50    public RecordHandler(AbsTaskWrapper wrapper) {                                                                  </span>
<span class="-4483703319181095288" onmouseenter="enter('-4483703319181095288');" onmouseout="out('-4483703319181095288');" style="">  51      mTaskWrapper = wrapper;                                                                                       </span>
<span class="-2477156305516257248" onmouseenter="enter('-2477156305516257248');" onmouseout="out('-2477156305516257248');" style="">  52      mEntity = (AbsNormalEntity) mTaskWrapper.getEntity();                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  53    }                                                                                                               </span>
<span  style="">  54                                                                                                                    </span>
<span class="3305577849379453561" onmouseenter="enter('3305577849379453561');" onmouseout="out('3305577849379453561');" style="">  55    public void setAdapter(IRecordHandlerAdapter mAdapter) {                                                        </span>
<span class="-2226079758135238337" onmouseenter="enter('-2226079758135238337');" onmouseout="out('-2226079758135238337');" style="">  56      this.mAdapter = mAdapter;                                                                                     </span>










<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  57    }                                                                                                               </span>
<span  style="">  58                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  59    /**                                                                                                             </span>
<span class="-4523044754040360039" onmouseenter="enter('-4523044754040360039');" onmouseout="out('-4523044754040360039');" style="">  60     * 获取任务记录，如果任务记录存在，检查任务记录                                                                                       </span>
<span class="-994801055868135316" onmouseenter="enter('-994801055868135316');" onmouseout="out('-994801055868135316');" style="">  61     * 检查记录 对于分块任务： 子分块不存在或被删除，子线程将重新下载                                                                             </span>
<span class="-5335970434013572058" onmouseenter="enter('-5335970434013572058');" onmouseout="out('-5335970434013572058');" style="">  62     * 对于普通任务： 预下载文件不存在，则任务任务呗删除                                                                                    </span>
<span class="6742381731051832150" onmouseenter="enter('6742381731051832150');" onmouseout="out('6742381731051832150');" style="">  63     * 如果任务记录不存在或线程记录不存在，初始化记录                                                                                      </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  64     *                                                                                                              </span>
<span class="2644027277083576426" onmouseenter="enter('2644027277083576426');" onmouseout="out('2644027277083576426');" style="">  65     * @return 任务记录                                                                                                 </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  66     */                                                                                                             </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style="">  67    @Override                                                                                                       </span>
<span class="1066955891247002122" onmouseenter="enter('1066955891247002122');" onmouseout="out('1066955891247002122');" style="">  68    public TaskRecord getRecord() {                                                                                 </span>
<span class="-5297450492380711808" onmouseenter="enter('-5297450492380711808');" onmouseout="out('-5297450492380711808');" style="">  69      mConfigFile = new File(CommonUtil.getFileConfigPath(false, mEntity.getFileName()));                           </span>
<span class="4951157766975006439" onmouseenter="enter('4951157766975006439');" onmouseout="out('4951157766975006439');" style="">  70      if (mConfigFile.exists()) {                                                                                   </span>
<span class="7932310618145443523" onmouseenter="enter('7932310618145443523');" onmouseout="out('7932310618145443523');" style="">  71        convertDb();                                                                                                </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style="">  72      } else {                                                                                                      </span>
<span class="7296682852134477027" onmouseenter="enter('7296682852134477027');" onmouseout="out('7296682852134477027');" style="">  73        mAdapter.onPre();                                                                                           </span>

<span class="-4126650542682918148" onmouseenter="enter('-4126650542682918148');" onmouseout="out('-4126650542682918148');" style="">  74        mTaskRecord = DbDataHelper.getTaskRecord(getFilePath(), mEntity.getTaskType());                             </span>
<span class="4057372030095958349" onmouseenter="enter('4057372030095958349');" onmouseout="out('4057372030095958349');" style="">  75        if (mTaskRecord == null) {                                                                                  </span>
<span class="574535391222419428" onmouseenter="enter('574535391222419428');" onmouseout="out('574535391222419428');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  76 -        if (!new File(getFilePath()).exists()){                                                                   </span>

<span class="158751631392391592" onmouseenter="enter('158751631392391592');" onmouseout="out('158751631392391592');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  77 -          FileUtil.createFile(getFilePath());                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  78 -        }                                                                                                         </span>
<span class="-6736410795519637054" onmouseenter="enter('-6736410795519637054');" onmouseout="out('-6736410795519637054');" style="">  79          initRecord(true);                                                                                         </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  80 -      } else {                                                                                                    </span>
<span class="-4007091416322407417" onmouseenter="enter('-4007091416322407417');" onmouseout="out('-4007091416322407417');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  81 -        File file = new File(mTaskRecord.filePath);                                                               </span>
<span class="4133240422546463755" onmouseenter="enter('4133240422546463755');" onmouseout="out('4133240422546463755');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  82 -        if (!file.exists()) {                                                                                     </span>
<span class="8386365718316155314" onmouseenter="enter('8386365718316155314');" onmouseout="out('8386365718316155314');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  83 -          ALog.w(TAG, String.format(&quot;文件【%s】不存在，重新分配线程区间&quot;, mTaskRecord.filePath));                                 </span>
<span class="3147181738283157854" onmouseenter="enter('3147181738283157854');" onmouseout="out('3147181738283157854');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  84 -          DbEntity.deleteData(ThreadRecord.class, &quot;taskKey=?&quot;, mTaskRecord.filePath);                             </span>
<span class="5854365307602457529" onmouseenter="enter('5854365307602457529');" onmouseout="out('5854365307602457529');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  85 -          mTaskRecord.threadRecords.clear();                                                                      </span>
<span class="7876801457309202704" onmouseenter="enter('7876801457309202704');" onmouseout="out('7876801457309202704');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  86 -          mTaskRecord.threadNum = mAdapter.initTaskThreadNum();                                                   </span>

<span class="-3891780371452029435" onmouseenter="enter('-3891780371452029435');" onmouseout="out('-3891780371452029435');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  87 -          initRecord(false);                                                                                      </span>
<span class="-7115068008347678823" onmouseenter="enter('-7115068008347678823');" onmouseout="out('-7115068008347678823');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  88 -        } else if (mTaskRecord.threadRecords == null || mTaskRecord.threadRecords.isEmpty()) {                    </span>
<span class="7876801457309202704" onmouseenter="enter('7876801457309202704');" onmouseout="out('7876801457309202704');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  89 -          mTaskRecord.threadNum = mAdapter.initTaskThreadNum();                                                   </span>

<span class="-3891780371452029435" onmouseenter="enter('-3891780371452029435');" onmouseout="out('-3891780371452029435');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  90 -          initRecord(false);                                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  91 -        }                                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  92        }                                                                                                           </span>
<span class="5534914312730067566" onmouseenter="enter('5534914312730067566');" onmouseout="out('5534914312730067566');" style="">  93        mAdapter.handlerTaskRecord(mTaskRecord);                                                                    </span>

<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  94      }                                                                                                             </span>
<span class="-4447853798640415053" onmouseenter="enter('-4447853798640415053');" onmouseout="out('-4447853798640415053');" style="">  95      saveRecord();                                                                                                 </span>
<span class="2589344107322293803" onmouseenter="enter('2589344107322293803');" onmouseout="out('2589344107322293803');" style="">  96      return mTaskRecord;                                                                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  97    }                                                                                                               </span>
<span  style="">  98                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  99    /**                                                                                                             </span>
<span class="4426545154492852727" onmouseenter="enter('4426545154492852727');" onmouseout="out('4426545154492852727');" style=""> 100     * convertDb 是兼容性代码 从3.4.1开始，线程配置信息将存储在数据库中。 将配置文件的内容复制到数据库中，并将配置文件删除                                           </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 101     */                                                                                                             </span>
<span class="14298455509427519" onmouseenter="enter('14298455509427519');" onmouseout="out('14298455509427519');" style=""> 102    private void convertDb() {                                                                                      </span>
<span class="-4598298306615401010" onmouseenter="enter('-4598298306615401010');" onmouseout="out('-4598298306615401010');" style=""> 103      List&lt;RecordWrapper&gt; records =                                                                                 </span>
<span class="-4738968014729726274" onmouseenter="enter('-4738968014729726274');" onmouseout="out('-4738968014729726274');" style=""> 104          DbEntity.findRelationData(RecordWrapper.class, &quot;TaskRecord.filePath=?&quot;,                                   </span>
<span class="1664646851824584272" onmouseenter="enter('1664646851824584272');" onmouseout="out('1664646851824584272');" style=""> 105              getFilePath());                                                                                       </span>
<span class="-376648440877788579" onmouseenter="enter('-376648440877788579');" onmouseout="out('-376648440877788579');" style=""> 106      if (records == null || records.size() == 0) {                                                                 </span>
<span class="1734928994769379059" onmouseenter="enter('1734928994769379059');" onmouseout="out('1734928994769379059');" style=""> 107        Properties pro = FileUtil.loadConfig(mConfigFile);                                                          </span>
<span class="-681137634566379888" onmouseenter="enter('-681137634566379888');" onmouseout="out('-681137634566379888');" style=""> 108        if (pro.isEmpty()) {                                                                                        </span>
<span class="6270101186355835075" onmouseenter="enter('6270101186355835075');" onmouseout="out('6270101186355835075');" style=""> 109          ALog.d(TAG, &quot;老版本的线程记录为空，任务为新任务&quot;);                                                                         </span>
<span class="-6736410795519637054" onmouseenter="enter('-6736410795519637054');" onmouseout="out('-6736410795519637054');" style=""> 110          initRecord(true);                                                                                         </span>
<span class="4043029072030362567" onmouseenter="enter('4043029072030362567');" onmouseout="out('4043029072030362567');" style=""> 111          return;                                                                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 112        }                                                                                                           </span>
<span  style=""> 113                                                                                                                    </span>
<span class="-4092719147494026286" onmouseenter="enter('-4092719147494026286');" onmouseout="out('-4092719147494026286');" style=""> 114        Set&lt;Object&gt; keys = pro.keySet();                                                                            </span>
<span class="7117164647387083506" onmouseenter="enter('7117164647387083506');" onmouseout="out('7117164647387083506');" style=""> 115        // 老版本记录是5s存一次，但是5s中内，如果线程执行完成，record记录是没有的，只有state记录...                                                    </span>
<span class="8442347856216504710" onmouseenter="enter('8442347856216504710');" onmouseout="out('8442347856216504710');" style=""> 116        // 第一步应该是record 和 state去重取正确的线程数                                                                            </span>
<span class="3880560860847601414" onmouseenter="enter('3880560860847601414');" onmouseout="out('3880560860847601414');" style=""> 117        Set&lt;Integer&gt; set = new HashSet&lt;&gt;();                                                                         </span>
<span class="-5644624400733519290" onmouseenter="enter('-5644624400733519290');" onmouseout="out('-5644624400733519290');" style=""> 118        for (Object key : keys) {                                                                                   </span>
<span class="-90111359741489740" onmouseenter="enter('-90111359741489740');" onmouseout="out('-90111359741489740');" style=""> 119          String str = String.valueOf(key);                                                                         </span>
<span class="4809237278425345525" onmouseenter="enter('4809237278425345525');" onmouseout="out('4809237278425345525');" style=""> 120          int i = Integer.parseInt(str.substring(str.length() - 1));                                                </span>
<span class="5139166377005733880" onmouseenter="enter('5139166377005733880');" onmouseout="out('5139166377005733880');" style=""> 121          set.add(i);                                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 122        }                                                                                                           </span>
<span class="1773727540275693887" onmouseenter="enter('1773727540275693887');" onmouseout="out('1773727540275693887');" style=""> 123        int threadNum = set.size();                                                                                 </span>
<span class="1658307869252768908" onmouseenter="enter('1658307869252768908');" onmouseout="out('1658307869252768908');" style=""> 124        if (threadNum == 0) {                                                                                       </span>
<span class="1148319986505262760" onmouseenter="enter('1148319986505262760');" onmouseout="out('1148319986505262760');" style=""> 125          ALog.d(TAG, &quot;线程数为空，任务为新任务&quot;);                                                                              </span>
<span class="-6736410795519637054" onmouseenter="enter('-6736410795519637054');" onmouseout="out('-6736410795519637054');" style=""> 126          initRecord(true);                                                                                         </span>
<span class="4043029072030362567" onmouseenter="enter('4043029072030362567');" onmouseout="out('4043029072030362567');" style=""> 127          return;                                                                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 128        }                                                                                                           </span>
<span class="7955340223234605" onmouseenter="enter('7955340223234605');" onmouseout="out('7955340223234605');" style=""> 129        mTaskWrapper.setNewTask(false);                                                                             </span>
<span class="5491689444108456019" onmouseenter="enter('5491689444108456019');" onmouseout="out('5491689444108456019');" style=""> 130        mTaskRecord = mAdapter.createTaskRecord(threadNum);                                                         </span>

<span class="7633421891114459750" onmouseenter="enter('7633421891114459750');" onmouseout="out('7633421891114459750');" style=""> 131        mTaskRecord.isBlock = false;                                                                                </span>
<span class="3855509751077495513" onmouseenter="enter('3855509751077495513');" onmouseout="out('3855509751077495513');" style=""> 132        File tempFile = new File(getFilePath());                                                                    </span>
<span class="92058997093189211" onmouseenter="enter('92058997093189211');" onmouseout="out('92058997093189211');" style=""> 133        for (int i = 0; i &lt; threadNum; i++) {                                                                       </span>
<span class="1846142719149590893" onmouseenter="enter('1846142719149590893');" onmouseout="out('1846142719149590893');" style=""> 134          ThreadRecord tRecord = new ThreadRecord();                                                                </span>
<span class="3723169099876741000" onmouseenter="enter('3723169099876741000');" onmouseout="out('3723169099876741000');" style=""> 135          tRecord.taskKey = mTaskRecord.filePath;                                                                   </span>
<span class="5678090729290962283" onmouseenter="enter('5678090729290962283');" onmouseout="out('5678090729290962283');" style=""> 136          Object state = pro.getProperty(tempFile.getName() + STATE + i);                                           </span>
<span class="8491464740929708384" onmouseenter="enter('8491464740929708384');" onmouseout="out('8491464740929708384');" style=""> 137          Object record = pro.getProperty(tempFile.getName() + RECORD + i);                                         </span>
<span class="-1417732743646819816" onmouseenter="enter('-1417732743646819816');" onmouseout="out('-1417732743646819816');" style=""> 138          if (state != null &amp;&amp; Integer.parseInt(String.valueOf(state)) == 1) {                                      </span>
<span class="-5900743039323389312" onmouseenter="enter('-5900743039323389312');" onmouseout="out('-5900743039323389312');" style=""> 139            tRecord.isComplete = true;                                                                              </span>
<span class="-6362435147834875541" onmouseenter="enter('-6362435147834875541');" onmouseout="out('-6362435147834875541');" style=""> 140            continue;                                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 141          }                                                                                                         </span>
<span class="2652986304939921073" onmouseenter="enter('2652986304939921073');" onmouseout="out('2652986304939921073');" style=""> 142          if (record != null) {                                                                                     </span>
<span class="7355303051831508853" onmouseenter="enter('7355303051831508853');" onmouseout="out('7355303051831508853');" style=""> 143            long temp = Long.parseLong(String.valueOf(record));                                                     </span>
<span class="6949017848225026676" onmouseenter="enter('6949017848225026676');" onmouseout="out('6949017848225026676');" style=""> 144            tRecord.startLocation = temp &gt; 0 ? temp : 0;                                                            </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 145          } else {                                                                                                  </span>
<span class="-2463924567028920967" onmouseenter="enter('-2463924567028920967');" onmouseout="out('-2463924567028920967');" style=""> 146            tRecord.startLocation = 0;                                                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 147          }                                                                                                         </span>
<span class="-6865700341156428088" onmouseenter="enter('-6865700341156428088');" onmouseout="out('-6865700341156428088');" style=""> 148          mTaskRecord.threadRecords.add(tRecord);                                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 149        }                                                                                                           </span>
<span class="4367383752983568604" onmouseenter="enter('4367383752983568604');" onmouseout="out('4367383752983568604');" style=""> 150        FileUtil.deleteFile(mConfigFile);                                                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 151      }                                                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 152    }                                                                                                               </span>
<span  style=""> 153                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 154    /**                                                                                                             </span>
<span class="8463391589973071562" onmouseenter="enter('8463391589973071562');" onmouseout="out('8463391589973071562');" style=""> 155     * 初始化任务记录，分配线程区间，如果任务记录不存在，则创建新的任务记录                                                                           </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 156     *                                                                                                              </span>
<span class="-3744851117936265295" onmouseenter="enter('-3744851117936265295');" onmouseout="out('-3744851117936265295');" style=""> 157     * @param newRecord {@code true} 需要创建新{@link TaskRecord}                                                        </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 158     */                                                                                                             </span>
<span class="1766652104121073893" onmouseenter="enter('1766652104121073893');" onmouseout="out('1766652104121073893');" style=""> 159    private void initRecord(boolean newRecord) {                                                                    </span>
<span class="6048435392166168608" onmouseenter="enter('6048435392166168608');" onmouseout="out('6048435392166168608');" style=""> 160      if (newRecord) {                                                                                              </span>
<span class="3042121584580047914" onmouseenter="enter('3042121584580047914');" onmouseout="out('3042121584580047914');" style=""> 161        mTaskRecord = mAdapter.createTaskRecord(mAdapter.initTaskThreadNum());                                      </span>

<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 162      }                                                                                                             </span>
<span class="-1512381015788610352" onmouseenter="enter('-1512381015788610352');" onmouseout="out('-1512381015788610352');" style=""> 163      mTaskWrapper.setNewTask(true);                                                                                </span>
<span class="-3721642619055872692" onmouseenter="enter('-3721642619055872692');" onmouseout="out('-3721642619055872692');" style=""> 164      int requestType = mTaskWrapper.getRequestType();                                                              </span>
<span class="3748431468753436023" onmouseenter="enter('3748431468753436023');" onmouseout="out('3748431468753436023');" style=""> 165      if (requestType == ITaskWrapper.M3U8_LIVE) {                                                                  </span>
<span class="4043029072030362567" onmouseenter="enter('4043029072030362567');" onmouseout="out('4043029072030362567');" style=""> 166        return;                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 167      }                                                                                                             </span>
<span class="1600220578687832077" onmouseenter="enter('1600220578687832077');" onmouseout="out('1600220578687832077');" style=""> 168      long blockSize = mEntity.getFileSize() / mTaskRecord.threadNum;                                               </span>
<span class="-4436010189640816687" onmouseenter="enter('-4436010189640816687');" onmouseout="out('-4436010189640816687');" style=""> 169      // 处理线程区间记录                                                                                                   </span>
<span class="-8559683407759389663" onmouseenter="enter('-8559683407759389663');" onmouseout="out('-8559683407759389663');" style=""> 170      for (int i = 0; i &lt; mTaskRecord.threadNum; i++) {                                                             </span>
<span class="-2965725495076654490" onmouseenter="enter('-2965725495076654490');" onmouseout="out('-2965725495076654490');" style=""> 171        long startL = i * blockSize, endL = (i + 1) * blockSize;                                                    </span>
<span class="-8537254312133948488" onmouseenter="enter('-8537254312133948488');" onmouseout="out('-8537254312133948488');" style=""> 172        ThreadRecord tr = mAdapter.createThreadRecord(mTaskRecord, i, startL, endL);                                </span>

<span class="-6805201278378671560" onmouseenter="enter('-6805201278378671560');" onmouseout="out('-6805201278378671560');" style=""> 173        mTaskRecord.threadRecords.add(tr);                                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 174      }                                                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 175    }                                                                                                               </span>
<span  style=""> 176                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 177    /**                                                                                                             </span>
<span class="-8991940256279851469" onmouseenter="enter('-8991940256279851469');" onmouseout="out('-8991940256279851469');" style=""> 178     * 保存任务记录                                                                                                       </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 179     */                                                                                                             </span>
<span class="1188287987342183098" onmouseenter="enter('1188287987342183098');" onmouseout="out('1188287987342183098');" style=""> 180    private void saveRecord() {                                                                                     </span>
<span class="323794376596875286" onmouseenter="enter('323794376596875286');" onmouseout="out('323794376596875286');" style=""> 181      mTaskRecord.threadNum = mTaskRecord.threadRecords.size();                                                     </span>
<span class="345625468264837114" onmouseenter="enter('345625468264837114');" onmouseout="out('345625468264837114');" style=""> 182      mTaskRecord.save();                                                                                           </span>
<span class="-3701039002002731049" onmouseenter="enter('-3701039002002731049');" onmouseout="out('-3701039002002731049');" style=""> 183      if (mTaskRecord.threadRecords != null &amp;&amp; !mTaskRecord.threadRecords.isEmpty()) {                              </span>
<span class="2432664825672590881" onmouseenter="enter('2432664825672590881');" onmouseout="out('2432664825672590881');" style=""> 184        DbEntity.saveAll(mTaskRecord.threadRecords);                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 185      }                                                                                                             </span>
<span class="-1161286805066448242" onmouseenter="enter('-1161286805066448242');" onmouseout="out('-1161286805066448242');" style=""> 186      ALog.d(TAG, String.format(&quot;保存记录，线程记录数：%s&quot;, mTaskRecord.threadRecords.size()));                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 187    }                                                                                                               </span>
<span  style=""> 188                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 189    /**                                                                                                             </span>
<span class="-5152727538261600286" onmouseenter="enter('-5152727538261600286');" onmouseout="out('-5152727538261600286');" style=""> 190     * 获取任务路径                                                                                                       </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 191     *                                                                                                              </span>
<span class="-2815134136997967815" onmouseenter="enter('-2815134136997967815');" onmouseout="out('-2815134136997967815');" style=""> 192     * @return 任务文件路径                                                                                               </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 193     */                                                                                                             </span>
<span class="-8326432688154281329" onmouseenter="enter('-8326432688154281329');" onmouseout="out('-8326432688154281329');" style=""> 194    private String getFilePath() {                                                                                  </span>
<span class="4415201624474066138" onmouseenter="enter('4415201624474066138');" onmouseout="out('4415201624474066138');" style=""> 195      if (mEntity instanceof DownloadEntity) {                                                                      </span>
<span class="-8422380947915573606" onmouseenter="enter('-8422380947915573606');" onmouseout="out('-8422380947915573606');" style=""> 196        return ((DownloadEntity) mTaskWrapper.getEntity()).getFilePath();                                           </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 197      } else {                                                                                                      </span>
<span class="-2519282598545089845" onmouseenter="enter('-2519282598545089845');" onmouseout="out('-2519282598545089845');" style=""> 198        return ((UploadEntity) mTaskWrapper.getEntity()).getFilePath();                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 199      }                                                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 200    }                                                                                                               </span>



















<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 201  }                                                                                                                 </span></pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            