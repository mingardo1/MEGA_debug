<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>6</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    6
                    <a href="5.html">prev</a>
                    <a href="7.html">next</a>
                    <a href="6_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    AriaLyy/Aria_102d3ba0f641e26d0a6e82b0506f600ea40244dd_HttpComponent/src/main/java/com/arialyy/aria/http/HttpFileInfoThread.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\AriaLyy\Aria show &quot;102d3ba0f641e26d0a6e82b0506f600ea40244dd:HttpComponent/src/main/java/com/arialyy/aria/http/HttpFileInfoThread.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\AriaLyy\Aria show &quot;102d3ba0f641e26d0a6e82b0506f600ea40244dd^1:HttpComponent/src/main/java/com/arialyy/aria/http/HttpFileInfoThread.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\AriaLyy\Aria show &quot;102d3ba0f641e26d0a6e82b0506f600ea40244dd^2:HttpComponent/src/main/java/com/arialyy/aria/http/HttpFileInfoThread.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\AriaLyy\Aria show &quot;0cb5d3e68461842509c569f76610654b8d5e6298:HttpComponent/src/main/java/com/arialyy/aria/http/HttpFileInfoThread.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[sbj]], subset: [[sbj]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
   2 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   3 /*</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   4  * Copyright (C) 2016 AriaLyy(https://github.com/AriaLyy/Aria)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   5  *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   6  * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   7  * you may not use this file except in compliance with the License.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   8  * You may obtain a copy of the License at</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   9  *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  10  *      http://www.apache.org/licenses/LICENSE-2.0</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  11  *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  12  * Unless required by applicable law or agreed to in writing, software</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  15  * See the License for the specific language governing permissions and</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  16  * limitations under the License.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  17  */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  18 package com.arialyy.aria.http;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  19 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  20 import android.net.TrafficStats;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  21 import android.net.Uri;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  22 import android.os.Process;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  23 import android.text.TextUtils;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  24 import com.arialyy.aria.core.AriaConfig;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  25 import com.arialyy.aria.core.common.CompleteInfo;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  26 import com.arialyy.aria.core.common.RequestEnum;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  27 import com.arialyy.aria.core.download.DTaskWrapper;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  28 import com.arialyy.aria.core.download.DownloadEntity;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  29 import com.arialyy.aria.core.inf.OnFileInfoCallback;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  30 import com.arialyy.aria.core.processor.IHttpFileLenAdapter;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  31 import com.arialyy.aria.exception.AriaIOException;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  32 import com.arialyy.aria.exception.BaseException;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  33 import com.arialyy.aria.exception.TaskException;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  34 import com.arialyy.aria.util.ALog;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  35 import com.arialyy.aria.util.CheckUtil;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  36 import com.arialyy.aria.util.CommonUtil;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  37 import com.arialyy.aria.util.FileUtil;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  38 import com.arialyy.aria.util.RecordUtil;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  39 import java.io.BufferedReader;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  40 import java.io.File;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  41 import java.io.IOException;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  42 import java.io.InputStreamReader;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  43 import java.io.OutputStreamWriter;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  44 import java.io.UnsupportedEncodingException;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  45 import java.net.CookieManager;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  46 import java.net.HttpCookie;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  47 import java.net.HttpURLConnection;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  48 import java.net.URL;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  49 import java.net.URLDecoder;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  50 import java.net.URLEncoder;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  51 import java.util.List;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  52 import java.util.Map;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  53 import java.util.Set;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  54 import java.util.UUID;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  55 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  56 /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  57  * 下载文件信息获取</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  58  */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  59 public class HttpFileInfoThread implements Runnable {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  60   private static final String TAG = &quot;HttpFileInfoThread&quot;;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  61   private DownloadEntity mEntity;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  62   private DTaskWrapper mTaskWrapper;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  63   private int mConnectTimeOut;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  64   private OnFileInfoCallback onFileInfoCallback;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  65   private HttpTaskOption taskOption;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  66 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  67   public HttpFileInfoThread(DTaskWrapper taskWrapper, OnFileInfoCallback callback) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  68     this.mTaskWrapper = taskWrapper;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  69     mEntity = taskWrapper.getEntity();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  70     mConnectTimeOut = AriaConfig.getInstance().getDConfig().getConnectTimeOut();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  71     onFileInfoCallback = callback;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  72     taskOption = (HttpTaskOption) taskWrapper.getTaskOption();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  73   }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  74 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  75   @Override public void run() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  76     Process.setThreadPriority(Process.THREAD_PRIORITY_BACKGROUND);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  77     TrafficStats.setThreadStatsTag(UUID.randomUUID().toString().hashCode());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  78     HttpURLConnection conn = null;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  79     try {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  80       URL url = ConnectionHelp.handleUrl(mEntity.getUrl(), taskOption);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  81       conn = ConnectionHelp.handleConnection(url, taskOption);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  82       ConnectionHelp.setConnectParam(taskOption, conn);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  83       conn.setRequestProperty(&quot;Range&quot;, &quot;bytes=&quot; + 0 + &quot;-&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  84       conn.setConnectTimeout(mConnectTimeOut);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  85       conn.connect();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  86       handleConnect(conn);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  87     } catch (IOException e) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  88       e.printStackTrace();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  89       failDownload(new AriaIOException(TAG,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  90               String.format(&quot;下载失败，filePath: %s, url: %s&quot;, mEntity.getDownloadPath(), mEntity.getUrl())),</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  91           true);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  92     } finally {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  93       if (conn != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  94         try {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  95           conn.getInputStream().close();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  96         } catch (IOException e) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  97           e.printStackTrace();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  98         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  99         conn.disconnect();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 100       }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 101     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 102   }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 103 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 104   private void handleConnect(HttpURLConnection conn) throws IOException {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 105     if (taskOption.getRequestEnum() == RequestEnum.POST) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 106       Map&lt;String, String&gt; params = taskOption.getParams();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 107       if (params != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 108         OutputStreamWriter dos = new OutputStreamWriter(conn.getOutputStream());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 109         Set&lt;String&gt; keys = params.keySet();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 110         StringBuilder sb = new StringBuilder();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 111         for (String key : keys) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 112           sb.append(key).append(&quot;=&quot;).append(URLEncoder.encode(params.get(key))).append(&quot;&amp;&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 113         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 114         String url = sb.toString();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 115         url = url.substring(0, url.length() - 1);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 116         dos.write(url);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 117         dos.flush();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 118         dos.close();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 119       }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 120     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 121 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 122     IHttpFileLenAdapter lenAdapter = taskOption.getFileLenAdapter();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 123     if (lenAdapter == null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 124       lenAdapter = new FileLenAdapter();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 125     } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 126       ALog.d(TAG, &quot;使用自定义adapter&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 127     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 128     long len = lenAdapter.handleFileLen(conn.getHeaderFields());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 129 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 130     if (!FileUtil.checkSDMemorySpace(mEntity.getFilePath(), len)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 131       failDownload(new TaskException(TAG,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 132           String.format(&quot;下载失败，内存空间不足；filePath: %s, url: %s&quot;, mEntity.getDownloadPath(),</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 133               mEntity.getUrl())), false);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 134       return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 135     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 136 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 137     int code = conn.getResponseCode();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 138     boolean end = false;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 139     if (TextUtils.isEmpty(mEntity.getMd5Code())) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 140       String md5Code = conn.getHeaderField(&quot;Content-MD5&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 141       mEntity.setMd5Code(md5Code);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 142     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 143 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 144     boolean isChunked = false;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 145     final String str = conn.getHeaderField(&quot;Transfer-Encoding&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 146     if (!TextUtils.isEmpty(str) &amp;&amp; str.equals(&quot;chunked&quot;)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 147       isChunked = true;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 148     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 149     Map&lt;String, List&lt;String&gt;&gt; headers = conn.getHeaderFields();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 150     String disposition = conn.getHeaderField(&quot;Content-Disposition&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 151 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 152     if (taskOption.isUseServerFileName()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 153       if (!TextUtils.isEmpty(disposition)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 154         mEntity.setDisposition(CommonUtil.encryptBASE64(disposition));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 155         handleContentDisposition(disposition);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 156       } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 157         ALog.w(TAG, &quot;Content-Disposition对于端字段为空，使用服务器端文件名失败&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 158       }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 159     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 160     CookieManager msCookieManager = new CookieManager();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 161     List&lt;String&gt; cookiesHeader = headers.get(&quot;Set-Cookie&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 162 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 163     if (cookiesHeader != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 164       for (String cookie : cookiesHeader) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 165         msCookieManager.getCookieStore().add(null, HttpCookie.parse(cookie).get(0));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 166       }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 167       taskOption.setCookieManager(msCookieManager);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 168     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 169 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 170     mTaskWrapper.setCode(code);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 171     if (code == HttpURLConnection.HTTP_PARTIAL) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 172       if (!checkLen(len) &amp;&amp; !isChunked) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 173         if (len &lt; 0) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 174           failDownload(</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 175               new AriaIOException(TAG, String.format(&quot;任务下载失败，文件长度小于0， url: %s&quot;, mEntity.getUrl())),</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 176               false);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 177         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 178         return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 179       }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 180       mEntity.setFileSize(len);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 181       mTaskWrapper.setSupportBP(true);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 182       end = true;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 183     } else if (code == HttpURLConnection.HTTP_OK) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 184       String contentType = conn.getHeaderField(&quot;Content-Type&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 185       if (TextUtils.isEmpty(contentType)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 186         return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 187       }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 188       if (contentType.equals(&quot;text/html&quot;)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 189         BufferedReader reader =</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 190             new BufferedReader(new InputStreamReader(ConnectionHelp.convertInputStream(conn)));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 191         StringBuilder sb = new StringBuilder();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 192         String line;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 193         while ((line = reader.readLine()) != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 194           sb.append(line);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 195         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 196         reader.close();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 197         handleUrlReTurn(conn, CommonUtil.getWindowReplaceUrl(sb.toString()));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 198         return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 199       } else if (!checkLen(len) &amp;&amp; !isChunked) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 200         if (len &lt; 0) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 201           failDownload(</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 202               new AriaIOException(TAG, String.format(&quot;任务下载失败，文件长度小于0， url: %s&quot;, mEntity.getUrl())),</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 203               false);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 204         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 205         ALog.d(TAG, &quot;len &lt; 0&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 206         return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 207       }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 208       mEntity.setFileSize(len);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 209       mTaskWrapper.setNewTask(true);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 210       mTaskWrapper.setSupportBP(false);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 211       end = true;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 212     } else if (code == HttpURLConnection.HTTP_NOT_FOUND) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 213       failDownload(new AriaIOException(TAG,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 214           String.format(&quot;任务下载失败，errorCode：404, url: %s&quot;, mEntity.getUrl())), true);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 215     } else if (code == HttpURLConnection.HTTP_MOVED_TEMP</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 216         || code == HttpURLConnection.HTTP_MOVED_PERM</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 217         || code == HttpURLConnection.HTTP_SEE_OTHER</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 218         || code == HttpURLConnection.HTTP_CREATED // 201 跳转</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 219         || code == 307) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 220       handleUrlReTurn(conn, conn.getHeaderField(&quot;Location&quot;));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 221     } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 222       failDownload(new AriaIOException(TAG,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 223           String.format(&quot;任务下载失败，errorCode：%s, errorMsg: %s, url: %s&quot;, code,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 224               conn.getResponseMessage(), mEntity.getUrl())), !CheckUtil.httpIsBadRequest(code));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 225     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 226     if (end) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 227       taskOption.setChunked(isChunked);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 228       if (onFileInfoCallback != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 229         CompleteInfo info = new CompleteInfo(code, mTaskWrapper);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 230         onFileInfoCallback.onComplete(mEntity.getUrl(), info);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 231       }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 232       mEntity.update();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 233     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 234   }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 235 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 236   /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 237    * 处理&quot;Content-Disposition&quot;参数</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 238    * &lt;a href=https://cloud.tencent.com/developer/section/1189916&gt;Content-Disposition&lt;/a&gt;&lt;/&gt;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 239    *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 240    * @throws UnsupportedEncodingException</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 241    */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 242   private void handleContentDisposition(String disposition) throws UnsupportedEncodingException {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 243     if (disposition.contains(&quot;;&quot;)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 244       String[] infos = disposition.split(&quot;;&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 245       if (infos[0].equals(&quot;attachment&quot;)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 246         for (String info : infos) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 247           if (info.startsWith(&quot;filename&quot;) &amp;&amp; info.contains(&quot;=&quot;)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 248             String[] temp = info.split(&quot;=&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 249             if (temp.length &gt; 1) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 250               String newName = URLDecoder.decode(temp[1], &quot;utf-8&quot;).replaceAll(&quot;\&quot;&quot;, &quot;&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 251               mEntity.setServerFileName(newName);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 252               renameFile(newName);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 253               break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 254             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 255           }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 256         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 257       } else if (infos[0].equals(&quot;form-data&quot;) &amp;&amp; infos.length &gt; 2) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 258         String[] temp = infos[2].split(&quot;=&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 259         if (temp.length &gt; 1) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 260           String newName = URLDecoder.decode(temp[1], &quot;utf-8&quot;).replaceAll(&quot;\&quot;&quot;, &quot;&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 261           mEntity.setServerFileName(newName);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 262           renameFile(newName);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 263         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 264       } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 265         ALog.w(TAG, &quot;不识别的Content-Disposition参数&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 266       }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 267     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 268   }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 269 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 270   /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 271    * 重命名文件</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 272    */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 273   private void renameFile(String newName) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 274     if (TextUtils.isEmpty(newName)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 275       ALog.w(TAG, &quot;重命名失败【服务器返回的文件名为空】&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 276       return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 277     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 278     ALog.d(TAG, String.format(&quot;文件重命名为：%s&quot;, newName));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 279     File oldFile = new File(mEntity.getFilePath());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 280     String newPath = oldFile.getParent() + &quot;/&quot; + newName;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 281     if (oldFile.exists()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 282       boolean b = oldFile.renameTo(new File(newPath));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 283       ALog.d(TAG, String.format(&quot;文件重命名%s&quot;, b ? &quot;成功&quot; : &quot;失败&quot;));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 284     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 285     mEntity.setFileName(newName);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 286     mEntity.setFilePath(newPath);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 287     RecordUtil.modifyTaskRecord(oldFile.getPath(), newPath, mEntity.getTaskType());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 288   }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 289 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 290   /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 291    * 处理30x跳转</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 292    */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 293   private void handleUrlReTurn(HttpURLConnection conn, String newUrl) throws IOException {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 294     ALog.d(TAG, &quot;30x跳转，新url为【&quot; + newUrl + &quot;】&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 295     if (TextUtils.isEmpty(newUrl) || newUrl.equalsIgnoreCase(&quot;null&quot;)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 296       if (onFileInfoCallback != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 297         onFileInfoCallback.onFail(mEntity, new TaskException(TAG, &quot;获取重定向链接失败&quot;), false);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 298       }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 299       return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 300     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 301     if (newUrl.startsWith(&quot;/&quot;)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 302       Uri uri = Uri.parse(mEntity.getUrl());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 303       newUrl = uri.getHost() + newUrl;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 304     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 305 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 306     if (!CheckUtil.checkUrl(newUrl)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 307       failDownload(new TaskException(TAG, &quot;下载失败，重定向url错误&quot;), false);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 308       return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 309     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 310     taskOption.setRedirectUrl(newUrl);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 311     mEntity.setRedirect(true);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 312     mEntity.setRedirectUrl(newUrl);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 313     String cookies = conn.getHeaderField(&quot;Set-Cookie&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 314     conn.disconnect();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 315     URL url = ConnectionHelp.handleUrl(newUrl, taskOption);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 316     conn = ConnectionHelp.handleConnection(url, taskOption);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 317     ConnectionHelp.setConnectParam(taskOption, conn);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 318     conn.setRequestProperty(&quot;Cookie&quot;, cookies);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 319     conn.setRequestProperty(&quot;Range&quot;, &quot;bytes=&quot; + 0 + &quot;-&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 320     conn.setConnectTimeout(mConnectTimeOut);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 321     conn.connect();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 322     handleConnect(conn);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 323     conn.disconnect();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 324   }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 325 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 326   /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 327    * 检查长度是否合法，并且检查新获取的文件长度是否和数据库的文件长度一直，如果不一致，则表示该任务为新任务</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 328    *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 329    * @param len 从服务器获取的文件长度</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 330    * @return {@code true}合法</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 331    */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 332   private boolean checkLen(long len) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 333     if (len != mEntity.getFileSize()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 334       ALog.d(TAG, &quot;长度不一致，任务为新任务&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 335       mTaskWrapper.setNewTask(true);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 336     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 337     return true;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 338   }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 339 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 340   private void failDownload(BaseException e, boolean needRetry) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 341     if (onFileInfoCallback != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 342       onFileInfoCallback.onFail(mEntity, e, needRetry);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 343     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 344   }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 345 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 346   private static class FileLenAdapter implements IHttpFileLenAdapter {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 347 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 348     @Override public long handleFileLen(Map&lt;String, List&lt;String&gt;&gt; headers) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 349       if (headers == null || headers.isEmpty()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 350         ALog.e(TAG, &quot;header为空，获取文件长度失败&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 351         return -1;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 352       }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 353       List&lt;String&gt; sLength = headers.get(&quot;Content-Length&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 354       if (sLength == null || sLength.isEmpty()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 355         return -1;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 356       }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 357       String temp = sLength.get(0);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 358       long len = TextUtils.isEmpty(temp) ? -1 : Long.parseLong(temp);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 359       // 某些服务，如果设置了conn.setRequestProperty(&quot;Range&quot;, &quot;bytes=&quot; + 0 + &quot;-&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 360       // 会返回 Content-Range: bytes 0-225427911/225427913</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 361       if (len &lt; 0) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 362         List&lt;String&gt; sRange = headers.get(&quot;Content-Range&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 363         if (sRange == null || sRange.isEmpty()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 364           len = -1;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 365         } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 366           int start = temp.indexOf(&quot;/&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 367           len = Long.parseLong(temp.substring(start + 1));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 368         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 369       }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 370 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 371       return len;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 372     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 373   }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 374 }</span>
 375 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 376 /*</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 377  * Copyright (C) 2016 AriaLyy(https://github.com/AriaLyy/Aria)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 378  *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 379  * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 380  * you may not use this file except in compliance with the License.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 381  * You may obtain a copy of the License at</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 382  *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 383  *      http://www.apache.org/licenses/LICENSE-2.0</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 384  *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 385  * Unless required by applicable law or agreed to in writing, software</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 386  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 387  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 388  * See the License for the specific language governing permissions and</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 389  * limitations under the License.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 390  */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 391 package com.arialyy.aria.http;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 392 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 393 import android.net.TrafficStats;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 394 import android.net.Uri;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 395 import android.os.Process;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 396 import android.text.TextUtils;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 397 import com.arialyy.aria.core.AriaConfig;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 398 import com.arialyy.aria.core.common.CompleteInfo;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 399 import com.arialyy.aria.core.common.RequestEnum;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 400 import com.arialyy.aria.core.download.DTaskWrapper;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 401 import com.arialyy.aria.core.download.DownloadEntity;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 402 import com.arialyy.aria.core.inf.OnFileInfoCallback;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 403 import com.arialyy.aria.core.processor.IHttpFileLenAdapter;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 404 import com.arialyy.aria.exception.AriaIOException;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 405 import com.arialyy.aria.exception.BaseException;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 406 import com.arialyy.aria.exception.TaskException;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 407 import com.arialyy.aria.util.ALog;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 408 import com.arialyy.aria.util.CheckUtil;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 409 import com.arialyy.aria.util.CommonUtil;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 410 import com.arialyy.aria.util.FileUtil;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 411 import com.arialyy.aria.util.RecordUtil;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 412 import java.io.BufferedReader;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 413 import java.io.File;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 414 import java.io.IOException;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 415 import java.io.InputStreamReader;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 416 import java.io.OutputStreamWriter;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 417 import java.io.UnsupportedEncodingException;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 418 import java.net.CookieManager;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 419 import java.net.HttpCookie;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 420 import java.net.HttpURLConnection;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 421 import java.net.URL;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 422 import java.net.URLDecoder;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 423 import java.net.URLEncoder;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 424 import java.util.List;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 425 import java.util.Map;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 426 import java.util.Set;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 427 import java.util.UUID;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 428 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 429 /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 430  * 下载文件信息获取</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 431  */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 432 public class HttpFileInfoThread implements Runnable {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 433   private static final String TAG = &quot;HttpFileInfoThread&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 434   private DownloadEntity mEntity;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 435   private DTaskWrapper mTaskWrapper;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 436   private int mConnectTimeOut;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 437   private OnFileInfoCallback onFileInfoCallback;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 438   private HttpTaskOption taskOption;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 439 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 440   public HttpFileInfoThread(DTaskWrapper taskWrapper, OnFileInfoCallback callback) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 441     this.mTaskWrapper = taskWrapper;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 442     mEntity = taskWrapper.getEntity();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 443     mConnectTimeOut = AriaConfig.getInstance().getDConfig().getConnectTimeOut();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 444     onFileInfoCallback = callback;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 445     taskOption = (HttpTaskOption) taskWrapper.getTaskOption();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 446   }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 447 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 448   @Override public void run() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 449     Process.setThreadPriority(Process.THREAD_PRIORITY_BACKGROUND);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 450     TrafficStats.setThreadStatsTag(UUID.randomUUID().toString().hashCode());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 451     HttpURLConnection conn = null;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 452     try {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 453       URL url = ConnectionHelp.handleUrl(mEntity.getUrl(), taskOption);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 454       conn = ConnectionHelp.handleConnection(url, taskOption);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 455       ConnectionHelp.setConnectParam(taskOption, conn);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 456       conn.setRequestProperty(&quot;Range&quot;, &quot;bytes=&quot; + 0 + &quot;-&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 457       conn.setConnectTimeout(mConnectTimeOut);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 458       conn.connect();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 459       handleConnect(conn);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 460     } catch (IOException e) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 461       e.printStackTrace();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 462       failDownload(new AriaIOException(TAG,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 463               String.format(&quot;下载失败，filePath: %s, url: %s&quot;, mEntity.getDownloadPath(), mEntity.getUrl())),</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 464           true);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 465     } finally {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 466       if (conn != null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 467         try {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 468           conn.getInputStream().close();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 469         } catch (IOException e) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 470           e.printStackTrace();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 471         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 472         conn.disconnect();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 473       }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 474     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 475   }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 476 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 477   private void handleConnect(HttpURLConnection conn) throws IOException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 478     if (taskOption.getRequestEnum() == RequestEnum.POST) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 479       Map&lt;String, String&gt; params = taskOption.getParams();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 480       if (params != null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 481         OutputStreamWriter dos = new OutputStreamWriter(conn.getOutputStream());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 482         Set&lt;String&gt; keys = params.keySet();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 483         StringBuilder sb = new StringBuilder();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 484         for (String key : keys) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 485           sb.append(key).append(&quot;=&quot;).append(URLEncoder.encode(params.get(key))).append(&quot;&amp;&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 486         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 487         String url = sb.toString();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 488         url = url.substring(0, url.length() - 1);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 489         dos.write(url);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 490         dos.flush();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 491         dos.close();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 492       }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 493     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 494 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 495     IHttpFileLenAdapter lenAdapter = taskOption.getFileLenAdapter();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 496     if (lenAdapter == null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 497       lenAdapter = new FileLenAdapter();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 498     } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 499       ALog.d(TAG, &quot;使用自定义adapter&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 500     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 501     long len = lenAdapter.handleFileLen(conn.getHeaderFields());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 502 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 503     if (!FileUtil.checkMemorySpace(mEntity.getFilePath(), len)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 504       failDownload(new TaskException(TAG,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 505           String.format(&quot;下载失败，内存空间不足；filePath: %s, url: %s&quot;, mEntity.getDownloadPath(),</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 506               mEntity.getUrl())), false);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 507       return;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 508     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 509 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 510     int code = conn.getResponseCode();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 511     boolean end = false;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 512     if (TextUtils.isEmpty(mEntity.getMd5Code())) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 513       String md5Code = conn.getHeaderField(&quot;Content-MD5&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 514       mEntity.setMd5Code(md5Code);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 515     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 516 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 517     boolean isChunked = false;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 518     final String str = conn.getHeaderField(&quot;Transfer-Encoding&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 519     if (!TextUtils.isEmpty(str) &amp;&amp; str.equals(&quot;chunked&quot;)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 520       isChunked = true;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 521     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 522     Map&lt;String, List&lt;String&gt;&gt; headers = conn.getHeaderFields();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 523     String disposition = conn.getHeaderField(&quot;Content-Disposition&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 524 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 525     if (taskOption.isUseServerFileName()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 526       if (!TextUtils.isEmpty(disposition)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 527         mEntity.setDisposition(CommonUtil.encryptBASE64(disposition));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 528         handleContentDisposition(disposition);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 529       } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 530         ALog.w(TAG, &quot;Content-Disposition对于端字段为空，使用服务器端文件名失败&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 531       }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 532     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 533     CookieManager msCookieManager = new CookieManager();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 534     List&lt;String&gt; cookiesHeader = headers.get(&quot;Set-Cookie&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 535 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 536     if (cookiesHeader != null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 537       for (String cookie : cookiesHeader) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 538         msCookieManager.getCookieStore().add(null, HttpCookie.parse(cookie).get(0));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 539       }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 540       taskOption.setCookieManager(msCookieManager);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 541     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 542 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 543     mTaskWrapper.setCode(code);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 544     if (code == HttpURLConnection.HTTP_PARTIAL) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 545       if (!checkLen(len) &amp;&amp; !isChunked) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 546         if (len &lt; 0) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 547           failDownload(</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 548               new AriaIOException(TAG, String.format(&quot;任务下载失败，文件长度小于0， url: %s&quot;, mEntity.getUrl())),</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 549               false);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 550         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 551         return;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 552       }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 553       mEntity.setFileSize(len);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 554       mTaskWrapper.setSupportBP(true);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 555       end = true;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 556     } else if (code == HttpURLConnection.HTTP_OK) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 557       String contentType = conn.getHeaderField(&quot;Content-Type&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 558       if (TextUtils.isEmpty(contentType)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 559         return;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 560       }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 561       if (contentType.equals(&quot;text/html&quot;)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 562         BufferedReader reader =</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 563             new BufferedReader(new InputStreamReader(ConnectionHelp.convertInputStream(conn)));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 564         StringBuilder sb = new StringBuilder();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 565         String line;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 566         while ((line = reader.readLine()) != null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 567           sb.append(line);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 568         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 569         reader.close();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 570         handleUrlReTurn(conn, CommonUtil.getWindowReplaceUrl(sb.toString()));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 571         return;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 572       } else if (!checkLen(len) &amp;&amp; !isChunked) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 573         if (len &lt; 0) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 574           failDownload(</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 575               new AriaIOException(TAG, String.format(&quot;任务下载失败，文件长度小于0， url: %s&quot;, mEntity.getUrl())),</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 576               false);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 577         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 578         ALog.d(TAG, &quot;len &lt; 0&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 579         return;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 580       }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 581       mEntity.setFileSize(len);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 582       mTaskWrapper.setNewTask(true);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 583       mTaskWrapper.setSupportBP(false);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 584       end = true;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 585     } else if (code == HttpURLConnection.HTTP_NOT_FOUND) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 586       failDownload(new AriaIOException(TAG,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 587           String.format(&quot;任务下载失败，errorCode：404, url: %s&quot;, mEntity.getUrl())), true);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 588     } else if (code == HttpURLConnection.HTTP_MOVED_TEMP</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 589         || code == HttpURLConnection.HTTP_MOVED_PERM</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 590         || code == HttpURLConnection.HTTP_SEE_OTHER</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 591         || code == HttpURLConnection.HTTP_CREATED // 201 跳转</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 592         || code == 307) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 593       handleUrlReTurn(conn, conn.getHeaderField(&quot;Location&quot;));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 594     } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 595       failDownload(new AriaIOException(TAG,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 596           String.format(&quot;任务下载失败，errorCode：%s, errorMsg: %s, url: %s&quot;, code,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 597               conn.getResponseMessage(), mEntity.getUrl())), !CheckUtil.httpIsBadRequest(code));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 598     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 599     if (end) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 600       taskOption.setChunked(isChunked);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 601       if (onFileInfoCallback != null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 602         CompleteInfo info = new CompleteInfo(code, mTaskWrapper);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 603         onFileInfoCallback.onComplete(mEntity.getUrl(), info);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 604       }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 605       mEntity.update();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 606     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 607   }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 608 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 609   /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 610    * 处理&quot;Content-Disposition&quot;参数</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 611    * &lt;a href=https://cloud.tencent.com/developer/section/1189916&gt;Content-Disposition&lt;/a&gt;&lt;/&gt;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 612    *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 613    * @throws UnsupportedEncodingException</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 614    */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 615   private void handleContentDisposition(String disposition) throws UnsupportedEncodingException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 616     if (disposition.contains(&quot;;&quot;)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 617       String[] infos = disposition.split(&quot;;&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 618       if (infos[0].equals(&quot;attachment&quot;)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 619         for (String info : infos) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 620           if (info.startsWith(&quot;filename&quot;) &amp;&amp; info.contains(&quot;=&quot;)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 621             String[] temp = info.split(&quot;=&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 622             if (temp.length &gt; 1) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 623               String newName = URLDecoder.decode(temp[1], &quot;utf-8&quot;).replaceAll(&quot;\&quot;&quot;, &quot;&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 624               mEntity.setServerFileName(newName);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 625               renameFile(newName);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 626               break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 627             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 628           }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 629         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 630       } else if (infos[0].equals(&quot;form-data&quot;) &amp;&amp; infos.length &gt; 2) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 631         String[] temp = infos[2].split(&quot;=&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 632         if (temp.length &gt; 1) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 633           String newName = URLDecoder.decode(temp[1], &quot;utf-8&quot;).replaceAll(&quot;\&quot;&quot;, &quot;&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 634           mEntity.setServerFileName(newName);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 635           renameFile(newName);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 636         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 637       } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 638         ALog.w(TAG, &quot;不识别的Content-Disposition参数&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 639       }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 640     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 641   }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 642 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 643   /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 644    * 重命名文件</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 645    */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 646   private void renameFile(String newName) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 647     if (TextUtils.isEmpty(newName)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 648       ALog.w(TAG, &quot;重命名失败【服务器返回的文件名为空】&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 649       return;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 650     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 651     ALog.d(TAG, String.format(&quot;文件重命名为：%s&quot;, newName));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 652     File oldFile = new File(mEntity.getFilePath());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 653     String newPath = oldFile.getParent() + &quot;/&quot; + newName;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 654     if (oldFile.exists()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 655       boolean b = oldFile.renameTo(new File(newPath));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 656       ALog.d(TAG, String.format(&quot;文件重命名%s&quot;, b ? &quot;成功&quot; : &quot;失败&quot;));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 657     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 658     mEntity.setFileName(newName);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 659     mEntity.setFilePath(newPath);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 660     RecordUtil.modifyTaskRecord(oldFile.getPath(), newPath, mEntity.getTaskType());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 661   }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 662 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 663   /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 664    * 处理30x跳转</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 665    */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 666   private void handleUrlReTurn(HttpURLConnection conn, String newUrl) throws IOException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 667     ALog.d(TAG, &quot;30x跳转，新url为【&quot; + newUrl + &quot;】&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 668     if (TextUtils.isEmpty(newUrl) || newUrl.equalsIgnoreCase(&quot;null&quot;)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 669       if (onFileInfoCallback != null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 670         onFileInfoCallback.onFail(mEntity, new TaskException(TAG, &quot;获取重定向链接失败&quot;), false);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 671       }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 672       return;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 673     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 674     if (newUrl.startsWith(&quot;/&quot;)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 675       Uri uri = Uri.parse(mEntity.getUrl());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 676       newUrl = uri.getHost() + newUrl;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 677     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 678 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 679     if (!CheckUtil.checkUrl(newUrl)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 680       failDownload(new TaskException(TAG, &quot;下载失败，重定向url错误&quot;), false);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 681       return;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 682     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 683     taskOption.setRedirectUrl(newUrl);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 684     mEntity.setRedirect(true);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 685     mEntity.setRedirectUrl(newUrl);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 686     String cookies = conn.getHeaderField(&quot;Set-Cookie&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 687     conn.disconnect();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 688     URL url = ConnectionHelp.handleUrl(newUrl, taskOption);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 689     conn = ConnectionHelp.handleConnection(url, taskOption);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 690     ConnectionHelp.setConnectParam(taskOption, conn);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 691     conn.setRequestProperty(&quot;Cookie&quot;, cookies);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 692     conn.setRequestProperty(&quot;Range&quot;, &quot;bytes=&quot; + 0 + &quot;-&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 693     conn.setConnectTimeout(mConnectTimeOut);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 694     conn.connect();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 695     handleConnect(conn);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 696     conn.disconnect();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 697   }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 698 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 699   /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 700    * 检查长度是否合法，并且检查新获取的文件长度是否和数据库的文件长度一直，如果不一致，则表示该任务为新任务</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 701    *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 702    * @param len 从服务器获取的文件长度</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 703    * @return {@code true}合法</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 704    */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 705   private boolean checkLen(long len) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 706     if (len != mEntity.getFileSize()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 707       ALog.d(TAG, &quot;长度不一致，任务为新任务&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 708       mTaskWrapper.setNewTask(true);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 709     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 710     return true;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 711   }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 712 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 713   private void failDownload(BaseException e, boolean needRetry) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 714     if (onFileInfoCallback != null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 715       onFileInfoCallback.onFail(mEntity, e, needRetry);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 716     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 717   }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 718 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 719   private static class FileLenAdapter implements IHttpFileLenAdapter {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 720 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 721     @Override public long handleFileLen(Map&lt;String, List&lt;String&gt;&gt; headers) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 722       if (headers == null || headers.isEmpty()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 723         ALog.e(TAG, &quot;header为空，获取文件长度失败&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 724         return -1;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 725       }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 726       List&lt;String&gt; sLength = headers.get(&quot;Content-Length&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 727       if (sLength == null || sLength.isEmpty()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 728         return -1;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 729       }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 730       String temp = sLength.get(0);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 731       long len = TextUtils.isEmpty(temp) ? -1 : Long.parseLong(temp);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 732       // 某些服务，如果设置了conn.setRequestProperty(&quot;Range&quot;, &quot;bytes=&quot; + 0 + &quot;-&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 733       // 会返回 Content-Range: bytes 0-225427911/225427913</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 734       if (len &lt; 0) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 735         List&lt;String&gt; sRange = headers.get(&quot;Content-Range&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 736         if (sRange == null || sRange.isEmpty()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 737           len = -1;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 738         } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 739           int start = temp.indexOf(&quot;/&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 740           len = Long.parseLong(temp.substring(start + 1));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 741         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 742       }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 743 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 744       return len;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 745     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 746   }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 747 }</span>
 748 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs</pre></td>
                            <td><pre>   1 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
   2 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   3 /*</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   4  * Copyright (C) 2016 AriaLyy(https://github.com/AriaLyy/Aria)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   5  *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   6  * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   7  * you may not use this file except in compliance with the License.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   8  * You may obtain a copy of the License at</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   9  *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  10  *      http://www.apache.org/licenses/LICENSE-2.0</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  11  *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  12  * Unless required by applicable law or agreed to in writing, software</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  15  * See the License for the specific language governing permissions and</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  16  * limitations under the License.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  17  */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  18 package com.arialyy.aria.http;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  19 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  20 import android.net.TrafficStats;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  21 import android.net.Uri;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  22 import android.os.Process;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  23 import android.text.TextUtils;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  24 import com.arialyy.aria.core.AriaConfig;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  25 import com.arialyy.aria.core.common.CompleteInfo;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  26 import com.arialyy.aria.core.common.RequestEnum;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  27 import com.arialyy.aria.core.download.DTaskWrapper;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  28 import com.arialyy.aria.core.download.DownloadEntity;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  29 import com.arialyy.aria.core.inf.OnFileInfoCallback;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  30 import com.arialyy.aria.core.processor.IHttpFileLenAdapter;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  31 import com.arialyy.aria.exception.AriaIOException;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  32 import com.arialyy.aria.exception.BaseException;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  33 import com.arialyy.aria.exception.TaskException;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  34 import com.arialyy.aria.util.ALog;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  35 import com.arialyy.aria.util.CheckUtil;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  36 import com.arialyy.aria.util.CommonUtil;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  37 import com.arialyy.aria.util.FileUtil;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  38 import com.arialyy.aria.util.RecordUtil;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  39 import java.io.BufferedReader;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  40 import java.io.File;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  41 import java.io.IOException;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  42 import java.io.InputStreamReader;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  43 import java.io.OutputStreamWriter;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  44 import java.io.UnsupportedEncodingException;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  45 import java.net.CookieManager;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  46 import java.net.HttpCookie;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  47 import java.net.HttpURLConnection;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  48 import java.net.URL;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  49 import java.net.URLDecoder;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  50 import java.net.URLEncoder;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  51 import java.util.List;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  52 import java.util.Map;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  53 import java.util.Set;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  54 import java.util.UUID;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  55 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  56 /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  57  * 下载文件信息获取</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  58  */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  59 public class HttpFileInfoThread implements Runnable {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  60   private static final String TAG = &quot;HttpFileInfoThread&quot;;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  61   private DownloadEntity mEntity;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  62   private DTaskWrapper mTaskWrapper;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  63   private int mConnectTimeOut;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  64   private OnFileInfoCallback onFileInfoCallback;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  65   private HttpTaskOption taskOption;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  66 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  67   public HttpFileInfoThread(DTaskWrapper taskWrapper, OnFileInfoCallback callback) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  68     this.mTaskWrapper = taskWrapper;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  69     mEntity = taskWrapper.getEntity();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  70     mConnectTimeOut = AriaConfig.getInstance().getDConfig().getConnectTimeOut();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  71     onFileInfoCallback = callback;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  72     taskOption = (HttpTaskOption) taskWrapper.getTaskOption();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  73   }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  74 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  75   @Override public void run() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  76     Process.setThreadPriority(Process.THREAD_PRIORITY_BACKGROUND);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  77     TrafficStats.setThreadStatsTag(UUID.randomUUID().toString().hashCode());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  78     HttpURLConnection conn = null;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  79     try {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  80       URL url = ConnectionHelp.handleUrl(mEntity.getUrl(), taskOption);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  81       conn = ConnectionHelp.handleConnection(url, taskOption);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  82       ConnectionHelp.setConnectParam(taskOption, conn);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  83       conn.setRequestProperty(&quot;Range&quot;, &quot;bytes=&quot; + 0 + &quot;-&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  84       conn.setConnectTimeout(mConnectTimeOut);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  85       conn.connect();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  86       handleConnect(conn);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  87     } catch (IOException e) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  88       e.printStackTrace();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  89       failDownload(new AriaIOException(TAG,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  90               String.format(&quot;下载失败，filePath: %s, url: %s&quot;, mEntity.getDownloadPath(), mEntity.getUrl())),</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  91           true);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  92     } finally {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  93       if (conn != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  94         try {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  95           conn.getInputStream().close();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  96         } catch (IOException e) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  97           e.printStackTrace();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  98         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  99         conn.disconnect();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 100       }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 101     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 102   }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 103 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 104   private void handleConnect(HttpURLConnection conn) throws IOException {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 105     if (taskOption.getRequestEnum() == RequestEnum.POST) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 106       Map&lt;String, String&gt; params = taskOption.getParams();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 107       if (params != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 108         OutputStreamWriter dos = new OutputStreamWriter(conn.getOutputStream());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 109         Set&lt;String&gt; keys = params.keySet();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 110         StringBuilder sb = new StringBuilder();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 111         for (String key : keys) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 112           sb.append(key).append(&quot;=&quot;).append(URLEncoder.encode(params.get(key))).append(&quot;&amp;&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 113         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 114         String url = sb.toString();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 115         url = url.substring(0, url.length() - 1);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 116         dos.write(url);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 117         dos.flush();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 118         dos.close();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 119       }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 120     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 121 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 122     IHttpFileLenAdapter lenAdapter = taskOption.getFileLenAdapter();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 123     if (lenAdapter == null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 124       lenAdapter = new FileLenAdapter();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 125     } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 126       ALog.d(TAG, &quot;使用自定义adapter&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 127     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 128     long len = lenAdapter.handleFileLen(conn.getHeaderFields());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 129 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 130     if (!FileUtil.checkSDMemorySpace(mEntity.getFilePath(), len)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 131       failDownload(new TaskException(TAG,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 132           String.format(&quot;下载失败，内存空间不足；filePath: %s, url: %s&quot;, mEntity.getDownloadPath(),</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 133               mEntity.getUrl())), false);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 134       return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 135     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 136 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 137     int code = conn.getResponseCode();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 138     boolean end = false;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 139     if (TextUtils.isEmpty(mEntity.getMd5Code())) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 140       String md5Code = conn.getHeaderField(&quot;Content-MD5&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 141       mEntity.setMd5Code(md5Code);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 142     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 143 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 144     boolean isChunked = false;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 145     final String str = conn.getHeaderField(&quot;Transfer-Encoding&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 146     if (!TextUtils.isEmpty(str) &amp;&amp; str.equals(&quot;chunked&quot;)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 147       isChunked = true;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 148     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 149     Map&lt;String, List&lt;String&gt;&gt; headers = conn.getHeaderFields();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 150     String disposition = conn.getHeaderField(&quot;Content-Disposition&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 151 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 152     if (taskOption.isUseServerFileName()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 153       if (!TextUtils.isEmpty(disposition)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 154         mEntity.setDisposition(CommonUtil.encryptBASE64(disposition));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 155         handleContentDisposition(disposition);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 156       } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 157         ALog.w(TAG, &quot;Content-Disposition对于端字段为空，使用服务器端文件名失败&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 158       }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 159     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 160     CookieManager msCookieManager = new CookieManager();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 161     List&lt;String&gt; cookiesHeader = headers.get(&quot;Set-Cookie&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 162 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 163     if (cookiesHeader != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 164       for (String cookie : cookiesHeader) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 165         msCookieManager.getCookieStore().add(null, HttpCookie.parse(cookie).get(0));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 166       }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 167       taskOption.setCookieManager(msCookieManager);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 168     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 169 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 170     mTaskWrapper.setCode(code);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 171     if (code == HttpURLConnection.HTTP_PARTIAL) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 172       if (!checkLen(len) &amp;&amp; !isChunked) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 173         if (len &lt; 0) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 174           failDownload(</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 175               new AriaIOException(TAG, String.format(&quot;任务下载失败，文件长度小于0， url: %s&quot;, mEntity.getUrl())),</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 176               false);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 177         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 178         return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 179       }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 180       mEntity.setFileSize(len);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 181       mTaskWrapper.setSupportBP(true);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 182       end = true;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 183     } else if (code == HttpURLConnection.HTTP_OK) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 184       String contentType = conn.getHeaderField(&quot;Content-Type&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 185       if (TextUtils.isEmpty(contentType)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 186         return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 187       }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 188       if (contentType.equals(&quot;text/html&quot;)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 189         BufferedReader reader =</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 190             new BufferedReader(new InputStreamReader(ConnectionHelp.convertInputStream(conn)));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 191         StringBuilder sb = new StringBuilder();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 192         String line;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 193         while ((line = reader.readLine()) != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 194           sb.append(line);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 195         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 196         reader.close();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 197         handleUrlReTurn(conn, CommonUtil.getWindowReplaceUrl(sb.toString()));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 198         return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 199       } else if (!checkLen(len) &amp;&amp; !isChunked) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 200         if (len &lt; 0) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 201           failDownload(</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 202               new AriaIOException(TAG, String.format(&quot;任务下载失败，文件长度小于0， url: %s&quot;, mEntity.getUrl())),</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 203               false);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 204         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 205         ALog.d(TAG, &quot;len &lt; 0&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 206         return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 207       }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 208       mEntity.setFileSize(len);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 209       mTaskWrapper.setNewTask(true);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 210       mTaskWrapper.setSupportBP(false);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 211       end = true;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 212     } else if (code == HttpURLConnection.HTTP_NOT_FOUND) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 213       failDownload(new AriaIOException(TAG,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 214           String.format(&quot;任务下载失败，errorCode：404, url: %s&quot;, mEntity.getUrl())), true);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 215     } else if (code == HttpURLConnection.HTTP_MOVED_TEMP</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 216         || code == HttpURLConnection.HTTP_MOVED_PERM</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 217         || code == HttpURLConnection.HTTP_SEE_OTHER</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 218         || code == HttpURLConnection.HTTP_CREATED // 201 跳转</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 219         || code == 307) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 220       handleUrlReTurn(conn, conn.getHeaderField(&quot;Location&quot;));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 221     } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 222       failDownload(new AriaIOException(TAG,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 223           String.format(&quot;任务下载失败，errorCode：%s, errorMsg: %s, url: %s&quot;, code,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 224               conn.getResponseMessage(), mEntity.getUrl())), !CheckUtil.httpIsBadRequest(code));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 225     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 226     if (end) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 227       taskOption.setChunked(isChunked);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 228       if (onFileInfoCallback != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 229         CompleteInfo info = new CompleteInfo(code, mTaskWrapper);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 230         onFileInfoCallback.onComplete(mEntity.getUrl(), info);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 231       }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 232       mEntity.update();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 233     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 234   }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 235 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 236   /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 237    * 处理&quot;Content-Disposition&quot;参数</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 238    * &lt;a href=https://cloud.tencent.com/developer/section/1189916&gt;Content-Disposition&lt;/a&gt;&lt;/&gt;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 239    *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 240    * @throws UnsupportedEncodingException</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 241    */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 242   private void handleContentDisposition(String disposition) throws UnsupportedEncodingException {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 243     if (disposition.contains(&quot;;&quot;)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 244       String[] infos = disposition.split(&quot;;&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 245       if (infos[0].equals(&quot;attachment&quot;)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 246         for (String info : infos) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 247           if (info.startsWith(&quot;filename&quot;) &amp;&amp; info.contains(&quot;=&quot;)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 248             String[] temp = info.split(&quot;=&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 249             if (temp.length &gt; 1) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 250               String newName = URLDecoder.decode(temp[1], &quot;utf-8&quot;).replaceAll(&quot;\&quot;&quot;, &quot;&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 251               mEntity.setServerFileName(newName);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 252               renameFile(newName);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 253               break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 254             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 255           }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 256         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 257       } else if (infos[0].equals(&quot;form-data&quot;) &amp;&amp; infos.length &gt; 2) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 258         String[] temp = infos[2].split(&quot;=&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 259         if (temp.length &gt; 1) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 260           String newName = URLDecoder.decode(temp[1], &quot;utf-8&quot;).replaceAll(&quot;\&quot;&quot;, &quot;&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 261           mEntity.setServerFileName(newName);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 262           renameFile(newName);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 263         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 264       } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 265         ALog.w(TAG, &quot;不识别的Content-Disposition参数&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 266       }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 267     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 268   }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 269 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 270   /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 271    * 重命名文件</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 272    */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 273   private void renameFile(String newName) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 274     if (TextUtils.isEmpty(newName)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 275       ALog.w(TAG, &quot;重命名失败【服务器返回的文件名为空】&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 276       return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 277     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 278     ALog.d(TAG, String.format(&quot;文件重命名为：%s&quot;, newName));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 279     File oldFile = new File(mEntity.getFilePath());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 280     String newPath = oldFile.getParent() + &quot;/&quot; + newName;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 281     if (oldFile.exists()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 282       boolean b = oldFile.renameTo(new File(newPath));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 283       ALog.d(TAG, String.format(&quot;文件重命名%s&quot;, b ? &quot;成功&quot; : &quot;失败&quot;));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 284     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 285     mEntity.setFileName(newName);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 286     mEntity.setFilePath(newPath);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 287     RecordUtil.modifyTaskRecord(oldFile.getPath(), newPath, mEntity.getTaskType());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 288   }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 289 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 290   /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 291    * 处理30x跳转</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 292    */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 293   private void handleUrlReTurn(HttpURLConnection conn, String newUrl) throws IOException {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 294     ALog.d(TAG, &quot;30x跳转，新url为【&quot; + newUrl + &quot;】&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 295     if (TextUtils.isEmpty(newUrl) || newUrl.equalsIgnoreCase(&quot;null&quot;)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 296       if (onFileInfoCallback != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 297         onFileInfoCallback.onFail(mEntity, new TaskException(TAG, &quot;获取重定向链接失败&quot;), false);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 298       }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 299       return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 300     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 301     if (newUrl.startsWith(&quot;/&quot;)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 302       Uri uri = Uri.parse(mEntity.getUrl());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 303       newUrl = uri.getHost() + newUrl;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 304     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 305 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 306     if (!CheckUtil.checkUrl(newUrl)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 307       failDownload(new TaskException(TAG, &quot;下载失败，重定向url错误&quot;), false);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 308       return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 309     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 310     taskOption.setRedirectUrl(newUrl);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 311     mEntity.setRedirect(true);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 312     mEntity.setRedirectUrl(newUrl);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 313     String cookies = conn.getHeaderField(&quot;Set-Cookie&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 314     conn.disconnect();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 315     URL url = ConnectionHelp.handleUrl(newUrl, taskOption);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 316     conn = ConnectionHelp.handleConnection(url, taskOption);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 317     ConnectionHelp.setConnectParam(taskOption, conn);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 318     conn.setRequestProperty(&quot;Cookie&quot;, cookies);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 319     conn.setRequestProperty(&quot;Range&quot;, &quot;bytes=&quot; + 0 + &quot;-&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 320     conn.setConnectTimeout(mConnectTimeOut);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 321     conn.connect();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 322     handleConnect(conn);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 323     conn.disconnect();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 324   }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 325 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 326   /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 327    * 检查长度是否合法，并且检查新获取的文件长度是否和数据库的文件长度一直，如果不一致，则表示该任务为新任务</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 328    *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 329    * @param len 从服务器获取的文件长度</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 330    * @return {@code true}合法</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 331    */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 332   private boolean checkLen(long len) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 333     if (len != mEntity.getFileSize()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 334       ALog.d(TAG, &quot;长度不一致，任务为新任务&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 335       mTaskWrapper.setNewTask(true);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 336     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 337     return true;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 338   }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 339 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 340   private void failDownload(BaseException e, boolean needRetry) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 341     if (onFileInfoCallback != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 342       onFileInfoCallback.onFail(mEntity, e, needRetry);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 343     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 344   }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 345 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 346   private static class FileLenAdapter implements IHttpFileLenAdapter {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 347 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 348     @Override public long handleFileLen(Map&lt;String, List&lt;String&gt;&gt; headers) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 349       if (headers == null || headers.isEmpty()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 350         ALog.e(TAG, &quot;header为空，获取文件长度失败&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 351         return -1;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 352       }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 353       List&lt;String&gt; sLength = headers.get(&quot;Content-Length&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 354       if (sLength == null || sLength.isEmpty()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 355         return -1;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 356       }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 357       String temp = sLength.get(0);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 358       long len = TextUtils.isEmpty(temp) ? -1 : Long.parseLong(temp);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 359       // 某些服务，如果设置了conn.setRequestProperty(&quot;Range&quot;, &quot;bytes=&quot; + 0 + &quot;-&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 360       // 会返回 Content-Range: bytes 0-225427911/225427913</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 361       if (len &lt; 0) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 362         List&lt;String&gt; sRange = headers.get(&quot;Content-Range&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 363         if (sRange == null || sRange.isEmpty()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 364           len = -1;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 365         } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 366           int start = temp.indexOf(&quot;/&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 367           len = Long.parseLong(temp.substring(start + 1));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 368         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 369       }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 370 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 371       return len;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 372     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 373   }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 374 }</span>
 375 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 376 /*</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 377  * Copyright (C) 2016 AriaLyy(https://github.com/AriaLyy/Aria)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 378  *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 379  * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 380  * you may not use this file except in compliance with the License.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 381  * You may obtain a copy of the License at</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 382  *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 383  *      http://www.apache.org/licenses/LICENSE-2.0</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 384  *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 385  * Unless required by applicable law or agreed to in writing, software</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 386  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 387  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 388  * See the License for the specific language governing permissions and</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 389  * limitations under the License.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 390  */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 391 package com.arialyy.aria.http;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 392 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 393 import android.net.TrafficStats;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 394 import android.net.Uri;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 395 import android.os.Process;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 396 import android.text.TextUtils;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 397 import com.arialyy.aria.core.AriaConfig;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 398 import com.arialyy.aria.core.common.CompleteInfo;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 399 import com.arialyy.aria.core.common.RequestEnum;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 400 import com.arialyy.aria.core.download.DTaskWrapper;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 401 import com.arialyy.aria.core.download.DownloadEntity;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 402 import com.arialyy.aria.core.inf.OnFileInfoCallback;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 403 import com.arialyy.aria.core.processor.IHttpFileLenAdapter;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 404 import com.arialyy.aria.exception.AriaIOException;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 405 import com.arialyy.aria.exception.BaseException;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 406 import com.arialyy.aria.exception.TaskException;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 407 import com.arialyy.aria.util.ALog;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 408 import com.arialyy.aria.util.CheckUtil;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 409 import com.arialyy.aria.util.CommonUtil;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 410 import com.arialyy.aria.util.FileUtil;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 411 import com.arialyy.aria.util.RecordUtil;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 412 import java.io.BufferedReader;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 413 import java.io.File;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 414 import java.io.IOException;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 415 import java.io.InputStreamReader;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 416 import java.io.OutputStreamWriter;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 417 import java.io.UnsupportedEncodingException;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 418 import java.net.CookieManager;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 419 import java.net.HttpCookie;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 420 import java.net.HttpURLConnection;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 421 import java.net.URL;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 422 import java.net.URLDecoder;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 423 import java.net.URLEncoder;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 424 import java.util.List;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 425 import java.util.Map;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 426 import java.util.Set;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 427 import java.util.UUID;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 428 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 429 /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 430  * 下载文件信息获取</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 431  */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 432 public class HttpFileInfoThread implements Runnable {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 433   private static final String TAG = &quot;HttpFileInfoThread&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 434   private DownloadEntity mEntity;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 435   private DTaskWrapper mTaskWrapper;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 436   private int mConnectTimeOut;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 437   private OnFileInfoCallback onFileInfoCallback;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 438   private HttpTaskOption taskOption;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 439 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 440   public HttpFileInfoThread(DTaskWrapper taskWrapper, OnFileInfoCallback callback) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 441     this.mTaskWrapper = taskWrapper;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 442     mEntity = taskWrapper.getEntity();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 443     mConnectTimeOut = AriaConfig.getInstance().getDConfig().getConnectTimeOut();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 444     onFileInfoCallback = callback;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 445     taskOption = (HttpTaskOption) taskWrapper.getTaskOption();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 446   }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 447 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 448   @Override public void run() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 449     Process.setThreadPriority(Process.THREAD_PRIORITY_BACKGROUND);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 450     TrafficStats.setThreadStatsTag(UUID.randomUUID().toString().hashCode());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 451     HttpURLConnection conn = null;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 452     try {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 453       URL url = ConnectionHelp.handleUrl(mEntity.getUrl(), taskOption);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 454       conn = ConnectionHelp.handleConnection(url, taskOption);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 455       ConnectionHelp.setConnectParam(taskOption, conn);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 456       conn.setRequestProperty(&quot;Range&quot;, &quot;bytes=&quot; + 0 + &quot;-&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 457       conn.setConnectTimeout(mConnectTimeOut);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 458       conn.connect();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 459       handleConnect(conn);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 460     } catch (IOException e) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 461       e.printStackTrace();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 462       failDownload(new AriaIOException(TAG,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 463               String.format(&quot;下载失败，filePath: %s, url: %s&quot;, mEntity.getDownloadPath(), mEntity.getUrl())),</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 464           true);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 465     } finally {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 466       if (conn != null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 467         try {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 468           conn.getInputStream().close();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 469         } catch (IOException e) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 470           e.printStackTrace();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 471         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 472         conn.disconnect();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 473       }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 474     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 475   }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 476 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 477   private void handleConnect(HttpURLConnection conn) throws IOException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 478     if (taskOption.getRequestEnum() == RequestEnum.POST) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 479       Map&lt;String, String&gt; params = taskOption.getParams();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 480       if (params != null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 481         OutputStreamWriter dos = new OutputStreamWriter(conn.getOutputStream());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 482         Set&lt;String&gt; keys = params.keySet();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 483         StringBuilder sb = new StringBuilder();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 484         for (String key : keys) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 485           sb.append(key).append(&quot;=&quot;).append(URLEncoder.encode(params.get(key))).append(&quot;&amp;&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 486         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 487         String url = sb.toString();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 488         url = url.substring(0, url.length() - 1);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 489         dos.write(url);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 490         dos.flush();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 491         dos.close();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 492       }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 493     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 494 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 495     IHttpFileLenAdapter lenAdapter = taskOption.getFileLenAdapter();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 496     if (lenAdapter == null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 497       lenAdapter = new FileLenAdapter();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 498     } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 499       ALog.d(TAG, &quot;使用自定义adapter&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 500     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 501     long len = lenAdapter.handleFileLen(conn.getHeaderFields());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 502 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 503     if (!FileUtil.checkMemorySpace(mEntity.getFilePath(), len)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 504       failDownload(new TaskException(TAG,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 505           String.format(&quot;下载失败，内存空间不足；filePath: %s, url: %s&quot;, mEntity.getDownloadPath(),</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 506               mEntity.getUrl())), false);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 507       return;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 508     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 509 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 510     int code = conn.getResponseCode();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 511     boolean end = false;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 512     if (TextUtils.isEmpty(mEntity.getMd5Code())) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 513       String md5Code = conn.getHeaderField(&quot;Content-MD5&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 514       mEntity.setMd5Code(md5Code);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 515     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 516 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 517     boolean isChunked = false;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 518     final String str = conn.getHeaderField(&quot;Transfer-Encoding&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 519     if (!TextUtils.isEmpty(str) &amp;&amp; str.equals(&quot;chunked&quot;)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 520       isChunked = true;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 521     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 522     Map&lt;String, List&lt;String&gt;&gt; headers = conn.getHeaderFields();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 523     String disposition = conn.getHeaderField(&quot;Content-Disposition&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 524 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 525     if (taskOption.isUseServerFileName()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 526       if (!TextUtils.isEmpty(disposition)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 527         mEntity.setDisposition(CommonUtil.encryptBASE64(disposition));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 528         handleContentDisposition(disposition);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 529       } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 530         ALog.w(TAG, &quot;Content-Disposition对于端字段为空，使用服务器端文件名失败&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 531       }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 532     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 533     CookieManager msCookieManager = new CookieManager();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 534     List&lt;String&gt; cookiesHeader = headers.get(&quot;Set-Cookie&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 535 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 536     if (cookiesHeader != null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 537       for (String cookie : cookiesHeader) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 538         msCookieManager.getCookieStore().add(null, HttpCookie.parse(cookie).get(0));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 539       }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 540       taskOption.setCookieManager(msCookieManager);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 541     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 542 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 543     mTaskWrapper.setCode(code);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 544     if (code == HttpURLConnection.HTTP_PARTIAL) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 545       if (!checkLen(len) &amp;&amp; !isChunked) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 546         if (len &lt; 0) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 547           failDownload(</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 548               new AriaIOException(TAG, String.format(&quot;任务下载失败，文件长度小于0， url: %s&quot;, mEntity.getUrl())),</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 549               false);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 550         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 551         return;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 552       }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 553       mEntity.setFileSize(len);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 554       mTaskWrapper.setSupportBP(true);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 555       end = true;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 556     } else if (code == HttpURLConnection.HTTP_OK) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 557       String contentType = conn.getHeaderField(&quot;Content-Type&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 558       if (TextUtils.isEmpty(contentType)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 559         return;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 560       }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 561       if (contentType.equals(&quot;text/html&quot;)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 562         BufferedReader reader =</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 563             new BufferedReader(new InputStreamReader(ConnectionHelp.convertInputStream(conn)));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 564         StringBuilder sb = new StringBuilder();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 565         String line;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 566         while ((line = reader.readLine()) != null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 567           sb.append(line);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 568         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 569         reader.close();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 570         handleUrlReTurn(conn, CommonUtil.getWindowReplaceUrl(sb.toString()));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 571         return;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 572       } else if (!checkLen(len) &amp;&amp; !isChunked) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 573         if (len &lt; 0) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 574           failDownload(</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 575               new AriaIOException(TAG, String.format(&quot;任务下载失败，文件长度小于0， url: %s&quot;, mEntity.getUrl())),</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 576               false);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 577         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 578         ALog.d(TAG, &quot;len &lt; 0&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 579         return;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 580       }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 581       mEntity.setFileSize(len);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 582       mTaskWrapper.setNewTask(true);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 583       mTaskWrapper.setSupportBP(false);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 584       end = true;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 585     } else if (code == HttpURLConnection.HTTP_NOT_FOUND) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 586       failDownload(new AriaIOException(TAG,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 587           String.format(&quot;任务下载失败，errorCode：404, url: %s&quot;, mEntity.getUrl())), true);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 588     } else if (code == HttpURLConnection.HTTP_MOVED_TEMP</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 589         || code == HttpURLConnection.HTTP_MOVED_PERM</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 590         || code == HttpURLConnection.HTTP_SEE_OTHER</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 591         || code == HttpURLConnection.HTTP_CREATED // 201 跳转</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 592         || code == 307) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 593       handleUrlReTurn(conn, conn.getHeaderField(&quot;Location&quot;));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 594     } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 595       failDownload(new AriaIOException(TAG,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 596           String.format(&quot;任务下载失败，errorCode：%s, errorMsg: %s, url: %s&quot;, code,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 597               conn.getResponseMessage(), mEntity.getUrl())), !CheckUtil.httpIsBadRequest(code));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 598     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 599     if (end) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 600       taskOption.setChunked(isChunked);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 601       if (onFileInfoCallback != null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 602         CompleteInfo info = new CompleteInfo(code, mTaskWrapper);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 603         onFileInfoCallback.onComplete(mEntity.getUrl(), info);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 604       }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 605       mEntity.update();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 606     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 607   }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 608 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 609   /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 610    * 处理&quot;Content-Disposition&quot;参数</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 611    * &lt;a href=https://cloud.tencent.com/developer/section/1189916&gt;Content-Disposition&lt;/a&gt;&lt;/&gt;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 612    *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 613    * @throws UnsupportedEncodingException</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 614    */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 615   private void handleContentDisposition(String disposition) throws UnsupportedEncodingException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 616     if (disposition.contains(&quot;;&quot;)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 617       String[] infos = disposition.split(&quot;;&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 618       if (infos[0].equals(&quot;attachment&quot;)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 619         for (String info : infos) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 620           if (info.startsWith(&quot;filename&quot;) &amp;&amp; info.contains(&quot;=&quot;)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 621             String[] temp = info.split(&quot;=&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 622             if (temp.length &gt; 1) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 623               String newName = URLDecoder.decode(temp[1], &quot;utf-8&quot;).replaceAll(&quot;\&quot;&quot;, &quot;&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 624               mEntity.setServerFileName(newName);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 625               renameFile(newName);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 626               break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 627             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 628           }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 629         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 630       } else if (infos[0].equals(&quot;form-data&quot;) &amp;&amp; infos.length &gt; 2) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 631         String[] temp = infos[2].split(&quot;=&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 632         if (temp.length &gt; 1) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 633           String newName = URLDecoder.decode(temp[1], &quot;utf-8&quot;).replaceAll(&quot;\&quot;&quot;, &quot;&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 634           mEntity.setServerFileName(newName);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 635           renameFile(newName);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 636         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 637       } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 638         ALog.w(TAG, &quot;不识别的Content-Disposition参数&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 639       }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 640     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 641   }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 642 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 643   /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 644    * 重命名文件</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 645    */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 646   private void renameFile(String newName) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 647     if (TextUtils.isEmpty(newName)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 648       ALog.w(TAG, &quot;重命名失败【服务器返回的文件名为空】&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 649       return;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 650     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 651     ALog.d(TAG, String.format(&quot;文件重命名为：%s&quot;, newName));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 652     File oldFile = new File(mEntity.getFilePath());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 653     String newPath = oldFile.getParent() + &quot;/&quot; + newName;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 654     if (oldFile.exists()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 655       boolean b = oldFile.renameTo(new File(newPath));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 656       ALog.d(TAG, String.format(&quot;文件重命名%s&quot;, b ? &quot;成功&quot; : &quot;失败&quot;));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 657     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 658     mEntity.setFileName(newName);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 659     mEntity.setFilePath(newPath);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 660     RecordUtil.modifyTaskRecord(oldFile.getPath(), newPath, mEntity.getTaskType());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 661   }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 662 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 663   /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 664    * 处理30x跳转</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 665    */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 666   private void handleUrlReTurn(HttpURLConnection conn, String newUrl) throws IOException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 667     ALog.d(TAG, &quot;30x跳转，新url为【&quot; + newUrl + &quot;】&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 668     if (TextUtils.isEmpty(newUrl) || newUrl.equalsIgnoreCase(&quot;null&quot;)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 669       if (onFileInfoCallback != null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 670         onFileInfoCallback.onFail(mEntity, new TaskException(TAG, &quot;获取重定向链接失败&quot;), false);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 671       }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 672       return;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 673     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 674     if (newUrl.startsWith(&quot;/&quot;)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 675       Uri uri = Uri.parse(mEntity.getUrl());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 676       newUrl = uri.getHost() + newUrl;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 677     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 678 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 679     if (!CheckUtil.checkUrl(newUrl)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 680       failDownload(new TaskException(TAG, &quot;下载失败，重定向url错误&quot;), false);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 681       return;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 682     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 683     taskOption.setRedirectUrl(newUrl);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 684     mEntity.setRedirect(true);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 685     mEntity.setRedirectUrl(newUrl);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 686     String cookies = conn.getHeaderField(&quot;Set-Cookie&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 687     conn.disconnect();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 688     URL url = ConnectionHelp.handleUrl(newUrl, taskOption);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 689     conn = ConnectionHelp.handleConnection(url, taskOption);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 690     ConnectionHelp.setConnectParam(taskOption, conn);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 691     conn.setRequestProperty(&quot;Cookie&quot;, cookies);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 692     conn.setRequestProperty(&quot;Range&quot;, &quot;bytes=&quot; + 0 + &quot;-&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 693     conn.setConnectTimeout(mConnectTimeOut);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 694     conn.connect();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 695     handleConnect(conn);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 696     conn.disconnect();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 697   }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 698 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 699   /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 700    * 检查长度是否合法，并且检查新获取的文件长度是否和数据库的文件长度一直，如果不一致，则表示该任务为新任务</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 701    *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 702    * @param len 从服务器获取的文件长度</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 703    * @return {@code true}合法</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 704    */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 705   private boolean checkLen(long len) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 706     if (len != mEntity.getFileSize()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 707       ALog.d(TAG, &quot;长度不一致，任务为新任务&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 708       mTaskWrapper.setNewTask(true);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 709     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 710     return true;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 711   }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 712 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 713   private void failDownload(BaseException e, boolean needRetry) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 714     if (onFileInfoCallback != null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 715       onFileInfoCallback.onFail(mEntity, e, needRetry);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 716     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 717   }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 718 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 719   private static class FileLenAdapter implements IHttpFileLenAdapter {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 720 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 721     @Override public long handleFileLen(Map&lt;String, List&lt;String&gt;&gt; headers) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 722       if (headers == null || headers.isEmpty()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 723         ALog.e(TAG, &quot;header为空，获取文件长度失败&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 724         return -1;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 725       }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 726       List&lt;String&gt; sLength = headers.get(&quot;Content-Length&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 727       if (sLength == null || sLength.isEmpty()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 728         return -1;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 729       }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 730       String temp = sLength.get(0);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 731       long len = TextUtils.isEmpty(temp) ? -1 : Long.parseLong(temp);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 732       // 某些服务，如果设置了conn.setRequestProperty(&quot;Range&quot;, &quot;bytes=&quot; + 0 + &quot;-&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 733       // 会返回 Content-Range: bytes 0-225427911/225427913</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 734       if (len &lt; 0) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 735         List&lt;String&gt; sRange = headers.get(&quot;Content-Range&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 736         if (sRange == null || sRange.isEmpty()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 737           len = -1;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 738         } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 739           int start = temp.indexOf(&quot;/&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 740           len = Long.parseLong(temp.substring(start + 1));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 741         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 742       }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 743 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 744       return len;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 745     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 746   }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 747 }</span>
 748 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS</pre></td>
                            <td><pre>   1 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
   2 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="   3 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/">   3 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kw🔵</abbr></span>
   4 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">   5 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">   6 /*</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">   7  * Copyright (C) 2016 AriaLyy(https://github.com/AriaLyy/Aria)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">   8  *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">   9  * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  10  * you may not use this file except in compliance with the License.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  11  * You may obtain a copy of the License at</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  12  *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  13  *      http://www.apache.org/licenses/LICENSE-2.0</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  14  *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  15  * Unless required by applicable law or agreed to in writing, software</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  16  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  17  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  18  * See the License for the specific language governing permissions and</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  19  * limitations under the License.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  20  */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  21 package com.arialyy.aria.http;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  22 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  23 import android.net.TrafficStats;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  24 import android.net.Uri;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  25 import android.os.Process;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  26 import android.text.TextUtils;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  27 import com.arialyy.aria.core.AriaConfig;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  28 import com.arialyy.aria.core.common.CompleteInfo;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  29 import com.arialyy.aria.core.common.RequestEnum;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  30 import com.arialyy.aria.core.download.DTaskWrapper;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  31 import com.arialyy.aria.core.download.DownloadEntity;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  32 import com.arialyy.aria.core.inf.OnFileInfoCallback;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  33 import com.arialyy.aria.core.processor.IHttpFileLenAdapter;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  34 import com.arialyy.aria.exception.AriaIOException;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  35 import com.arialyy.aria.exception.BaseException;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  36 import com.arialyy.aria.exception.TaskException;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  37 import com.arialyy.aria.util.ALog;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  38 import com.arialyy.aria.util.CheckUtil;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  39 import com.arialyy.aria.util.CommonUtil;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  40 import com.arialyy.aria.util.FileUtil;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  41 import com.arialyy.aria.util.RecordUtil;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  42 import java.io.BufferedReader;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  43 import java.io.File;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  44 import java.io.IOException;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  45 import java.io.InputStreamReader;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  46 import java.io.OutputStreamWriter;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  47 import java.io.UnsupportedEncodingException;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  48 import java.net.CookieManager;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  49 import java.net.HttpCookie;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  50 import java.net.HttpURLConnection;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  51 import java.net.URL;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  52 import java.net.URLDecoder;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  53 import java.net.URLEncoder;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  54 import java.util.List;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  55 import java.util.Map;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  56 import java.util.Set;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  57 import java.util.UUID;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  58 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  59 /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  60  * 下载文件信息获取</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  61  */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  62 public class HttpFileInfoThread implements Runnable {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  63   private static final String TAG = &quot;HttpFileInfoThread&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  64   private DownloadEntity mEntity;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  65   private DTaskWrapper mTaskWrapper;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  66   private int mConnectTimeOut;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  67   private OnFileInfoCallback onFileInfoCallback;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  68   private HttpTaskOption taskOption;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  69 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  70   public HttpFileInfoThread(DTaskWrapper taskWrapper, OnFileInfoCallback callback) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  71     this.mTaskWrapper = taskWrapper;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  72     mEntity = taskWrapper.getEntity();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  73     mConnectTimeOut = AriaConfig.getInstance().getDConfig().getConnectTimeOut();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  74     onFileInfoCallback = callback;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  75     taskOption = (HttpTaskOption) taskWrapper.getTaskOption();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  76   }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  77 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  78   @Override public void run() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  79     Process.setThreadPriority(Process.THREAD_PRIORITY_BACKGROUND);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  80     TrafficStats.setThreadStatsTag(UUID.randomUUID().toString().hashCode());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  81     HttpURLConnection conn = null;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  82     try {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  83       URL url = ConnectionHelp.handleUrl(mEntity.getUrl(), taskOption);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  84       conn = ConnectionHelp.handleConnection(url, taskOption);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  85       ConnectionHelp.setConnectParam(taskOption, conn);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  86       conn.setRequestProperty(&quot;Range&quot;, &quot;bytes=&quot; + 0 + &quot;-&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  87       conn.setConnectTimeout(mConnectTimeOut);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  88       conn.connect();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  89       handleConnect(conn);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  90     } catch (IOException e) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  91       e.printStackTrace();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  92       failDownload(new AriaIOException(TAG,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  93               String.format(&quot;下载失败，filePath: %s, url: %s&quot;, mEntity.getDownloadPath(), mEntity.getUrl())),</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  94           true);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  95     } finally {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  96       if (conn != null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  97         try {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  98           conn.getInputStream().close();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  99         } catch (IOException e) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 100           e.printStackTrace();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 101         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 102         conn.disconnect();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 103       }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 104     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 105   }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 106 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 107   private void handleConnect(HttpURLConnection conn) throws IOException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 108     if (taskOption.getRequestEnum() == RequestEnum.POST) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 109       Map&lt;String, String&gt; params = taskOption.getParams();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 110       if (params != null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 111         OutputStreamWriter dos = new OutputStreamWriter(conn.getOutputStream());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 112         Set&lt;String&gt; keys = params.keySet();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 113         StringBuilder sb = new StringBuilder();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 114         for (String key : keys) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 115           sb.append(key).append(&quot;=&quot;).append(URLEncoder.encode(params.get(key))).append(&quot;&amp;&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 116         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 117         String url = sb.toString();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 118         url = url.substring(0, url.length() - 1);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 119         dos.write(url);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 120         dos.flush();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 121         dos.close();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 122       }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 123     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 124 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 125     IHttpFileLenAdapter lenAdapter = taskOption.getFileLenAdapter();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 126     if (lenAdapter == null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 127       lenAdapter = new FileLenAdapter();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 128     } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 129       ALog.d(TAG, &quot;使用自定义adapter&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 130     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 131     long len = lenAdapter.handleFileLen(conn.getHeaderFields());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 132 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 133     if (!FileUtil.checkMemorySpace(mEntity.getFilePath(), len)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 134       failDownload(new TaskException(TAG,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 135           String.format(&quot;下载失败，内存空间不足；filePath: %s, url: %s&quot;, mEntity.getDownloadPath(),</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 136               mEntity.getUrl())), false);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 137       return;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 138     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 139 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 140     int code = conn.getResponseCode();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 141     boolean end = false;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 142     if (TextUtils.isEmpty(mEntity.getMd5Code())) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 143       String md5Code = conn.getHeaderField(&quot;Content-MD5&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 144       mEntity.setMd5Code(md5Code);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 145     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 146 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 147     boolean isChunked = false;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 148     final String str = conn.getHeaderField(&quot;Transfer-Encoding&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 149     if (!TextUtils.isEmpty(str) &amp;&amp; str.equals(&quot;chunked&quot;)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 150       isChunked = true;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 151     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 152     Map&lt;String, List&lt;String&gt;&gt; headers = conn.getHeaderFields();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 153     String disposition = conn.getHeaderField(&quot;Content-Disposition&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 154 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 155     if (taskOption.isUseServerFileName()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 156       if (!TextUtils.isEmpty(disposition)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 157         mEntity.setDisposition(CommonUtil.encryptBASE64(disposition));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 158         handleContentDisposition(disposition);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 159       } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 160         ALog.w(TAG, &quot;Content-Disposition对于端字段为空，使用服务器端文件名失败&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 161       }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 162     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 163     CookieManager msCookieManager = new CookieManager();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 164     List&lt;String&gt; cookiesHeader = headers.get(&quot;Set-Cookie&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 165 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 166     if (cookiesHeader != null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 167       for (String cookie : cookiesHeader) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 168         msCookieManager.getCookieStore().add(null, HttpCookie.parse(cookie).get(0));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 169       }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 170       taskOption.setCookieManager(msCookieManager);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 171     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 172 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 173     mTaskWrapper.setCode(code);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 174     if (code == HttpURLConnection.HTTP_PARTIAL) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 175       if (!checkLen(len) &amp;&amp; !isChunked) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 176         if (len &lt; 0) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 177           failDownload(</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 178               new AriaIOException(TAG, String.format(&quot;任务下载失败，文件长度小于0， url: %s&quot;, mEntity.getUrl())),</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 179               false);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 180         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 181         return;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 182       }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 183       mEntity.setFileSize(len);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 184       mTaskWrapper.setSupportBP(true);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 185       end = true;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 186     } else if (code == HttpURLConnection.HTTP_OK) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 187       String contentType = conn.getHeaderField(&quot;Content-Type&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 188       if (TextUtils.isEmpty(contentType)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 189         return;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 190       }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 191       if (contentType.equals(&quot;text/html&quot;)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 192         BufferedReader reader =</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 193             new BufferedReader(new InputStreamReader(ConnectionHelp.convertInputStream(conn)));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 194         StringBuilder sb = new StringBuilder();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 195         String line;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 196         while ((line = reader.readLine()) != null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 197           sb.append(line);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 198         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 199         reader.close();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 200         handleUrlReTurn(conn, CommonUtil.getWindowReplaceUrl(sb.toString()));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 201         return;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 202       } else if (!checkLen(len) &amp;&amp; !isChunked) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 203         if (len &lt; 0) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 204           failDownload(</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 205               new AriaIOException(TAG, String.format(&quot;任务下载失败，文件长度小于0， url: %s&quot;, mEntity.getUrl())),</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 206               false);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 207         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 208         ALog.d(TAG, &quot;len &lt; 0&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 209         return;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 210       }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 211       mEntity.setFileSize(len);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 212       mTaskWrapper.setNewTask(true);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 213       mTaskWrapper.setSupportBP(false);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 214       end = true;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 215     } else if (code == HttpURLConnection.HTTP_NOT_FOUND) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 216       failDownload(new AriaIOException(TAG,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 217           String.format(&quot;任务下载失败，errorCode：404, url: %s&quot;, mEntity.getUrl())), true);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 218     } else if (code == HttpURLConnection.HTTP_MOVED_TEMP</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 219         || code == HttpURLConnection.HTTP_MOVED_PERM</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 220         || code == HttpURLConnection.HTTP_SEE_OTHER</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 221         || code == HttpURLConnection.HTTP_CREATED // 201 跳转</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 222         || code == 307) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 223       handleUrlReTurn(conn, conn.getHeaderField(&quot;Location&quot;));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 224     } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 225       failDownload(new AriaIOException(TAG,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 226           String.format(&quot;任务下载失败，errorCode：%s, errorMsg: %s, url: %s&quot;, code,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 227               conn.getResponseMessage(), mEntity.getUrl())), !CheckUtil.httpIsBadRequest(code));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 228     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 229     if (end) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 230       taskOption.setChunked(isChunked);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 231       if (onFileInfoCallback != null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 232         CompleteInfo info = new CompleteInfo(code, mTaskWrapper);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 233         onFileInfoCallback.onComplete(mEntity.getUrl(), info);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 234       }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 235       mEntity.update();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 236     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 237   }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 238 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 239   /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 240    * 处理&quot;Content-Disposition&quot;参数</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 241    * &lt;a href=https://cloud.tencent.com/developer/section/1189916&gt;Content-Disposition&lt;/a&gt;&lt;/&gt;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 242    *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 243    * @throws UnsupportedEncodingException</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 244    */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 245   private void handleContentDisposition(String disposition) throws UnsupportedEncodingException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 246     if (disposition.contains(&quot;;&quot;)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 247       String[] infos = disposition.split(&quot;;&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 248       if (infos[0].equals(&quot;attachment&quot;)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 249         for (String info : infos) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 250           if (info.startsWith(&quot;filename&quot;) &amp;&amp; info.contains(&quot;=&quot;)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 251             String[] temp = info.split(&quot;=&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 252             if (temp.length &gt; 1) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 253               String newName = URLDecoder.decode(temp[1], &quot;utf-8&quot;).replaceAll(&quot;\&quot;&quot;, &quot;&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 254               mEntity.setServerFileName(newName);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 255               renameFile(newName);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 256               break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 257             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 258           }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 259         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 260       } else if (infos[0].equals(&quot;form-data&quot;) &amp;&amp; infos.length &gt; 2) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 261         String[] temp = infos[2].split(&quot;=&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 262         if (temp.length &gt; 1) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 263           String newName = URLDecoder.decode(temp[1], &quot;utf-8&quot;).replaceAll(&quot;\&quot;&quot;, &quot;&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 264           mEntity.setServerFileName(newName);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 265           renameFile(newName);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 266         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 267       } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 268         ALog.w(TAG, &quot;不识别的Content-Disposition参数&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 269       }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 270     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 271   }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 272 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 273   /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 274    * 重命名文件</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 275    */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 276   private void renameFile(String newName) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 277     if (TextUtils.isEmpty(newName)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 278       ALog.w(TAG, &quot;重命名失败【服务器返回的文件名为空】&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 279       return;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 280     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 281     ALog.d(TAG, String.format(&quot;文件重命名为：%s&quot;, newName));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 282     File oldFile = new File(mEntity.getFilePath());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 283     String newPath = oldFile.getParent() + &quot;/&quot; + newName;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 284     if (oldFile.exists()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 285       boolean b = oldFile.renameTo(new File(newPath));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 286       ALog.d(TAG, String.format(&quot;文件重命名%s&quot;, b ? &quot;成功&quot; : &quot;失败&quot;));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 287     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 288     mEntity.setFileName(newName);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 289     mEntity.setFilePath(newPath);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 290     RecordUtil.modifyTaskRecord(oldFile.getPath(), newPath, mEntity.getTaskType());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 291   }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 292 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 293   /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 294    * 处理30x跳转</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 295    */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 296   private void handleUrlReTurn(HttpURLConnection conn, String newUrl) throws IOException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 297     ALog.d(TAG, &quot;30x跳转，新url为【&quot; + newUrl + &quot;】&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 298     if (TextUtils.isEmpty(newUrl) || newUrl.equalsIgnoreCase(&quot;null&quot;)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 299       if (onFileInfoCallback != null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 300         onFileInfoCallback.onFail(mEntity, new TaskException(TAG, &quot;获取重定向链接失败&quot;), false);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 301       }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 302       return;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 303     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 304     if (newUrl.startsWith(&quot;/&quot;)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 305       Uri uri = Uri.parse(mEntity.getUrl());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 306       newUrl = uri.getHost() + newUrl;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 307     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 308 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 309     if (!CheckUtil.checkUrl(newUrl)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 310       failDownload(new TaskException(TAG, &quot;下载失败，重定向url错误&quot;), false);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 311       return;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 312     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 313     taskOption.setRedirectUrl(newUrl);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 314     mEntity.setRedirect(true);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 315     mEntity.setRedirectUrl(newUrl);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 316     String cookies = conn.getHeaderField(&quot;Set-Cookie&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 317     conn.disconnect();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 318     URL url = ConnectionHelp.handleUrl(newUrl, taskOption);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 319     conn = ConnectionHelp.handleConnection(url, taskOption);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 320     ConnectionHelp.setConnectParam(taskOption, conn);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 321     conn.setRequestProperty(&quot;Cookie&quot;, cookies);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 322     conn.setRequestProperty(&quot;Range&quot;, &quot;bytes=&quot; + 0 + &quot;-&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 323     conn.setConnectTimeout(mConnectTimeOut);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 324     conn.connect();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 325     handleConnect(conn);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 326     conn.disconnect();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 327   }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 328 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 329   /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 330    * 检查长度是否合法，并且检查新获取的文件长度是否和数据库的文件长度一直，如果不一致，则表示该任务为新任务</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 331    *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 332    * @param len 从服务器获取的文件长度</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 333    * @return {@code true}合法</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 334    */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 335   private boolean checkLen(long len) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 336     if (len != mEntity.getFileSize()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 337       ALog.d(TAG, &quot;长度不一致，任务为新任务&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 338       mTaskWrapper.setNewTask(true);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 339     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 340     return true;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 341   }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 342 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 343   private void failDownload(BaseException e, boolean needRetry) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 344     if (onFileInfoCallback != null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 345       onFileInfoCallback.onFail(mEntity, e, needRetry);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 346     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 347   }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 348 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 349   private static class FileLenAdapter implements IHttpFileLenAdapter {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 350 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 351     @Override public long handleFileLen(Map&lt;String, List&lt;String&gt;&gt; headers) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 352       if (headers == null || headers.isEmpty()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 353         ALog.e(TAG, &quot;header为空，获取文件长度失败&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 354         return -1;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 355       }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 356       List&lt;String&gt; sLength = headers.get(&quot;Content-Length&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 357       if (sLength == null || sLength.isEmpty()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 358         return -1;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 359       }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 360       String temp = sLength.get(0);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 361       long len = TextUtils.isEmpty(temp) ? -1 : Long.parseLong(temp);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 362       // 某些服务，如果设置了conn.setRequestProperty(&quot;Range&quot;, &quot;bytes=&quot; + 0 + &quot;-&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 363       // 会返回 Content-Range: bytes 0-225427911/225427913</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 364       if (len &lt; 0) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 365         List&lt;String&gt; sRange = headers.get(&quot;Content-Range&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 366         if (sRange == null || sRange.isEmpty()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 367           len = -1;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 368         } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 369           int start = temp.indexOf(&quot;/&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 370           len = Long.parseLong(temp.substring(start + 1));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 371         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 372       }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 373 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 374       return len;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 375     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 376   }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 377 }</span>
 378 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre><span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   1 -/*</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   2 - * Copyright (C) 2016 AriaLyy(https://github.com/AriaLyy/Aria)</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   3 - *</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   4 - * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   5 - * you may not use this file except in compliance with the License.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   6 - * You may obtain a copy of the License at</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   7 - *</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   8 - *      http://www.apache.org/licenses/LICENSE-2.0</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   9 - *</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  10 - * Unless required by applicable law or agreed to in writing, software</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  11 - * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  12 - * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  13 - * See the License for the specific language governing permissions and</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  14 - * limitations under the License.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  15 - */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  16 -package com.arialyy.aria.http;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  17 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  18 -import android.net.TrafficStats;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  19 -import android.net.Uri;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  20 -import android.os.Process;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  21 -import android.text.TextUtils;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  22 -import com.arialyy.aria.core.AriaConfig;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  23 -import com.arialyy.aria.core.common.CompleteInfo;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  24 -import com.arialyy.aria.core.common.RequestEnum;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  25 -import com.arialyy.aria.core.download.DTaskWrapper;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  26 -import com.arialyy.aria.core.download.DownloadEntity;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  27 -import com.arialyy.aria.core.inf.OnFileInfoCallback;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  28 -import com.arialyy.aria.core.processor.IHttpFileLenAdapter;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  29 -import com.arialyy.aria.exception.AriaIOException;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  30 -import com.arialyy.aria.exception.BaseException;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  31 -import com.arialyy.aria.exception.TaskException;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  32 -import com.arialyy.aria.util.ALog;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  33 -import com.arialyy.aria.util.CheckUtil;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  34 -import com.arialyy.aria.util.CommonUtil;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  35 -import com.arialyy.aria.util.FileUtil;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  36 -import com.arialyy.aria.util.RecordUtil;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  37 -import java.io.BufferedReader;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  38 -import java.io.File;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  39 -import java.io.IOException;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  40 -import java.io.InputStreamReader;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  41 -import java.io.OutputStreamWriter;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  42 -import java.io.UnsupportedEncodingException;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  43 -import java.net.CookieManager;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  44 -import java.net.HttpCookie;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  45 -import java.net.HttpURLConnection;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  46 -import java.net.URL;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  47 -import java.net.URLDecoder;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  48 -import java.net.URLEncoder;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  49 -import java.util.List;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  50 -import java.util.Map;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  51 -import java.util.Set;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  52 -import java.util.UUID;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  53 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  54 -/**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  55 - * 下载文件信息获取</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  56 - */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  57 -public class HttpFileInfoThread implements Runnable {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  58 -  private static final String TAG = &quot;HttpFileInfoThread&quot;;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  59 -  private DownloadEntity mEntity;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  60 -  private DTaskWrapper mTaskWrapper;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  61 -  private int mConnectTimeOut;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  62 -  private OnFileInfoCallback onFileInfoCallback;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  63 -  private HttpTaskOption taskOption;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  64 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  65 -  public HttpFileInfoThread(DTaskWrapper taskWrapper, OnFileInfoCallback callback) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  66 -    this.mTaskWrapper = taskWrapper;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  67 -    mEntity = taskWrapper.getEntity();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  68 -    mConnectTimeOut = AriaConfig.getInstance().getDConfig().getConnectTimeOut();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  69 -    onFileInfoCallback = callback;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  70 -    taskOption = (HttpTaskOption) taskWrapper.getTaskOption();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  71 -  }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  72 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  73 -  @Override public void run() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  74 -    Process.setThreadPriority(Process.THREAD_PRIORITY_BACKGROUND);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  75 -    TrafficStats.setThreadStatsTag(UUID.randomUUID().toString().hashCode());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  76 -    HttpURLConnection conn = null;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  77 -    try {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  78 -      URL url = ConnectionHelp.handleUrl(mEntity.getUrl(), taskOption);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  79 -      conn = ConnectionHelp.handleConnection(url, taskOption);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  80 -      ConnectionHelp.setConnectParam(taskOption, conn);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  81 -      conn.setRequestProperty(&quot;Range&quot;, &quot;bytes=&quot; + 0 + &quot;-&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  82 -      conn.setConnectTimeout(mConnectTimeOut);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  83 -      conn.connect();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  84 -      handleConnect(conn);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  85 -    } catch (IOException e) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  86 -      e.printStackTrace();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  87 -      failDownload(new AriaIOException(TAG,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  88 -              String.format(&quot;下载失败，filePath: %s, url: %s&quot;, mEntity.getDownloadPath(), mEntity.getUrl())),</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  89 -          true);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  90 -    } finally {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  91 -      if (conn != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  92 -        try {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  93 -          conn.getInputStream().close();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  94 -        } catch (IOException e) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  95 -          e.printStackTrace();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  96 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  97 -        conn.disconnect();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  98 -      }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  99 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 100 -  }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 101 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 102 -  private void handleConnect(HttpURLConnection conn) throws IOException {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 103 -    if (taskOption.getRequestEnum() == RequestEnum.POST) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 104 -      Map&lt;String, String&gt; params = taskOption.getParams();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 105 -      if (params != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 106 -        OutputStreamWriter dos = new OutputStreamWriter(conn.getOutputStream());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 107 -        Set&lt;String&gt; keys = params.keySet();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 108 -        StringBuilder sb = new StringBuilder();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 109 -        for (String key : keys) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 110 -          sb.append(key).append(&quot;=&quot;).append(URLEncoder.encode(params.get(key))).append(&quot;&amp;&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 111 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 112 -        String url = sb.toString();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 113 -        url = url.substring(0, url.length() - 1);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 114 -        dos.write(url);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 115 -        dos.flush();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 116 -        dos.close();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 117 -      }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 118 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 119 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 120 -    IHttpFileLenAdapter lenAdapter = taskOption.getFileLenAdapter();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 121 -    if (lenAdapter == null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 122 -      lenAdapter = new FileLenAdapter();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 123 -    } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 124 -      ALog.d(TAG, &quot;使用自定义adapter&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 125 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 126 -    long len = lenAdapter.handleFileLen(conn.getHeaderFields());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 127 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 128 -    if (!FileUtil.checkSDMemorySpace(mEntity.getFilePath(), len)) {</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 129 -      failDownload(new TaskException(TAG,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 130 -          String.format(&quot;下载失败，内存空间不足；filePath: %s, url: %s&quot;, mEntity.getDownloadPath(),</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 131 -              mEntity.getUrl())), false);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 132 -      return;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 133 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 134 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 135 -    int code = conn.getResponseCode();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 136 -    boolean end = false;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 137 -    if (TextUtils.isEmpty(mEntity.getMd5Code())) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 138 -      String md5Code = conn.getHeaderField(&quot;Content-MD5&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 139 -      mEntity.setMd5Code(md5Code);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 140 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 141 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 142 -    boolean isChunked = false;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 143 -    final String str = conn.getHeaderField(&quot;Transfer-Encoding&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 144 -    if (!TextUtils.isEmpty(str) &amp;&amp; str.equals(&quot;chunked&quot;)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 145 -      isChunked = true;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 146 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 147 -    Map&lt;String, List&lt;String&gt;&gt; headers = conn.getHeaderFields();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 148 -    String disposition = conn.getHeaderField(&quot;Content-Disposition&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 149 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 150 -    if (taskOption.isUseServerFileName()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 151 -      if (!TextUtils.isEmpty(disposition)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 152 -        mEntity.setDisposition(CommonUtil.encryptBASE64(disposition));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 153 -        handleContentDisposition(disposition);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 154 -      } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 155 -        ALog.w(TAG, &quot;Content-Disposition对于端字段为空，使用服务器端文件名失败&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 156 -      }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 157 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 158 -    CookieManager msCookieManager = new CookieManager();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 159 -    List&lt;String&gt; cookiesHeader = headers.get(&quot;Set-Cookie&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 160 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 161 -    if (cookiesHeader != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 162 -      for (String cookie : cookiesHeader) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 163 -        msCookieManager.getCookieStore().add(null, HttpCookie.parse(cookie).get(0));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 164 -      }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 165 -      taskOption.setCookieManager(msCookieManager);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 166 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 167 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 168 -    mTaskWrapper.setCode(code);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 169 -    if (code == HttpURLConnection.HTTP_PARTIAL) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 170 -      if (!checkLen(len) &amp;&amp; !isChunked) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 171 -        if (len &lt; 0) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 172 -          failDownload(</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 173 -              new AriaIOException(TAG, String.format(&quot;任务下载失败，文件长度小于0， url: %s&quot;, mEntity.getUrl())),</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 174 -              false);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 175 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 176 -        return;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 177 -      }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 178 -      mEntity.setFileSize(len);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 179 -      mTaskWrapper.setSupportBP(true);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 180 -      end = true;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 181 -    } else if (code == HttpURLConnection.HTTP_OK) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 182 -      String contentType = conn.getHeaderField(&quot;Content-Type&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 183 -      if (TextUtils.isEmpty(contentType)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 184 -        return;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 185 -      }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 186 -      if (contentType.equals(&quot;text/html&quot;)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 187 -        BufferedReader reader =</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 188 -            new BufferedReader(new InputStreamReader(ConnectionHelp.convertInputStream(conn)));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 189 -        StringBuilder sb = new StringBuilder();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 190 -        String line;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 191 -        while ((line = reader.readLine()) != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 192 -          sb.append(line);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 193 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 194 -        reader.close();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 195 -        handleUrlReTurn(conn, CommonUtil.getWindowReplaceUrl(sb.toString()));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 196 -        return;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 197 -      } else if (!checkLen(len) &amp;&amp; !isChunked) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 198 -        if (len &lt; 0) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 199 -          failDownload(</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 200 -              new AriaIOException(TAG, String.format(&quot;任务下载失败，文件长度小于0， url: %s&quot;, mEntity.getUrl())),</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 201 -              false);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 202 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 203 -        ALog.d(TAG, &quot;len &lt; 0&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 204 -        return;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 205 -      }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 206 -      mEntity.setFileSize(len);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 207 -      mTaskWrapper.setNewTask(true);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 208 -      mTaskWrapper.setSupportBP(false);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 209 -      end = true;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 210 -    } else if (code == HttpURLConnection.HTTP_NOT_FOUND) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 211 -      failDownload(new AriaIOException(TAG,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 212 -          String.format(&quot;任务下载失败，errorCode：404, url: %s&quot;, mEntity.getUrl())), true);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 213 -    } else if (code == HttpURLConnection.HTTP_MOVED_TEMP</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 214 -        || code == HttpURLConnection.HTTP_MOVED_PERM</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 215 -        || code == HttpURLConnection.HTTP_SEE_OTHER</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 216 -        || code == HttpURLConnection.HTTP_CREATED // 201 跳转</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 217 -        || code == 307) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 218 -      handleUrlReTurn(conn, conn.getHeaderField(&quot;Location&quot;));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 219 -    } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 220 -      failDownload(new AriaIOException(TAG,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 221 -          String.format(&quot;任务下载失败，errorCode：%s, errorMsg: %s, url: %s&quot;, code,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 222 -              conn.getResponseMessage(), mEntity.getUrl())), !CheckUtil.httpIsBadRequest(code));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 223 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 224 -    if (end) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 225 -      taskOption.setChunked(isChunked);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 226 -      if (onFileInfoCallback != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 227 -        CompleteInfo info = new CompleteInfo(code, mTaskWrapper);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 228 -        onFileInfoCallback.onComplete(mEntity.getUrl(), info);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 229 -      }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 230 -      mEntity.update();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 231 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 232 -  }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 233 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 234 -  /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 235 -   * 处理&quot;Content-Disposition&quot;参数</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 236 -   * &lt;a href=https://cloud.tencent.com/developer/section/1189916&gt;Content-Disposition&lt;/a&gt;&lt;/&gt;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 237 -   *</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 238 -   * @throws UnsupportedEncodingException</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 239 -   */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 240 -  private void handleContentDisposition(String disposition) throws UnsupportedEncodingException {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 241 -    if (disposition.contains(&quot;;&quot;)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 242 -      String[] infos = disposition.split(&quot;;&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 243 -      if (infos[0].equals(&quot;attachment&quot;)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 244 -        for (String info : infos) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 245 -          if (info.startsWith(&quot;filename&quot;) &amp;&amp; info.contains(&quot;=&quot;)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 246 -            String[] temp = info.split(&quot;=&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 247 -            if (temp.length &gt; 1) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 248 -              String newName = URLDecoder.decode(temp[1], &quot;utf-8&quot;).replaceAll(&quot;\&quot;&quot;, &quot;&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 249 -              mEntity.setServerFileName(newName);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 250 -              renameFile(newName);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 251 -              break;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 252 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 253 -          }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 254 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 255 -      } else if (infos[0].equals(&quot;form-data&quot;) &amp;&amp; infos.length &gt; 2) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 256 -        String[] temp = infos[2].split(&quot;=&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 257 -        if (temp.length &gt; 1) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 258 -          String newName = URLDecoder.decode(temp[1], &quot;utf-8&quot;).replaceAll(&quot;\&quot;&quot;, &quot;&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 259 -          mEntity.setServerFileName(newName);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 260 -          renameFile(newName);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 261 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 262 -      } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 263 -        ALog.w(TAG, &quot;不识别的Content-Disposition参数&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 264 -      }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 265 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 266 -  }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 267 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 268 -  /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 269 -   * 重命名文件</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 270 -   */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 271 -  private void renameFile(String newName) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 272 -    if (TextUtils.isEmpty(newName)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 273 -      ALog.w(TAG, &quot;重命名失败【服务器返回的文件名为空】&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 274 -      return;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 275 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 276 -    ALog.d(TAG, String.format(&quot;文件重命名为：%s&quot;, newName));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 277 -    File oldFile = new File(mEntity.getFilePath());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 278 -    String newPath = oldFile.getParent() + &quot;/&quot; + newName;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 279 -    if (oldFile.exists()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 280 -      boolean b = oldFile.renameTo(new File(newPath));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 281 -      ALog.d(TAG, String.format(&quot;文件重命名%s&quot;, b ? &quot;成功&quot; : &quot;失败&quot;));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 282 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 283 -    mEntity.setFileName(newName);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 284 -    mEntity.setFilePath(newPath);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 285 -    RecordUtil.modifyTaskRecord(oldFile.getPath(), newPath, mEntity.getTaskType());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 286 -  }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 287 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 288 -  /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 289 -   * 处理30x跳转</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 290 -   */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 291 -  private void handleUrlReTurn(HttpURLConnection conn, String newUrl) throws IOException {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 292 -    ALog.d(TAG, &quot;30x跳转，新url为【&quot; + newUrl + &quot;】&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 293 -    if (TextUtils.isEmpty(newUrl) || newUrl.equalsIgnoreCase(&quot;null&quot;)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 294 -      if (onFileInfoCallback != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 295 -        onFileInfoCallback.onFail(mEntity, new TaskException(TAG, &quot;获取重定向链接失败&quot;), false);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 296 -      }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 297 -      return;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 298 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 299 -    if (newUrl.startsWith(&quot;/&quot;)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 300 -      Uri uri = Uri.parse(mEntity.getUrl());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 301 -      newUrl = uri.getHost() + newUrl;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 302 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 303 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 304 -    if (!CheckUtil.checkUrl(newUrl)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 305 -      failDownload(new TaskException(TAG, &quot;下载失败，重定向url错误&quot;), false);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 306 -      return;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 307 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 308 -    taskOption.setRedirectUrl(newUrl);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 309 -    mEntity.setRedirect(true);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 310 -    mEntity.setRedirectUrl(newUrl);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 311 -    String cookies = conn.getHeaderField(&quot;Set-Cookie&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 312 -    conn.disconnect();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 313 -    URL url = ConnectionHelp.handleUrl(newUrl, taskOption);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 314 -    conn = ConnectionHelp.handleConnection(url, taskOption);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 315 -    ConnectionHelp.setConnectParam(taskOption, conn);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 316 -    conn.setRequestProperty(&quot;Cookie&quot;, cookies);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 317 -    conn.setRequestProperty(&quot;Range&quot;, &quot;bytes=&quot; + 0 + &quot;-&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 318 -    conn.setConnectTimeout(mConnectTimeOut);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 319 -    conn.connect();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 320 -    handleConnect(conn);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 321 -    conn.disconnect();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 322 -  }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 323 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 324 -  /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 325 -   * 检查长度是否合法，并且检查新获取的文件长度是否和数据库的文件长度一直，如果不一致，则表示该任务为新任务</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 326 -   *</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 327 -   * @param len 从服务器获取的文件长度</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 328 -   * @return {@code true}合法</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 329 -   */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 330 -  private boolean checkLen(long len) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 331 -    if (len != mEntity.getFileSize()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 332 -      ALog.d(TAG, &quot;长度不一致，任务为新任务&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 333 -      mTaskWrapper.setNewTask(true);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 334 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 335 -    return true;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 336 -  }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 337 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 338 -  private void failDownload(BaseException e, boolean needRetry) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 339 -    if (onFileInfoCallback != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 340 -      onFileInfoCallback.onFail(mEntity, e, needRetry);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 341 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 342 -  }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 343 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 344 -  private static class FileLenAdapter implements IHttpFileLenAdapter {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 345 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 346 -    @Override public long handleFileLen(Map&lt;String, List&lt;String&gt;&gt; headers) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 347 -      if (headers == null || headers.isEmpty()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 348 -        ALog.e(TAG, &quot;header为空，获取文件长度失败&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 349 -        return -1;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 350 -      }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 351 -      List&lt;String&gt; sLength = headers.get(&quot;Content-Length&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 352 -      if (sLength == null || sLength.isEmpty()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 353 -        return -1;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 354 -      }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 355 -      String temp = sLength.get(0);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 356 -      long len = TextUtils.isEmpty(temp) ? -1 : Long.parseLong(temp);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 357 -      // 某些服务，如果设置了conn.setRequestProperty(&quot;Range&quot;, &quot;bytes=&quot; + 0 + &quot;-&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 358 -      // 会返回 Content-Range: bytes 0-225427911/225427913</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 359 -      if (len &lt; 0) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 360 -        List&lt;String&gt; sRange = headers.get(&quot;Content-Range&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 361 -        if (sRange == null || sRange.isEmpty()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 362 -          len = -1;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 363 -        } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 364 -          int start = temp.indexOf(&quot;/&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 365 -          len = Long.parseLong(temp.substring(start + 1));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 366 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 367 -      }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 368 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 369 -      return len;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 370 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 371 -  }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 372 -}</span></pre></td>
                            <td><pre>   1  /*
   2   * Copyright (C) 2016 AriaLyy(https://github.com/AriaLyy/Aria)
   3   *
   4   * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
   5   * you may not use this file except in compliance with the License.
   6   * You may obtain a copy of the License at
   7   *
   8   *      http://www.apache.org/licenses/LICENSE-2.0
   9   *
  10   * Unless required by applicable law or agreed to in writing, software
  11   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  12   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  13   * See the License for the specific language governing permissions and
  14   * limitations under the License.
  15   */
  16  package com.arialyy.aria.http;
  17  
  18  import android.net.TrafficStats;
  19  import android.net.Uri;
  20  import android.os.Process;
  21  import android.text.TextUtils;
  22  import com.arialyy.aria.core.AriaConfig;
  23  import com.arialyy.aria.core.common.CompleteInfo;
  24  import com.arialyy.aria.core.common.RequestEnum;
  25  import com.arialyy.aria.core.download.DTaskWrapper;
  26  import com.arialyy.aria.core.download.DownloadEntity;
  27  import com.arialyy.aria.core.inf.OnFileInfoCallback;
  28  import com.arialyy.aria.core.processor.IHttpFileLenAdapter;
  29  import com.arialyy.aria.exception.AriaIOException;
  30  import com.arialyy.aria.exception.BaseException;
  31  import com.arialyy.aria.exception.TaskException;
  32  import com.arialyy.aria.util.ALog;
  33  import com.arialyy.aria.util.CheckUtil;
  34  import com.arialyy.aria.util.CommonUtil;
  35  import com.arialyy.aria.util.FileUtil;
  36  import com.arialyy.aria.util.RecordUtil;
  37  import java.io.BufferedReader;
  38  import java.io.File;
  39  import java.io.IOException;
  40  import java.io.InputStreamReader;
  41  import java.io.OutputStreamWriter;
  42  import java.io.UnsupportedEncodingException;
  43  import java.net.CookieManager;
  44  import java.net.HttpCookie;
  45  import java.net.HttpURLConnection;
  46  import java.net.URL;
  47  import java.net.URLDecoder;
  48  import java.net.URLEncoder;
  49  import java.util.List;
  50  import java.util.Map;
  51  import java.util.Set;
  52  import java.util.UUID;
  53  
  54  /**
  55   * 下载文件信息获取
  56   */
  57  public class HttpFileInfoThread implements Runnable {
  58    private static final String TAG = &quot;HttpFileInfoThread&quot;;
  59    private DownloadEntity mEntity;
  60    private DTaskWrapper mTaskWrapper;
  61    private int mConnectTimeOut;
  62    private OnFileInfoCallback onFileInfoCallback;
  63    private HttpTaskOption taskOption;
  64  
  65    public HttpFileInfoThread(DTaskWrapper taskWrapper, OnFileInfoCallback callback) {
  66      this.mTaskWrapper = taskWrapper;
  67      mEntity = taskWrapper.getEntity();
  68      mConnectTimeOut = AriaConfig.getInstance().getDConfig().getConnectTimeOut();
  69      onFileInfoCallback = callback;
  70      taskOption = (HttpTaskOption) taskWrapper.getTaskOption();
  71    }
  72  
  73    @Override public void run() {
  74      Process.setThreadPriority(Process.THREAD_PRIORITY_BACKGROUND);
  75      TrafficStats.setThreadStatsTag(UUID.randomUUID().toString().hashCode());
  76      HttpURLConnection conn = null;
  77      try {
  78        URL url = ConnectionHelp.handleUrl(mEntity.getUrl(), taskOption);
  79        conn = ConnectionHelp.handleConnection(url, taskOption);
  80        ConnectionHelp.setConnectParam(taskOption, conn);
  81        conn.setRequestProperty(&quot;Range&quot;, &quot;bytes=&quot; + 0 + &quot;-&quot;);
  82        conn.setConnectTimeout(mConnectTimeOut);
  83        conn.connect();
  84        handleConnect(conn);
  85      } catch (IOException e) {
  86        e.printStackTrace();
  87        failDownload(new AriaIOException(TAG,
  88                String.format(&quot;下载失败，filePath: %s, url: %s&quot;, mEntity.getDownloadPath(), mEntity.getUrl())),
  89            true);
  90      } finally {
  91        if (conn != null) {
  92          try {
  93            conn.getInputStream().close();
  94          } catch (IOException e) {
  95            e.printStackTrace();
  96          }
  97          conn.disconnect();
  98        }
  99      }
 100    }
 101  
 102    private void handleConnect(HttpURLConnection conn) throws IOException {
 103      if (taskOption.getRequestEnum() == RequestEnum.POST) {
 104        Map&lt;String, String&gt; params = taskOption.getParams();
 105        if (params != null) {
 106          OutputStreamWriter dos = new OutputStreamWriter(conn.getOutputStream());
 107          Set&lt;String&gt; keys = params.keySet();
 108          StringBuilder sb = new StringBuilder();
 109          for (String key : keys) {
 110            sb.append(key).append(&quot;=&quot;).append(URLEncoder.encode(params.get(key))).append(&quot;&amp;&quot;);
 111          }
 112          String url = sb.toString();
 113          url = url.substring(0, url.length() - 1);
 114          dos.write(url);
 115          dos.flush();
 116          dos.close();
 117        }
 118      }
 119  
 120      IHttpFileLenAdapter lenAdapter = taskOption.getFileLenAdapter();
 121      if (lenAdapter == null) {
 122        lenAdapter = new FileLenAdapter();
 123      } else {
 124        ALog.d(TAG, &quot;使用自定义adapter&quot;);
 125      }
 126      long len = lenAdapter.handleFileLen(conn.getHeaderFields());
 127  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 128 -    if (!FileUtil.checkSDMemorySpace(mEntity.getFilePath(), len)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 129 +    if (!FileUtil.checkMemorySpace(mEntity.getFilePath(), len)) {</span>
 130        failDownload(new TaskException(TAG,
 131            String.format(&quot;下载失败，内存空间不足；filePath: %s, url: %s&quot;, mEntity.getDownloadPath(),
 132                mEntity.getUrl())), false);
 133        return;
 134      }
 135  
 136      int code = conn.getResponseCode();
 137      boolean end = false;
 138      if (TextUtils.isEmpty(mEntity.getMd5Code())) {
 139        String md5Code = conn.getHeaderField(&quot;Content-MD5&quot;);
 140        mEntity.setMd5Code(md5Code);
 141      }
 142  
 143      boolean isChunked = false;
 144      final String str = conn.getHeaderField(&quot;Transfer-Encoding&quot;);
 145      if (!TextUtils.isEmpty(str) &amp;&amp; str.equals(&quot;chunked&quot;)) {
 146        isChunked = true;
 147      }
 148      Map&lt;String, List&lt;String&gt;&gt; headers = conn.getHeaderFields();
 149      String disposition = conn.getHeaderField(&quot;Content-Disposition&quot;);
 150  
 151      if (taskOption.isUseServerFileName()) {
 152        if (!TextUtils.isEmpty(disposition)) {
 153          mEntity.setDisposition(CommonUtil.encryptBASE64(disposition));
 154          handleContentDisposition(disposition);
 155        } else {
 156          ALog.w(TAG, &quot;Content-Disposition对于端字段为空，使用服务器端文件名失败&quot;);
 157        }
 158      }
 159      CookieManager msCookieManager = new CookieManager();
 160      List&lt;String&gt; cookiesHeader = headers.get(&quot;Set-Cookie&quot;);
 161  
 162      if (cookiesHeader != null) {
 163        for (String cookie : cookiesHeader) {
 164          msCookieManager.getCookieStore().add(null, HttpCookie.parse(cookie).get(0));
 165        }
 166        taskOption.setCookieManager(msCookieManager);
 167      }
 168  
 169      mTaskWrapper.setCode(code);
 170      if (code == HttpURLConnection.HTTP_PARTIAL) {
 171        if (!checkLen(len) &amp;&amp; !isChunked) {
 172          if (len &lt; 0) {
 173            failDownload(
 174                new AriaIOException(TAG, String.format(&quot;任务下载失败，文件长度小于0， url: %s&quot;, mEntity.getUrl())),
 175                false);
 176          }
 177          return;
 178        }
 179        mEntity.setFileSize(len);
 180        mTaskWrapper.setSupportBP(true);
 181        end = true;
 182      } else if (code == HttpURLConnection.HTTP_OK) {
 183        String contentType = conn.getHeaderField(&quot;Content-Type&quot;);
 184        if (TextUtils.isEmpty(contentType)) {
 185          return;
 186        }
 187        if (contentType.equals(&quot;text/html&quot;)) {
 188          BufferedReader reader =
 189              new BufferedReader(new InputStreamReader(ConnectionHelp.convertInputStream(conn)));
 190          StringBuilder sb = new StringBuilder();
 191          String line;
 192          while ((line = reader.readLine()) != null) {
 193            sb.append(line);
 194          }
 195          reader.close();
 196          handleUrlReTurn(conn, CommonUtil.getWindowReplaceUrl(sb.toString()));
 197          return;
 198        } else if (!checkLen(len) &amp;&amp; !isChunked) {
 199          if (len &lt; 0) {
 200            failDownload(
 201                new AriaIOException(TAG, String.format(&quot;任务下载失败，文件长度小于0， url: %s&quot;, mEntity.getUrl())),
 202                false);
 203          }
 204          ALog.d(TAG, &quot;len &lt; 0&quot;);
 205          return;
 206        }
 207        mEntity.setFileSize(len);
 208        mTaskWrapper.setNewTask(true);
 209        mTaskWrapper.setSupportBP(false);
 210        end = true;
 211      } else if (code == HttpURLConnection.HTTP_NOT_FOUND) {
 212        failDownload(new AriaIOException(TAG,
 213            String.format(&quot;任务下载失败，errorCode：404, url: %s&quot;, mEntity.getUrl())), true);
 214      } else if (code == HttpURLConnection.HTTP_MOVED_TEMP
 215          || code == HttpURLConnection.HTTP_MOVED_PERM
 216          || code == HttpURLConnection.HTTP_SEE_OTHER
 217          || code == HttpURLConnection.HTTP_CREATED // 201 跳转
 218          || code == 307) {
 219        handleUrlReTurn(conn, conn.getHeaderField(&quot;Location&quot;));
 220      } else {
 221        failDownload(new AriaIOException(TAG,
 222            String.format(&quot;任务下载失败，errorCode：%s, errorMsg: %s, url: %s&quot;, code,
 223                conn.getResponseMessage(), mEntity.getUrl())), !CheckUtil.httpIsBadRequest(code));
 224      }
 225      if (end) {
 226        taskOption.setChunked(isChunked);
 227        if (onFileInfoCallback != null) {
 228          CompleteInfo info = new CompleteInfo(code, mTaskWrapper);
 229          onFileInfoCallback.onComplete(mEntity.getUrl(), info);
 230        }
 231        mEntity.update();
 232      }
 233    }
 234  
 235    /**
 236     * 处理&quot;Content-Disposition&quot;参数
 237     * &lt;a href=https://cloud.tencent.com/developer/section/1189916&gt;Content-Disposition&lt;/a&gt;&lt;/&gt;
 238     *
 239     * @throws UnsupportedEncodingException
 240     */
 241    private void handleContentDisposition(String disposition) throws UnsupportedEncodingException {
 242      if (disposition.contains(&quot;;&quot;)) {
 243        String[] infos = disposition.split(&quot;;&quot;);
 244        if (infos[0].equals(&quot;attachment&quot;)) {
 245          for (String info : infos) {
 246            if (info.startsWith(&quot;filename&quot;) &amp;&amp; info.contains(&quot;=&quot;)) {
 247              String[] temp = info.split(&quot;=&quot;);
 248              if (temp.length &gt; 1) {
 249                String newName = URLDecoder.decode(temp[1], &quot;utf-8&quot;).replaceAll(&quot;\&quot;&quot;, &quot;&quot;);
 250                mEntity.setServerFileName(newName);
 251                renameFile(newName);
 252                break;
 253              }
 254            }
 255          }
 256        } else if (infos[0].equals(&quot;form-data&quot;) &amp;&amp; infos.length &gt; 2) {
 257          String[] temp = infos[2].split(&quot;=&quot;);
 258          if (temp.length &gt; 1) {
 259            String newName = URLDecoder.decode(temp[1], &quot;utf-8&quot;).replaceAll(&quot;\&quot;&quot;, &quot;&quot;);
 260            mEntity.setServerFileName(newName);
 261            renameFile(newName);
 262          }
 263        } else {
 264          ALog.w(TAG, &quot;不识别的Content-Disposition参数&quot;);
 265        }
 266      }
 267    }
 268  
 269    /**
 270     * 重命名文件
 271     */
 272    private void renameFile(String newName) {
 273      if (TextUtils.isEmpty(newName)) {
 274        ALog.w(TAG, &quot;重命名失败【服务器返回的文件名为空】&quot;);
 275        return;
 276      }
 277      ALog.d(TAG, String.format(&quot;文件重命名为：%s&quot;, newName));
 278      File oldFile = new File(mEntity.getFilePath());
 279      String newPath = oldFile.getParent() + &quot;/&quot; + newName;
 280      if (oldFile.exists()) {
 281        boolean b = oldFile.renameTo(new File(newPath));
 282        ALog.d(TAG, String.format(&quot;文件重命名%s&quot;, b ? &quot;成功&quot; : &quot;失败&quot;));
 283      }
 284      mEntity.setFileName(newName);
 285      mEntity.setFilePath(newPath);
 286      RecordUtil.modifyTaskRecord(oldFile.getPath(), newPath, mEntity.getTaskType());
 287    }
 288  
 289    /**
 290     * 处理30x跳转
 291     */
 292    private void handleUrlReTurn(HttpURLConnection conn, String newUrl) throws IOException {
 293      ALog.d(TAG, &quot;30x跳转，新url为【&quot; + newUrl + &quot;】&quot;);
 294      if (TextUtils.isEmpty(newUrl) || newUrl.equalsIgnoreCase(&quot;null&quot;)) {
 295        if (onFileInfoCallback != null) {
 296          onFileInfoCallback.onFail(mEntity, new TaskException(TAG, &quot;获取重定向链接失败&quot;), false);
 297        }
 298        return;
 299      }
 300      if (newUrl.startsWith(&quot;/&quot;)) {
 301        Uri uri = Uri.parse(mEntity.getUrl());
 302        newUrl = uri.getHost() + newUrl;
 303      }
 304  
 305      if (!CheckUtil.checkUrl(newUrl)) {
 306        failDownload(new TaskException(TAG, &quot;下载失败，重定向url错误&quot;), false);
 307        return;
 308      }
 309      taskOption.setRedirectUrl(newUrl);
 310      mEntity.setRedirect(true);
 311      mEntity.setRedirectUrl(newUrl);
 312      String cookies = conn.getHeaderField(&quot;Set-Cookie&quot;);
 313      conn.disconnect();
 314      URL url = ConnectionHelp.handleUrl(newUrl, taskOption);
 315      conn = ConnectionHelp.handleConnection(url, taskOption);
 316      ConnectionHelp.setConnectParam(taskOption, conn);
 317      conn.setRequestProperty(&quot;Cookie&quot;, cookies);
 318      conn.setRequestProperty(&quot;Range&quot;, &quot;bytes=&quot; + 0 + &quot;-&quot;);
 319      conn.setConnectTimeout(mConnectTimeOut);
 320      conn.connect();
 321      handleConnect(conn);
 322      conn.disconnect();
 323    }
 324  
 325    /**
 326     * 检查长度是否合法，并且检查新获取的文件长度是否和数据库的文件长度一直，如果不一致，则表示该任务为新任务
 327     *
 328     * @param len 从服务器获取的文件长度
 329     * @return {@code true}合法
 330     */
 331    private boolean checkLen(long len) {
 332      if (len != mEntity.getFileSize()) {
 333        ALog.d(TAG, &quot;长度不一致，任务为新任务&quot;);
 334        mTaskWrapper.setNewTask(true);
 335      }
 336      return true;
 337    }
 338  
 339    private void failDownload(BaseException e, boolean needRetry) {
 340      if (onFileInfoCallback != null) {
 341        onFileInfoCallback.onFail(mEntity, e, needRetry);
 342      }
 343    }
 344  
 345    private static class FileLenAdapter implements IHttpFileLenAdapter {
 346  
 347      @Override public long handleFileLen(Map&lt;String, List&lt;String&gt;&gt; headers) {
 348        if (headers == null || headers.isEmpty()) {
 349          ALog.e(TAG, &quot;header为空，获取文件长度失败&quot;);
 350          return -1;
 351        }
 352        List&lt;String&gt; sLength = headers.get(&quot;Content-Length&quot;);
 353        if (sLength == null || sLength.isEmpty()) {
 354          return -1;
 355        }
 356        String temp = sLength.get(0);
 357        long len = TextUtils.isEmpty(temp) ? -1 : Long.parseLong(temp);
 358        // 某些服务，如果设置了conn.setRequestProperty(&quot;Range&quot;, &quot;bytes=&quot; + 0 + &quot;-&quot;);
 359        // 会返回 Content-Range: bytes 0-225427911/225427913
 360        if (len &lt; 0) {
 361          List&lt;String&gt; sRange = headers.get(&quot;Content-Range&quot;);
 362          if (sRange == null || sRange.isEmpty()) {
 363            len = -1;
 364          } else {
 365            int start = temp.indexOf(&quot;/&quot;);
 366            len = Long.parseLong(temp.substring(start + 1));
 367          }
 368        }
 369  
 370        return len;
 371      }
 372    }
 373  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            