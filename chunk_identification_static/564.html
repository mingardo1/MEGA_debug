<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>564</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    564
                    <a href="563.html">prev</a>
                    <a href="565.html">next</a>
                    <a href="564_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    DTStack/flinkStreamSQL_7302b163e73618ae14d90bd0ad9b64f1caf7c884_launcher/src/main/java/com/dtstack/flink/sql/launcher/ClusterClientFactory.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;7302b163e73618ae14d90bd0ad9b64f1caf7c884:launcher/src/main/java/com/dtstack/flink/sql/launcher/ClusterClientFactory.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;7302b163e73618ae14d90bd0ad9b64f1caf7c884^1:launcher/src/main/java/com/dtstack/flink/sql/launcher/ClusterClientFactory.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;7302b163e73618ae14d90bd0ad9b64f1caf7c884^2:launcher/src/main/java/com/dtstack/flink/sql/launcher/ClusterClientFactory.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;b259aa5e9ca64e4d07266783ec504a1f5fd6d5ec:launcher/src/main/java/com/dtstack/flink/sql/launcher/ClusterClientFactory.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[sbj]], subset: [[sbj]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
   2 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   3 /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   4  * Licensed to the Apache Software Foundation (ASF) under one</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   5  * or more contributor license agreements.  See the NOTICE file</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   6  * distributed with this work for additional information</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   7  * regarding copyright ownership.  The ASF licenses this file</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   8  * to you under the Apache License, Version 2.0 (the</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   9  * &quot;License&quot;); you may not use this file except in compliance</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  10  * with the License.  You may obtain a copy of the License at</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  11  *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  12  * http://www.apache.org/licenses/LICENSE-2.0</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  13  *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  14  * Unless required by applicable law or agreed to in writing, software</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  15  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  16  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  17  * See the License for the specific language governing permissions and</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  18  * limitations under the License.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  19  */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  20 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  21 package com.dtstack.flink.sql.launcher;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  22 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  23 import com.dtstack.flink.sql.enums.ClusterMode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  24 import com.dtstack.flink.sql.option.Options;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  25 import com.dtstack.flink.sql.util.PluginUtil;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  26 import org.apache.commons.io.Charsets;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  27 import org.apache.commons.lang.StringUtils;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  28 import org.apache.flink.client.program.ClusterClient;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  29 import org.apache.flink.client.program.MiniClusterClient;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  30 import org.apache.flink.configuration.ConfigConstants;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  31 import org.apache.flink.configuration.Configuration;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  32 import org.apache.flink.configuration.GlobalConfiguration;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  33 import org.apache.flink.configuration.JobManagerOptions;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  34 import org.apache.flink.core.fs.FileSystem;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  35 import org.apache.flink.runtime.akka.AkkaUtils;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  36 import org.apache.flink.runtime.minicluster.MiniCluster;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  37 import org.apache.flink.runtime.minicluster.MiniClusterConfiguration;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  38 import org.apache.flink.runtime.util.LeaderConnectionInfo;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  39 import org.apache.flink.yarn.AbstractYarnClusterDescriptor;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  40 import org.apache.flink.yarn.YarnClusterDescriptor;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  41 import org.apache.hadoop.yarn.api.records.ApplicationId;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  42 import org.apache.hadoop.yarn.api.records.ApplicationReport;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  43 import org.apache.hadoop.yarn.api.records.YarnApplicationState;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  44 import org.apache.hadoop.yarn.client.api.YarnClient;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  45 import org.apache.hadoop.yarn.conf.YarnConfiguration;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  46 import org.apache.hadoop.yarn.util.StringHelper;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  47 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  48 import java.net.InetSocketAddress;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  49 import java.net.URLDecoder;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  50 import java.util.EnumSet;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  51 import java.util.HashSet;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  52 import java.util.Iterator;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  53 import java.util.List;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  54 import java.util.Properties;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  55 import java.util.Set;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  56 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  57 /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  58  * @author sishu.yss</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  59  */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  60 public class ClusterClientFactory {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  61 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  62     public static ClusterClient createClusterClient(Options launcherOptions) throws Exception {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  63         String mode = launcherOptions.getMode();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  64         if (mode.equals(ClusterMode.standalone.name())) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  65             return createStandaloneClient(launcherOptions);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  66         } else if (mode.equals(ClusterMode.yarn.name())) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  67             return createYarnSessionClient(launcherOptions);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  68         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  69         throw new IllegalArgumentException(&quot;Unsupported cluster client type: &quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  70     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  71 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  72     public static ClusterClient createStandaloneClient(Options launcherOptions) throws Exception {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  73         String flinkConfDir = launcherOptions.getFlinkconf();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  74         Configuration config = GlobalConfiguration.loadConfiguration(flinkConfDir);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  75         MiniClusterConfiguration.Builder configBuilder = new MiniClusterConfiguration.Builder();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  76         configBuilder.setConfiguration(config);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  77         MiniCluster miniCluster = new MiniCluster(configBuilder.build());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  78         MiniClusterClient clusterClient = new MiniClusterClient(config, miniCluster);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  79         LeaderConnectionInfo connectionInfo = clusterClient.getClusterConnectionInfo();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="  80         InetSocketAddress address = AkkaUtils.getInetSocketAddressFromAkkaURL(connectionInfo.getAddress());">  80         InetSocketAddress address = AkkaUtils.getInetSocketAddressFromAkkaURL(connectionInfo.getAddress()ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  81         config.setString(JobManagerOptions.ADDRESS, address.getAddress().getHostName());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  82         config.setInteger(JobManagerOptions.PORT, address.getPort());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  83         clusterClient.setDetached(true);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  84         return clusterClient;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  85     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  86 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  87     public static ClusterClient createYarnSessionClient(Options launcherOptions) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="  88         String flinkConfDir = StringUtils.isEmpty(launcherOptions.getFlinkconf()) ? &quot;&quot; : launcherOptions.getFlinkconf();">  88         String flinkConfDir = StringUtils.isEmpty(launcherOptions.getFlinkconf()) ? &quot;&quot; : launcherOptions.ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="  89         Configuration config = StringUtils.isEmpty(flinkConfDir) ? new Configuration() : GlobalConfiguration.loadConfiguration(flinkConfDir);">  89         Configuration config = StringUtils.isEmpty(flinkConfDir) ? new Configuration() : GlobalConfiguratðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  90         String yarnConfDir = launcherOptions.getYarnconf();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  91 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  92         if (StringUtils.isNotBlank(yarnConfDir)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  93             try {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  94                 config.setString(ConfigConstants.PATH_HADOOP_CONFIG, yarnConfDir);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  95                 FileSystem.initialize(config, null);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  96 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  97                 YarnConfiguration yarnConf = YarnConfLoader.getYarnConf(yarnConfDir);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  98                 YarnClient yarnClient = YarnClient.createYarnClient();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  99                 yarnClient.init(yarnConf);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 100                 yarnClient.start();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 101                 ApplicationId applicationId = null;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 102 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 103                 String yarnSessionConf = launcherOptions.getYarnSessionConf();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 104                 yarnSessionConf = URLDecoder.decode(yarnSessionConf, Charsets.UTF_8.toString());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 105                 Properties yarnSessionConfProperties = PluginUtil.jsonStrToObject(yarnSessionConf, Properties.class);"> 105                 Properties yarnSessionConfProperties = PluginUtil.jsonStrToObject(yarnSessionConf, ProperðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 106                 Object yid = yarnSessionConfProperties.get(&quot;yid&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 107 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 108                 if (null != yid) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 109                     applicationId = toApplicationId(yid.toString());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 110                 } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 111                     applicationId = getYarnClusterApplicationId(yarnClient);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 112                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 113 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 114                 System.out.println(&quot;applicationId=&quot; + applicationId.toString());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 115 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 116                 if (StringUtils.isEmpty(applicationId.toString())) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 117                     throw new RuntimeException(&quot;No flink session found on yarn cluster.&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 118                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 119 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 120                 AbstractYarnClusterDescriptor clusterDescriptor = new YarnClusterDescriptor(config, yarnConf, flinkConfDir, yarnClient, false);"> 120                 AbstractYarnClusterDescriptor clusterDescriptor = new YarnClusterDescriptor(config, yarnCðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 121                 ClusterClient clusterClient = clusterDescriptor.retrieve(applicationId);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 122                 clusterClient.setDetached(true);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 123                 return clusterClient;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 124             } catch (Exception e) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 125                 throw new RuntimeException(e);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 126             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 127         }else{</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 128             throw new RuntimeException(&quot;yarn mode must set param of &#x27;yarnconf&#x27;!!!&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 129         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 130     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 131 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 132 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 133     private static ApplicationId getYarnClusterApplicationId(YarnClient yarnClient) throws Exception {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 134         ApplicationId applicationId = null;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 135 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 136         Set&lt;String&gt; set = new HashSet&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 137         set.add(&quot;Apache Flink&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 138         EnumSet&lt;YarnApplicationState&gt; enumSet = EnumSet.noneOf(YarnApplicationState.class);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 139         enumSet.add(YarnApplicationState.RUNNING);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 140         List&lt;ApplicationReport&gt; reportList = yarnClient.getApplications(set, enumSet);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 141 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 142         int maxMemory = -1;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 143         int maxCores = -1;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 144         for (ApplicationReport report : reportList) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 145             if (!report.getName().startsWith(&quot;Flink session&quot;)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 146                 continue;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 147             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 148 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 149             if (!report.getYarnApplicationState().equals(YarnApplicationState.RUNNING)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 150                 continue;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 151             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 152 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 153             int thisMemory = report.getApplicationResourceUsageReport().getNeededResources().getMemory();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 154             int thisCores = report.getApplicationResourceUsageReport().getNeededResources().getVirtualCores();"> 154             int thisCores = report.getApplicationResourceUsageReport().getNeededResources().getVirtualCorðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 155             if (thisMemory &gt; maxMemory || thisMemory == maxMemory &amp;&amp; thisCores &gt; maxCores) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 156                 maxMemory = thisMemory;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 157                 maxCores = thisCores;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 158                 applicationId = report.getApplicationId();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 159             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 160 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 161         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 162 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 163         if (StringUtils.isEmpty(applicationId.toString())) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 164             throw new RuntimeException(&quot;No flink session found on yarn cluster.&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 165         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 166         return applicationId;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 167     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 168 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 169     private static ApplicationId toApplicationId(String appIdStr) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 170         Iterator&lt;String&gt; it = StringHelper._split(appIdStr).iterator();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 171         if (!(it.next()).equals(&quot;application&quot;)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 172             throw new IllegalArgumentException(&quot;Invalid ApplicationId prefix: &quot; + appIdStr + &quot;. The valid ApplicationId should start with prefix &quot; + &quot;application&quot;);"> 172             throw new IllegalArgumentException(&quot;Invalid ApplicationId prefix: &quot; + appIdStr + &quot;. The validðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 173         } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 174             try {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 175                 return toApplicationId(it);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 176             } catch (NumberFormatException e) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 177                 throw new IllegalArgumentException(&quot;Invalid AppAttemptId: &quot; + appIdStr, e);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 178             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 179         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 180     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 181 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 182     private static ApplicationId toApplicationId(Iterator&lt;String&gt; it) throws NumberFormatException {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 183         return ApplicationId.newInstance(Long.parseLong(it.next()), Integer.parseInt(it.next()));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 184     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 185 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 186 }</span>
 187 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 188 /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 189  * Licensed to the Apache Software Foundation (ASF) under one</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 190  * or more contributor license agreements.  See the NOTICE file</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 191  * distributed with this work for additional information</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 192  * regarding copyright ownership.  The ASF licenses this file</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 193  * to you under the Apache License, Version 2.0 (the</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 194  * &quot;License&quot;); you may not use this file except in compliance</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 195  * with the License.  You may obtain a copy of the License at</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 196  *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 197  * http://www.apache.org/licenses/LICENSE-2.0</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 198  *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 199  * Unless required by applicable law or agreed to in writing, software</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 200  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 201  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 202  * See the License for the specific language governing permissions and</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 203  * limitations under the License.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 204  */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 205 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 206 package com.dtstack.flink.sql.launcher;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 207 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 208 import com.dtstack.flink.sql.enums.ClusterMode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 209 import com.dtstack.flink.sql.option.Options;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 210 import com.dtstack.flink.sql.util.PluginUtil;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 211 import com.esotericsoftware.minlog.Log;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 212 import org.apache.commons.io.Charsets;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 213 import org.apache.commons.lang.StringUtils;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 214 import org.apache.flink.client.program.ClusterClient;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 215 import org.apache.flink.client.program.MiniClusterClient;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 216 import org.apache.flink.configuration.ConfigConstants;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 217 import org.apache.flink.configuration.Configuration;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 218 import org.apache.flink.configuration.GlobalConfiguration;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 219 import org.apache.flink.configuration.JobManagerOptions;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 220 import org.apache.flink.core.fs.FileSystem;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 221 import org.apache.flink.runtime.akka.AkkaUtils;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 222 import org.apache.flink.runtime.minicluster.MiniCluster;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 223 import org.apache.flink.runtime.minicluster.MiniClusterConfiguration;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 224 import org.apache.flink.runtime.util.LeaderConnectionInfo;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 225 import org.apache.flink.yarn.AbstractYarnClusterDescriptor;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 226 import org.apache.flink.yarn.YarnClusterDescriptor;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 227 import org.apache.hadoop.yarn.api.records.ApplicationId;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 228 import org.apache.hadoop.yarn.api.records.ApplicationReport;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 229 import org.apache.hadoop.yarn.api.records.YarnApplicationState;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 230 import org.apache.hadoop.yarn.client.api.YarnClient;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 231 import org.apache.hadoop.yarn.conf.YarnConfiguration;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 232 import org.apache.hadoop.yarn.util.StringHelper;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 233 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 234 import java.net.InetSocketAddress;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 235 import java.net.URLDecoder;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 236 import java.util.EnumSet;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 237 import java.util.HashSet;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 238 import java.util.Iterator;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 239 import java.util.List;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 240 import java.util.Properties;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 241 import java.util.Set;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 242 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 243 /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 244  * @author sishu.yss</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 245  */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 246 public class ClusterClientFactory {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 247 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 248     public static ClusterClient createClusterClient(Options launcherOptions) throws Exception {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 249         String mode = launcherOptions.getMode();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 250         if (mode.equals(ClusterMode.standalone.name())) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 251             return createStandaloneClient(launcherOptions);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 252         } else if (mode.equals(ClusterMode.yarn.name())) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 253             return createYarnSessionClient(launcherOptions);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 254         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 255         throw new IllegalArgumentException(&quot;Unsupported cluster client type: &quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 256     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 257 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 258     public static ClusterClient createStandaloneClient(Options launcherOptions) throws Exception {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 259         String flinkConfDir = launcherOptions.getFlinkconf();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 260         Configuration config = GlobalConfiguration.loadConfiguration(flinkConfDir);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 261         MiniClusterConfiguration.Builder configBuilder = new MiniClusterConfiguration.Builder();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 262         configBuilder.setConfiguration(config);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 263         MiniCluster miniCluster = new MiniCluster(configBuilder.build());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 264         MiniClusterClient clusterClient = new MiniClusterClient(config, miniCluster);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 265         LeaderConnectionInfo connectionInfo = clusterClient.getClusterConnectionInfo();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 266         InetSocketAddress address = AkkaUtils.getInetSocketAddressFromAkkaURL(connectionInfo.getAddress());"> 266         InetSocketAddress address = AkkaUtils.getInetSocketAddressFromAkkaURL(connectionInfo.getAddress()ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 267         config.setString(JobManagerOptions.ADDRESS, address.getAddress().getHostName());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 268         config.setInteger(JobManagerOptions.PORT, address.getPort());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 269         clusterClient.setDetached(true);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 270         return clusterClient;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 271     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 272 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 273     public static ClusterClient createYarnSessionClient(Options launcherOptions) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 274         String flinkConfDir = StringUtils.isEmpty(launcherOptions.getFlinkconf()) ? &quot;&quot; : launcherOptions.getFlinkconf();"> 274         String flinkConfDir = StringUtils.isEmpty(launcherOptions.getFlinkconf()) ? &quot;&quot; : launcherOptions.ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 275         Configuration config = StringUtils.isEmpty(flinkConfDir) ? new Configuration() : GlobalConfiguration.loadConfiguration(flinkConfDir);"> 275         Configuration config = StringUtils.isEmpty(flinkConfDir) ? new Configuration() : GlobalConfiguratðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 276         String yarnConfDir = launcherOptions.getYarnconf();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 277 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 278         if (StringUtils.isNotBlank(yarnConfDir)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 279             try {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 280                 config.setString(ConfigConstants.PATH_HADOOP_CONFIG, yarnConfDir);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 281                 FileSystem.initialize(config, null);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 282 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 283                 YarnConfiguration yarnConf = YarnConfLoader.getYarnConf(yarnConfDir);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 284                 YarnClient yarnClient = YarnClient.createYarnClient();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 285                 yarnClient.init(yarnConf);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 286                 yarnClient.start();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 287                 ApplicationId applicationId = null;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 288 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 289                 String yarnSessionConf = launcherOptions.getYarnSessionConf();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 290                 yarnSessionConf = URLDecoder.decode(yarnSessionConf, Charsets.UTF_8.toString());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 291                 Properties yarnSessionConfProperties = PluginUtil.jsonStrToObject(yarnSessionConf, Properties.class);"> 291                 Properties yarnSessionConfProperties = PluginUtil.jsonStrToObject(yarnSessionConf, ProperðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 292                 Object yid = yarnSessionConfProperties.get(&quot;yid&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 293 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 294                 if (null != yid) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 295                     applicationId = toApplicationId(yid.toString());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 296                 } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 297                     applicationId = getYarnClusterApplicationId(yarnClient);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 298                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 299 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 300                 Log.info(&quot;applicationId={}&quot;, applicationId.toString());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 301 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 302                 if (StringUtils.isEmpty(applicationId.toString())) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 303                     throw new RuntimeException(&quot;No flink session found on yarn cluster.&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 304                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 305 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 306                 AbstractYarnClusterDescriptor clusterDescriptor = new YarnClusterDescriptor(config, yarnConf, flinkConfDir, yarnClient, false);"> 306                 AbstractYarnClusterDescriptor clusterDescriptor = new YarnClusterDescriptor(config, yarnCðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 307                 ClusterClient clusterClient = clusterDescriptor.retrieve(applicationId);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 308                 clusterClient.setDetached(true);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 309                 return clusterClient;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 310             } catch (Exception e) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 311                 throw new RuntimeException(e);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 312             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 313         }else{</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 314             throw new RuntimeException(&quot;yarn mode must set param of &#x27;yarnconf&#x27;!!!&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 315         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 316     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 317 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 318 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 319     private static ApplicationId getYarnClusterApplicationId(YarnClient yarnClient) throws Exception {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 320         ApplicationId applicationId = null;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 321 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 322         Set&lt;String&gt; set = new HashSet&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 323         set.add(&quot;Apache Flink&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 324         EnumSet&lt;YarnApplicationState&gt; enumSet = EnumSet.noneOf(YarnApplicationState.class);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 325         enumSet.add(YarnApplicationState.RUNNING);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 326         List&lt;ApplicationReport&gt; reportList = yarnClient.getApplications(set, enumSet);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 327 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 328         int maxMemory = -1;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 329         int maxCores = -1;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 330         for (ApplicationReport report : reportList) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 331             if (!report.getName().startsWith(&quot;Flink session&quot;)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 332                 continue;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 333             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 334 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 335             if (!report.getYarnApplicationState().equals(YarnApplicationState.RUNNING)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 336                 continue;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 337             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 338 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 339             int thisMemory = report.getApplicationResourceUsageReport().getNeededResources().getMemory();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 340             int thisCores = report.getApplicationResourceUsageReport().getNeededResources().getVirtualCores();"> 340             int thisCores = report.getApplicationResourceUsageReport().getNeededResources().getVirtualCorðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 341             if (thisMemory &gt; maxMemory || thisMemory == maxMemory &amp;&amp; thisCores &gt; maxCores) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 342                 maxMemory = thisMemory;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 343                 maxCores = thisCores;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 344                 applicationId = report.getApplicationId();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 345             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 346 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 347         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 348 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 349         if (StringUtils.isEmpty(applicationId.toString())) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 350             throw new RuntimeException(&quot;No flink session found on yarn cluster.&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 351         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 352         return applicationId;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 353     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 354 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 355     private static ApplicationId toApplicationId(String appIdStr) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 356         Iterator&lt;String&gt; it = StringHelper._split(appIdStr).iterator();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 357         if (!&quot;application&quot;.equals(it.next())) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 358             throw new IllegalArgumentException(&quot;Invalid ApplicationId prefix: &quot; + appIdStr + &quot;. The valid ApplicationId should start with prefix &quot; + &quot;application&quot;);"> 358             throw new IllegalArgumentException(&quot;Invalid ApplicationId prefix: &quot; + appIdStr + &quot;. The validðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 359         } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 360             try {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 361                 return toApplicationId(it);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 362             } catch (NumberFormatException e) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 363                 throw new IllegalArgumentException(&quot;Invalid AppAttemptId: &quot; + appIdStr, e);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 364             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 365         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 366     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 367 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 368     private static ApplicationId toApplicationId(Iterator&lt;String&gt; it) throws NumberFormatException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 369         return ApplicationId.newInstance(Long.parseLong(it.next()), Integer.parseInt(it.next()));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 370     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 371 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 372 }</span>
 373 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs</pre></td>
                            <td><pre>   1 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
   2 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   3 /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   4  * Licensed to the Apache Software Foundation (ASF) under one</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   5  * or more contributor license agreements.  See the NOTICE file</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   6  * distributed with this work for additional information</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   7  * regarding copyright ownership.  The ASF licenses this file</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   8  * to you under the Apache License, Version 2.0 (the</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   9  * &quot;License&quot;); you may not use this file except in compliance</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  10  * with the License.  You may obtain a copy of the License at</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  11  *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  12  * http://www.apache.org/licenses/LICENSE-2.0</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  13  *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  14  * Unless required by applicable law or agreed to in writing, software</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  15  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  16  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  17  * See the License for the specific language governing permissions and</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  18  * limitations under the License.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  19  */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  20 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  21 package com.dtstack.flink.sql.launcher;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  22 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  23 import com.dtstack.flink.sql.enums.ClusterMode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  24 import com.dtstack.flink.sql.option.Options;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  25 import com.dtstack.flink.sql.util.PluginUtil;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  26 import org.apache.commons.io.Charsets;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  27 import org.apache.commons.lang.StringUtils;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  28 import org.apache.flink.client.program.ClusterClient;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  29 import org.apache.flink.client.program.MiniClusterClient;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  30 import org.apache.flink.configuration.ConfigConstants;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  31 import org.apache.flink.configuration.Configuration;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  32 import org.apache.flink.configuration.GlobalConfiguration;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  33 import org.apache.flink.configuration.JobManagerOptions;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  34 import org.apache.flink.core.fs.FileSystem;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  35 import org.apache.flink.runtime.akka.AkkaUtils;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  36 import org.apache.flink.runtime.minicluster.MiniCluster;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  37 import org.apache.flink.runtime.minicluster.MiniClusterConfiguration;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  38 import org.apache.flink.runtime.util.LeaderConnectionInfo;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  39 import org.apache.flink.yarn.AbstractYarnClusterDescriptor;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  40 import org.apache.flink.yarn.YarnClusterDescriptor;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  41 import org.apache.hadoop.yarn.api.records.ApplicationId;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  42 import org.apache.hadoop.yarn.api.records.ApplicationReport;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  43 import org.apache.hadoop.yarn.api.records.YarnApplicationState;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  44 import org.apache.hadoop.yarn.client.api.YarnClient;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  45 import org.apache.hadoop.yarn.conf.YarnConfiguration;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  46 import org.apache.hadoop.yarn.util.StringHelper;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  47 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  48 import java.net.InetSocketAddress;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  49 import java.net.URLDecoder;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  50 import java.util.EnumSet;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  51 import java.util.HashSet;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  52 import java.util.Iterator;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  53 import java.util.List;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  54 import java.util.Properties;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  55 import java.util.Set;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  56 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  57 /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  58  * @author sishu.yss</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  59  */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  60 public class ClusterClientFactory {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  61 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  62     public static ClusterClient createClusterClient(Options launcherOptions) throws Exception {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  63         String mode = launcherOptions.getMode();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  64         if (mode.equals(ClusterMode.standalone.name())) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  65             return createStandaloneClient(launcherOptions);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  66         } else if (mode.equals(ClusterMode.yarn.name())) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  67             return createYarnSessionClient(launcherOptions);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  68         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  69         throw new IllegalArgumentException(&quot;Unsupported cluster client type: &quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  70     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  71 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  72     public static ClusterClient createStandaloneClient(Options launcherOptions) throws Exception {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  73         String flinkConfDir = launcherOptions.getFlinkconf();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  74         Configuration config = GlobalConfiguration.loadConfiguration(flinkConfDir);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  75         MiniClusterConfiguration.Builder configBuilder = new MiniClusterConfiguration.Builder();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  76         configBuilder.setConfiguration(config);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  77         MiniCluster miniCluster = new MiniCluster(configBuilder.build());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  78         MiniClusterClient clusterClient = new MiniClusterClient(config, miniCluster);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  79         LeaderConnectionInfo connectionInfo = clusterClient.getClusterConnectionInfo();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="  80         InetSocketAddress address = AkkaUtils.getInetSocketAddressFromAkkaURL(connectionInfo.getAddress());">  80         InetSocketAddress address = AkkaUtils.getInetSocketAddressFromAkkaURL(connectionInfo.getAddress()ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  81         config.setString(JobManagerOptions.ADDRESS, address.getAddress().getHostName());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  82         config.setInteger(JobManagerOptions.PORT, address.getPort());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  83         clusterClient.setDetached(true);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  84         return clusterClient;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  85     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  86 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  87     public static ClusterClient createYarnSessionClient(Options launcherOptions) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="  88         String flinkConfDir = StringUtils.isEmpty(launcherOptions.getFlinkconf()) ? &quot;&quot; : launcherOptions.getFlinkconf();">  88         String flinkConfDir = StringUtils.isEmpty(launcherOptions.getFlinkconf()) ? &quot;&quot; : launcherOptions.ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="  89         Configuration config = StringUtils.isEmpty(flinkConfDir) ? new Configuration() : GlobalConfiguration.loadConfiguration(flinkConfDir);">  89         Configuration config = StringUtils.isEmpty(flinkConfDir) ? new Configuration() : GlobalConfiguratðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  90         String yarnConfDir = launcherOptions.getYarnconf();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  91 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  92         if (StringUtils.isNotBlank(yarnConfDir)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  93             try {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  94                 config.setString(ConfigConstants.PATH_HADOOP_CONFIG, yarnConfDir);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  95                 FileSystem.initialize(config, null);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  96 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  97                 YarnConfiguration yarnConf = YarnConfLoader.getYarnConf(yarnConfDir);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  98                 YarnClient yarnClient = YarnClient.createYarnClient();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  99                 yarnClient.init(yarnConf);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 100                 yarnClient.start();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 101                 ApplicationId applicationId = null;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 102 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 103                 String yarnSessionConf = launcherOptions.getYarnSessionConf();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 104                 yarnSessionConf = URLDecoder.decode(yarnSessionConf, Charsets.UTF_8.toString());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 105                 Properties yarnSessionConfProperties = PluginUtil.jsonStrToObject(yarnSessionConf, Properties.class);"> 105                 Properties yarnSessionConfProperties = PluginUtil.jsonStrToObject(yarnSessionConf, ProperðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 106                 Object yid = yarnSessionConfProperties.get(&quot;yid&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 107 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 108                 if (null != yid) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 109                     applicationId = toApplicationId(yid.toString());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 110                 } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 111                     applicationId = getYarnClusterApplicationId(yarnClient);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 112                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 113 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 114                 System.out.println(&quot;applicationId=&quot; + applicationId.toString());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 115 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 116                 if (StringUtils.isEmpty(applicationId.toString())) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 117                     throw new RuntimeException(&quot;No flink session found on yarn cluster.&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 118                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 119 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 120                 AbstractYarnClusterDescriptor clusterDescriptor = new YarnClusterDescriptor(config, yarnConf, flinkConfDir, yarnClient, false);"> 120                 AbstractYarnClusterDescriptor clusterDescriptor = new YarnClusterDescriptor(config, yarnCðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 121                 ClusterClient clusterClient = clusterDescriptor.retrieve(applicationId);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 122                 clusterClient.setDetached(true);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 123                 return clusterClient;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 124             } catch (Exception e) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 125                 throw new RuntimeException(e);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 126             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 127         }else{</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 128             throw new RuntimeException(&quot;yarn mode must set param of &#x27;yarnconf&#x27;!!!&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 129         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 130     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 131 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 132 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 133     private static ApplicationId getYarnClusterApplicationId(YarnClient yarnClient) throws Exception {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 134         ApplicationId applicationId = null;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 135 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 136         Set&lt;String&gt; set = new HashSet&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 137         set.add(&quot;Apache Flink&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 138         EnumSet&lt;YarnApplicationState&gt; enumSet = EnumSet.noneOf(YarnApplicationState.class);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 139         enumSet.add(YarnApplicationState.RUNNING);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 140         List&lt;ApplicationReport&gt; reportList = yarnClient.getApplications(set, enumSet);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 141 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 142         int maxMemory = -1;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 143         int maxCores = -1;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 144         for (ApplicationReport report : reportList) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 145             if (!report.getName().startsWith(&quot;Flink session&quot;)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 146                 continue;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 147             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 148 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 149             if (!report.getYarnApplicationState().equals(YarnApplicationState.RUNNING)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 150                 continue;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 151             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 152 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 153             int thisMemory = report.getApplicationResourceUsageReport().getNeededResources().getMemory();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 154             int thisCores = report.getApplicationResourceUsageReport().getNeededResources().getVirtualCores();"> 154             int thisCores = report.getApplicationResourceUsageReport().getNeededResources().getVirtualCorðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 155             if (thisMemory &gt; maxMemory || thisMemory == maxMemory &amp;&amp; thisCores &gt; maxCores) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 156                 maxMemory = thisMemory;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 157                 maxCores = thisCores;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 158                 applicationId = report.getApplicationId();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 159             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 160 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 161         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 162 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 163         if (StringUtils.isEmpty(applicationId.toString())) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 164             throw new RuntimeException(&quot;No flink session found on yarn cluster.&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 165         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 166         return applicationId;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 167     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 168 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 169     private static ApplicationId toApplicationId(String appIdStr) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 170         Iterator&lt;String&gt; it = StringHelper._split(appIdStr).iterator();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 171         if (!(it.next()).equals(&quot;application&quot;)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 172             throw new IllegalArgumentException(&quot;Invalid ApplicationId prefix: &quot; + appIdStr + &quot;. The valid ApplicationId should start with prefix &quot; + &quot;application&quot;);"> 172             throw new IllegalArgumentException(&quot;Invalid ApplicationId prefix: &quot; + appIdStr + &quot;. The validðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 173         } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 174             try {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 175                 return toApplicationId(it);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 176             } catch (NumberFormatException e) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 177                 throw new IllegalArgumentException(&quot;Invalid AppAttemptId: &quot; + appIdStr, e);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 178             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 179         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 180     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 181 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 182     private static ApplicationId toApplicationId(Iterator&lt;String&gt; it) throws NumberFormatException {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 183         return ApplicationId.newInstance(Long.parseLong(it.next()), Integer.parseInt(it.next()));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 184     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 185 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 186 }</span>
 187 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 188 /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 189  * Licensed to the Apache Software Foundation (ASF) under one</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 190  * or more contributor license agreements.  See the NOTICE file</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 191  * distributed with this work for additional information</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 192  * regarding copyright ownership.  The ASF licenses this file</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 193  * to you under the Apache License, Version 2.0 (the</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 194  * &quot;License&quot;); you may not use this file except in compliance</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 195  * with the License.  You may obtain a copy of the License at</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 196  *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 197  * http://www.apache.org/licenses/LICENSE-2.0</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 198  *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 199  * Unless required by applicable law or agreed to in writing, software</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 200  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 201  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 202  * See the License for the specific language governing permissions and</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 203  * limitations under the License.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 204  */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 205 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 206 package com.dtstack.flink.sql.launcher;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 207 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 208 import com.dtstack.flink.sql.enums.ClusterMode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 209 import com.dtstack.flink.sql.option.Options;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 210 import com.dtstack.flink.sql.util.PluginUtil;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 211 import com.esotericsoftware.minlog.Log;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 212 import org.apache.commons.io.Charsets;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 213 import org.apache.commons.lang.StringUtils;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 214 import org.apache.flink.client.program.ClusterClient;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 215 import org.apache.flink.client.program.MiniClusterClient;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 216 import org.apache.flink.configuration.ConfigConstants;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 217 import org.apache.flink.configuration.Configuration;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 218 import org.apache.flink.configuration.GlobalConfiguration;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 219 import org.apache.flink.configuration.JobManagerOptions;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 220 import org.apache.flink.core.fs.FileSystem;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 221 import org.apache.flink.runtime.akka.AkkaUtils;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 222 import org.apache.flink.runtime.minicluster.MiniCluster;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 223 import org.apache.flink.runtime.minicluster.MiniClusterConfiguration;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 224 import org.apache.flink.runtime.util.LeaderConnectionInfo;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 225 import org.apache.flink.yarn.AbstractYarnClusterDescriptor;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 226 import org.apache.flink.yarn.YarnClusterDescriptor;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 227 import org.apache.hadoop.yarn.api.records.ApplicationId;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 228 import org.apache.hadoop.yarn.api.records.ApplicationReport;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 229 import org.apache.hadoop.yarn.api.records.YarnApplicationState;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 230 import org.apache.hadoop.yarn.client.api.YarnClient;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 231 import org.apache.hadoop.yarn.conf.YarnConfiguration;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 232 import org.apache.hadoop.yarn.util.StringHelper;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 233 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 234 import java.net.InetSocketAddress;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 235 import java.net.URLDecoder;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 236 import java.util.EnumSet;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 237 import java.util.HashSet;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 238 import java.util.Iterator;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 239 import java.util.List;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 240 import java.util.Properties;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 241 import java.util.Set;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 242 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 243 /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 244  * @author sishu.yss</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 245  */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 246 public class ClusterClientFactory {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 247 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 248     public static ClusterClient createClusterClient(Options launcherOptions) throws Exception {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 249         String mode = launcherOptions.getMode();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 250         if (mode.equals(ClusterMode.standalone.name())) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 251             return createStandaloneClient(launcherOptions);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 252         } else if (mode.equals(ClusterMode.yarn.name())) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 253             return createYarnSessionClient(launcherOptions);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 254         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 255         throw new IllegalArgumentException(&quot;Unsupported cluster client type: &quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 256     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 257 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 258     public static ClusterClient createStandaloneClient(Options launcherOptions) throws Exception {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 259         String flinkConfDir = launcherOptions.getFlinkconf();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 260         Configuration config = GlobalConfiguration.loadConfiguration(flinkConfDir);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 261         MiniClusterConfiguration.Builder configBuilder = new MiniClusterConfiguration.Builder();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 262         configBuilder.setConfiguration(config);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 263         MiniCluster miniCluster = new MiniCluster(configBuilder.build());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 264         MiniClusterClient clusterClient = new MiniClusterClient(config, miniCluster);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 265         LeaderConnectionInfo connectionInfo = clusterClient.getClusterConnectionInfo();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 266         InetSocketAddress address = AkkaUtils.getInetSocketAddressFromAkkaURL(connectionInfo.getAddress());"> 266         InetSocketAddress address = AkkaUtils.getInetSocketAddressFromAkkaURL(connectionInfo.getAddress()ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 267         config.setString(JobManagerOptions.ADDRESS, address.getAddress().getHostName());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 268         config.setInteger(JobManagerOptions.PORT, address.getPort());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 269         clusterClient.setDetached(true);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 270         return clusterClient;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 271     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 272 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 273     public static ClusterClient createYarnSessionClient(Options launcherOptions) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 274         String flinkConfDir = StringUtils.isEmpty(launcherOptions.getFlinkconf()) ? &quot;&quot; : launcherOptions.getFlinkconf();"> 274         String flinkConfDir = StringUtils.isEmpty(launcherOptions.getFlinkconf()) ? &quot;&quot; : launcherOptions.ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 275         Configuration config = StringUtils.isEmpty(flinkConfDir) ? new Configuration() : GlobalConfiguration.loadConfiguration(flinkConfDir);"> 275         Configuration config = StringUtils.isEmpty(flinkConfDir) ? new Configuration() : GlobalConfiguratðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 276         String yarnConfDir = launcherOptions.getYarnconf();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 277 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 278         if (StringUtils.isNotBlank(yarnConfDir)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 279             try {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 280                 config.setString(ConfigConstants.PATH_HADOOP_CONFIG, yarnConfDir);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 281                 FileSystem.initialize(config, null);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 282 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 283                 YarnConfiguration yarnConf = YarnConfLoader.getYarnConf(yarnConfDir);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 284                 YarnClient yarnClient = YarnClient.createYarnClient();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 285                 yarnClient.init(yarnConf);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 286                 yarnClient.start();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 287                 ApplicationId applicationId = null;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 288 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 289                 String yarnSessionConf = launcherOptions.getYarnSessionConf();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 290                 yarnSessionConf = URLDecoder.decode(yarnSessionConf, Charsets.UTF_8.toString());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 291                 Properties yarnSessionConfProperties = PluginUtil.jsonStrToObject(yarnSessionConf, Properties.class);"> 291                 Properties yarnSessionConfProperties = PluginUtil.jsonStrToObject(yarnSessionConf, ProperðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 292                 Object yid = yarnSessionConfProperties.get(&quot;yid&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 293 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 294                 if (null != yid) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 295                     applicationId = toApplicationId(yid.toString());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 296                 } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 297                     applicationId = getYarnClusterApplicationId(yarnClient);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 298                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 299 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 300                 Log.info(&quot;applicationId={}&quot;, applicationId.toString());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 301 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 302                 if (StringUtils.isEmpty(applicationId.toString())) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 303                     throw new RuntimeException(&quot;No flink session found on yarn cluster.&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 304                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 305 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 306                 AbstractYarnClusterDescriptor clusterDescriptor = new YarnClusterDescriptor(config, yarnConf, flinkConfDir, yarnClient, false);"> 306                 AbstractYarnClusterDescriptor clusterDescriptor = new YarnClusterDescriptor(config, yarnCðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 307                 ClusterClient clusterClient = clusterDescriptor.retrieve(applicationId);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 308                 clusterClient.setDetached(true);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 309                 return clusterClient;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 310             } catch (Exception e) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 311                 throw new RuntimeException(e);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 312             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 313         }else{</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 314             throw new RuntimeException(&quot;yarn mode must set param of &#x27;yarnconf&#x27;!!!&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 315         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 316     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 317 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 318 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 319     private static ApplicationId getYarnClusterApplicationId(YarnClient yarnClient) throws Exception {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 320         ApplicationId applicationId = null;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 321 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 322         Set&lt;String&gt; set = new HashSet&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 323         set.add(&quot;Apache Flink&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 324         EnumSet&lt;YarnApplicationState&gt; enumSet = EnumSet.noneOf(YarnApplicationState.class);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 325         enumSet.add(YarnApplicationState.RUNNING);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 326         List&lt;ApplicationReport&gt; reportList = yarnClient.getApplications(set, enumSet);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 327 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 328         int maxMemory = -1;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 329         int maxCores = -1;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 330         for (ApplicationReport report : reportList) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 331             if (!report.getName().startsWith(&quot;Flink session&quot;)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 332                 continue;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 333             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 334 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 335             if (!report.getYarnApplicationState().equals(YarnApplicationState.RUNNING)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 336                 continue;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 337             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 338 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 339             int thisMemory = report.getApplicationResourceUsageReport().getNeededResources().getMemory();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 340             int thisCores = report.getApplicationResourceUsageReport().getNeededResources().getVirtualCores();"> 340             int thisCores = report.getApplicationResourceUsageReport().getNeededResources().getVirtualCorðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 341             if (thisMemory &gt; maxMemory || thisMemory == maxMemory &amp;&amp; thisCores &gt; maxCores) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 342                 maxMemory = thisMemory;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 343                 maxCores = thisCores;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 344                 applicationId = report.getApplicationId();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 345             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 346 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 347         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 348 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 349         if (StringUtils.isEmpty(applicationId.toString())) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 350             throw new RuntimeException(&quot;No flink session found on yarn cluster.&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 351         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 352         return applicationId;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 353     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 354 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 355     private static ApplicationId toApplicationId(String appIdStr) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 356         Iterator&lt;String&gt; it = StringHelper._split(appIdStr).iterator();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 357         if (!&quot;application&quot;.equals(it.next())) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 358             throw new IllegalArgumentException(&quot;Invalid ApplicationId prefix: &quot; + appIdStr + &quot;. The valid ApplicationId should start with prefix &quot; + &quot;application&quot;);"> 358             throw new IllegalArgumentException(&quot;Invalid ApplicationId prefix: &quot; + appIdStr + &quot;. The validðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 359         } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 360             try {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 361                 return toApplicationId(it);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 362             } catch (NumberFormatException e) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 363                 throw new IllegalArgumentException(&quot;Invalid AppAttemptId: &quot; + appIdStr, e);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 364             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 365         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 366     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 367 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 368     private static ApplicationId toApplicationId(Iterator&lt;String&gt; it) throws NumberFormatException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 369         return ApplicationId.newInstance(Long.parseLong(it.next()), Integer.parseInt(it.next()));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 370     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 371 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 372 }</span>
 373 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS</pre></td>
                            <td><pre>   1 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
   2 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="   3 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/">   3 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwðŸ”µ</abbr></span>
   4 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">   5 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">   6 /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">   7  * Licensed to the Apache Software Foundation (ASF) under one</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">   8  * or more contributor license agreements.  See the NOTICE file</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">   9  * distributed with this work for additional information</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  10  * regarding copyright ownership.  The ASF licenses this file</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  11  * to you under the Apache License, Version 2.0 (the</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  12  * &quot;License&quot;); you may not use this file except in compliance</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  13  * with the License.  You may obtain a copy of the License at</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  14  *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  15  * http://www.apache.org/licenses/LICENSE-2.0</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  16  *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  17  * Unless required by applicable law or agreed to in writing, software</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  18  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  19  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  20  * See the License for the specific language governing permissions and</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  21  * limitations under the License.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  22  */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  23 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  24 package com.dtstack.flink.sql.launcher;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  25 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  26 import com.dtstack.flink.sql.enums.ClusterMode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  27 import com.dtstack.flink.sql.option.Options;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  28 import com.dtstack.flink.sql.util.PluginUtil;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  29 import com.esotericsoftware.minlog.Log;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  30 import org.apache.commons.io.Charsets;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  31 import org.apache.commons.lang.StringUtils;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  32 import org.apache.flink.client.program.ClusterClient;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  33 import org.apache.flink.client.program.MiniClusterClient;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  34 import org.apache.flink.configuration.ConfigConstants;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  35 import org.apache.flink.configuration.Configuration;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  36 import org.apache.flink.configuration.GlobalConfiguration;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  37 import org.apache.flink.configuration.JobManagerOptions;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  38 import org.apache.flink.core.fs.FileSystem;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  39 import org.apache.flink.runtime.akka.AkkaUtils;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  40 import org.apache.flink.runtime.minicluster.MiniCluster;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  41 import org.apache.flink.runtime.minicluster.MiniClusterConfiguration;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  42 import org.apache.flink.runtime.util.LeaderConnectionInfo;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  43 import org.apache.flink.yarn.AbstractYarnClusterDescriptor;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  44 import org.apache.flink.yarn.YarnClusterDescriptor;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  45 import org.apache.hadoop.yarn.api.records.ApplicationId;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  46 import org.apache.hadoop.yarn.api.records.ApplicationReport;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  47 import org.apache.hadoop.yarn.api.records.YarnApplicationState;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  48 import org.apache.hadoop.yarn.client.api.YarnClient;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  49 import org.apache.hadoop.yarn.conf.YarnConfiguration;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  50 import org.apache.hadoop.yarn.util.StringHelper;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  51 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  52 import java.net.InetSocketAddress;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  53 import java.net.URLDecoder;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  54 import java.util.EnumSet;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  55 import java.util.HashSet;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  56 import java.util.Iterator;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  57 import java.util.List;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  58 import java.util.Properties;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  59 import java.util.Set;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  60 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  61 /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  62  * @author sishu.yss</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  63  */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  64 public class ClusterClientFactory {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  65 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  66     public static ClusterClient createClusterClient(Options launcherOptions) throws Exception {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  67         String mode = launcherOptions.getMode();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  68         if (mode.equals(ClusterMode.standalone.name())) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  69             return createStandaloneClient(launcherOptions);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  70         } else if (mode.equals(ClusterMode.yarn.name())) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  71             return createYarnSessionClient(launcherOptions);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  72         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  73         throw new IllegalArgumentException(&quot;Unsupported cluster client type: &quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  74     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  75 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  76     public static ClusterClient createStandaloneClient(Options launcherOptions) throws Exception {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  77         String flinkConfDir = launcherOptions.getFlinkconf();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  78         Configuration config = GlobalConfiguration.loadConfiguration(flinkConfDir);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  79         MiniClusterConfiguration.Builder configBuilder = new MiniClusterConfiguration.Builder();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  80         configBuilder.setConfiguration(config);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  81         MiniCluster miniCluster = new MiniCluster(configBuilder.build());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  82         MiniClusterClient clusterClient = new MiniClusterClient(config, miniCluster);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  83         LeaderConnectionInfo connectionInfo = clusterClient.getClusterConnectionInfo();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title="  84         InetSocketAddress address = AkkaUtils.getInetSocketAddressFromAkkaURL(connectionInfo.getAddress());">  84         InetSocketAddress address = AkkaUtils.getInetSocketAddressFromAkkaURL(connectionInfo.getAddress()ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  85         config.setString(JobManagerOptions.ADDRESS, address.getAddress().getHostName());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  86         config.setInteger(JobManagerOptions.PORT, address.getPort());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  87         clusterClient.setDetached(true);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  88         return clusterClient;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  89     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  90 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  91     public static ClusterClient createYarnSessionClient(Options launcherOptions) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title="  92         String flinkConfDir = StringUtils.isEmpty(launcherOptions.getFlinkconf()) ? &quot;&quot; : launcherOptions.getFlinkconf();">  92         String flinkConfDir = StringUtils.isEmpty(launcherOptions.getFlinkconf()) ? &quot;&quot; : launcherOptions.ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title="  93         Configuration config = StringUtils.isEmpty(flinkConfDir) ? new Configuration() : GlobalConfiguration.loadConfiguration(flinkConfDir);">  93         Configuration config = StringUtils.isEmpty(flinkConfDir) ? new Configuration() : GlobalConfiguratðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  94         String yarnConfDir = launcherOptions.getYarnconf();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  95 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  96         if (StringUtils.isNotBlank(yarnConfDir)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  97             try {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  98                 config.setString(ConfigConstants.PATH_HADOOP_CONFIG, yarnConfDir);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  99                 FileSystem.initialize(config, null);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 100 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 101                 YarnConfiguration yarnConf = YarnConfLoader.getYarnConf(yarnConfDir);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 102                 YarnClient yarnClient = YarnClient.createYarnClient();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 103                 yarnClient.init(yarnConf);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 104                 yarnClient.start();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 105                 ApplicationId applicationId = null;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 106 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 107                 String yarnSessionConf = launcherOptions.getYarnSessionConf();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 108                 yarnSessionConf = URLDecoder.decode(yarnSessionConf, Charsets.UTF_8.toString());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 109                 Properties yarnSessionConfProperties = PluginUtil.jsonStrToObject(yarnSessionConf, Properties.class);"> 109                 Properties yarnSessionConfProperties = PluginUtil.jsonStrToObject(yarnSessionConf, ProperðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 110                 Object yid = yarnSessionConfProperties.get(&quot;yid&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 111 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 112                 if (null != yid) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 113                     applicationId = toApplicationId(yid.toString());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 114                 } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 115                     applicationId = getYarnClusterApplicationId(yarnClient);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 116                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 117 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 118                 Log.info(&quot;applicationId={}&quot;, applicationId.toString());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 119 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 120                 if (StringUtils.isEmpty(applicationId.toString())) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 121                     throw new RuntimeException(&quot;No flink session found on yarn cluster.&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 122                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 123 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 124                 AbstractYarnClusterDescriptor clusterDescriptor = new YarnClusterDescriptor(config, yarnConf, flinkConfDir, yarnClient, false);"> 124                 AbstractYarnClusterDescriptor clusterDescriptor = new YarnClusterDescriptor(config, yarnCðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 125                 ClusterClient clusterClient = clusterDescriptor.retrieve(applicationId);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 126                 clusterClient.setDetached(true);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 127                 return clusterClient;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 128             } catch (Exception e) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 129                 throw new RuntimeException(e);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 130             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 131         }else{</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 132             throw new RuntimeException(&quot;yarn mode must set param of &#x27;yarnconf&#x27;!!!&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 133         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 134     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 135 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 136 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 137     private static ApplicationId getYarnClusterApplicationId(YarnClient yarnClient) throws Exception {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 138         ApplicationId applicationId = null;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 139 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 140         Set&lt;String&gt; set = new HashSet&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 141         set.add(&quot;Apache Flink&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 142         EnumSet&lt;YarnApplicationState&gt; enumSet = EnumSet.noneOf(YarnApplicationState.class);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 143         enumSet.add(YarnApplicationState.RUNNING);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 144         List&lt;ApplicationReport&gt; reportList = yarnClient.getApplications(set, enumSet);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 145 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 146         int maxMemory = -1;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 147         int maxCores = -1;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 148         for (ApplicationReport report : reportList) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 149             if (!report.getName().startsWith(&quot;Flink session&quot;)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 150                 continue;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 151             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 152 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 153             if (!report.getYarnApplicationState().equals(YarnApplicationState.RUNNING)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 154                 continue;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 155             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 156 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 157             int thisMemory = report.getApplicationResourceUsageReport().getNeededResources().getMemory();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 158             int thisCores = report.getApplicationResourceUsageReport().getNeededResources().getVirtualCores();"> 158             int thisCores = report.getApplicationResourceUsageReport().getNeededResources().getVirtualCorðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 159             if (thisMemory &gt; maxMemory || thisMemory == maxMemory &amp;&amp; thisCores &gt; maxCores) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 160                 maxMemory = thisMemory;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 161                 maxCores = thisCores;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 162                 applicationId = report.getApplicationId();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 163             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 164 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 165         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 166 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 167         if (StringUtils.isEmpty(applicationId.toString())) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 168             throw new RuntimeException(&quot;No flink session found on yarn cluster.&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 169         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 170         return applicationId;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 171     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 172 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 173     private static ApplicationId toApplicationId(String appIdStr) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 174         Iterator&lt;String&gt; it = StringHelper._split(appIdStr).iterator();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 175         if (!&quot;application&quot;.equals(it.next())) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 176             throw new IllegalArgumentException(&quot;Invalid ApplicationId prefix: &quot; + appIdStr + &quot;. The valid ApplicationId should start with prefix &quot; + &quot;application&quot;);"> 176             throw new IllegalArgumentException(&quot;Invalid ApplicationId prefix: &quot; + appIdStr + &quot;. The validðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 177         } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 178             try {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 179                 return toApplicationId(it);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 180             } catch (NumberFormatException e) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 181                 throw new IllegalArgumentException(&quot;Invalid AppAttemptId: &quot; + appIdStr, e);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 182             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 183         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 184     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 185 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 186     private static ApplicationId toApplicationId(Iterator&lt;String&gt; it) throws NumberFormatException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 187         return ApplicationId.newInstance(Long.parseLong(it.next()), Integer.parseInt(it.next()));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 188     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 189 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 190 }</span>
 191 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre><span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   1 -/**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   2 - * Licensed to the Apache Software Foundation (ASF) under one</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   3 - * or more contributor license agreements.  See the NOTICE file</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   4 - * distributed with this work for additional information</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   5 - * regarding copyright ownership.  The ASF licenses this file</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   6 - * to you under the Apache License, Version 2.0 (the</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   7 - * &quot;License&quot;); you may not use this file except in compliance</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   8 - * with the License.  You may obtain a copy of the License at</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   9 - *</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  10 - * http://www.apache.org/licenses/LICENSE-2.0</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  11 - *</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  12 - * Unless required by applicable law or agreed to in writing, software</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  13 - * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  14 - * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  15 - * See the License for the specific language governing permissions and</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  16 - * limitations under the License.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  17 - */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  18 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  19 -package com.dtstack.flink.sql.launcher;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  20 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  21 -import com.dtstack.flink.sql.enums.ClusterMode;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  22 -import com.dtstack.flink.sql.option.Options;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  23 -import com.dtstack.flink.sql.util.PluginUtil;</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  24 -import org.apache.commons.io.Charsets;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  25 -import org.apache.commons.lang.StringUtils;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  26 -import org.apache.flink.client.program.ClusterClient;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  27 -import org.apache.flink.client.program.MiniClusterClient;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  28 -import org.apache.flink.configuration.ConfigConstants;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  29 -import org.apache.flink.configuration.Configuration;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  30 -import org.apache.flink.configuration.GlobalConfiguration;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  31 -import org.apache.flink.configuration.JobManagerOptions;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  32 -import org.apache.flink.core.fs.FileSystem;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  33 -import org.apache.flink.runtime.akka.AkkaUtils;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  34 -import org.apache.flink.runtime.minicluster.MiniCluster;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  35 -import org.apache.flink.runtime.minicluster.MiniClusterConfiguration;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  36 -import org.apache.flink.runtime.util.LeaderConnectionInfo;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  37 -import org.apache.flink.yarn.AbstractYarnClusterDescriptor;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  38 -import org.apache.flink.yarn.YarnClusterDescriptor;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  39 -import org.apache.hadoop.yarn.api.records.ApplicationId;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  40 -import org.apache.hadoop.yarn.api.records.ApplicationReport;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  41 -import org.apache.hadoop.yarn.api.records.YarnApplicationState;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  42 -import org.apache.hadoop.yarn.client.api.YarnClient;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  43 -import org.apache.hadoop.yarn.conf.YarnConfiguration;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  44 -import org.apache.hadoop.yarn.util.StringHelper;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  45 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  46 -import java.net.InetSocketAddress;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  47 -import java.net.URLDecoder;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  48 -import java.util.EnumSet;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  49 -import java.util.HashSet;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  50 -import java.util.Iterator;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  51 -import java.util.List;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  52 -import java.util.Properties;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  53 -import java.util.Set;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  54 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  55 -/**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  56 - * @author sishu.yss</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  57 - */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  58 -public class ClusterClientFactory {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  59 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  60 -    public static ClusterClient createClusterClient(Options launcherOptions) throws Exception {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  61 -        String mode = launcherOptions.getMode();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  62 -        if (mode.equals(ClusterMode.standalone.name())) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  63 -            return createStandaloneClient(launcherOptions);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  64 -        } else if (mode.equals(ClusterMode.yarn.name())) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  65 -            return createYarnSessionClient(launcherOptions);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  66 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  67 -        throw new IllegalArgumentException(&quot;Unsupported cluster client type: &quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  68 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  69 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  70 -    public static ClusterClient createStandaloneClient(Options launcherOptions) throws Exception {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  71 -        String flinkConfDir = launcherOptions.getFlinkconf();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  72 -        Configuration config = GlobalConfiguration.loadConfiguration(flinkConfDir);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  73 -        MiniClusterConfiguration.Builder configBuilder = new MiniClusterConfiguration.Builder();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  74 -        configBuilder.setConfiguration(config);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  75 -        MiniCluster miniCluster = new MiniCluster(configBuilder.build());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  76 -        MiniClusterClient clusterClient = new MiniClusterClient(config, miniCluster);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  77 -        LeaderConnectionInfo connectionInfo = clusterClient.getClusterConnectionInfo();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  78 -        InetSocketAddress address = AkkaUtils.getInetSocketAddressFromAkkaURL(connectionInfo.getAddress());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  79 -        config.setString(JobManagerOptions.ADDRESS, address.getAddress().getHostName());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  80 -        config.setInteger(JobManagerOptions.PORT, address.getPort());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  81 -        clusterClient.setDetached(true);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  82 -        return clusterClient;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  83 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  84 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  85 -    public static ClusterClient createYarnSessionClient(Options launcherOptions) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title="  86 -        String flinkConfDir = StringUtils.isEmpty(launcherOptions.getFlinkconf()) ? &quot;&quot; : launcherOptions.getFlinkconf();">  86 -        String flinkConfDir = StringUtils.isEmpty(launcherOptions.getFlinkconf()) ? &quot;&quot; : launcherOptions.getFlinkcðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title="  87 -        Configuration config = StringUtils.isEmpty(flinkConfDir) ? new Configuration() : GlobalConfiguration.loadConfiguration(flinkConfDir);">  87 -        Configuration config = StringUtils.isEmpty(flinkConfDir) ? new Configuration() : GlobalConfiguration.loadCðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  88 -        String yarnConfDir = launcherOptions.getYarnconf();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  89 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  90 -        if (StringUtils.isNotBlank(yarnConfDir)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  91 -            try {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  92 -                config.setString(ConfigConstants.PATH_HADOOP_CONFIG, yarnConfDir);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  93 -                FileSystem.initialize(config, null);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  94 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  95 -                YarnConfiguration yarnConf = YarnConfLoader.getYarnConf(yarnConfDir);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  96 -                YarnClient yarnClient = YarnClient.createYarnClient();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  97 -                yarnClient.init(yarnConf);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  98 -                yarnClient.start();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  99 -                ApplicationId applicationId = null;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 100 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 101 -                String yarnSessionConf = launcherOptions.getYarnSessionConf();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 102 -                yarnSessionConf = URLDecoder.decode(yarnSessionConf, Charsets.UTF_8.toString());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 103 -                Properties yarnSessionConfProperties = PluginUtil.jsonStrToObject(yarnSessionConf, Properties.class);"> 103 -                Properties yarnSessionConfProperties = PluginUtil.jsonStrToObject(yarnSessionConf, Properties.clasðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 104 -                Object yid = yarnSessionConfProperties.get(&quot;yid&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 105 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 106 -                if (null != yid) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 107 -                    applicationId = toApplicationId(yid.toString());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 108 -                } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 109 -                    applicationId = getYarnClusterApplicationId(yarnClient);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 110 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 111 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 112 -                System.out.println(&quot;applicationId=&quot; + applicationId.toString());</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 113 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 114 -                if (StringUtils.isEmpty(applicationId.toString())) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 115 -                    throw new RuntimeException(&quot;No flink session found on yarn cluster.&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 116 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 117 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 118 -                AbstractYarnClusterDescriptor clusterDescriptor = new YarnClusterDescriptor(config, yarnConf, flinkConfDir, yarnClient, false);"> 118 -                AbstractYarnClusterDescriptor clusterDescriptor = new YarnClusterDescriptor(config, yarnConf, flinðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 119 -                ClusterClient clusterClient = clusterDescriptor.retrieve(applicationId);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 120 -                clusterClient.setDetached(true);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 121 -                return clusterClient;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 122 -            } catch (Exception e) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 123 -                throw new RuntimeException(e);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 124 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 125 -        }else{</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 126 -            throw new RuntimeException(&quot;yarn mode must set param of &#x27;yarnconf&#x27;!!!&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 127 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 128 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 129 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 130 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 131 -    private static ApplicationId getYarnClusterApplicationId(YarnClient yarnClient) throws Exception {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 132 -        ApplicationId applicationId = null;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 133 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 134 -        Set&lt;String&gt; set = new HashSet&lt;&gt;();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 135 -        set.add(&quot;Apache Flink&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 136 -        EnumSet&lt;YarnApplicationState&gt; enumSet = EnumSet.noneOf(YarnApplicationState.class);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 137 -        enumSet.add(YarnApplicationState.RUNNING);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 138 -        List&lt;ApplicationReport&gt; reportList = yarnClient.getApplications(set, enumSet);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 139 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 140 -        int maxMemory = -1;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 141 -        int maxCores = -1;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 142 -        for (ApplicationReport report : reportList) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 143 -            if (!report.getName().startsWith(&quot;Flink session&quot;)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 144 -                continue;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 145 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 146 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 147 -            if (!report.getYarnApplicationState().equals(YarnApplicationState.RUNNING)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 148 -                continue;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 149 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 150 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 151 -            int thisMemory = report.getApplicationResourceUsageReport().getNeededResources().getMemory();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 152 -            int thisCores = report.getApplicationResourceUsageReport().getNeededResources().getVirtualCores();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 153 -            if (thisMemory &gt; maxMemory || thisMemory == maxMemory &amp;&amp; thisCores &gt; maxCores) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 154 -                maxMemory = thisMemory;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 155 -                maxCores = thisCores;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 156 -                applicationId = report.getApplicationId();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 157 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 158 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 159 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 160 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 161 -        if (StringUtils.isEmpty(applicationId.toString())) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 162 -            throw new RuntimeException(&quot;No flink session found on yarn cluster.&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 163 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 164 -        return applicationId;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 165 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 166 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 167 -    private static ApplicationId toApplicationId(String appIdStr) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 168 -        Iterator&lt;String&gt; it = StringHelper._split(appIdStr).iterator();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 169 -        if (!(it.next()).equals(&quot;application&quot;)) {</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 170 -            throw new IllegalArgumentException(&quot;Invalid ApplicationId prefix: &quot; + appIdStr + &quot;. The valid ApplicationId should start with prefix &quot; + &quot;application&quot;);"> 170 -            throw new IllegalArgumentException(&quot;Invalid ApplicationId prefix: &quot; + appIdStr + &quot;. The valid ApplicatðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 171 -        } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 172 -            try {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 173 -                return toApplicationId(it);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 174 -            } catch (NumberFormatException e) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 175 -                throw new IllegalArgumentException(&quot;Invalid AppAttemptId: &quot; + appIdStr, e);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 176 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 177 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 178 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 179 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 180 -    private static ApplicationId toApplicationId(Iterator&lt;String&gt; it) throws NumberFormatException {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 181 -        return ApplicationId.newInstance(Long.parseLong(it.next()), Integer.parseInt(it.next()));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 182 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 183 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 184 -}</span></pre></td>
                            <td><pre>   1  /**
   2   * Licensed to the Apache Software Foundation (ASF) under one
   3   * or more contributor license agreements.  See the NOTICE file
   4   * distributed with this work for additional information
   5   * regarding copyright ownership.  The ASF licenses this file
   6   * to you under the Apache License, Version 2.0 (the
   7   * &quot;License&quot;); you may not use this file except in compliance
   8   * with the License.  You may obtain a copy of the License at
   9   *
  10   * http://www.apache.org/licenses/LICENSE-2.0
  11   *
  12   * Unless required by applicable law or agreed to in writing, software
  13   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15   * See the License for the specific language governing permissions and
  16   * limitations under the License.
  17   */
  18  
  19  package com.dtstack.flink.sql.launcher;
  20  
  21  import com.dtstack.flink.sql.enums.ClusterMode;
  22  import com.dtstack.flink.sql.option.Options;
  23  import com.dtstack.flink.sql.util.PluginUtil;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  24 +import com.esotericsoftware.minlog.Log;</span>
  25  import org.apache.commons.io.Charsets;
  26  import org.apache.commons.lang.StringUtils;
  27  import org.apache.flink.client.program.ClusterClient;
  28  import org.apache.flink.client.program.MiniClusterClient;
  29  import org.apache.flink.configuration.ConfigConstants;
  30  import org.apache.flink.configuration.Configuration;
  31  import org.apache.flink.configuration.GlobalConfiguration;
  32  import org.apache.flink.configuration.JobManagerOptions;
  33  import org.apache.flink.core.fs.FileSystem;
  34  import org.apache.flink.runtime.akka.AkkaUtils;
  35  import org.apache.flink.runtime.minicluster.MiniCluster;
  36  import org.apache.flink.runtime.minicluster.MiniClusterConfiguration;
  37  import org.apache.flink.runtime.util.LeaderConnectionInfo;
  38  import org.apache.flink.yarn.AbstractYarnClusterDescriptor;
  39  import org.apache.flink.yarn.YarnClusterDescriptor;
  40  import org.apache.hadoop.yarn.api.records.ApplicationId;
  41  import org.apache.hadoop.yarn.api.records.ApplicationReport;
  42  import org.apache.hadoop.yarn.api.records.YarnApplicationState;
  43  import org.apache.hadoop.yarn.client.api.YarnClient;
  44  import org.apache.hadoop.yarn.conf.YarnConfiguration;
  45  import org.apache.hadoop.yarn.util.StringHelper;
  46  
  47  import java.net.InetSocketAddress;
  48  import java.net.URLDecoder;
  49  import java.util.EnumSet;
  50  import java.util.HashSet;
  51  import java.util.Iterator;
  52  import java.util.List;
  53  import java.util.Properties;
  54  import java.util.Set;
  55  
  56  /**
  57   * @author sishu.yss
  58   */
  59  public class ClusterClientFactory {
  60  
  61      public static ClusterClient createClusterClient(Options launcherOptions) throws Exception {
  62          String mode = launcherOptions.getMode();
  63          if (mode.equals(ClusterMode.standalone.name())) {
  64              return createStandaloneClient(launcherOptions);
  65          } else if (mode.equals(ClusterMode.yarn.name())) {
  66              return createYarnSessionClient(launcherOptions);
  67          }
  68          throw new IllegalArgumentException(&quot;Unsupported cluster client type: &quot;);
  69      }
  70  
  71      public static ClusterClient createStandaloneClient(Options launcherOptions) throws Exception {
  72          String flinkConfDir = launcherOptions.getFlinkconf();
  73          Configuration config = GlobalConfiguration.loadConfiguration(flinkConfDir);
  74          MiniClusterConfiguration.Builder configBuilder = new MiniClusterConfiguration.Builder();
  75          configBuilder.setConfiguration(config);
  76          MiniCluster miniCluster = new MiniCluster(configBuilder.build());
  77          MiniClusterClient clusterClient = new MiniClusterClient(config, miniCluster);
  78          LeaderConnectionInfo connectionInfo = clusterClient.getClusterConnectionInfo();
  79          InetSocketAddress address = AkkaUtils.getInetSocketAddressFromAkkaURL(connectionInfo.getAddress());
  80          config.setString(JobManagerOptions.ADDRESS, address.getAddress().getHostName());
  81          config.setInteger(JobManagerOptions.PORT, address.getPort());
  82          clusterClient.setDetached(true);
  83          return clusterClient;
  84      }
  85  
  86      public static ClusterClient createYarnSessionClient(Options launcherOptions) {
<abbr title="  87          String flinkConfDir = StringUtils.isEmpty(launcherOptions.getFlinkconf()) ? &quot;&quot; : launcherOptions.getFlinkconf();">  87          String flinkConfDir = StringUtils.isEmpty(launcherOptions.getFlinkconf()) ? &quot;&quot; : launcherOptions.getFlinkcðŸ”µ</abbr>
<abbr title="  88          Configuration config = StringUtils.isEmpty(flinkConfDir) ? new Configuration() : GlobalConfiguration.loadConfiguration(flinkConfDir);">  88          Configuration config = StringUtils.isEmpty(flinkConfDir) ? new Configuration() : GlobalConfiguration.loadCðŸ”µ</abbr>
  89          String yarnConfDir = launcherOptions.getYarnconf();
  90  
  91          if (StringUtils.isNotBlank(yarnConfDir)) {
  92              try {
  93                  config.setString(ConfigConstants.PATH_HADOOP_CONFIG, yarnConfDir);
  94                  FileSystem.initialize(config, null);
  95  
  96                  YarnConfiguration yarnConf = YarnConfLoader.getYarnConf(yarnConfDir);
  97                  YarnClient yarnClient = YarnClient.createYarnClient();
  98                  yarnClient.init(yarnConf);
  99                  yarnClient.start();
 100                  ApplicationId applicationId = null;
 101  
 102                  String yarnSessionConf = launcherOptions.getYarnSessionConf();
 103                  yarnSessionConf = URLDecoder.decode(yarnSessionConf, Charsets.UTF_8.toString());
<abbr title=" 104                  Properties yarnSessionConfProperties = PluginUtil.jsonStrToObject(yarnSessionConf, Properties.class);"> 104                  Properties yarnSessionConfProperties = PluginUtil.jsonStrToObject(yarnSessionConf, Properties.clasðŸ”µ</abbr>
 105                  Object yid = yarnSessionConfProperties.get(&quot;yid&quot;);
 106  
 107                  if (null != yid) {
 108                      applicationId = toApplicationId(yid.toString());
 109                  } else {
 110                      applicationId = getYarnClusterApplicationId(yarnClient);
 111                  }
 112  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 113 -                System.out.println(&quot;applicationId=&quot; + applicationId.toString());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 114 +                Log.info(&quot;applicationId={}&quot;, applicationId.toString());</span>
 115  
 116                  if (StringUtils.isEmpty(applicationId.toString())) {
 117                      throw new RuntimeException(&quot;No flink session found on yarn cluster.&quot;);
 118                  }
 119  
<abbr title=" 120                  AbstractYarnClusterDescriptor clusterDescriptor = new YarnClusterDescriptor(config, yarnConf, flinkConfDir, yarnClient, false);"> 120                  AbstractYarnClusterDescriptor clusterDescriptor = new YarnClusterDescriptor(config, yarnConf, flinðŸ”µ</abbr>
 121                  ClusterClient clusterClient = clusterDescriptor.retrieve(applicationId);
 122                  clusterClient.setDetached(true);
 123                  return clusterClient;
 124              } catch (Exception e) {
 125                  throw new RuntimeException(e);
 126              }
 127          }else{
 128              throw new RuntimeException(&quot;yarn mode must set param of &#x27;yarnconf&#x27;!!!&quot;);
 129          }
 130      }
 131  
 132  
 133      private static ApplicationId getYarnClusterApplicationId(YarnClient yarnClient) throws Exception {
 134          ApplicationId applicationId = null;
 135  
 136          Set&lt;String&gt; set = new HashSet&lt;&gt;();
 137          set.add(&quot;Apache Flink&quot;);
 138          EnumSet&lt;YarnApplicationState&gt; enumSet = EnumSet.noneOf(YarnApplicationState.class);
 139          enumSet.add(YarnApplicationState.RUNNING);
 140          List&lt;ApplicationReport&gt; reportList = yarnClient.getApplications(set, enumSet);
 141  
 142          int maxMemory = -1;
 143          int maxCores = -1;
 144          for (ApplicationReport report : reportList) {
 145              if (!report.getName().startsWith(&quot;Flink session&quot;)) {
 146                  continue;
 147              }
 148  
 149              if (!report.getYarnApplicationState().equals(YarnApplicationState.RUNNING)) {
 150                  continue;
 151              }
 152  
 153              int thisMemory = report.getApplicationResourceUsageReport().getNeededResources().getMemory();
 154              int thisCores = report.getApplicationResourceUsageReport().getNeededResources().getVirtualCores();
 155              if (thisMemory &gt; maxMemory || thisMemory == maxMemory &amp;&amp; thisCores &gt; maxCores) {
 156                  maxMemory = thisMemory;
 157                  maxCores = thisCores;
 158                  applicationId = report.getApplicationId();
 159              }
 160  
 161          }
 162  
 163          if (StringUtils.isEmpty(applicationId.toString())) {
 164              throw new RuntimeException(&quot;No flink session found on yarn cluster.&quot;);
 165          }
 166          return applicationId;
 167      }
 168  
 169      private static ApplicationId toApplicationId(String appIdStr) {
 170          Iterator&lt;String&gt; it = StringHelper._split(appIdStr).iterator();
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 171 -        if (!(it.next()).equals(&quot;application&quot;)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 172 +        if (!&quot;application&quot;.equals(it.next())) {</span>
<abbr title=" 173              throw new IllegalArgumentException(&quot;Invalid ApplicationId prefix: &quot; + appIdStr + &quot;. The valid ApplicationId should start with prefix &quot; + &quot;application&quot;);"> 173              throw new IllegalArgumentException(&quot;Invalid ApplicationId prefix: &quot; + appIdStr + &quot;. The valid ApplicatðŸ”µ</abbr>
 174          } else {
 175              try {
 176                  return toApplicationId(it);
 177              } catch (NumberFormatException e) {
 178                  throw new IllegalArgumentException(&quot;Invalid AppAttemptId: &quot; + appIdStr, e);
 179              }
 180          }
 181      }
 182  
 183      private static ApplicationId toApplicationId(Iterator&lt;String&gt; it) throws NumberFormatException {
 184          return ApplicationId.newInstance(Long.parseLong(it.next()), Integer.parseInt(it.next()));
 185      }
 186  
 187  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            