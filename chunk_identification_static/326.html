<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>326</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    326
                    <a href="325.html">prev</a>
                    <a href="327.html">next</a>
                    <a href="326_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    Cybereason/Logout4Shell_f5b8576194dd61c99ba013d48ddaf2338d4a0bea_src/main/java/Log4jRCE.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Cybereason\Logout4Shell show &quot;f5b8576194dd61c99ba013d48ddaf2338d4a0bea:src/main/java/Log4jRCE.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Cybereason\Logout4Shell show &quot;f5b8576194dd61c99ba013d48ddaf2338d4a0bea^1:src/main/java/Log4jRCE.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Cybereason\Logout4Shell show &quot;f5b8576194dd61c99ba013d48ddaf2338d4a0bea^2:src/main/java/Log4jRCE.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Cybereason\Logout4Shell show &quot;cff871be4a27c0c5a8acf585ecb20748fc7628e2:src/main/java/Log4jRCE.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[bs], [b], [j], [j], [j]], subset: [[sbj], [bj]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 /* Commented out because they are only needed for another commented-out
   2    code block.
   3 --- BEGIN COMMENTED OUT CODE ---
   4 import jdk.internal.org.objectweb.asm.ClassReader;
   5 import jdk.internal.org.objectweb.asm.ClassWriter;
   6 import jdk.internal.org.objectweb.asm.Opcodes;
   7 import jdk.internal.org.objectweb.asm.tree.*;
   8 import java.io.ByteArrayOutputStream;
   9 import java.util.Optional;
  10 --- END COMMENTED OUT CODE ---
  11  */
  12 import org.apache.logging.log4j.core.LoggerContext;
  13 import org.apache.logging.log4j.core.config.Configuration;
  14 import org.apache.logging.log4j.core.lookup.Interpolator;
  15 import org.apache.logging.log4j.core.lookup.StrLookup;
  16 import org.apache.logging.log4j.core.selector.ContextSelector;
  17 
  18 import java.io.*;
  19 import java.lang.reflect.Field;
  20 import java.lang.reflect.Method;
  21 import java.lang.reflect.Modifier;
  22 import java.net.URL;
  23 import java.util.Base64;
  24 import java.util.zip.ZipEntry;
  25 import java.util.zip.ZipInputStream;
  26 import java.util.zip.ZipOutputStream;
  27 import java.util.Map;
  28 
  29 public class Log4jRCE {
  30     static {
  31         Class&lt;?&gt; c = null;
  32         try {
  33             try { // Try for versions of Log4j &gt;= 2.10
<abbr title="  34                 c = Thread.currentThread().getContextClassLoader().loadClass(&quot;org.apache.logging.log4j.core.util.Constants&quot;);">  34                 c = Thread.currentThread().getContextClassLoader().loadClass(&quot;org.apache.logging.log4j.coðŸ”µ</abbr>
  35                 Field field = c.getField(&quot;FORMAT_MESSAGES_PATTERN_DISABLE_LOOKUPS&quot;);
  36                 System.out.println(&quot;Setting &quot; + field.getName() + &quot; value to True&quot;);
  37                 setAccess(field);
  38                 field.set(null, Boolean.TRUE);
  39             } catch (Throwable e) { // Fall back to older versions. Try to make JNDI non instantiable
  40                 c = null;
<abbr title="  41                 System.err.println(&quot;No field FORMAT_MESSAGES_PATTERN_DISABLE_LOOKUPS - version &lt;= 2.9.0&quot;);">  41                 System.err.println(&quot;No field FORMAT_MESSAGES_PATTERN_DISABLE_LOOKUPS - version &lt;= 2.9.0&quot;)ðŸ”µ</abbr>
  42                 System.err.println(&quot;Will attempt to modify the configuration directly&quot;);
  43             }
  44 
  45             // Reconfigure log4j
  46             ClassLoader classLoader = Thread.currentThread().getContextClassLoader();
  47 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  48             c = classLoader.loadClass(&quot;org.apache.logging.log4j.core.config.Configurator&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  49             try {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  50                 Method reconfigure = c.getMethod(&quot;reconfigure&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  51                 reconfigure.invoke(null);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  52             } catch (Exception ex) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  53                 // Log4j is probably older.</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  54                 Method getFactoryMethod = c.getDeclaredMethod(&quot;getFactory&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  55                 getFactoryMethod.setAccessible(true);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  56                 Object factory = getFactoryMethod.invoke(null);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title="  57                 Class&lt;?&gt; log4jContextFactoryClass = classLoader.loadClass(&quot;org.apache.logging.log4j.core.impl.Log4jContextFactory&quot;);">  57                 Class&lt;?&gt; log4jContextFactoryClass = classLoader.loadClass(&quot;org.apache.logging.log4j.core.ðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  58                 Method getSelector = log4jContextFactoryClass.getMethod(&quot;getSelector&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  59                 Object contextSelector = getSelector.invoke(factory, (Object[]) null);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  60                 ContextSelector ctxSelector = (ContextSelector) contextSelector;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  61                 for (LoggerContext ctx: ctxSelector.getLoggerContexts()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  62                     ctx.reconfigure();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  63                     System.err.println(&quot;Reconfiguring context&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  64                     Configuration config = ctx.getConfiguration();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  65                     StrLookup resolver = config.getStrSubstitutor().getVariableResolver();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  66                     if (resolver instanceof Interpolator) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  67                         System.err.println(&quot;Lookup is an Interpolator - attempting to remove JNDI&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  68                         Field lookups;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  69                         //noinspection RedundantSuppression</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  70                         try {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  71                             //noinspection JavaReflectionMemberAccess</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  72                             lookups = Interpolator.class.getDeclaredField(&quot;lookups&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  73                         } catch (NoSuchFieldException e) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  74                             //noinspection JavaReflectionMemberAccess</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  75                             lookups = Interpolator.class.getDeclaredField(&quot;strLookupMap&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  76                         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  77                         lookups.setAccessible(true);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title="  78                         Map&lt;String, StrLookup&gt; lookupMap = (Map&lt;String, StrLookup&gt;) lookups.get(resolver);">  78                         Map&lt;String, StrLookup&gt; lookupMap = (Map&lt;String, StrLookup&gt;) lookups.get(resolver)ðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  79                         lookupMap.remove(&quot;jndi&quot;);</span>
  80 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="  81             Class&lt;?&gt; configuratorClass = classLoader.loadClass(&quot;org.apache.logging.log4j.core.config.Configurator&quot;);">  81             Class&lt;?&gt; configuratorClass = classLoader.loadClass(&quot;org.apache.logging.log4j.core.config.ConfðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  82             try {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  83                 Method reconfigure = configuratorClass.getMethod(&quot;reconfigure&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  84                 reconfigure.invoke(null);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  85             } catch (Exception ex) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  86                 Method getFactoryMethod = configuratorClass.getDeclaredMethod(&quot;getFactory&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  87                 getFactoryMethod.setAccessible(true);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  88                 Object factory = getFactoryMethod.invoke(null);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="  89                 Class&lt;?&gt; log4jContextFactoryClass = classLoader.loadClass(&quot;org.apache.logging.log4j.core.impl.Log4jContextFactory&quot;);">  89                 Class&lt;?&gt; log4jContextFactoryClass = classLoader.loadClass(&quot;org.apache.logging.log4j.core.ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  90                 Method getSelector = log4jContextFactoryClass.getMethod(&quot;getSelector&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  91                 Object contextSelector = getSelector.invoke(factory, null);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  92                 ContextSelector ctxSelector = (ContextSelector) contextSelector;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  93                 for (LoggerContext ctx: ctxSelector.getLoggerContexts()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  94                     ctx.reconfigure();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  95                     System.err.println(&quot;Reconfiguring context&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  96                     Configuration config = ctx.getConfiguration();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  97                     StrLookup resolver = config.getStrSubstitutor().getVariableResolver();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  98                     if (resolver instanceof Interpolator) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  99                         System.err.println(&quot;Lookup is an Interpolator - attempting to remove JNDI&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 100                         Field lookups = null;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 101                         try {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 102                             lookups = Interpolator.class.getDeclaredField(&quot;lookups&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 103                         } catch (NoSuchFieldException e) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 104                             lookups = Interpolator.class.getDeclaredField(&quot;strLookupMap&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 105                         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 106                         lookups.setAccessible(true);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 107                         Map&lt;String, StrLookup&gt; lookupMap = (Map&lt;String, StrLookup&gt;) lookups.get(resolver);"> 107                         Map&lt;String, StrLookup&gt; lookupMap = (Map&lt;String, StrLookup&gt;) lookups.get(resolver)ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 108                         lookupMap.remove(&quot;jndi&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 109                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 110                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 111             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 112         } catch (Exception e) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 113             System.err.println(&quot;Exception &quot; + e);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 114             e.printStackTrace();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 115         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 116     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 117 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 118     static void setFinalStatic(Field field, Object newValue) throws Exception {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 119         setAccess(field);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 120         field.set(null, newValue);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 121     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 122 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 123     private static void setAccess(Field field) throws NoSuchFieldException, IllegalAccessException {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 124         field.setAccessible(true);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 125         Field modifiersField = Field.class.getDeclaredField(&quot;modifiers&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 126         modifiersField.setAccessible(true);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 127         modifiersField.setInt(field, field.getModifiers() &amp; ~Modifier.FINAL);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 128     }</span>
 129 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 130             Class&lt;?&gt; configuratorClass = classLoader.loadClass(&quot;org.apache.logging.log4j.core.config.Configurator&quot;);"> 130             Class&lt;?&gt; configuratorClass = classLoader.loadClass(&quot;org.apache.logging.log4j.core.config.ConfðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 131 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 132             // Due to CVE-2021-45046 we&#x27;re no longer using the reconfigure method -</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 133             // Instead we reconfigure the logger but *also* remove the JNDI listener from the plugin map</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 134             //try {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 135             //    Method reconfigure = configuratorClass.getMethod(&quot;reconfigure&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 136             //    reconfigure.invoke(null);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 137             //} catch (Exception ex) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 138 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 139             Method getFactoryMethod = configuratorClass.getDeclaredMethod(&quot;getFactory&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 140             getFactoryMethod.setAccessible(true);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 141             Object factory = getFactoryMethod.invoke(null);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 142             Class&lt;?&gt; log4jContextFactoryClass = classLoader.loadClass(&quot;org.apache.logging.log4j.core.impl.Log4jContextFactory&quot;);"> 142             Class&lt;?&gt; log4jContextFactoryClass = classLoader.loadClass(&quot;org.apache.logging.log4j.core.implðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 143             Method getSelector = log4jContextFactoryClass.getMethod(&quot;getSelector&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 144             Object contextSelector = getSelector.invoke(factory, null);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 145             ContextSelector ctxSelector = (ContextSelector) contextSelector;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 146             for (LoggerContext ctx: ctxSelector.getLoggerContexts()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 147                 // The following deadlocks in some tests when using ThreadContext attacks</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 148                 //ctx.reconfigure();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 149                 Configuration config = ctx.getConfiguration();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 150                 StrLookup resolver = config.getStrSubstitutor().getVariableResolver();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 151                 if (resolver instanceof Interpolator) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 152                     System.err.println(&quot;Lookup is an Interpolator - removing JNDI&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 153                     Field lookups = null;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 154                     try {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 155                         lookups = Interpolator.class.getDeclaredField(&quot;lookups&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 156                     } catch (NoSuchFieldException e) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 157                         lookups = Interpolator.class.getDeclaredField(&quot;strLookupMap&quot;);</span>
 158 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 159                     }
 160                     lookups.setAccessible(true);
 161                     Map&lt;String, StrLookup&gt; lookupMap = (Map&lt;String, StrLookup&gt;) lookups.get(resolver);
 162                     lookupMap.remove(&quot;jndi&quot;);
 163                 }
 164             }
 165 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 166         } catch (Throwable e) {</span>
 167 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 168         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 169     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 170 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 171     static void setFinalStatic(Field field, Object newValue) throws Exception {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 172         setAccess(field);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 173         field.set(null, newValue);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 174     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 175 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 176     private static void setAccess(Field field) throws NoSuchFieldException, IllegalAccessException {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 177         field.setAccessible(true);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 178         Field modifiersField = Field.class.getDeclaredField(&quot;modifiers&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 179         modifiersField.setAccessible(true);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 180         modifiersField.setInt(field, field.getModifiers() &amp; ~Modifier.FINAL);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 181     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 182 }</span>
 183 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 184 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 185             //}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 186         } catch (Exception e) {</span>
 187 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 188             System.err.println(&quot;Exception &quot; + e);
 189             e.printStackTrace();
 190         }
 191 
 192         // Modify the log4j jar to fix the vulnerability permanently
 193         if(c != null)
 194             fullyVaccinate(c.getProtectionDomain().getCodeSource().getLocation());
 195     }
 196 
 197     private static void fullyVaccinate(URL jarfile) {
 198         String path = jarfile.getFile();
 199         File jar = new File(path);
 200         if(path.endsWith(&quot;.jar&quot;)) {
 201             try {
 202                 File fixedjar = new File(&quot;log4j.jar.tmp&quot;);
 203                 ZipInputStream in = new ZipInputStream(new FileInputStream(path));
 204                 ZipOutputStream out = new ZipOutputStream(new FileOutputStream(fixedjar));
 205                 ZipEntry entry;
 206                 while ((entry = in.getNextEntry()) != null) {
 207                     out.putNextEntry(new ZipEntry(entry.getName()));
 208                     switch (entry.getName()) {
 209                         case &quot;org/apache/logging/log4j/core/util/Constants.class&quot;:
<abbr title=" 210                             // base64 of the patched class (FORMAT_MESSAGES_PATTERN_DISABLE_LOOKUPS set to default false)"> 210                             // base64 of the patched class (FORMAT_MESSAGES_PATTERN_DISABLE_LOOKUPS set tðŸ”µ</abbr>
 211                             // base64 is more compact than a byte array in source code.
 212                             byte[] newClass = Base64.getDecoder().decode(&quot;&quot; +
<abbr title=" 213                                     &quot;yv66vgAAADQAZAEALG9yZy9hcGFjaGUvbG9nZ2luZy9sb2c0ai9jb3JlL3V0aWwvQ29uc3RhbnRz&quot; +"> 213                                     &quot;yv66vgAAADQAZAEALG9yZy9hcGFjaGUvbG9nZ2luZy9sb2c0ai9jb3JlL3V0aWwvQ29uðŸ”µ</abbr>
<abbr title=" 214                                     &quot;BwABAQAQamF2YS9sYW5nL09iamVjdAcAAwEADkNvbnN0YW50cy5qYXZhAQAXTE9HNEpfTE9HX0VW&quot; +"> 214                                     &quot;BwABAQAQamF2YS9sYW5nL09iamVjdAcAAwEADkNvbnN0YW50cy5qYXZhAQAXTE9HNEpfðŸ”µ</abbr>
<abbr title=" 215                                     &quot;RU5UX0ZBQ1RPUlkBABJMamF2YS9sYW5nL1N0cmluZzsBABRMb2c0akxvZ0V2ZW50RmFjdG9yeQgA&quot; +"> 215                                     &quot;RU5UX0ZBQ1RPUlkBABJMamF2YS9sYW5nL1N0cmluZzsBABRMb2c0akxvZ0V2ZW50RmFjðŸ”µ</abbr>
<abbr title=" 216                                     &quot;CAEAFkxPRzRKX0NPTlRFWFRfU0VMRUNUT1IBABRMb2c0akNvbnRleHRTZWxlY3RvcggACwEAGkxP&quot; +"> 216                                     &quot;CAEAFkxPRzRKX0NPTlRFWFRfU0VMRUNUT1IBABRMb2c0akNvbnRleHRTZWxlY3RvcggAðŸ”µ</abbr>
<abbr title=" 217                                     &quot;RzRKX0RFRkFVTFRfU1RBVFVTX0xFVkVMAQAXTG9nNGpEZWZhdWx0U3RhdHVzTGV2ZWwIAA4BABFK&quot; +"> 217                                     &quot;RzRKX0RFRkFVTFRfU1RBVFVTX0xFVkVMAQAXTG9nNGpEZWZhdWx0U3RhdHVzTGV2ZWwIðŸ”µ</abbr>
<abbr title=" 218                                     &quot;TkRJX0NPTlRFWFRfTkFNRQEAIGphdmE6Y29tcC9lbnYvbG9nNGovY29udGV4dC1uYW1lCAARAQAR&quot; +"> 218                                     &quot;TkRJX0NPTlRFWFRfTkFNRQEAIGphdmE6Y29tcC9lbnYvbG9nNGovY29udGV4dC1uYW1lðŸ”µ</abbr>
<abbr title=" 219                                     &quot;TUlMTElTX0lOX1NFQ09ORFMBAAFJAwAAA+gBAB1GT1JNQVRfTUVTU0FHRVNfSU5fQkFDS0dST1VO&quot; +"> 219                                     &quot;TUlMTElTX0lOX1NFQ09ORFMBAAFJAwAAA+gBAB1GT1JNQVRfTUVTU0FHRVNfSU5fQkFDðŸ”µ</abbr>
<abbr title=" 220                                     &quot;RAEAAVoBACdGT1JNQVRfTUVTU0FHRVNfUEFUVEVSTl9ESVNBQkxFX0xPT0tVUFMBAApJU19XRUJf&quot; +"> 220                                     &quot;RAEAAVoBACdGT1JNQVRfTUVTU0FHRVNfUEFUVEVSTl9ESVNBQkxFX0xPT0tVUFMBAApJðŸ”µ</abbr>
<abbr title=" 221                                     &quot;QVBQAQATRU5BQkxFX1RIUkVBRExPQ0FMUwEAFkVOQUJMRV9ESVJFQ1RfRU5DT0RFUlMBAB1JTklU&quot; +"> 221                                     &quot;QVBQAQATRU5BQkxFX1RIUkVBRExPQ0FMUwEAFkVOQUJMRV9ESVJFQ1RfRU5DT0RFUlMBðŸ”µ</abbr>
<abbr title=" 222                                     &quot;SUFMX1JFVVNBQkxFX01FU1NBR0VfU0laRQEAGU1BWF9SRVVTQUJMRV9NRVNTQUdFX1NJWkUBABhF&quot; +"> 222                                     &quot;SUFMX1JFVVNBQkxFX01FU1NBR0VfU0laRQEAGU1BWF9SRVVTQUJMRV9NRVNTQUdFX1NJðŸ”µ</abbr>
<abbr title=" 223                                     &quot;TkNPREVSX0NIQVJfQlVGRkVSX1NJWkUBABhFTkNPREVSX0JZVEVfQlVGRkVSX1NJWkUBAARzaXpl&quot; +"> 223                                     &quot;TkNPREVSX0NIQVJfQlVGRkVSX1NJWkUBABhFTkNPREVSX0JZVEVfQlVGRkVSX1NJWkUBðŸ”µ</abbr>
<abbr title=" 224                                     &quot;AQAWKExqYXZhL2xhbmcvU3RyaW5nO0kpSQEACHByb3BlcnR5AQAMZGVmYXVsdFZhbHVlAQAsb3Jn&quot; +"> 224                                     &quot;AQAWKExqYXZhL2xhbmcvU3RyaW5nO0kpSQEACHByb3BlcnR5AQAMZGVmYXVsdFZhbHVlðŸ”µ</abbr>
<abbr title=" 225                                     &quot;L2FwYWNoZS9sb2dnaW5nL2xvZzRqL3V0aWwvUHJvcGVydGllc1V0aWwHACQBAA1nZXRQcm9wZXJ0&quot; +"> 225                                     &quot;L2FwYWNoZS9sb2dnaW5nL2xvZzRqL3V0aWwvUHJvcGVydGllc1V0aWwHACQBAA1nZXRQðŸ”µ</abbr>
<abbr title=" 226                                     &quot;aWVzAQAwKClMb3JnL2FwYWNoZS9sb2dnaW5nL2xvZzRqL3V0aWwvUHJvcGVydGllc1V0aWw7DAAm&quot; +"> 226                                     &quot;aWVzAQAwKClMb3JnL2FwYWNoZS9sb2dnaW5nL2xvZzRqL3V0aWwvUHJvcGVydGllc1V0ðŸ”µ</abbr>
<abbr title=" 227                                     &quot;ACcKACUAKAEAEmdldEludGVnZXJQcm9wZXJ0eQwAKgAhCgAlACsBAAY8aW5pdD4BAAMoKVYMAC0A&quot; +"> 227                                     &quot;ACcKACUAKAEAEmdldEludGVnZXJQcm9wZXJ0eQwAKgAhCgAlACsBAAY8aW5pdD4BAAMoðŸ”µ</abbr>
<abbr title=" 228                                     &quot;LgoABAAvAQAEdGhpcwEALkxvcmcvYXBhY2hlL2xvZ2dpbmcvbG9nNGovY29yZS91dGlsL0NvbnN0&quot; +"> 228                                     &quot;LgoABAAvAQAEdGhpcwEALkxvcmcvYXBhY2hlL2xvZ2dpbmcvbG9nNGovY29yZS91dGlsðŸ”µ</abbr>
<abbr title=" 229                                     &quot;YW50czsBAAg8Y2xpbml0PgEAFmxvZzRqLmZvcm1hdC5tc2cuYXN5bmMIADQBABJnZXRCb29sZWFu&quot; +"> 229                                     &quot;YW50czsBAAg8Y2xpbml0PgEAFmxvZzRqLmZvcm1hdC5tc2cuYXN5bmMIADQBABJnZXRCðŸ”µ</abbr>
<abbr title=" 230                                     &quot;UHJvcGVydHkBABYoTGphdmEvbGFuZy9TdHJpbmc7WilaDAA2ADcKACUAOAwAFgAXCQACADoBABls&quot; +"> 230                                     &quot;UHJvcGVydHkBABYoTGphdmEvbGFuZy9TdHJpbmc7WilaDAA2ADcKACUAOAwAFgAXCQACðŸ”µ</abbr>
<abbr title=" 231                                     &quot;b2c0ajIuZm9ybWF0TXNnTm9Mb29rdXBzCAA8DAAYABcJAAIAPgEAJ29yZy9hcGFjaGUvbG9nZ2lu&quot; +"> 231                                     &quot;b2c0ajIuZm9ybWF0TXNnTm9Mb29rdXBzCAA8DAAYABcJAAIAPgEAJ29yZy9hcGFjaGUvðŸ”µ</abbr>
<abbr title=" 232                                     &quot;Zy9sb2c0ai91dGlsL0NvbnN0YW50cwcAQAwAGQAXCQBBAEIJAAIAQgwAGgAXCQBBAEUJAAIARQEA&quot; +"> 232                                     &quot;Zy9sb2c0ai91dGlsL0NvbnN0YW50cwcAQAwAGQAXCQBBAEIJAAIAQgwAGgAXCQBBAEUJðŸ”µ</abbr>
<abbr title=" 233                                     &quot;HWxvZzRqMi5lbmFibGUuZGlyZWN0LmVuY29kZXJzCABIDAAbABcJAAIASgEAHGxvZzRqLmluaXRp&quot; +"> 233                                     &quot;HWxvZzRqMi5lbmFibGUuZGlyZWN0LmVuY29kZXJzCABIDAAbABcJAAIASgEAHGxvZzRqðŸ”µ</abbr>
<abbr title=" 234                                     &quot;YWxSZXVzYWJsZU1zZ1NpemUIAEwMACAAIQoAAgBODAAcABQJAAIAUAEAGGxvZzRqLm1heFJldXNh&quot; +"> 234                                     &quot;YWxSZXVzYWJsZU1zZ1NpemUIAEwMACAAIQoAAgBODAAcABQJAAIAUAEAGGxvZzRqLm1hðŸ”µ</abbr>
<abbr title=" 235                                     &quot;YmxlTXNnU2l6ZQgAUgwAHQAUCQACAFQBABxsb2c0ai5lbmNvZGVyLmNoYXJCdWZmZXJTaXplCABW&quot; +"> 235                                     &quot;YmxlTXNnU2l6ZQgAUgwAHQAUCQACAFQBABxsb2c0ai5lbmNvZGVyLmNoYXJCdWZmZXJTðŸ”µ</abbr>
<abbr title=" 236                                     &quot;DAAeABQJAAIAWAEAHGxvZzRqLmVuY29kZXIuYnl0ZUJ1ZmZlclNpemUIAFoMAB8AFAkAAgBcAQAN&quot; +"> 236                                     &quot;DAAeABQJAAIAWAEAHGxvZzRqLmVuY29kZXIuYnl0ZUJ1ZmZlclNpemUIAFoMAB8AFAkAðŸ”µ</abbr>
<abbr title=" 237                                     &quot;Q29uc3RhbnRWYWx1ZQEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBABJMb2NhbFZhcmlhYmxlVGFi&quot; +"> 237                                     &quot;Q29uc3RhbnRWYWx1ZQEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBABJMb2NhbFZhcmlhðŸ”µ</abbr>
<abbr title=" 238                                     &quot;bGUBABBNZXRob2RQYXJhbWV0ZXJzAQAKU291cmNlRmlsZQAxAAIABAAAAA4AGQAGAAcAAQBeAAAA&quot; +"> 238                                     &quot;bGUBABBNZXRob2RQYXJhbWV0ZXJzAQAKU291cmNlRmlsZQAxAAIABAAAAA4AGQAGAAcAðŸ”µ</abbr>
<abbr title=" 239                                     &quot;AgAJABkACgAHAAEAXgAAAAIADAAZAA0ABwABAF4AAAACAA8AGQAQAAcAAQBeAAAAAgASABkAEwAU&quot; +"> 239                                     &quot;AgAJABkACgAHAAEAXgAAAAIADAAZAA0ABwABAF4AAAACAA8AGQAQAAcAAQBeAAAAAgASðŸ”µ</abbr>
<abbr title=" 240                                     &quot;AAEAXgAAAAIAFQAZABYAFwAAABkAGAAXAAAAGQAZABcAAAAZABoAFwAAABkAGwAXAAAAGQAcABQA&quot; +"> 240                                     &quot;AAEAXgAAAAIAFQAZABYAFwAAABkAGAAXAAAAGQAZABcAAAAZABoAFwAAABkAGwAXAAAAðŸ”µ</abbr>
<abbr title=" 241                                     &quot;AAAZAB0AFAAAABkAHgAUAAAAGQAfABQAAAADAAoAIAAhAAIAXwAAAD0AAwACAAAACbgAKSobtgAs&quot; +"> 241                                     &quot;AAAZAB0AFAAAABkAHgAUAAAAGQAfABQAAAADAAoAIAAhAAIAXwAAAD0AAwACAAAACbgAðŸ”µ</abbr>
<abbr title=" 242                                     &quot;rAAAAAIAYAAAAAYAAQAAAIwAYQAAABYAAgAAAAkAIgAHAAAAAAAJACMAFAABAGIAAAAJAgAiABAA&quot; +"> 242                                     &quot;rAAAAAIAYAAAAAYAAQAAAIwAYQAAABYAAgAAAAkAIgAHAAAAAAAJACMAFAABAGIAAAAJðŸ”µ</abbr>
<abbr title=" 243                                     &quot;IwAQAAIALQAuAAEAXwAAADMAAQABAAAABSq3ADCxAAAAAgBgAAAACgACAAAAkgAEAJMAYQAAAAwA&quot; +"> 243                                     &quot;IwAQAAIALQAuAAEAXwAAADMAAQABAAAABSq3ADCxAAAAAgBgAAAACgACAAAAkgAEAJMAðŸ”µ</abbr>
<abbr title=" 244                                     &quot;AQAAAAUAMQAyAAAACAAzAC4AAQBfAAAAlQADAAAAAABduAApEjUDtgA5swA7uAApEj0EtgA5swA/&quot; +"> 244                                     &quot;AQAAAAUAMQAyAAAACAAzAC4AAQBfAAAAlQADAAAAAABduAApEjUDtgA5swA7uAApEj0EðŸ”µ</abbr>
<abbr title=" 245                                     &quot;sgBDswBEsgBGswBHuAApEkkEtgA5swBLEk0RAIC4AE+zAFESUxECBrgAT7MAVRJXEQgAuABPswBZ&quot; +"> 245                                     &quot;sgBDswBEsgBGswBHuAApEkkEtgA5swBLEk0RAIC4AE+zAFESUxECBrgAT7MAVRJXEQgAðŸ”µ</abbr>
<abbr title=" 246                                     &quot;ElsRIAC4AE+zAF2xAAAAAQBgAAAAJgAJAAAANgAMAD8AGABHAB4AUQAkAF4AMABqADsAdQBGAH4A&quot; +"> 246                                     &quot;ElsRIAC4AE+zAF2xAAAAAQBgAAAAJgAJAAAANgAMAD8AGABHAB4AUQAkAF4AMABqADsAðŸ”µ</abbr>
 247                                     &quot;UQCIAAEAYwAAAAIABQ==&quot;);
 248                             out.write(newClass);
 249                             break;
 250                         /* Commented out because of compatibility issues - JNDI will be deleted instead
 251                            (which will help in almost the same way).
 252                         --- BEGIN COMMENTED OUT CODE ---
 253                         case &quot;org/apache/logging/log4j/core/lookup/Interpolator&quot;:
 254                             try {
 255                                 // Read class
 256                                 ByteArrayOutputStream baos = new ByteArrayOutputStream();
 257                                 byte[] buf = new byte[4096];
 258                                 int i;
 259                                 while ((i = in.read(buf)) &gt; 0) {
 260                                     baos.write(buf, 0, i);
 261                                 }
 262                                 ClassReader classReader = new ClassReader(baos.toByteArray());
 263                                 ClassNode node = new ClassNode();
 264                                 classReader.accept(node, 0);
 265 
 266                                 FieldNode fn;
 267                                 {
<abbr title=" 268                                     Optional&lt;FieldNode&gt; optionalFieldNode = node.fields.stream().filter(fieldNode -&gt; fieldNode.desc.contains(&quot;Map&quot;)).findFirst();"> 268                                     Optional&lt;FieldNode&gt; optionalFieldNode = node.fields.stream().filter(fðŸ”µ</abbr>
 269                                     if(optionalFieldNode.isPresent())
 270                                         fn = optionalFieldNode.get();
 271                                     else
 272                                         throw new NoSuchFieldException(); // This will be caught.
 273                                 }
 274 
 275                                 // Transform class
 276                                 InsnList patch = new InsnList();
 277                                 patch.add(new VarInsnNode(Opcodes.ALOAD, 0));
<abbr title=" 278                                 patch.add(new FieldInsnNode(Opcodes.GETFIELD, &quot;org/apache/logging/log4j/core/lookup/Interpolator&quot;, fn.name, fn.desc));"> 278                                 patch.add(new FieldInsnNode(Opcodes.GETFIELD, &quot;org/apache/logging/log4j/cðŸ”µ</abbr>
 279                                 patch.add(new LdcInsnNode(&quot;jndi&quot;));
<abbr title=" 280                                 patch.add(new MethodInsnNode(Opcodes.INVOKEINTERFACE, &quot;java/util/Map&quot;, &quot;remove&quot;, &quot;(Ljava/lang/Object;)Ljava/lang/Object;&quot;, true));"> 280                                 patch.add(new MethodInsnNode(Opcodes.INVOKEINTERFACE, &quot;java/util/Map&quot;, &quot;rðŸ”µ</abbr>
 281                                 patch.add(new InsnNode(Opcodes.POP));
 282                                 for (MethodNode method : node.methods) {
 283                                     if ((method.access &amp; Opcodes.ACC_STATIC) == 0)
<abbr title=" 284                                         method.instructions.insertBefore(method.instructions.getFirst(), patch);"> 284                                         method.instructions.insertBefore(method.instructions.getFirst(), ðŸ”µ</abbr>
 285                                 }
 286 
 287                                 // Write class back into zip file
 288                                 ClassWriter classWriter = new ClassWriter(ClassWriter.COMPUTE_FRAMES);
 289                                 node.accept(classWriter);
 290                                 out.write(classWriter.toByteArray());
 291                             } catch (Throwable throwable) {
<abbr title=" 292                                 System.err.println(&quot;Couldn&#x27;t fully vaccinate! Deleting JNDILookup to make program crash when the exploit is used!!&quot;);"> 292                                 System.err.println(&quot;Couldn&#x27;t fully vaccinate! Deleting JNDILookup to makeðŸ”µ</abbr>
 293                             }
 294                             break;
 295                         --- END COMMENTED OUT CODE ---
 296                          */
 297                         case &quot;org/apache/logging/log4j/core/lookup/JndiLookup.class&quot;:
 298                             break;
 299                         case &quot;META-INF/org/apache/logging/log4j/core/config/plugins/Log4j2Plugins.dat&quot;:
 300                             DataOutputStream os = new DataOutputStream(out);
 301                             DataInputStream is = new DataInputStream(new BufferedInputStream(in));
 302 
 303                             // The old count
 304                             int count = is.readInt();
 305 
 306                             // Names of the visited categories
 307                             String[] categoryNames = new String[count];
 308                             // Counts in categories
 309                             int[] ecounts = new int[count];
 310                             // Bytes of the plugin entries, [category count][entries in category][bytes]
 311                             byte[][][] bytes = new byte[count][][];
 312                             for (int i = 0; i &lt; count; i++) {
 313                                 // Category name is read and stores
 314                                 categoryNames[i] = is.readUTF();
<abbr title=" 315                                 // Amount of entries in category is read and stored, ecounts[i] will be modified gradually."> 315                                 // Amount of entries in category is read and stored, ecounts[i] will be mðŸ”µ</abbr>
 316                                 int ecount = ecounts[i] = is.readInt();
 317                                 // Initialize bytearray for this category
 318                                 bytes[i] = new byte[ecount][];
 319 
 320                                 // Loop through each plugin
 321                                 for (int j = 0; j &lt; ecount; j++) {
 322                                     // Create streams for this plugin
 323                                     ByteArrayOutputStream baos = new ByteArrayOutputStream();
 324                                     DataOutputStream dos = new DataOutputStream(baos);
 325                                     // Read the name
 326                                     String name = is.readUTF();
 327                                     // Copy plugin data to plugin byte array
 328                                     dos.writeUTF(name);
 329                                     dos.writeUTF(is.readUTF());
 330                                     dos.writeUTF(is.readUTF());
 331                                     dos.writeBoolean(is.readBoolean());
 332                                     dos.writeBoolean(is.readBoolean());
 333                                     // Store plugin byte array unless it is JNDI
 334                                     if(name.equals(&quot;jndi&quot;)) {
 335                                         ecounts[i]--;
 336                                     }
 337                                     else
 338                                         bytes[i][j - (ecount - ecounts[i])] = baos.toByteArray();
 339                                 }
 340                             }
 341 
 342                             // Write back the data we just read
 343                             os.writeInt(count);
 344                             for (int i = 0; i &lt; count; i++) {
 345                                 // Write category name
 346                                 os.writeUTF(categoryNames[i]);
 347                                 // Amount of plugins in category
 348                                 int ecount = ecounts[i];
 349                                 // Write number of plugins in category
 350                                 os.writeInt(ecount);
 351 
 352                                 // Loop through each plugin and write its bytes
 353                                 for (int j = 0; j &lt; ecount; j++) {
 354                                     os.write(bytes[i][j]);
 355                                 }
 356                             }
 357 
 358                             break;
 359                         default:
 360                             byte[] buf = new byte[4096];
 361                             int i;
 362                             while ((i = in.read(buf)) &gt; 0) {
 363                                 out.write(buf, 0, i);
 364                             }
 365                             break;
 366                     }
 367                     out.closeEntry();
 368                     in.closeEntry();
 369                 }
 370                 in.close();
 371                 out.close();
 372                 if (!jar.delete() || !fixedjar.renameTo(jar)) {
 373                     System.err.println(&quot;Couldn&#x27;t patch jar.&quot;);
 374                 }
 375             }
 376             catch (Exception e) {
 377                 System.err.println(&quot;Couldn&#x27;t patch jar.&quot;);
 378                 e.printStackTrace();
 379             }
 380         }
 381     }
 382 
 383     private static void setAccess(Field field) throws NoSuchFieldException, IllegalAccessException {
 384         field.setAccessible(true);
 385         Field modifiersField = Field.class.getDeclaredField(&quot;modifiers&quot;);
 386         modifiersField.setAccessible(true);
 387         modifiersField.setInt(field, field.getModifiers() &amp; ~Modifier.FINAL);
 388     }
 389 }</pre></td>
                            <td><pre>   1 /* Commented out because they are only needed for another commented-out
   2    code block.
   3 --- BEGIN COMMENTED OUT CODE ---
   4 import jdk.internal.org.objectweb.asm.ClassReader;
   5 import jdk.internal.org.objectweb.asm.ClassWriter;
   6 import jdk.internal.org.objectweb.asm.Opcodes;
   7 import jdk.internal.org.objectweb.asm.tree.*;
   8 import java.io.ByteArrayOutputStream;
   9 import java.util.Optional;
  10 --- END COMMENTED OUT CODE ---
  11  */
  12 import org.apache.logging.log4j.core.LoggerContext;
  13 import org.apache.logging.log4j.core.config.Configuration;
  14 import org.apache.logging.log4j.core.lookup.Interpolator;
  15 import org.apache.logging.log4j.core.lookup.StrLookup;
  16 import org.apache.logging.log4j.core.selector.ContextSelector;
  17 
  18 import java.io.*;
  19 import java.lang.reflect.Field;
  20 import java.lang.reflect.Method;
  21 import java.lang.reflect.Modifier;
  22 import java.net.URL;
  23 import java.util.Base64;
  24 import java.util.zip.ZipEntry;
  25 import java.util.zip.ZipInputStream;
  26 import java.util.zip.ZipOutputStream;
  27 import java.util.Map;
  28 
  29 public class Log4jRCE {
  30     static {
  31         Class&lt;?&gt; c = null;
  32         try {
  33             try { // Try for versions of Log4j &gt;= 2.10
<abbr title="  34                 c = Thread.currentThread().getContextClassLoader().loadClass(&quot;org.apache.logging.log4j.core.util.Constants&quot;);">  34                 c = Thread.currentThread().getContextClassLoader().loadClass(&quot;org.apache.logging.log4j.coðŸ”µ</abbr>
  35               Field field = c.getField(&quot;FORMAT_MESSAGES_PATTERN_DISABLE_LOOKUPS&quot;);
  36               System.out.println(&quot;Setting &quot; + field.getName() + &quot; value to True&quot;);
  37                 setAccess(field);
  38                 field.set(null, Boolean.TRUE);
  39             } catch (Throwable e) { // Fall back to older versions. Try to make JNDI non instantiable
  40                 c = null;
<abbr title="  41                 System.err.println(&quot;No field FORMAT_MESSAGES_PATTERN_DISABLE_LOOKUPS - version &lt;= 2.9.0&quot;);">  41                 System.err.println(&quot;No field FORMAT_MESSAGES_PATTERN_DISABLE_LOOKUPS - version &lt;= 2.9.0&quot;)ðŸ”µ</abbr>
  42                 System.err.println(&quot;Will attempt to modify the configuration directly&quot;);
  43             }
  44 
  45             // Reconfigure log4j
  46             ClassLoader classLoader = Thread.currentThread().getContextClassLoader();
  47 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  48             c = classLoader.loadClass(&quot;org.apache.logging.log4j.core.config.Configurator&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  49             try {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  50                 Method reconfigure = c.getMethod(&quot;reconfigure&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  51                 reconfigure.invoke(null);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  52             } catch (Exception ex) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  53                 // Log4j is probably older.</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  54                 Method getFactoryMethod = c.getDeclaredMethod(&quot;getFactory&quot;);</span>
  55 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="  56             Class&lt;?&gt; configuratorClass = classLoader.loadClass(&quot;org.apache.logging.log4j.core.config.Configurator&quot;);">  56             Class&lt;?&gt; configuratorClass = classLoader.loadClass(&quot;org.apache.logging.log4j.core.config.ConfðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  57             try {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  58                 Method reconfigure = configuratorClass.getMethod(&quot;reconfigure&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  59                 reconfigure.invoke(null);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  60             } catch (Exception ex) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  61                 Method getFactoryMethod = configuratorClass.getDeclaredMethod(&quot;getFactory&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  62                 getFactoryMethod.setAccessible(true);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  63                 Object factory = getFactoryMethod.invoke(null);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="  64                 Class&lt;?&gt; log4jContextFactoryClass = classLoader.loadClass(&quot;org.apache.logging.log4j.core.impl.Log4jContextFactory&quot;);">  64                 Class&lt;?&gt; log4jContextFactoryClass = classLoader.loadClass(&quot;org.apache.logging.log4j.core.ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  65                 Method getSelector = log4jContextFactoryClass.getMethod(&quot;getSelector&quot;);</span>
  66 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title="  67             Class&lt;?&gt; configuratorClass = classLoader.loadClass(&quot;org.apache.logging.log4j.core.config.Configurator&quot;);">  67             Class&lt;?&gt; configuratorClass = classLoader.loadClass(&quot;org.apache.logging.log4j.core.config.ConfðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  68 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  69             // Due to CVE-2021-45046 we&#x27;re no longer using the reconfigure method -</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  70             // Instead we reconfigure the logger but *also* remove the JNDI listener from the plugin map</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  71             //try {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  72             //    Method reconfigure = configuratorClass.getMethod(&quot;reconfigure&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  73             //    reconfigure.invoke(null);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  74             //} catch (Exception ex) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  75 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  76             Method getFactoryMethod = configuratorClass.getDeclaredMethod(&quot;getFactory&quot;);</span>
  77 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
  78                 getFactoryMethod.setAccessible(true);
  79                 Object factory = getFactoryMethod.invoke(null);
<abbr title="  80                 Class&lt;?&gt; log4jContextFactoryClass = classLoader.loadClass(&quot;org.apache.logging.log4j.core.impl.Log4jContextFactory&quot;);">  80                 Class&lt;?&gt; log4jContextFactoryClass = classLoader.loadClass(&quot;org.apache.logging.log4j.core.ðŸ”µ</abbr>
  81                 Method getSelector = log4jContextFactoryClass.getMethod(&quot;getSelector&quot;);
  82                 Object contextSelector = getSelector.invoke(factory, (Object[]) null);
  83                 ContextSelector ctxSelector = (ContextSelector) contextSelector;
  84                 for (LoggerContext ctx: ctxSelector.getLoggerContexts()) {
  85                 // The following deadlocks in some tests when using ThreadContext attacks
  86                 //ctx.reconfigure();
  87                     Configuration config = ctx.getConfiguration();
  88                     StrLookup resolver = config.getStrSubstitutor().getVariableResolver();
  89                     if (resolver instanceof Interpolator) {
  90 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  91                         System.err.println(&quot;Lookup is an Interpolator - attempting to remove JNDI&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  92                         Field lookups;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  93                         //noinspection RedundantSuppression</span>
  94 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  95                         } catch (NoSuchFieldException e) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  96                             lookups = Interpolator.class.getDeclaredField(&quot;strLookupMap&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  97                         }</span>
  98 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  99                     System.err.println(&quot;Lookup is an Interpolator - removing JNDI&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 100                     Field lookups = null;</span>
 101 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 102                         try {
 103                             //noinspection JavaReflectionMemberAccess
 104                             lookups = Interpolator.class.getDeclaredField(&quot;lookups&quot;);
 105                         } catch (NoSuchFieldException e) {
 106                             //noinspection JavaReflectionMemberAccess
 107                             lookups = Interpolator.class.getDeclaredField(&quot;strLookupMap&quot;);
 108                         }
 109                         lookups.setAccessible(true);
<abbr title=" 110                         Map&lt;String, StrLookup&gt; lookupMap = (Map&lt;String, StrLookup&gt;) lookups.get(resolver);"> 110                         Map&lt;String, StrLookup&gt; lookupMap = (Map&lt;String, StrLookup&gt;) lookups.get(resolver)ðŸ”µ</abbr>
 111                         lookupMap.remove(&quot;jndi&quot;);
 112                     }
 113                 }
 114 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 115             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 116         } catch (Throwable e) {</span>
 117 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 118         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 119     }</span>
 120 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 121 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 122             //}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 123         } catch (Exception e) {</span>
 124 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 125             System.err.println(&quot;Exception &quot; + e);
 126             e.printStackTrace();
 127         }
 128 
 129         // Modify the log4j jar to fix the vulnerability permanently
 130         if(c != null)
 131             fullyVaccinate(c.getProtectionDomain().getCodeSource().getLocation());
 132     }
 133 
 134     private static void fullyVaccinate(URL jarfile) {
 135         String path = jarfile.getFile();
 136         File jar = new File(path);
 137         if(path.endsWith(&quot;.jar&quot;)) {
 138             try {
 139                 File fixedjar = new File(&quot;log4j.jar.tmp&quot;);
 140                 ZipInputStream in = new ZipInputStream(new FileInputStream(path));
 141                 ZipOutputStream out = new ZipOutputStream(new FileOutputStream(fixedjar));
 142                 ZipEntry entry;
 143                 while ((entry = in.getNextEntry()) != null) {
 144                     out.putNextEntry(new ZipEntry(entry.getName()));
 145                     switch (entry.getName()) {
 146                         case &quot;org/apache/logging/log4j/core/util/Constants.class&quot;:
<abbr title=" 147                             // base64 of the patched class (FORMAT_MESSAGES_PATTERN_DISABLE_LOOKUPS set to default false)"> 147                             // base64 of the patched class (FORMAT_MESSAGES_PATTERN_DISABLE_LOOKUPS set tðŸ”µ</abbr>
 148                             // base64 is more compact than a byte array in source code.
 149                             byte[] newClass = Base64.getDecoder().decode(&quot;&quot; +
<abbr title=" 150                                     &quot;yv66vgAAADQAZAEALG9yZy9hcGFjaGUvbG9nZ2luZy9sb2c0ai9jb3JlL3V0aWwvQ29uc3RhbnRz&quot; +"> 150                                     &quot;yv66vgAAADQAZAEALG9yZy9hcGFjaGUvbG9nZ2luZy9sb2c0ai9jb3JlL3V0aWwvQ29uðŸ”µ</abbr>
<abbr title=" 151                                     &quot;BwABAQAQamF2YS9sYW5nL09iamVjdAcAAwEADkNvbnN0YW50cy5qYXZhAQAXTE9HNEpfTE9HX0VW&quot; +"> 151                                     &quot;BwABAQAQamF2YS9sYW5nL09iamVjdAcAAwEADkNvbnN0YW50cy5qYXZhAQAXTE9HNEpfðŸ”µ</abbr>
<abbr title=" 152                                     &quot;RU5UX0ZBQ1RPUlkBABJMamF2YS9sYW5nL1N0cmluZzsBABRMb2c0akxvZ0V2ZW50RmFjdG9yeQgA&quot; +"> 152                                     &quot;RU5UX0ZBQ1RPUlkBABJMamF2YS9sYW5nL1N0cmluZzsBABRMb2c0akxvZ0V2ZW50RmFjðŸ”µ</abbr>
<abbr title=" 153                                     &quot;CAEAFkxPRzRKX0NPTlRFWFRfU0VMRUNUT1IBABRMb2c0akNvbnRleHRTZWxlY3RvcggACwEAGkxP&quot; +"> 153                                     &quot;CAEAFkxPRzRKX0NPTlRFWFRfU0VMRUNUT1IBABRMb2c0akNvbnRleHRTZWxlY3RvcggAðŸ”µ</abbr>
<abbr title=" 154                                     &quot;RzRKX0RFRkFVTFRfU1RBVFVTX0xFVkVMAQAXTG9nNGpEZWZhdWx0U3RhdHVzTGV2ZWwIAA4BABFK&quot; +"> 154                                     &quot;RzRKX0RFRkFVTFRfU1RBVFVTX0xFVkVMAQAXTG9nNGpEZWZhdWx0U3RhdHVzTGV2ZWwIðŸ”µ</abbr>
<abbr title=" 155                                     &quot;TkRJX0NPTlRFWFRfTkFNRQEAIGphdmE6Y29tcC9lbnYvbG9nNGovY29udGV4dC1uYW1lCAARAQAR&quot; +"> 155                                     &quot;TkRJX0NPTlRFWFRfTkFNRQEAIGphdmE6Y29tcC9lbnYvbG9nNGovY29udGV4dC1uYW1lðŸ”µ</abbr>
<abbr title=" 156                                     &quot;TUlMTElTX0lOX1NFQ09ORFMBAAFJAwAAA+gBAB1GT1JNQVRfTUVTU0FHRVNfSU5fQkFDS0dST1VO&quot; +"> 156                                     &quot;TUlMTElTX0lOX1NFQ09ORFMBAAFJAwAAA+gBAB1GT1JNQVRfTUVTU0FHRVNfSU5fQkFDðŸ”µ</abbr>
<abbr title=" 157                                     &quot;RAEAAVoBACdGT1JNQVRfTUVTU0FHRVNfUEFUVEVSTl9ESVNBQkxFX0xPT0tVUFMBAApJU19XRUJf&quot; +"> 157                                     &quot;RAEAAVoBACdGT1JNQVRfTUVTU0FHRVNfUEFUVEVSTl9ESVNBQkxFX0xPT0tVUFMBAApJðŸ”µ</abbr>
<abbr title=" 158                                     &quot;QVBQAQATRU5BQkxFX1RIUkVBRExPQ0FMUwEAFkVOQUJMRV9ESVJFQ1RfRU5DT0RFUlMBAB1JTklU&quot; +"> 158                                     &quot;QVBQAQATRU5BQkxFX1RIUkVBRExPQ0FMUwEAFkVOQUJMRV9ESVJFQ1RfRU5DT0RFUlMBðŸ”µ</abbr>
<abbr title=" 159                                     &quot;SUFMX1JFVVNBQkxFX01FU1NBR0VfU0laRQEAGU1BWF9SRVVTQUJMRV9NRVNTQUdFX1NJWkUBABhF&quot; +"> 159                                     &quot;SUFMX1JFVVNBQkxFX01FU1NBR0VfU0laRQEAGU1BWF9SRVVTQUJMRV9NRVNTQUdFX1NJðŸ”µ</abbr>
<abbr title=" 160                                     &quot;TkNPREVSX0NIQVJfQlVGRkVSX1NJWkUBABhFTkNPREVSX0JZVEVfQlVGRkVSX1NJWkUBAARzaXpl&quot; +"> 160                                     &quot;TkNPREVSX0NIQVJfQlVGRkVSX1NJWkUBABhFTkNPREVSX0JZVEVfQlVGRkVSX1NJWkUBðŸ”µ</abbr>
<abbr title=" 161                                     &quot;AQAWKExqYXZhL2xhbmcvU3RyaW5nO0kpSQEACHByb3BlcnR5AQAMZGVmYXVsdFZhbHVlAQAsb3Jn&quot; +"> 161                                     &quot;AQAWKExqYXZhL2xhbmcvU3RyaW5nO0kpSQEACHByb3BlcnR5AQAMZGVmYXVsdFZhbHVlðŸ”µ</abbr>
<abbr title=" 162                                     &quot;L2FwYWNoZS9sb2dnaW5nL2xvZzRqL3V0aWwvUHJvcGVydGllc1V0aWwHACQBAA1nZXRQcm9wZXJ0&quot; +"> 162                                     &quot;L2FwYWNoZS9sb2dnaW5nL2xvZzRqL3V0aWwvUHJvcGVydGllc1V0aWwHACQBAA1nZXRQðŸ”µ</abbr>
<abbr title=" 163                                     &quot;aWVzAQAwKClMb3JnL2FwYWNoZS9sb2dnaW5nL2xvZzRqL3V0aWwvUHJvcGVydGllc1V0aWw7DAAm&quot; +"> 163                                     &quot;aWVzAQAwKClMb3JnL2FwYWNoZS9sb2dnaW5nL2xvZzRqL3V0aWwvUHJvcGVydGllc1V0ðŸ”µ</abbr>
<abbr title=" 164                                     &quot;ACcKACUAKAEAEmdldEludGVnZXJQcm9wZXJ0eQwAKgAhCgAlACsBAAY8aW5pdD4BAAMoKVYMAC0A&quot; +"> 164                                     &quot;ACcKACUAKAEAEmdldEludGVnZXJQcm9wZXJ0eQwAKgAhCgAlACsBAAY8aW5pdD4BAAMoðŸ”µ</abbr>
<abbr title=" 165                                     &quot;LgoABAAvAQAEdGhpcwEALkxvcmcvYXBhY2hlL2xvZ2dpbmcvbG9nNGovY29yZS91dGlsL0NvbnN0&quot; +"> 165                                     &quot;LgoABAAvAQAEdGhpcwEALkxvcmcvYXBhY2hlL2xvZ2dpbmcvbG9nNGovY29yZS91dGlsðŸ”µ</abbr>
<abbr title=" 166                                     &quot;YW50czsBAAg8Y2xpbml0PgEAFmxvZzRqLmZvcm1hdC5tc2cuYXN5bmMIADQBABJnZXRCb29sZWFu&quot; +"> 166                                     &quot;YW50czsBAAg8Y2xpbml0PgEAFmxvZzRqLmZvcm1hdC5tc2cuYXN5bmMIADQBABJnZXRCðŸ”µ</abbr>
<abbr title=" 167                                     &quot;UHJvcGVydHkBABYoTGphdmEvbGFuZy9TdHJpbmc7WilaDAA2ADcKACUAOAwAFgAXCQACADoBABls&quot; +"> 167                                     &quot;UHJvcGVydHkBABYoTGphdmEvbGFuZy9TdHJpbmc7WilaDAA2ADcKACUAOAwAFgAXCQACðŸ”µ</abbr>
<abbr title=" 168                                     &quot;b2c0ajIuZm9ybWF0TXNnTm9Mb29rdXBzCAA8DAAYABcJAAIAPgEAJ29yZy9hcGFjaGUvbG9nZ2lu&quot; +"> 168                                     &quot;b2c0ajIuZm9ybWF0TXNnTm9Mb29rdXBzCAA8DAAYABcJAAIAPgEAJ29yZy9hcGFjaGUvðŸ”µ</abbr>
<abbr title=" 169                                     &quot;Zy9sb2c0ai91dGlsL0NvbnN0YW50cwcAQAwAGQAXCQBBAEIJAAIAQgwAGgAXCQBBAEUJAAIARQEA&quot; +"> 169                                     &quot;Zy9sb2c0ai91dGlsL0NvbnN0YW50cwcAQAwAGQAXCQBBAEIJAAIAQgwAGgAXCQBBAEUJðŸ”µ</abbr>
<abbr title=" 170                                     &quot;HWxvZzRqMi5lbmFibGUuZGlyZWN0LmVuY29kZXJzCABIDAAbABcJAAIASgEAHGxvZzRqLmluaXRp&quot; +"> 170                                     &quot;HWxvZzRqMi5lbmFibGUuZGlyZWN0LmVuY29kZXJzCABIDAAbABcJAAIASgEAHGxvZzRqðŸ”µ</abbr>
<abbr title=" 171                                     &quot;YWxSZXVzYWJsZU1zZ1NpemUIAEwMACAAIQoAAgBODAAcABQJAAIAUAEAGGxvZzRqLm1heFJldXNh&quot; +"> 171                                     &quot;YWxSZXVzYWJsZU1zZ1NpemUIAEwMACAAIQoAAgBODAAcABQJAAIAUAEAGGxvZzRqLm1hðŸ”µ</abbr>
<abbr title=" 172                                     &quot;YmxlTXNnU2l6ZQgAUgwAHQAUCQACAFQBABxsb2c0ai5lbmNvZGVyLmNoYXJCdWZmZXJTaXplCABW&quot; +"> 172                                     &quot;YmxlTXNnU2l6ZQgAUgwAHQAUCQACAFQBABxsb2c0ai5lbmNvZGVyLmNoYXJCdWZmZXJTðŸ”µ</abbr>
<abbr title=" 173                                     &quot;DAAeABQJAAIAWAEAHGxvZzRqLmVuY29kZXIuYnl0ZUJ1ZmZlclNpemUIAFoMAB8AFAkAAgBcAQAN&quot; +"> 173                                     &quot;DAAeABQJAAIAWAEAHGxvZzRqLmVuY29kZXIuYnl0ZUJ1ZmZlclNpemUIAFoMAB8AFAkAðŸ”µ</abbr>
<abbr title=" 174                                     &quot;Q29uc3RhbnRWYWx1ZQEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBABJMb2NhbFZhcmlhYmxlVGFi&quot; +"> 174                                     &quot;Q29uc3RhbnRWYWx1ZQEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBABJMb2NhbFZhcmlhðŸ”µ</abbr>
<abbr title=" 175                                     &quot;bGUBABBNZXRob2RQYXJhbWV0ZXJzAQAKU291cmNlRmlsZQAxAAIABAAAAA4AGQAGAAcAAQBeAAAA&quot; +"> 175                                     &quot;bGUBABBNZXRob2RQYXJhbWV0ZXJzAQAKU291cmNlRmlsZQAxAAIABAAAAA4AGQAGAAcAðŸ”µ</abbr>
<abbr title=" 176                                     &quot;AgAJABkACgAHAAEAXgAAAAIADAAZAA0ABwABAF4AAAACAA8AGQAQAAcAAQBeAAAAAgASABkAEwAU&quot; +"> 176                                     &quot;AgAJABkACgAHAAEAXgAAAAIADAAZAA0ABwABAF4AAAACAA8AGQAQAAcAAQBeAAAAAgASðŸ”µ</abbr>
<abbr title=" 177                                     &quot;AAEAXgAAAAIAFQAZABYAFwAAABkAGAAXAAAAGQAZABcAAAAZABoAFwAAABkAGwAXAAAAGQAcABQA&quot; +"> 177                                     &quot;AAEAXgAAAAIAFQAZABYAFwAAABkAGAAXAAAAGQAZABcAAAAZABoAFwAAABkAGwAXAAAAðŸ”µ</abbr>
<abbr title=" 178                                     &quot;AAAZAB0AFAAAABkAHgAUAAAAGQAfABQAAAADAAoAIAAhAAIAXwAAAD0AAwACAAAACbgAKSobtgAs&quot; +"> 178                                     &quot;AAAZAB0AFAAAABkAHgAUAAAAGQAfABQAAAADAAoAIAAhAAIAXwAAAD0AAwACAAAACbgAðŸ”µ</abbr>
<abbr title=" 179                                     &quot;rAAAAAIAYAAAAAYAAQAAAIwAYQAAABYAAgAAAAkAIgAHAAAAAAAJACMAFAABAGIAAAAJAgAiABAA&quot; +"> 179                                     &quot;rAAAAAIAYAAAAAYAAQAAAIwAYQAAABYAAgAAAAkAIgAHAAAAAAAJACMAFAABAGIAAAAJðŸ”µ</abbr>
<abbr title=" 180                                     &quot;IwAQAAIALQAuAAEAXwAAADMAAQABAAAABSq3ADCxAAAAAgBgAAAACgACAAAAkgAEAJMAYQAAAAwA&quot; +"> 180                                     &quot;IwAQAAIALQAuAAEAXwAAADMAAQABAAAABSq3ADCxAAAAAgBgAAAACgACAAAAkgAEAJMAðŸ”µ</abbr>
<abbr title=" 181                                     &quot;AQAAAAUAMQAyAAAACAAzAC4AAQBfAAAAlQADAAAAAABduAApEjUDtgA5swA7uAApEj0EtgA5swA/&quot; +"> 181                                     &quot;AQAAAAUAMQAyAAAACAAzAC4AAQBfAAAAlQADAAAAAABduAApEjUDtgA5swA7uAApEj0EðŸ”µ</abbr>
<abbr title=" 182                                     &quot;sgBDswBEsgBGswBHuAApEkkEtgA5swBLEk0RAIC4AE+zAFESUxECBrgAT7MAVRJXEQgAuABPswBZ&quot; +"> 182                                     &quot;sgBDswBEsgBGswBHuAApEkkEtgA5swBLEk0RAIC4AE+zAFESUxECBrgAT7MAVRJXEQgAðŸ”µ</abbr>
<abbr title=" 183                                     &quot;ElsRIAC4AE+zAF2xAAAAAQBgAAAAJgAJAAAANgAMAD8AGABHAB4AUQAkAF4AMABqADsAdQBGAH4A&quot; +"> 183                                     &quot;ElsRIAC4AE+zAF2xAAAAAQBgAAAAJgAJAAAANgAMAD8AGABHAB4AUQAkAF4AMABqADsAðŸ”µ</abbr>
 184                                     &quot;UQCIAAEAYwAAAAIABQ==&quot;);
 185                             out.write(newClass);
 186                             break;
 187                         /* Commented out because of compatibility issues - JNDI will be deleted instead
 188                            (which will help in almost the same way).
 189                         --- BEGIN COMMENTED OUT CODE ---
 190                         case &quot;org/apache/logging/log4j/core/lookup/Interpolator&quot;:
 191                             try {
 192                                 // Read class
 193                                 ByteArrayOutputStream baos = new ByteArrayOutputStream();
 194                                 byte[] buf = new byte[4096];
 195                                 int i;
 196                                 while ((i = in.read(buf)) &gt; 0) {
 197                                     baos.write(buf, 0, i);
 198                                 }
 199                                 ClassReader classReader = new ClassReader(baos.toByteArray());
 200                                 ClassNode node = new ClassNode();
 201                                 classReader.accept(node, 0);
 202 
 203                                 FieldNode fn;
 204                                 {
<abbr title=" 205                                     Optional&lt;FieldNode&gt; optionalFieldNode = node.fields.stream().filter(fieldNode -&gt; fieldNode.desc.contains(&quot;Map&quot;)).findFirst();"> 205                                     Optional&lt;FieldNode&gt; optionalFieldNode = node.fields.stream().filter(fðŸ”µ</abbr>
 206                                     if(optionalFieldNode.isPresent())
 207                                         fn = optionalFieldNode.get();
 208                                     else
 209                                         throw new NoSuchFieldException(); // This will be caught.
 210                                 }
 211 
 212                                 // Transform class
 213                                 InsnList patch = new InsnList();
 214                                 patch.add(new VarInsnNode(Opcodes.ALOAD, 0));
<abbr title=" 215                                 patch.add(new FieldInsnNode(Opcodes.GETFIELD, &quot;org/apache/logging/log4j/core/lookup/Interpolator&quot;, fn.name, fn.desc));"> 215                                 patch.add(new FieldInsnNode(Opcodes.GETFIELD, &quot;org/apache/logging/log4j/cðŸ”µ</abbr>
 216                                 patch.add(new LdcInsnNode(&quot;jndi&quot;));
<abbr title=" 217                                 patch.add(new MethodInsnNode(Opcodes.INVOKEINTERFACE, &quot;java/util/Map&quot;, &quot;remove&quot;, &quot;(Ljava/lang/Object;)Ljava/lang/Object;&quot;, true));"> 217                                 patch.add(new MethodInsnNode(Opcodes.INVOKEINTERFACE, &quot;java/util/Map&quot;, &quot;rðŸ”µ</abbr>
 218                                 patch.add(new InsnNode(Opcodes.POP));
 219                                 for (MethodNode method : node.methods) {
 220                                     if ((method.access &amp; Opcodes.ACC_STATIC) == 0)
<abbr title=" 221                                         method.instructions.insertBefore(method.instructions.getFirst(), patch);"> 221                                         method.instructions.insertBefore(method.instructions.getFirst(), ðŸ”µ</abbr>
 222                                 }
 223 
 224                                 // Write class back into zip file
 225                                 ClassWriter classWriter = new ClassWriter(ClassWriter.COMPUTE_FRAMES);
 226                                 node.accept(classWriter);
 227                                 out.write(classWriter.toByteArray());
 228                             } catch (Throwable throwable) {
<abbr title=" 229                                 System.err.println(&quot;Couldn&#x27;t fully vaccinate! Deleting JNDILookup to make program crash when the exploit is used!!&quot;);"> 229                                 System.err.println(&quot;Couldn&#x27;t fully vaccinate! Deleting JNDILookup to makeðŸ”µ</abbr>
 230                             }
 231                             break;
 232                         --- END COMMENTED OUT CODE ---
 233                          */
 234                         case &quot;org/apache/logging/log4j/core/lookup/JndiLookup.class&quot;:
 235                             break;
 236                         case &quot;META-INF/org/apache/logging/log4j/core/config/plugins/Log4j2Plugins.dat&quot;:
 237                             DataOutputStream os = new DataOutputStream(out);
 238                             DataInputStream is = new DataInputStream(new BufferedInputStream(in));
 239 
 240                             // The old count
 241                             int count = is.readInt();
 242 
 243                             // Names of the visited categories
 244                             String[] categoryNames = new String[count];
 245                             // Counts in categories
 246                             int[] ecounts = new int[count];
 247                             // Bytes of the plugin entries, [category count][entries in category][bytes]
 248                             byte[][][] bytes = new byte[count][][];
 249                             for (int i = 0; i &lt; count; i++) {
 250                                 // Category name is read and stores
 251                                 categoryNames[i] = is.readUTF();
<abbr title=" 252                                 // Amount of entries in category is read and stored, ecounts[i] will be modified gradually."> 252                                 // Amount of entries in category is read and stored, ecounts[i] will be mðŸ”µ</abbr>
 253                                 int ecount = ecounts[i] = is.readInt();
 254                                 // Initialize bytearray for this category
 255                                 bytes[i] = new byte[ecount][];
 256 
 257                                 // Loop through each plugin
 258                                 for (int j = 0; j &lt; ecount; j++) {
 259                                     // Create streams for this plugin
 260                                     ByteArrayOutputStream baos = new ByteArrayOutputStream();
 261                                     DataOutputStream dos = new DataOutputStream(baos);
 262                                     // Read the name
 263                                     String name = is.readUTF();
 264                                     // Copy plugin data to plugin byte array
 265                                     dos.writeUTF(name);
 266                                     dos.writeUTF(is.readUTF());
 267                                     dos.writeUTF(is.readUTF());
 268                                     dos.writeBoolean(is.readBoolean());
 269                                     dos.writeBoolean(is.readBoolean());
 270                                     // Store plugin byte array unless it is JNDI
 271                                     if(name.equals(&quot;jndi&quot;)) {
 272                                         ecounts[i]--;
 273                                     }
 274                                     else
 275                                         bytes[i][j - (ecount - ecounts[i])] = baos.toByteArray();
 276                                 }
 277                             }
 278 
 279                             // Write back the data we just read
 280                             os.writeInt(count);
 281                             for (int i = 0; i &lt; count; i++) {
 282                                 // Write category name
 283                                 os.writeUTF(categoryNames[i]);
 284                                 // Amount of plugins in category
 285                                 int ecount = ecounts[i];
 286                                 // Write number of plugins in category
 287                                 os.writeInt(ecount);
 288 
 289                                 // Loop through each plugin and write its bytes
 290                                 for (int j = 0; j &lt; ecount; j++) {
 291                                     os.write(bytes[i][j]);
 292                                 }
 293                             }
 294 
 295                             break;
 296                         default:
 297                             byte[] buf = new byte[4096];
 298                             int i;
 299                             while ((i = in.read(buf)) &gt; 0) {
 300                                 out.write(buf, 0, i);
 301                             }
 302                             break;
 303                     }
 304                     out.closeEntry();
 305                     in.closeEntry();
 306                 }
 307                 in.close();
 308                 out.close();
 309                 if (!jar.delete() || !fixedjar.renameTo(jar)) {
 310                     System.err.println(&quot;Couldn&#x27;t patch jar.&quot;);
 311                 }
 312             }
 313             catch (Exception e) {
 314                 System.err.println(&quot;Couldn&#x27;t patch jar.&quot;);
 315                 e.printStackTrace();
 316             }
 317         }
 318     }
 319 
 320     private static void setAccess(Field field) throws NoSuchFieldException, IllegalAccessException {
 321         field.setAccessible(true);
 322         Field modifiersField = Field.class.getDeclaredField(&quot;modifiers&quot;);
 323         modifiersField.setAccessible(true);
 324         modifiersField.setInt(field, field.getModifiers() &amp; ~Modifier.FINAL);
 325     }
 326 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                            <td><pre>   1 import java.io.*;
   2 import java.lang.reflect.Field;
   3 import java.lang.reflect.Method;
   4 import java.lang.reflect.Modifier;
   5 import java.net.URL;
   6 import java.util.Base64;
   7 import java.util.Map;
   8 import java.util.zip.ZipEntry;
   9 import java.util.zip.ZipInputStream;
  10 import java.util.zip.ZipOutputStream;
  11 import org.apache.logging.log4j.core.LoggerContext;
  12 import org.apache.logging.log4j.core.config.Configuration;
  13 import org.apache.logging.log4j.core.lookup.Interpolator;
  14 import org.apache.logging.log4j.core.lookup.StrLookup;
  15 import org.apache.logging.log4j.core.selector.ContextSelector;
  16 
  17 
  18 public class Log4jRCE {
  19     static {
  20         Class&lt;?&gt; c = null;
  21         try {
  22             try { // Try for versions of Log4j &gt;= 2.10
<abbr title="  23                 c = Thread.currentThread().getContextClassLoader().loadClass(&quot;org.apache.logging.log4j.core.util.Constants&quot;);">  23                 c = Thread.currentThread().getContextClassLoader().loadClass(&quot;org.apache.logging.log4j.coðŸ”µ</abbr>
  24                 Field field = c.getField(&quot;FORMAT_MESSAGES_PATTERN_DISABLE_LOOKUPS&quot;);
  25                 System.out.println(&quot;Setting &quot; + field.getName() + &quot; value to True&quot;);
  26                 setAccess(field);
  27                 field.set(null, Boolean.TRUE);
  28             } catch (Throwable e) { // Fall back to older versions. Try to make JNDI non instantiable
  29                 c = null;
<abbr title="  30                 System.err.println(&quot;No field FORMAT_MESSAGES_PATTERN_DISABLE_LOOKUPS - version &lt;= 2.9.0&quot;);">  30                 System.err.println(&quot;No field FORMAT_MESSAGES_PATTERN_DISABLE_LOOKUPS - version &lt;= 2.9.0&quot;)ðŸ”µ</abbr>
  31                 System.err.println(&quot;Will attempt to modify the configuration directly&quot;);
  32             }
  33 
  34             // Reconfigure log4j
  35             ClassLoader classLoader = Thread.currentThread().getContextClassLoader();
  36 
  37 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  38             c = classLoader.loadClass(&quot;org.apache.logging.log4j.core.config.Configurator&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  39             try {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  40                 Method reconfigure = c.getMethod(&quot;reconfigure&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  41                 reconfigure.invoke(null);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  42             } catch (Exception ex) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  43                 // Log4j is probably older.</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  44                 Method getFactoryMethod = c.getDeclaredMethod(&quot;getFactory&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  45                 getFactoryMethod.setAccessible(true);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  46                 Object factory = getFactoryMethod.invoke(null);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title="  47                 Class&lt;?&gt; log4jContextFactoryClass = classLoader.loadClass(&quot;org.apache.logging.log4j.core.impl.Log4jContextFactory&quot;);">  47                 Class&lt;?&gt; log4jContextFactoryClass = classLoader.loadClass(&quot;org.apache.logging.log4j.core.ðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  48                 Method getSelector = log4jContextFactoryClass.getMethod(&quot;getSelector&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  49                 Object contextSelector = getSelector.invoke(factory, (Object[]) null);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  50                 ContextSelector ctxSelector = (ContextSelector) contextSelector;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  51                 for (LoggerContext ctx: ctxSelector.getLoggerContexts()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  52                     ctx.reconfigure();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  53                     System.err.println(&quot;Reconfiguring context&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  54                     Configuration config = ctx.getConfiguration();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  55                     StrLookup resolver = config.getStrSubstitutor().getVariableResolver();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  56                     if (resolver instanceof Interpolator) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  57                         System.err.println(&quot;Lookup is an Interpolator - attempting to remove JNDI&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  58                         Field lookups;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  59                         //noinspection RedundantSuppression</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  60                         try {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  61                             //noinspection JavaReflectionMemberAccess</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  62                             lookups = Interpolator.class.getDeclaredField(&quot;lookups&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  63                         } catch (NoSuchFieldException e) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  64                             //noinspection JavaReflectionMemberAccess</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  65                             lookups = Interpolator.class.getDeclaredField(&quot;strLookupMap&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  66                         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  67                         lookups.setAccessible(true);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title="  68                         Map&lt;String, StrLookup&gt; lookupMap = (Map&lt;String, StrLookup&gt;) lookups.get(resolver);">  68                         Map&lt;String, StrLookup&gt; lookupMap = (Map&lt;String, StrLookup&gt;) lookups.get(resolver)ðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  69                         lookupMap.remove(&quot;jndi&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  70 </span>
  71 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="  72 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/">  72 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwðŸ”µ</abbr></span>
  73 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  74 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title="  75             Class&lt;?&gt; configuratorClass = classLoader.loadClass(&quot;org.apache.logging.log4j.core.config.Configurator&quot;);">  75             Class&lt;?&gt; configuratorClass = classLoader.loadClass(&quot;org.apache.logging.log4j.core.config.ConfðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  76 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  77             // Due to CVE-2021-45046 we&#x27;re no longer using the reconfigure method -</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  78             // Instead we reconfigure the logger but *also* remove the JNDI listener from the plugin map</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  79             //try {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  80             //    Method reconfigure = configuratorClass.getMethod(&quot;reconfigure&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  81             //    reconfigure.invoke(null);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  82             //} catch (Exception ex) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  83 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  84             Method getFactoryMethod = configuratorClass.getDeclaredMethod(&quot;getFactory&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  85             getFactoryMethod.setAccessible(true);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  86             Object factory = getFactoryMethod.invoke(null);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title="  87             Class&lt;?&gt; log4jContextFactoryClass = classLoader.loadClass(&quot;org.apache.logging.log4j.core.impl.Log4jContextFactory&quot;);">  87             Class&lt;?&gt; log4jContextFactoryClass = classLoader.loadClass(&quot;org.apache.logging.log4j.core.implðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  88             Method getSelector = log4jContextFactoryClass.getMethod(&quot;getSelector&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  89             Object contextSelector = getSelector.invoke(factory, null);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  90             ContextSelector ctxSelector = (ContextSelector) contextSelector;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  91             for (LoggerContext ctx: ctxSelector.getLoggerContexts()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  92                 // The following deadlocks in some tests when using ThreadContext attacks</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  93                 //ctx.reconfigure();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  94                 Configuration config = ctx.getConfiguration();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  95                 StrLookup resolver = config.getStrSubstitutor().getVariableResolver();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  96                 if (resolver instanceof Interpolator) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  97                     System.err.println(&quot;Lookup is an Interpolator - removing JNDI&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  98                     Field lookups = null;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  99                     try {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 100                         lookups = Interpolator.class.getDeclaredField(&quot;lookups&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 101                     } catch (NoSuchFieldException e) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 102                         lookups = Interpolator.class.getDeclaredField(&quot;strLookupMap&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 103 </span>
 104 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 105                     }
 106                     lookups.setAccessible(true);
 107                     Map&lt;String, StrLookup&gt; lookupMap = (Map&lt;String, StrLookup&gt;) lookups.get(resolver);
 108                     lookupMap.remove(&quot;jndi&quot;);
 109                 }
 110             }
 111 
 112             //}
 113         } catch (java.lang.Throwable e) {
 114             System.err.println(&quot;Exception &quot; + e);
 115             e.printStackTrace();
 116         }
 117         // Modify the log4j jar to fix the vulnerability permanently
 118         if (c != null) {
 119             fullyVaccinate(c.getProtectionDomain().getCodeSource().getLocation());
 120         }
 121     }
 122 
 123     private static void fullyVaccinate(URL jarfile) {
 124         String path = jarfile.getFile();
 125         File jar = new File(path);
 126         if (path.endsWith(&quot;.jar&quot;)) {
 127             try {
 128                 File fixedjar = new File(&quot;log4j.jar.tmp&quot;);
 129                 ZipInputStream in = new ZipInputStream(new FileInputStream(path));
 130                 ZipOutputStream out = new ZipOutputStream(new FileOutputStream(fixedjar));
 131                 ZipEntry entry;
 132                 while ((entry = in.getNextEntry()) != null) {
 133                     out.putNextEntry(new ZipEntry(entry.getName()));
 134                     switch (entry.getName()) {
 135                         case &quot;org/apache/logging/log4j/core/util/Constants.class&quot; :
<abbr title=" 136                             // base64 of the patched class (FORMAT_MESSAGES_PATTERN_DISABLE_LOOKUPS set to default false)"> 136                             // base64 of the patched class (FORMAT_MESSAGES_PATTERN_DISABLE_LOOKUPS set tðŸ”µ</abbr>
 137                             // base64 is more compact than a byte array in source code.
<abbr title=" 138                             byte[] newClass = Base64.getDecoder().decode(&quot;&quot; + ((((((((((((((((((((((((((((((((((&quot;yv66vgAAADQAZAEALG9yZy9hcGFjaGUvbG9nZ2luZy9sb2c0ai9jb3JlL3V0aWwvQ29uc3RhbnRz&quot; + &quot;BwABAQAQamF2YS9sYW5nL09iamVjdAcAAwEADkNvbnN0YW50cy5qYXZhAQAXTE9HNEpfTE9HX0VW&quot;) + &quot;RU5UX0ZBQ1RPUlkBABJMamF2YS9sYW5nL1N0cmluZzsBABRMb2c0akxvZ0V2ZW50RmFjdG9yeQgA&quot;) + &quot;CAEAFkxPRzRKX0NPTlRFWFRfU0VMRUNUT1IBABRMb2c0akNvbnRleHRTZWxlY3RvcggACwEAGkxP&quot;) + &quot;RzRKX0RFRkFVTFRfU1RBVFVTX0xFVkVMAQAXTG9nNGpEZWZhdWx0U3RhdHVzTGV2ZWwIAA4BABFK&quot;) + &quot;TkRJX0NPTlRFWFRfTkFNRQEAIGphdmE6Y29tcC9lbnYvbG9nNGovY29udGV4dC1uYW1lCAARAQAR&quot;) + &quot;TUlMTElTX0lOX1NFQ09ORFMBAAFJAwAAA+gBAB1GT1JNQVRfTUVTU0FHRVNfSU5fQkFDS0dST1VO&quot;) + &quot;RAEAAVoBACdGT1JNQVRfTUVTU0FHRVNfUEFUVEVSTl9ESVNBQkxFX0xPT0tVUFMBAApJU19XRUJf&quot;) + &quot;QVBQAQATRU5BQkxFX1RIUkVBRExPQ0FMUwEAFkVOQUJMRV9ESVJFQ1RfRU5DT0RFUlMBAB1JTklU&quot;) + &quot;SUFMX1JFVVNBQkxFX01FU1NBR0VfU0laRQEAGU1BWF9SRVVTQUJMRV9NRVNTQUdFX1NJWkUBABhF&quot;) + &quot;TkNPREVSX0NIQVJfQlVGRkVSX1NJWkUBABhFTkNPREVSX0JZVEVfQlVGRkVSX1NJWkUBAARzaXpl&quot;) + &quot;AQAWKExqYXZhL2xhbmcvU3RyaW5nO0kpSQEACHByb3BlcnR5AQAMZGVmYXVsdFZhbHVlAQAsb3Jn&quot;) + &quot;L2FwYWNoZS9sb2dnaW5nL2xvZzRqL3V0aWwvUHJvcGVydGllc1V0aWwHACQBAA1nZXRQcm9wZXJ0&quot;) + &quot;aWVzAQAwKClMb3JnL2FwYWNoZS9sb2dnaW5nL2xvZzRqL3V0aWwvUHJvcGVydGllc1V0aWw7DAAm&quot;) + &quot;ACcKACUAKAEAEmdldEludGVnZXJQcm9wZXJ0eQwAKgAhCgAlACsBAAY8aW5pdD4BAAMoKVYMAC0A&quot;) + &quot;LgoABAAvAQAEdGhpcwEALkxvcmcvYXBhY2hlL2xvZ2dpbmcvbG9nNGovY29yZS91dGlsL0NvbnN0&quot;) + &quot;YW50czsBAAg8Y2xpbml0PgEAFmxvZzRqLmZvcm1hdC5tc2cuYXN5bmMIADQBABJnZXRCb29sZWFu&quot;) + &quot;UHJvcGVydHkBABYoTGphdmEvbGFuZy9TdHJpbmc7WilaDAA2ADcKACUAOAwAFgAXCQACADoBABls&quot;) + &quot;b2c0ajIuZm9ybWF0TXNnTm9Mb29rdXBzCAA8DAAYABcJAAIAPgEAJ29yZy9hcGFjaGUvbG9nZ2lu&quot;) + &quot;Zy9sb2c0ai91dGlsL0NvbnN0YW50cwcAQAwAGQAXCQBBAEIJAAIAQgwAGgAXCQBBAEUJAAIARQEA&quot;) + &quot;HWxvZzRqMi5lbmFibGUuZGlyZWN0LmVuY29kZXJzCABIDAAbABcJAAIASgEAHGxvZzRqLmluaXRp&quot;) + &quot;YWxSZXVzYWJsZU1zZ1NpemUIAEwMACAAIQoAAgBODAAcABQJAAIAUAEAGGxvZzRqLm1heFJldXNh&quot;) + &quot;YmxlTXNnU2l6ZQgAUgwAHQAUCQACAFQBABxsb2c0ai5lbmNvZGVyLmNoYXJCdWZmZXJTaXplCABW&quot;) + &quot;DAAeABQJAAIAWAEAHGxvZzRqLmVuY29kZXIuYnl0ZUJ1ZmZlclNpemUIAFoMAB8AFAkAAgBcAQAN&quot;) + &quot;Q29uc3RhbnRWYWx1ZQEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBABJMb2NhbFZhcmlhYmxlVGFi&quot;) + &quot;bGUBABBNZXRob2RQYXJhbWV0ZXJzAQAKU291cmNlRmlsZQAxAAIABAAAAA4AGQAGAAcAAQBeAAAA&quot;) + &quot;AgAJABkACgAHAAEAXgAAAAIADAAZAA0ABwABAF4AAAACAA8AGQAQAAcAAQBeAAAAAgASABkAEwAU&quot;) + &quot;AAEAXgAAAAIAFQAZABYAFwAAABkAGAAXAAAAGQAZABcAAAAZABoAFwAAABkAGwAXAAAAGQAcABQA&quot;) + &quot;AAAZAB0AFAAAABkAHgAUAAAAGQAfABQAAAADAAoAIAAhAAIAXwAAAD0AAwACAAAACbgAKSobtgAs&quot;) + &quot;rAAAAAIAYAAAAAYAAQAAAIwAYQAAABYAAgAAAAkAIgAHAAAAAAAJACMAFAABAGIAAAAJAgAiABAA&quot;) + &quot;IwAQAAIALQAuAAEAXwAAADMAAQABAAAABSq3ADCxAAAAAgBgAAAACgACAAAAkgAEAJMAYQAAAAwA&quot;) + &quot;AQAAAAUAMQAyAAAACAAzAC4AAQBfAAAAlQADAAAAAABduAApEjUDtgA5swA7uAApEj0EtgA5swA/&quot;) + &quot;sgBDswBEsgBGswBHuAApEkkEtgA5swBLEk0RAIC4AE+zAFESUxECBrgAT7MAVRJXEQgAuABPswBZ&quot;) + &quot;ElsRIAC4AE+zAF2xAAAAAQBgAAAAJgAJAAAANgAMAD8AGABHAB4AUQAkAF4AMABqADsAdQBGAH4A&quot;) + &quot;UQCIAAEAYwAAAAIABQ==&quot;));"> 138                             byte[] newClass = Base64.getDecoder().decode(&quot;&quot; + (((((((((((((((((((((((((((ðŸ”µ</abbr>
 139                             out.write(newClass);
 140                             break;
 141                         /* Commented out because of compatibility issues - JNDI will be deleted instead
 142                            (which will help in almost the same way).
 143                         --- BEGIN COMMENTED OUT CODE ---
 144                         case &quot;org/apache/logging/log4j/core/lookup/Interpolator&quot;:
 145                             try {
 146                                 // Read class
 147                                 ByteArrayOutputStream baos = new ByteArrayOutputStream();
 148                                 byte[] buf = new byte[4096];
 149                                 int i;
 150                                 while ((i = in.read(buf)) &gt; 0) {
 151                                     baos.write(buf, 0, i);
 152                                 }
 153                                 ClassReader classReader = new ClassReader(baos.toByteArray());
 154                                 ClassNode node = new ClassNode();
 155                                 classReader.accept(node, 0);
 156 
 157                                 FieldNode fn;
 158                                 {
<abbr title=" 159                                     Optional&lt;FieldNode&gt; optionalFieldNode = node.fields.stream().filter(fieldNode -&gt; fieldNode.desc.contains(&quot;Map&quot;)).findFirst();"> 159                                     Optional&lt;FieldNode&gt; optionalFieldNode = node.fields.stream().filter(fðŸ”µ</abbr>
 160                                     if(optionalFieldNode.isPresent())
 161                                         fn = optionalFieldNode.get();
 162                                     else
 163                                         throw new NoSuchFieldException(); // This will be caught.
 164                                 }
 165 
 166                                 // Transform class
 167                                 InsnList patch = new InsnList();
 168                                 patch.add(new VarInsnNode(Opcodes.ALOAD, 0));
<abbr title=" 169                                 patch.add(new FieldInsnNode(Opcodes.GETFIELD, &quot;org/apache/logging/log4j/core/lookup/Interpolator&quot;, fn.name, fn.desc));"> 169                                 patch.add(new FieldInsnNode(Opcodes.GETFIELD, &quot;org/apache/logging/log4j/cðŸ”µ</abbr>
 170                                 patch.add(new LdcInsnNode(&quot;jndi&quot;));
<abbr title=" 171                                 patch.add(new MethodInsnNode(Opcodes.INVOKEINTERFACE, &quot;java/util/Map&quot;, &quot;remove&quot;, &quot;(Ljava/lang/Object;)Ljava/lang/Object;&quot;, true));"> 171                                 patch.add(new MethodInsnNode(Opcodes.INVOKEINTERFACE, &quot;java/util/Map&quot;, &quot;rðŸ”µ</abbr>
 172                                 patch.add(new InsnNode(Opcodes.POP));
 173                                 for (MethodNode method : node.methods) {
 174                                     if ((method.access &amp; Opcodes.ACC_STATIC) == 0)
<abbr title=" 175                                         method.instructions.insertBefore(method.instructions.getFirst(), patch);"> 175                                         method.instructions.insertBefore(method.instructions.getFirst(), ðŸ”µ</abbr>
 176                                 }
 177 
 178                                 // Write class back into zip file
 179                                 ClassWriter classWriter = new ClassWriter(ClassWriter.COMPUTE_FRAMES);
 180                                 node.accept(classWriter);
 181                                 out.write(classWriter.toByteArray());
 182                             } catch (Throwable throwable) {
<abbr title=" 183                                 System.err.println(&quot;Couldn&#x27;t fully vaccinate! Deleting JNDILookup to make program crash when the exploit is used!!&quot;);"> 183                                 System.err.println(&quot;Couldn&#x27;t fully vaccinate! Deleting JNDILookup to makeðŸ”µ</abbr>
 184                             }
 185                             break;
 186                         --- END COMMENTED OUT CODE ---
 187                          */
 188                         case &quot;org/apache/logging/log4j/core/lookup/JndiLookup.class&quot; :
 189                             break;
 190                         case &quot;META-INF/org/apache/logging/log4j/core/config/plugins/Log4j2Plugins.dat&quot; :
 191                             DataOutputStream os = new DataOutputStream(out);
 192                             DataInputStream is = new DataInputStream(new BufferedInputStream(in));
 193                             // The old count
 194                             int count = is.readInt();
 195                             // Names of the visited categories
 196                             String[] categoryNames = new String[count];
 197                             // Counts in categories
 198                             int[] ecounts = new int[count];
 199                             // Bytes of the plugin entries, [category count][entries in category][bytes]
 200                             byte[][][] bytes = new byte[count][][];
 201                             for (int i = 0; i &lt; count; i++) {
 202                                 // Category name is read and stores
 203                                 categoryNames[i] = is.readUTF();
<abbr title=" 204                                 // Amount of entries in category is read and stored, ecounts[i] will be modified gradually."> 204                                 // Amount of entries in category is read and stored, ecounts[i] will be mðŸ”µ</abbr>
 205                                 int ecount = ecounts[i] = is.readInt();
 206                                 // Initialize bytearray for this category
 207                                 bytes[i] = new byte[ecount][];
 208                                 // Loop through each plugin
 209                                 for (int j = 0; j &lt; ecount; j++) {
 210                                     // Create streams for this plugin
 211                                     ByteArrayOutputStream baos = new ByteArrayOutputStream();
 212                                     DataOutputStream dos = new DataOutputStream(baos);
 213                                     // Read the name
 214                                     String name = is.readUTF();
 215                                     // Copy plugin data to plugin byte array
 216                                     dos.writeUTF(name);
 217                                     dos.writeUTF(is.readUTF());
 218                                     dos.writeUTF(is.readUTF());
 219                                     dos.writeBoolean(is.readBoolean());
 220                                     dos.writeBoolean(is.readBoolean());
 221                                     // Store plugin byte array unless it is JNDI
 222                                     if (name.equals(&quot;jndi&quot;)) {
 223                                         ecounts[i]--;
 224                                     } else {
 225                                         bytes[i][j - (ecount - ecounts[i])] = baos.toByteArray();
 226                                     }
 227                                 }
 228                             }
 229                             // Write back the data we just read
 230                             os.writeInt(count);
 231                             for (int i = 0; i &lt; count; i++) {
 232                                 // Write category name
 233                                 os.writeUTF(categoryNames[i]);
 234                                 // Amount of plugins in category
 235                                 int ecount = ecounts[i];
 236                                 // Write number of plugins in category
 237                                 os.writeInt(ecount);
 238                                 // Loop through each plugin and write its bytes
 239                                 for (int j = 0; j &lt; ecount; j++) {
 240                                     os.write(bytes[i][j]);
 241                                 }
 242                             }
 243                             break;
 244                         default :
 245                             byte[] buf = new byte[4096];
 246                             int i;
 247                             while ((i = in.read(buf)) &gt; 0) {
 248                                 out.write(buf, 0, i);
 249                             }
 250                             break;
 251                     }
 252                     out.closeEntry();
 253                     in.closeEntry();
 254                 }
 255                 in.close();
 256                 out.close();
 257                 if ((!jar.delete()) || (!fixedjar.renameTo(jar))) {
 258                     System.err.println(&quot;Couldn&#x27;t patch jar.&quot;);
 259                 }
 260             } catch (java.lang.Exception e) {
 261                 System.err.println(&quot;Couldn&#x27;t patch jar.&quot;);
 262                 e.printStackTrace();
 263             }
 264         }
 265     }
 266 
 267     private static void setAccess(Field field) throws NoSuchFieldException, IllegalAccessException {
 268         field.setAccessible(true);
 269         Field modifiersField = Field.class.getDeclaredField(&quot;modifiers&quot;);
 270         modifiersField.setAccessible(true);
 271         modifiersField.setInt(field, field.getModifiers() &amp; ~Modifier.FINAL);
 272     }
 273 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre><span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   1 -import org.apache.logging.log4j.LogManager;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   2 +/* Commented out because they are only needed for another commented-out</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   3 +   code block.</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   4 +--- BEGIN COMMENTED OUT CODE ---</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   5 +import jdk.internal.org.objectweb.asm.ClassReader;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   6 +import jdk.internal.org.objectweb.asm.ClassWriter;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   7 +import jdk.internal.org.objectweb.asm.Opcodes;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   8 +import jdk.internal.org.objectweb.asm.tree.*;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   9 +import java.io.ByteArrayOutputStream;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  10 +import java.util.Optional;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  11 +--- END COMMENTED OUT CODE ---</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  12 + */</span>
  13  import org.apache.logging.log4j.core.LoggerContext;
  14  import org.apache.logging.log4j.core.config.Configuration;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  15 -import org.apache.logging.log4j.core.config.Configurator;</span>
  16  import org.apache.logging.log4j.core.lookup.Interpolator;
  17  import org.apache.logging.log4j.core.lookup.StrLookup;
  18  import org.apache.logging.log4j.core.selector.ContextSelector;
  19  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  20 +import java.io.*;</span>
  21  import java.lang.reflect.Field;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  22 -import java.lang.reflect.Constructor;</span>
  23  import java.lang.reflect.Method;
  24  import java.lang.reflect.Modifier;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  25 -import java.util.HashMap;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  26 +import java.net.URL;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  27 +import java.util.Base64;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  28 +import java.util.zip.ZipEntry;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  29 +import java.util.zip.ZipInputStream;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  30 +import java.util.zip.ZipOutputStream;</span>
  31  import java.util.Map;
  32  
  33  public class Log4jRCE {
  34      static {
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  35 +        Class&lt;?&gt; c = null;</span>
  36          try {
  37              try { // Try for versions of Log4j &gt;= 2.10
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title="  38 -              Class&lt;?&gt; c = Thread.currentThread().getContextClassLoader().loadClass(&quot;org.apache.logging.log4j.core.util.Constants&quot;);">  38 -              Class&lt;?&gt; c = Thread.currentThread().getContextClassLoader().loadClass(&quot;org.apache.logging.log4j.coreðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  39 -              Field field = c.getField(&quot;FORMAT_MESSAGES_PATTERN_DISABLE_LOOKUPS&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  40 -              System.out.println(&quot;Setting &quot; + field.getName() + &quot; value to True&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  41 -              setFinalStatic(field, Boolean.TRUE);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  42 -            } catch (NoSuchFieldException e) { // Fall back to older versions. Try to make JNDI non instantiable</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title="  43 +                c = Thread.currentThread().getContextClassLoader().loadClass(&quot;org.apache.logging.log4j.core.util.Constants&quot;);">  43 +                c = Thread.currentThread().getContextClassLoader().loadClass(&quot;org.apache.logging.log4j.core.util.CðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  44 +                Field field = c.getField(&quot;FORMAT_MESSAGES_PATTERN_DISABLE_LOOKUPS&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  45 +                System.out.println(&quot;Setting &quot; + field.getName() + &quot; value to True&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  46 +                setAccess(field);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  47 +                field.set(null, Boolean.TRUE);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  48 +            } catch (Throwable e) { // Fall back to older versions. Try to make JNDI non instantiable</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  49 +                c = null;</span>
  50                  System.err.println(&quot;No field FORMAT_MESSAGES_PATTERN_DISABLE_LOOKUPS - version &lt;= 2.9.0&quot;);
  51                  System.err.println(&quot;Will attempt to modify the configuration directly&quot;);
  52              }
  53  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  54 -            //reconfiguring log4j</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  55 +            // Reconfigure log4j</span>
  56              ClassLoader classLoader = Thread.currentThread().getContextClassLoader();
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title="  57 -            Class&lt;?&gt; configuratorClass = classLoader.loadClass(&quot;org.apache.logging.log4j.core.config.Configurator&quot;);">  57 -            Class&lt;?&gt; configuratorClass = classLoader.loadClass(&quot;org.apache.logging.log4j.core.config.Configurator&quot;ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  58 +            c = classLoader.loadClass(&quot;org.apache.logging.log4j.core.config.Configurator&quot;);</span>
  59              try {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  60 -                Method reconfigure = configuratorClass.getMethod(&quot;reconfigure&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  61 +                Method reconfigure = c.getMethod(&quot;reconfigure&quot;);</span>
  62                  reconfigure.invoke(null);
  63              } catch (Exception ex) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  64 -                Method getFactoryMethod = configuratorClass.getDeclaredMethod(&quot;getFactory&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  65 +                // Log4j is probably older.</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  66 +                Method getFactoryMethod = c.getDeclaredMethod(&quot;getFactory&quot;);</span>
  67                  getFactoryMethod.setAccessible(true);
  68                  Object factory = getFactoryMethod.invoke(null);
<abbr title="  69                  Class&lt;?&gt; log4jContextFactoryClass = classLoader.loadClass(&quot;org.apache.logging.log4j.core.impl.Log4jContextFactory&quot;);">  69                  Class&lt;?&gt; log4jContextFactoryClass = classLoader.loadClass(&quot;org.apache.logging.log4j.core.impl.Log4ðŸ”µ</abbr>
  70                  Method getSelector = log4jContextFactoryClass.getMethod(&quot;getSelector&quot;);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  71 -                Object contextSelector = getSelector.invoke(factory, null);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  72 +                Object contextSelector = getSelector.invoke(factory, (Object[]) null);</span>
  73                  ContextSelector ctxSelector = (ContextSelector) contextSelector;
  74                  for (LoggerContext ctx: ctxSelector.getLoggerContexts()) {
  75                      ctx.reconfigure();
  76                      System.err.println(&quot;Reconfiguring context&quot;);
  77                      Configuration config = ctx.getConfiguration();
  78                      StrLookup resolver = config.getStrSubstitutor().getVariableResolver();
  79                      if (resolver instanceof Interpolator) {
  80                          System.err.println(&quot;Lookup is an Interpolator - attempting to remove JNDI&quot;);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  81 -                        Field lookups = null;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  82 +                        Field lookups;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  83 +                        //noinspection RedundantSuppression</span>
  84                          try {
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  85 +                            //noinspection JavaReflectionMemberAccess</span>
  86                              lookups = Interpolator.class.getDeclaredField(&quot;lookups&quot;);
  87                          } catch (NoSuchFieldException e) {
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  88 +                            //noinspection JavaReflectionMemberAccess</span>
  89                              lookups = Interpolator.class.getDeclaredField(&quot;strLookupMap&quot;);
  90                          }
  91                          lookups.setAccessible(true);
  92                          Map&lt;String, StrLookup&gt; lookupMap = (Map&lt;String, StrLookup&gt;) lookups.get(resolver);
  93                          lookupMap.remove(&quot;jndi&quot;);



























  94                      }



  95                  }
  96              }


<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  97 -        } catch (Exception e) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  98 +        } catch (Throwable e) {</span>
  99              System.err.println(&quot;Exception &quot; + e);
 100              e.printStackTrace();
 101          }
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 102 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 103 +        // Modify the log4j jar to fix the vulnerability permanently</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 104 +        if(c != null)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 105 +            fullyVaccinate(c.getProtectionDomain().getCodeSource().getLocation());</span>
 106      }
 107  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 108 -    static void setFinalStatic(Field field, Object newValue) throws Exception {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 109 -        setAccess(field);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 110 -        field.set(null, newValue);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 111 +    private static void fullyVaccinate(URL jarfile) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 112 +        String path = jarfile.getFile();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 113 +        File jar = new File(path);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 114 +        if(path.endsWith(&quot;.jar&quot;)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 115 +            try {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 116 +                File fixedjar = new File(&quot;log4j.jar.tmp&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 117 +                ZipInputStream in = new ZipInputStream(new FileInputStream(path));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 118 +                ZipOutputStream out = new ZipOutputStream(new FileOutputStream(fixedjar));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 119 +                ZipEntry entry;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 120 +                while ((entry = in.getNextEntry()) != null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 121 +                    out.putNextEntry(new ZipEntry(entry.getName()));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 122 +                    switch (entry.getName()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 123 +                        case &quot;org/apache/logging/log4j/core/util/Constants.class&quot;:</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 124 +                            // base64 of the patched class (FORMAT_MESSAGES_PATTERN_DISABLE_LOOKUPS set to default false)"> 124 +                            // base64 of the patched class (FORMAT_MESSAGES_PATTERN_DISABLE_LOOKUPS set to defaultðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 125 +                            // base64 is more compact than a byte array in source code.</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 126 +                            byte[] newClass = Base64.getDecoder().decode(&quot;&quot; +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 127 +                                    &quot;yv66vgAAADQAZAEALG9yZy9hcGFjaGUvbG9nZ2luZy9sb2c0ai9jb3JlL3V0aWwvQ29uc3RhbnRz&quot; +"> 127 +                                    &quot;yv66vgAAADQAZAEALG9yZy9hcGFjaGUvbG9nZ2luZy9sb2c0ai9jb3JlL3V0aWwvQ29uc3RhbnRz&quot;ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 128 +                                    &quot;BwABAQAQamF2YS9sYW5nL09iamVjdAcAAwEADkNvbnN0YW50cy5qYXZhAQAXTE9HNEpfTE9HX0VW&quot; +"> 128 +                                    &quot;BwABAQAQamF2YS9sYW5nL09iamVjdAcAAwEADkNvbnN0YW50cy5qYXZhAQAXTE9HNEpfTE9HX0VW&quot;ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 129 +                                    &quot;RU5UX0ZBQ1RPUlkBABJMamF2YS9sYW5nL1N0cmluZzsBABRMb2c0akxvZ0V2ZW50RmFjdG9yeQgA&quot; +"> 129 +                                    &quot;RU5UX0ZBQ1RPUlkBABJMamF2YS9sYW5nL1N0cmluZzsBABRMb2c0akxvZ0V2ZW50RmFjdG9yeQgA&quot;ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 130 +                                    &quot;CAEAFkxPRzRKX0NPTlRFWFRfU0VMRUNUT1IBABRMb2c0akNvbnRleHRTZWxlY3RvcggACwEAGkxP&quot; +"> 130 +                                    &quot;CAEAFkxPRzRKX0NPTlRFWFRfU0VMRUNUT1IBABRMb2c0akNvbnRleHRTZWxlY3RvcggACwEAGkxP&quot;ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 131 +                                    &quot;RzRKX0RFRkFVTFRfU1RBVFVTX0xFVkVMAQAXTG9nNGpEZWZhdWx0U3RhdHVzTGV2ZWwIAA4BABFK&quot; +"> 131 +                                    &quot;RzRKX0RFRkFVTFRfU1RBVFVTX0xFVkVMAQAXTG9nNGpEZWZhdWx0U3RhdHVzTGV2ZWwIAA4BABFK&quot;ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 132 +                                    &quot;TkRJX0NPTlRFWFRfTkFNRQEAIGphdmE6Y29tcC9lbnYvbG9nNGovY29udGV4dC1uYW1lCAARAQAR&quot; +"> 132 +                                    &quot;TkRJX0NPTlRFWFRfTkFNRQEAIGphdmE6Y29tcC9lbnYvbG9nNGovY29udGV4dC1uYW1lCAARAQAR&quot;ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 133 +                                    &quot;TUlMTElTX0lOX1NFQ09ORFMBAAFJAwAAA+gBAB1GT1JNQVRfTUVTU0FHRVNfSU5fQkFDS0dST1VO&quot; +"> 133 +                                    &quot;TUlMTElTX0lOX1NFQ09ORFMBAAFJAwAAA+gBAB1GT1JNQVRfTUVTU0FHRVNfSU5fQkFDS0dST1VO&quot;ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 134 +                                    &quot;RAEAAVoBACdGT1JNQVRfTUVTU0FHRVNfUEFUVEVSTl9ESVNBQkxFX0xPT0tVUFMBAApJU19XRUJf&quot; +"> 134 +                                    &quot;RAEAAVoBACdGT1JNQVRfTUVTU0FHRVNfUEFUVEVSTl9ESVNBQkxFX0xPT0tVUFMBAApJU19XRUJf&quot;ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 135 +                                    &quot;QVBQAQATRU5BQkxFX1RIUkVBRExPQ0FMUwEAFkVOQUJMRV9ESVJFQ1RfRU5DT0RFUlMBAB1JTklU&quot; +"> 135 +                                    &quot;QVBQAQATRU5BQkxFX1RIUkVBRExPQ0FMUwEAFkVOQUJMRV9ESVJFQ1RfRU5DT0RFUlMBAB1JTklU&quot;ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 136 +                                    &quot;SUFMX1JFVVNBQkxFX01FU1NBR0VfU0laRQEAGU1BWF9SRVVTQUJMRV9NRVNTQUdFX1NJWkUBABhF&quot; +"> 136 +                                    &quot;SUFMX1JFVVNBQkxFX01FU1NBR0VfU0laRQEAGU1BWF9SRVVTQUJMRV9NRVNTQUdFX1NJWkUBABhF&quot;ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 137 +                                    &quot;TkNPREVSX0NIQVJfQlVGRkVSX1NJWkUBABhFTkNPREVSX0JZVEVfQlVGRkVSX1NJWkUBAARzaXpl&quot; +"> 137 +                                    &quot;TkNPREVSX0NIQVJfQlVGRkVSX1NJWkUBABhFTkNPREVSX0JZVEVfQlVGRkVSX1NJWkUBAARzaXpl&quot;ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 138 +                                    &quot;AQAWKExqYXZhL2xhbmcvU3RyaW5nO0kpSQEACHByb3BlcnR5AQAMZGVmYXVsdFZhbHVlAQAsb3Jn&quot; +"> 138 +                                    &quot;AQAWKExqYXZhL2xhbmcvU3RyaW5nO0kpSQEACHByb3BlcnR5AQAMZGVmYXVsdFZhbHVlAQAsb3Jn&quot;ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 139 +                                    &quot;L2FwYWNoZS9sb2dnaW5nL2xvZzRqL3V0aWwvUHJvcGVydGllc1V0aWwHACQBAA1nZXRQcm9wZXJ0&quot; +"> 139 +                                    &quot;L2FwYWNoZS9sb2dnaW5nL2xvZzRqL3V0aWwvUHJvcGVydGllc1V0aWwHACQBAA1nZXRQcm9wZXJ0&quot;ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 140 +                                    &quot;aWVzAQAwKClMb3JnL2FwYWNoZS9sb2dnaW5nL2xvZzRqL3V0aWwvUHJvcGVydGllc1V0aWw7DAAm&quot; +"> 140 +                                    &quot;aWVzAQAwKClMb3JnL2FwYWNoZS9sb2dnaW5nL2xvZzRqL3V0aWwvUHJvcGVydGllc1V0aWw7DAAm&quot;ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 141 +                                    &quot;ACcKACUAKAEAEmdldEludGVnZXJQcm9wZXJ0eQwAKgAhCgAlACsBAAY8aW5pdD4BAAMoKVYMAC0A&quot; +"> 141 +                                    &quot;ACcKACUAKAEAEmdldEludGVnZXJQcm9wZXJ0eQwAKgAhCgAlACsBAAY8aW5pdD4BAAMoKVYMAC0A&quot;ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 142 +                                    &quot;LgoABAAvAQAEdGhpcwEALkxvcmcvYXBhY2hlL2xvZ2dpbmcvbG9nNGovY29yZS91dGlsL0NvbnN0&quot; +"> 142 +                                    &quot;LgoABAAvAQAEdGhpcwEALkxvcmcvYXBhY2hlL2xvZ2dpbmcvbG9nNGovY29yZS91dGlsL0NvbnN0&quot;ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 143 +                                    &quot;YW50czsBAAg8Y2xpbml0PgEAFmxvZzRqLmZvcm1hdC5tc2cuYXN5bmMIADQBABJnZXRCb29sZWFu&quot; +"> 143 +                                    &quot;YW50czsBAAg8Y2xpbml0PgEAFmxvZzRqLmZvcm1hdC5tc2cuYXN5bmMIADQBABJnZXRCb29sZWFu&quot;ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 144 +                                    &quot;UHJvcGVydHkBABYoTGphdmEvbGFuZy9TdHJpbmc7WilaDAA2ADcKACUAOAwAFgAXCQACADoBABls&quot; +"> 144 +                                    &quot;UHJvcGVydHkBABYoTGphdmEvbGFuZy9TdHJpbmc7WilaDAA2ADcKACUAOAwAFgAXCQACADoBABls&quot;ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 145 +                                    &quot;b2c0ajIuZm9ybWF0TXNnTm9Mb29rdXBzCAA8DAAYABcJAAIAPgEAJ29yZy9hcGFjaGUvbG9nZ2lu&quot; +"> 145 +                                    &quot;b2c0ajIuZm9ybWF0TXNnTm9Mb29rdXBzCAA8DAAYABcJAAIAPgEAJ29yZy9hcGFjaGUvbG9nZ2lu&quot;ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 146 +                                    &quot;Zy9sb2c0ai91dGlsL0NvbnN0YW50cwcAQAwAGQAXCQBBAEIJAAIAQgwAGgAXCQBBAEUJAAIARQEA&quot; +"> 146 +                                    &quot;Zy9sb2c0ai91dGlsL0NvbnN0YW50cwcAQAwAGQAXCQBBAEIJAAIAQgwAGgAXCQBBAEUJAAIARQEA&quot;ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 147 +                                    &quot;HWxvZzRqMi5lbmFibGUuZGlyZWN0LmVuY29kZXJzCABIDAAbABcJAAIASgEAHGxvZzRqLmluaXRp&quot; +"> 147 +                                    &quot;HWxvZzRqMi5lbmFibGUuZGlyZWN0LmVuY29kZXJzCABIDAAbABcJAAIASgEAHGxvZzRqLmluaXRp&quot;ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 148 +                                    &quot;YWxSZXVzYWJsZU1zZ1NpemUIAEwMACAAIQoAAgBODAAcABQJAAIAUAEAGGxvZzRqLm1heFJldXNh&quot; +"> 148 +                                    &quot;YWxSZXVzYWJsZU1zZ1NpemUIAEwMACAAIQoAAgBODAAcABQJAAIAUAEAGGxvZzRqLm1heFJldXNh&quot;ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 149 +                                    &quot;YmxlTXNnU2l6ZQgAUgwAHQAUCQACAFQBABxsb2c0ai5lbmNvZGVyLmNoYXJCdWZmZXJTaXplCABW&quot; +"> 149 +                                    &quot;YmxlTXNnU2l6ZQgAUgwAHQAUCQACAFQBABxsb2c0ai5lbmNvZGVyLmNoYXJCdWZmZXJTaXplCABW&quot;ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 150 +                                    &quot;DAAeABQJAAIAWAEAHGxvZzRqLmVuY29kZXIuYnl0ZUJ1ZmZlclNpemUIAFoMAB8AFAkAAgBcAQAN&quot; +"> 150 +                                    &quot;DAAeABQJAAIAWAEAHGxvZzRqLmVuY29kZXIuYnl0ZUJ1ZmZlclNpemUIAFoMAB8AFAkAAgBcAQAN&quot;ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 151 +                                    &quot;Q29uc3RhbnRWYWx1ZQEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBABJMb2NhbFZhcmlhYmxlVGFi&quot; +"> 151 +                                    &quot;Q29uc3RhbnRWYWx1ZQEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBABJMb2NhbFZhcmlhYmxlVGFi&quot;ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 152 +                                    &quot;bGUBABBNZXRob2RQYXJhbWV0ZXJzAQAKU291cmNlRmlsZQAxAAIABAAAAA4AGQAGAAcAAQBeAAAA&quot; +"> 152 +                                    &quot;bGUBABBNZXRob2RQYXJhbWV0ZXJzAQAKU291cmNlRmlsZQAxAAIABAAAAA4AGQAGAAcAAQBeAAAA&quot;ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 153 +                                    &quot;AgAJABkACgAHAAEAXgAAAAIADAAZAA0ABwABAF4AAAACAA8AGQAQAAcAAQBeAAAAAgASABkAEwAU&quot; +"> 153 +                                    &quot;AgAJABkACgAHAAEAXgAAAAIADAAZAA0ABwABAF4AAAACAA8AGQAQAAcAAQBeAAAAAgASABkAEwAU&quot;ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 154 +                                    &quot;AAEAXgAAAAIAFQAZABYAFwAAABkAGAAXAAAAGQAZABcAAAAZABoAFwAAABkAGwAXAAAAGQAcABQA&quot; +"> 154 +                                    &quot;AAEAXgAAAAIAFQAZABYAFwAAABkAGAAXAAAAGQAZABcAAAAZABoAFwAAABkAGwAXAAAAGQAcABQA&quot;ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 155 +                                    &quot;AAAZAB0AFAAAABkAHgAUAAAAGQAfABQAAAADAAoAIAAhAAIAXwAAAD0AAwACAAAACbgAKSobtgAs&quot; +"> 155 +                                    &quot;AAAZAB0AFAAAABkAHgAUAAAAGQAfABQAAAADAAoAIAAhAAIAXwAAAD0AAwACAAAACbgAKSobtgAs&quot;ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 156 +                                    &quot;rAAAAAIAYAAAAAYAAQAAAIwAYQAAABYAAgAAAAkAIgAHAAAAAAAJACMAFAABAGIAAAAJAgAiABAA&quot; +"> 156 +                                    &quot;rAAAAAIAYAAAAAYAAQAAAIwAYQAAABYAAgAAAAkAIgAHAAAAAAAJACMAFAABAGIAAAAJAgAiABAA&quot;ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 157 +                                    &quot;IwAQAAIALQAuAAEAXwAAADMAAQABAAAABSq3ADCxAAAAAgBgAAAACgACAAAAkgAEAJMAYQAAAAwA&quot; +"> 157 +                                    &quot;IwAQAAIALQAuAAEAXwAAADMAAQABAAAABSq3ADCxAAAAAgBgAAAACgACAAAAkgAEAJMAYQAAAAwA&quot;ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 158 +                                    &quot;AQAAAAUAMQAyAAAACAAzAC4AAQBfAAAAlQADAAAAAABduAApEjUDtgA5swA7uAApEj0EtgA5swA/&quot; +"> 158 +                                    &quot;AQAAAAUAMQAyAAAACAAzAC4AAQBfAAAAlQADAAAAAABduAApEjUDtgA5swA7uAApEj0EtgA5swA/&quot;ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 159 +                                    &quot;sgBDswBEsgBGswBHuAApEkkEtgA5swBLEk0RAIC4AE+zAFESUxECBrgAT7MAVRJXEQgAuABPswBZ&quot; +"> 159 +                                    &quot;sgBDswBEsgBGswBHuAApEkkEtgA5swBLEk0RAIC4AE+zAFESUxECBrgAT7MAVRJXEQgAuABPswBZ&quot;ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 160 +                                    &quot;ElsRIAC4AE+zAF2xAAAAAQBgAAAAJgAJAAAANgAMAD8AGABHAB4AUQAkAF4AMABqADsAdQBGAH4A&quot; +"> 160 +                                    &quot;ElsRIAC4AE+zAF2xAAAAAQBgAAAAJgAJAAAANgAMAD8AGABHAB4AUQAkAF4AMABqADsAdQBGAH4A&quot;ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 161 +                                    &quot;UQCIAAEAYwAAAAIABQ==&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 162 +                            out.write(newClass);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 163 +                            break;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 164 +                        /* Commented out because of compatibility issues - JNDI will be deleted instead</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 165 +                           (which will help in almost the same way).</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 166 +                        --- BEGIN COMMENTED OUT CODE ---</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 167 +                        case &quot;org/apache/logging/log4j/core/lookup/Interpolator&quot;:</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 168 +                            try {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 169 +                                // Read class</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 170 +                                ByteArrayOutputStream baos = new ByteArrayOutputStream();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 171 +                                byte[] buf = new byte[4096];</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 172 +                                int i;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 173 +                                while ((i = in.read(buf)) &gt; 0) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 174 +                                    baos.write(buf, 0, i);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 175 +                                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 176 +                                ClassReader classReader = new ClassReader(baos.toByteArray());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 177 +                                ClassNode node = new ClassNode();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 178 +                                classReader.accept(node, 0);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 179 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 180 +                                FieldNode fn;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 181 +                                {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 182 +                                    Optional&lt;FieldNode&gt; optionalFieldNode = node.fields.stream().filter(fieldNode -&gt; fieldNode.desc.contains(&quot;Map&quot;)).findFirst();"> 182 +                                    Optional&lt;FieldNode&gt; optionalFieldNode = node.fields.stream().filter(fieldNode ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 183 +                                    if(optionalFieldNode.isPresent())</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 184 +                                        fn = optionalFieldNode.get();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 185 +                                    else</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 186 +                                        throw new NoSuchFieldException(); // This will be caught.</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 187 +                                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 188 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 189 +                                // Transform class</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 190 +                                InsnList patch = new InsnList();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 191 +                                patch.add(new VarInsnNode(Opcodes.ALOAD, 0));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 192 +                                patch.add(new FieldInsnNode(Opcodes.GETFIELD, &quot;org/apache/logging/log4j/core/lookup/Interpolator&quot;, fn.name, fn.desc));"> 192 +                                patch.add(new FieldInsnNode(Opcodes.GETFIELD, &quot;org/apache/logging/log4j/core/lookuðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 193 +                                patch.add(new LdcInsnNode(&quot;jndi&quot;));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 194 +                                patch.add(new MethodInsnNode(Opcodes.INVOKEINTERFACE, &quot;java/util/Map&quot;, &quot;remove&quot;, &quot;(Ljava/lang/Object;)Ljava/lang/Object;&quot;, true));"> 194 +                                patch.add(new MethodInsnNode(Opcodes.INVOKEINTERFACE, &quot;java/util/Map&quot;, &quot;remove&quot;, &quot;ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 195 +                                patch.add(new InsnNode(Opcodes.POP));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 196 +                                for (MethodNode method : node.methods) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 197 +                                    if ((method.access &amp; Opcodes.ACC_STATIC) == 0)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 198 +                                        method.instructions.insertBefore(method.instructions.getFirst(), patch);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 199 +                                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 200 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 201 +                                // Write class back into zip file</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 202 +                                ClassWriter classWriter = new ClassWriter(ClassWriter.COMPUTE_FRAMES);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 203 +                                node.accept(classWriter);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 204 +                                out.write(classWriter.toByteArray());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 205 +                            } catch (Throwable throwable) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 206 +                                System.err.println(&quot;Couldn&#x27;t fully vaccinate! Deleting JNDILookup to make program crash when the exploit is used!!&quot;);"> 206 +                                System.err.println(&quot;Couldn&#x27;t fully vaccinate! Deleting JNDILookup to make program ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 207 +                            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 208 +                            break;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 209 +                        --- END COMMENTED OUT CODE ---</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 210 +                         */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 211 +                        case &quot;org/apache/logging/log4j/core/lookup/JndiLookup.class&quot;:</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 212 +                            break;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 213 +                        case &quot;META-INF/org/apache/logging/log4j/core/config/plugins/Log4j2Plugins.dat&quot;:</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 214 +                            DataOutputStream os = new DataOutputStream(out);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 215 +                            DataInputStream is = new DataInputStream(new BufferedInputStream(in));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 216 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 217 +                            // The old count</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 218 +                            int count = is.readInt();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 219 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 220 +                            // Names of the visited categories</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 221 +                            String[] categoryNames = new String[count];</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 222 +                            // Counts in categories</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 223 +                            int[] ecounts = new int[count];</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 224 +                            // Bytes of the plugin entries, [category count][entries in category][bytes]</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 225 +                            byte[][][] bytes = new byte[count][][];</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 226 +                            for (int i = 0; i &lt; count; i++) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 227 +                                // Category name is read and stores</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 228 +                                categoryNames[i] = is.readUTF();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 229 +                                // Amount of entries in category is read and stored, ecounts[i] will be modified gradually."> 229 +                                // Amount of entries in category is read and stored, ecounts[i] will be modified gðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 230 +                                int ecount = ecounts[i] = is.readInt();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 231 +                                // Initialize bytearray for this category</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 232 +                                bytes[i] = new byte[ecount][];</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 233 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 234 +                                // Loop through each plugin</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 235 +                                for (int j = 0; j &lt; ecount; j++) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 236 +                                    // Create streams for this plugin</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 237 +                                    ByteArrayOutputStream baos = new ByteArrayOutputStream();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 238 +                                    DataOutputStream dos = new DataOutputStream(baos);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 239 +                                    // Read the name</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 240 +                                    String name = is.readUTF();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 241 +                                    // Copy plugin data to plugin byte array</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 242 +                                    dos.writeUTF(name);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 243 +                                    dos.writeUTF(is.readUTF());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 244 +                                    dos.writeUTF(is.readUTF());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 245 +                                    dos.writeBoolean(is.readBoolean());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 246 +                                    dos.writeBoolean(is.readBoolean());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 247 +                                    // Store plugin byte array unless it is JNDI</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 248 +                                    if(name.equals(&quot;jndi&quot;)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 249 +                                        ecounts[i]--;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 250 +                                    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 251 +                                    else</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 252 +                                        bytes[i][j - (ecount - ecounts[i])] = baos.toByteArray();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 253 +                                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 254 +                            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 255 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 256 +                            // Write back the data we just read</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 257 +                            os.writeInt(count);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 258 +                            for (int i = 0; i &lt; count; i++) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 259 +                                // Write category name</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 260 +                                os.writeUTF(categoryNames[i]);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 261 +                                // Amount of plugins in category</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 262 +                                int ecount = ecounts[i];</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 263 +                                // Write number of plugins in category</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 264 +                                os.writeInt(ecount);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 265 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 266 +                                // Loop through each plugin and write its bytes</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 267 +                                for (int j = 0; j &lt; ecount; j++) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 268 +                                    os.write(bytes[i][j]);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 269 +                                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 270 +                            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 271 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 272 +                            break;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 273 +                        default:</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 274 +                            byte[] buf = new byte[4096];</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 275 +                            int i;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 276 +                            while ((i = in.read(buf)) &gt; 0) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 277 +                                out.write(buf, 0, i);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 278 +                            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 279 +                            break;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 280 +                    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 281 +                    out.closeEntry();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 282 +                    in.closeEntry();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 283 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 284 +                in.close();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 285 +                out.close();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 286 +                if (!jar.delete() || !fixedjar.renameTo(jar)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 287 +                    System.err.println(&quot;Couldn&#x27;t patch jar.&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 288 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 289 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 290 +            catch (Exception e) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 291 +                System.err.println(&quot;Couldn&#x27;t patch jar.&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 292 +                e.printStackTrace();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 293 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 294 +        }</span>
 295      }
 296  
 297      private static void setAccess(Field field) throws NoSuchFieldException, IllegalAccessException {
 298          field.setAccessible(true);
 299          Field modifiersField = Field.class.getDeclaredField(&quot;modifiers&quot;);
 300          modifiersField.setAccessible(true);
 301          modifiersField.setInt(field, field.getModifiers() &amp; ~Modifier.FINAL);
 302      }
 303  }</pre></td>
                            <td><pre>   1  import org.apache.logging.log4j.LogManager;











   2  import org.apache.logging.log4j.core.LoggerContext;
   3  import org.apache.logging.log4j.core.config.Configuration;
   4  import org.apache.logging.log4j.core.config.Configurator;
   5  import org.apache.logging.log4j.core.lookup.Interpolator;
   6  import org.apache.logging.log4j.core.lookup.StrLookup;
   7  import org.apache.logging.log4j.core.selector.ContextSelector;
   8  

   9  import java.lang.reflect.Field;
  10  import java.lang.reflect.Constructor;
  11  import java.lang.reflect.Method;
  12  import java.lang.reflect.Modifier;
  13  import java.util.HashMap;





  14  import java.util.Map;
  15  
  16  public class Log4jRCE {
  17      static {

  18          try {
  19              try { // Try for versions of Log4j &gt;= 2.10
<abbr title="  20                Class&lt;?&gt; c = Thread.currentThread().getContextClassLoader().loadClass(&quot;org.apache.logging.log4j.core.util.Constants&quot;);">  20                Class&lt;?&gt; c = Thread.currentThread().getContextClassLoader().loadClass(&quot;org.apache.logging.log4j.coreðŸ”µ</abbr>
  21                Field field = c.getField(&quot;FORMAT_MESSAGES_PATTERN_DISABLE_LOOKUPS&quot;);
  22                System.out.println(&quot;Setting &quot; + field.getName() + &quot; value to True&quot;);
  23                setFinalStatic(field, Boolean.TRUE);
  24              } catch (NoSuchFieldException e) { // Fall back to older versions. Try to make JNDI non instantiable







  25                  System.err.println(&quot;No field FORMAT_MESSAGES_PATTERN_DISABLE_LOOKUPS - version &lt;= 2.9.0&quot;);
  26                  System.err.println(&quot;Will attempt to modify the configuration directly&quot;);
  27              }
  28  
  29              //reconfiguring log4j

  30              ClassLoader classLoader = Thread.currentThread().getContextClassLoader();
<abbr title="  31              Class&lt;?&gt; configuratorClass = classLoader.loadClass(&quot;org.apache.logging.log4j.core.config.Configurator&quot;);">  31              Class&lt;?&gt; configuratorClass = classLoader.loadClass(&quot;org.apache.logging.log4j.core.config.Configurator&quot;ðŸ”µ</abbr>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  32 -            try {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  33 -                Method reconfigure = configuratorClass.getMethod(&quot;reconfigure&quot;);</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  34 -                reconfigure.invoke(null);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  35 -            } catch (Exception ex) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  36 -                Method getFactoryMethod = configuratorClass.getDeclaredMethod(&quot;getFactory&quot;);</span>


<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  37 -                getFactoryMethod.setAccessible(true);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  38 -                Object factory = getFactoryMethod.invoke(null);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title="  39 -                Class&lt;?&gt; log4jContextFactoryClass = classLoader.loadClass(&quot;org.apache.logging.log4j.core.impl.Log4jContextFactory&quot;);">  39 -                Class&lt;?&gt; log4jContextFactoryClass = classLoader.loadClass(&quot;org.apache.logging.log4j.core.impl.Log4ðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  40 -                Method getSelector = log4jContextFactoryClass.getMethod(&quot;getSelector&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  41 -                Object contextSelector = getSelector.invoke(factory, null);</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  42 -                ContextSelector ctxSelector = (ContextSelector) contextSelector;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  43 -                for (LoggerContext ctx: ctxSelector.getLoggerContexts()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  44 -                    ctx.reconfigure();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  45 -                    System.err.println(&quot;Reconfiguring context&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  46 -                    Configuration config = ctx.getConfiguration();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  47 -                    StrLookup resolver = config.getStrSubstitutor().getVariableResolver();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  48 -                    if (resolver instanceof Interpolator) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  49 -                        System.err.println(&quot;Lookup is an Interpolator - attempting to remove JNDI&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  50 -                        Field lookups = null;</span>


<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  51 -                        try {</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  52 -                            lookups = Interpolator.class.getDeclaredField(&quot;lookups&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  53 -                        } catch (NoSuchFieldException e) {</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  54 -                            lookups = Interpolator.class.getDeclaredField(&quot;strLookupMap&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  55 -                        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  56 -                        lookups.setAccessible(true);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  57 -                        Map&lt;String, StrLookup&gt; lookupMap = (Map&lt;String, StrLookup&gt;) lookups.get(resolver);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  58 -                        lookupMap.remove(&quot;jndi&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  59 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  60 +            // Due to CVE-2021-45046 we&#x27;re no longer using the reconfigure method -</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  61 +            // Instead we reconfigure the logger but *also* remove the JNDI listener from the plugin map</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  62 +            //try {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  63 +            //    Method reconfigure = configuratorClass.getMethod(&quot;reconfigure&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  64 +            //    reconfigure.invoke(null);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  65 +            //} catch (Exception ex) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  66 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  67 +            Method getFactoryMethod = configuratorClass.getDeclaredMethod(&quot;getFactory&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  68 +            getFactoryMethod.setAccessible(true);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  69 +            Object factory = getFactoryMethod.invoke(null);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title="  70 +            Class&lt;?&gt; log4jContextFactoryClass = classLoader.loadClass(&quot;org.apache.logging.log4j.core.impl.Log4jContextFactory&quot;);">  70 +            Class&lt;?&gt; log4jContextFactoryClass = classLoader.loadClass(&quot;org.apache.logging.log4j.core.impl.Log4jConðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  71 +            Method getSelector = log4jContextFactoryClass.getMethod(&quot;getSelector&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  72 +            Object contextSelector = getSelector.invoke(factory, null);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  73 +            ContextSelector ctxSelector = (ContextSelector) contextSelector;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  74 +            for (LoggerContext ctx: ctxSelector.getLoggerContexts()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  75 +                // The following deadlocks in some tests when using ThreadContext attacks</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  76 +                //ctx.reconfigure();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  77 +                Configuration config = ctx.getConfiguration();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  78 +                StrLookup resolver = config.getStrSubstitutor().getVariableResolver();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  79 +                if (resolver instanceof Interpolator) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  80 +                    System.err.println(&quot;Lookup is an Interpolator - removing JNDI&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  81 +                    Field lookups = null;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  82 +                    try {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  83 +                        lookups = Interpolator.class.getDeclaredField(&quot;lookups&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  84 +                    } catch (NoSuchFieldException e) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  85 +                        lookups = Interpolator.class.getDeclaredField(&quot;strLookupMap&quot;);</span>
  86                      }
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  87 +                    lookups.setAccessible(true);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  88 +                    Map&lt;String, StrLookup&gt; lookupMap = (Map&lt;String, StrLookup&gt;) lookups.get(resolver);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  89 +                    lookupMap.remove(&quot;jndi&quot;);</span>
  90                  }
  91              }
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  92 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  93 +            //}</span>
  94          } catch (Exception e) {

  95              System.err.println(&quot;Exception &quot; + e);
  96              e.printStackTrace();
  97          }




  98      }
  99  
 100      static void setFinalStatic(Field field, Object newValue) throws Exception {
 101          setAccess(field);
 102          field.set(null, newValue);
























































































































































































 103      }
 104  
 105      private static void setAccess(Field field) throws NoSuchFieldException, IllegalAccessException {
 106          field.setAccessible(true);
 107          Field modifiersField = Field.class.getDeclaredField(&quot;modifiers&quot;);
 108          modifiersField.setAccessible(true);
 109          modifiersField.setInt(field, field.getModifiers() &amp; ~Modifier.FINAL);
 110      }
 111  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            