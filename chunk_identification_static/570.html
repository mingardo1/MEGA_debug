<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>570</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    570
                    <a href="569.html">prev</a>
                    <a href="571.html">next</a>
                    <a href="570_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    DTStack/flinkStreamSQL_d3f904d1d764e0acb7127ddbeb050c2b3ff060b3_elasticsearch6/elasticsearch6-side/elasticsearch6-async-side/src/main/java/com/dtstack/flink/sql/side/elasticsearch6/Elasticsearch6AsyncReqRow.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;d3f904d1d764e0acb7127ddbeb050c2b3ff060b3:elasticsearch6/elasticsearch6-side/elasticsearch6-async-side/src/main/java/com/dtstack/flink/sql/side/elasticsearch6/Elasticsearch6AsyncReqRow.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;d3f904d1d764e0acb7127ddbeb050c2b3ff060b3^1:elasticsearch6/elasticsearch6-side/elasticsearch6-async-side/src/main/java/com/dtstack/flink/sql/side/elasticsearch6/Elasticsearch6AsyncReqRow.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;d3f904d1d764e0acb7127ddbeb050c2b3ff060b3^2:elasticsearch6/elasticsearch6-side/elasticsearch6-async-side/src/main/java/com/dtstack/flink/sql/side/elasticsearch6/Elasticsearch6AsyncReqRow.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;d124305ffe07b66f8eee430b3c0ac1072281dc14:elasticsearch6/elasticsearch6-side/elasticsearch6-async-side/src/main/java/com/dtstack/flink/sql/side/elasticsearch6/Elasticsearch6AsyncReqRow.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[b]], subset: [[b]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 /*
   2  * Licensed to the Apache Software Foundation (ASF) under one
   3  * or more contributor license agreements.  See the NOTICE file
   4  * distributed with this work for additional information
   5  * regarding copyright ownership.  The ASF licenses this file
   6  * to you under the Apache License, Version 2.0 (the
   7  * &quot;License&quot;); you may not use this file except in compliance
   8  * with the License.  You may obtain a copy of the License at
   9  *
  10  *     http://www.apache.org/licenses/LICENSE-2.0
  11  *
  12  * Unless required by applicable law or agreed to in writing, software
  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15  * See the License for the specific language governing permissions and
  16  * limitations under the License.
  17  */
  18 
  19 package com.dtstack.flink.sql.side.elasticsearch6;
  20 
  21 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  22 import org.apache.flink.api.java.tuple.Tuple2;</span>
  23 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  24 import org.apache.flink.api.java.typeutils.RowTypeInfo;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  25 import org.apache.flink.configuration.Configuration;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  26 import org.apache.flink.streaming.api.functions.async.ResultFuture;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  27 import org.apache.flink.table.runtime.types.CRow;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  28 import org.apache.flink.table.typeutils.TimeIndicatorTypeInfo;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  29 import org.apache.flink.types.Row;</span>
  30 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  31 import com.dtstack.flink.sql.side.AbstractSideTableInfo;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  32 import com.dtstack.flink.sql.side.BaseAsyncReqRow;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  33 import com.dtstack.flink.sql.side.CacheMissVal;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  34 import com.dtstack.flink.sql.side.FieldInfo;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  35 import com.dtstack.flink.sql.side.JoinInfo;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  36 import com.dtstack.flink.sql.side.PredicateInfo;</span>
  37 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
  38 import org.apache.flink.api.java.typeutils.RowTypeInfo;
  39 import org.apache.flink.configuration.Configuration;
  40 import org.apache.flink.streaming.api.functions.async.ResultFuture;
  41 import org.apache.flink.table.typeutils.TimeIndicatorTypeInfo;
  42 import org.apache.flink.types.Row;
  43 
  44 import com.dtstack.flink.sql.enums.ECacheContentType;
  45 import com.dtstack.flink.sql.side.cache.CacheObj;
  46 import com.dtstack.flink.sql.side.elasticsearch6.table.Elasticsearch6SideTableInfo;
  47 import com.dtstack.flink.sql.side.elasticsearch6.util.Es6Util;
  48 import com.dtstack.flink.sql.side.elasticsearch6.util.SwitchUtil;
  49 import com.dtstack.flink.sql.util.ParseUtils;
  50 import com.google.common.collect.Lists;
  51 import org.apache.calcite.sql.SqlNode;
  52 import org.apache.commons.lang3.StringUtils;
  53 import org.elasticsearch.action.ActionListener;
  54 import org.elasticsearch.action.search.SearchRequest;
  55 import org.elasticsearch.action.search.SearchResponse;
  56 import org.elasticsearch.client.RequestOptions;
  57 import org.elasticsearch.client.RestHighLevelClient;
  58 import org.elasticsearch.index.query.BoolQueryBuilder;
  59 import org.elasticsearch.search.SearchHit;
  60 import org.elasticsearch.search.builder.SearchSourceBuilder;
  61 import org.elasticsearch.search.sort.SortOrder;
  62 import org.slf4j.Logger;
  63 import org.slf4j.LoggerFactory;
  64 
  65 import java.io.IOException;
  66 import java.io.Serializable;
  67 import java.sql.Timestamp;
  68 import java.util.List;
  69 import java.util.Map;
  70 
  71 /**
  72  * @author yinxi
  73  * @date 2020/2/13 - 13:10
  74  */
  75 public class Elasticsearch6AsyncReqRow extends BaseAsyncReqRow implements Serializable {
  76 
  77     private static final Logger LOG = LoggerFactory.getLogger(Elasticsearch6AsyncReqRow.class);
  78     private transient RestHighLevelClient rhlClient;
  79     private SearchRequest searchRequest;
  80     private List&lt;String&gt; sqlJoinCompareOperate = Lists.newArrayList();
  81 
<abbr title="  82     public Elasticsearch6AsyncReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, AbstractSideTableInfo sideTableInfo) {">  82     public Elasticsearch6AsyncReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outField🔵</abbr>
  83         super(new Elasticsearch6AsyncSideInfo(rowTypeInfo, joinInfo, outFieldInfoList, sideTableInfo));
  84         SqlNode conditionNode = joinInfo.getCondition();
  85         ParseUtils.parseJoinCompareOperate(conditionNode, sqlJoinCompareOperate);
  86     }
  87 
  88     @Override
  89     public void open(Configuration parameters) throws Exception {
  90         super.open(parameters);
<abbr title="  91         Elasticsearch6SideTableInfo tableInfo = (Elasticsearch6SideTableInfo) sideInfo.getSideTableInfo();">  91         Elasticsearch6SideTableInfo tableInfo = (Elasticsearch6SideTableInfo) sideInfo.getSideTableInfo()🔵</abbr>
<abbr title="  92         rhlClient = Es6Util.getClient(tableInfo.getAddress(), tableInfo.isAuthMesh(), tableInfo.getUserName(), tableInfo.getPassword());">  92         rhlClient = Es6Util.getClient(tableInfo.getAddress(), tableInfo.isAuthMesh(), tableInfo.getUserNa🔵</abbr>
  93         searchRequest = Es6Util.setSearchRequest(sideInfo);
  94 
  95     }
  96 
  97 
  98     @Override
<abbr title="  99     public void asyncInvoke(Tuple2&lt;Boolean,Row&gt; input, ResultFuture&lt;Tuple2&lt;Boolean,Row&gt;&gt; resultFuture) throws Exception {">  99     public void asyncInvoke(Tuple2&lt;Boolean,Row&gt; input, ResultFuture&lt;Tuple2&lt;Boolean,Row&gt;&gt; resultFuture) th🔵</abbr>
 100         Tuple2&lt;Boolean,Row&gt; copyInput= Tuple2.of(input.f0,input.f1);
 101         List&lt;Object&gt; inputParams = Lists.newArrayList();
 102         for (Integer conValIndex : sideInfo.getEqualValIndex()) {
 103             Object equalObj = copyInput.f1.getField(conValIndex);
 104             if (equalObj == null) {
 105                 dealMissKey(copyInput, resultFuture);
 106                 return;
 107             }
 108             inputParams.add(equalObj);
 109         }
 110 
 111         String key = buildCacheKey(inputParams);
 112         if (openCache()) {
 113             CacheObj val = getFromCache(key);
 114             if (val != null) {
 115                 if (ECacheContentType.MissVal == val.getType()) {
 116                     dealMissKey(copyInput, resultFuture);
 117                     return;
 118                 } else if (ECacheContentType.MultiLine == val.getType()) {
 119                     try {
<abbr title=" 120                         List&lt;Tuple2&lt;Boolean,Row&gt;&gt; rowList = getRows(copyInput, null, (List) val.getContent());"> 120                         List&lt;Tuple2&lt;Boolean,Row&gt;&gt; rowList = getRows(copyInput, null, (List) val.getConten🔵</abbr>
 121                         resultFuture.complete(rowList);
 122                     } catch (Exception e) {
 123                         dealFillDataError(resultFuture, e, copyInput);
 124                     }
 125                 } else {
<abbr title=" 126                     resultFuture.completeExceptionally(new RuntimeException(&quot;not support cache obj type &quot; + val.getType()));"> 126                     resultFuture.completeExceptionally(new RuntimeException(&quot;not support cache obj type &quot;🔵</abbr>
 127                 }
 128                 return;
 129             }
 130         }
 131 
 132         BoolQueryBuilder boolQueryBuilder = Es6Util.setPredicateclause(sideInfo);
 133         boolQueryBuilder = setInputParams(inputParams, boolQueryBuilder);
 134         SearchSourceBuilder searchSourceBuilder = initConfiguration();
 135         searchSourceBuilder.query(boolQueryBuilder);
 136         searchRequest.source(searchSourceBuilder);
 137 
 138         // 异步查询数据
<abbr title=" 139         rhlClient.searchAsync(searchRequest, RequestOptions.DEFAULT, new ActionListener&lt;SearchResponse&gt;() {"> 139         rhlClient.searchAsync(searchRequest, RequestOptions.DEFAULT, new ActionListener&lt;SearchResponse&gt;()🔵</abbr>
 140 
 141             //成功响应时
 142             @Override
 143             public void onResponse(SearchResponse searchResponse) {
 144 
 145                 List&lt;Object&gt; cacheContent = Lists.newArrayList();
 146                 List&lt;Tuple2&lt;Boolean,Row&gt;&gt; rowList = Lists.newArrayList();
 147                 SearchHit[] searchHits = searchResponse.getHits().getHits();
 148                 if (searchHits.length &gt; 0) {
 149                     Elasticsearch6SideTableInfo tableInfo = null;
 150                     RestHighLevelClient tmpRhlClient = null;
 151                     try {
 152                         while (true) {
 153                             loadDataToCache(searchHits, rowList, cacheContent, copyInput);
 154                             // determine if all results haven been ferched
 155                             if (searchHits.length &lt; getFetchSize()) {
 156                                 break;
 157                             }
 158                             if (tableInfo == null &amp;&amp; tmpRhlClient == null) {
 159                                 // create new connection to fetch data
 160                                 tableInfo = (Elasticsearch6SideTableInfo) sideInfo.getSideTableInfo();
<abbr title=" 161                                 tmpRhlClient = Es6Util.getClient(tableInfo.getAddress(), tableInfo.isAuthMesh(), tableInfo.getUserName(), tableInfo.getPassword());"> 161                                 tmpRhlClient = Es6Util.getClient(tableInfo.getAddress(), tableInfo.isAuth🔵</abbr>
 162                             }
<abbr title=" 163                             Object[] searchAfterParameter = searchHits[searchHits.length - 1].getSortValues();"> 163                             Object[] searchAfterParameter = searchHits[searchHits.length - 1].getSortValu🔵</abbr>
 164                             searchSourceBuilder.searchAfter(searchAfterParameter);
 165                             searchRequest.source(searchSourceBuilder);
 166                             searchResponse = tmpRhlClient.search(searchRequest, RequestOptions.DEFAULT);
 167                             searchHits = searchResponse.getHits().getHits();
 168                         }
<abbr title=" 169                         dealCacheData(key, CacheObj.buildCacheObj(ECacheContentType.MultiLine, cacheContent));"> 169                         dealCacheData(key, CacheObj.buildCacheObj(ECacheContentType.MultiLine, cacheConte🔵</abbr>
 170                         resultFuture.complete(rowList);
 171                     } catch (Exception e) {
 172                         dealFillDataError(resultFuture, e, copyInput);
 173                     } finally {
 174                         if (tmpRhlClient != null) {
 175                             try {
 176                                 tmpRhlClient.close();
 177                             } catch (IOException e) {
 178                                 LOG.warn(&quot;Failed to shut down tmpRhlClient.&quot;, e);
 179                             }
 180                         }
 181                     }
 182                 } else {
 183                     dealMissKey(copyInput, resultFuture);
 184                     dealCacheData(key, CacheMissVal.getMissKeyObj());
 185                 }
 186             }
 187 
 188             // 响应失败处理
 189             @Override
 190             public void onFailure(Exception e) {
 191                 LOG.error(&quot;&quot; + e);
 192                 resultFuture.completeExceptionally(new RuntimeException(&quot;Response failed!&quot;));
 193             }
 194         });
 195 
 196     }
 197 
<abbr title=" 198     private void loadDataToCache(SearchHit[] searchHits, List&lt;Tuple2&lt;Boolean,Row&gt;&gt; rowList, List&lt;Object&gt; cacheContent, Tuple2&lt;Boolean,Row&gt; copyCrow) {"> 198     private void loadDataToCache(SearchHit[] searchHits, List&lt;Tuple2&lt;Boolean,Row&gt;&gt; rowList, List&lt;Object&gt; 🔵</abbr>
 199         List&lt;Object&gt; results = Lists.newArrayList();
 200         for (SearchHit searchHit : searchHits) {
 201             Map&lt;String, Object&gt; object = searchHit.getSourceAsMap();
 202             results.add(object);
 203         }
 204         rowList.addAll(getRows(copyCrow, cacheContent, results));
 205     }
 206 
<abbr title=" 207     protected List&lt;Tuple2&lt;Boolean, Row&gt;&gt; getRows(Tuple2&lt;Boolean, Row&gt; inputRow, List&lt;Object&gt; cacheContent, List&lt;Object&gt; results) {"> 207     protected List&lt;Tuple2&lt;Boolean, Row&gt;&gt; getRows(Tuple2&lt;Boolean, Row&gt; inputRow, List&lt;Object&gt; cacheContent🔵</abbr>
 208         List&lt;Tuple2&lt;Boolean, Row&gt;&gt; rowList = Lists.newArrayList();
 209         for (Object line : results) {
 210             Row row = fillData(inputRow.f1, line);
 211             if (null != cacheContent &amp;&amp; openCache()) {
 212                 cacheContent.add(line);
 213             }
 214             rowList.add(Tuple2.of(inputRow.f0, row));
 215         }
 216         return rowList;
 217     }
 218 
 219     @Override
 220     public Row fillData(Row input, Object line) {
 221 
 222         Map&lt;String, Object&gt; cacheInfo = (Map&lt;String, Object&gt;) line;
 223         Row row = new Row(sideInfo.getOutFieldInfoList().size());
 224         String[] fields = sideInfo.getSideTableInfo().getFieldTypes();
 225         for (Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getInFieldIndex().entrySet()) {
 226             Object obj = input.getField(entry.getValue());
<abbr title=" 227             boolean isTimeIndicatorTypeInfo = TimeIndicatorTypeInfo.class.isAssignableFrom(sideInfo.getRowTypeInfo().getTypeAt(entry.getValue()).getClass());"> 227             boolean isTimeIndicatorTypeInfo = TimeIndicatorTypeInfo.class.isAssignableFrom(sideInfo.getRo🔵</abbr>
 228             if (obj instanceof Timestamp &amp;&amp; isTimeIndicatorTypeInfo) {
 229                 obj = ((Timestamp) obj).getTime();
 230             }
 231 
 232             row.setField(entry.getKey(), obj);
 233         }
 234 
 235         for (Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getSideFieldIndex().entrySet()) {
 236             if (cacheInfo == null) {
 237                 row.setField(entry.getKey(), null);
 238             } else {
<abbr title=" 239                 Object object = SwitchUtil.getTarget(cacheInfo.get(sideInfo.getSideFieldNameIndex().get(entry.getKey())), fields[entry.getValue()]);"> 239                 Object object = SwitchUtil.getTarget(cacheInfo.get(sideInfo.getSideFieldNameIndex().get(e🔵</abbr>
 240                 row.setField(entry.getKey(), object);
 241             }
 242         }
 243 
 244         return row;
 245     }
 246 
 247     @Override
 248     public void close() throws Exception {
 249         super.close();
 250         if (rhlClient != null) {
 251             rhlClient.close();
 252         }
 253 
 254     }
 255 
 256     public String buildCacheKey(List equalValList) {
 257         StringBuilder sb = new StringBuilder();
 258         for (Object ele : equalValList) {
 259             sb.append(ele.toString())
 260                     .append(&quot;_&quot;);
 261         }
 262 
 263         return sb.toString();
 264     }
 265 
 266     private SearchSourceBuilder initConfiguration() {
 267         SearchSourceBuilder searchSourceBuilder = new SearchSourceBuilder();
 268         searchSourceBuilder.size(getFetchSize());
 269         searchSourceBuilder.sort(&quot;_id&quot;, SortOrder.DESC);
 270         String[] sideFieldNames = StringUtils.split(sideInfo.getSideSelectFields().trim(), &quot;,&quot;);
 271         searchSourceBuilder.fetchSource(sideFieldNames, null);
 272 
 273         return searchSourceBuilder;
 274     }
 275 
<abbr title=" 276     private BoolQueryBuilder setInputParams(List&lt;Object&gt; inputParams, BoolQueryBuilder boolQueryBuilder) {"> 276     private BoolQueryBuilder setInputParams(List&lt;Object&gt; inputParams, BoolQueryBuilder boolQueryBuilder) 🔵</abbr>
 277         if (boolQueryBuilder == null) {
 278             boolQueryBuilder = new BoolQueryBuilder();
 279         }
 280 
 281         for (int i = 0; i &lt; sqlJoinCompareOperate.size(); i++) {
 282             String fieldName = sideInfo.getEqualFieldList().get(i);
<abbr title=" 283             String operatorKind = sqlJoinCompareOperate.get(sideInfo.getEqualFieldList().indexOf(fieldName));"> 283             String operatorKind = sqlJoinCompareOperate.get(sideInfo.getEqualFieldList().indexOf(fieldNam🔵</abbr>
 284             String condition = String.valueOf(inputParams.get(i));
<abbr title=" 285             boolQueryBuilder = Es6Util.buildFilterCondition(boolQueryBuilder, new PredicateInfo(null, operatorKind, null, fieldName, condition), sideInfo);"> 285             boolQueryBuilder = Es6Util.buildFilterCondition(boolQueryBuilder, new PredicateInfo(null, ope🔵</abbr>
 286         }
 287 
 288         return boolQueryBuilder;
 289     }
 290 
 291     public int getFetchSize() {
 292         return 1000;
 293     }
 294 }
 295 </pre></td>
                            <td><pre>   1 /*
   2  * Licensed to the Apache Software Foundation (ASF) under one
   3  * or more contributor license agreements.  See the NOTICE file
   4  * distributed with this work for additional information
   5  * regarding copyright ownership.  The ASF licenses this file
   6  * to you under the Apache License, Version 2.0 (the
   7  * &quot;License&quot;); you may not use this file except in compliance
   8  * with the License.  You may obtain a copy of the License at
   9  *
  10  *     http://www.apache.org/licenses/LICENSE-2.0
  11  *
  12  * Unless required by applicable law or agreed to in writing, software
  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15  * See the License for the specific language governing permissions and
  16  * limitations under the License.
  17  */
  18 
  19 package com.dtstack.flink.sql.side.elasticsearch6;
  20 
  21 import org.apache.flink.api.java.tuple.Tuple2;
  22 
  23 import com.dtstack.flink.sql.side.AbstractSideTableInfo;
  24 import com.dtstack.flink.sql.side.BaseAsyncReqRow;
  25 import com.dtstack.flink.sql.side.CacheMissVal;
  26 import com.dtstack.flink.sql.side.FieldInfo;
  27 import com.dtstack.flink.sql.side.JoinInfo;
  28 import com.dtstack.flink.sql.side.PredicateInfo;
  29 import org.apache.flink.api.java.typeutils.RowTypeInfo;
  30 import org.apache.flink.configuration.Configuration;
  31 import org.apache.flink.streaming.api.functions.async.ResultFuture;
  32 import org.apache.flink.table.typeutils.TimeIndicatorTypeInfo;
  33 import org.apache.flink.types.Row;
  34 
  35 import com.dtstack.flink.sql.enums.ECacheContentType;
  36 import com.dtstack.flink.sql.side.cache.CacheObj;
  37 import com.dtstack.flink.sql.side.elasticsearch6.table.Elasticsearch6SideTableInfo;
  38 import com.dtstack.flink.sql.side.elasticsearch6.util.Es6Util;
  39 import com.dtstack.flink.sql.side.elasticsearch6.util.SwitchUtil;
  40 import com.dtstack.flink.sql.util.ParseUtils;
  41 import com.google.common.collect.Lists;
  42 import org.apache.calcite.sql.SqlNode;
  43 import org.apache.commons.lang3.StringUtils;
  44 import org.elasticsearch.action.ActionListener;
  45 import org.elasticsearch.action.search.SearchRequest;
  46 import org.elasticsearch.action.search.SearchResponse;
  47 import org.elasticsearch.client.RequestOptions;
  48 import org.elasticsearch.client.RestHighLevelClient;
  49 import org.elasticsearch.index.query.BoolQueryBuilder;
  50 import org.elasticsearch.search.SearchHit;
  51 import org.elasticsearch.search.builder.SearchSourceBuilder;
  52 import org.elasticsearch.search.sort.SortOrder;
  53 import org.slf4j.Logger;
  54 import org.slf4j.LoggerFactory;
  55 
  56 import java.io.IOException;
  57 import java.io.Serializable;
  58 import java.sql.Timestamp;
  59 import java.util.List;
  60 import java.util.Map;
  61 
  62 /**
  63  * @author yinxi
  64  * @date 2020/2/13 - 13:10
  65  */
  66 public class Elasticsearch6AsyncReqRow extends BaseAsyncReqRow implements Serializable {
  67 
  68     private static final Logger LOG = LoggerFactory.getLogger(Elasticsearch6AsyncReqRow.class);
  69     private transient RestHighLevelClient rhlClient;
  70     private SearchRequest searchRequest;
  71     private List&lt;String&gt; sqlJoinCompareOperate = Lists.newArrayList();
  72 
<abbr title="  73     public Elasticsearch6AsyncReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, AbstractSideTableInfo sideTableInfo) {">  73     public Elasticsearch6AsyncReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outField🔵</abbr>
  74         super(new Elasticsearch6AsyncSideInfo(rowTypeInfo, joinInfo, outFieldInfoList, sideTableInfo));
  75         SqlNode conditionNode = joinInfo.getCondition();
  76         ParseUtils.parseJoinCompareOperate(conditionNode, sqlJoinCompareOperate);
  77     }
  78 
  79     @Override
  80     public void open(Configuration parameters) throws Exception {
  81         super.open(parameters);
<abbr title="  82         Elasticsearch6SideTableInfo tableInfo = (Elasticsearch6SideTableInfo) sideInfo.getSideTableInfo();">  82         Elasticsearch6SideTableInfo tableInfo = (Elasticsearch6SideTableInfo) sideInfo.getSideTableInfo()🔵</abbr>
<abbr title="  83         rhlClient = Es6Util.getClient(tableInfo.getAddress(), tableInfo.isAuthMesh(), tableInfo.getUserName(), tableInfo.getPassword());">  83         rhlClient = Es6Util.getClient(tableInfo.getAddress(), tableInfo.isAuthMesh(), tableInfo.getUserNa🔵</abbr>
  84         searchRequest = Es6Util.setSearchRequest(sideInfo);
  85 
  86     }
  87 
  88 
  89     @Override
<abbr title="  90     public void asyncInvoke(Tuple2&lt;Boolean,Row&gt; input, ResultFuture&lt;Tuple2&lt;Boolean,Row&gt;&gt; resultFuture) throws Exception {">  90     public void asyncInvoke(Tuple2&lt;Boolean,Row&gt; input, ResultFuture&lt;Tuple2&lt;Boolean,Row&gt;&gt; resultFuture) th🔵</abbr>
  91         Tuple2&lt;Boolean,Row&gt; copyInput= Tuple2.of(input.f0,input.f1);
  92         List&lt;Object&gt; inputParams = Lists.newArrayList();
  93         for (Integer conValIndex : sideInfo.getEqualValIndex()) {
  94             Object equalObj = copyInput.f1.getField(conValIndex);
  95             if (equalObj == null) {
  96                 dealMissKey(copyInput, resultFuture);
  97                 return;
  98             }
  99             inputParams.add(equalObj);
 100         }
 101 
 102         String key = buildCacheKey(inputParams);
 103         if (openCache()) {
 104             CacheObj val = getFromCache(key);
 105             if (val != null) {
 106                 if (ECacheContentType.MissVal == val.getType()) {
 107                     dealMissKey(copyInput, resultFuture);
 108                     return;
 109                 } else if (ECacheContentType.MultiLine == val.getType()) {
 110                     try {
<abbr title=" 111                         List&lt;Tuple2&lt;Boolean,Row&gt;&gt; rowList = getRows(copyInput, null, (List) val.getContent());"> 111                         List&lt;Tuple2&lt;Boolean,Row&gt;&gt; rowList = getRows(copyInput, null, (List) val.getConten🔵</abbr>
 112                         resultFuture.complete(rowList);
 113                     } catch (Exception e) {
 114                         dealFillDataError(resultFuture, e, copyInput);
 115                     }
 116                 } else {
<abbr title=" 117                     resultFuture.completeExceptionally(new RuntimeException(&quot;not support cache obj type &quot; + val.getType()));"> 117                     resultFuture.completeExceptionally(new RuntimeException(&quot;not support cache obj type &quot;🔵</abbr>
 118                 }
 119                 return;
 120             }
 121         }
 122 
 123         BoolQueryBuilder boolQueryBuilder = Es6Util.setPredicateclause(sideInfo);
 124         boolQueryBuilder = setInputParams(inputParams, boolQueryBuilder);
 125         SearchSourceBuilder searchSourceBuilder = initConfiguration();
 126         searchSourceBuilder.query(boolQueryBuilder);
 127         searchRequest.source(searchSourceBuilder);
 128 
 129         // 异步查询数据
<abbr title=" 130         rhlClient.searchAsync(searchRequest, RequestOptions.DEFAULT, new ActionListener&lt;SearchResponse&gt;() {"> 130         rhlClient.searchAsync(searchRequest, RequestOptions.DEFAULT, new ActionListener&lt;SearchResponse&gt;()🔵</abbr>
 131 
 132             //成功响应时
 133             @Override
 134             public void onResponse(SearchResponse searchResponse) {
 135 
 136                 List&lt;Object&gt; cacheContent = Lists.newArrayList();
 137                 List&lt;Tuple2&lt;Boolean,Row&gt;&gt; rowList = Lists.newArrayList();
 138                 SearchHit[] searchHits = searchResponse.getHits().getHits();
 139                 if (searchHits.length &gt; 0) {
 140                     Elasticsearch6SideTableInfo tableInfo = null;
 141                     RestHighLevelClient tmpRhlClient = null;
 142                     try {
 143                         while (true) {
 144                             loadDataToCache(searchHits, rowList, cacheContent, copyInput);
 145                             // determine if all results haven been ferched
 146                             if (searchHits.length &lt; getFetchSize()) {
 147                                 break;
 148                             }
 149                             if (tableInfo == null &amp;&amp; tmpRhlClient == null) {
 150                                 // create new connection to fetch data
 151                                 tableInfo = (Elasticsearch6SideTableInfo) sideInfo.getSideTableInfo();
<abbr title=" 152                                 tmpRhlClient = Es6Util.getClient(tableInfo.getAddress(), tableInfo.isAuthMesh(), tableInfo.getUserName(), tableInfo.getPassword());"> 152                                 tmpRhlClient = Es6Util.getClient(tableInfo.getAddress(), tableInfo.isAuth🔵</abbr>
 153                             }
<abbr title=" 154                             Object[] searchAfterParameter = searchHits[searchHits.length - 1].getSortValues();"> 154                             Object[] searchAfterParameter = searchHits[searchHits.length - 1].getSortValu🔵</abbr>
 155                             searchSourceBuilder.searchAfter(searchAfterParameter);
 156                             searchRequest.source(searchSourceBuilder);
 157                             searchResponse = tmpRhlClient.search(searchRequest, RequestOptions.DEFAULT);
 158                             searchHits = searchResponse.getHits().getHits();
 159                         }
<abbr title=" 160                         dealCacheData(key, CacheObj.buildCacheObj(ECacheContentType.MultiLine, cacheContent));"> 160                         dealCacheData(key, CacheObj.buildCacheObj(ECacheContentType.MultiLine, cacheConte🔵</abbr>
 161                         resultFuture.complete(rowList);
 162                     } catch (Exception e) {
 163                         dealFillDataError(resultFuture, e, copyInput);
 164                     } finally {
 165                         if (tmpRhlClient != null) {
 166                             try {
 167                                 tmpRhlClient.close();
 168                             } catch (IOException e) {
 169                                 LOG.warn(&quot;Failed to shut down tmpRhlClient.&quot;, e);
 170                             }
 171                         }
 172                     }
 173                 } else {
 174                     dealMissKey(copyInput, resultFuture);
 175                     dealCacheData(key, CacheMissVal.getMissKeyObj());
 176                 }
 177             }
 178 
 179             // 响应失败处理
 180             @Override
 181             public void onFailure(Exception e) {
 182                 LOG.error(&quot;&quot; + e);
 183                 resultFuture.completeExceptionally(new RuntimeException(&quot;Response failed!&quot;));
 184             }
 185         });
 186 
 187     }
 188 
<abbr title=" 189     private void loadDataToCache(SearchHit[] searchHits, List&lt;Tuple2&lt;Boolean,Row&gt;&gt; rowList, List&lt;Object&gt; cacheContent, Tuple2&lt;Boolean,Row&gt; copyCrow) {"> 189     private void loadDataToCache(SearchHit[] searchHits, List&lt;Tuple2&lt;Boolean,Row&gt;&gt; rowList, List&lt;Object&gt; 🔵</abbr>
 190         List&lt;Object&gt; results = Lists.newArrayList();
 191         for (SearchHit searchHit : searchHits) {
 192             Map&lt;String, Object&gt; object = searchHit.getSourceAsMap();
 193             results.add(object);
 194         }
 195         rowList.addAll(getRows(copyCrow, cacheContent, results));
 196     }
 197 
<abbr title=" 198     protected List&lt;Tuple2&lt;Boolean, Row&gt;&gt; getRows(Tuple2&lt;Boolean, Row&gt; inputRow, List&lt;Object&gt; cacheContent, List&lt;Object&gt; results) {"> 198     protected List&lt;Tuple2&lt;Boolean, Row&gt;&gt; getRows(Tuple2&lt;Boolean, Row&gt; inputRow, List&lt;Object&gt; cacheContent🔵</abbr>
 199         List&lt;Tuple2&lt;Boolean, Row&gt;&gt; rowList = Lists.newArrayList();
 200         for (Object line : results) {
 201             Row row = fillData(inputRow.f1, line);
 202             if (null != cacheContent &amp;&amp; openCache()) {
 203                 cacheContent.add(line);
 204             }
 205             rowList.add(Tuple2.of(inputRow.f0, row));
 206         }
 207         return rowList;
 208     }
 209 
 210     @Override
 211     public Row fillData(Row input, Object line) {
 212 
 213         Map&lt;String, Object&gt; cacheInfo = (Map&lt;String, Object&gt;) line;
 214         Row row = new Row(sideInfo.getOutFieldInfoList().size());
 215         String[] fields = sideInfo.getSideTableInfo().getFieldTypes();
 216         for (Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getInFieldIndex().entrySet()) {
 217             Object obj = input.getField(entry.getValue());
<abbr title=" 218             boolean isTimeIndicatorTypeInfo = TimeIndicatorTypeInfo.class.isAssignableFrom(sideInfo.getRowTypeInfo().getTypeAt(entry.getValue()).getClass());"> 218             boolean isTimeIndicatorTypeInfo = TimeIndicatorTypeInfo.class.isAssignableFrom(sideInfo.getRo🔵</abbr>
 219             if (obj instanceof Timestamp &amp;&amp; isTimeIndicatorTypeInfo) {
 220                 obj = ((Timestamp) obj).getTime();
 221             }
 222 
 223             row.setField(entry.getKey(), obj);
 224         }
 225 
 226         for (Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getSideFieldIndex().entrySet()) {
 227             if (cacheInfo == null) {
 228                 row.setField(entry.getKey(), null);
 229             } else {
<abbr title=" 230                 Object object = SwitchUtil.getTarget(cacheInfo.get(sideInfo.getSideFieldNameIndex().get(entry.getKey())), fields[entry.getValue()]);"> 230                 Object object = SwitchUtil.getTarget(cacheInfo.get(sideInfo.getSideFieldNameIndex().get(e🔵</abbr>
 231                 row.setField(entry.getKey(), object);
 232             }
 233         }
 234 
 235         return row;
 236     }
 237 
 238     @Override
 239     public void close() throws Exception {
 240         super.close();
 241         if (rhlClient != null) {
 242             rhlClient.close();
 243         }
 244 
 245     }
 246 
 247     public String buildCacheKey(List equalValList) {
 248         StringBuilder sb = new StringBuilder();
 249         for (Object ele : equalValList) {
 250             sb.append(ele.toString())
 251                     .append(&quot;_&quot;);
 252         }
 253 
 254         return sb.toString();
 255     }
 256 
 257     private SearchSourceBuilder initConfiguration() {
 258         SearchSourceBuilder searchSourceBuilder = new SearchSourceBuilder();
 259         searchSourceBuilder.size(getFetchSize());
 260         searchSourceBuilder.sort(&quot;_id&quot;, SortOrder.DESC);
 261         String[] sideFieldNames = StringUtils.split(sideInfo.getSideSelectFields().trim(), &quot;,&quot;);
 262         searchSourceBuilder.fetchSource(sideFieldNames, null);
 263 
 264         return searchSourceBuilder;
 265     }
 266 
<abbr title=" 267     private BoolQueryBuilder setInputParams(List&lt;Object&gt; inputParams, BoolQueryBuilder boolQueryBuilder) {"> 267     private BoolQueryBuilder setInputParams(List&lt;Object&gt; inputParams, BoolQueryBuilder boolQueryBuilder) 🔵</abbr>
 268         if (boolQueryBuilder == null) {
 269             boolQueryBuilder = new BoolQueryBuilder();
 270         }
 271 
 272         for (int i = 0; i &lt; sqlJoinCompareOperate.size(); i++) {
 273             String fieldName = sideInfo.getEqualFieldList().get(i);
<abbr title=" 274             String operatorKind = sqlJoinCompareOperate.get(sideInfo.getEqualFieldList().indexOf(fieldName));"> 274             String operatorKind = sqlJoinCompareOperate.get(sideInfo.getEqualFieldList().indexOf(fieldNam🔵</abbr>
 275             String condition = String.valueOf(inputParams.get(i));
<abbr title=" 276             boolQueryBuilder = Es6Util.buildFilterCondition(boolQueryBuilder, new PredicateInfo(null, operatorKind, null, fieldName, condition), sideInfo);"> 276             boolQueryBuilder = Es6Util.buildFilterCondition(boolQueryBuilder, new PredicateInfo(null, ope🔵</abbr>
 277         }
 278 
 279         return boolQueryBuilder;
 280     }
 281 
 282     public int getFetchSize() {
 283         return 1000;
 284     }
 285 }
 
 
 
 
 
 
 
 
 </pre></td>
                            <td><pre>   1 /*
   2  * Licensed to the Apache Software Foundation (ASF) under one
   3  * or more contributor license agreements.  See the NOTICE file
   4  * distributed with this work for additional information
   5  * regarding copyright ownership.  The ASF licenses this file
   6  * to you under the Apache License, Version 2.0 (the
   7  * &quot;License&quot;); you may not use this file except in compliance
   8  * with the License.  You may obtain a copy of the License at
   9  *
  10  *     http://www.apache.org/licenses/LICENSE-2.0
  11  *
  12  * Unless required by applicable law or agreed to in writing, software
  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15  * See the License for the specific language governing permissions and
  16  * limitations under the License.
  17  */
  18 package com.dtstack.flink.sql.side.elasticsearch6;
  19 
  20 import com.dtstack.flink.sql.enums.ECacheContentType;
  21 import com.dtstack.flink.sql.side.AbstractSideTableInfo;
  22 import com.dtstack.flink.sql.side.BaseAsyncReqRow;
  23 import com.dtstack.flink.sql.side.CacheMissVal;
  24 import com.dtstack.flink.sql.side.FieldInfo;
  25 import com.dtstack.flink.sql.side.JoinInfo;
  26 import com.dtstack.flink.sql.side.PredicateInfo;
  27 import com.dtstack.flink.sql.side.cache.CacheObj;
  28 import com.dtstack.flink.sql.side.elasticsearch6.table.Elasticsearch6SideTableInfo;
  29 import com.dtstack.flink.sql.side.elasticsearch6.util.Es6Util;
  30 import com.dtstack.flink.sql.side.elasticsearch6.util.SwitchUtil;
  31 import com.dtstack.flink.sql.util.ParseUtils;
  32 import com.google.common.collect.Lists;
  33 import java.io.IOException;
  34 import java.io.Serializable;
  35 import java.sql.Timestamp;
  36 import java.util.List;
  37 import java.util.Map;
  38 import org.apache.calcite.sql.SqlNode;
  39 import org.apache.commons.lang3.StringUtils;
  40 import org.apache.flink.api.java.tuple.Tuple2;
  41 import org.apache.flink.api.java.typeutils.RowTypeInfo;
  42 import org.apache.flink.configuration.Configuration;
  43 import org.apache.flink.streaming.api.functions.async.ResultFuture;
  44 import org.apache.flink.table.typeutils.TimeIndicatorTypeInfo;
  45 import org.apache.flink.types.Row;
  46 import org.elasticsearch.action.ActionListener;
  47 import org.elasticsearch.action.search.SearchRequest;
  48 import org.elasticsearch.action.search.SearchResponse;
  49 import org.elasticsearch.client.RequestOptions;
  50 import org.elasticsearch.client.RestHighLevelClient;
  51 import org.elasticsearch.index.query.BoolQueryBuilder;
  52 import org.elasticsearch.search.SearchHit;
  53 import org.elasticsearch.search.builder.SearchSourceBuilder;
  54 import org.elasticsearch.search.sort.SortOrder;
  55 import org.slf4j.Logger;
  56 import org.slf4j.LoggerFactory;
  57 
  58 
  59 /**
  60  * @author yinxi
  61  * @date 2020/2/13 - 13:10
  62  */
  63 public class Elasticsearch6AsyncReqRow extends BaseAsyncReqRow implements Serializable {
  64     private static final Logger LOG = LoggerFactory.getLogger(Elasticsearch6AsyncReqRow.class);
  65 
  66     private transient RestHighLevelClient rhlClient;
  67 
  68     private SearchRequest searchRequest;
  69 
  70     private List&lt;String&gt; sqlJoinCompareOperate = Lists.newArrayList();
  71 
<abbr title="  72     public Elasticsearch6AsyncReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, AbstractSideTableInfo sideTableInfo) {">  72     public Elasticsearch6AsyncReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outField🔵</abbr>
  73         super(new Elasticsearch6AsyncSideInfo(rowTypeInfo, joinInfo, outFieldInfoList, sideTableInfo));
  74         SqlNode conditionNode = joinInfo.getCondition();
  75         ParseUtils.parseJoinCompareOperate(conditionNode, sqlJoinCompareOperate);
  76     }
  77 
  78     @Override
  79     public void open(Configuration parameters) throws Exception {
  80         super.open(parameters);
<abbr title="  81         Elasticsearch6SideTableInfo tableInfo = ((Elasticsearch6SideTableInfo) (sideInfo.getSideTableInfo()));">  81         Elasticsearch6SideTableInfo tableInfo = ((Elasticsearch6SideTableInfo) (sideInfo.getSideTableInfo🔵</abbr>
<abbr title="  82         rhlClient = Es6Util.getClient(tableInfo.getAddress(), tableInfo.isAuthMesh(), tableInfo.getUserName(), tableInfo.getPassword());">  82         rhlClient = Es6Util.getClient(tableInfo.getAddress(), tableInfo.isAuthMesh(), tableInfo.getUserNa🔵</abbr>
  83         searchRequest = Es6Util.setSearchRequest(sideInfo);
  84     }
  85 
  86     @Override
<abbr title="  87     public void asyncInvoke(Tuple2&lt;Boolean, Row&gt; input, ResultFuture&lt;Tuple2&lt;Boolean, Row&gt;&gt; resultFuture) throws Exception {">  87     public void asyncInvoke(Tuple2&lt;Boolean, Row&gt; input, ResultFuture&lt;Tuple2&lt;Boolean, Row&gt;&gt; resultFuture) 🔵</abbr>
  88         Tuple2&lt;Boolean, Row&gt; copyInput = Tuple2.of(input.f0, input.f1);
  89         List&lt;Object&gt; inputParams = Lists.newArrayList();
  90         for (Integer conValIndex : sideInfo.getEqualValIndex()) {
  91             Object equalObj = copyInput.f1.getField(conValIndex);
  92             if (equalObj == null) {
  93                 dealMissKey(copyInput, resultFuture);
  94                 return;
  95             }
  96             inputParams.add(equalObj);
  97         }
  98         String key = buildCacheKey(inputParams);
  99         if (openCache()) {
 100             CacheObj val = getFromCache(key);
 101             if (val != null) {
 102                 if (ECacheContentType.MissVal == val.getType()) {
 103                     dealMissKey(copyInput, resultFuture);
 104                     return;
 105                 } else if (ECacheContentType.MultiLine == val.getType()) {
 106                     try {
<abbr title=" 107                         List&lt;Tuple2&lt;Boolean, Row&gt;&gt; rowList = getRows(copyInput, null, ((List) (val.getContent())));"> 107                         List&lt;Tuple2&lt;Boolean, Row&gt;&gt; rowList = getRows(copyInput, null, ((List) (val.getCon🔵</abbr>
 108                         resultFuture.complete(rowList);
 109                     } catch (java.lang.Exception e) {
 110                         dealFillDataError(resultFuture, e, copyInput);
 111                     }
 112                 } else {
<abbr title=" 113                     resultFuture.completeExceptionally(new RuntimeException(&quot;not support cache obj type &quot; + val.getType()));"> 113                     resultFuture.completeExceptionally(new RuntimeException(&quot;not support cache obj type &quot;🔵</abbr>
 114                 }
 115                 return;
 116             }
 117         }
 118         BoolQueryBuilder boolQueryBuilder = Es6Util.setPredicateclause(sideInfo);
 119         boolQueryBuilder = setInputParams(inputParams, boolQueryBuilder);
 120         SearchSourceBuilder searchSourceBuilder = initConfiguration();
 121         searchSourceBuilder.query(boolQueryBuilder);
 122         searchRequest.source(searchSourceBuilder);
 123         // 异步查询数据
<abbr title=" 124         rhlClient.searchAsync(searchRequest, RequestOptions.DEFAULT, new ActionListener&lt;SearchResponse&gt;() {"> 124         rhlClient.searchAsync(searchRequest, RequestOptions.DEFAULT, new ActionListener&lt;SearchResponse&gt;()🔵</abbr>
 125             //成功响应时
 126             @Override
 127             public void onResponse(SearchResponse searchResponse) {
 128                 List&lt;Object&gt; cacheContent = Lists.newArrayList();
 129                 List&lt;Tuple2&lt;Boolean, Row&gt;&gt; rowList = Lists.newArrayList();
 130                 SearchHit[] searchHits = searchResponse.getHits().getHits();
 131                 if (searchHits.length &gt; 0) {
 132                     Elasticsearch6SideTableInfo tableInfo = null;
 133                     RestHighLevelClient tmpRhlClient = null;
 134                     try {
 135                         while (true) {
 136                             loadDataToCache(searchHits, rowList, cacheContent, copyInput);
 137                             // determine if all results haven been ferched
 138                             if (searchHits.length &lt; getFetchSize()) {
 139                                 break;
 140                             }
 141                             if ((tableInfo == null) &amp;&amp; (tmpRhlClient == null)) {
 142                                 // create new connection to fetch data
<abbr title=" 143                                 tableInfo = ((Elasticsearch6SideTableInfo) (sideInfo.getSideTableInfo()));"> 143                                 tableInfo = ((Elasticsearch6SideTableInfo) (sideInfo.getSideTableInfo()))🔵</abbr>
<abbr title=" 144                                 tmpRhlClient = Es6Util.getClient(tableInfo.getAddress(), tableInfo.isAuthMesh(), tableInfo.getUserName(), tableInfo.getPassword());"> 144                                 tmpRhlClient = Es6Util.getClient(tableInfo.getAddress(), tableInfo.isAuth🔵</abbr>
 145                             }
<abbr title=" 146                             Object[] searchAfterParameter = searchHits[searchHits.length - 1].getSortValues();"> 146                             Object[] searchAfterParameter = searchHits[searchHits.length - 1].getSortValu🔵</abbr>
 147                             searchSourceBuilder.searchAfter(searchAfterParameter);
 148                             searchRequest.source(searchSourceBuilder);
 149                             searchResponse = tmpRhlClient.search(searchRequest, RequestOptions.DEFAULT);
 150                             searchHits = searchResponse.getHits().getHits();
 151                         }
<abbr title=" 152                         dealCacheData(key, CacheObj.buildCacheObj(ECacheContentType.MultiLine, cacheContent));"> 152                         dealCacheData(key, CacheObj.buildCacheObj(ECacheContentType.MultiLine, cacheConte🔵</abbr>
 153                         resultFuture.complete(rowList);
 154                     } catch (java.lang.Exception e) {
 155                         dealFillDataError(resultFuture, e, copyInput);
 156                     } finally {
 157                         if (tmpRhlClient != null) {
 158                             try {
 159                                 tmpRhlClient.close();
 160                             } catch (IOException e) {
 161                                 LOG.warn(&quot;Failed to shut down tmpRhlClient.&quot;, e);
 162                             }
 163                         }
 164                     }
 165                 } else {
 166                     dealMissKey(copyInput, resultFuture);
 167                     dealCacheData(key, CacheMissVal.getMissKeyObj());
 168                 }
 169             }
 170 
 171             // 响应失败处理
 172             @Override
 173             public void onFailure(Exception e) {
 174                 LOG.error(&quot;&quot; + e);
 175                 resultFuture.completeExceptionally(new RuntimeException(&quot;Response failed!&quot;));
 176             }
 177         });
 178     }
 179 
<abbr title=" 180     private void loadDataToCache(SearchHit[] searchHits, List&lt;Tuple2&lt;Boolean, Row&gt;&gt; rowList, List&lt;Object&gt; cacheContent, Tuple2&lt;Boolean, Row&gt; copyCrow) {"> 180     private void loadDataToCache(SearchHit[] searchHits, List&lt;Tuple2&lt;Boolean, Row&gt;&gt; rowList, List&lt;Object&gt;🔵</abbr>
 181         List&lt;Object&gt; results = Lists.newArrayList();
 182         for (SearchHit searchHit : searchHits) {
 183             Map&lt;String, Object&gt; object = searchHit.getSourceAsMap();
 184             results.add(object);
 185         }
 186         rowList.addAll(getRows(copyCrow, cacheContent, results));
 187     }
 188 
<abbr title=" 189     protected List&lt;Tuple2&lt;Boolean, Row&gt;&gt; getRows(Tuple2&lt;Boolean, Row&gt; inputRow, List&lt;Object&gt; cacheContent, List&lt;Object&gt; results) {"> 189     protected List&lt;Tuple2&lt;Boolean, Row&gt;&gt; getRows(Tuple2&lt;Boolean, Row&gt; inputRow, List&lt;Object&gt; cacheContent🔵</abbr>
 190         List&lt;Tuple2&lt;Boolean, Row&gt;&gt; rowList = Lists.newArrayList();
 191         for (Object line : results) {
 192             Row row = fillData(inputRow.f1, line);
 193             if ((null != cacheContent) &amp;&amp; openCache()) {
 194                 cacheContent.add(line);
 195             }
 196             rowList.add(Tuple2.of(inputRow.f0, row));
 197         }
 198         return rowList;
 199     }
 200 
 201     @Override
 202     public Row fillData(Row input, Object line) {
 203         Map&lt;String, Object&gt; cacheInfo = ((Map&lt;String, Object&gt;) (line));
 204         Row row = new Row(sideInfo.getOutFieldInfoList().size());
 205         String[] fields = sideInfo.getSideTableInfo().getFieldTypes();
 206         for (Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getInFieldIndex().entrySet()) {
 207             Object obj = input.getField(entry.getValue());
<abbr title=" 208             boolean isTimeIndicatorTypeInfo = TimeIndicatorTypeInfo.class.isAssignableFrom(sideInfo.getRowTypeInfo().getTypeAt(entry.getValue()).getClass());"> 208             boolean isTimeIndicatorTypeInfo = TimeIndicatorTypeInfo.class.isAssignableFrom(sideInfo.getRo🔵</abbr>
 209             if ((obj instanceof Timestamp) &amp;&amp; isTimeIndicatorTypeInfo) {
 210                 obj = ((Timestamp) (obj)).getTime();
 211             }
 212             row.setField(entry.getKey(), obj);
 213         }
 214         for (Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getSideFieldIndex().entrySet()) {
 215             if (cacheInfo == null) {
 216                 row.setField(entry.getKey(), null);
 217             } else {
<abbr title=" 218                 Object object = SwitchUtil.getTarget(cacheInfo.get(sideInfo.getSideFieldNameIndex().get(entry.getKey())), fields[entry.getValue()]);"> 218                 Object object = SwitchUtil.getTarget(cacheInfo.get(sideInfo.getSideFieldNameIndex().get(e🔵</abbr>
 219                 row.setField(entry.getKey(), object);
 220             }
 221         }
 222         return row;
 223     }
 224 
 225     @Override
 226     public void close() throws Exception {
 227         super.close();
 228         if (rhlClient != null) {
 229             rhlClient.close();
 230         }
 231     }
 232 
 233     public String buildCacheKey(List equalValList) {
 234         StringBuilder sb = new StringBuilder();
 235         for (Object ele : equalValList) {
 236             sb.append(ele.toString())
 237                     .append(&quot;_&quot;);
 238         }
 239 
 240         return sb.toString();
 241     }
 242 
 243     private SearchSourceBuilder initConfiguration() {
 244         SearchSourceBuilder searchSourceBuilder = new SearchSourceBuilder();
 245         searchSourceBuilder.size(getFetchSize());
 246         searchSourceBuilder.sort(&quot;_id&quot;, SortOrder.DESC);
 247         String[] sideFieldNames = StringUtils.split(sideInfo.getSideSelectFields().trim(), &quot;,&quot;);
 248         searchSourceBuilder.fetchSource(sideFieldNames, null);
 249         return searchSourceBuilder;
 250     }
 251 
<abbr title=" 252     private BoolQueryBuilder setInputParams(List&lt;Object&gt; inputParams, BoolQueryBuilder boolQueryBuilder) {"> 252     private BoolQueryBuilder setInputParams(List&lt;Object&gt; inputParams, BoolQueryBuilder boolQueryBuilder) 🔵</abbr>
 253         if (boolQueryBuilder == null) {
 254             boolQueryBuilder = new BoolQueryBuilder();
 255         }
 256         for (int i = 0; i &lt; sqlJoinCompareOperate.size(); i++) {
 257             String fieldName = sideInfo.getEqualFieldList().get(i);
<abbr title=" 258             String operatorKind = sqlJoinCompareOperate.get(sideInfo.getEqualFieldList().indexOf(fieldName));"> 258             String operatorKind = sqlJoinCompareOperate.get(sideInfo.getEqualFieldList().indexOf(fieldNam🔵</abbr>
 259             String condition = String.valueOf(inputParams.get(i));
<abbr title=" 260             boolQueryBuilder = Es6Util.buildFilterCondition(boolQueryBuilder, new PredicateInfo(null, operatorKind, null, fieldName, condition), sideInfo);"> 260             boolQueryBuilder = Es6Util.buildFilterCondition(boolQueryBuilder, new PredicateInfo(null, ope🔵</abbr>
 261         }
 262         return boolQueryBuilder;
 263     }
 264 
 265     public int getFetchSize() {
 266         return 1000;
 267     }
 268 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  /*
   2   * Licensed to the Apache Software Foundation (ASF) under one
   3   * or more contributor license agreements.  See the NOTICE file
   4   * distributed with this work for additional information
   5   * regarding copyright ownership.  The ASF licenses this file
   6   * to you under the Apache License, Version 2.0 (the
   7   * &quot;License&quot;); you may not use this file except in compliance
   8   * with the License.  You may obtain a copy of the License at
   9   *
  10   *     http://www.apache.org/licenses/LICENSE-2.0
  11   *
  12   * Unless required by applicable law or agreed to in writing, software
  13   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15   * See the License for the specific language governing permissions and
  16   * limitations under the License.
  17   */
  18  
  19  package com.dtstack.flink.sql.side.elasticsearch6;
  20  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  21 +import org.apache.flink.api.java.tuple.Tuple2;</span>





  22  import org.apache.flink.api.java.typeutils.RowTypeInfo;
  23  import org.apache.flink.configuration.Configuration;
  24  import org.apache.flink.streaming.api.functions.async.ResultFuture;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  25 -import org.apache.flink.table.runtime.types.CRow;</span>
  26  import org.apache.flink.table.typeutils.TimeIndicatorTypeInfo;
  27  import org.apache.flink.types.Row;
  28  
  29  import com.dtstack.flink.sql.enums.ECacheContentType;
  30  import com.dtstack.flink.sql.side.*;
  31  import com.dtstack.flink.sql.side.cache.CacheObj;
  32  import com.dtstack.flink.sql.side.elasticsearch6.table.Elasticsearch6SideTableInfo;
  33  import com.dtstack.flink.sql.side.elasticsearch6.util.Es6Util;
  34  import com.dtstack.flink.sql.side.elasticsearch6.util.SwitchUtil;
  35  import com.dtstack.flink.sql.util.ParseUtils;
  36  import com.google.common.collect.Lists;
  37  import org.apache.calcite.sql.SqlNode;
  38  import org.apache.commons.lang3.StringUtils;
  39  import org.elasticsearch.action.ActionListener;
  40  import org.elasticsearch.action.search.SearchRequest;
  41  import org.elasticsearch.action.search.SearchResponse;
  42  import org.elasticsearch.client.RequestOptions;
  43  import org.elasticsearch.client.RestHighLevelClient;
  44  import org.elasticsearch.index.query.BoolQueryBuilder;
  45  import org.elasticsearch.search.SearchHit;
  46  import org.elasticsearch.search.builder.SearchSourceBuilder;
  47  import org.elasticsearch.search.sort.SortOrder;
  48  import org.slf4j.Logger;
  49  import org.slf4j.LoggerFactory;
  50  
  51  import java.io.IOException;
  52  import java.io.Serializable;
  53  import java.sql.Timestamp;
  54  import java.util.List;
  55  import java.util.Map;
  56  
  57  /**
  58   * @author yinxi
  59   * @date 2020/2/13 - 13:10
  60   */
  61  public class Elasticsearch6AsyncReqRow extends BaseAsyncReqRow implements Serializable {
  62  
  63      private static final Logger LOG = LoggerFactory.getLogger(Elasticsearch6AsyncReqRow.class);
  64      private transient RestHighLevelClient rhlClient;
  65      private SearchRequest searchRequest;
  66      private List&lt;String&gt; sqlJoinCompareOperate = Lists.newArrayList();
  67  
<abbr title="  68      public Elasticsearch6AsyncReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, AbstractSideTableInfo sideTableInfo) {">  68      public Elasticsearch6AsyncReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList,🔵</abbr>
  69          super(new Elasticsearch6AsyncSideInfo(rowTypeInfo, joinInfo, outFieldInfoList, sideTableInfo));
  70          SqlNode conditionNode = joinInfo.getCondition();
  71          ParseUtils.parseJoinCompareOperate(conditionNode, sqlJoinCompareOperate);
  72      }
  73  
  74      @Override
  75      public void open(Configuration parameters) throws Exception {
  76          super.open(parameters);
  77          Elasticsearch6SideTableInfo tableInfo = (Elasticsearch6SideTableInfo) sideInfo.getSideTableInfo();
<abbr title="  78          rhlClient = Es6Util.getClient(tableInfo.getAddress(), tableInfo.isAuthMesh(), tableInfo.getUserName(), tableInfo.getPassword());">  78          rhlClient = Es6Util.getClient(tableInfo.getAddress(), tableInfo.isAuthMesh(), tableInfo.getUserName(), tab🔵</abbr>
  79          searchRequest = Es6Util.setSearchRequest(sideInfo);
  80  
  81      }
  82  
  83  
  84      @Override
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  85 -    public void asyncInvoke(CRow input, ResultFuture&lt;CRow&gt; resultFuture) throws Exception {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  86 -        CRow copyCrow = new CRow(input.row(), input.change());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title="  87 +    public void asyncInvoke(Tuple2&lt;Boolean,Row&gt; input, ResultFuture&lt;Tuple2&lt;Boolean,Row&gt;&gt; resultFuture) throws Exception {">  87 +    public void asyncInvoke(Tuple2&lt;Boolean,Row&gt; input, ResultFuture&lt;Tuple2&lt;Boolean,Row&gt;&gt; resultFuture) throws Exce🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  88 +        Tuple2&lt;Boolean,Row&gt; copyInput= Tuple2.of(input.f0,input.f1);</span>
  89          List&lt;Object&gt; inputParams = Lists.newArrayList();
  90          for (Integer conValIndex : sideInfo.getEqualValIndex()) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  91 -            Object equalObj = copyCrow.row().getField(conValIndex);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  92 +            Object equalObj = copyInput.f1.getField(conValIndex);</span>
  93              if (equalObj == null) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  94 -                dealMissKey(copyCrow, resultFuture);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  95 +                dealMissKey(copyInput, resultFuture);</span>
  96                  return;
  97              }
  98              inputParams.add(equalObj);
  99          }
 100  
 101          String key = buildCacheKey(inputParams);
 102          if (openCache()) {
 103              CacheObj val = getFromCache(key);
 104              if (val != null) {
 105                  if (ECacheContentType.MissVal == val.getType()) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 106 -                    dealMissKey(copyCrow, resultFuture);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 107 +                    dealMissKey(copyInput, resultFuture);</span>
 108                      return;
 109                  } else if (ECacheContentType.MultiLine == val.getType()) {
 110                      try {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 111 -                        List&lt;CRow&gt; rowList = getRows(copyCrow, null, (List) val.getContent());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 112 +                        List&lt;Tuple2&lt;Boolean,Row&gt;&gt; rowList = getRows(copyInput, null, (List) val.getContent());</span>
 113                          resultFuture.complete(rowList);
 114                      } catch (Exception e) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 115 -                        dealFillDataError(resultFuture, e, copyCrow);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 116 +                        dealFillDataError(resultFuture, e, copyInput);</span>
 117                      }
 118                  } else {
<abbr title=" 119                      resultFuture.completeExceptionally(new RuntimeException(&quot;not support cache obj type &quot; + val.getType()));"> 119                      resultFuture.completeExceptionally(new RuntimeException(&quot;not support cache obj type &quot; + val.ge🔵</abbr>
 120                  }
 121                  return;
 122              }
 123          }
 124  
 125          BoolQueryBuilder boolQueryBuilder = Es6Util.setPredicateclause(sideInfo);
 126          boolQueryBuilder = setInputParams(inputParams, boolQueryBuilder);
 127          SearchSourceBuilder searchSourceBuilder = initConfiguration();
 128          searchSourceBuilder.query(boolQueryBuilder);
 129          searchRequest.source(searchSourceBuilder);
 130  
 131          // 异步查询数据
 132          rhlClient.searchAsync(searchRequest, RequestOptions.DEFAULT, new ActionListener&lt;SearchResponse&gt;() {
 133  
 134              //成功响应时
 135              @Override
 136              public void onResponse(SearchResponse searchResponse) {
 137  
 138                  List&lt;Object&gt; cacheContent = Lists.newArrayList();
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 139 -                List&lt;CRow&gt; rowList = Lists.newArrayList();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 140 +                List&lt;Tuple2&lt;Boolean,Row&gt;&gt; rowList = Lists.newArrayList();</span>
 141                  SearchHit[] searchHits = searchResponse.getHits().getHits();
 142                  if (searchHits.length &gt; 0) {
 143                      Elasticsearch6SideTableInfo tableInfo = null;
 144                      RestHighLevelClient tmpRhlClient = null;
 145                      try {
 146                          while (true) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 147 -                            loadDataToCache(searchHits, rowList, cacheContent, copyCrow);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 148 +                            loadDataToCache(searchHits, rowList, cacheContent, copyInput);</span>
 149                              // determine if all results haven been ferched
 150                              if (searchHits.length &lt; getFetchSize()) {
 151                                  break;
 152                              }
 153                              if (tableInfo == null &amp;&amp; tmpRhlClient == null) {
 154                                  // create new connection to fetch data
 155                                  tableInfo = (Elasticsearch6SideTableInfo) sideInfo.getSideTableInfo();
<abbr title=" 156                                  tmpRhlClient = Es6Util.getClient(tableInfo.getAddress(), tableInfo.isAuthMesh(), tableInfo.getUserName(), tableInfo.getPassword());"> 156                                  tmpRhlClient = Es6Util.getClient(tableInfo.getAddress(), tableInfo.isAuthMesh(), t🔵</abbr>
 157                              }
 158                              Object[] searchAfterParameter = searchHits[searchHits.length - 1].getSortValues();
 159                              searchSourceBuilder.searchAfter(searchAfterParameter);
 160                              searchRequest.source(searchSourceBuilder);
 161                              searchResponse = tmpRhlClient.search(searchRequest, RequestOptions.DEFAULT);
 162                              searchHits = searchResponse.getHits().getHits();
 163                          }
 164                          dealCacheData(key, CacheObj.buildCacheObj(ECacheContentType.MultiLine, cacheContent));
 165                          resultFuture.complete(rowList);
 166                      } catch (Exception e) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 167 -                        dealFillDataError(resultFuture, e, copyCrow);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 168 +                        dealFillDataError(resultFuture, e, copyInput);</span>
 169                      } finally {
 170                          if (tmpRhlClient != null) {
 171                              try {
 172                                  tmpRhlClient.close();
 173                              } catch (IOException e) {
 174                                  LOG.warn(&quot;Failed to shut down tmpRhlClient.&quot;, e);
 175                              }
 176                          }
 177                      }
 178                  } else {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 179 -                    dealMissKey(copyCrow, resultFuture);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 180 +                    dealMissKey(copyInput, resultFuture);</span>
 181                      dealCacheData(key, CacheMissVal.getMissKeyObj());
 182                  }
 183              }
 184  
 185              // 响应失败处理
 186              @Override
 187              public void onFailure(Exception e) {
 188                  LOG.error(&quot;&quot; + e);
 189                  resultFuture.completeExceptionally(new RuntimeException(&quot;Response failed!&quot;));
 190              }
 191          });
 192  
 193      }
 194  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 195 -    private void loadDataToCache(SearchHit[] searchHits, List&lt;CRow&gt; rowList, List&lt;Object&gt; cacheContent, CRow copyCrow) {"> 195 -    private void loadDataToCache(SearchHit[] searchHits, List&lt;CRow&gt; rowList, List&lt;Object&gt; cacheContent, CRow copyC🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 196 +    private void loadDataToCache(SearchHit[] searchHits, List&lt;Tuple2&lt;Boolean,Row&gt;&gt; rowList, List&lt;Object&gt; cacheContent, Tuple2&lt;Boolean,Row&gt; copyCrow) {"> 196 +    private void loadDataToCache(SearchHit[] searchHits, List&lt;Tuple2&lt;Boolean,Row&gt;&gt; rowList, List&lt;Object&gt; cacheCont🔵</abbr></span>
 197          List&lt;Object&gt; results = Lists.newArrayList();
 198          for (SearchHit searchHit : searchHits) {
 199              Map&lt;String, Object&gt; object = searchHit.getSourceAsMap();
 200              results.add(object);
 201          }
 202          rowList.addAll(getRows(copyCrow, cacheContent, results));
 203      }
 204  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 205 -    protected List&lt;CRow&gt; getRows(CRow inputRow, List&lt;Object&gt; cacheContent, List&lt;Object&gt; results) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 206 -        List&lt;CRow&gt; rowList = Lists.newArrayList();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 207 +    protected List&lt;Tuple2&lt;Boolean, Row&gt;&gt; getRows(Tuple2&lt;Boolean, Row&gt; inputRow, List&lt;Object&gt; cacheContent, List&lt;Object&gt; results) {"> 207 +    protected List&lt;Tuple2&lt;Boolean, Row&gt;&gt; getRows(Tuple2&lt;Boolean, Row&gt; inputRow, List&lt;Object&gt; cacheContent, List&lt;Ob🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 208 +        List&lt;Tuple2&lt;Boolean, Row&gt;&gt; rowList = Lists.newArrayList();</span>
 209          for (Object line : results) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 210 -            Row row = fillData(inputRow.row(), line);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 211 +            Row row = fillData(inputRow.f1, line);</span>
 212              if (null != cacheContent &amp;&amp; openCache()) {
 213                  cacheContent.add(line);
 214              }
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 215 -            rowList.add(new CRow(row, inputRow.change()));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 216 +            rowList.add(Tuple2.of(inputRow.f0, row));</span>
 217          }
 218          return rowList;
 219      }
 220  
 221      @Override
 222      public Row fillData(Row input, Object line) {
 223  
 224          Map&lt;String, Object&gt; cacheInfo = (Map&lt;String, Object&gt;) line;
 225          Row row = new Row(sideInfo.getOutFieldInfoList().size());
 226          String[] fields = sideInfo.getSideTableInfo().getFieldTypes();
 227          for (Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getInFieldIndex().entrySet()) {
 228              Object obj = input.getField(entry.getValue());
<abbr title=" 229              boolean isTimeIndicatorTypeInfo = TimeIndicatorTypeInfo.class.isAssignableFrom(sideInfo.getRowTypeInfo().getTypeAt(entry.getValue()).getClass());"> 229              boolean isTimeIndicatorTypeInfo = TimeIndicatorTypeInfo.class.isAssignableFrom(sideInfo.getRowTypeInfo🔵</abbr>
 230              if (obj instanceof Timestamp &amp;&amp; isTimeIndicatorTypeInfo) {
 231                  obj = ((Timestamp) obj).getTime();
 232              }
 233  
 234              row.setField(entry.getKey(), obj);
 235          }
 236  
 237          for (Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getSideFieldIndex().entrySet()) {
 238              if (cacheInfo == null) {
 239                  row.setField(entry.getKey(), null);
 240              } else {
<abbr title=" 241                  Object object = SwitchUtil.getTarget(cacheInfo.get(sideInfo.getSideFieldNameIndex().get(entry.getKey())), fields[entry.getValue()]);"> 241                  Object object = SwitchUtil.getTarget(cacheInfo.get(sideInfo.getSideFieldNameIndex().get(entry.getK🔵</abbr>
 242                  row.setField(entry.getKey(), object);
 243              }
 244          }
 245  
 246          return row;
 247      }
 248  
 249      @Override
 250      public void close() throws Exception {
 251          super.close();
 252          if (rhlClient != null) {
 253              rhlClient.close();
 254          }
 255  
 256      }
 257  
 258      public String buildCacheKey(List equalValList) {
 259          StringBuilder sb = new StringBuilder();
 260          for (Object ele : equalValList) {
 261              sb.append(ele.toString())
 262                      .append(&quot;_&quot;);
 263          }
 264  
 265          return sb.toString();
 266      }
 267  
 268      private SearchSourceBuilder initConfiguration() {
 269          SearchSourceBuilder searchSourceBuilder = new SearchSourceBuilder();
 270          searchSourceBuilder.size(getFetchSize());
 271          searchSourceBuilder.sort(&quot;_id&quot;, SortOrder.DESC);
 272          String[] sideFieldNames = StringUtils.split(sideInfo.getSideSelectFields().trim(), &quot;,&quot;);
 273          searchSourceBuilder.fetchSource(sideFieldNames, null);
 274  
 275          return searchSourceBuilder;
 276      }
 277  
 278      private BoolQueryBuilder setInputParams(List&lt;Object&gt; inputParams, BoolQueryBuilder boolQueryBuilder) {
 279          if (boolQueryBuilder == null) {
 280              boolQueryBuilder = new BoolQueryBuilder();
 281          }
 282  
 283          for (int i = 0; i &lt; sqlJoinCompareOperate.size(); i++) {
 284              String fieldName = sideInfo.getEqualFieldList().get(i);
 285              String operatorKind = sqlJoinCompareOperate.get(sideInfo.getEqualFieldList().indexOf(fieldName));
 286              String condition = String.valueOf(inputParams.get(i));
<abbr title=" 287              boolQueryBuilder = Es6Util.buildFilterCondition(boolQueryBuilder, new PredicateInfo(null, operatorKind, null, fieldName, condition), sideInfo);"> 287              boolQueryBuilder = Es6Util.buildFilterCondition(boolQueryBuilder, new PredicateInfo(null, operatorKind🔵</abbr>
 288          }
 289  
 290          return boolQueryBuilder;
 291      }
 292  
 293      public int getFetchSize() {
 294          return 1000;
 295      }
 296  }</pre></td>
                            <td><pre>   1  /*
   2   * Licensed to the Apache Software Foundation (ASF) under one
   3   * or more contributor license agreements.  See the NOTICE file
   4   * distributed with this work for additional information
   5   * regarding copyright ownership.  The ASF licenses this file
   6   * to you under the Apache License, Version 2.0 (the
   7   * &quot;License&quot;); you may not use this file except in compliance
   8   * with the License.  You may obtain a copy of the License at
   9   *
  10   *     http://www.apache.org/licenses/LICENSE-2.0
  11   *
  12   * Unless required by applicable law or agreed to in writing, software
  13   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15   * See the License for the specific language governing permissions and
  16   * limitations under the License.
  17   */
  18  
  19  package com.dtstack.flink.sql.side.elasticsearch6;
  20  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  21 +import com.dtstack.flink.sql.side.AbstractSideTableInfo;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  22 +import com.dtstack.flink.sql.side.BaseAsyncReqRow;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  23 +import com.dtstack.flink.sql.side.CacheMissVal;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  24 +import com.dtstack.flink.sql.side.FieldInfo;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  25 +import com.dtstack.flink.sql.side.JoinInfo;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  26 +import com.dtstack.flink.sql.side.PredicateInfo;</span>
  27  import org.apache.flink.api.java.typeutils.RowTypeInfo;
  28  import org.apache.flink.configuration.Configuration;
  29  import org.apache.flink.streaming.api.functions.async.ResultFuture;
  30  import org.apache.flink.table.runtime.types.CRow;
  31  import org.apache.flink.table.typeutils.TimeIndicatorTypeInfo;
  32  import org.apache.flink.types.Row;
  33  
  34  import com.dtstack.flink.sql.enums.ECacheContentType;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  35 -import com.dtstack.flink.sql.side.*;</span>
  36  import com.dtstack.flink.sql.side.cache.CacheObj;
  37  import com.dtstack.flink.sql.side.elasticsearch6.table.Elasticsearch6SideTableInfo;
  38  import com.dtstack.flink.sql.side.elasticsearch6.util.Es6Util;
  39  import com.dtstack.flink.sql.side.elasticsearch6.util.SwitchUtil;
  40  import com.dtstack.flink.sql.util.ParseUtils;
  41  import com.google.common.collect.Lists;
  42  import org.apache.calcite.sql.SqlNode;
  43  import org.apache.commons.lang3.StringUtils;
  44  import org.elasticsearch.action.ActionListener;
  45  import org.elasticsearch.action.search.SearchRequest;
  46  import org.elasticsearch.action.search.SearchResponse;
  47  import org.elasticsearch.client.RequestOptions;
  48  import org.elasticsearch.client.RestHighLevelClient;
  49  import org.elasticsearch.index.query.BoolQueryBuilder;
  50  import org.elasticsearch.search.SearchHit;
  51  import org.elasticsearch.search.builder.SearchSourceBuilder;
  52  import org.elasticsearch.search.sort.SortOrder;
  53  import org.slf4j.Logger;
  54  import org.slf4j.LoggerFactory;
  55  
  56  import java.io.IOException;
  57  import java.io.Serializable;
  58  import java.sql.Timestamp;
  59  import java.util.List;
  60  import java.util.Map;
  61  
  62  /**
  63   * @author yinxi
  64   * @date 2020/2/13 - 13:10
  65   */
  66  public class Elasticsearch6AsyncReqRow extends BaseAsyncReqRow implements Serializable {
  67  
  68      private static final Logger LOG = LoggerFactory.getLogger(Elasticsearch6AsyncReqRow.class);
  69      private transient RestHighLevelClient rhlClient;
  70      private SearchRequest searchRequest;
  71      private List&lt;String&gt; sqlJoinCompareOperate = Lists.newArrayList();
  72  
<abbr title="  73      public Elasticsearch6AsyncReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, AbstractSideTableInfo sideTableInfo) {">  73      public Elasticsearch6AsyncReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList,🔵</abbr>
  74          super(new Elasticsearch6AsyncSideInfo(rowTypeInfo, joinInfo, outFieldInfoList, sideTableInfo));
  75          SqlNode conditionNode = joinInfo.getCondition();
  76          ParseUtils.parseJoinCompareOperate(conditionNode, sqlJoinCompareOperate);
  77      }
  78  
  79      @Override
  80      public void open(Configuration parameters) throws Exception {
  81          super.open(parameters);
  82          Elasticsearch6SideTableInfo tableInfo = (Elasticsearch6SideTableInfo) sideInfo.getSideTableInfo();
<abbr title="  83          rhlClient = Es6Util.getClient(tableInfo.getAddress(), tableInfo.isAuthMesh(), tableInfo.getUserName(), tableInfo.getPassword());">  83          rhlClient = Es6Util.getClient(tableInfo.getAddress(), tableInfo.isAuthMesh(), tableInfo.getUserName(), tab🔵</abbr>
  84          searchRequest = Es6Util.setSearchRequest(sideInfo);
  85  
  86      }
  87  
  88  
  89      @Override
  90      public void asyncInvoke(CRow input, ResultFuture&lt;CRow&gt; resultFuture) throws Exception {
  91          CRow copyCrow = new CRow(input.row(), input.change());


  92          List&lt;Object&gt; inputParams = Lists.newArrayList();
  93          for (Integer conValIndex : sideInfo.getEqualValIndex()) {
  94              Object equalObj = copyCrow.row().getField(conValIndex);

  95              if (equalObj == null) {
  96                  dealMissKey(copyCrow, resultFuture);

  97                  return;
  98              }
  99              inputParams.add(equalObj);
 100          }
 101  
 102          String key = buildCacheKey(inputParams);
 103          if (openCache()) {
 104              CacheObj val = getFromCache(key);
 105              if (val != null) {
 106                  if (ECacheContentType.MissVal == val.getType()) {
 107                      dealMissKey(copyCrow, resultFuture);

 108                      return;
 109                  } else if (ECacheContentType.MultiLine == val.getType()) {
 110                      try {
 111                          List&lt;CRow&gt; rowList = getRows(copyCrow, null, (List) val.getContent());

 112                          resultFuture.complete(rowList);
 113                      } catch (Exception e) {
 114                          dealFillDataError(resultFuture, e, copyCrow);

 115                      }
 116                  } else {
<abbr title=" 117                      resultFuture.completeExceptionally(new RuntimeException(&quot;not support cache obj type &quot; + val.getType()));"> 117                      resultFuture.completeExceptionally(new RuntimeException(&quot;not support cache obj type &quot; + val.ge🔵</abbr>
 118                  }
 119                  return;
 120              }
 121          }
 122  
 123          BoolQueryBuilder boolQueryBuilder = Es6Util.setPredicateclause(sideInfo);
 124          boolQueryBuilder = setInputParams(inputParams, boolQueryBuilder);
 125          SearchSourceBuilder searchSourceBuilder = initConfiguration();
 126          searchSourceBuilder.query(boolQueryBuilder);
 127          searchRequest.source(searchSourceBuilder);
 128  
 129          // 异步查询数据
 130          rhlClient.searchAsync(searchRequest, RequestOptions.DEFAULT, new ActionListener&lt;SearchResponse&gt;() {
 131  
 132              //成功响应时
 133              @Override
 134              public void onResponse(SearchResponse searchResponse) {
 135  
 136                  List&lt;Object&gt; cacheContent = Lists.newArrayList();
 137                  List&lt;CRow&gt; rowList = Lists.newArrayList();

 138                  SearchHit[] searchHits = searchResponse.getHits().getHits();
 139                  if (searchHits.length &gt; 0) {
 140                      Elasticsearch6SideTableInfo tableInfo = null;
 141                      RestHighLevelClient tmpRhlClient = null;
 142                      try {
 143                          while (true) {
 144                              loadDataToCache(searchHits, rowList, cacheContent, copyCrow);

 145                              // determine if all results haven been ferched
 146                              if (searchHits.length &lt; getFetchSize()) {
 147                                  break;
 148                              }
 149                              if (tableInfo == null &amp;&amp; tmpRhlClient == null) {
 150                                  // create new connection to fetch data
 151                                  tableInfo = (Elasticsearch6SideTableInfo) sideInfo.getSideTableInfo();
<abbr title=" 152                                  tmpRhlClient = Es6Util.getClient(tableInfo.getAddress(), tableInfo.isAuthMesh(), tableInfo.getUserName(), tableInfo.getPassword());"> 152                                  tmpRhlClient = Es6Util.getClient(tableInfo.getAddress(), tableInfo.isAuthMesh(), t🔵</abbr>
 153                              }
 154                              Object[] searchAfterParameter = searchHits[searchHits.length - 1].getSortValues();
 155                              searchSourceBuilder.searchAfter(searchAfterParameter);
 156                              searchRequest.source(searchSourceBuilder);
 157                              searchResponse = tmpRhlClient.search(searchRequest, RequestOptions.DEFAULT);
 158                              searchHits = searchResponse.getHits().getHits();
 159                          }
 160                          dealCacheData(key, CacheObj.buildCacheObj(ECacheContentType.MultiLine, cacheContent));
 161                          resultFuture.complete(rowList);
 162                      } catch (Exception e) {
 163                          dealFillDataError(resultFuture, e, copyCrow);

 164                      } finally {
 165                          if (tmpRhlClient != null) {
 166                              try {
 167                                  tmpRhlClient.close();
 168                              } catch (IOException e) {
 169                                  LOG.warn(&quot;Failed to shut down tmpRhlClient.&quot;, e);
 170                              }
 171                          }
 172                      }
 173                  } else {
 174                      dealMissKey(copyCrow, resultFuture);

 175                      dealCacheData(key, CacheMissVal.getMissKeyObj());
 176                  }
 177              }
 178  
 179              // 响应失败处理
 180              @Override
 181              public void onFailure(Exception e) {
 182                  LOG.error(&quot;&quot; + e);
 183                  resultFuture.completeExceptionally(new RuntimeException(&quot;Response failed!&quot;));
 184              }
 185          });
 186  
 187      }
 188  
<abbr title=" 189      private void loadDataToCache(SearchHit[] searchHits, List&lt;CRow&gt; rowList, List&lt;Object&gt; cacheContent, CRow copyCrow) {"> 189      private void loadDataToCache(SearchHit[] searchHits, List&lt;CRow&gt; rowList, List&lt;Object&gt; cacheContent, CRow copyC🔵</abbr>

 190          List&lt;Object&gt; results = Lists.newArrayList();
 191          for (SearchHit searchHit : searchHits) {
 192              Map&lt;String, Object&gt; object = searchHit.getSourceAsMap();
 193              results.add(object);
 194          }
 195          rowList.addAll(getRows(copyCrow, cacheContent, results));
 196      }
 197  
 198      protected List&lt;CRow&gt; getRows(CRow inputRow, List&lt;Object&gt; cacheContent, List&lt;Object&gt; results) {
 199          List&lt;CRow&gt; rowList = Lists.newArrayList();


 200          for (Object line : results) {
 201              Row row = fillData(inputRow.row(), line);

 202              if (null != cacheContent &amp;&amp; openCache()) {
 203                  cacheContent.add(line);
 204              }
 205              rowList.add(new CRow(row, inputRow.change()));

 206          }
 207          return rowList;
 208      }
 209  
 210      @Override
 211      public Row fillData(Row input, Object line) {
 212  
 213          Map&lt;String, Object&gt; cacheInfo = (Map&lt;String, Object&gt;) line;
 214          Row row = new Row(sideInfo.getOutFieldInfoList().size());
 215          String[] fields = sideInfo.getSideTableInfo().getFieldTypes();
 216          for (Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getInFieldIndex().entrySet()) {
 217              Object obj = input.getField(entry.getValue());
<abbr title=" 218              boolean isTimeIndicatorTypeInfo = TimeIndicatorTypeInfo.class.isAssignableFrom(sideInfo.getRowTypeInfo().getTypeAt(entry.getValue()).getClass());"> 218              boolean isTimeIndicatorTypeInfo = TimeIndicatorTypeInfo.class.isAssignableFrom(sideInfo.getRowTypeInfo🔵</abbr>
 219              if (obj instanceof Timestamp &amp;&amp; isTimeIndicatorTypeInfo) {
 220                  obj = ((Timestamp) obj).getTime();
 221              }
 222  
 223              row.setField(entry.getKey(), obj);
 224          }
 225  
 226          for (Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getSideFieldIndex().entrySet()) {
 227              if (cacheInfo == null) {
 228                  row.setField(entry.getKey(), null);
 229              } else {
<abbr title=" 230                  Object object = SwitchUtil.getTarget(cacheInfo.get(sideInfo.getSideFieldNameIndex().get(entry.getKey())), fields[entry.getValue()]);"> 230                  Object object = SwitchUtil.getTarget(cacheInfo.get(sideInfo.getSideFieldNameIndex().get(entry.getK🔵</abbr>
 231                  row.setField(entry.getKey(), object);
 232              }
 233          }
 234  
 235          return row;
 236      }
 237  
 238      @Override
 239      public void close() throws Exception {
 240          super.close();
 241          if (rhlClient != null) {
 242              rhlClient.close();
 243          }
 244  
 245      }
 246  
 247      public String buildCacheKey(List equalValList) {
 248          StringBuilder sb = new StringBuilder();
 249          for (Object ele : equalValList) {
 250              sb.append(ele.toString())
 251                      .append(&quot;_&quot;);
 252          }
 253  
 254          return sb.toString();
 255      }
 256  
 257      private SearchSourceBuilder initConfiguration() {
 258          SearchSourceBuilder searchSourceBuilder = new SearchSourceBuilder();
 259          searchSourceBuilder.size(getFetchSize());
 260          searchSourceBuilder.sort(&quot;_id&quot;, SortOrder.DESC);
 261          String[] sideFieldNames = StringUtils.split(sideInfo.getSideSelectFields().trim(), &quot;,&quot;);
 262          searchSourceBuilder.fetchSource(sideFieldNames, null);
 263  
 264          return searchSourceBuilder;
 265      }
 266  
 267      private BoolQueryBuilder setInputParams(List&lt;Object&gt; inputParams, BoolQueryBuilder boolQueryBuilder) {
 268          if (boolQueryBuilder == null) {
 269              boolQueryBuilder = new BoolQueryBuilder();
 270          }
 271  
 272          for (int i = 0; i &lt; sqlJoinCompareOperate.size(); i++) {
 273              String fieldName = sideInfo.getEqualFieldList().get(i);
 274              String operatorKind = sqlJoinCompareOperate.get(sideInfo.getEqualFieldList().indexOf(fieldName));
 275              String condition = String.valueOf(inputParams.get(i));
<abbr title=" 276              boolQueryBuilder = Es6Util.buildFilterCondition(boolQueryBuilder, new PredicateInfo(null, operatorKind, null, fieldName, condition), sideInfo);"> 276              boolQueryBuilder = Es6Util.buildFilterCondition(boolQueryBuilder, new PredicateInfo(null, operatorKind🔵</abbr>
 277          }
 278  
 279          return boolQueryBuilder;
 280      }
 281  
 282      public int getFetchSize() {
 283          return 1000;
 284      }
 285  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            