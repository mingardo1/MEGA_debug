<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>321</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        .highlighted {
                            background-color: rgba(177, 82, 227, 0.85) !important;
                        }
                    </style>
                    <script>
                        function enter(c) {
                            const lines = document.getElementsByClassName(c);
                            for (let i = 0; i < lines.length; i++) {
                               lines.item(i).classList.add('highlighted');
                            }
                        }
                        function out(c) {
                            const lines = document.getElementsByClassName(c);
                            for (let i = 0; i < lines.length; i++) {
                               lines.item(i).classList.remove('highlighted');
                            }
                        }
                    </script>
              </head>
              <body>
                <span style="height: 4vh">
                    321
                    <a href="320.html">prev</a>
                    <a href="322.html">next</a>
                    <a href="321_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    DTStack/flinkStreamSQL_50c469a5b6542133ec852cd19a999679ea4093ed_core/src/main/java/com/dtstack/flink/sql/dirtyManager/manager/DirtyDataManager.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;50c469a5b6542133ec852cd19a999679ea4093ed:core/src/main/java/com/dtstack/flink/sql/dirtyManager/manager/DirtyDataManager.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;50c469a5b6542133ec852cd19a999679ea4093ed^1:core/src/main/java/com/dtstack/flink/sql/dirtyManager/manager/DirtyDataManager.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;50c469a5b6542133ec852cd19a999679ea4093ed^2:core/src/main/java/com/dtstack/flink/sql/dirtyManager/manager/DirtyDataManager.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;7ee482dc6e85e6f2df3f43d9a97b8b96edb606f7:core/src/main/java/com/dtstack/flink/sql/dirtyManager/manager/DirtyDataManager.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[b], [b], [bsj], [b], [b], [j], [j], [s]], subset: [[bsj]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre><span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style="">   1 /*                                                                                                       </span>
<span class="3101153502889412828" onmouseenter="enter('3101153502889412828');" onmouseout="out('3101153502889412828');" style="">   2  * Licensed to the Apache Software Foundation (ASF) under one                                            </span>
<span class="-6690800139350779170" onmouseenter="enter('-6690800139350779170');" onmouseout="out('-6690800139350779170');" style="">   3  * or more contributor license agreements.  See the NOTICE file                                          </span>
<span class="4408648408749222780" onmouseenter="enter('4408648408749222780');" onmouseout="out('4408648408749222780');" style="">   4  * distributed with this work for additional information                                                 </span>
<span class="7440871955664702931" onmouseenter="enter('7440871955664702931');" onmouseout="out('7440871955664702931');" style="">   5  * regarding copyright ownership.  The ASF licenses this file                                            </span>
<span class="-7748987699953482767" onmouseenter="enter('-7748987699953482767');" onmouseout="out('-7748987699953482767');" style="">   6  * to you under the Apache License, Version 2.0 (the                                                     </span>
<span class="-7532787339260984706" onmouseenter="enter('-7532787339260984706');" onmouseout="out('-7532787339260984706');" style="">   7  * &quot;License&quot;); you may not use this file except in compliance                                            </span>
<span class="6072654417402056570" onmouseenter="enter('6072654417402056570');" onmouseout="out('6072654417402056570');" style="">   8  * with the License.  You may obtain a copy of the License at                                            </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">   9  *                                                                                                       </span>
<span class="3430964305904514764" onmouseenter="enter('3430964305904514764');" onmouseout="out('3430964305904514764');" style="">  10  * http://www.apache.org/licenses/LICENSE-2.0                                                            </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  11  *                                                                                                       </span>
<span class="2557607632756179983" onmouseenter="enter('2557607632756179983');" onmouseout="out('2557607632756179983');" style="">  12  * Unless required by applicable law or agreed to in writing, software                                   </span>
<span class="-9189129105512731955" onmouseenter="enter('-9189129105512731955');" onmouseout="out('-9189129105512731955');" style="">  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,                                     </span>
<span class="5781161717946418340" onmouseenter="enter('5781161717946418340');" onmouseout="out('5781161717946418340');" style="">  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.                              </span>
<span class="1761562277992059393" onmouseenter="enter('1761562277992059393');" onmouseout="out('1761562277992059393');" style="">  15  * See the License for the specific language governing permissions and                                   </span>
<span class="7217408601297779962" onmouseenter="enter('7217408601297779962');" onmouseout="out('7217408601297779962');" style="">  16  * limitations under the License.                                                                        </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  17  */                                                                                                      </span>
<span  style="">  18                                                                                                          </span>
<span class="5491803375468606953" onmouseenter="enter('5491803375468606953');" onmouseout="out('5491803375468606953');" style="">  19 package com.dtstack.flink.sql.dirtyManager.manager;                                                      </span>
<span  style="">  20                                                                                                          </span>
<span class="1128057574573805325" onmouseenter="enter('1128057574573805325');" onmouseout="out('1128057574573805325');" style="">  21 import com.dtstack.flink.sql.classloader.ClassLoaderManager;                                             </span>
<span class="-9209416939158381067" onmouseenter="enter('-9209416939158381067');" onmouseout="out('-9209416939158381067');" style="">  22 import com.dtstack.flink.sql.dirtyManager.consumer.AbstractDirtyDataConsumer;                            </span>
<span class="114557361084888270" onmouseenter="enter('114557361084888270');" onmouseout="out('114557361084888270');" style="">  23 import com.dtstack.flink.sql.dirtyManager.entity.DirtyDataEntity;                                        </span>
<span class="9128825106411316982" onmouseenter="enter('9128825106411316982');" onmouseout="out('9128825106411316982');" style="">  24 import com.dtstack.flink.sql.factory.DTThreadFactory;                                                    </span>
<span class="-3389130316234486348" onmouseenter="enter('-3389130316234486348');" onmouseout="out('-3389130316234486348');" style="">  25 import com.dtstack.flink.sql.util.PluginUtil;                                                            </span>
<span class="9072327285961251154" onmouseenter="enter('9072327285961251154');" onmouseout="out('9072327285961251154');" style="">  26 import org.slf4j.Logger;                                                                                 </span>
<span class="697043352225962606" onmouseenter="enter('697043352225962606');" onmouseout="out('697043352225962606');" style="">  27 import org.slf4j.LoggerFactory;                                                                          </span>
<span  style="">  28                                                                                                          </span>
<span class="-3926401431737521278" onmouseenter="enter('-3926401431737521278');" onmouseout="out('-3926401431737521278');" style="">  29 import java.io.File;                                                                                     </span>
<span class="5998602906817463685" onmouseenter="enter('5998602906817463685');" onmouseout="out('5998602906817463685');" style="">  30 import java.io.Serializable;                                                                             </span>
<span class="2674806488057045420" onmouseenter="enter('2674806488057045420');" onmouseout="out('2674806488057045420');" style="">  31 import java.lang.reflect.Constructor;                                                                    </span>
<span class="6618655971923850695" onmouseenter="enter('6618655971923850695');" onmouseout="out('6618655971923850695');" style="">  32 import java.util.Map;                                                                                    </span>
<span class="-5549638946827519456" onmouseenter="enter('-5549638946827519456');" onmouseout="out('-5549638946827519456');" style="">  33 import java.util.concurrent.ExecutorService;                                                             </span>
<span class="-3492814532060861089" onmouseenter="enter('-3492814532060861089');" onmouseout="out('-3492814532060861089');" style="">  34 import java.util.concurrent.Executors;                                                                   </span>
<span class="-331778695229620376" onmouseenter="enter('-331778695229620376');" onmouseout="out('-331778695229620376');" style="">  35 import java.util.concurrent.Future;                                                                      </span>
<span class="5052275383743182469" onmouseenter="enter('5052275383743182469');" onmouseout="out('5052275383743182469');" style="">  36 import java.util.concurrent.LinkedBlockingQueue;                                                         </span>
<span class="8146438650974953238" onmouseenter="enter('8146438650974953238');" onmouseout="out('8146438650974953238');" style="">  37 import java.util.concurrent.ThreadPoolExecutor;                                                          </span>
<span class="-6356287537734540725" onmouseenter="enter('-6356287537734540725');" onmouseout="out('-6356287537734540725');" style="">  38 import java.util.concurrent.TimeUnit;                                                                    </span>
<span class="475099823122781612" onmouseenter="enter('475099823122781612');" onmouseout="out('475099823122781612');" style="">  39 import java.util.concurrent.atomic.AtomicLong;                                                           </span>
<span  style="">  40                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  41 /**                                                                                                      </span>
<span class="-4100502199450942834" onmouseenter="enter('-4100502199450942834');" onmouseout="out('-4100502199450942834');" style="">  42  * @author tiezhu                                                                                        </span>
<span class="-1158256683614797078" onmouseenter="enter('-1158256683614797078');" onmouseout="out('-1158256683614797078');" style="">  43  * Company dtstack                                                                                       </span>
<span class="-2400154308327571743" onmouseenter="enter('-2400154308327571743');" onmouseout="out('-2400154308327571743');" style="">  44  * Date 2020/8/27 星期四                                                                                    </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  45  */                                                                                                      </span>
<span class="-3812614075256696210" onmouseenter="enter('-3812614075256696210');" onmouseout="out('-3812614075256696210');" style="">  46 public class DirtyDataManager implements Serializable {                                                  </span>
<span class="-4667942192763773056" onmouseenter="enter('-4667942192763773056');" onmouseout="out('-4667942192763773056');" style="">  47 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours                                                                             </span>
<span class="6741223626729319096" onmouseenter="enter('6741223626729319096');" onmouseout="out('6741223626729319096');" style="">  48 ||||||| GitAnalyzerPlus_base                                                                             </span>
<span  style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  49                                                                                                          </span>
<span class="3796057323931724632" onmouseenter="enter('3796057323931724632');" onmouseout="out('3796057323931724632');" style="">  50 =======                                                                                                  </span>
<span  style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  51                                                                                                          </span>
<span class="-1382546150375666264" onmouseenter="enter('-1382546150375666264');" onmouseout="out('-1382546150375666264');" style="">  52 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs                                                                           </span>
<span class="5999329968759114835" onmouseenter="enter('5999329968759114835');" onmouseout="out('5999329968759114835');" style="">  53     private static final long serialVersionUID = 7190970299538893497L;                                   </span>
<span  style="">  54                                                                                                          </span>
<span class="224310682692221662" onmouseenter="enter('224310682692221662');" onmouseout="out('224310682692221662');" style="">  55     private static final Logger LOG = LoggerFactory.getLogger(DirtyDataManager.class);                   </span>
<span  style="">  56                                                                                                          </span>
<span class="-6228478812450324887" onmouseenter="enter('-6228478812450324887');" onmouseout="out('-6228478812450324887');" style="">  57     private static final String CLASS_PRE_STR = &quot;com.dtstack.flink.sql.dirty&quot;;                           </span>
<span  style="">  58                                                                                                          </span>
<span class="2656302477200666223" onmouseenter="enter('2656302477200666223');" onmouseout="out('2656302477200666223');" style="">  59     private static final String CLASS_POST_STR = &quot;DirtyDataConsumer&quot;;                                    </span>
<span  style="">  60                                                                                                          </span>
<span class="-144862183860853241" onmouseenter="enter('-144862183860853241');" onmouseout="out('-144862183860853241');" style="">  61     private static final String DIRTY_CONSUMER_PATH = &quot;dirtyData&quot;;                                       </span>
<span  style="">  62                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  63     /**                                                                                                  </span>
<span class="2447214252488375907" onmouseenter="enter('2447214252488375907');" onmouseout="out('2447214252488375907');" style="">  64      * 写入队列阻塞时间                                                                                          </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  65      */                                                                                                  </span>
<span class="1288105432018799460" onmouseenter="enter('1288105432018799460');" onmouseout="out('1288105432018799460');" style="">  66     private long blockingInterval;                                                                       </span>
<span  style="">  67                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  68     /**                                                                                                  </span>
<span class="-7026334171379977064" onmouseenter="enter('-7026334171379977064');" onmouseout="out('-7026334171379977064');" style="">  69      * 缓存脏数据信息队列                                                                                         </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  70      */                                                                                                  </span>
<span class="1580837919019423566" onmouseenter="enter('1580837919019423566');" onmouseout="out('1580837919019423566');" style="">  71     public final LinkedBlockingQueue&lt;DirtyDataEntity&gt; queue = new LinkedBlockingQueue&lt;&gt;();               </span>
<span  style="">  72                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  73     /**                                                                                                  </span>
<span class="3233249345333193755" onmouseenter="enter('3233249345333193755');" onmouseout="out('3233249345333193755');" style="">  74      * 统计manager收集到的脏数据条数                                                                                </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  75      */                                                                                                  </span>
<span class="-8874840091978478789" onmouseenter="enter('-8874840091978478789');" onmouseout="out('-8874840091978478789');" style="">  76     private final AtomicLong count = new AtomicLong(0);                                                  </span>
<span  style="">  77                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  78     /**                                                                                                  </span>
<span class="-8804634106042183975" onmouseenter="enter('-8804634106042183975');" onmouseout="out('-8804634106042183975');" style="">  79      * 脏数据写入队列失败条数                                                                                       </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  80      */                                                                                                  </span>
<span class="4228318894546121771" onmouseenter="enter('4228318894546121771');" onmouseout="out('4228318894546121771');" style="">  81     private final AtomicLong errorCount = new AtomicLong(0);                                             </span>
<span  style="">  82                                                                                                          </span>
<span class="-4667942192763773056" onmouseenter="enter('-4667942192763773056');" onmouseout="out('-4667942192763773056');" style="">  83 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours                                                                             </span>
<span class="4017110792483941245" onmouseenter="enter('4017110792483941245');" onmouseout="out('4017110792483941245');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  84     public AbstractDirtyDataConsumer consumer;                                                           </span>
<span  style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  85                                                                                                          </span>
<span class="8919599632341312398" onmouseenter="enter('8919599632341312398');" onmouseout="out('8919599632341312398');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  86     private final ExecutorService executor = Executors.newSingleThreadExecutor();                        </span>
<span class="6741223626729319096" onmouseenter="enter('6741223626729319096');" onmouseout="out('6741223626729319096');" style="">  87 ||||||| GitAnalyzerPlus_base                                                                             </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  88     /**                                                                                                  </span>
<span class="-9065255876861284630" onmouseenter="enter('-9065255876861284630');" onmouseout="out('-9065255876861284630');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  89      * 通过参数生成manager实例，并同时将consumer实例化                                                                   </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  90      */                                                                                                  </span>
<span class="3796057323931724632" onmouseenter="enter('3796057323931724632');" onmouseout="out('3796057323931724632');" style="">  91 =======                                                                                                  </span>
<span class="6376742731498755928" onmouseenter="enter('6376742731498755928');" onmouseout="out('6376742731498755928');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  92     private double errorLimitRate;                                                                       </span>
<span  style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  93                                                                                                          </span>
<span class="-2805031698975647131" onmouseenter="enter('-2805031698975647131');" onmouseout="out('-2805031698975647131');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  94     public static AbstractDirtyDataConsumer consumer;                                                    </span>
<span class="-1382546150375666264" onmouseenter="enter('-1382546150375666264');" onmouseout="out('-1382546150375666264');" style="">  95 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs                                                                           </span>
<span  style="">  96                                                                                                          </span>
<span class="-1864791881058708717" onmouseenter="enter('-1864791881058708717');" onmouseout="out('-1864791881058708717');" style="">  97     private static ThreadPoolExecutor dirtyDataConsumer;                                                 </span>
<span  style="">  98                                                                                                          </span>
<span class="2567714078094157835" onmouseenter="enter('2567714078094157835');" onmouseout="out('2567714078094157835');" style="">  99     public final static int MAX_POOL_SIZE_LIMIT = 5;                                                     </span>
<span  style=""> 100                                                                                                          </span>
<span class="-7081887652578957041" onmouseenter="enter('-7081887652578957041');" onmouseout="out('-7081887652578957041');" style=""> 101     private final static int MAX_TASK_QUEUE_SIZE = 100;                                                  </span>
<span  style=""> 102                                                                                                          </span>
<span class="-785659455048892261" onmouseenter="enter('-785659455048892261');" onmouseout="out('-785659455048892261');" style=""> 103     private final static String DEFAULT_TYPE = &quot;console&quot;;                                                </span>
<span  style=""> 104                                                                                                          </span>
<span class="-5843097799946498887" onmouseenter="enter('-5843097799946498887');" onmouseout="out('-5843097799946498887');" style=""> 105     private final static String DEFAULT_ERROR_LIMIT_RATE = &quot;0.8&quot;;                                        </span>
<span  style=""> 106                                                                                                          </span>
<span class="-3406851134206279848" onmouseenter="enter('-3406851134206279848');" onmouseout="out('-3406851134206279848');" style=""> 107     private final static String DEFAULT_BLOCKING_INTERVAL = &quot;60&quot;;                                        </span>
<span  style=""> 108                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 109     /**                                                                                                  </span>
<span class="-9065255876861284630" onmouseenter="enter('-9065255876861284630');" onmouseout="out('-9065255876861284630');" style=""> 110      * 通过参数生成manager实例，并同时将consumer实例化                                                                   </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 111      */                                                                                                  </span>
<span class="8247390322301240087" onmouseenter="enter('8247390322301240087');" onmouseout="out('8247390322301240087');" style=""> 112     public static DirtyDataManager newInstance(Map&lt;String, String&gt; properties) throws Exception {        </span>
<span class="-429202415469380285" onmouseenter="enter('-429202415469380285');" onmouseout="out('-429202415469380285');" style=""> 113         DirtyDataManager manager = new DirtyDataManager();                                               </span>
<span class="-4667942192763773056" onmouseenter="enter('-4667942192763773056');" onmouseout="out('-4667942192763773056');" style=""> 114 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours                                                                             </span>
<span class="-6498901718656355528" onmouseenter="enter('-6498901718656355528');" onmouseout="out('-6498901718656355528');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 115         manager.blockingInterval = Long.parseLong(properties.getOrDefault(&quot;blockingInterval&quot;, &quot;60&quot;));    </span>
<span class="-5593258154225191560" onmouseenter="enter('-5593258154225191560');" onmouseout="out('-5593258154225191560');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 116         manager.consumer = createConsumer(properties);                                                   </span>
<span class="-5717168828156365572" onmouseenter="enter('-5717168828156365572');" onmouseout="out('-5717168828156365572');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 117         manager.consumer.init(properties);                                                               </span>
<span class="4747534887806436185" onmouseenter="enter('4747534887806436185');" onmouseout="out('4747534887806436185');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 118         manager.executor.execute(manager.consumer);                                                      </span>
<span class="6741223626729319096" onmouseenter="enter('6741223626729319096');" onmouseout="out('6741223626729319096');" style=""> 119 ||||||| GitAnalyzerPlus_base                                                                             </span>
<span class="8740236974697237335" onmouseenter="enter('8740236974697237335');" onmouseout="out('8740236974697237335');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 120         Thread dirtyDataConsumer = new Thread(consumer.setQueue(manager.queue), &quot;dirtyData Consumer&quot;);   </span>
<span class="2707431131308680140" onmouseenter="enter('2707431131308680140');" onmouseout="out('2707431131308680140');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 121         dirtyDataConsumer.start();                                                                       </span>
<span class="4517602483633400817" onmouseenter="enter('4517602483633400817');" onmouseout="out('4517602483633400817');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 122         return manager;                                                                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 123     }                                                                                                    </span>
<span  style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 124                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 125     /**                                                                                                  </span>
<span class="2813898973986269376" onmouseenter="enter('2813898973986269376');" onmouseout="out('2813898973986269376');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 126      * 通过动态加载的方式加载Consumer                                                                               </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 127      */                                                                                                  </span>
<span class="-7283128464228250938" onmouseenter="enter('-7283128464228250938');" onmouseout="out('-7283128464228250938');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 128     private static AbstractDirtyDataConsumer createConsumer(Map&lt;String, String&gt; properties) throws Exception {"> 128     private static AbstractDirtyDataConsumer createConsumer(Map&lt;String, String&gt; properties) throws Except🔵</abbr></span>
<span class="-4914662716305676428" onmouseenter="enter('-4914662716305676428');" onmouseout="out('-4914662716305676428');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 129         String type = properties.getOrDefault(&quot;type&quot;, &quot;print&quot;);                                          </span>
<span class="483617201224409134" onmouseenter="enter('483617201224409134');" onmouseout="out('483617201224409134');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 130         String consumerType = DIRTY_CONSUMER_PATH + File.separator + type;                               </span>
<span class="2615777252874702183" onmouseenter="enter('2615777252874702183');" onmouseout="out('2615777252874702183');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 131         String consumerJar = PluginUtil.getJarFileDirPath(consumerType, properties.getOrDefault(&quot;pluginPath&quot;, null), &quot;shipfile&quot;);"> 131         String consumerJar = PluginUtil.getJarFileDirPath(consumerType, properties.getOrDefault(&quot;pluginPa🔵</abbr></span>
<span class="-5190243946208745922" onmouseenter="enter('-5190243946208745922');" onmouseout="out('-5190243946208745922');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 132         String className = CLASS_PRE_STR + &quot;.&quot; + type.toLowerCase() + &quot;.&quot; + upperCaseFirstChar(type + CLASS_POST_STR);"> 132         String className = CLASS_PRE_STR + &quot;.&quot; + type.toLowerCase() + &quot;.&quot; + upperCaseFirstChar(type + CLA🔵</abbr></span>
<span  style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 133                                                                                                          </span>
<span class="-4007269595747684077" onmouseenter="enter('-4007269595747684077');" onmouseout="out('-4007269595747684077');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 134         return ClassLoaderManager.newInstance(consumerJar, cl -&gt; {                                       </span>
<span class="-1748502629280141996" onmouseenter="enter('-1748502629280141996');" onmouseout="out('-1748502629280141996');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 135             Class&lt;?&gt; clazz = cl.loadClass(className);                                                    </span>
<span class="8710049300716534777" onmouseenter="enter('8710049300716534777');" onmouseout="out('8710049300716534777');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 136             Constructor&lt;?&gt; constructor = clazz.getConstructor();                                         </span>
<span class="2831262314561398727" onmouseenter="enter('2831262314561398727');" onmouseout="out('2831262314561398727');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 137             return (AbstractDirtyDataConsumer) constructor.newInstance();                                </span>
<span class="7938821646327104961" onmouseenter="enter('7938821646327104961');" onmouseout="out('7938821646327104961');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 138         });                                                                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 139     }                                                                                                    </span>
<span  style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 140                                                                                                          </span>
<span class="3796057323931724632" onmouseenter="enter('3796057323931724632');" onmouseout="out('3796057323931724632');" style=""> 141 =======                                                                                                  </span>
<span class="1957877795460293246" onmouseenter="enter('1957877795460293246');" onmouseout="out('1957877795460293246');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 142         manager.blockingInterval = Long.parseLong(properties.getOrDefault(&quot;blockingInterval&quot;, DEFAULT_BLOCKING_INTERVAL));"> 142         manager.blockingInterval = Long.parseLong(properties.getOrDefault(&quot;blockingInterval&quot;, DEFAULT_BLO🔵</abbr></span>
<span class="-4708360011963152283" onmouseenter="enter('-4708360011963152283');" onmouseout="out('-4708360011963152283');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 143         manager.errorLimitRate = Double.parseDouble(properties.getOrDefault(&quot;errorLimitRate&quot;, DEFAULT_ERROR_LIMIT_RATE));"> 143         manager.errorLimitRate = Double.parseDouble(properties.getOrDefault(&quot;errorLimitRate&quot;, DEFAULT_ERR🔵</abbr></span>
<span class="1492431014173351963" onmouseenter="enter('1492431014173351963');" onmouseout="out('1492431014173351963');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 144         consumer = createConsumer(properties);                                                           </span>
<span class="-1976763955085357310" onmouseenter="enter('-1976763955085357310');" onmouseout="out('-1976763955085357310');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 145         consumer.init(properties);                                                                       </span>
<span class="-8797406258356249433" onmouseenter="enter('-8797406258356249433');" onmouseout="out('-8797406258356249433');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 146         consumer.setQueue(manager.queue);                                                                </span>
<span class="-1281301123089696578" onmouseenter="enter('-1281301123089696578');" onmouseout="out('-1281301123089696578');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 147         dirtyDataConsumer = new ThreadPoolExecutor(MAX_POOL_SIZE_LIMIT, MAX_POOL_SIZE_LIMIT, 0, TimeUnit.MILLISECONDS,"> 147         dirtyDataConsumer = new ThreadPoolExecutor(MAX_POOL_SIZE_LIMIT, MAX_POOL_SIZE_LIMIT, 0, TimeUnit.🔵</abbr></span>
<span class="-2176419747084942513" onmouseenter="enter('-2176419747084942513');" onmouseout="out('-2176419747084942513');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 148                 new LinkedBlockingQueue&lt;&gt;(MAX_TASK_QUEUE_SIZE), new DTThreadFactory(&quot;dirtyDataConsumer&quot;), new ThreadPoolExecutor.CallerRunsPolicy());"> 148                 new LinkedBlockingQueue&lt;&gt;(MAX_TASK_QUEUE_SIZE), new DTThreadFactory(&quot;dirtyDataConsumer&quot;),🔵</abbr></span>
<span class="5908978019406382442" onmouseenter="enter('5908978019406382442');" onmouseout="out('5908978019406382442');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 149         dirtyDataConsumer.execute(consumer);                                                             </span>
<span  style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 150                                                                                                          </span>
<span class="-1382546150375666264" onmouseenter="enter('-1382546150375666264');" onmouseout="out('-1382546150375666264');" style=""> 151 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs                                                                           </span>
<span class="4517602483633400817" onmouseenter="enter('4517602483633400817');" onmouseout="out('4517602483633400817');" style=""> 152         return manager;                                                                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 153     }                                                                                                    </span>
<span  style=""> 154                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 155     /**                                                                                                  </span>
<span class="2813898973986269376" onmouseenter="enter('2813898973986269376');" onmouseout="out('2813898973986269376');" style=""> 156      * 通过动态加载的方式加载Consumer                                                                               </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 157      */                                                                                                  </span>
<span class="-7283128464228250938" onmouseenter="enter('-7283128464228250938');" onmouseout="out('-7283128464228250938');" style=""><abbr title=" 158     private static AbstractDirtyDataConsumer createConsumer(Map&lt;String, String&gt; properties) throws Exception {"> 158     private static AbstractDirtyDataConsumer createConsumer(Map&lt;String, String&gt; properties) throws Except🔵</abbr></span>
<span class="-4392768324361270875" onmouseenter="enter('-4392768324361270875');" onmouseout="out('-4392768324361270875');" style=""> 159         String type = properties.getOrDefault(&quot;type&quot;, DEFAULT_TYPE);                                     </span>
<span class="483617201224409134" onmouseenter="enter('483617201224409134');" onmouseout="out('483617201224409134');" style=""> 160         String consumerType = DIRTY_CONSUMER_PATH + File.separator + type;                               </span>
<span class="2615777252874702183" onmouseenter="enter('2615777252874702183');" onmouseout="out('2615777252874702183');" style=""><abbr title=" 161         String consumerJar = PluginUtil.getJarFileDirPath(consumerType, properties.getOrDefault(&quot;pluginPath&quot;, null), &quot;shipfile&quot;);"> 161         String consumerJar = PluginUtil.getJarFileDirPath(consumerType, properties.getOrDefault(&quot;pluginPa🔵</abbr></span>
<span class="-5190243946208745922" onmouseenter="enter('-5190243946208745922');" onmouseout="out('-5190243946208745922');" style=""><abbr title=" 162         String className = CLASS_PRE_STR + &quot;.&quot; + type.toLowerCase() + &quot;.&quot; + upperCaseFirstChar(type + CLASS_POST_STR);"> 162         String className = CLASS_PRE_STR + &quot;.&quot; + type.toLowerCase() + &quot;.&quot; + upperCaseFirstChar(type + CLA🔵</abbr></span>
<span  style=""> 163                                                                                                          </span>
<span class="-4007269595747684077" onmouseenter="enter('-4007269595747684077');" onmouseout="out('-4007269595747684077');" style=""> 164         return ClassLoaderManager.newInstance(consumerJar, cl -&gt; {                                       </span>
<span class="-1748502629280141996" onmouseenter="enter('-1748502629280141996');" onmouseout="out('-1748502629280141996');" style=""> 165             Class&lt;?&gt; clazz = cl.loadClass(className);                                                    </span>
<span class="8710049300716534777" onmouseenter="enter('8710049300716534777');" onmouseout="out('8710049300716534777');" style=""> 166             Constructor&lt;?&gt; constructor = clazz.getConstructor();                                         </span>
<span class="2831262314561398727" onmouseenter="enter('2831262314561398727');" onmouseout="out('2831262314561398727');" style=""> 167             return (AbstractDirtyDataConsumer) constructor.newInstance();                                </span>
<span class="7938821646327104961" onmouseenter="enter('7938821646327104961');" onmouseout="out('7938821646327104961');" style=""> 168         });                                                                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 169     }                                                                                                    </span>
<span  style=""> 170                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 171     /**                                                                                                  </span>
<span class="5810358238997397501" onmouseenter="enter('5810358238997397501');" onmouseout="out('5810358238997397501');" style=""> 172      * 脏数据收集任务停止，任务停止之前，需要将队列中所有的数据清空                                                                    </span>
<span class="412054095653206879" onmouseenter="enter('412054095653206879');" onmouseout="out('412054095653206879');" style=""> 173      * TODO consumer 关闭时仍有数据没有消费到，假如有500条数据，在结束时实际消费数量可能只有493                                            </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 174      */                                                                                                  </span>
<span class="-8990893524708255660" onmouseenter="enter('-8990893524708255660');" onmouseout="out('-8990893524708255660');" style=""> 175     public void close() {                                                                                </span>
<span class="-4667942192763773056" onmouseenter="enter('-4667942192763773056');" onmouseout="out('-4667942192763773056');" style=""> 176 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours                                                                             </span>
<span class="5792664235883029029" onmouseenter="enter('5792664235883029029');" onmouseout="out('5792664235883029029');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 177         if (!queue.isEmpty() &amp;&amp; checkConsumer()) {                                                       </span>
<span class="6269622546247724580" onmouseenter="enter('6269622546247724580');" onmouseout="out('6269622546247724580');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 178             executor.shutdown();                                                                         </span>
<span class="6741223626729319096" onmouseenter="enter('6741223626729319096');" onmouseout="out('6741223626729319096');" style=""> 179 ||||||| GitAnalyzerPlus_base                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 180         }                                                                                                </span>
<span class="3359122776167641383" onmouseenter="enter('3359122776167641383');" onmouseout="out('3359122776167641383');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 181         LOG.info(&quot;dirty consumer is closing ...&quot;);                                                       </span>
<span class="7934375192701066001" onmouseenter="enter('7934375192701066001');" onmouseout="out('7934375192701066001');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 182         consumer.close();                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 183     }                                                                                                    </span>
<span  style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 184                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 185     /**                                                                                                  </span>
<span class="4819634322432885190" onmouseenter="enter('4819634322432885190');" onmouseout="out('4819634322432885190');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 186      * 收集脏数据放入队列缓存中，记录放入失败的数目和存入队列中的总数目，如果放入失败的数目超过一定比列，那么manager任务失败                                    </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 187      */                                                                                                  </span>
<span class="-6344828763611310298" onmouseenter="enter('-6344828763611310298');" onmouseout="out('-6344828763611310298');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 188     public void collectDirtyData(String dataInfo, String cause, String field) {                          </span>
<span class="3152158306793742973" onmouseenter="enter('3152158306793742973');" onmouseout="out('3152158306793742973');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 189         DirtyDataEntity dirtyDataEntity = new DirtyDataEntity(dataInfo, System.currentTimeMillis(), cause, field);"> 189         DirtyDataEntity dirtyDataEntity = new DirtyDataEntity(dataInfo, System.currentTimeMillis(), cause🔵</abbr></span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 190         try {                                                                                            </span>
<span class="5568638511517650665" onmouseenter="enter('5568638511517650665');" onmouseout="out('5568638511517650665');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 191             queue.offer(dirtyDataEntity, blockingInterval, TimeUnit.MILLISECONDS);                       </span>
<span class="-4277231538887053652" onmouseenter="enter('-4277231538887053652');" onmouseout="out('-4277231538887053652');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 192             count.incrementAndGet();                                                                     </span>
<span class="8538742657781196138" onmouseenter="enter('8538742657781196138');" onmouseout="out('8538742657781196138');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 193         } catch (Exception ignored) {                                                                    </span>
<span class="8412332427617783613" onmouseenter="enter('8412332427617783613');" onmouseout="out('8412332427617783613');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 194             LOG.warn(&quot;dirty Data insert error ... Failed number: &quot; + errorCount.incrementAndGet());      </span>
<span class="-2112956431206001507" onmouseenter="enter('-2112956431206001507');" onmouseout="out('-2112956431206001507');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 195             LOG.warn(&quot;error dirty data:&quot; + dirtyDataEntity.toString());                                  </span>
<span class="-6672890298032813997" onmouseenter="enter('-6672890298032813997');" onmouseout="out('-6672890298032813997');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 196             if (errorCount.get() &gt; Math.ceil(count.longValue() * 0.8)) {                                 </span>
<span class="6502407236027236896" onmouseenter="enter('6502407236027236896');" onmouseout="out('6502407236027236896');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 197                 throw new RuntimeException(&quot;The number of failed number reaches the limit, manager fails&quot;);"> 197                 throw new RuntimeException(&quot;The number of failed number reaches the limit, manager fails&quot;🔵</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 198             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 199         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 200     }                                                                                                    </span>
<span  style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 201                                                                                                          </span>
<span class="3796057323931724632" onmouseenter="enter('3796057323931724632');" onmouseout="out('3796057323931724632');" style=""> 202 =======                                                                                                  </span>
<span class="1832344628397617014" onmouseenter="enter('1832344628397617014');" onmouseout="out('1832344628397617014');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 203         if (checkConsumer()) {                                                                           </span>
<span class="3359122776167641383" onmouseenter="enter('3359122776167641383');" onmouseout="out('3359122776167641383');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 204             LOG.info(&quot;dirty consumer is closing ...&quot;);                                                   </span>
<span class="7934375192701066001" onmouseenter="enter('7934375192701066001');" onmouseout="out('7934375192701066001');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 205             consumer.close();                                                                            </span>
<span class="-8608443351473140036" onmouseenter="enter('-8608443351473140036');" onmouseout="out('-8608443351473140036');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 206             dirtyDataConsumer.shutdownNow();                                                             </span>
<span class="-1382546150375666264" onmouseenter="enter('-1382546150375666264');" onmouseout="out('-1382546150375666264');" style=""> 207 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs                                                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 208         }                                                                                                </span>
<span class="-4667942192763773056" onmouseenter="enter('-4667942192763773056');" onmouseout="out('-4667942192763773056');" style=""> 209 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours                                                                             </span>
<span class="3359122776167641383" onmouseenter="enter('3359122776167641383');" onmouseout="out('3359122776167641383');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 210         LOG.info(&quot;dirty consumer is closing ...&quot;);                                                       </span>
<span class="4585814285115663204" onmouseenter="enter('4585814285115663204');" onmouseout="out('4585814285115663204');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 211         this.consumer.isRunning.compareAndSet(true, false);                                              </span>
<span class="-4665420521193854593" onmouseenter="enter('-4665420521193854593');" onmouseout="out('-4665420521193854593');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 212         executor.shutdownNow();                                                                          </span>
<span class="6741223626729319096" onmouseenter="enter('6741223626729319096');" onmouseout="out('6741223626729319096');" style=""> 213 ||||||| GitAnalyzerPlus_base                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 214     }                                                                                                    </span>
<span  style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 215                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 216     /**                                                                                                  </span>
<span class="4819634322432885190" onmouseenter="enter('4819634322432885190');" onmouseout="out('4819634322432885190');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 217      * 收集脏数据放入队列缓存中，记录放入失败的数目和存入队列中的总数目，如果放入失败的数目超过一定比列，那么manager任务失败                                    </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 218      */                                                                                                  </span>
<span class="-6344828763611310298" onmouseenter="enter('-6344828763611310298');" onmouseout="out('-6344828763611310298');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 219     public void collectDirtyData(String dataInfo, String cause, String field) {                          </span>
<span class="3152158306793742973" onmouseenter="enter('3152158306793742973');" onmouseout="out('3152158306793742973');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 220         DirtyDataEntity dirtyDataEntity = new DirtyDataEntity(dataInfo, System.currentTimeMillis(), cause, field);"> 220         DirtyDataEntity dirtyDataEntity = new DirtyDataEntity(dataInfo, System.currentTimeMillis(), cause🔵</abbr></span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 221         try {                                                                                            </span>
<span class="5568638511517650665" onmouseenter="enter('5568638511517650665');" onmouseout="out('5568638511517650665');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 222             queue.offer(dirtyDataEntity, blockingInterval, TimeUnit.MILLISECONDS);                       </span>
<span class="-4277231538887053652" onmouseenter="enter('-4277231538887053652');" onmouseout="out('-4277231538887053652');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 223             count.incrementAndGet();                                                                     </span>
<span class="8538742657781196138" onmouseenter="enter('8538742657781196138');" onmouseout="out('8538742657781196138');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 224         } catch (Exception ignored) {                                                                    </span>
<span class="8412332427617783613" onmouseenter="enter('8412332427617783613');" onmouseout="out('8412332427617783613');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 225             LOG.warn(&quot;dirty Data insert error ... Failed number: &quot; + errorCount.incrementAndGet());      </span>
<span class="-2112956431206001507" onmouseenter="enter('-2112956431206001507');" onmouseout="out('-2112956431206001507');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 226             LOG.warn(&quot;error dirty data:&quot; + dirtyDataEntity.toString());                                  </span>
<span class="-6672890298032813997" onmouseenter="enter('-6672890298032813997');" onmouseout="out('-6672890298032813997');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 227             if (errorCount.get() &gt; Math.ceil(count.longValue() * 0.8)) {                                 </span>
<span class="6502407236027236896" onmouseenter="enter('6502407236027236896');" onmouseout="out('6502407236027236896');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 228                 throw new RuntimeException(&quot;The number of failed number reaches the limit, manager fails&quot;);"> 228                 throw new RuntimeException(&quot;The number of failed number reaches the limit, manager fails&quot;🔵</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 229             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 230         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 231     }                                                                                                    </span>
<span  style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 232                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 233     /**                                                                                                  </span>
<span class="3796057323931724632" onmouseenter="enter('3796057323931724632');" onmouseout="out('3796057323931724632');" style=""> 234 =======                                                                                                  </span>
<span class="-1382546150375666264" onmouseenter="enter('-1382546150375666264');" onmouseout="out('-1382546150375666264');" style=""> 235 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs                                                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 236     }                                                                                                    </span>
<span  style=""> 237                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 238     /**                                                                                                  </span>
<span class="194178201576134348" onmouseenter="enter('194178201576134348');" onmouseout="out('194178201576134348');" style=""> 239      * 收集脏数据放入队列缓存中，记录放入失败的数目和存入队列中的总数目，如果放入失败的数目超过一定比例，那么manager任务失败                                    </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 240      */                                                                                                  </span>
<span class="-6344828763611310298" onmouseenter="enter('-6344828763611310298');" onmouseout="out('-6344828763611310298');" style=""> 241     public void collectDirtyData(String dataInfo, String cause, String field) {                          </span>
<span class="3152158306793742973" onmouseenter="enter('3152158306793742973');" onmouseout="out('3152158306793742973');" style=""><abbr title=" 242         DirtyDataEntity dirtyDataEntity = new DirtyDataEntity(dataInfo, System.currentTimeMillis(), cause, field);"> 242         DirtyDataEntity dirtyDataEntity = new DirtyDataEntity(dataInfo, System.currentTimeMillis(), cause🔵</abbr></span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 243         try {                                                                                            </span>
<span class="5568638511517650665" onmouseenter="enter('5568638511517650665');" onmouseout="out('5568638511517650665');" style=""> 244             queue.offer(dirtyDataEntity, blockingInterval, TimeUnit.MILLISECONDS);                       </span>
<span class="-4277231538887053652" onmouseenter="enter('-4277231538887053652');" onmouseout="out('-4277231538887053652');" style=""> 245             count.incrementAndGet();                                                                     </span>
<span class="8538742657781196138" onmouseenter="enter('8538742657781196138');" onmouseout="out('8538742657781196138');" style=""> 246         } catch (Exception ignored) {                                                                    </span>
<span class="8412332427617783613" onmouseenter="enter('8412332427617783613');" onmouseout="out('8412332427617783613');" style=""> 247             LOG.warn(&quot;dirty Data insert error ... Failed number: &quot; + errorCount.incrementAndGet());      </span>
<span class="-2112956431206001507" onmouseenter="enter('-2112956431206001507');" onmouseout="out('-2112956431206001507');" style=""> 248             LOG.warn(&quot;error dirty data:&quot; + dirtyDataEntity.toString());                                  </span>
<span class="-1442578212705282557" onmouseenter="enter('-1442578212705282557');" onmouseout="out('-1442578212705282557');" style=""> 249             if (errorCount.get() &gt; Math.ceil(count.longValue() * errorLimitRate)) {                      </span>
<span class="6502407236027236896" onmouseenter="enter('6502407236027236896');" onmouseout="out('6502407236027236896');" style=""><abbr title=" 250                 throw new RuntimeException(&quot;The number of failed number reaches the limit, manager fails&quot;);"> 250                 throw new RuntimeException(&quot;The number of failed number reaches the limit, manager fails&quot;🔵</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 251             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 252         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 253     }                                                                                                    </span>
<span  style=""> 254                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 255     /**                                                                                                  </span>
<span class="2449093599871099166" onmouseenter="enter('2449093599871099166');" onmouseout="out('2449093599871099166');" style=""> 256      * 查看consumer当前状态                                                                                    </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 257      */                                                                                                  </span>
<span class="-7462222326053316033" onmouseenter="enter('-7462222326053316033');" onmouseout="out('-7462222326053316033');" style=""> 258     public boolean checkConsumer() {                                                                     </span>
<span class="1228564361815955906" onmouseenter="enter('1228564361815955906');" onmouseout="out('1228564361815955906');" style=""> 259         return this.consumer.isRunning();                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 260     }                                                                                                    </span>
<span  style=""> 261                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 262     /**                                                                                                  </span>
<span class="-2486644912947517360" onmouseenter="enter('-2486644912947517360');" onmouseout="out('-2486644912947517360');" style=""> 263      * 首字母大写                                                                                             </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 264      */                                                                                                  </span>
<span class="3506443581067250310" onmouseenter="enter('3506443581067250310');" onmouseout="out('3506443581067250310');" style=""> 265     private static String upperCaseFirstChar(String str) {                                               </span>
<span class="8717998801821522526" onmouseenter="enter('8717998801821522526');" onmouseout="out('8717998801821522526');" style=""> 266         return str.substring(0, 1).toUpperCase() + str.substring(1);                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 267     }                                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 268 }                                                                                                        </span></pre></td>
                            <td><pre><span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style="">   1 /*                                                                                                       </span>
<span class="3101153502889412828" onmouseenter="enter('3101153502889412828');" onmouseout="out('3101153502889412828');" style="">   2  * Licensed to the Apache Software Foundation (ASF) under one                                            </span>
<span class="-6690800139350779170" onmouseenter="enter('-6690800139350779170');" onmouseout="out('-6690800139350779170');" style="">   3  * or more contributor license agreements.  See the NOTICE file                                          </span>
<span class="4408648408749222780" onmouseenter="enter('4408648408749222780');" onmouseout="out('4408648408749222780');" style="">   4  * distributed with this work for additional information                                                 </span>
<span class="7440871955664702931" onmouseenter="enter('7440871955664702931');" onmouseout="out('7440871955664702931');" style="">   5  * regarding copyright ownership.  The ASF licenses this file                                            </span>
<span class="-7748987699953482767" onmouseenter="enter('-7748987699953482767');" onmouseout="out('-7748987699953482767');" style="">   6  * to you under the Apache License, Version 2.0 (the                                                     </span>
<span class="-7532787339260984706" onmouseenter="enter('-7532787339260984706');" onmouseout="out('-7532787339260984706');" style="">   7  * &quot;License&quot;); you may not use this file except in compliance                                            </span>
<span class="6072654417402056570" onmouseenter="enter('6072654417402056570');" onmouseout="out('6072654417402056570');" style="">   8  * with the License.  You may obtain a copy of the License at                                            </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">   9  *                                                                                                       </span>
<span class="3430964305904514764" onmouseenter="enter('3430964305904514764');" onmouseout="out('3430964305904514764');" style="">  10  * http://www.apache.org/licenses/LICENSE-2.0                                                            </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  11  *                                                                                                       </span>
<span class="2557607632756179983" onmouseenter="enter('2557607632756179983');" onmouseout="out('2557607632756179983');" style="">  12  * Unless required by applicable law or agreed to in writing, software                                   </span>
<span class="-9189129105512731955" onmouseenter="enter('-9189129105512731955');" onmouseout="out('-9189129105512731955');" style="">  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,                                     </span>
<span class="5781161717946418340" onmouseenter="enter('5781161717946418340');" onmouseout="out('5781161717946418340');" style="">  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.                              </span>
<span class="1761562277992059393" onmouseenter="enter('1761562277992059393');" onmouseout="out('1761562277992059393');" style="">  15  * See the License for the specific language governing permissions and                                   </span>
<span class="7217408601297779962" onmouseenter="enter('7217408601297779962');" onmouseout="out('7217408601297779962');" style="">  16  * limitations under the License.                                                                        </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  17  */                                                                                                      </span>
<span  style="">  18                                                                                                          </span>
<span class="5491803375468606953" onmouseenter="enter('5491803375468606953');" onmouseout="out('5491803375468606953');" style="">  19 package com.dtstack.flink.sql.dirtyManager.manager;                                                      </span>
<span  style="">  20                                                                                                          </span>
<span class="1128057574573805325" onmouseenter="enter('1128057574573805325');" onmouseout="out('1128057574573805325');" style="">  21 import com.dtstack.flink.sql.classloader.ClassLoaderManager;                                             </span>
<span class="-9209416939158381067" onmouseenter="enter('-9209416939158381067');" onmouseout="out('-9209416939158381067');" style="">  22 import com.dtstack.flink.sql.dirtyManager.consumer.AbstractDirtyDataConsumer;                            </span>
<span class="114557361084888270" onmouseenter="enter('114557361084888270');" onmouseout="out('114557361084888270');" style="">  23 import com.dtstack.flink.sql.dirtyManager.entity.DirtyDataEntity;                                        </span>
<span class="9128825106411316982" onmouseenter="enter('9128825106411316982');" onmouseout="out('9128825106411316982');" style="">  24 import com.dtstack.flink.sql.factory.DTThreadFactory;                                                    </span>
<span class="-3389130316234486348" onmouseenter="enter('-3389130316234486348');" onmouseout="out('-3389130316234486348');" style="">  25 import com.dtstack.flink.sql.util.PluginUtil;                                                            </span>
<span class="9072327285961251154" onmouseenter="enter('9072327285961251154');" onmouseout="out('9072327285961251154');" style="">  26 import org.slf4j.Logger;                                                                                 </span>
<span class="697043352225962606" onmouseenter="enter('697043352225962606');" onmouseout="out('697043352225962606');" style="">  27 import org.slf4j.LoggerFactory;                                                                          </span>
<span  style="">  28                                                                                                          </span>
<span class="-3926401431737521278" onmouseenter="enter('-3926401431737521278');" onmouseout="out('-3926401431737521278');" style="">  29 import java.io.File;                                                                                     </span>
<span class="5998602906817463685" onmouseenter="enter('5998602906817463685');" onmouseout="out('5998602906817463685');" style="">  30 import java.io.Serializable;                                                                             </span>
<span class="2674806488057045420" onmouseenter="enter('2674806488057045420');" onmouseout="out('2674806488057045420');" style="">  31 import java.lang.reflect.Constructor;                                                                    </span>
<span class="6618655971923850695" onmouseenter="enter('6618655971923850695');" onmouseout="out('6618655971923850695');" style="">  32 import java.util.Map;                                                                                    </span>
<span class="-5549638946827519456" onmouseenter="enter('-5549638946827519456');" onmouseout="out('-5549638946827519456');" style="">  33 import java.util.concurrent.ExecutorService;                                                             </span>
<span class="-3492814532060861089" onmouseenter="enter('-3492814532060861089');" onmouseout="out('-3492814532060861089');" style="">  34 import java.util.concurrent.Executors;                                                                   </span>
<span class="-331778695229620376" onmouseenter="enter('-331778695229620376');" onmouseout="out('-331778695229620376');" style="">  35 import java.util.concurrent.Future;                                                                      </span>
<span class="5052275383743182469" onmouseenter="enter('5052275383743182469');" onmouseout="out('5052275383743182469');" style="">  36 import java.util.concurrent.LinkedBlockingQueue;                                                         </span>
<span class="8146438650974953238" onmouseenter="enter('8146438650974953238');" onmouseout="out('8146438650974953238');" style="">  37 import java.util.concurrent.ThreadPoolExecutor;                                                          </span>
<span class="-6356287537734540725" onmouseenter="enter('-6356287537734540725');" onmouseout="out('-6356287537734540725');" style="">  38 import java.util.concurrent.TimeUnit;                                                                    </span>
<span class="475099823122781612" onmouseenter="enter('475099823122781612');" onmouseout="out('475099823122781612');" style="">  39 import java.util.concurrent.atomic.AtomicLong;                                                           </span>
<span  style="">  40                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  41 /**                                                                                                      </span>
<span class="-4100502199450942834" onmouseenter="enter('-4100502199450942834');" onmouseout="out('-4100502199450942834');" style="">  42  * @author tiezhu                                                                                        </span>
<span class="-1158256683614797078" onmouseenter="enter('-1158256683614797078');" onmouseout="out('-1158256683614797078');" style="">  43  * Company dtstack                                                                                       </span>
<span class="-2400154308327571743" onmouseenter="enter('-2400154308327571743');" onmouseout="out('-2400154308327571743');" style="">  44  * Date 2020/8/27 星期四                                                                                    </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  45  */                                                                                                      </span>
<span class="-3812614075256696210" onmouseenter="enter('-3812614075256696210');" onmouseout="out('-3812614075256696210');" style="">  46 public class DirtyDataManager implements Serializable {                                                  </span>
<span class="5999329968759114835" onmouseenter="enter('5999329968759114835');" onmouseout="out('5999329968759114835');" style="">  47     private static final long serialVersionUID = 7190970299538893497L;                                   </span>
<span  style="">  48                                                                                                          </span>
<span class="224310682692221662" onmouseenter="enter('224310682692221662');" onmouseout="out('224310682692221662');" style="">  49     private static final Logger LOG = LoggerFactory.getLogger(DirtyDataManager.class);                   </span>
<span  style="">  50                                                                                                          </span>
<span class="-6228478812450324887" onmouseenter="enter('-6228478812450324887');" onmouseout="out('-6228478812450324887');" style="">  51     private static final String CLASS_PRE_STR = &quot;com.dtstack.flink.sql.dirty&quot;;                           </span>
<span  style="">  52                                                                                                          </span>
<span class="2656302477200666223" onmouseenter="enter('2656302477200666223');" onmouseout="out('2656302477200666223');" style="">  53     private static final String CLASS_POST_STR = &quot;DirtyDataConsumer&quot;;                                    </span>
<span  style="">  54                                                                                                          </span>
<span class="-144862183860853241" onmouseenter="enter('-144862183860853241');" onmouseout="out('-144862183860853241');" style="">  55     private static final String DIRTY_CONSUMER_PATH = &quot;dirtyData&quot;;                                       </span>
<span  style="">  56                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  57     /**                                                                                                  </span>
<span class="2447214252488375907" onmouseenter="enter('2447214252488375907');" onmouseout="out('2447214252488375907');" style="">  58      * 写入队列阻塞时间                                                                                          </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  59      */                                                                                                  </span>
<span class="1288105432018799460" onmouseenter="enter('1288105432018799460');" onmouseout="out('1288105432018799460');" style="">  60     private long blockingInterval;                                                                       </span>
<span  style="">  61                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  62     /**                                                                                                  </span>
<span class="-7026334171379977064" onmouseenter="enter('-7026334171379977064');" onmouseout="out('-7026334171379977064');" style="">  63      * 缓存脏数据信息队列                                                                                         </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  64      */                                                                                                  </span>
<span class="1580837919019423566" onmouseenter="enter('1580837919019423566');" onmouseout="out('1580837919019423566');" style="">  65     public final LinkedBlockingQueue&lt;DirtyDataEntity&gt; queue = new LinkedBlockingQueue&lt;&gt;();               </span>
<span  style="">  66                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  67     /**                                                                                                  </span>
<span class="3233249345333193755" onmouseenter="enter('3233249345333193755');" onmouseout="out('3233249345333193755');" style="">  68      * 统计manager收集到的脏数据条数                                                                                </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  69      */                                                                                                  </span>
<span class="-8874840091978478789" onmouseenter="enter('-8874840091978478789');" onmouseout="out('-8874840091978478789');" style="">  70     private final AtomicLong count = new AtomicLong(0);                                                  </span>
<span  style="">  71                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  72     /**                                                                                                  </span>
<span class="-8804634106042183975" onmouseenter="enter('-8804634106042183975');" onmouseout="out('-8804634106042183975');" style="">  73      * 脏数据写入队列失败条数                                                                                       </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  74      */                                                                                                  </span>
<span class="4228318894546121771" onmouseenter="enter('4228318894546121771');" onmouseout="out('4228318894546121771');" style="">  75     private final AtomicLong errorCount = new AtomicLong(0);                                             </span>
<span  style="">  76                                                                                                          </span>
<span class="6376742731498755928" onmouseenter="enter('6376742731498755928');" onmouseout="out('6376742731498755928');" style="">  77     private double errorLimitRate;                                                                       </span>
<span  style="">  78                                                                                                          </span>
<span class="4017110792483941245" onmouseenter="enter('4017110792483941245');" onmouseout="out('4017110792483941245');" style="">  79     public AbstractDirtyDataConsumer consumer;                                                           </span>
<span  style="">  80                                                                                                          </span>
<span class="8919599632341312398" onmouseenter="enter('8919599632341312398');" onmouseout="out('8919599632341312398');" style="">  81     private final ExecutorService executor = Executors.newSingleThreadExecutor();                        </span>
<span  style="">  82                                                                                                          </span>
<span class="-1864791881058708717" onmouseenter="enter('-1864791881058708717');" onmouseout="out('-1864791881058708717');" style="">  83     private static ThreadPoolExecutor dirtyDataConsumer;                                                 </span>
<span  style="">  84                                                                                                          </span>
<span class="2567714078094157835" onmouseenter="enter('2567714078094157835');" onmouseout="out('2567714078094157835');" style="">  85     public final static int MAX_POOL_SIZE_LIMIT = 5;                                                     </span>
<span  style="">  86                                                                                                          </span>
<span class="-7081887652578957041" onmouseenter="enter('-7081887652578957041');" onmouseout="out('-7081887652578957041');" style="">  87     private final static int MAX_TASK_QUEUE_SIZE = 100;                                                  </span>
<span  style="">  88                                                                                                          </span>
<span class="-785659455048892261" onmouseenter="enter('-785659455048892261');" onmouseout="out('-785659455048892261');" style="">  89     private final static String DEFAULT_TYPE = &quot;console&quot;;                                                </span>
<span  style="">  90                                                                                                          </span>
<span class="-5843097799946498887" onmouseenter="enter('-5843097799946498887');" onmouseout="out('-5843097799946498887');" style="">  91     private final static String DEFAULT_ERROR_LIMIT_RATE = &quot;0.8&quot;;                                        </span>
<span  style="">  92                                                                                                          </span>
<span class="-3406851134206279848" onmouseenter="enter('-3406851134206279848');" onmouseout="out('-3406851134206279848');" style="">  93     private final static String DEFAULT_BLOCKING_INTERVAL = &quot;60&quot;;                                        </span>
<span  style="">  94                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  95     /**                                                                                                  </span>
<span class="-9065255876861284630" onmouseenter="enter('-9065255876861284630');" onmouseout="out('-9065255876861284630');" style="">  96      * 通过参数生成manager实例，并同时将consumer实例化                                                                   </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  97      */                                                                                                  </span>
<span class="8247390322301240087" onmouseenter="enter('8247390322301240087');" onmouseout="out('8247390322301240087');" style="">  98     public static DirtyDataManager newInstance(Map&lt;String, String&gt; properties) throws Exception {        </span>
<span class="-429202415469380285" onmouseenter="enter('-429202415469380285');" onmouseout="out('-429202415469380285');" style="">  99         DirtyDataManager manager = new DirtyDataManager();                                               </span>
<span class="7598536375028459133" onmouseenter="enter('7598536375028459133');" onmouseout="out('7598536375028459133');" style=""> 100 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE                                                                                             </span>
<span class="-6498901718656355528" onmouseenter="enter('-6498901718656355528');" onmouseout="out('-6498901718656355528');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 101         manager.blockingInterval = Long.parseLong(properties.getOrDefault(&quot;blockingInterval&quot;, &quot;60&quot;));    </span>
<span class="-5593258154225191560" onmouseenter="enter('-5593258154225191560');" onmouseout="out('-5593258154225191560');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 102         manager.consumer = createConsumer(properties);                                                   </span>
<span class="-5717168828156365572" onmouseenter="enter('-5717168828156365572');" onmouseout="out('-5717168828156365572');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 103         manager.consumer.init(properties);                                                               </span>
<span class="4747534887806436185" onmouseenter="enter('4747534887806436185');" onmouseout="out('4747534887806436185');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 104         manager.executor.execute(manager.consumer);                                                      </span>
<span class="7991106586064342212" onmouseenter="enter('7991106586064342212');" onmouseout="out('7991106586064342212');" style=""> 105 ||||||| BASE                                                                                             </span>
<span class="-6498901718656355528" onmouseenter="enter('-6498901718656355528');" onmouseout="out('-6498901718656355528');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 106         manager.blockingInterval = Long.parseLong(properties.getOrDefault(&quot;blockingInterval&quot;, &quot;60&quot;));    </span>
<span class="1492431014173351963" onmouseenter="enter('1492431014173351963');" onmouseout="out('1492431014173351963');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 107         consumer = createConsumer(properties);                                                           </span>
<span class="-1976763955085357310" onmouseenter="enter('-1976763955085357310');" onmouseout="out('-1976763955085357310');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 108         consumer.init(properties);                                                                       </span>
<span class="-8035703022814018113" onmouseenter="enter('-8035703022814018113');" onmouseout="out('-8035703022814018113');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 109         //TODO 使用线程池创建线程，不要用thread                                                                       </span>
<span class="8740236974697237335" onmouseenter="enter('8740236974697237335');" onmouseout="out('8740236974697237335');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 110         Thread dirtyDataConsumer = new Thread(consumer.setQueue(manager.queue), &quot;dirtyData Consumer&quot;);   </span>
<span class="2707431131308680140" onmouseenter="enter('2707431131308680140');" onmouseout="out('2707431131308680140');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 111         dirtyDataConsumer.start();                                                                       </span>
<span class="4517602483633400817" onmouseenter="enter('4517602483633400817');" onmouseout="out('4517602483633400817');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 112         return manager;                                                                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 113     }                                                                                                    </span>
<span class="3796057323931724632" onmouseenter="enter('3796057323931724632');" onmouseout="out('3796057323931724632');" style=""> 114 =======                                                                                                  </span>
<span class="1957877795460293246" onmouseenter="enter('1957877795460293246');" onmouseout="out('1957877795460293246');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 115         manager.blockingInterval = Long.parseLong(properties.getOrDefault(&quot;blockingInterval&quot;, DEFAULT_BLOCKING_INTERVAL));"> 115         manager.blockingInterval = Long.parseLong(properties.getOrDefault(&quot;blockingInterval&quot;, DEFAULT_BLO🔵</abbr></span>
<span class="-4708360011963152283" onmouseenter="enter('-4708360011963152283');" onmouseout="out('-4708360011963152283');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 116         manager.errorLimitRate = Double.parseDouble(properties.getOrDefault(&quot;errorLimitRate&quot;, DEFAULT_ERROR_LIMIT_RATE));"> 116         manager.errorLimitRate = Double.parseDouble(properties.getOrDefault(&quot;errorLimitRate&quot;, DEFAULT_ERR🔵</abbr></span>
<span class="1492431014173351963" onmouseenter="enter('1492431014173351963');" onmouseout="out('1492431014173351963');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 117         consumer = createConsumer(properties);                                                           </span>
<span class="-1976763955085357310" onmouseenter="enter('-1976763955085357310');" onmouseout="out('-1976763955085357310');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 118         consumer.init(properties);                                                                       </span>
<span class="-8797406258356249433" onmouseenter="enter('-8797406258356249433');" onmouseout="out('-8797406258356249433');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 119         consumer.setQueue(manager.queue);                                                                </span>
<span class="-1281301123089696578" onmouseenter="enter('-1281301123089696578');" onmouseout="out('-1281301123089696578');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 120         dirtyDataConsumer = new ThreadPoolExecutor(MAX_POOL_SIZE_LIMIT, MAX_POOL_SIZE_LIMIT, 0, TimeUnit.MILLISECONDS,"> 120         dirtyDataConsumer = new ThreadPoolExecutor(MAX_POOL_SIZE_LIMIT, MAX_POOL_SIZE_LIMIT, 0, TimeUnit.🔵</abbr></span>
<span class="-2176419747084942513" onmouseenter="enter('-2176419747084942513');" onmouseout="out('-2176419747084942513');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 121                 new LinkedBlockingQueue&lt;&gt;(MAX_TASK_QUEUE_SIZE), new DTThreadFactory(&quot;dirtyDataConsumer&quot;), new ThreadPoolExecutor.CallerRunsPolicy());"> 121                 new LinkedBlockingQueue&lt;&gt;(MAX_TASK_QUEUE_SIZE), new DTThreadFactory(&quot;dirtyDataConsumer&quot;),🔵</abbr></span>
<span class="5908978019406382442" onmouseenter="enter('5908978019406382442');" onmouseout="out('5908978019406382442');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 122         dirtyDataConsumer.execute(consumer);                                                             </span>
<span  style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 123                                                                                                          </span>
<span class="-5027112130205478640" onmouseenter="enter('-5027112130205478640');" onmouseout="out('-5027112130205478640');" style=""> 124 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS                                                                                            </span>
<span class="4517602483633400817" onmouseenter="enter('4517602483633400817');" onmouseout="out('4517602483633400817');" style=""> 125         return manager;                                                                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 126     }                                                                                                    </span>
<span  style=""> 127                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 128     /**                                                                                                  </span>
<span class="2813898973986269376" onmouseenter="enter('2813898973986269376');" onmouseout="out('2813898973986269376');" style=""> 129      * 通过动态加载的方式加载Consumer                                                                               </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 130      */                                                                                                  </span>
<span class="-7283128464228250938" onmouseenter="enter('-7283128464228250938');" onmouseout="out('-7283128464228250938');" style=""><abbr title=" 131     private static AbstractDirtyDataConsumer createConsumer(Map&lt;String, String&gt; properties) throws Exception {"> 131     private static AbstractDirtyDataConsumer createConsumer(Map&lt;String, String&gt; properties) throws Except🔵</abbr></span>
<span class="-4392768324361270875" onmouseenter="enter('-4392768324361270875');" onmouseout="out('-4392768324361270875');" style=""> 132         String type = properties.getOrDefault(&quot;type&quot;, DEFAULT_TYPE);                                     </span>
<span class="483617201224409134" onmouseenter="enter('483617201224409134');" onmouseout="out('483617201224409134');" style=""> 133         String consumerType = DIRTY_CONSUMER_PATH + File.separator + type;                               </span>
<span class="2615777252874702183" onmouseenter="enter('2615777252874702183');" onmouseout="out('2615777252874702183');" style=""><abbr title=" 134         String consumerJar = PluginUtil.getJarFileDirPath(consumerType, properties.getOrDefault(&quot;pluginPath&quot;, null), &quot;shipfile&quot;);"> 134         String consumerJar = PluginUtil.getJarFileDirPath(consumerType, properties.getOrDefault(&quot;pluginPa🔵</abbr></span>
<span class="-5190243946208745922" onmouseenter="enter('-5190243946208745922');" onmouseout="out('-5190243946208745922');" style=""><abbr title=" 135         String className = CLASS_PRE_STR + &quot;.&quot; + type.toLowerCase() + &quot;.&quot; + upperCaseFirstChar(type + CLASS_POST_STR);"> 135         String className = CLASS_PRE_STR + &quot;.&quot; + type.toLowerCase() + &quot;.&quot; + upperCaseFirstChar(type + CLA🔵</abbr></span>
<span  style=""> 136                                                                                                          </span>
<span class="-4007269595747684077" onmouseenter="enter('-4007269595747684077');" onmouseout="out('-4007269595747684077');" style=""> 137         return ClassLoaderManager.newInstance(consumerJar, cl -&gt; {                                       </span>
<span class="-1748502629280141996" onmouseenter="enter('-1748502629280141996');" onmouseout="out('-1748502629280141996');" style=""> 138             Class&lt;?&gt; clazz = cl.loadClass(className);                                                    </span>
<span class="8710049300716534777" onmouseenter="enter('8710049300716534777');" onmouseout="out('8710049300716534777');" style=""> 139             Constructor&lt;?&gt; constructor = clazz.getConstructor();                                         </span>
<span class="2831262314561398727" onmouseenter="enter('2831262314561398727');" onmouseout="out('2831262314561398727');" style=""> 140             return (AbstractDirtyDataConsumer) constructor.newInstance();                                </span>
<span class="7938821646327104961" onmouseenter="enter('7938821646327104961');" onmouseout="out('7938821646327104961');" style=""> 141         });                                                                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 142     }                                                                                                    </span>
<span  style=""> 143                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 144     /**                                                                                                  </span>
<span class="5810358238997397501" onmouseenter="enter('5810358238997397501');" onmouseout="out('5810358238997397501');" style=""> 145      * 脏数据收集任务停止，任务停止之前，需要将队列中所有的数据清空                                                                    </span>
<span class="412054095653206879" onmouseenter="enter('412054095653206879');" onmouseout="out('412054095653206879');" style=""> 146      * TODO consumer 关闭时仍有数据没有消费到，假如有500条数据，在结束时实际消费数量可能只有493                                            </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 147      */                                                                                                  </span>
<span class="-8990893524708255660" onmouseenter="enter('-8990893524708255660');" onmouseout="out('-8990893524708255660');" style=""> 148     public void close() {                                                                                </span>
<span class="7598536375028459133" onmouseenter="enter('7598536375028459133');" onmouseout="out('7598536375028459133');" style=""> 149 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE                                                                                             </span>
<span class="5792664235883029029" onmouseenter="enter('5792664235883029029');" onmouseout="out('5792664235883029029');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 150         if (!queue.isEmpty() &amp;&amp; checkConsumer()) {                                                       </span>
<span class="6269622546247724580" onmouseenter="enter('6269622546247724580');" onmouseout="out('6269622546247724580');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 151             executor.shutdown();                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 152         }                                                                                                </span>
<span class="7991106586064342212" onmouseenter="enter('7991106586064342212');" onmouseout="out('7991106586064342212');" style=""> 153 ||||||| BASE                                                                                             </span>
<span class="5792664235883029029" onmouseenter="enter('5792664235883029029');" onmouseout="out('5792664235883029029');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 154         if (!queue.isEmpty() &amp;&amp; checkConsumer()) {                                                       </span>
<span class="-5377898926401715887" onmouseenter="enter('-5377898926401715887');" onmouseout="out('-5377898926401715887');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 155             consumer.consume();                                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 156         }                                                                                                </span>
<span class="3796057323931724632" onmouseenter="enter('3796057323931724632');" onmouseout="out('3796057323931724632');" style=""> 157 =======                                                                                                  </span>
<span class="1832344628397617014" onmouseenter="enter('1832344628397617014');" onmouseout="out('1832344628397617014');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 158         if (checkConsumer()) {                                                                           </span>
<span class="-5027112130205478640" onmouseenter="enter('-5027112130205478640');" onmouseout="out('-5027112130205478640');" style=""> 159 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS                                                                                            </span>
<span class="3359122776167641383" onmouseenter="enter('3359122776167641383');" onmouseout="out('3359122776167641383');" style=""> 160         LOG.info(&quot;dirty consumer is closing ...&quot;);                                                       </span>
<span class="7598536375028459133" onmouseenter="enter('7598536375028459133');" onmouseout="out('7598536375028459133');" style=""> 161 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE                                                                                             </span>
<span class="4585814285115663204" onmouseenter="enter('4585814285115663204');" onmouseout="out('4585814285115663204');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 162         this.consumer.isRunning.compareAndSet(true, false);                                              </span>
<span class="-4665420521193854593" onmouseenter="enter('-4665420521193854593');" onmouseout="out('-4665420521193854593');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 163         executor.shutdownNow();                                                                          </span>
<span class="7991106586064342212" onmouseenter="enter('7991106586064342212');" onmouseout="out('7991106586064342212');" style=""> 164 ||||||| BASE                                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 165         }                                                                                                </span>
<span class="3359122776167641383" onmouseenter="enter('3359122776167641383');" onmouseout="out('3359122776167641383');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 166         LOG.info(&quot;dirty consumer is closing ...&quot;);                                                       </span>
<span class="7934375192701066001" onmouseenter="enter('7934375192701066001');" onmouseout="out('7934375192701066001');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 167         consumer.close();                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 168     }                                                                                                    </span>
<span class="3796057323931724632" onmouseenter="enter('3796057323931724632');" onmouseout="out('3796057323931724632');" style=""> 169 =======                                                                                                  </span>
<span class="7934375192701066001" onmouseenter="enter('7934375192701066001');" onmouseout="out('7934375192701066001');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 170             consumer.close();                                                                            </span>
<span class="-8608443351473140036" onmouseenter="enter('-8608443351473140036');" onmouseout="out('-8608443351473140036');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 171             dirtyDataConsumer.shutdownNow();                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 172         }                                                                                                </span>
<span class="-5027112130205478640" onmouseenter="enter('-5027112130205478640');" onmouseout="out('-5027112130205478640');" style=""> 173 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 174     }                                                                                                    </span>
<span  style=""> 175                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 176     /**                                                                                                  </span>
<span class="194178201576134348" onmouseenter="enter('194178201576134348');" onmouseout="out('194178201576134348');" style=""> 177      * 收集脏数据放入队列缓存中，记录放入失败的数目和存入队列中的总数目，如果放入失败的数目超过一定比例，那么manager任务失败                                    </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 178      */                                                                                                  </span>
<span class="-6344828763611310298" onmouseenter="enter('-6344828763611310298');" onmouseout="out('-6344828763611310298');" style=""> 179     public void collectDirtyData(String dataInfo, String cause, String field) {                          </span>
<span class="3152158306793742973" onmouseenter="enter('3152158306793742973');" onmouseout="out('3152158306793742973');" style=""><abbr title=" 180         DirtyDataEntity dirtyDataEntity = new DirtyDataEntity(dataInfo, System.currentTimeMillis(), cause, field);"> 180         DirtyDataEntity dirtyDataEntity = new DirtyDataEntity(dataInfo, System.currentTimeMillis(), cause🔵</abbr></span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 181         try {                                                                                            </span>
<span class="5568638511517650665" onmouseenter="enter('5568638511517650665');" onmouseout="out('5568638511517650665');" style=""> 182             queue.offer(dirtyDataEntity, blockingInterval, TimeUnit.MILLISECONDS);                       </span>
<span class="-4277231538887053652" onmouseenter="enter('-4277231538887053652');" onmouseout="out('-4277231538887053652');" style=""> 183             count.incrementAndGet();                                                                     </span>
<span class="8538742657781196138" onmouseenter="enter('8538742657781196138');" onmouseout="out('8538742657781196138');" style=""> 184         } catch (Exception ignored) {                                                                    </span>
<span class="8412332427617783613" onmouseenter="enter('8412332427617783613');" onmouseout="out('8412332427617783613');" style=""> 185             LOG.warn(&quot;dirty Data insert error ... Failed number: &quot; + errorCount.incrementAndGet());      </span>
<span class="-2112956431206001507" onmouseenter="enter('-2112956431206001507');" onmouseout="out('-2112956431206001507');" style=""> 186             LOG.warn(&quot;error dirty data:&quot; + dirtyDataEntity.toString());                                  </span>
<span class="-1442578212705282557" onmouseenter="enter('-1442578212705282557');" onmouseout="out('-1442578212705282557');" style=""> 187             if (errorCount.get() &gt; Math.ceil(count.longValue() * errorLimitRate)) {                      </span>
<span class="6502407236027236896" onmouseenter="enter('6502407236027236896');" onmouseout="out('6502407236027236896');" style=""><abbr title=" 188                 throw new RuntimeException(&quot;The number of failed number reaches the limit, manager fails&quot;);"> 188                 throw new RuntimeException(&quot;The number of failed number reaches the limit, manager fails&quot;🔵</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 189             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 190         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 191     }                                                                                                    </span>
<span  style=""> 192                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 193     /**                                                                                                  </span>
<span class="2449093599871099166" onmouseenter="enter('2449093599871099166');" onmouseout="out('2449093599871099166');" style=""> 194      * 查看consumer当前状态                                                                                    </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 195      */                                                                                                  </span>
<span class="-7462222326053316033" onmouseenter="enter('-7462222326053316033');" onmouseout="out('-7462222326053316033');" style=""> 196     public boolean checkConsumer() {                                                                     </span>
<span class="1228564361815955906" onmouseenter="enter('1228564361815955906');" onmouseout="out('1228564361815955906');" style=""> 197         return this.consumer.isRunning();                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 198     }                                                                                                    </span>
<span  style=""> 199                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 200     /**                                                                                                  </span>
<span class="-2486644912947517360" onmouseenter="enter('-2486644912947517360');" onmouseout="out('-2486644912947517360');" style=""> 201      * 首字母大写                                                                                             </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 202      */                                                                                                  </span>
<span class="3506443581067250310" onmouseenter="enter('3506443581067250310');" onmouseout="out('3506443581067250310');" style=""> 203     private static String upperCaseFirstChar(String str) {                                               </span>
<span class="8717998801821522526" onmouseenter="enter('8717998801821522526');" onmouseout="out('8717998801821522526');" style=""> 204         return str.substring(0, 1).toUpperCase() + str.substring(1);                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 205     }                                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 206 }                                                                                                        </span>




























































</pre></td>
                            <td><pre><span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style="">   1 /*                                                                                                       </span>
<span class="3101153502889412828" onmouseenter="enter('3101153502889412828');" onmouseout="out('3101153502889412828');" style="">   2  * Licensed to the Apache Software Foundation (ASF) under one                                            </span>
<span class="-6690800139350779170" onmouseenter="enter('-6690800139350779170');" onmouseout="out('-6690800139350779170');" style="">   3  * or more contributor license agreements.  See the NOTICE file                                          </span>
<span class="4408648408749222780" onmouseenter="enter('4408648408749222780');" onmouseout="out('4408648408749222780');" style="">   4  * distributed with this work for additional information                                                 </span>
<span class="7440871955664702931" onmouseenter="enter('7440871955664702931');" onmouseout="out('7440871955664702931');" style="">   5  * regarding copyright ownership.  The ASF licenses this file                                            </span>
<span class="-7748987699953482767" onmouseenter="enter('-7748987699953482767');" onmouseout="out('-7748987699953482767');" style="">   6  * to you under the Apache License, Version 2.0 (the                                                     </span>
<span class="-7532787339260984706" onmouseenter="enter('-7532787339260984706');" onmouseout="out('-7532787339260984706');" style="">   7  * &quot;License&quot;); you may not use this file except in compliance                                            </span>
<span class="6072654417402056570" onmouseenter="enter('6072654417402056570');" onmouseout="out('6072654417402056570');" style="">   8  * with the License.  You may obtain a copy of the License at                                            </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">   9  *                                                                                                       </span>
<span class="3430964305904514764" onmouseenter="enter('3430964305904514764');" onmouseout="out('3430964305904514764');" style="">  10  * http://www.apache.org/licenses/LICENSE-2.0                                                            </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  11  *                                                                                                       </span>
<span class="2557607632756179983" onmouseenter="enter('2557607632756179983');" onmouseout="out('2557607632756179983');" style="">  12  * Unless required by applicable law or agreed to in writing, software                                   </span>
<span class="-9189129105512731955" onmouseenter="enter('-9189129105512731955');" onmouseout="out('-9189129105512731955');" style="">  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,                                     </span>
<span class="5781161717946418340" onmouseenter="enter('5781161717946418340');" onmouseout="out('5781161717946418340');" style="">  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.                              </span>
<span class="1761562277992059393" onmouseenter="enter('1761562277992059393');" onmouseout="out('1761562277992059393');" style="">  15  * See the License for the specific language governing permissions and                                   </span>
<span class="7217408601297779962" onmouseenter="enter('7217408601297779962');" onmouseout="out('7217408601297779962');" style="">  16  * limitations under the License.                                                                        </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  17  */                                                                                                      </span>
<span class="5491803375468606953" onmouseenter="enter('5491803375468606953');" onmouseout="out('5491803375468606953');" style="">  18 package com.dtstack.flink.sql.dirtyManager.manager;                                                      </span>
<span  style="">  19                                                                                                          </span>
<span class="1128057574573805325" onmouseenter="enter('1128057574573805325');" onmouseout="out('1128057574573805325');" style="">  20 import com.dtstack.flink.sql.classloader.ClassLoaderManager;                                             </span>
<span class="-9209416939158381067" onmouseenter="enter('-9209416939158381067');" onmouseout="out('-9209416939158381067');" style="">  21 import com.dtstack.flink.sql.dirtyManager.consumer.AbstractDirtyDataConsumer;                            </span>
<span class="114557361084888270" onmouseenter="enter('114557361084888270');" onmouseout="out('114557361084888270');" style="">  22 import com.dtstack.flink.sql.dirtyManager.entity.DirtyDataEntity;                                        </span>
<span class="9128825106411316982" onmouseenter="enter('9128825106411316982');" onmouseout="out('9128825106411316982');" style="">  23 import com.dtstack.flink.sql.factory.DTThreadFactory;                                                    </span>
<span class="-3389130316234486348" onmouseenter="enter('-3389130316234486348');" onmouseout="out('-3389130316234486348');" style="">  24 import com.dtstack.flink.sql.util.PluginUtil;                                                            </span>
<span class="-3926401431737521278" onmouseenter="enter('-3926401431737521278');" onmouseout="out('-3926401431737521278');" style="">  25 import java.io.File;                                                                                     </span>
<span class="5998602906817463685" onmouseenter="enter('5998602906817463685');" onmouseout="out('5998602906817463685');" style="">  26 import java.io.Serializable;                                                                             </span>
<span class="2674806488057045420" onmouseenter="enter('2674806488057045420');" onmouseout="out('2674806488057045420');" style="">  27 import java.lang.reflect.Constructor;                                                                    </span>
<span class="6618655971923850695" onmouseenter="enter('6618655971923850695');" onmouseout="out('6618655971923850695');" style="">  28 import java.util.Map;                                                                                    </span>
<span class="-5549638946827519456" onmouseenter="enter('-5549638946827519456');" onmouseout="out('-5549638946827519456');" style="">  29 import java.util.concurrent.ExecutorService;                                                             </span>
<span class="-3492814532060861089" onmouseenter="enter('-3492814532060861089');" onmouseout="out('-3492814532060861089');" style="">  30 import java.util.concurrent.Executors;                                                                   </span>
<span class="-331778695229620376" onmouseenter="enter('-331778695229620376');" onmouseout="out('-331778695229620376');" style="">  31 import java.util.concurrent.Future;                                                                      </span>
<span class="5052275383743182469" onmouseenter="enter('5052275383743182469');" onmouseout="out('5052275383743182469');" style="">  32 import java.util.concurrent.LinkedBlockingQueue;                                                         </span>
<span class="8146438650974953238" onmouseenter="enter('8146438650974953238');" onmouseout="out('8146438650974953238');" style="">  33 import java.util.concurrent.ThreadPoolExecutor;                                                          </span>
<span class="-6356287537734540725" onmouseenter="enter('-6356287537734540725');" onmouseout="out('-6356287537734540725');" style="">  34 import java.util.concurrent.TimeUnit;                                                                    </span>
<span class="475099823122781612" onmouseenter="enter('475099823122781612');" onmouseout="out('475099823122781612');" style="">  35 import java.util.concurrent.atomic.AtomicLong;                                                           </span>
<span class="9072327285961251154" onmouseenter="enter('9072327285961251154');" onmouseout="out('9072327285961251154');" style="">  36 import org.slf4j.Logger;                                                                                 </span>
<span class="697043352225962606" onmouseenter="enter('697043352225962606');" onmouseout="out('697043352225962606');" style="">  37 import org.slf4j.LoggerFactory;                                                                          </span>
<span  style="">  38                                                                                                          </span>
<span  style="">  39                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  40 /**                                                                                                      </span>
<span class="-4100502199450942834" onmouseenter="enter('-4100502199450942834');" onmouseout="out('-4100502199450942834');" style="">  41  * @author tiezhu                                                                                        </span>
<span class="-1158256683614797078" onmouseenter="enter('-1158256683614797078');" onmouseout="out('-1158256683614797078');" style="">  42  * Company dtstack                                                                                       </span>
<span class="-2400154308327571743" onmouseenter="enter('-2400154308327571743');" onmouseout="out('-2400154308327571743');" style="">  43  * Date 2020/8/27 星期四                                                                                    </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  44  */                                                                                                      </span>
<span class="-3812614075256696210" onmouseenter="enter('-3812614075256696210');" onmouseout="out('-3812614075256696210');" style="">  45 public class DirtyDataManager implements Serializable {                                                  </span>
<span class="5999329968759114835" onmouseenter="enter('5999329968759114835');" onmouseout="out('5999329968759114835');" style="">  46     private static final long serialVersionUID = 7190970299538893497L;                                   </span>
<span  style="">  47                                                                                                          </span>
<span class="224310682692221662" onmouseenter="enter('224310682692221662');" onmouseout="out('224310682692221662');" style="">  48     private static final Logger LOG = LoggerFactory.getLogger(DirtyDataManager.class);                   </span>
<span  style="">  49                                                                                                          </span>
<span class="-6228478812450324887" onmouseenter="enter('-6228478812450324887');" onmouseout="out('-6228478812450324887');" style="">  50     private static final String CLASS_PRE_STR = &quot;com.dtstack.flink.sql.dirty&quot;;                           </span>
<span  style="">  51                                                                                                          </span>
<span class="2656302477200666223" onmouseenter="enter('2656302477200666223');" onmouseout="out('2656302477200666223');" style="">  52     private static final String CLASS_POST_STR = &quot;DirtyDataConsumer&quot;;                                    </span>
<span  style="">  53                                                                                                          </span>
<span class="-144862183860853241" onmouseenter="enter('-144862183860853241');" onmouseout="out('-144862183860853241');" style="">  54     private static final String DIRTY_CONSUMER_PATH = &quot;dirtyData&quot;;                                       </span>
<span  style="">  55                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  56     /**                                                                                                  </span>
<span class="2447214252488375907" onmouseenter="enter('2447214252488375907');" onmouseout="out('2447214252488375907');" style="">  57      * 写入队列阻塞时间                                                                                          </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  58      */                                                                                                  </span>
<span class="1288105432018799460" onmouseenter="enter('1288105432018799460');" onmouseout="out('1288105432018799460');" style="">  59     private long blockingInterval;                                                                       </span>
<span  style="">  60                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  61     /**                                                                                                  </span>
<span class="-7026334171379977064" onmouseenter="enter('-7026334171379977064');" onmouseout="out('-7026334171379977064');" style="">  62      * 缓存脏数据信息队列                                                                                         </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  63      */                                                                                                  </span>
<span class="1580837919019423566" onmouseenter="enter('1580837919019423566');" onmouseout="out('1580837919019423566');" style="">  64     public final LinkedBlockingQueue&lt;DirtyDataEntity&gt; queue = new LinkedBlockingQueue&lt;&gt;();               </span>
<span  style="">  65                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  66     /**                                                                                                  </span>
<span class="3233249345333193755" onmouseenter="enter('3233249345333193755');" onmouseout="out('3233249345333193755');" style="">  67      * 统计manager收集到的脏数据条数                                                                                </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  68      */                                                                                                  </span>
<span class="-8874840091978478789" onmouseenter="enter('-8874840091978478789');" onmouseout="out('-8874840091978478789');" style="">  69     private final AtomicLong count = new AtomicLong(0);                                                  </span>
<span  style="">  70                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  71     /**                                                                                                  </span>
<span class="-8804634106042183975" onmouseenter="enter('-8804634106042183975');" onmouseout="out('-8804634106042183975');" style="">  72      * 脏数据写入队列失败条数                                                                                       </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  73      */                                                                                                  </span>
<span class="4228318894546121771" onmouseenter="enter('4228318894546121771');" onmouseout="out('4228318894546121771');" style="">  74     private final AtomicLong errorCount = new AtomicLong(0);                                             </span>
<span  style="">  75                                                                                                          </span>
<span class="6376742731498755928" onmouseenter="enter('6376742731498755928');" onmouseout="out('6376742731498755928');" style="">  76     private double errorLimitRate;                                                                       </span>
<span  style="">  77                                                                                                          </span>
<span class="4017110792483941245" onmouseenter="enter('4017110792483941245');" onmouseout="out('4017110792483941245');" style="">  78     public AbstractDirtyDataConsumer consumer;                                                           </span>
<span  style="">  79                                                                                                          </span>
<span class="8919599632341312398" onmouseenter="enter('8919599632341312398');" onmouseout="out('8919599632341312398');" style="">  80     private final ExecutorService executor = Executors.newSingleThreadExecutor();                        </span>
<span  style="">  81                                                                                                          </span>
<span class="-1864791881058708717" onmouseenter="enter('-1864791881058708717');" onmouseout="out('-1864791881058708717');" style="">  82     private static ThreadPoolExecutor dirtyDataConsumer;                                                 </span>
<span  style="">  83                                                                                                          </span>
<span class="2567714078094157835" onmouseenter="enter('2567714078094157835');" onmouseout="out('2567714078094157835');" style="">  84     public final static int MAX_POOL_SIZE_LIMIT = 5;                                                     </span>
<span  style="">  85                                                                                                          </span>
<span class="-7081887652578957041" onmouseenter="enter('-7081887652578957041');" onmouseout="out('-7081887652578957041');" style="">  86     private final static int MAX_TASK_QUEUE_SIZE = 100;                                                  </span>
<span  style="">  87                                                                                                          </span>
<span class="-785659455048892261" onmouseenter="enter('-785659455048892261');" onmouseout="out('-785659455048892261');" style="">  88     private final static String DEFAULT_TYPE = &quot;console&quot;;                                                </span>
<span  style="">  89                                                                                                          </span>
<span class="-5843097799946498887" onmouseenter="enter('-5843097799946498887');" onmouseout="out('-5843097799946498887');" style="">  90     private final static String DEFAULT_ERROR_LIMIT_RATE = &quot;0.8&quot;;                                        </span>
<span  style="">  91                                                                                                          </span>
<span class="-3406851134206279848" onmouseenter="enter('-3406851134206279848');" onmouseout="out('-3406851134206279848');" style="">  92     private final static String DEFAULT_BLOCKING_INTERVAL = &quot;60&quot;;                                        </span>
<span  style="">  93                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  94     /**                                                                                                  </span>
<span class="-9065255876861284630" onmouseenter="enter('-9065255876861284630');" onmouseout="out('-9065255876861284630');" style="">  95      * 通过参数生成manager实例，并同时将consumer实例化                                                                   </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  96      */                                                                                                  </span>
<span class="8247390322301240087" onmouseenter="enter('8247390322301240087');" onmouseout="out('8247390322301240087');" style="">  97     public static DirtyDataManager newInstance(Map&lt;String, String&gt; properties) throws Exception {        </span>
<span class="-429202415469380285" onmouseenter="enter('-429202415469380285');" onmouseout="out('-429202415469380285');" style="">  98         DirtyDataManager manager = new DirtyDataManager();                                               </span>
<span  style="">  99                                                                                                          </span>
<span class="-6681681893462133916" onmouseenter="enter('-6681681893462133916');" onmouseout="out('-6681681893462133916');" style=""> 100 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT                                                                                             </span>
<span class="-6498901718656355528" onmouseenter="enter('-6498901718656355528');" onmouseout="out('-6498901718656355528');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 101         manager.blockingInterval = Long.parseLong(properties.getOrDefault(&quot;blockingInterval&quot;, &quot;60&quot;));    </span>
<span class="-5593258154225191560" onmouseenter="enter('-5593258154225191560');" onmouseout="out('-5593258154225191560');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 102         manager.consumer = createConsumer(properties);                                                   </span>
<span class="-5717168828156365572" onmouseenter="enter('-5717168828156365572');" onmouseout="out('-5717168828156365572');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 103         manager.consumer.init(properties);                                                               </span>
<span class="4747534887806436185" onmouseenter="enter('4747534887806436185');" onmouseout="out('4747534887806436185');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 104         manager.executor.execute(manager.consumer);                                                      </span>
<span  style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 105                                                                                                          </span>
<span class="7991106586064342212" onmouseenter="enter('7991106586064342212');" onmouseout="out('7991106586064342212');" style=""> 106 ||||||| BASE                                                                                             </span>
<span class="-3639349873877828882" onmouseenter="enter('-3639349873877828882');" onmouseout="out('-3639349873877828882');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 107 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 107 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kw🔵</abbr></span>
<span class="3796057323931724632" onmouseenter="enter('3796057323931724632');" onmouseout="out('3796057323931724632');" style=""> 108 =======                                                                                                  </span>
<span  style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 109                                                                                                          </span>
<span class="1957877795460293246" onmouseenter="enter('1957877795460293246');" onmouseout="out('1957877795460293246');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 110         manager.blockingInterval = Long.parseLong(properties.getOrDefault(&quot;blockingInterval&quot;, DEFAULT_BLOCKING_INTERVAL));"> 110         manager.blockingInterval = Long.parseLong(properties.getOrDefault(&quot;blockingInterval&quot;, DEFAULT_BLO🔵</abbr></span>
<span class="-4708360011963152283" onmouseenter="enter('-4708360011963152283');" onmouseout="out('-4708360011963152283');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 111         manager.errorLimitRate = Double.parseDouble(properties.getOrDefault(&quot;errorLimitRate&quot;, DEFAULT_ERROR_LIMIT_RATE));"> 111         manager.errorLimitRate = Double.parseDouble(properties.getOrDefault(&quot;errorLimitRate&quot;, DEFAULT_ERR🔵</abbr></span>
<span class="1492431014173351963" onmouseenter="enter('1492431014173351963');" onmouseout="out('1492431014173351963');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 112         consumer = createConsumer(properties);                                                           </span>
<span class="-1976763955085357310" onmouseenter="enter('-1976763955085357310');" onmouseout="out('-1976763955085357310');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 113         consumer.init(properties);                                                                       </span>
<span class="-8797406258356249433" onmouseenter="enter('-8797406258356249433');" onmouseout="out('-8797406258356249433');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 114         consumer.setQueue(manager.queue);                                                                </span>
<span class="-1281301123089696578" onmouseenter="enter('-1281301123089696578');" onmouseout="out('-1281301123089696578');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 115         dirtyDataConsumer = new ThreadPoolExecutor(MAX_POOL_SIZE_LIMIT, MAX_POOL_SIZE_LIMIT, 0, TimeUnit.MILLISECONDS,"> 115         dirtyDataConsumer = new ThreadPoolExecutor(MAX_POOL_SIZE_LIMIT, MAX_POOL_SIZE_LIMIT, 0, TimeUnit.🔵</abbr></span>
<span class="-2176419747084942513" onmouseenter="enter('-2176419747084942513');" onmouseout="out('-2176419747084942513');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 116                 new LinkedBlockingQueue&lt;&gt;(MAX_TASK_QUEUE_SIZE), new DTThreadFactory(&quot;dirtyDataConsumer&quot;), new ThreadPoolExecutor.CallerRunsPolicy());"> 116                 new LinkedBlockingQueue&lt;&gt;(MAX_TASK_QUEUE_SIZE), new DTThreadFactory(&quot;dirtyDataConsumer&quot;),🔵</abbr></span>
<span class="5908978019406382442" onmouseenter="enter('5908978019406382442');" onmouseout="out('5908978019406382442');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 117         dirtyDataConsumer.execute(consumer);                                                             </span>
<span  style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 118                                                                                                          </span>
<span  style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 119                                                                                                          </span>
<span class="-1814092468913316143" onmouseenter="enter('-1814092468913316143');" onmouseout="out('-1814092468913316143');" style=""> 120 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT                                                                                            </span>
<span class="4517602483633400817" onmouseenter="enter('4517602483633400817');" onmouseout="out('4517602483633400817');" style=""> 121         return manager;                                                                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 122     }                                                                                                    </span>
<span  style=""> 123                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 124     /**                                                                                                  </span>
<span class="2813898973986269376" onmouseenter="enter('2813898973986269376');" onmouseout="out('2813898973986269376');" style=""> 125      * 通过动态加载的方式加载Consumer                                                                               </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 126      */                                                                                                  </span>
<span class="-7283128464228250938" onmouseenter="enter('-7283128464228250938');" onmouseout="out('-7283128464228250938');" style=""><abbr title=" 127     private static AbstractDirtyDataConsumer createConsumer(Map&lt;String, String&gt; properties) throws Exception {"> 127     private static AbstractDirtyDataConsumer createConsumer(Map&lt;String, String&gt; properties) throws Except🔵</abbr></span>
<span class="-4392768324361270875" onmouseenter="enter('-4392768324361270875');" onmouseout="out('-4392768324361270875');" style=""> 128         String type = properties.getOrDefault(&quot;type&quot;, DEFAULT_TYPE);                                     </span>
<span class="-8629452405590542201" onmouseenter="enter('-8629452405590542201');" onmouseout="out('-8629452405590542201');" style=""> 129         String consumerType = (DIRTY_CONSUMER_PATH + File.separator) + type;                             </span>
<span class="2615777252874702183" onmouseenter="enter('2615777252874702183');" onmouseout="out('2615777252874702183');" style=""><abbr title=" 130         String consumerJar = PluginUtil.getJarFileDirPath(consumerType, properties.getOrDefault(&quot;pluginPath&quot;, null), &quot;shipfile&quot;);"> 130         String consumerJar = PluginUtil.getJarFileDirPath(consumerType, properties.getOrDefault(&quot;pluginPa🔵</abbr></span>
<span class="-6845493279002661598" onmouseenter="enter('-6845493279002661598');" onmouseout="out('-6845493279002661598');" style=""><abbr title=" 131         String className = (((CLASS_PRE_STR + &quot;.&quot;) + type.toLowerCase()) + &quot;.&quot;) + upperCaseFirstChar(type + CLASS_POST_STR);"> 131         String className = (((CLASS_PRE_STR + &quot;.&quot;) + type.toLowerCase()) + &quot;.&quot;) + upperCaseFirstChar(type🔵</abbr></span>
<span class="3880700488327116198" onmouseenter="enter('3880700488327116198');" onmouseout="out('3880700488327116198');" style=""> 132         return ClassLoaderManager.newInstance(consumerJar, ( cl) -&gt; {                                    </span>
<span class="-1748502629280141996" onmouseenter="enter('-1748502629280141996');" onmouseout="out('-1748502629280141996');" style=""> 133             Class&lt;?&gt; clazz = cl.loadClass(className);                                                    </span>
<span class="8710049300716534777" onmouseenter="enter('8710049300716534777');" onmouseout="out('8710049300716534777');" style=""> 134             Constructor&lt;?&gt; constructor = clazz.getConstructor();                                         </span>
<span class="6294732520333681525" onmouseenter="enter('6294732520333681525');" onmouseout="out('6294732520333681525');" style=""> 135             return ((AbstractDirtyDataConsumer) (constructor.newInstance()));                            </span>
<span class="7938821646327104961" onmouseenter="enter('7938821646327104961');" onmouseout="out('7938821646327104961');" style=""> 136         });                                                                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 137     }                                                                                                    </span>
<span  style=""> 138                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 139     /**                                                                                                  </span>
<span class="5810358238997397501" onmouseenter="enter('5810358238997397501');" onmouseout="out('5810358238997397501');" style=""> 140      * 脏数据收集任务停止，任务停止之前，需要将队列中所有的数据清空                                                                    </span>
<span class="412054095653206879" onmouseenter="enter('412054095653206879');" onmouseout="out('412054095653206879');" style=""> 141      * TODO consumer 关闭时仍有数据没有消费到，假如有500条数据，在结束时实际消费数量可能只有493                                            </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 142      */                                                                                                  </span>
<span class="8420191109034177215" onmouseenter="enter('8420191109034177215');" onmouseout="out('8420191109034177215');" style=""> 143     public void close()                                                                                  </span>
<span class="-6681681893462133916" onmouseenter="enter('-6681681893462133916');" onmouseout="out('-6681681893462133916');" style=""> 144 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT                                                                                             </span>
<span class="5677081435180812955" onmouseenter="enter('5677081435180812955');" onmouseout="out('5677081435180812955');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 145 {                                                                                                        </span>
<span class="5792664235883029029" onmouseenter="enter('5792664235883029029');" onmouseout="out('5792664235883029029');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 146         if (!queue.isEmpty() &amp;&amp; checkConsumer()) {                                                       </span>
<span class="6269622546247724580" onmouseenter="enter('6269622546247724580');" onmouseout="out('6269622546247724580');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 147             executor.shutdown();                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 148         }                                                                                                </span>
<span class="3359122776167641383" onmouseenter="enter('3359122776167641383');" onmouseout="out('3359122776167641383');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 149         LOG.info(&quot;dirty consumer is closing ...&quot;);                                                       </span>
<span class="4585814285115663204" onmouseenter="enter('4585814285115663204');" onmouseout="out('4585814285115663204');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 150         this.consumer.isRunning.compareAndSet(true, false);                                              </span>
<span class="-4665420521193854593" onmouseenter="enter('-4665420521193854593');" onmouseout="out('-4665420521193854593');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 151         executor.shutdownNow();                                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 152     }                                                                                                    </span>
<span class="7991106586064342212" onmouseenter="enter('7991106586064342212');" onmouseout="out('7991106586064342212');" style=""> 153 ||||||| BASE                                                                                             </span>
<span class="-3639349873877828882" onmouseenter="enter('-3639349873877828882');" onmouseout="out('-3639349873877828882');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 154 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 154 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kw🔵</abbr></span>
<span class="3796057323931724632" onmouseenter="enter('3796057323931724632');" onmouseout="out('3796057323931724632');" style=""> 155 =======                                                                                                  </span>
<span  style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 156                                                                                                          </span>
<span class="5677081435180812955" onmouseenter="enter('5677081435180812955');" onmouseout="out('5677081435180812955');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 157 {                                                                                                        </span>
<span class="1832344628397617014" onmouseenter="enter('1832344628397617014');" onmouseout="out('1832344628397617014');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 158         if (checkConsumer()) {                                                                           </span>
<span class="3359122776167641383" onmouseenter="enter('3359122776167641383');" onmouseout="out('3359122776167641383');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 159             LOG.info(&quot;dirty consumer is closing ...&quot;);                                                   </span>
<span class="7934375192701066001" onmouseenter="enter('7934375192701066001');" onmouseout="out('7934375192701066001');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 160             consumer.close();                                                                            </span>
<span class="-8608443351473140036" onmouseenter="enter('-8608443351473140036');" onmouseout="out('-8608443351473140036');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 161             dirtyDataConsumer.shutdownNow();                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 162         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 163     }                                                                                                    </span>
<span class="-1814092468913316143" onmouseenter="enter('-1814092468913316143');" onmouseout="out('-1814092468913316143');" style=""> 164 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT                                                                                            </span>
<span  style=""> 165                                                                                                          </span>
<span  style=""> 166                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 167     /**                                                                                                  </span>
<span class="194178201576134348" onmouseenter="enter('194178201576134348');" onmouseout="out('194178201576134348');" style=""> 168      * 收集脏数据放入队列缓存中，记录放入失败的数目和存入队列中的总数目，如果放入失败的数目超过一定比例，那么manager任务失败                                    </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 169      */                                                                                                  </span>
<span class="-6344828763611310298" onmouseenter="enter('-6344828763611310298');" onmouseout="out('-6344828763611310298');" style=""> 170     public void collectDirtyData(String dataInfo, String cause, String field) {                          </span>
<span class="3152158306793742973" onmouseenter="enter('3152158306793742973');" onmouseout="out('3152158306793742973');" style=""><abbr title=" 171         DirtyDataEntity dirtyDataEntity = new DirtyDataEntity(dataInfo, System.currentTimeMillis(), cause, field);"> 171         DirtyDataEntity dirtyDataEntity = new DirtyDataEntity(dataInfo, System.currentTimeMillis(), cause🔵</abbr></span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 172         try {                                                                                            </span>
<span class="5568638511517650665" onmouseenter="enter('5568638511517650665');" onmouseout="out('5568638511517650665');" style=""> 173             queue.offer(dirtyDataEntity, blockingInterval, TimeUnit.MILLISECONDS);                       </span>
<span class="-4277231538887053652" onmouseenter="enter('-4277231538887053652');" onmouseout="out('-4277231538887053652');" style=""> 174             count.incrementAndGet();                                                                     </span>
<span class="2168304593065879823" onmouseenter="enter('2168304593065879823');" onmouseout="out('2168304593065879823');" style=""> 175         } catch (java.lang.Exception ignored) {                                                          </span>
<span class="8412332427617783613" onmouseenter="enter('8412332427617783613');" onmouseout="out('8412332427617783613');" style=""> 176             LOG.warn(&quot;dirty Data insert error ... Failed number: &quot; + errorCount.incrementAndGet());      </span>
<span class="-2112956431206001507" onmouseenter="enter('-2112956431206001507');" onmouseout="out('-2112956431206001507');" style=""> 177             LOG.warn(&quot;error dirty data:&quot; + dirtyDataEntity.toString());                                  </span>
<span class="-1442578212705282557" onmouseenter="enter('-1442578212705282557');" onmouseout="out('-1442578212705282557');" style=""> 178             if (errorCount.get() &gt; Math.ceil(count.longValue() * errorLimitRate)) {                      </span>
<span class="6502407236027236896" onmouseenter="enter('6502407236027236896');" onmouseout="out('6502407236027236896');" style=""><abbr title=" 179                 throw new RuntimeException(&quot;The number of failed number reaches the limit, manager fails&quot;);"> 179                 throw new RuntimeException(&quot;The number of failed number reaches the limit, manager fails&quot;🔵</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 180             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 181         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 182     }                                                                                                    </span>
<span  style=""> 183                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 184     /**                                                                                                  </span>
<span class="2449093599871099166" onmouseenter="enter('2449093599871099166');" onmouseout="out('2449093599871099166');" style=""> 185      * 查看consumer当前状态                                                                                    </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 186      */                                                                                                  </span>
<span class="-7462222326053316033" onmouseenter="enter('-7462222326053316033');" onmouseout="out('-7462222326053316033');" style=""> 187     public boolean checkConsumer() {                                                                     </span>
<span class="1228564361815955906" onmouseenter="enter('1228564361815955906');" onmouseout="out('1228564361815955906');" style=""> 188         return this.consumer.isRunning();                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 189     }                                                                                                    </span>
<span  style=""> 190                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 191     /**                                                                                                  </span>
<span class="-2486644912947517360" onmouseenter="enter('-2486644912947517360');" onmouseout="out('-2486644912947517360');" style=""> 192      * 首字母大写                                                                                             </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 193      */                                                                                                  </span>
<span class="3506443581067250310" onmouseenter="enter('3506443581067250310');" onmouseout="out('3506443581067250310');" style=""> 194     private static String upperCaseFirstChar(String str) {                                               </span>
<span class="8717998801821522526" onmouseenter="enter('8717998801821522526');" onmouseout="out('8717998801821522526');" style=""> 195         return str.substring(0, 1).toUpperCase() + str.substring(1);                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 196     }                                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 197 }                                                                                                        </span>





































































</pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre><span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style="">   1  /*                                                                                                                </span>
<span class="3101153502889412828" onmouseenter="enter('3101153502889412828');" onmouseout="out('3101153502889412828');" style="">   2   * Licensed to the Apache Software Foundation (ASF) under one                                                     </span>
<span class="-6690800139350779170" onmouseenter="enter('-6690800139350779170');" onmouseout="out('-6690800139350779170');" style="">   3   * or more contributor license agreements.  See the NOTICE file                                                   </span>
<span class="4408648408749222780" onmouseenter="enter('4408648408749222780');" onmouseout="out('4408648408749222780');" style="">   4   * distributed with this work for additional information                                                          </span>
<span class="7440871955664702931" onmouseenter="enter('7440871955664702931');" onmouseout="out('7440871955664702931');" style="">   5   * regarding copyright ownership.  The ASF licenses this file                                                     </span>
<span class="-7748987699953482767" onmouseenter="enter('-7748987699953482767');" onmouseout="out('-7748987699953482767');" style="">   6   * to you under the Apache License, Version 2.0 (the                                                              </span>
<span class="-7532787339260984706" onmouseenter="enter('-7532787339260984706');" onmouseout="out('-7532787339260984706');" style="">   7   * &quot;License&quot;); you may not use this file except in compliance                                                     </span>
<span class="6072654417402056570" onmouseenter="enter('6072654417402056570');" onmouseout="out('6072654417402056570');" style="">   8   * with the License.  You may obtain a copy of the License at                                                     </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">   9   *                                                                                                                </span>
<span class="3430964305904514764" onmouseenter="enter('3430964305904514764');" onmouseout="out('3430964305904514764');" style="">  10   * http://www.apache.org/licenses/LICENSE-2.0                                                                     </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  11   *                                                                                                                </span>
<span class="2557607632756179983" onmouseenter="enter('2557607632756179983');" onmouseout="out('2557607632756179983');" style="">  12   * Unless required by applicable law or agreed to in writing, software                                            </span>
<span class="-9189129105512731955" onmouseenter="enter('-9189129105512731955');" onmouseout="out('-9189129105512731955');" style="">  13   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,                                              </span>
<span class="5781161717946418340" onmouseenter="enter('5781161717946418340');" onmouseout="out('5781161717946418340');" style="">  14   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.                                       </span>
<span class="1761562277992059393" onmouseenter="enter('1761562277992059393');" onmouseout="out('1761562277992059393');" style="">  15   * See the License for the specific language governing permissions and                                            </span>
<span class="7217408601297779962" onmouseenter="enter('7217408601297779962');" onmouseout="out('7217408601297779962');" style="">  16   * limitations under the License.                                                                                 </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  17   */                                                                                                               </span>
<span  style="">  18                                                                                                                    </span>
<span class="5491803375468606953" onmouseenter="enter('5491803375468606953');" onmouseout="out('5491803375468606953');" style="">  19  package com.dtstack.flink.sql.dirtyManager.manager;                                                               </span>
<span  style="">  20                                                                                                                    </span>
<span class="1128057574573805325" onmouseenter="enter('1128057574573805325');" onmouseout="out('1128057574573805325');" style="">  21  import com.dtstack.flink.sql.classloader.ClassLoaderManager;                                                      </span>
<span class="-9209416939158381067" onmouseenter="enter('-9209416939158381067');" onmouseout="out('-9209416939158381067');" style="">  22  import com.dtstack.flink.sql.dirtyManager.consumer.AbstractDirtyDataConsumer;                                     </span>
<span class="114557361084888270" onmouseenter="enter('114557361084888270');" onmouseout="out('114557361084888270');" style="">  23  import com.dtstack.flink.sql.dirtyManager.entity.DirtyDataEntity;                                                 </span>

<span class="-3389130316234486348" onmouseenter="enter('-3389130316234486348');" onmouseout="out('-3389130316234486348');" style="">  24  import com.dtstack.flink.sql.util.PluginUtil;                                                                     </span>
<span class="9072327285961251154" onmouseenter="enter('9072327285961251154');" onmouseout="out('9072327285961251154');" style="">  25  import org.slf4j.Logger;                                                                                          </span>
<span class="697043352225962606" onmouseenter="enter('697043352225962606');" onmouseout="out('697043352225962606');" style="">  26  import org.slf4j.LoggerFactory;                                                                                   </span>
<span  style="">  27                                                                                                                    </span>
<span class="-3926401431737521278" onmouseenter="enter('-3926401431737521278');" onmouseout="out('-3926401431737521278');" style="">  28  import java.io.File;                                                                                              </span>
<span class="5998602906817463685" onmouseenter="enter('5998602906817463685');" onmouseout="out('5998602906817463685');" style="">  29  import java.io.Serializable;                                                                                      </span>
<span class="2674806488057045420" onmouseenter="enter('2674806488057045420');" onmouseout="out('2674806488057045420');" style="">  30  import java.lang.reflect.Constructor;                                                                             </span>
<span class="6618655971923850695" onmouseenter="enter('6618655971923850695');" onmouseout="out('6618655971923850695');" style="">  31  import java.util.Map;                                                                                             </span>
<span class="-5549638946827519456" onmouseenter="enter('-5549638946827519456');" onmouseout="out('-5549638946827519456');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  32 +import java.util.concurrent.ExecutorService;                                                                      </span>
<span class="-3492814532060861089" onmouseenter="enter('-3492814532060861089');" onmouseout="out('-3492814532060861089');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  33 +import java.util.concurrent.Executors;                                                                            </span>
<span class="-331778695229620376" onmouseenter="enter('-331778695229620376');" onmouseout="out('-331778695229620376');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  34 +import java.util.concurrent.Future;                                                                               </span>
<span class="5052275383743182469" onmouseenter="enter('5052275383743182469');" onmouseout="out('5052275383743182469');" style="">  35  import java.util.concurrent.LinkedBlockingQueue;                                                                  </span>

<span class="-6356287537734540725" onmouseenter="enter('-6356287537734540725');" onmouseout="out('-6356287537734540725');" style="">  36  import java.util.concurrent.TimeUnit;                                                                             </span>
<span class="475099823122781612" onmouseenter="enter('475099823122781612');" onmouseout="out('475099823122781612');" style="">  37  import java.util.concurrent.atomic.AtomicLong;                                                                    </span>
<span  style="">  38                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  39  /**                                                                                                               </span>
<span class="-4100502199450942834" onmouseenter="enter('-4100502199450942834');" onmouseout="out('-4100502199450942834');" style="">  40   * @author tiezhu                                                                                                 </span>
<span class="-1158256683614797078" onmouseenter="enter('-1158256683614797078');" onmouseout="out('-1158256683614797078');" style="">  41   * Company dtstack                                                                                                </span>
<span class="-2400154308327571743" onmouseenter="enter('-2400154308327571743');" onmouseout="out('-2400154308327571743');" style="">  42   * Date 2020/8/27 星期四                                                                                             </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  43   */                                                                                                               </span>
<span class="-3812614075256696210" onmouseenter="enter('-3812614075256696210');" onmouseout="out('-3812614075256696210');" style="">  44  public class DirtyDataManager implements Serializable {                                                           </span>
<span class="-5703917321142291079" onmouseenter="enter('-5703917321142291079');" onmouseout="out('-5703917321142291079');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  45 -    //TODO 需要确保产生脏数据后至少一次是成功发送给了consumer，至于consumer是否成功消费，manager不需要关心                                            </span>

<span class="5999329968759114835" onmouseenter="enter('5999329968759114835');" onmouseout="out('5999329968759114835');" style="">  46      private static final long serialVersionUID = 7190970299538893497L;                                            </span>
<span  style="">  47                                                                                                                    </span>
<span class="224310682692221662" onmouseenter="enter('224310682692221662');" onmouseout="out('224310682692221662');" style="">  48      private static final Logger LOG = LoggerFactory.getLogger(DirtyDataManager.class);                            </span>
<span  style="">  49                                                                                                                    </span>
<span class="-6228478812450324887" onmouseenter="enter('-6228478812450324887');" onmouseout="out('-6228478812450324887');" style="">  50      private static final String CLASS_PRE_STR = &quot;com.dtstack.flink.sql.dirty&quot;;                                    </span>
<span  style="">  51                                                                                                                    </span>
<span class="2656302477200666223" onmouseenter="enter('2656302477200666223');" onmouseout="out('2656302477200666223');" style="">  52      private static final String CLASS_POST_STR = &quot;DirtyDataConsumer&quot;;                                             </span>
<span  style="">  53                                                                                                                    </span>
<span class="-144862183860853241" onmouseenter="enter('-144862183860853241');" onmouseout="out('-144862183860853241');" style="">  54      private static final String DIRTY_CONSUMER_PATH = &quot;dirtyData&quot;;                                                </span>
<span  style="">  55                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  56      /**                                                                                                           </span>
<span class="2447214252488375907" onmouseenter="enter('2447214252488375907');" onmouseout="out('2447214252488375907');" style="">  57       * 写入队列阻塞时间                                                                                                   </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  58       */                                                                                                           </span>
<span class="4915644032396965105" onmouseenter="enter('4915644032396965105');" onmouseout="out('4915644032396965105');" style="">  59      private long blockingInterval = 60;                                                                           </span>

<span  style="">  60                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  61      /**                                                                                                           </span>
<span class="-7026334171379977064" onmouseenter="enter('-7026334171379977064');" onmouseout="out('-7026334171379977064');" style="">  62       * 缓存脏数据信息队列                                                                                                  </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  63       */                                                                                                           </span>
<span class="1580837919019423566" onmouseenter="enter('1580837919019423566');" onmouseout="out('1580837919019423566');" style="">  64      public final LinkedBlockingQueue&lt;DirtyDataEntity&gt; queue = new LinkedBlockingQueue&lt;&gt;();                        </span>
<span  style="">  65                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  66      /**                                                                                                           </span>
<span class="3233249345333193755" onmouseenter="enter('3233249345333193755');" onmouseout="out('3233249345333193755');" style="">  67       * 统计manager收集到的脏数据条数                                                                                         </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  68       */                                                                                                           </span>
<span class="-8874840091978478789" onmouseenter="enter('-8874840091978478789');" onmouseout="out('-8874840091978478789');" style="">  69      private final AtomicLong count = new AtomicLong(0);                                                           </span>
<span  style="">  70                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  71      /**                                                                                                           </span>
<span class="-8804634106042183975" onmouseenter="enter('-8804634106042183975');" onmouseout="out('-8804634106042183975');" style="">  72       * 脏数据写入队列失败条数                                                                                                </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  73       */                                                                                                           </span>
<span class="4228318894546121771" onmouseenter="enter('4228318894546121771');" onmouseout="out('4228318894546121771');" style="">  74      private final AtomicLong errorCount = new AtomicLong(0);                                                      </span>
<span  style="">  75                                                                                                                    </span>


<span class="-2805031698975647131" onmouseenter="enter('-2805031698975647131');" onmouseout="out('-2805031698975647131');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  76 -    public static AbstractDirtyDataConsumer consumer;                                                             </span>
<span class="4017110792483941245" onmouseenter="enter('4017110792483941245');" onmouseout="out('4017110792483941245');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  77 +    public AbstractDirtyDataConsumer consumer;                                                                    </span>
<span  style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  78 +                                                                                                                  </span>
<span class="8919599632341312398" onmouseenter="enter('8919599632341312398');" onmouseout="out('8919599632341312398');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  79 +    private final ExecutorService executor = Executors.newSingleThreadExecutor();                                 </span>









<span  style="">  80                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  81      /**                                                                                                           </span>
<span class="-9065255876861284630" onmouseenter="enter('-9065255876861284630');" onmouseout="out('-9065255876861284630');" style="">  82       * 通过参数生成manager实例，并同时将consumer实例化                                                                            </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  83       */                                                                                                           </span>
<span class="8247390322301240087" onmouseenter="enter('8247390322301240087');" onmouseout="out('8247390322301240087');" style="">  84      public static DirtyDataManager newInstance(Map&lt;String, String&gt; properties) throws Exception {                 </span>
<span class="-429202415469380285" onmouseenter="enter('-429202415469380285');" onmouseout="out('-429202415469380285');" style="">  85          DirtyDataManager manager = new DirtyDataManager();                                                        </span>
<span class="-6498901718656355528" onmouseenter="enter('-6498901718656355528');" onmouseout="out('-6498901718656355528');" style="">  86          manager.blockingInterval = Long.parseLong(properties.getOrDefault(&quot;blockingInterval&quot;, &quot;60&quot;));             </span>


<span class="1492431014173351963" onmouseenter="enter('1492431014173351963');" onmouseout="out('1492431014173351963');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  87 -        consumer = createConsumer(properties);                                                                    </span>
<span class="-1976763955085357310" onmouseenter="enter('-1976763955085357310');" onmouseout="out('-1976763955085357310');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  88 -        consumer.init(properties);                                                                                </span>
<span class="-8035703022814018113" onmouseenter="enter('-8035703022814018113');" onmouseout="out('-8035703022814018113');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  89 -        //TODO 使用线程池创建线程，不要用thread                                                                                </span>
<span class="8740236974697237335" onmouseenter="enter('8740236974697237335');" onmouseout="out('8740236974697237335');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  90 -        Thread dirtyDataConsumer = new Thread(consumer.setQueue(manager.queue), &quot;dirtyData Consumer&quot;);            </span>
<span class="2707431131308680140" onmouseenter="enter('2707431131308680140');" onmouseout="out('2707431131308680140');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  91 -        dirtyDataConsumer.start();                                                                                </span>
<span class="-5593258154225191560" onmouseenter="enter('-5593258154225191560');" onmouseout="out('-5593258154225191560');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  92 +        manager.consumer = createConsumer(properties);                                                            </span>
<span class="-5717168828156365572" onmouseenter="enter('-5717168828156365572');" onmouseout="out('-5717168828156365572');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  93 +        manager.consumer.init(properties);                                                                        </span>
<span class="4747534887806436185" onmouseenter="enter('4747534887806436185');" onmouseout="out('4747534887806436185');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  94 +        manager.executor.execute(manager.consumer);                                                               </span>


<span class="4517602483633400817" onmouseenter="enter('4517602483633400817');" onmouseout="out('4517602483633400817');" style="">  95          return manager;                                                                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  96      }                                                                                                             </span>
<span  style="">  97                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  98      /**                                                                                                           </span>
<span class="2813898973986269376" onmouseenter="enter('2813898973986269376');" onmouseout="out('2813898973986269376');" style="">  99       * 通过动态加载的方式加载Consumer                                                                                        </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 100       */                                                                                                           </span>
<span class="-7283128464228250938" onmouseenter="enter('-7283128464228250938');" onmouseout="out('-7283128464228250938');" style=""> 101      private static AbstractDirtyDataConsumer createConsumer(Map&lt;String, String&gt; properties) throws Exception {    </span>
<span class="-4914662716305676428" onmouseenter="enter('-4914662716305676428');" onmouseout="out('-4914662716305676428');" style=""> 102          String type = properties.getOrDefault(&quot;type&quot;, &quot;print&quot;);                                                   </span>

<span class="483617201224409134" onmouseenter="enter('483617201224409134');" onmouseout="out('483617201224409134');" style=""> 103          String consumerType = DIRTY_CONSUMER_PATH + File.separator + type;                                        </span>
<span class="2615777252874702183" onmouseenter="enter('2615777252874702183');" onmouseout="out('2615777252874702183');" style=""><abbr title=" 104          String consumerJar = PluginUtil.getJarFileDirPath(consumerType, properties.getOrDefault(&quot;pluginPath&quot;, null), &quot;shipfile&quot;);"> 104          String consumerJar = PluginUtil.getJarFileDirPath(consumerType, properties.getOrDefault(&quot;pluginPath&quot;, null🔵</abbr></span>
<span class="-5190243946208745922" onmouseenter="enter('-5190243946208745922');" onmouseout="out('-5190243946208745922');" style=""><abbr title=" 105          String className = CLASS_PRE_STR + &quot;.&quot; + type.toLowerCase() + &quot;.&quot; + upperCaseFirstChar(type + CLASS_POST_STR);"> 105          String className = CLASS_PRE_STR + &quot;.&quot; + type.toLowerCase() + &quot;.&quot; + upperCaseFirstChar(type + CLASS_POST_S🔵</abbr></span>
<span  style=""> 106                                                                                                                    </span>
<span class="-4007269595747684077" onmouseenter="enter('-4007269595747684077');" onmouseout="out('-4007269595747684077');" style=""> 107          return ClassLoaderManager.newInstance(consumerJar, cl -&gt; {                                                </span>
<span class="-1748502629280141996" onmouseenter="enter('-1748502629280141996');" onmouseout="out('-1748502629280141996');" style=""> 108              Class&lt;?&gt; clazz = cl.loadClass(className);                                                             </span>
<span class="8710049300716534777" onmouseenter="enter('8710049300716534777');" onmouseout="out('8710049300716534777');" style=""> 109              Constructor&lt;?&gt; constructor = clazz.getConstructor();                                                  </span>
<span class="2831262314561398727" onmouseenter="enter('2831262314561398727');" onmouseout="out('2831262314561398727');" style=""> 110              return (AbstractDirtyDataConsumer) constructor.newInstance();                                         </span>
<span class="7938821646327104961" onmouseenter="enter('7938821646327104961');" onmouseout="out('7938821646327104961');" style=""> 111          });                                                                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 112      }                                                                                                             </span>
<span  style=""> 113                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 114      /**                                                                                                           </span>
<span class="5810358238997397501" onmouseenter="enter('5810358238997397501');" onmouseout="out('5810358238997397501');" style=""> 115       * 脏数据收集任务停止，任务停止之前，需要将队列中所有的数据清空                                                                             </span>

<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 116       */                                                                                                           </span>
<span class="3412323497574912500" onmouseenter="enter('3412323497574912500');" onmouseout="out('3412323497574912500');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 117 -    public void close() throws Exception {                                                                        </span>
<span class="-8990893524708255660" onmouseenter="enter('-8990893524708255660');" onmouseout="out('-8990893524708255660');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 118 +    public void close() {                                                                                         </span>
<span class="5792664235883029029" onmouseenter="enter('5792664235883029029');" onmouseout="out('5792664235883029029');" style=""> 119          if (!queue.isEmpty() &amp;&amp; checkConsumer()) {                                                                </span>
<span class="-5377898926401715887" onmouseenter="enter('-5377898926401715887');" onmouseout="out('-5377898926401715887');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 120 -            consumer.consume();                                                                                   </span>
<span class="6269622546247724580" onmouseenter="enter('6269622546247724580');" onmouseout="out('6269622546247724580');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 121 +            executor.shutdown();                                                                                  </span>




<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 122          }                                                                                                         </span>
<span class="3359122776167641383" onmouseenter="enter('3359122776167641383');" onmouseout="out('3359122776167641383');" style=""> 123          LOG.info(&quot;dirty consumer is closing ...&quot;);                                                                </span>
<span class="7934375192701066001" onmouseenter="enter('7934375192701066001');" onmouseout="out('7934375192701066001');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 124 -        consumer.close();                                                                                         </span>
<span class="4585814285115663204" onmouseenter="enter('4585814285115663204');" onmouseout="out('4585814285115663204');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 125 +        this.consumer.isRunning.compareAndSet(true, false);                                                       </span>
<span class="-4665420521193854593" onmouseenter="enter('-4665420521193854593');" onmouseout="out('-4665420521193854593');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 126 +        executor.shutdownNow();                                                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 127      }                                                                                                             </span>
<span  style=""> 128                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 129      /**                                                                                                           </span>
<span class="4819634322432885190" onmouseenter="enter('4819634322432885190');" onmouseout="out('4819634322432885190');" style=""> 130       * 收集脏数据放入队列缓存中，记录放入失败的数目和存入队列中的总数目，如果放入失败的数目超过一定比列，那么manager任务失败                                             </span>

<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 131       */                                                                                                           </span>
<span class="-6344828763611310298" onmouseenter="enter('-6344828763611310298');" onmouseout="out('-6344828763611310298');" style=""> 132      public void collectDirtyData(String dataInfo, String cause, String field) {                                   </span>
<span class="3152158306793742973" onmouseenter="enter('3152158306793742973');" onmouseout="out('3152158306793742973');" style=""> 133          DirtyDataEntity dirtyDataEntity = new DirtyDataEntity(dataInfo, System.currentTimeMillis(), cause, field);</span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 134          try {                                                                                                     </span>
<span class="5568638511517650665" onmouseenter="enter('5568638511517650665');" onmouseout="out('5568638511517650665');" style=""> 135              queue.offer(dirtyDataEntity, blockingInterval, TimeUnit.MILLISECONDS);                                </span>
<span class="-4277231538887053652" onmouseenter="enter('-4277231538887053652');" onmouseout="out('-4277231538887053652');" style=""> 136              count.incrementAndGet();                                                                              </span>
<span class="8538742657781196138" onmouseenter="enter('8538742657781196138');" onmouseout="out('8538742657781196138');" style=""> 137          } catch (Exception ignored) {                                                                             </span>
<span class="8412332427617783613" onmouseenter="enter('8412332427617783613');" onmouseout="out('8412332427617783613');" style=""> 138              LOG.warn(&quot;dirty Data insert error ... Failed number: &quot; + errorCount.incrementAndGet());               </span>
<span class="-2112956431206001507" onmouseenter="enter('-2112956431206001507');" onmouseout="out('-2112956431206001507');" style=""> 139              LOG.warn(&quot;error dirty data:&quot; + dirtyDataEntity.toString());                                           </span>
<span class="-6672890298032813997" onmouseenter="enter('-6672890298032813997');" onmouseout="out('-6672890298032813997');" style=""> 140              if (errorCount.get() &gt; Math.ceil(count.longValue() * 0.8)) {                                          </span>

<span class="6502407236027236896" onmouseenter="enter('6502407236027236896');" onmouseout="out('6502407236027236896');" style=""> 141                  throw new RuntimeException(&quot;The number of failed number reaches the limit, manager fails&quot;);       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 142              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 143          }                                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 144      }                                                                                                             </span>
<span  style=""> 145                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 146      /**                                                                                                           </span>
<span class="2449093599871099166" onmouseenter="enter('2449093599871099166');" onmouseout="out('2449093599871099166');" style=""> 147       * 查看consumer当前状态                                                                                             </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 148       */                                                                                                           </span>
<span class="-7462222326053316033" onmouseenter="enter('-7462222326053316033');" onmouseout="out('-7462222326053316033');" style=""> 149      public boolean checkConsumer() {                                                                              </span>
<span class="-5016120291312955291" onmouseenter="enter('-5016120291312955291');" onmouseout="out('-5016120291312955291');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 150 -        return consumer.isRunning();                                                                              </span>
<span class="1228564361815955906" onmouseenter="enter('1228564361815955906');" onmouseout="out('1228564361815955906');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 151 +        return this.consumer.isRunning();                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 152      }                                                                                                             </span>
<span  style=""> 153                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 154      /**                                                                                                           </span>
<span class="-2486644912947517360" onmouseenter="enter('-2486644912947517360');" onmouseout="out('-2486644912947517360');" style=""> 155       * 首字母大写                                                                                                      </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 156       */                                                                                                           </span>
<span class="3506443581067250310" onmouseenter="enter('3506443581067250310');" onmouseout="out('3506443581067250310');" style=""> 157      private static String upperCaseFirstChar(String str) {                                                        </span>
<span class="8717998801821522526" onmouseenter="enter('8717998801821522526');" onmouseout="out('8717998801821522526');" style=""> 158          return str.substring(0, 1).toUpperCase() + str.substring(1);                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 159      }                                                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 160  }                                                                                                                 </span></pre></td>
                            <td><pre><span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style="">   1  /*                                                                                                                </span>
<span class="3101153502889412828" onmouseenter="enter('3101153502889412828');" onmouseout="out('3101153502889412828');" style="">   2   * Licensed to the Apache Software Foundation (ASF) under one                                                     </span>
<span class="-6690800139350779170" onmouseenter="enter('-6690800139350779170');" onmouseout="out('-6690800139350779170');" style="">   3   * or more contributor license agreements.  See the NOTICE file                                                   </span>
<span class="4408648408749222780" onmouseenter="enter('4408648408749222780');" onmouseout="out('4408648408749222780');" style="">   4   * distributed with this work for additional information                                                          </span>
<span class="7440871955664702931" onmouseenter="enter('7440871955664702931');" onmouseout="out('7440871955664702931');" style="">   5   * regarding copyright ownership.  The ASF licenses this file                                                     </span>
<span class="-7748987699953482767" onmouseenter="enter('-7748987699953482767');" onmouseout="out('-7748987699953482767');" style="">   6   * to you under the Apache License, Version 2.0 (the                                                              </span>
<span class="-7532787339260984706" onmouseenter="enter('-7532787339260984706');" onmouseout="out('-7532787339260984706');" style="">   7   * &quot;License&quot;); you may not use this file except in compliance                                                     </span>
<span class="6072654417402056570" onmouseenter="enter('6072654417402056570');" onmouseout="out('6072654417402056570');" style="">   8   * with the License.  You may obtain a copy of the License at                                                     </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">   9   *                                                                                                                </span>
<span class="3430964305904514764" onmouseenter="enter('3430964305904514764');" onmouseout="out('3430964305904514764');" style="">  10   * http://www.apache.org/licenses/LICENSE-2.0                                                                     </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  11   *                                                                                                                </span>
<span class="2557607632756179983" onmouseenter="enter('2557607632756179983');" onmouseout="out('2557607632756179983');" style="">  12   * Unless required by applicable law or agreed to in writing, software                                            </span>
<span class="-9189129105512731955" onmouseenter="enter('-9189129105512731955');" onmouseout="out('-9189129105512731955');" style="">  13   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,                                              </span>
<span class="5781161717946418340" onmouseenter="enter('5781161717946418340');" onmouseout="out('5781161717946418340');" style="">  14   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.                                       </span>
<span class="1761562277992059393" onmouseenter="enter('1761562277992059393');" onmouseout="out('1761562277992059393');" style="">  15   * See the License for the specific language governing permissions and                                            </span>
<span class="7217408601297779962" onmouseenter="enter('7217408601297779962');" onmouseout="out('7217408601297779962');" style="">  16   * limitations under the License.                                                                                 </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  17   */                                                                                                               </span>
<span  style="">  18                                                                                                                    </span>
<span class="5491803375468606953" onmouseenter="enter('5491803375468606953');" onmouseout="out('5491803375468606953');" style="">  19  package com.dtstack.flink.sql.dirtyManager.manager;                                                               </span>
<span  style="">  20                                                                                                                    </span>
<span class="1128057574573805325" onmouseenter="enter('1128057574573805325');" onmouseout="out('1128057574573805325');" style="">  21  import com.dtstack.flink.sql.classloader.ClassLoaderManager;                                                      </span>
<span class="-9209416939158381067" onmouseenter="enter('-9209416939158381067');" onmouseout="out('-9209416939158381067');" style="">  22  import com.dtstack.flink.sql.dirtyManager.consumer.AbstractDirtyDataConsumer;                                     </span>
<span class="114557361084888270" onmouseenter="enter('114557361084888270');" onmouseout="out('114557361084888270');" style="">  23  import com.dtstack.flink.sql.dirtyManager.entity.DirtyDataEntity;                                                 </span>
<span class="9128825106411316982" onmouseenter="enter('9128825106411316982');" onmouseout="out('9128825106411316982');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  24 +import com.dtstack.flink.sql.factory.DTThreadFactory;                                                             </span>
<span class="-3389130316234486348" onmouseenter="enter('-3389130316234486348');" onmouseout="out('-3389130316234486348');" style="">  25  import com.dtstack.flink.sql.util.PluginUtil;                                                                     </span>
<span class="9072327285961251154" onmouseenter="enter('9072327285961251154');" onmouseout="out('9072327285961251154');" style="">  26  import org.slf4j.Logger;                                                                                          </span>
<span class="697043352225962606" onmouseenter="enter('697043352225962606');" onmouseout="out('697043352225962606');" style="">  27  import org.slf4j.LoggerFactory;                                                                                   </span>
<span  style="">  28                                                                                                                    </span>
<span class="-3926401431737521278" onmouseenter="enter('-3926401431737521278');" onmouseout="out('-3926401431737521278');" style="">  29  import java.io.File;                                                                                              </span>
<span class="5998602906817463685" onmouseenter="enter('5998602906817463685');" onmouseout="out('5998602906817463685');" style="">  30  import java.io.Serializable;                                                                                      </span>
<span class="2674806488057045420" onmouseenter="enter('2674806488057045420');" onmouseout="out('2674806488057045420');" style="">  31  import java.lang.reflect.Constructor;                                                                             </span>
<span class="6618655971923850695" onmouseenter="enter('6618655971923850695');" onmouseout="out('6618655971923850695');" style="">  32  import java.util.Map;                                                                                             </span>



<span class="5052275383743182469" onmouseenter="enter('5052275383743182469');" onmouseout="out('5052275383743182469');" style="">  33  import java.util.concurrent.LinkedBlockingQueue;                                                                  </span>
<span class="8146438650974953238" onmouseenter="enter('8146438650974953238');" onmouseout="out('8146438650974953238');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  34 +import java.util.concurrent.ThreadPoolExecutor;                                                                   </span>
<span class="-6356287537734540725" onmouseenter="enter('-6356287537734540725');" onmouseout="out('-6356287537734540725');" style="">  35  import java.util.concurrent.TimeUnit;                                                                             </span>
<span class="475099823122781612" onmouseenter="enter('475099823122781612');" onmouseout="out('475099823122781612');" style="">  36  import java.util.concurrent.atomic.AtomicLong;                                                                    </span>
<span  style="">  37                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  38  /**                                                                                                               </span>
<span class="-4100502199450942834" onmouseenter="enter('-4100502199450942834');" onmouseout="out('-4100502199450942834');" style="">  39   * @author tiezhu                                                                                                 </span>
<span class="-1158256683614797078" onmouseenter="enter('-1158256683614797078');" onmouseout="out('-1158256683614797078');" style="">  40   * Company dtstack                                                                                                </span>
<span class="-2400154308327571743" onmouseenter="enter('-2400154308327571743');" onmouseout="out('-2400154308327571743');" style="">  41   * Date 2020/8/27 星期四                                                                                             </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  42   */                                                                                                               </span>
<span class="-3812614075256696210" onmouseenter="enter('-3812614075256696210');" onmouseout="out('-3812614075256696210');" style="">  43  public class DirtyDataManager implements Serializable {                                                           </span>
<span class="-5703917321142291079" onmouseenter="enter('-5703917321142291079');" onmouseout="out('-5703917321142291079');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  44 -    //TODO 需要确保产生脏数据后至少一次是成功发送给了consumer，至于consumer是否成功消费，manager不需要关心                                            </span>
<span  style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  45 +                                                                                                                  </span>
<span class="5999329968759114835" onmouseenter="enter('5999329968759114835');" onmouseout="out('5999329968759114835');" style="">  46      private static final long serialVersionUID = 7190970299538893497L;                                            </span>
<span  style="">  47                                                                                                                    </span>
<span class="224310682692221662" onmouseenter="enter('224310682692221662');" onmouseout="out('224310682692221662');" style="">  48      private static final Logger LOG = LoggerFactory.getLogger(DirtyDataManager.class);                            </span>
<span  style="">  49                                                                                                                    </span>
<span class="-6228478812450324887" onmouseenter="enter('-6228478812450324887');" onmouseout="out('-6228478812450324887');" style="">  50      private static final String CLASS_PRE_STR = &quot;com.dtstack.flink.sql.dirty&quot;;                                    </span>
<span  style="">  51                                                                                                                    </span>
<span class="2656302477200666223" onmouseenter="enter('2656302477200666223');" onmouseout="out('2656302477200666223');" style="">  52      private static final String CLASS_POST_STR = &quot;DirtyDataConsumer&quot;;                                             </span>
<span  style="">  53                                                                                                                    </span>
<span class="-144862183860853241" onmouseenter="enter('-144862183860853241');" onmouseout="out('-144862183860853241');" style="">  54      private static final String DIRTY_CONSUMER_PATH = &quot;dirtyData&quot;;                                                </span>
<span  style="">  55                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  56      /**                                                                                                           </span>
<span class="2447214252488375907" onmouseenter="enter('2447214252488375907');" onmouseout="out('2447214252488375907');" style="">  57       * 写入队列阻塞时间                                                                                                   </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  58       */                                                                                                           </span>
<span class="4915644032396965105" onmouseenter="enter('4915644032396965105');" onmouseout="out('4915644032396965105');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  59 -    private long blockingInterval = 60;                                                                           </span>
<span class="1288105432018799460" onmouseenter="enter('1288105432018799460');" onmouseout="out('1288105432018799460');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  60 +    private long blockingInterval;                                                                                </span>
<span  style="">  61                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  62      /**                                                                                                           </span>
<span class="-7026334171379977064" onmouseenter="enter('-7026334171379977064');" onmouseout="out('-7026334171379977064');" style="">  63       * 缓存脏数据信息队列                                                                                                  </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  64       */                                                                                                           </span>
<span class="1580837919019423566" onmouseenter="enter('1580837919019423566');" onmouseout="out('1580837919019423566');" style="">  65      public final LinkedBlockingQueue&lt;DirtyDataEntity&gt; queue = new LinkedBlockingQueue&lt;&gt;();                        </span>
<span  style="">  66                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  67      /**                                                                                                           </span>
<span class="3233249345333193755" onmouseenter="enter('3233249345333193755');" onmouseout="out('3233249345333193755');" style="">  68       * 统计manager收集到的脏数据条数                                                                                         </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  69       */                                                                                                           </span>
<span class="-8874840091978478789" onmouseenter="enter('-8874840091978478789');" onmouseout="out('-8874840091978478789');" style="">  70      private final AtomicLong count = new AtomicLong(0);                                                           </span>
<span  style="">  71                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  72      /**                                                                                                           </span>
<span class="-8804634106042183975" onmouseenter="enter('-8804634106042183975');" onmouseout="out('-8804634106042183975');" style="">  73       * 脏数据写入队列失败条数                                                                                                </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  74       */                                                                                                           </span>
<span class="4228318894546121771" onmouseenter="enter('4228318894546121771');" onmouseout="out('4228318894546121771');" style="">  75      private final AtomicLong errorCount = new AtomicLong(0);                                                      </span>
<span  style="">  76                                                                                                                    </span>
<span class="6376742731498755928" onmouseenter="enter('6376742731498755928');" onmouseout="out('6376742731498755928');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  77 +    private double errorLimitRate;                                                                                </span>
<span  style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  78 +                                                                                                                  </span>
<span class="-2805031698975647131" onmouseenter="enter('-2805031698975647131');" onmouseout="out('-2805031698975647131');" style="">  79      public static AbstractDirtyDataConsumer consumer;                                                             </span>
<span  style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  80 +                                                                                                                  </span>
<span class="-1864791881058708717" onmouseenter="enter('-1864791881058708717');" onmouseout="out('-1864791881058708717');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  81 +    private static ThreadPoolExecutor dirtyDataConsumer;                                                          </span>
<span  style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  82 +                                                                                                                  </span>
<span class="2567714078094157835" onmouseenter="enter('2567714078094157835');" onmouseout="out('2567714078094157835');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  83 +    public final static int MAX_POOL_SIZE_LIMIT = 5;                                                              </span>
<span  style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  84 +                                                                                                                  </span>
<span class="-7081887652578957041" onmouseenter="enter('-7081887652578957041');" onmouseout="out('-7081887652578957041');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  85 +    private final static int MAX_TASK_QUEUE_SIZE = 100;                                                           </span>
<span  style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  86 +                                                                                                                  </span>
<span class="-785659455048892261" onmouseenter="enter('-785659455048892261');" onmouseout="out('-785659455048892261');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  87 +    private final static String DEFAULT_TYPE = &quot;console&quot;;                                                         </span>
<span  style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  88 +                                                                                                                  </span>
<span class="-5843097799946498887" onmouseenter="enter('-5843097799946498887');" onmouseout="out('-5843097799946498887');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  89 +    private final static String DEFAULT_ERROR_LIMIT_RATE = &quot;0.8&quot;;                                                 </span>
<span  style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  90 +                                                                                                                  </span>
<span class="-3406851134206279848" onmouseenter="enter('-3406851134206279848');" onmouseout="out('-3406851134206279848');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  91 +    private final static String DEFAULT_BLOCKING_INTERVAL = &quot;60&quot;;                                                 </span>
<span  style="">  92                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  93      /**                                                                                                           </span>
<span class="-9065255876861284630" onmouseenter="enter('-9065255876861284630');" onmouseout="out('-9065255876861284630');" style="">  94       * 通过参数生成manager实例，并同时将consumer实例化                                                                            </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  95       */                                                                                                           </span>
<span class="8247390322301240087" onmouseenter="enter('8247390322301240087');" onmouseout="out('8247390322301240087');" style="">  96      public static DirtyDataManager newInstance(Map&lt;String, String&gt; properties) throws Exception {                 </span>
<span class="-429202415469380285" onmouseenter="enter('-429202415469380285');" onmouseout="out('-429202415469380285');" style="">  97          DirtyDataManager manager = new DirtyDataManager();                                                        </span>
<span class="-6498901718656355528" onmouseenter="enter('-6498901718656355528');" onmouseout="out('-6498901718656355528');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  98 -        manager.blockingInterval = Long.parseLong(properties.getOrDefault(&quot;blockingInterval&quot;, &quot;60&quot;));             </span>
<span class="1957877795460293246" onmouseenter="enter('1957877795460293246');" onmouseout="out('1957877795460293246');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title="  99 +        manager.blockingInterval = Long.parseLong(properties.getOrDefault(&quot;blockingInterval&quot;, DEFAULT_BLOCKING_INTERVAL));">  99 +        manager.blockingInterval = Long.parseLong(properties.getOrDefault(&quot;blockingInterval&quot;, DEFAULT_BLOCKING_INT🔵</abbr></span>
<span class="-4708360011963152283" onmouseenter="enter('-4708360011963152283');" onmouseout="out('-4708360011963152283');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 100 +        manager.errorLimitRate = Double.parseDouble(properties.getOrDefault(&quot;errorLimitRate&quot;, DEFAULT_ERROR_LIMIT_RATE));"> 100 +        manager.errorLimitRate = Double.parseDouble(properties.getOrDefault(&quot;errorLimitRate&quot;, DEFAULT_ERROR_LIMIT_🔵</abbr></span>
<span class="1492431014173351963" onmouseenter="enter('1492431014173351963');" onmouseout="out('1492431014173351963');" style=""> 101          consumer = createConsumer(properties);                                                                    </span>
<span class="-1976763955085357310" onmouseenter="enter('-1976763955085357310');" onmouseout="out('-1976763955085357310');" style=""> 102          consumer.init(properties);                                                                                </span>
<span class="-8035703022814018113" onmouseenter="enter('-8035703022814018113');" onmouseout="out('-8035703022814018113');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 103 -        //TODO 使用线程池创建线程，不要用thread                                                                                </span>
<span class="8740236974697237335" onmouseenter="enter('8740236974697237335');" onmouseout="out('8740236974697237335');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 104 -        Thread dirtyDataConsumer = new Thread(consumer.setQueue(manager.queue), &quot;dirtyData Consumer&quot;);            </span>
<span class="2707431131308680140" onmouseenter="enter('2707431131308680140');" onmouseout="out('2707431131308680140');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 105 -        dirtyDataConsumer.start();                                                                                </span>
<span class="-8797406258356249433" onmouseenter="enter('-8797406258356249433');" onmouseout="out('-8797406258356249433');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 106 +        consumer.setQueue(manager.queue);                                                                         </span>
<span class="-1281301123089696578" onmouseenter="enter('-1281301123089696578');" onmouseout="out('-1281301123089696578');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 107 +        dirtyDataConsumer = new ThreadPoolExecutor(MAX_POOL_SIZE_LIMIT, MAX_POOL_SIZE_LIMIT, 0, TimeUnit.MILLISECONDS,"> 107 +        dirtyDataConsumer = new ThreadPoolExecutor(MAX_POOL_SIZE_LIMIT, MAX_POOL_SIZE_LIMIT, 0, TimeUnit.MILLISECO🔵</abbr></span>
<span class="-2176419747084942513" onmouseenter="enter('-2176419747084942513');" onmouseout="out('-2176419747084942513');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 108 +                new LinkedBlockingQueue&lt;&gt;(MAX_TASK_QUEUE_SIZE), new DTThreadFactory(&quot;dirtyDataConsumer&quot;), new ThreadPoolExecutor.CallerRunsPolicy());"> 108 +                new LinkedBlockingQueue&lt;&gt;(MAX_TASK_QUEUE_SIZE), new DTThreadFactory(&quot;dirtyDataConsumer&quot;), new Thre🔵</abbr></span>
<span class="5908978019406382442" onmouseenter="enter('5908978019406382442');" onmouseout="out('5908978019406382442');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 109 +        dirtyDataConsumer.execute(consumer);                                                                      </span>
<span  style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 110 +                                                                                                                  </span>
<span class="4517602483633400817" onmouseenter="enter('4517602483633400817');" onmouseout="out('4517602483633400817');" style=""> 111          return manager;                                                                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 112      }                                                                                                             </span>
<span  style=""> 113                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 114      /**                                                                                                           </span>
<span class="2813898973986269376" onmouseenter="enter('2813898973986269376');" onmouseout="out('2813898973986269376');" style=""> 115       * 通过动态加载的方式加载Consumer                                                                                        </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 116       */                                                                                                           </span>
<span class="-7283128464228250938" onmouseenter="enter('-7283128464228250938');" onmouseout="out('-7283128464228250938');" style=""> 117      private static AbstractDirtyDataConsumer createConsumer(Map&lt;String, String&gt; properties) throws Exception {    </span>
<span class="-4914662716305676428" onmouseenter="enter('-4914662716305676428');" onmouseout="out('-4914662716305676428');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 118 -        String type = properties.getOrDefault(&quot;type&quot;, &quot;print&quot;);                                                   </span>
<span class="-4392768324361270875" onmouseenter="enter('-4392768324361270875');" onmouseout="out('-4392768324361270875');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 119 +        String type = properties.getOrDefault(&quot;type&quot;, DEFAULT_TYPE);                                              </span>
<span class="483617201224409134" onmouseenter="enter('483617201224409134');" onmouseout="out('483617201224409134');" style=""> 120          String consumerType = DIRTY_CONSUMER_PATH + File.separator + type;                                        </span>
<span class="2615777252874702183" onmouseenter="enter('2615777252874702183');" onmouseout="out('2615777252874702183');" style=""><abbr title=" 121          String consumerJar = PluginUtil.getJarFileDirPath(consumerType, properties.getOrDefault(&quot;pluginPath&quot;, null), &quot;shipfile&quot;);"> 121          String consumerJar = PluginUtil.getJarFileDirPath(consumerType, properties.getOrDefault(&quot;pluginPath&quot;, null🔵</abbr></span>
<span class="-5190243946208745922" onmouseenter="enter('-5190243946208745922');" onmouseout="out('-5190243946208745922');" style=""><abbr title=" 122          String className = CLASS_PRE_STR + &quot;.&quot; + type.toLowerCase() + &quot;.&quot; + upperCaseFirstChar(type + CLASS_POST_STR);"> 122          String className = CLASS_PRE_STR + &quot;.&quot; + type.toLowerCase() + &quot;.&quot; + upperCaseFirstChar(type + CLASS_POST_S🔵</abbr></span>
<span  style=""> 123                                                                                                                    </span>
<span class="-4007269595747684077" onmouseenter="enter('-4007269595747684077');" onmouseout="out('-4007269595747684077');" style=""> 124          return ClassLoaderManager.newInstance(consumerJar, cl -&gt; {                                                </span>
<span class="-1748502629280141996" onmouseenter="enter('-1748502629280141996');" onmouseout="out('-1748502629280141996');" style=""> 125              Class&lt;?&gt; clazz = cl.loadClass(className);                                                             </span>
<span class="8710049300716534777" onmouseenter="enter('8710049300716534777');" onmouseout="out('8710049300716534777');" style=""> 126              Constructor&lt;?&gt; constructor = clazz.getConstructor();                                                  </span>
<span class="2831262314561398727" onmouseenter="enter('2831262314561398727');" onmouseout="out('2831262314561398727');" style=""> 127              return (AbstractDirtyDataConsumer) constructor.newInstance();                                         </span>
<span class="7938821646327104961" onmouseenter="enter('7938821646327104961');" onmouseout="out('7938821646327104961');" style=""> 128          });                                                                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 129      }                                                                                                             </span>
<span  style=""> 130                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 131      /**                                                                                                           </span>
<span class="5810358238997397501" onmouseenter="enter('5810358238997397501');" onmouseout="out('5810358238997397501');" style=""> 132       * 脏数据收集任务停止，任务停止之前，需要将队列中所有的数据清空                                                                             </span>
<span class="412054095653206879" onmouseenter="enter('412054095653206879');" onmouseout="out('412054095653206879');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 133 +     * TODO consumer 关闭时仍有数据没有消费到，假如有500条数据，在结束时实际消费数量可能只有493                                                     </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 134       */                                                                                                           </span>
<span class="3412323497574912500" onmouseenter="enter('3412323497574912500');" onmouseout="out('3412323497574912500');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 135 -    public void close() throws Exception {                                                                        </span>

<span class="5792664235883029029" onmouseenter="enter('5792664235883029029');" onmouseout="out('5792664235883029029');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 136 -        if (!queue.isEmpty() &amp;&amp; checkConsumer()) {                                                                </span>
<span class="-5377898926401715887" onmouseenter="enter('-5377898926401715887');" onmouseout="out('-5377898926401715887');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 137 -            consumer.consume();                                                                                   </span>
<span class="-8990893524708255660" onmouseenter="enter('-8990893524708255660');" onmouseout="out('-8990893524708255660');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 138 +    public void close() {                                                                                         </span>
<span class="1832344628397617014" onmouseenter="enter('1832344628397617014');" onmouseout="out('1832344628397617014');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 139 +        if (checkConsumer()) {                                                                                    </span>
<span class="3359122776167641383" onmouseenter="enter('3359122776167641383');" onmouseout="out('3359122776167641383');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 140 +            LOG.info(&quot;dirty consumer is closing ...&quot;);                                                            </span>
<span class="7934375192701066001" onmouseenter="enter('7934375192701066001');" onmouseout="out('7934375192701066001');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 141 +            consumer.close();                                                                                     </span>
<span class="-8608443351473140036" onmouseenter="enter('-8608443351473140036');" onmouseout="out('-8608443351473140036');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 142 +            dirtyDataConsumer.shutdownNow();                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 143          }                                                                                                         </span>
<span class="3359122776167641383" onmouseenter="enter('3359122776167641383');" onmouseout="out('3359122776167641383');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 144 -        LOG.info(&quot;dirty consumer is closing ...&quot;);                                                                </span>
<span class="7934375192701066001" onmouseenter="enter('7934375192701066001');" onmouseout="out('7934375192701066001');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 145 -        consumer.close();                                                                                         </span>


<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 146      }                                                                                                             </span>
<span  style=""> 147                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 148      /**                                                                                                           </span>
<span class="4819634322432885190" onmouseenter="enter('4819634322432885190');" onmouseout="out('4819634322432885190');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 149 -     * 收集脏数据放入队列缓存中，记录放入失败的数目和存入队列中的总数目，如果放入失败的数目超过一定比列，那么manager任务失败                                             </span>
<span class="194178201576134348" onmouseenter="enter('194178201576134348');" onmouseout="out('194178201576134348');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 150 +     * 收集脏数据放入队列缓存中，记录放入失败的数目和存入队列中的总数目，如果放入失败的数目超过一定比例，那么manager任务失败                                             </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 151       */                                                                                                           </span>
<span class="-6344828763611310298" onmouseenter="enter('-6344828763611310298');" onmouseout="out('-6344828763611310298');" style=""> 152      public void collectDirtyData(String dataInfo, String cause, String field) {                                   </span>
<span class="3152158306793742973" onmouseenter="enter('3152158306793742973');" onmouseout="out('3152158306793742973');" style=""> 153          DirtyDataEntity dirtyDataEntity = new DirtyDataEntity(dataInfo, System.currentTimeMillis(), cause, field);</span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 154          try {                                                                                                     </span>
<span class="5568638511517650665" onmouseenter="enter('5568638511517650665');" onmouseout="out('5568638511517650665');" style=""> 155              queue.offer(dirtyDataEntity, blockingInterval, TimeUnit.MILLISECONDS);                                </span>
<span class="-4277231538887053652" onmouseenter="enter('-4277231538887053652');" onmouseout="out('-4277231538887053652');" style=""> 156              count.incrementAndGet();                                                                              </span>
<span class="8538742657781196138" onmouseenter="enter('8538742657781196138');" onmouseout="out('8538742657781196138');" style=""> 157          } catch (Exception ignored) {                                                                             </span>
<span class="8412332427617783613" onmouseenter="enter('8412332427617783613');" onmouseout="out('8412332427617783613');" style=""> 158              LOG.warn(&quot;dirty Data insert error ... Failed number: &quot; + errorCount.incrementAndGet());               </span>
<span class="-2112956431206001507" onmouseenter="enter('-2112956431206001507');" onmouseout="out('-2112956431206001507');" style=""> 159              LOG.warn(&quot;error dirty data:&quot; + dirtyDataEntity.toString());                                           </span>
<span class="-6672890298032813997" onmouseenter="enter('-6672890298032813997');" onmouseout="out('-6672890298032813997');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 160 -            if (errorCount.get() &gt; Math.ceil(count.longValue() * 0.8)) {                                          </span>
<span class="-1442578212705282557" onmouseenter="enter('-1442578212705282557');" onmouseout="out('-1442578212705282557');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 161 +            if (errorCount.get() &gt; Math.ceil(count.longValue() * errorLimitRate)) {                               </span>
<span class="6502407236027236896" onmouseenter="enter('6502407236027236896');" onmouseout="out('6502407236027236896');" style=""> 162                  throw new RuntimeException(&quot;The number of failed number reaches the limit, manager fails&quot;);       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 163              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 164          }                                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 165      }                                                                                                             </span>
<span  style=""> 166                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 167      /**                                                                                                           </span>
<span class="2449093599871099166" onmouseenter="enter('2449093599871099166');" onmouseout="out('2449093599871099166');" style=""> 168       * 查看consumer当前状态                                                                                             </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 169       */                                                                                                           </span>
<span class="-7462222326053316033" onmouseenter="enter('-7462222326053316033');" onmouseout="out('-7462222326053316033');" style=""> 170      public boolean checkConsumer() {                                                                              </span>
<span class="-5016120291312955291" onmouseenter="enter('-5016120291312955291');" onmouseout="out('-5016120291312955291');" style=""> 171          return consumer.isRunning();                                                                              </span>

<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 172      }                                                                                                             </span>
<span  style=""> 173                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 174      /**                                                                                                           </span>
<span class="-2486644912947517360" onmouseenter="enter('-2486644912947517360');" onmouseout="out('-2486644912947517360');" style=""> 175       * 首字母大写                                                                                                      </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 176       */                                                                                                           </span>
<span class="3506443581067250310" onmouseenter="enter('3506443581067250310');" onmouseout="out('3506443581067250310');" style=""> 177      private static String upperCaseFirstChar(String str) {                                                        </span>
<span class="8717998801821522526" onmouseenter="enter('8717998801821522526');" onmouseout="out('8717998801821522526');" style=""> 178          return str.substring(0, 1).toUpperCase() + str.substring(1);                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 179      }                                                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 180  }                                                                                                                 </span></pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            