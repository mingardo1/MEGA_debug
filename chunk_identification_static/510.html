<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>510</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    510
                    <a href="509.html">prev</a>
                    <a href="511.html">next</a>
                    <a href="510_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    DTStack/flinkStreamSQL_e83f8c3a3cbab21ecd8ceab223b0f3539be4b5fd_launcher/src/main/java/com/dtstack/flink/sql/launcher/ClusterClientFactory.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;e83f8c3a3cbab21ecd8ceab223b0f3539be4b5fd:launcher/src/main/java/com/dtstack/flink/sql/launcher/ClusterClientFactory.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;e83f8c3a3cbab21ecd8ceab223b0f3539be4b5fd^1:launcher/src/main/java/com/dtstack/flink/sql/launcher/ClusterClientFactory.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;e83f8c3a3cbab21ecd8ceab223b0f3539be4b5fd^2:launcher/src/main/java/com/dtstack/flink/sql/launcher/ClusterClientFactory.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;55715c184d537500eff25ccea853833950100929:launcher/src/main/java/com/dtstack/flink/sql/launcher/ClusterClientFactory.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[b], [bj], [s]], subset: [[b], [sbj]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 /**
   2  * Licensed to the Apache Software Foundation (ASF) under one
   3  * or more contributor license agreements.  See the NOTICE file
   4  * distributed with this work for additional information
   5  * regarding copyright ownership.  The ASF licenses this file
   6  * to you under the Apache License, Version 2.0 (the
   7  * &quot;License&quot;); you may not use this file except in compliance
   8  * with the License.  You may obtain a copy of the License at
   9  * &lt;p&gt;
  10  * http://www.apache.org/licenses/LICENSE-2.0
  11  * &lt;p&gt;
  12  * Unless required by applicable law or agreed to in writing, software
  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15  * See the License for the specific language governing permissions and
  16  * limitations under the License.
  17  */
  18 
  19 package com.dtstack.flink.sql.launcher;
  20 
  21 import com.dtstack.flink.sql.enums.ClusterMode;
  22 import com.dtstack.flink.sql.option.Options;
  23 import com.dtstack.flink.sql.util.PluginUtil;
  24 import org.apache.commons.io.Charsets;
  25 import org.apache.commons.lang.StringUtils;
  26 import org.apache.flink.client.program.ClusterClient;
  27 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  28 import org.apache.flink.client.program.MiniClusterClient;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  29 import org.apache.flink.configuration.ConfigConstants;</span>
  30 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  31 import org.apache.flink.client.program.ClusterClient;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  32 import org.apache.flink.client.program.MiniClusterClient;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  33 import org.apache.flink.configuration.Configuration;</span>
  34 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  35 import org.apache.flink.client.program.rest.RestClusterClient;</span>
  36 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
  37 import org.apache.flink.configuration.Configuration;
  38 import org.apache.flink.configuration.GlobalConfiguration;
  39 import org.apache.flink.configuration.JobManagerOptions;
  40 import org.apache.flink.core.fs.FileSystem;
  41 import org.apache.flink.runtime.akka.AkkaUtils;
  42 import org.apache.flink.runtime.util.LeaderConnectionInfo;
  43 import org.apache.flink.yarn.AbstractYarnClusterDescriptor;
  44 import org.apache.flink.yarn.YarnClusterDescriptor;
  45 import org.apache.hadoop.yarn.api.records.ApplicationId;
  46 import org.apache.hadoop.yarn.api.records.ApplicationReport;
  47 import org.apache.hadoop.yarn.api.records.YarnApplicationState;
  48 import org.apache.hadoop.yarn.client.api.YarnClient;
  49 import org.apache.hadoop.yarn.conf.YarnConfiguration;
  50 import org.apache.hadoop.yarn.util.StringHelper;
  51 import org.slf4j.Logger;
  52 import org.slf4j.LoggerFactory;
  53 
  54 import java.net.InetSocketAddress;
  55 import java.net.URLDecoder;
  56 import java.util.EnumSet;
  57 import java.util.HashSet;
  58 import java.util.Set;
  59 import java.util.List;
  60 import java.util.Properties;
  61 import java.util.Iterator;
  62 
  63 /**
  64  * @author sishu.yss
  65  */
  66 public class ClusterClientFactory {
  67 
  68     private static final Logger LOG = LoggerFactory.getLogger(ClusterClientFactory.class);
  69 
  70     private static final String HA_CLUSTER_ID = &quot;high-availability.cluster-id&quot;;
  71 
  72     private static final String HIGH_AVAILABILITY = &quot;high-availability&quot;;
  73 
  74     private static final String NODE = &quot;NONE&quot;;
  75 
  76     private static final String ZOOKEEPER = &quot;zookeeper&quot;;
  77 
  78     private static final String HADOOP_CONF = &quot;fs.hdfs.hadoopconf&quot;;
  79 
  80     public static ClusterClient createClusterClient(Options launcherOptions) throws Exception {
  81         String mode = launcherOptions.getMode();
  82         if (mode.equals(ClusterMode.standalone.name())) {
  83             return createStandaloneClient(launcherOptions);
  84         } else if (mode.equals(ClusterMode.yarn.name())) {
  85             return createYarnSessionClient(launcherOptions);
  86         }
  87         throw new IllegalArgumentException(&quot;Unsupported cluster client type: &quot;);
  88     }
  89 
  90     public static ClusterClient createStandaloneClient(Options launcherOptions) throws Exception {
  91         String flinkConfDir = launcherOptions.getFlinkconf();
  92         Configuration config = GlobalConfiguration.loadConfiguration(flinkConfDir);
  93 
  94         LOG.info(&quot;------------config params-------------------------&quot;);
  95         config.toMap().forEach((key, value) -&gt; LOG.info(&quot;{}: {}&quot;, key, value));
  96         LOG.info(&quot;-------------------------------------------&quot;);
  97 
  98         RestClusterClient clusterClient = new RestClusterClient&lt;&gt;(config, &quot;clusterClient&quot;);
  99         LeaderConnectionInfo connectionInfo = clusterClient.getClusterConnectionInfo();
<abbr title=" 100         InetSocketAddress address = AkkaUtils.getInetSocketAddressFromAkkaURL(connectionInfo.getAddress());"> 100         InetSocketAddress address = AkkaUtils.getInetSocketAddressFromAkkaURL(connectionInfo.getAddress()ðŸ”µ</abbr>
 101         config.setString(JobManagerOptions.ADDRESS, address.getAddress().getHostName());
 102         config.setInteger(JobManagerOptions.PORT, address.getPort());
 103         clusterClient.setDetached(true);
 104         return clusterClient;
 105     }
 106 
 107     public static ClusterClient createYarnSessionClient(Options launcherOptions) {
<abbr title=" 108         String flinkConfDir = StringUtils.isEmpty(launcherOptions.getFlinkconf()) ? &quot;&quot; : launcherOptions.getFlinkconf();"> 108         String flinkConfDir = StringUtils.isEmpty(launcherOptions.getFlinkconf()) ? &quot;&quot; : launcherOptions.ðŸ”µ</abbr>
<abbr title=" 109         Configuration config = StringUtils.isEmpty(flinkConfDir) ? new Configuration() : GlobalConfiguration.loadConfiguration(flinkConfDir);"> 109         Configuration config = StringUtils.isEmpty(flinkConfDir) ? new Configuration() : GlobalConfiguratðŸ”µ</abbr>
 110         String yarnConfDir = launcherOptions.getYarnconf();
 111 
 112         if (StringUtils.isNotBlank(yarnConfDir)) {
 113             try {
 114 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 115                 config.setString(ConfigConstants.PATH_HADOOP_CONFIG, yarnConfDir);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 116                 FileSystem.initialize(config, null);</span>
 117 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 118                 FileSystem.initialize(config);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 119 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 120                 YarnConfiguration yarnConf = YarnConfLoader.getYarnConf(yarnConfDir);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 121                 YarnClient yarnClient = YarnClient.createYarnClient();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 122                 yarnClient.init(yarnConf);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 123                 yarnClient.start();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 124                 ApplicationId applicationId = null;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 125 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 126                 String yarnSessionConf = launcherOptions.getYarnSessionConf();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 127                 yarnSessionConf = URLDecoder.decode(yarnSessionConf, Charsets.UTF_8.toString());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 128                 Properties yarnSessionConfProperties = PluginUtil.jsonStrToObject(yarnSessionConf, Properties.class);"> 128                 Properties yarnSessionConfProperties = PluginUtil.jsonStrToObject(yarnSessionConf, ProperðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 129                 Object yid = yarnSessionConfProperties.get(&quot;yid&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 130 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 131                 if (null != yid) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 132                     applicationId = toApplicationId(yid.toString());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 133                 } else {</span>
 134 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 135                 boolean isHighAvailability;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 136 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 137                 config.setString(HADOOP_CONF, yarnConfDir);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 138                 FileSystem.initialize(config);</span>
 139 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 140 
 141                 YarnConfiguration yarnConf = YarnConfLoader.getYarnConf(yarnConfDir);
 142                 YarnClient yarnClient = YarnClient.createYarnClient();
 143                 yarnClient.init(yarnConf);
 144                 yarnClient.start();
 145                 ApplicationId applicationId;
 146 
 147                 String yarnSessionConf = launcherOptions.getYarnSessionConf();
 148                 yarnSessionConf = URLDecoder.decode(yarnSessionConf, Charsets.UTF_8.toString());
<abbr title=" 149                 Properties yarnSessionConfProperties = PluginUtil.jsonStrToObject(yarnSessionConf, Properties.class);"> 149                 Properties yarnSessionConfProperties = PluginUtil.jsonStrToObject(yarnSessionConf, ProperðŸ”µ</abbr>
 150 
 151                 Object yid = yarnSessionConfProperties.get(&quot;yid&quot;);
 152 
 153                 if (null != yid) {
 154                     applicationId = toApplicationId(yid.toString());
 155                 } else {
 156                     applicationId = getYarnClusterApplicationId(yarnClient);
 157                 }
 158 
 159                 LOG.info(&quot;current applicationId = {}&quot;, applicationId.toString());
 160 
 161                 if (StringUtils.isEmpty(applicationId.toString())) {
 162                     throw new RuntimeException(&quot;No flink session found on yarn cluster.&quot;);
 163                 }
 164 
 165                 isHighAvailability = config.getString(HIGH_AVAILABILITY, NODE).equals(ZOOKEEPER);
 166 
 167                 if (isHighAvailability &amp;&amp; config.getString(HA_CLUSTER_ID, null) == null) {
 168                     config.setString(HA_CLUSTER_ID, applicationId.toString());
 169                 }
 170 
 171                 LOG.info(&quot;------------config params-------------------------&quot;);
 172                 config.toMap().forEach((key, value) -&gt; LOG.info(&quot;{}: {}&quot;, key, value));
 173                 LOG.info(&quot;-------------------------------------------&quot;);
 174 
<abbr title=" 175                 AbstractYarnClusterDescriptor clusterDescriptor = new YarnClusterDescriptor(config, yarnConf, flinkConfDir, yarnClient, false);"> 175                 AbstractYarnClusterDescriptor clusterDescriptor = new YarnClusterDescriptor(config, yarnCðŸ”µ</abbr>
 176                 ClusterClient clusterClient = clusterDescriptor.retrieve(applicationId);
 177                 clusterClient.setDetached(true);
 178                 return clusterClient;
 179             } catch (Exception e) {
 180                 throw new RuntimeException(e);
 181             }
 182         } else {
 183             throw new RuntimeException(&quot;yarn mode must set param of &#x27;yarnconf&#x27;!!!&quot;);
 184         }
 185     }
 186 
 187 
 188     private static ApplicationId getYarnClusterApplicationId(YarnClient yarnClient) throws Exception {
 189         ApplicationId applicationId = null;
 190 
 191         Set&lt;String&gt; set = new HashSet&lt;&gt;();
 192         set.add(&quot;Apache Flink&quot;);
 193         EnumSet&lt;YarnApplicationState&gt; enumSet = EnumSet.noneOf(YarnApplicationState.class);
 194         enumSet.add(YarnApplicationState.RUNNING);
 195         List&lt;ApplicationReport&gt; reportList = yarnClient.getApplications(set, enumSet);
 196 
 197         int maxMemory = -1;
 198         int maxCores = -1;
 199         for (ApplicationReport report : reportList) {
 200             if (!report.getName().startsWith(&quot;Flink session&quot;)) {
 201                 continue;
 202             }
 203 
 204             if (!report.getYarnApplicationState().equals(YarnApplicationState.RUNNING)) {
 205                 continue;
 206             }
 207 
 208             int thisMemory = report.getApplicationResourceUsageReport().getNeededResources().getMemory();
<abbr title=" 209             int thisCores = report.getApplicationResourceUsageReport().getNeededResources().getVirtualCores();"> 209             int thisCores = report.getApplicationResourceUsageReport().getNeededResources().getVirtualCorðŸ”µ</abbr>
 210             if (thisMemory &gt; maxMemory || thisMemory == maxMemory &amp;&amp; thisCores &gt; maxCores) {
 211                 maxMemory = thisMemory;
 212                 maxCores = thisCores;
 213                 applicationId = report.getApplicationId();
 214             }
 215 
 216         }
 217 
 218         if (applicationId == null || StringUtils.isEmpty(applicationId.toString())) {
 219             throw new RuntimeException(&quot;No flink session found on yarn cluster.&quot;);
 220         }
 221         return applicationId;
 222     }
 223 
 224     private static ApplicationId toApplicationId(String appIdStr) {
 225         Iterator&lt;String&gt; it = StringHelper._split(appIdStr).iterator();
 226         if (!&quot;application&quot;.equals(it.next())) {
<abbr title=" 227             throw new IllegalArgumentException(&quot;Invalid ApplicationId prefix: &quot; + appIdStr + &quot;. The valid ApplicationId should start with prefix &quot; + &quot;application&quot;);"> 227             throw new IllegalArgumentException(&quot;Invalid ApplicationId prefix: &quot; + appIdStr + &quot;. The validðŸ”µ</abbr>
 228         } else {
 229             try {
 230                 return toApplicationId(it);
 231             } catch (NumberFormatException e) {
 232                 throw new IllegalArgumentException(&quot;Invalid AppAttemptId: &quot; + appIdStr, e);
 233             }
 234         }
 235     }
 236 
 237     private static ApplicationId toApplicationId(Iterator&lt;String&gt; it) throws NumberFormatException {
 238         return ApplicationId.newInstance(Long.parseLong(it.next()), Integer.parseInt(it.next()));
 239     }
 240 
 241 }</pre></td>
                            <td><pre>   1 /**
   2  * Licensed to the Apache Software Foundation (ASF) under one
   3  * or more contributor license agreements.  See the NOTICE file
   4  * distributed with this work for additional information
   5  * regarding copyright ownership.  The ASF licenses this file
   6  * to you under the Apache License, Version 2.0 (the
   7  * &quot;License&quot;); you may not use this file except in compliance
   8  * with the License.  You may obtain a copy of the License at
   9  *
  10  * http://www.apache.org/licenses/LICENSE-2.0
  11  *
  12  * Unless required by applicable law or agreed to in writing, software
  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15  * See the License for the specific language governing permissions and
  16  * limitations under the License.
  17  */
  18 
  19 package com.dtstack.flink.sql.launcher;
  20 
  21 import com.dtstack.flink.sql.enums.ClusterMode;
  22 import com.dtstack.flink.sql.option.Options;
  23 import com.dtstack.flink.sql.util.PluginUtil;
  24 import org.apache.commons.io.Charsets;
  25 import org.apache.commons.lang.StringUtils;
  26 import org.apache.flink.client.program.ClusterClient;
  27 import org.apache.flink.configuration.ConfigConstants;
  28 import org.apache.flink.client.program.rest.RestClusterClient;
  29 import org.apache.flink.configuration.Configuration;
  30 import org.apache.flink.configuration.GlobalConfiguration;
  31 import org.apache.flink.configuration.JobManagerOptions;
  32 import org.apache.flink.core.fs.FileSystem;
  33 import org.apache.flink.runtime.akka.AkkaUtils;
  34 import org.apache.flink.runtime.util.LeaderConnectionInfo;
  35 import org.apache.flink.yarn.AbstractYarnClusterDescriptor;
  36 import org.apache.flink.yarn.YarnClusterDescriptor;
  37 import org.apache.hadoop.yarn.api.records.ApplicationId;
  38 import org.apache.hadoop.yarn.api.records.ApplicationReport;
  39 import org.apache.hadoop.yarn.api.records.YarnApplicationState;
  40 import org.apache.hadoop.yarn.client.api.YarnClient;
  41 import org.apache.hadoop.yarn.conf.YarnConfiguration;
  42 import org.apache.hadoop.yarn.util.StringHelper;
  43 import org.slf4j.Logger;
  44 import org.slf4j.LoggerFactory;
  45 
  46 import java.net.InetSocketAddress;
  47 import java.net.URLDecoder;
  48 import java.util.EnumSet;
  49 import java.util.HashSet;
  50 import java.util.Set;
  51 import java.util.List;
  52 import java.util.Properties;
  53 import java.util.Iterator;
  54 
  55 /**
  56  * @author sishu.yss
  57  */
  58 public class ClusterClientFactory {
  59 
  60     private static final Logger LOG = LoggerFactory.getLogger(ClusterClientFactory.class);
  61 
  62     private static final String HA_CLUSTER_ID = &quot;high-availability.cluster-id&quot;;
  63 
  64     private static final String HIGH_AVAILABILITY = &quot;high-availability&quot;;
  65 
  66     private static final String NODE = &quot;NONE&quot;;
  67 
  68     private static final String ZOOKEEPER = &quot;zookeeper&quot;;
  69 
  70     private static final String HADOOP_CONF = &quot;fs.hdfs.hadoopconf&quot;;
  71 
  72     public static ClusterClient createClusterClient(Options launcherOptions) throws Exception {
  73         String mode = launcherOptions.getMode();
  74         if (mode.equals(ClusterMode.standalone.name())) {
  75             return createStandaloneClient(launcherOptions);
  76         } else if (mode.equals(ClusterMode.yarn.name())) {
  77             return createYarnSessionClient(launcherOptions);
  78         }
  79         throw new IllegalArgumentException(&quot;Unsupported cluster client type: &quot;);
  80     }
  81 
  82     public static ClusterClient createStandaloneClient(Options launcherOptions) throws Exception {
  83         String flinkConfDir = launcherOptions.getFlinkconf();
  84         Configuration config = GlobalConfiguration.loadConfiguration(flinkConfDir);
  85 
  86         LOG.info(&quot;------------config params-------------------------&quot;);
  87         config.toMap().forEach((key, value) -&gt; LOG.info(&quot;{}: {}&quot;, key, value));
  88         LOG.info(&quot;-------------------------------------------&quot;);
  89 
  90         RestClusterClient clusterClient = new RestClusterClient&lt;&gt;(config, &quot;clusterClient&quot;);
  91         LeaderConnectionInfo connectionInfo = clusterClient.getClusterConnectionInfo();
<abbr title="  92         InetSocketAddress address = AkkaUtils.getInetSocketAddressFromAkkaURL(connectionInfo.getAddress());">  92         InetSocketAddress address = AkkaUtils.getInetSocketAddressFromAkkaURL(connectionInfo.getAddress()ðŸ”µ</abbr>
  93         config.setString(JobManagerOptions.ADDRESS, address.getAddress().getHostName());
  94         config.setInteger(JobManagerOptions.PORT, address.getPort());
  95         clusterClient.setDetached(true);
  96         return clusterClient;
  97     }
  98 
  99     public static ClusterClient createYarnSessionClient(Options launcherOptions) {
<abbr title=" 100         String flinkConfDir = StringUtils.isEmpty(launcherOptions.getFlinkconf()) ? &quot;&quot; : launcherOptions.getFlinkconf();"> 100         String flinkConfDir = StringUtils.isEmpty(launcherOptions.getFlinkconf()) ? &quot;&quot; : launcherOptions.ðŸ”µ</abbr>
<abbr title=" 101         Configuration config = StringUtils.isEmpty(flinkConfDir) ? new Configuration() : GlobalConfiguration.loadConfiguration(flinkConfDir);"> 101         Configuration config = StringUtils.isEmpty(flinkConfDir) ? new Configuration() : GlobalConfiguratðŸ”µ</abbr>
 102         String yarnConfDir = launcherOptions.getYarnconf();
 103 
 104         if (StringUtils.isNotBlank(yarnConfDir)) {
 105             try {
 106 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 107                 config.setString(ConfigConstants.PATH_HADOOP_CONFIG, yarnConfDir);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 108                 FileSystem.initialize(config, null);</span>
 109 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 110                 config.setString(&quot;fs.hdfs.hadoopconf&quot;, yarnConfDir);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 111                 FileSystem.initialize(config);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 112 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 113                 YarnConfiguration yarnConf = YarnConfLoader.getYarnConf(yarnConfDir);</span>
 114 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 115                 boolean isHighAvailability;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 116 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 117                 config.setString(HADOOP_CONF, yarnConfDir);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 118                 FileSystem.initialize(config);</span>
 119 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 120 
 121                 YarnConfiguration yarnConf = YarnConfLoader.getYarnConf(yarnConfDir);
 122                 YarnClient yarnClient = YarnClient.createYarnClient();
 123                 yarnClient.init(yarnConf);
 124                 yarnClient.start();
 125                 ApplicationId applicationId;
 126 
 127                 String yarnSessionConf = launcherOptions.getYarnSessionConf();
 128                 yarnSessionConf = URLDecoder.decode(yarnSessionConf, Charsets.UTF_8.toString());
<abbr title=" 129                 Properties yarnSessionConfProperties = PluginUtil.jsonStrToObject(yarnSessionConf, Properties.class);"> 129                 Properties yarnSessionConfProperties = PluginUtil.jsonStrToObject(yarnSessionConf, ProperðŸ”µ</abbr>
 130 
 131                 Object yid = yarnSessionConfProperties.get(&quot;yid&quot;);
 132 
 133                 if (null != yid) {
 134                     applicationId = toApplicationId(yid.toString());
 135                 } else {
 136                     applicationId = getYarnClusterApplicationId(yarnClient);
 137                 }
 138 
 139                 LOG.info(&quot;current applicationId = {}&quot;, applicationId.toString());
 140 
 141                 if (StringUtils.isEmpty(applicationId.toString())) {
 142                     throw new RuntimeException(&quot;No flink session found on yarn cluster.&quot;);
 143                 }
 144 
 145                 isHighAvailability = config.getString(HIGH_AVAILABILITY, NODE).equals(ZOOKEEPER);
 146 
 147                 if (isHighAvailability &amp;&amp; config.getString(HA_CLUSTER_ID, null) == null) {
 148                     config.setString(HA_CLUSTER_ID, applicationId.toString());
 149                 }
 150 
 151                 LOG.info(&quot;------------config params-------------------------&quot;);
 152                 config.toMap().forEach((key, value) -&gt; LOG.info(&quot;{}: {}&quot;, key, value));
 153                 LOG.info(&quot;-------------------------------------------&quot;);
 154 
<abbr title=" 155                 AbstractYarnClusterDescriptor clusterDescriptor = new YarnClusterDescriptor(config, yarnConf, flinkConfDir, yarnClient, false);"> 155                 AbstractYarnClusterDescriptor clusterDescriptor = new YarnClusterDescriptor(config, yarnCðŸ”µ</abbr>
 156                 ClusterClient clusterClient = clusterDescriptor.retrieve(applicationId);
 157                 clusterClient.setDetached(true);
 158                 return clusterClient;
 159             } catch (Exception e) {
 160                 throw new RuntimeException(e);
 161             }
 162         }else{
 163             throw new RuntimeException(&quot;yarn mode must set param of &#x27;yarnconf&#x27;!!!&quot;);
 164         }
 165     }
 166 
 167 
 168     private static ApplicationId getYarnClusterApplicationId(YarnClient yarnClient) throws Exception {
 169         ApplicationId applicationId = null;
 170 
 171         Set&lt;String&gt; set = new HashSet&lt;&gt;();
 172         set.add(&quot;Apache Flink&quot;);
 173         EnumSet&lt;YarnApplicationState&gt; enumSet = EnumSet.noneOf(YarnApplicationState.class);
 174         enumSet.add(YarnApplicationState.RUNNING);
 175         List&lt;ApplicationReport&gt; reportList = yarnClient.getApplications(set, enumSet);
 176 
 177         int maxMemory = -1;
 178         int maxCores = -1;
 179         for (ApplicationReport report : reportList) {
 180             if (!report.getName().startsWith(&quot;Flink session&quot;)) {
 181                 continue;
 182             }
 183 
 184             if (!report.getYarnApplicationState().equals(YarnApplicationState.RUNNING)) {
 185                 continue;
 186             }
 187 
 188             int thisMemory = report.getApplicationResourceUsageReport().getNeededResources().getMemory();
<abbr title=" 189             int thisCores = report.getApplicationResourceUsageReport().getNeededResources().getVirtualCores();"> 189             int thisCores = report.getApplicationResourceUsageReport().getNeededResources().getVirtualCorðŸ”µ</abbr>
 190             if (thisMemory &gt; maxMemory || thisMemory == maxMemory &amp;&amp; thisCores &gt; maxCores) {
 191                 maxMemory = thisMemory;
 192                 maxCores = thisCores;
 193                 applicationId = report.getApplicationId();
 194             }
 195 
 196         }
 197 
 198         if (applicationId == null || StringUtils.isEmpty(applicationId.toString())) {
 199             throw new RuntimeException(&quot;No flink session found on yarn cluster.&quot;);
 200         }
 201         return applicationId;
 202     }
 203 
 204     private static ApplicationId toApplicationId(String appIdStr) {
 205         Iterator&lt;String&gt; it = StringHelper._split(appIdStr).iterator();
 206         if (!&quot;application&quot;.equals(it.next())) {
<abbr title=" 207             throw new IllegalArgumentException(&quot;Invalid ApplicationId prefix: &quot; + appIdStr + &quot;. The valid ApplicationId should start with prefix &quot; + &quot;application&quot;);"> 207             throw new IllegalArgumentException(&quot;Invalid ApplicationId prefix: &quot; + appIdStr + &quot;. The validðŸ”µ</abbr>
 208         } else {
 209             try {
 210                 return toApplicationId(it);
 211             } catch (NumberFormatException e) {
 212                 throw new IllegalArgumentException(&quot;Invalid AppAttemptId: &quot; + appIdStr, e);
 213             }
 214         }
 215     }
 216 
 217     private static ApplicationId toApplicationId(Iterator&lt;String&gt; it) throws NumberFormatException {
 218         return ApplicationId.newInstance(Long.parseLong(it.next()), Integer.parseInt(it.next()));
 219     }
 220 
 221 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                            <td><pre>   1 /**
   2  * Licensed to the Apache Software Foundation (ASF) under one
   3  * or more contributor license agreements.  See the NOTICE file
   4  * distributed with this work for additional information
   5  * regarding copyright ownership.  The ASF licenses this file
   6  * to you under the Apache License, Version 2.0 (the
   7  * &quot;License&quot;); you may not use this file except in compliance
   8  * with the License.  You may obtain a copy of the License at
   9  * &lt;p&gt;
  10  * http://www.apache.org/licenses/LICENSE-2.0
  11  * &lt;p&gt;
  12  * Unless required by applicable law or agreed to in writing, software
  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15  * See the License for the specific language governing permissions and
  16  * limitations under the License.
  17  */
  18 package com.dtstack.flink.sql.launcher;
  19 
  20 import com.dtstack.flink.sql.enums.ClusterMode;
  21 import com.dtstack.flink.sql.option.Options;
  22 import com.dtstack.flink.sql.util.PluginUtil;
  23 import java.net.InetSocketAddress;
  24 import java.net.URLDecoder;
  25 import java.util.EnumSet;
  26 import java.util.HashSet;
  27 import java.util.Iterator;
  28 import java.util.List;
  29 import java.util.Properties;
  30 import java.util.Set;
  31 import org.apache.commons.io.Charsets;
  32 import org.apache.commons.lang.StringUtils;
  33 import org.apache.flink.client.program.ClusterClient;
  34 import org.apache.flink.client.program.rest.RestClusterClient;
  35 import org.apache.flink.configuration.ConfigConstants;
  36 import org.apache.flink.configuration.Configuration;
  37 import org.apache.flink.configuration.GlobalConfiguration;
  38 import org.apache.flink.configuration.JobManagerOptions;
  39 import org.apache.flink.core.fs.FileSystem;
  40 import org.apache.flink.runtime.akka.AkkaUtils;
  41 import org.apache.flink.runtime.util.LeaderConnectionInfo;
  42 import org.apache.flink.yarn.AbstractYarnClusterDescriptor;
  43 import org.apache.flink.yarn.YarnClusterDescriptor;
  44 import org.apache.hadoop.yarn.api.records.ApplicationId;
  45 import org.apache.hadoop.yarn.api.records.ApplicationReport;
  46 import org.apache.hadoop.yarn.api.records.YarnApplicationState;
  47 import org.apache.hadoop.yarn.client.api.YarnClient;
  48 import org.apache.hadoop.yarn.conf.YarnConfiguration;
  49 import org.apache.hadoop.yarn.util.StringHelper;
  50 import org.slf4j.Logger;
  51 import org.slf4j.LoggerFactory;
  52 
  53 
  54 /**
  55  * @author sishu.yss
  56  */
  57 public class ClusterClientFactory {
  58     private static final Logger LOG = LoggerFactory.getLogger(ClusterClientFactory.class);
  59 
  60     private static final String HA_CLUSTER_ID = &quot;high-availability.cluster-id&quot;;
  61 
  62     private static final String HIGH_AVAILABILITY = &quot;high-availability&quot;;
  63 
  64     private static final String NODE = &quot;NONE&quot;;
  65 
  66     private static final String ZOOKEEPER = &quot;zookeeper&quot;;
  67 
  68     private static final String HADOOP_CONF = &quot;fs.hdfs.hadoopconf&quot;;
  69 
  70     public static ClusterClient createClusterClient(Options launcherOptions) throws Exception {
  71         String mode = launcherOptions.getMode();
  72         if (mode.equals(ClusterMode.standalone.name())) {
  73             return createStandaloneClient(launcherOptions);
  74         } else if (mode.equals(ClusterMode.yarn.name())) {
  75             return createYarnSessionClient(launcherOptions);
  76         }
  77         throw new IllegalArgumentException(&quot;Unsupported cluster client type: &quot;);
  78     }
  79 
  80     public static ClusterClient createStandaloneClient(Options launcherOptions) throws Exception {
  81         String flinkConfDir = launcherOptions.getFlinkconf();
  82         Configuration config = GlobalConfiguration.loadConfiguration(flinkConfDir);
  83         LOG.info(&quot;------------config params-------------------------&quot;);
  84         config.toMap().forEach(( key, value) -&gt; LOG.info(&quot;{}: {}&quot;, key, value));
  85         LOG.info(&quot;-------------------------------------------&quot;);
  86         RestClusterClient clusterClient = new RestClusterClient&lt;&gt;(config, &quot;clusterClient&quot;);
  87         LeaderConnectionInfo connectionInfo = clusterClient.getClusterConnectionInfo();
<abbr title="  88         InetSocketAddress address = AkkaUtils.getInetSocketAddressFromAkkaURL(connectionInfo.getAddress());">  88         InetSocketAddress address = AkkaUtils.getInetSocketAddressFromAkkaURL(connectionInfo.getAddress()ðŸ”µ</abbr>
  89         config.setString(JobManagerOptions.ADDRESS, address.getAddress().getHostName());
  90         config.setInteger(JobManagerOptions.PORT, address.getPort());
  91         clusterClient.setDetached(true);
  92         return clusterClient;
  93     }
  94 
  95     public static ClusterClient createYarnSessionClient(Options launcherOptions) {
<abbr title="  96         String flinkConfDir = (StringUtils.isEmpty(launcherOptions.getFlinkconf())) ? &quot;&quot; : launcherOptions.getFlinkconf();">  96         String flinkConfDir = (StringUtils.isEmpty(launcherOptions.getFlinkconf())) ? &quot;&quot; : launcherOptionðŸ”µ</abbr>
<abbr title="  97         Configuration config = (StringUtils.isEmpty(flinkConfDir)) ? new Configuration() : GlobalConfiguration.loadConfiguration(flinkConfDir);">  97         Configuration config = (StringUtils.isEmpty(flinkConfDir)) ? new Configuration() : GlobalConfigurðŸ”µ</abbr>
  98         String yarnConfDir = launcherOptions.getYarnconf();
  99         if (StringUtils.isNotBlank(yarnConfDir)) {
 100             try {
 101                 boolean isHighAvailability;
 102                 config.setString(
 103 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 104 ConfigConstants.PATH_HADOOP_CONFIG</span>
 105 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 106 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 106 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwðŸ”µ</abbr></span>
 107 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 108 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 109 HADOOP_CONF</span>
 110 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 111                 , yarnConfDir);
 112                 FileSystem.initialize(config, null);
 113                 YarnConfiguration yarnConf = YarnConfLoader.getYarnConf(yarnConfDir);
 114                 YarnClient yarnClient = YarnClient.createYarnClient();
 115                 yarnClient.init(yarnConf);
 116                 yarnClient.start();
 117                 ApplicationId applicationId;
 118                 String yarnSessionConf = launcherOptions.getYarnSessionConf();
 119                 yarnSessionConf = URLDecoder.decode(yarnSessionConf, Charsets.UTF_8.toString());
<abbr title=" 120                 Properties yarnSessionConfProperties = PluginUtil.jsonStrToObject(yarnSessionConf, Properties.class);"> 120                 Properties yarnSessionConfProperties = PluginUtil.jsonStrToObject(yarnSessionConf, ProperðŸ”µ</abbr>
 121                 Object yid = yarnSessionConfProperties.get(&quot;yid&quot;);
 122                 if (null != yid) {
 123                     applicationId = toApplicationId(yid.toString());
 124                 } else {
 125                     applicationId = getYarnClusterApplicationId(yarnClient);
 126                 }
 127                 LOG.info(&quot;current applicationId = {}&quot;, applicationId.toString());
 128                 if (StringUtils.isEmpty(applicationId.toString())) {
 129                     throw new RuntimeException(&quot;No flink session found on yarn cluster.&quot;);
 130                 }
 131                 isHighAvailability = config.getString(HIGH_AVAILABILITY, NODE).equals(ZOOKEEPER);
 132                 if (isHighAvailability &amp;&amp; (config.getString(HA_CLUSTER_ID, null) == null)) {
 133                     config.setString(HA_CLUSTER_ID, applicationId.toString());
 134                 }
 135                 LOG.info(&quot;------------config params-------------------------&quot;);
 136                 config.toMap().forEach(( key, value) -&gt; LOG.info(&quot;{}: {}&quot;, key, value));
 137                 LOG.info(&quot;-------------------------------------------&quot;);
<abbr title=" 138                 AbstractYarnClusterDescriptor clusterDescriptor = new YarnClusterDescriptor(config, yarnConf, flinkConfDir, yarnClient, false);"> 138                 AbstractYarnClusterDescriptor clusterDescriptor = new YarnClusterDescriptor(config, yarnCðŸ”µ</abbr>
 139                 ClusterClient clusterClient = clusterDescriptor.retrieve(applicationId);
 140                 clusterClient.setDetached(true);
 141                 return clusterClient;
 142             } catch (java.lang.Exception e) {
 143                 throw new RuntimeException(e);
 144             }
 145         } else {
 146             throw new RuntimeException(&quot;yarn mode must set param of &#x27;yarnconf&#x27;!!!&quot;);
 147         }
 148     }
 149 
 150     private static ApplicationId getYarnClusterApplicationId(YarnClient yarnClient) throws Exception {
 151         ApplicationId applicationId = null;
 152         Set&lt;String&gt; set = new HashSet&lt;&gt;();
 153         set.add(&quot;Apache Flink&quot;);
 154         EnumSet&lt;YarnApplicationState&gt; enumSet = EnumSet.noneOf(YarnApplicationState.class);
 155         enumSet.add(YarnApplicationState.RUNNING);
 156         List&lt;ApplicationReport&gt; reportList = yarnClient.getApplications(set, enumSet);
 157         int maxMemory = -1;
 158         int maxCores = -1;
 159         for (ApplicationReport report : reportList) {
 160             if (!report.getName().startsWith(&quot;Flink session&quot;)) {
 161                 continue;
 162             }
 163             if (!report.getYarnApplicationState().equals(YarnApplicationState.RUNNING)) {
 164                 continue;
 165             }
 166             int thisMemory = report.getApplicationResourceUsageReport().getNeededResources().getMemory();
<abbr title=" 167             int thisCores = report.getApplicationResourceUsageReport().getNeededResources().getVirtualCores();"> 167             int thisCores = report.getApplicationResourceUsageReport().getNeededResources().getVirtualCorðŸ”µ</abbr>
 168             if ((thisMemory &gt; maxMemory) || ((thisMemory == maxMemory) &amp;&amp; (thisCores &gt; maxCores))) {
 169                 maxMemory = thisMemory;
 170                 maxCores = thisCores;
 171                 applicationId = report.getApplicationId();
 172             }
 173         }
 174         if ((applicationId == null) || StringUtils.isEmpty(applicationId.toString())) {
 175             throw new RuntimeException(&quot;No flink session found on yarn cluster.&quot;);
 176         }
 177         return applicationId;
 178     }
 179 
 180     private static ApplicationId toApplicationId(String appIdStr) {
 181         Iterator&lt;String&gt; it = StringHelper._split(appIdStr).iterator();
 182         if (!&quot;application&quot;.equals(it.next())) {
<abbr title=" 183             throw new IllegalArgumentException(&quot;Invalid ApplicationId prefix: &quot; + appIdStr + &quot;. The valid ApplicationId should start with prefix &quot; + &quot;application&quot;);"> 183             throw new IllegalArgumentException(&quot;Invalid ApplicationId prefix: &quot; + appIdStr + &quot;. The validðŸ”µ</abbr>
 184         } else {
 185             try {
 186                 return toApplicationId(it);
 187             } catch (NumberFormatException e) {
 188                 throw new IllegalArgumentException(&quot;Invalid AppAttemptId: &quot; + appIdStr, e);
 189             }
 190         }
 191     }
 192 
 193     private static ApplicationId toApplicationId(Iterator&lt;String&gt; it) throws NumberFormatException {
 194         return ApplicationId.newInstance(Long.parseLong(it.next()), Integer.parseInt(it.next()));
 195     }
 196 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  /**
   2   * Licensed to the Apache Software Foundation (ASF) under one
   3   * or more contributor license agreements.  See the NOTICE file
   4   * distributed with this work for additional information
   5   * regarding copyright ownership.  The ASF licenses this file
   6   * to you under the Apache License, Version 2.0 (the
   7   * &quot;License&quot;); you may not use this file except in compliance
   8   * with the License.  You may obtain a copy of the License at
   9   *

  10   * http://www.apache.org/licenses/LICENSE-2.0
  11   *

  12   * Unless required by applicable law or agreed to in writing, software
  13   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15   * See the License for the specific language governing permissions and
  16   * limitations under the License.
  17   */
  18  
  19  package com.dtstack.flink.sql.launcher;
  20  
  21  import com.dtstack.flink.sql.enums.ClusterMode;
  22  import com.dtstack.flink.sql.option.Options;
  23  import com.dtstack.flink.sql.util.PluginUtil;
  24  import com.esotericsoftware.minlog.Log;
  25  import org.apache.commons.io.Charsets;
  26  import org.apache.commons.lang.StringUtils;
  27  import org.apache.flink.client.program.ClusterClient;
  28  import org.apache.flink.client.program.MiniClusterClient;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  29 +import org.apache.flink.configuration.ConfigConstants;</span>
  30  import org.apache.flink.configuration.Configuration;
  31  import org.apache.flink.configuration.GlobalConfiguration;
  32  import org.apache.flink.configuration.JobManagerOptions;
  33  import org.apache.flink.core.fs.FileSystem;
  34  import org.apache.flink.runtime.akka.AkkaUtils;
  35  import org.apache.flink.runtime.minicluster.MiniCluster;
  36  import org.apache.flink.runtime.minicluster.MiniClusterConfiguration;
  37  import org.apache.flink.runtime.util.LeaderConnectionInfo;
  38  import org.apache.flink.yarn.AbstractYarnClusterDescriptor;
  39  import org.apache.flink.yarn.YarnClusterDescriptor;
  40  import org.apache.hadoop.yarn.api.records.ApplicationId;
  41  import org.apache.hadoop.yarn.api.records.ApplicationReport;
  42  import org.apache.hadoop.yarn.api.records.YarnApplicationState;
  43  import org.apache.hadoop.yarn.client.api.YarnClient;
  44  import org.apache.hadoop.yarn.conf.YarnConfiguration;
  45  import org.apache.hadoop.yarn.util.StringHelper;


  46  
  47  import java.net.InetSocketAddress;
  48  import java.net.URLDecoder;
  49  import java.util.EnumSet;
  50  import java.util.HashSet;
  51  import java.util.Iterator;

  52  import java.util.List;
  53  import java.util.Properties;
  54  import java.util.Set;

  55  
  56  /**
  57   * @author sishu.yss
  58   */
  59  public class ClusterClientFactory {












  60  
  61      public static ClusterClient createClusterClient(Options launcherOptions) throws Exception {
  62          String mode = launcherOptions.getMode();
  63          if (mode.equals(ClusterMode.standalone.name())) {
  64              return createStandaloneClient(launcherOptions);
  65          } else if (mode.equals(ClusterMode.yarn.name())) {
  66              return createYarnSessionClient(launcherOptions);
  67          }
  68          throw new IllegalArgumentException(&quot;Unsupported cluster client type: &quot;);
  69      }
  70  
  71      public static ClusterClient createStandaloneClient(Options launcherOptions) throws Exception {
  72          String flinkConfDir = launcherOptions.getFlinkconf();
  73          Configuration config = GlobalConfiguration.loadConfiguration(flinkConfDir);
  74          MiniClusterConfiguration.Builder configBuilder = new MiniClusterConfiguration.Builder();
  75          configBuilder.setConfiguration(config);
  76          MiniCluster miniCluster = new MiniCluster(configBuilder.build());
  77          MiniClusterClient clusterClient = new MiniClusterClient(config, miniCluster);






  78          LeaderConnectionInfo connectionInfo = clusterClient.getClusterConnectionInfo();
  79          InetSocketAddress address = AkkaUtils.getInetSocketAddressFromAkkaURL(connectionInfo.getAddress());
  80          config.setString(JobManagerOptions.ADDRESS, address.getAddress().getHostName());
  81          config.setInteger(JobManagerOptions.PORT, address.getPort());
  82          clusterClient.setDetached(true);
  83          return clusterClient;
  84      }
  85  
  86      public static ClusterClient createYarnSessionClient(Options launcherOptions) {
<abbr title="  87          String flinkConfDir = StringUtils.isEmpty(launcherOptions.getFlinkconf()) ? &quot;&quot; : launcherOptions.getFlinkconf();">  87          String flinkConfDir = StringUtils.isEmpty(launcherOptions.getFlinkconf()) ? &quot;&quot; : launcherOptions.getFlinkcðŸ”µ</abbr>
<abbr title="  88          Configuration config = StringUtils.isEmpty(flinkConfDir) ? new Configuration() : GlobalConfiguration.loadConfiguration(flinkConfDir);">  88          Configuration config = StringUtils.isEmpty(flinkConfDir) ? new Configuration() : GlobalConfiguration.loadCðŸ”µ</abbr>
  89          String yarnConfDir = launcherOptions.getYarnconf();
  90  
  91          if (StringUtils.isNotBlank(yarnConfDir)) {
  92              try {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  93 -                config.setString(&quot;fs.hdfs.hadoopconf&quot;, yarnConfDir);</span>



<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  94 -                FileSystem.initialize(config);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  95 +                config.setString(ConfigConstants.PATH_HADOOP_CONFIG, yarnConfDir);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  96 +                FileSystem.initialize(config, null);</span>
  97  
  98                  YarnConfiguration yarnConf = YarnConfLoader.getYarnConf(yarnConfDir);
  99                  YarnClient yarnClient = YarnClient.createYarnClient();
 100                  yarnClient.init(yarnConf);
 101                  yarnClient.start();
 102                  ApplicationId applicationId = null;

 103  
 104                  String yarnSessionConf = launcherOptions.getYarnSessionConf();
 105                  yarnSessionConf = URLDecoder.decode(yarnSessionConf, Charsets.UTF_8.toString());
<abbr title=" 106                  Properties yarnSessionConfProperties = PluginUtil.jsonStrToObject(yarnSessionConf, Properties.class);"> 106                  Properties yarnSessionConfProperties = PluginUtil.jsonStrToObject(yarnSessionConf, Properties.clasðŸ”µ</abbr>

 107                  Object yid = yarnSessionConfProperties.get(&quot;yid&quot;);
 108  
 109                  if (null != yid) {
 110                      applicationId = toApplicationId(yid.toString());
 111                  } else {
 112                      applicationId = getYarnClusterApplicationId(yarnClient);
 113                  }
 114  
 115                  Log.info(&quot;applicationId={}&quot;, applicationId.toString());

 116  
 117                  if (StringUtils.isEmpty(applicationId.toString())) {
 118                      throw new RuntimeException(&quot;No flink session found on yarn cluster.&quot;);
 119                  }










 120  
<abbr title=" 121                  AbstractYarnClusterDescriptor clusterDescriptor = new YarnClusterDescriptor(config, yarnConf, flinkConfDir, yarnClient, false);"> 121                  AbstractYarnClusterDescriptor clusterDescriptor = new YarnClusterDescriptor(config, yarnConf, flinðŸ”µ</abbr>
 122                  ClusterClient clusterClient = clusterDescriptor.retrieve(applicationId);
 123                  clusterClient.setDetached(true);
 124                  return clusterClient;
 125              } catch (Exception e) {
 126                  throw new RuntimeException(e);
 127              }
 128          }else{

 129              throw new RuntimeException(&quot;yarn mode must set param of &#x27;yarnconf&#x27;!!!&quot;);
 130          }
 131      }
 132  
 133  
 134      private static ApplicationId getYarnClusterApplicationId(YarnClient yarnClient) throws Exception {
 135          ApplicationId applicationId = null;
 136  
 137          Set&lt;String&gt; set = new HashSet&lt;&gt;();
 138          set.add(&quot;Apache Flink&quot;);
 139          EnumSet&lt;YarnApplicationState&gt; enumSet = EnumSet.noneOf(YarnApplicationState.class);
 140          enumSet.add(YarnApplicationState.RUNNING);
 141          List&lt;ApplicationReport&gt; reportList = yarnClient.getApplications(set, enumSet);
 142  
 143          int maxMemory = -1;
 144          int maxCores = -1;
 145          for (ApplicationReport report : reportList) {
 146              if (!report.getName().startsWith(&quot;Flink session&quot;)) {
 147                  continue;
 148              }
 149  
 150              if (!report.getYarnApplicationState().equals(YarnApplicationState.RUNNING)) {
 151                  continue;
 152              }
 153  
 154              int thisMemory = report.getApplicationResourceUsageReport().getNeededResources().getMemory();
 155              int thisCores = report.getApplicationResourceUsageReport().getNeededResources().getVirtualCores();
 156              if (thisMemory &gt; maxMemory || thisMemory == maxMemory &amp;&amp; thisCores &gt; maxCores) {
 157                  maxMemory = thisMemory;
 158                  maxCores = thisCores;
 159                  applicationId = report.getApplicationId();
 160              }
 161  
 162          }
 163  
 164          if (StringUtils.isEmpty(applicationId.toString())) {

 165              throw new RuntimeException(&quot;No flink session found on yarn cluster.&quot;);
 166          }
 167          return applicationId;
 168      }
 169  
 170      private static ApplicationId toApplicationId(String appIdStr) {
 171          Iterator&lt;String&gt; it = StringHelper._split(appIdStr).iterator();
 172          if (!&quot;application&quot;.equals(it.next())) {
<abbr title=" 173              throw new IllegalArgumentException(&quot;Invalid ApplicationId prefix: &quot; + appIdStr + &quot;. The valid ApplicationId should start with prefix &quot; + &quot;application&quot;);"> 173              throw new IllegalArgumentException(&quot;Invalid ApplicationId prefix: &quot; + appIdStr + &quot;. The valid ApplicatðŸ”µ</abbr>
 174          } else {
 175              try {
 176                  return toApplicationId(it);
 177              } catch (NumberFormatException e) {
 178                  throw new IllegalArgumentException(&quot;Invalid AppAttemptId: &quot; + appIdStr, e);
 179              }
 180          }
 181      }
 182  
 183      private static ApplicationId toApplicationId(Iterator&lt;String&gt; it) throws NumberFormatException {
 184          return ApplicationId.newInstance(Long.parseLong(it.next()), Integer.parseInt(it.next()));
 185      }
 186  
 187  }</pre></td>
                            <td><pre>   1  /**
   2   * Licensed to the Apache Software Foundation (ASF) under one
   3   * or more contributor license agreements.  See the NOTICE file
   4   * distributed with this work for additional information
   5   * regarding copyright ownership.  The ASF licenses this file
   6   * to you under the Apache License, Version 2.0 (the
   7   * &quot;License&quot;); you may not use this file except in compliance
   8   * with the License.  You may obtain a copy of the License at
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   9 - *</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  10 + * &lt;p&gt;</span>
  11   * http://www.apache.org/licenses/LICENSE-2.0
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  12 - *</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  13 + * &lt;p&gt;</span>
  14   * Unless required by applicable law or agreed to in writing, software
  15   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  16   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  17   * See the License for the specific language governing permissions and
  18   * limitations under the License.
  19   */
  20  
  21  package com.dtstack.flink.sql.launcher;
  22  
  23  import com.dtstack.flink.sql.enums.ClusterMode;
  24  import com.dtstack.flink.sql.option.Options;
  25  import com.dtstack.flink.sql.util.PluginUtil;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  26 -import com.esotericsoftware.minlog.Log;</span>
  27  import org.apache.commons.io.Charsets;
  28  import org.apache.commons.lang.StringUtils;
  29  import org.apache.flink.client.program.ClusterClient;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  30 -import org.apache.flink.client.program.MiniClusterClient;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  31 +import org.apache.flink.client.program.rest.RestClusterClient;</span>
  32  import org.apache.flink.configuration.Configuration;
  33  import org.apache.flink.configuration.GlobalConfiguration;
  34  import org.apache.flink.configuration.JobManagerOptions;
  35  import org.apache.flink.core.fs.FileSystem;
  36  import org.apache.flink.runtime.akka.AkkaUtils;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  37 -import org.apache.flink.runtime.minicluster.MiniCluster;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  38 -import org.apache.flink.runtime.minicluster.MiniClusterConfiguration;</span>
  39  import org.apache.flink.runtime.util.LeaderConnectionInfo;
  40  import org.apache.flink.yarn.AbstractYarnClusterDescriptor;
  41  import org.apache.flink.yarn.YarnClusterDescriptor;
  42  import org.apache.hadoop.yarn.api.records.ApplicationId;
  43  import org.apache.hadoop.yarn.api.records.ApplicationReport;
  44  import org.apache.hadoop.yarn.api.records.YarnApplicationState;
  45  import org.apache.hadoop.yarn.client.api.YarnClient;
  46  import org.apache.hadoop.yarn.conf.YarnConfiguration;
  47  import org.apache.hadoop.yarn.util.StringHelper;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  48 +import org.slf4j.Logger;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  49 +import org.slf4j.LoggerFactory;</span>
  50  
  51  import java.net.InetSocketAddress;
  52  import java.net.URLDecoder;
  53  import java.util.EnumSet;
  54  import java.util.HashSet;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  55 -import java.util.Iterator;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  56 +import java.util.Set;</span>
  57  import java.util.List;
  58  import java.util.Properties;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  59 -import java.util.Set;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  60 +import java.util.Iterator;</span>
  61  
  62  /**
  63   * @author sishu.yss
  64   */
  65  public class ClusterClientFactory {
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  66 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  67 +    private static final Logger LOG = LoggerFactory.getLogger(ClusterClientFactory.class);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  68 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  69 +    private static final String HA_CLUSTER_ID = &quot;high-availability.cluster-id&quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  70 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  71 +    private static final String HIGH_AVAILABILITY = &quot;high-availability&quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  72 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  73 +    private static final String NODE = &quot;NONE&quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  74 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  75 +    private static final String ZOOKEEPER = &quot;zookeeper&quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  76 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  77 +    private static final String HADOOP_CONF = &quot;fs.hdfs.hadoopconf&quot;;</span>
  78  
  79      public static ClusterClient createClusterClient(Options launcherOptions) throws Exception {
  80          String mode = launcherOptions.getMode();
  81          if (mode.equals(ClusterMode.standalone.name())) {
  82              return createStandaloneClient(launcherOptions);
  83          } else if (mode.equals(ClusterMode.yarn.name())) {
  84              return createYarnSessionClient(launcherOptions);
  85          }
  86          throw new IllegalArgumentException(&quot;Unsupported cluster client type: &quot;);
  87      }
  88  
  89      public static ClusterClient createStandaloneClient(Options launcherOptions) throws Exception {
  90          String flinkConfDir = launcherOptions.getFlinkconf();
  91          Configuration config = GlobalConfiguration.loadConfiguration(flinkConfDir);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  92 -        MiniClusterConfiguration.Builder configBuilder = new MiniClusterConfiguration.Builder();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  93 -        configBuilder.setConfiguration(config);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  94 -        MiniCluster miniCluster = new MiniCluster(configBuilder.build());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  95 -        MiniClusterClient clusterClient = new MiniClusterClient(config, miniCluster);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  96 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  97 +        LOG.info(&quot;------------config params-------------------------&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  98 +        config.toMap().forEach((key, value) -&gt; LOG.info(&quot;{}: {}&quot;, key, value));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  99 +        LOG.info(&quot;-------------------------------------------&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 100 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 101 +        RestClusterClient clusterClient = new RestClusterClient&lt;&gt;(config, &quot;clusterClient&quot;);</span>
 102          LeaderConnectionInfo connectionInfo = clusterClient.getClusterConnectionInfo();
 103          InetSocketAddress address = AkkaUtils.getInetSocketAddressFromAkkaURL(connectionInfo.getAddress());
 104          config.setString(JobManagerOptions.ADDRESS, address.getAddress().getHostName());
 105          config.setInteger(JobManagerOptions.PORT, address.getPort());
 106          clusterClient.setDetached(true);
 107          return clusterClient;
 108      }
 109  
 110      public static ClusterClient createYarnSessionClient(Options launcherOptions) {
<abbr title=" 111          String flinkConfDir = StringUtils.isEmpty(launcherOptions.getFlinkconf()) ? &quot;&quot; : launcherOptions.getFlinkconf();"> 111          String flinkConfDir = StringUtils.isEmpty(launcherOptions.getFlinkconf()) ? &quot;&quot; : launcherOptions.getFlinkcðŸ”µ</abbr>
<abbr title=" 112          Configuration config = StringUtils.isEmpty(flinkConfDir) ? new Configuration() : GlobalConfiguration.loadConfiguration(flinkConfDir);"> 112          Configuration config = StringUtils.isEmpty(flinkConfDir) ? new Configuration() : GlobalConfiguration.loadCðŸ”µ</abbr>
 113          String yarnConfDir = launcherOptions.getYarnconf();
 114  
 115          if (StringUtils.isNotBlank(yarnConfDir)) {
 116              try {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 117 -                config.setString(&quot;fs.hdfs.hadoopconf&quot;, yarnConfDir);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 118 +                boolean isHighAvailability;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 119 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 120 +                config.setString(HADOOP_CONF, yarnConfDir);</span>
 121                  FileSystem.initialize(config);


 122  
 123                  YarnConfiguration yarnConf = YarnConfLoader.getYarnConf(yarnConfDir);
 124                  YarnClient yarnClient = YarnClient.createYarnClient();
 125                  yarnClient.init(yarnConf);
 126                  yarnClient.start();
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 127 -                ApplicationId applicationId = null;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 128 +                ApplicationId applicationId;</span>
 129  
 130                  String yarnSessionConf = launcherOptions.getYarnSessionConf();
 131                  yarnSessionConf = URLDecoder.decode(yarnSessionConf, Charsets.UTF_8.toString());
<abbr title=" 132                  Properties yarnSessionConfProperties = PluginUtil.jsonStrToObject(yarnSessionConf, Properties.class);"> 132                  Properties yarnSessionConfProperties = PluginUtil.jsonStrToObject(yarnSessionConf, Properties.clasðŸ”µ</abbr>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 133 +</span>
 134                  Object yid = yarnSessionConfProperties.get(&quot;yid&quot;);
 135  
 136                  if (null != yid) {
 137                      applicationId = toApplicationId(yid.toString());
 138                  } else {
 139                      applicationId = getYarnClusterApplicationId(yarnClient);
 140                  }
 141  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 142 -                Log.info(&quot;applicationId={}&quot;, applicationId.toString());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 143 +                LOG.info(&quot;current applicationId = {}&quot;, applicationId.toString());</span>
 144  
 145                  if (StringUtils.isEmpty(applicationId.toString())) {
 146                      throw new RuntimeException(&quot;No flink session found on yarn cluster.&quot;);
 147                  }
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 148 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 149 +                isHighAvailability = config.getString(HIGH_AVAILABILITY, NODE).equals(ZOOKEEPER);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 150 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 151 +                if (isHighAvailability &amp;&amp; config.getString(HA_CLUSTER_ID, null) == null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 152 +                    config.setString(HA_CLUSTER_ID, applicationId.toString());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 153 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 154 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 155 +                LOG.info(&quot;------------config params-------------------------&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 156 +                config.toMap().forEach((key, value) -&gt; LOG.info(&quot;{}: {}&quot;, key, value));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 157 +                LOG.info(&quot;-------------------------------------------&quot;);</span>
 158  
<abbr title=" 159                  AbstractYarnClusterDescriptor clusterDescriptor = new YarnClusterDescriptor(config, yarnConf, flinkConfDir, yarnClient, false);"> 159                  AbstractYarnClusterDescriptor clusterDescriptor = new YarnClusterDescriptor(config, yarnConf, flinðŸ”µ</abbr>
 160                  ClusterClient clusterClient = clusterDescriptor.retrieve(applicationId);
 161                  clusterClient.setDetached(true);
 162                  return clusterClient;
 163              } catch (Exception e) {
 164                  throw new RuntimeException(e);
 165              }
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 166 -        }else{</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 167 +        } else {</span>
 168              throw new RuntimeException(&quot;yarn mode must set param of &#x27;yarnconf&#x27;!!!&quot;);
 169          }
 170      }
 171  
 172  
 173      private static ApplicationId getYarnClusterApplicationId(YarnClient yarnClient) throws Exception {
 174          ApplicationId applicationId = null;
 175  
 176          Set&lt;String&gt; set = new HashSet&lt;&gt;();
 177          set.add(&quot;Apache Flink&quot;);
 178          EnumSet&lt;YarnApplicationState&gt; enumSet = EnumSet.noneOf(YarnApplicationState.class);
 179          enumSet.add(YarnApplicationState.RUNNING);
 180          List&lt;ApplicationReport&gt; reportList = yarnClient.getApplications(set, enumSet);
 181  
 182          int maxMemory = -1;
 183          int maxCores = -1;
 184          for (ApplicationReport report : reportList) {
 185              if (!report.getName().startsWith(&quot;Flink session&quot;)) {
 186                  continue;
 187              }
 188  
 189              if (!report.getYarnApplicationState().equals(YarnApplicationState.RUNNING)) {
 190                  continue;
 191              }
 192  
 193              int thisMemory = report.getApplicationResourceUsageReport().getNeededResources().getMemory();
 194              int thisCores = report.getApplicationResourceUsageReport().getNeededResources().getVirtualCores();
 195              if (thisMemory &gt; maxMemory || thisMemory == maxMemory &amp;&amp; thisCores &gt; maxCores) {
 196                  maxMemory = thisMemory;
 197                  maxCores = thisCores;
 198                  applicationId = report.getApplicationId();
 199              }
 200  
 201          }
 202  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 203 -        if (StringUtils.isEmpty(applicationId.toString())) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 204 +        if (applicationId == null || StringUtils.isEmpty(applicationId.toString())) {</span>
 205              throw new RuntimeException(&quot;No flink session found on yarn cluster.&quot;);
 206          }
 207          return applicationId;
 208      }
 209  
 210      private static ApplicationId toApplicationId(String appIdStr) {
 211          Iterator&lt;String&gt; it = StringHelper._split(appIdStr).iterator();
 212          if (!&quot;application&quot;.equals(it.next())) {
<abbr title=" 213              throw new IllegalArgumentException(&quot;Invalid ApplicationId prefix: &quot; + appIdStr + &quot;. The valid ApplicationId should start with prefix &quot; + &quot;application&quot;);"> 213              throw new IllegalArgumentException(&quot;Invalid ApplicationId prefix: &quot; + appIdStr + &quot;. The valid ApplicatðŸ”µ</abbr>
 214          } else {
 215              try {
 216                  return toApplicationId(it);
 217              } catch (NumberFormatException e) {
 218                  throw new IllegalArgumentException(&quot;Invalid AppAttemptId: &quot; + appIdStr, e);
 219              }
 220          }
 221      }
 222  
 223      private static ApplicationId toApplicationId(Iterator&lt;String&gt; it) throws NumberFormatException {
 224          return ApplicationId.newInstance(Long.parseLong(it.next()), Integer.parseInt(it.next()));
 225      }
 226  
 227  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            