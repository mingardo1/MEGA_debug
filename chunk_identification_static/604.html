<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>604</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        .highlighted {
                            background-color: rgba(177, 82, 227, 0.85) !important;
                        }
                    </style>
                    <script>
                        function enter(c) {
                            const lines = document.getElementsByClassName(c);
                            for (let i = 0; i < lines.length; i++) {
                               lines.item(i).classList.add('highlighted');
                            }
                        }
                        function out(c) {
                            const lines = document.getElementsByClassName(c);
                            for (let i = 0; i < lines.length; i++) {
                               lines.item(i).classList.remove('highlighted');
                            }
                        }
                    </script>
              </head>
              <body>
                <span style="height: 4vh">
                    604
                    <a href="603.html">prev</a>
                    <a href="605.html">next</a>
                    <a href="604_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    Freeyourgadget/Gadgetbridge_f66f765fb67afe074167bda0ea354ba64402dcac_app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/pebble/PebbleIoThread.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Freeyourgadget\Gadgetbridge show &quot;f66f765fb67afe074167bda0ea354ba64402dcac:app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/pebble/PebbleIoThread.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Freeyourgadget\Gadgetbridge show &quot;f66f765fb67afe074167bda0ea354ba64402dcac^1:app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/pebble/PebbleIoThread.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Freeyourgadget\Gadgetbridge show &quot;f66f765fb67afe074167bda0ea354ba64402dcac^2:app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/pebble/PebbleIoThread.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Freeyourgadget\Gadgetbridge show &quot;fd51f32765c40e0f125a4bbc5d2575ecbb1a66ec:app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/pebble/PebbleIoThread.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[bs]], subset: [[bs]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre><span class="-5771549642386131488" onmouseenter="enter('-5771549642386131488');" onmouseout="out('-5771549642386131488');" style="">   1 package nodomain.freeyourgadget.gadgetbridge.service.devices.pebble;                                     </span>
<span  style="">   2                                                                                                          </span>
<span class="-8028506601233233593" onmouseenter="enter('-8028506601233233593');" onmouseout="out('-8028506601233233593');" style="">   3 import android.bluetooth.BluetoothAdapter;                                                               </span>
<span class="2859895893394018468" onmouseenter="enter('2859895893394018468');" onmouseout="out('2859895893394018468');" style="">   4 import android.bluetooth.BluetoothDevice;                                                                </span>
<span class="634810844753697830" onmouseenter="enter('634810844753697830');" onmouseout="out('634810844753697830');" style="">   5 import android.bluetooth.BluetoothSocket;                                                                </span>
<span class="5922045460006936195" onmouseenter="enter('5922045460006936195');" onmouseout="out('5922045460006936195');" style="">   6 import android.content.Context;                                                                          </span>
<span class="6568903789857736568" onmouseenter="enter('6568903789857736568');" onmouseout="out('6568903789857736568');" style="">   7 import android.content.Intent;                                                                           </span>
<span class="-8750621697125156872" onmouseenter="enter('-8750621697125156872');" onmouseout="out('-8750621697125156872');" style="">   8 import android.net.Uri;                                                                                  </span>
<span class="8301908088148850736" onmouseenter="enter('8301908088148850736');" onmouseout="out('8301908088148850736');" style="">   9 import android.os.ParcelUuid;                                                                            </span>
<span class="2517521963771876570" onmouseenter="enter('2517521963771876570');" onmouseout="out('2517521963771876570');" style="">  10 import android.support.v4.content.LocalBroadcastManager;                                                 </span>
<span  style="">  11                                                                                                          </span>
<span class="9072327285961251154" onmouseenter="enter('9072327285961251154');" onmouseout="out('9072327285961251154');" style="">  12 import org.slf4j.Logger;                                                                                 </span>
<span class="697043352225962606" onmouseenter="enter('697043352225962606');" onmouseout="out('697043352225962606');" style="">  13 import org.slf4j.LoggerFactory;                                                                          </span>
<span  style="">  14                                                                                                          </span>
<span class="-3926401431737521278" onmouseenter="enter('-3926401431737521278');" onmouseout="out('-3926401431737521278');" style="">  15 import java.io.File;                                                                                     </span>
<span class="-75475733228177869" onmouseenter="enter('-75475733228177869');" onmouseout="out('-75475733228177869');" style="">  16 import java.io.FileNotFoundException;                                                                    </span>
<span class="103340661636203254" onmouseenter="enter('103340661636203254');" onmouseout="out('103340661636203254');" style="">  17 import java.io.IOException;                                                                              </span>
<span class="5631563232245871054" onmouseenter="enter('5631563232245871054');" onmouseout="out('5631563232245871054');" style="">  18 import java.io.InputStream;                                                                              </span>
<span class="4621164050749610193" onmouseenter="enter('4621164050749610193');" onmouseout="out('4621164050749610193');" style="">  19 import java.io.OutputStream;                                                                             </span>
<span class="-4777627942089262832" onmouseenter="enter('-4777627942089262832');" onmouseout="out('-4777627942089262832');" style="">  20 import java.io.PipedInputStream;                                                                         </span>
<span class="5026237307424376420" onmouseenter="enter('5026237307424376420');" onmouseout="out('5026237307424376420');" style="">  21 import java.io.PipedOutputStream;                                                                        </span>
<span class="-5790770097715703577" onmouseenter="enter('-5790770097715703577');" onmouseout="out('-5790770097715703577');" style="">  22 import java.net.InetAddress;                                                                             </span>
<span class="-623186069646925252" onmouseenter="enter('-623186069646925252');" onmouseout="out('-623186069646925252');" style="">  23 import java.net.Socket;                                                                                  </span>
<span class="-6886346622632588502" onmouseenter="enter('-6886346622632588502');" onmouseout="out('-6886346622632588502');" style="">  24 import java.nio.ByteBuffer;                                                                              </span>
<span class="-4536046119683402321" onmouseenter="enter('-4536046119683402321');" onmouseout="out('-4536046119683402321');" style="">  25 import java.nio.ByteOrder;                                                                               </span>
<span  style="">  26                                                                                                          </span>
<span class="-8113221927992302576" onmouseenter="enter('-8113221927992302576');" onmouseout="out('-8113221927992302576');" style="">  27 import nodomain.freeyourgadget.gadgetbridge.GBApplication;                                               </span>
<span class="-7198279398549834921" onmouseenter="enter('-7198279398549834921');" onmouseout="out('-7198279398549834921');" style="">  28 import nodomain.freeyourgadget.gadgetbridge.R;                                                           </span>
<span class="5959948573825064529" onmouseenter="enter('5959948573825064529');" onmouseout="out('5959948573825064529');" style="">  29 import nodomain.freeyourgadget.gadgetbridge.activities.appmanager.AbstractAppManagerFragment;            </span>
<span class="-7454882487459214858" onmouseenter="enter('-7454882487459214858');" onmouseout="out('-7454882487459214858');" style="">  30 import nodomain.freeyourgadget.gadgetbridge.activities.appmanager.AppManagerActivity;                    </span>
<span class="8774236294555479386" onmouseenter="enter('8774236294555479386');" onmouseout="out('8774236294555479386');" style="">  31 import nodomain.freeyourgadget.gadgetbridge.deviceevents.GBDeviceEvent;                                  </span>
<span class="-4700446920707564194" onmouseenter="enter('-4700446920707564194');" onmouseout="out('-4700446920707564194');" style="">  32 import nodomain.freeyourgadget.gadgetbridge.deviceevents.GBDeviceEventAppInfo;                           </span>
<span class="-5686102242644058946" onmouseenter="enter('-5686102242644058946');" onmouseout="out('-5686102242644058946');" style="">  33 import nodomain.freeyourgadget.gadgetbridge.deviceevents.GBDeviceEventAppManagement;                     </span>
<span class="2791890994602016761" onmouseenter="enter('2791890994602016761');" onmouseout="out('2791890994602016761');" style="">  34 import nodomain.freeyourgadget.gadgetbridge.deviceevents.GBDeviceEventAppMessage;                        </span>
<span class="7456778970616733409" onmouseenter="enter('7456778970616733409');" onmouseout="out('7456778970616733409');" style="">  35 import nodomain.freeyourgadget.gadgetbridge.deviceevents.GBDeviceEventVersionInfo;                       </span>
<span class="-8786909529118259831" onmouseenter="enter('-8786909529118259831');" onmouseout="out('-8786909529118259831');" style="">  36 import nodomain.freeyourgadget.gadgetbridge.devices.pebble.PBWReader;                                    </span>
<span class="-6745962823678362300" onmouseenter="enter('-6745962823678362300');" onmouseout="out('-6745962823678362300');" style="">  37 import nodomain.freeyourgadget.gadgetbridge.devices.pebble.PebbleInstallable;                            </span>
<span class="4836892992022606579" onmouseenter="enter('4836892992022606579');" onmouseout="out('4836892992022606579');" style="">  38 import nodomain.freeyourgadget.gadgetbridge.impl.GBDevice;                                               </span>
<span class="-6775704228596592306" onmouseenter="enter('-6775704228596592306');" onmouseout="out('-6775704228596592306');" style="">  39 import nodomain.freeyourgadget.gadgetbridge.impl.GBDeviceApp;                                            </span>
<span class="-1754164907108633436" onmouseenter="enter('-1754164907108633436');" onmouseout="out('-1754164907108633436');" style="">  40 import nodomain.freeyourgadget.gadgetbridge.service.devices.pebble.ble.PebbleLESupport;                  </span>
<span class="-211901022449891328" onmouseenter="enter('-211901022449891328');" onmouseout="out('-211901022449891328');" style="">  41 import nodomain.freeyourgadget.gadgetbridge.service.serial.GBDeviceIoThread;                             </span>
<span class="-2195471833159259314" onmouseenter="enter('-2195471833159259314');" onmouseout="out('-2195471833159259314');" style="">  42 import nodomain.freeyourgadget.gadgetbridge.service.serial.GBDeviceProtocol;                             </span>
<span class="-2020231768395052380" onmouseenter="enter('-2020231768395052380');" onmouseout="out('-2020231768395052380');" style="">  43 import nodomain.freeyourgadget.gadgetbridge.util.FileUtils;                                              </span>
<span class="-3798970344596478499" onmouseenter="enter('-3798970344596478499');" onmouseout="out('-3798970344596478499');" style="">  44 import nodomain.freeyourgadget.gadgetbridge.util.GB;                                                     </span>
<span class="4645284583739884744" onmouseenter="enter('4645284583739884744');" onmouseout="out('4645284583739884744');" style="">  45 import nodomain.freeyourgadget.gadgetbridge.util.PebbleUtils;                                            </span>
<span class="-600862318521663319" onmouseenter="enter('-600862318521663319');" onmouseout="out('-600862318521663319');" style="">  46 import nodomain.freeyourgadget.gadgetbridge.util.Prefs;                                                  </span>
<span class="-425744571032727695" onmouseenter="enter('-425744571032727695');" onmouseout="out('-425744571032727695');" style="">  47 import nodomain.freeyourgadget.gadgetbridge.util.WebViewSingleton;                                       </span>
<span  style="">  48                                                                                                          </span>
<span class="2468896418036970449" onmouseenter="enter('2468896418036970449');" onmouseout="out('2468896418036970449');" style="">  49 class PebbleIoThread extends GBDeviceIoThread {                                                          </span>
<span class="2529670288626938632" onmouseenter="enter('2529670288626938632');" onmouseout="out('2529670288626938632');" style="">  50     private static final Logger LOG = LoggerFactory.getLogger(PebbleIoThread.class);                     </span>
<span  style="">  51                                                                                                          </span>
<span class="-4632193205469069671" onmouseenter="enter('-4632193205469069671');" onmouseout="out('-4632193205469069671');" style="">  52     private final Prefs prefs = GBApplication.getPrefs();                                                </span>
<span  style="">  53                                                                                                          </span>
<span class="-6631401332787692352" onmouseenter="enter('-6631401332787692352');" onmouseout="out('-6631401332787692352');" style="">  54     private final PebbleProtocol mPebbleProtocol;                                                        </span>
<span class="1328262475374241602" onmouseenter="enter('1328262475374241602');" onmouseout="out('1328262475374241602');" style="">  55     private final PebbleSupport mPebbleSupport;                                                          </span>
<span class="-2685935515172486802" onmouseenter="enter('-2685935515172486802');" onmouseout="out('-2685935515172486802');" style="">  56     private PebbleKitSupport mPebbleKitSupport;                                                          </span>
<span class="5255281464364524557" onmouseenter="enter('5255281464364524557');" onmouseout="out('5255281464364524557');" style="">  57     private final boolean mEnablePebblekit;                                                              </span>
<span  style="">  58                                                                                                          </span>
<span class="-1663504808667212623" onmouseenter="enter('-1663504808667212623');" onmouseout="out('-1663504808667212623');" style="">  59     private boolean mIsTCP = false;                                                                      </span>
<span class="7891956114489637668" onmouseenter="enter('7891956114489637668');" onmouseout="out('7891956114489637668');" style="">  60     private BluetoothAdapter mBtAdapter = null;                                                          </span>
<span class="-3474230100367526093" onmouseenter="enter('-3474230100367526093');" onmouseout="out('-3474230100367526093');" style="">  61     private BluetoothSocket mBtSocket = null;                                                            </span>
<span class="4972621324459114153" onmouseenter="enter('4972621324459114153');" onmouseout="out('4972621324459114153');" style="">  62     private Socket mTCPSocket = null; // for emulator                                                    </span>
<span class="8464954913827308931" onmouseenter="enter('8464954913827308931');" onmouseout="out('8464954913827308931');" style="">  63     private InputStream mInStream = null;                                                                </span>
<span class="176817746371882191" onmouseenter="enter('176817746371882191');" onmouseout="out('176817746371882191');" style="">  64     private OutputStream mOutStream = null;                                                              </span>
<span class="3507668063671934062" onmouseenter="enter('3507668063671934062');" onmouseout="out('3507668063671934062');" style="">  65     private PebbleLESupport mPebbleLESupport;                                                            </span>
<span  style="">  66                                                                                                          </span>
<span class="8291227991234502986" onmouseenter="enter('8291227991234502986');" onmouseout="out('8291227991234502986');" style="">  67     private boolean mQuit = false;                                                                       </span>
<span class="-4308649044970502514" onmouseenter="enter('-4308649044970502514');" onmouseout="out('-4308649044970502514');" style="">  68     private boolean mIsConnected = false;                                                                </span>
<span class="591172670703241498" onmouseenter="enter('591172670703241498');" onmouseout="out('591172670703241498');" style="">  69     private boolean mIsInstalling = false;                                                               </span>
<span  style="">  70                                                                                                          </span>
<span class="7746276727914849634" onmouseenter="enter('7746276727914849634');" onmouseout="out('7746276727914849634');" style="">  71     private PBWReader mPBWReader = null;                                                                 </span>
<span class="1166586313023966318" onmouseenter="enter('1166586313023966318');" onmouseout="out('1166586313023966318');" style="">  72     private GBDeviceApp mCurrentlyInstallingApp = null;                                                  </span>
<span class="-1645742411754742536" onmouseenter="enter('-1645742411754742536');" onmouseout="out('-1645742411754742536');" style="">  73     private int mAppInstallToken = -1;                                                                   </span>
<span class="-3680441812231545667" onmouseenter="enter('-3680441812231545667');" onmouseout="out('-3680441812231545667');" style="">  74     private InputStream mFis = null;                                                                     </span>
<span class="8056811120544011853" onmouseenter="enter('8056811120544011853');" onmouseout="out('8056811120544011853');" style="">  75     private PebbleAppInstallState mInstallState = PebbleAppInstallState.UNKNOWN;                         </span>
<span class="2315852437300231853" onmouseenter="enter('2315852437300231853');" onmouseout="out('2315852437300231853');" style="">  76     private PebbleInstallable[] mPebbleInstallables = null;                                              </span>
<span class="-6610002799635202363" onmouseenter="enter('-6610002799635202363');" onmouseout="out('-6610002799635202363');" style="">  77     private int mCurrentInstallableIndex = -1;                                                           </span>
<span class="-6569382683370215618" onmouseenter="enter('-6569382683370215618');" onmouseout="out('-6569382683370215618');" style="">  78     private int mInstallSlot = -2;                                                                       </span>
<span class="-8194648222476538160" onmouseenter="enter('-8194648222476538160');" onmouseout="out('-8194648222476538160');" style="">  79     private int mCRC = -1;                                                                               </span>
<span class="-2481332028036817904" onmouseenter="enter('-2481332028036817904');" onmouseout="out('-2481332028036817904');" style="">  80     private int mBinarySize = -1;                                                                        </span>
<span class="-1832879895999614218" onmouseenter="enter('-1832879895999614218');" onmouseout="out('-1832879895999614218');" style="">  81     private int mBytesWritten = -1;                                                                      </span>
<span  style="">  82                                                                                                          </span>
<span class="-4667942192763773056" onmouseenter="enter('-4667942192763773056');" onmouseout="out('-4667942192763773056');" style="">  83 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours                                                                             </span>
<span class="8914325663092470246" onmouseenter="enter('8914325663092470246');" onmouseout="out('8914325663092470246');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  84     private final BroadcastReceiver mPebbleKitReceiver = new BroadcastReceiver() {                       </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  85         @Override                                                                                        </span>
<span class="-1520739091809898546" onmouseenter="enter('-1520739091809898546');" onmouseout="out('-1520739091809898546');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  86         public void onReceive(Context context, Intent intent) {                                          </span>
<span class="5344227773413700857" onmouseenter="enter('5344227773413700857');" onmouseout="out('5344227773413700857');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  87             String action = intent.getAction();                                                          </span>
<span class="-2767557360944414006" onmouseenter="enter('-2767557360944414006');" onmouseout="out('-2767557360944414006');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  88             LOG.info(&quot;Got action: &quot; + action);                                                           </span>
<span class="8190723481817549581" onmouseenter="enter('8190723481817549581');" onmouseout="out('8190723481817549581');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  89             UUID uuid;                                                                                   </span>
<span class="6099627150369302694" onmouseenter="enter('6099627150369302694');" onmouseout="out('6099627150369302694');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  90             switch (action) {                                                                            </span>
<span class="-5607690174400779115" onmouseenter="enter('-5607690174400779115');" onmouseout="out('-5607690174400779115');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  91                 case PEBBLEKIT_ACTION_APP_START:                                                         </span>
<span class="-1756369772806174160" onmouseenter="enter('-1756369772806174160');" onmouseout="out('-1756369772806174160');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  92                 case PEBBLEKIT_ACTION_APP_STOP:                                                          </span>
<span class="-185467528302823505" onmouseenter="enter('-185467528302823505');" onmouseout="out('-185467528302823505');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  93                     uuid = (UUID) intent.getSerializableExtra(&quot;uuid&quot;);                                   </span>
<span class="6094803455832882033" onmouseenter="enter('6094803455832882033');" onmouseout="out('6094803455832882033');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  94                     if (uuid != null) {                                                                  </span>
<span class="-3038014536715207103" onmouseenter="enter('-3038014536715207103');" onmouseout="out('-3038014536715207103');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title="  95                         write(mPebbleProtocol.encodeAppStart(uuid, action.equals(PEBBLEKIT_ACTION_APP_START)));">  95                         write(mPebbleProtocol.encodeAppStart(uuid, action.equals(PEBBLEKIT_ACTION_APP_STAðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  96                     }                                                                                    </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  97                     break;                                                                               </span>
<span class="3550381777945223205" onmouseenter="enter('3550381777945223205');" onmouseout="out('3550381777945223205');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  98                 case PEBBLEKIT_ACTION_APP_SEND:                                                          </span>
<span class="8746871362101842242" onmouseenter="enter('8746871362101842242');" onmouseout="out('8746871362101842242');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  99                     int transaction_id = intent.getIntExtra(&quot;transaction_id&quot;, -1);                       </span>
<span class="-185467528302823505" onmouseenter="enter('-185467528302823505');" onmouseout="out('-185467528302823505');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 100                     uuid = (UUID) intent.getSerializableExtra(&quot;uuid&quot;);                                   </span>
<span class="115505315270435118" onmouseenter="enter('115505315270435118');" onmouseout="out('115505315270435118');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 101                     String jsonString = intent.getStringExtra(&quot;msg_data&quot;);                               </span>
<span class="1347360621013773363" onmouseenter="enter('1347360621013773363');" onmouseout="out('1347360621013773363');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 102                     LOG.info(&quot;json string: &quot; + jsonString);                                              </span>
<span  style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 103                                                                                                          </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 104                     try {                                                                                </span>
<span class="6685187839340796030" onmouseenter="enter('6685187839340796030');" onmouseout="out('6685187839340796030');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 105                         JSONArray jsonArray = new JSONArray(jsonString);                                 </span>
<span class="1915657714539023329" onmouseenter="enter('1915657714539023329');" onmouseout="out('1915657714539023329');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 106                         write(mPebbleProtocol.encodeApplicationMessageFromJSON(uuid, jsonArray));        </span>
<span class="4286948008967663548" onmouseenter="enter('4286948008967663548');" onmouseout="out('4286948008967663548');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 107                         sendAppMessageAck(transaction_id);                                               </span>
<span  style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 108                                                                                                          </span>
<span class="2021063483207698984" onmouseenter="enter('2021063483207698984');" onmouseout="out('2021063483207698984');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 109                     } catch (JSONException e) {                                                          </span>
<span class="4090663313211582937" onmouseenter="enter('4090663313211582937');" onmouseout="out('4090663313211582937');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 110                         e.printStackTrace();                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 111                     }                                                                                    </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 112                     break;                                                                               </span>
<span class="-4575626246346919371" onmouseenter="enter('-4575626246346919371');" onmouseout="out('-4575626246346919371');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 113                 case PEBBLEKIT_ACTION_APP_ACK:                                                           </span>
<span class="-5397546053733935151" onmouseenter="enter('-5397546053733935151');" onmouseout="out('-5397546053733935151');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 114                     // we do not get a uuid and cannot map a transaction id to it, so we ack in PebbleProtocol early"> 114                     // we do not get a uuid and cannot map a transaction id to it, so we ack in PebbleProðŸ”µ</abbr></span>
<span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 115                     /*                                                                                   </span>
<span class="-185467528302823505" onmouseenter="enter('-185467528302823505');" onmouseout="out('-185467528302823505');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 116                     uuid = (UUID) intent.getSerializableExtra(&quot;uuid&quot;);                                   </span>
<span class="8746871362101842242" onmouseenter="enter('8746871362101842242');" onmouseout="out('8746871362101842242');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 117                     int transaction_id = intent.getIntExtra(&quot;transaction_id&quot;, -1);                       </span>
<span class="-5460339056046386879" onmouseenter="enter('-5460339056046386879');" onmouseout="out('-5460339056046386879');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 118                     if (transaction_id &gt;= 0 &amp;&amp; transaction_id &lt;= 255) {                                  </span>
<span class="-1247931610264669179" onmouseenter="enter('-1247931610264669179');" onmouseout="out('-1247931610264669179');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 119                         write(mPebbleProtocol.encodeApplicationMessageAck(uuid, (byte) transaction_id)); </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 120                     } else {                                                                             </span>
<span class="9187855197608677341" onmouseenter="enter('9187855197608677341');" onmouseout="out('9187855197608677341');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 121                         LOG.warn(&quot;illegal transacktion id &quot; + transaction_id);                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 122                     }                                                                                    </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 123                     */                                                                                   </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 124                     break;                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 125             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 126         }                                                                                                </span>
<span class="2468309323999483380" onmouseenter="enter('2468309323999483380');" onmouseout="out('2468309323999483380');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 127     };                                                                                                   </span>
<span  style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 128                                                                                                          </span>
<span class="-8000809992863847428" onmouseenter="enter('-8000809992863847428');" onmouseout="out('-8000809992863847428');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 129     private void sendAppMessageJS(GBDeviceEventAppMessage appMessage) {                                  </span>
<span class="5061350280559930277" onmouseenter="enter('5061350280559930277');" onmouseout="out('5061350280559930277');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 130         WebViewSingleton.getorInitWebView(getContext(), gbDevice, appMessage.appUUID);                   </span>
<span class="-2478103463940331708" onmouseenter="enter('-2478103463940331708');" onmouseout="out('-2478103463940331708');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 131         WebViewSingleton.appMessage(appMessage.message);                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 132     }                                                                                                    </span>
<span  style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 133                                                                                                          </span>
<span class="-7621847952583919612" onmouseenter="enter('-7621847952583919612');" onmouseout="out('-7621847952583919612');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 134     private void sendAppMessageIntent(GBDeviceEventAppMessage appMessage) {                              </span>
<span class="535862575394010177" onmouseenter="enter('535862575394010177');" onmouseout="out('535862575394010177');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 135         Intent intent = new Intent();                                                                    </span>
<span class="-308940498243775713" onmouseenter="enter('-308940498243775713');" onmouseout="out('-308940498243775713');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 136         intent.setAction(PEBBLEKIT_ACTION_APP_RECEIVE);                                                  </span>
<span class="-4819521277987879596" onmouseenter="enter('-4819521277987879596');" onmouseout="out('-4819521277987879596');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 137         intent.putExtra(&quot;uuid&quot;, appMessage.appUUID);                                                     </span>
<span class="-4518626450248788495" onmouseenter="enter('-4518626450248788495');" onmouseout="out('-4518626450248788495');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 138         intent.putExtra(&quot;msg_data&quot;, appMessage.message);                                                 </span>
<span class="788400804283391840" onmouseenter="enter('788400804283391840');" onmouseout="out('788400804283391840');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 139         intent.putExtra(&quot;transaction_id&quot;, appMessage.id);                                                </span>
<span class="-877666395707968466" onmouseenter="enter('-877666395707968466');" onmouseout="out('-877666395707968466');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 140         LOG.info(&quot;broadcasting to uuid &quot; + appMessage.appUUID + &quot; transaction id: &quot; + appMessage.id + &quot; JSON: &quot; + appMessage.message);"> 140         LOG.info(&quot;broadcasting to uuid &quot; + appMessage.appUUID + &quot; transaction id: &quot; + appMessage.id + &quot; JðŸ”µ</abbr></span>
<span class="5781834444291540387" onmouseenter="enter('5781834444291540387');" onmouseout="out('5781834444291540387');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 141         getContext().sendBroadcast(intent);                                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 142     }                                                                                                    </span>
<span  style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 143                                                                                                          </span>
<span class="6741223626729319096" onmouseenter="enter('6741223626729319096');" onmouseout="out('6741223626729319096');" style=""> 144 ||||||| GitAnalyzerPlus_base                                                                             </span>
<span class="-4308649044970502514" onmouseenter="enter('-4308649044970502514');" onmouseout="out('-4308649044970502514');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 145     private boolean mIsConnected = false;                                                                </span>
<span class="591172670703241498" onmouseenter="enter('591172670703241498');" onmouseout="out('591172670703241498');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 146     private boolean mIsInstalling = false;                                                               </span>
<span  style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 147                                                                                                          </span>
<span class="7746276727914849634" onmouseenter="enter('7746276727914849634');" onmouseout="out('7746276727914849634');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 148     private PBWReader mPBWReader = null;                                                                 </span>
<span class="1166586313023966318" onmouseenter="enter('1166586313023966318');" onmouseout="out('1166586313023966318');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 149     private GBDeviceApp mCurrentlyInstallingApp = null;                                                  </span>
<span class="-1645742411754742536" onmouseenter="enter('-1645742411754742536');" onmouseout="out('-1645742411754742536');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 150     private int mAppInstallToken = -1;                                                                   </span>
<span class="-3680441812231545667" onmouseenter="enter('-3680441812231545667');" onmouseout="out('-3680441812231545667');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 151     private InputStream mFis = null;                                                                     </span>
<span class="8056811120544011853" onmouseenter="enter('8056811120544011853');" onmouseout="out('8056811120544011853');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 152     private PebbleAppInstallState mInstallState = PebbleAppInstallState.UNKNOWN;                         </span>
<span class="2315852437300231853" onmouseenter="enter('2315852437300231853');" onmouseout="out('2315852437300231853');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 153     private PebbleInstallable[] mPebbleInstallables = null;                                              </span>
<span class="-6610002799635202363" onmouseenter="enter('-6610002799635202363');" onmouseout="out('-6610002799635202363');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 154     private int mCurrentInstallableIndex = -1;                                                           </span>
<span class="-6569382683370215618" onmouseenter="enter('-6569382683370215618');" onmouseout="out('-6569382683370215618');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 155     private int mInstallSlot = -2;                                                                       </span>
<span class="-8194648222476538160" onmouseenter="enter('-8194648222476538160');" onmouseout="out('-8194648222476538160');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 156     private int mCRC = -1;                                                                               </span>
<span class="-2481332028036817904" onmouseenter="enter('-2481332028036817904');" onmouseout="out('-2481332028036817904');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 157     private int mBinarySize = -1;                                                                        </span>
<span class="-1832879895999614218" onmouseenter="enter('-1832879895999614218');" onmouseout="out('-1832879895999614218');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 158     private int mBytesWritten = -1;                                                                      </span>
<span  style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 159                                                                                                          </span>
<span class="8914325663092470246" onmouseenter="enter('8914325663092470246');" onmouseout="out('8914325663092470246');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 160     private final BroadcastReceiver mPebbleKitReceiver = new BroadcastReceiver() {                       </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 161         @Override                                                                                        </span>
<span class="-1520739091809898546" onmouseenter="enter('-1520739091809898546');" onmouseout="out('-1520739091809898546');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 162         public void onReceive(Context context, Intent intent) {                                          </span>
<span class="5344227773413700857" onmouseenter="enter('5344227773413700857');" onmouseout="out('5344227773413700857');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 163             String action = intent.getAction();                                                          </span>
<span class="-2767557360944414006" onmouseenter="enter('-2767557360944414006');" onmouseout="out('-2767557360944414006');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 164             LOG.info(&quot;Got action: &quot; + action);                                                           </span>
<span class="8190723481817549581" onmouseenter="enter('8190723481817549581');" onmouseout="out('8190723481817549581');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 165             UUID uuid;                                                                                   </span>
<span class="6099627150369302694" onmouseenter="enter('6099627150369302694');" onmouseout="out('6099627150369302694');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 166             switch (action) {                                                                            </span>
<span class="-5607690174400779115" onmouseenter="enter('-5607690174400779115');" onmouseout="out('-5607690174400779115');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 167                 case PEBBLEKIT_ACTION_APP_START:                                                         </span>
<span class="-1756369772806174160" onmouseenter="enter('-1756369772806174160');" onmouseout="out('-1756369772806174160');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 168                 case PEBBLEKIT_ACTION_APP_STOP:                                                          </span>
<span class="-185467528302823505" onmouseenter="enter('-185467528302823505');" onmouseout="out('-185467528302823505');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 169                     uuid = (UUID) intent.getSerializableExtra(&quot;uuid&quot;);                                   </span>
<span class="6094803455832882033" onmouseenter="enter('6094803455832882033');" onmouseout="out('6094803455832882033');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 170                     if (uuid != null) {                                                                  </span>
<span class="-3038014536715207103" onmouseenter="enter('-3038014536715207103');" onmouseout="out('-3038014536715207103');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 171                         write(mPebbleProtocol.encodeAppStart(uuid, action.equals(PEBBLEKIT_ACTION_APP_START)));"> 171                         write(mPebbleProtocol.encodeAppStart(uuid, action.equals(PEBBLEKIT_ACTION_APP_STAðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 172                     }                                                                                    </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 173                     break;                                                                               </span>
<span class="3550381777945223205" onmouseenter="enter('3550381777945223205');" onmouseout="out('3550381777945223205');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 174                 case PEBBLEKIT_ACTION_APP_SEND:                                                          </span>
<span class="8746871362101842242" onmouseenter="enter('8746871362101842242');" onmouseout="out('8746871362101842242');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 175                     int transaction_id = intent.getIntExtra(&quot;transaction_id&quot;, -1);                       </span>
<span class="-185467528302823505" onmouseenter="enter('-185467528302823505');" onmouseout="out('-185467528302823505');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 176                     uuid = (UUID) intent.getSerializableExtra(&quot;uuid&quot;);                                   </span>
<span class="115505315270435118" onmouseenter="enter('115505315270435118');" onmouseout="out('115505315270435118');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 177                     String jsonString = intent.getStringExtra(&quot;msg_data&quot;);                               </span>
<span class="1347360621013773363" onmouseenter="enter('1347360621013773363');" onmouseout="out('1347360621013773363');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 178                     LOG.info(&quot;json string: &quot; + jsonString);                                              </span>
<span  style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 179                                                                                                          </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 180                     try {                                                                                </span>
<span class="6685187839340796030" onmouseenter="enter('6685187839340796030');" onmouseout="out('6685187839340796030');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 181                         JSONArray jsonArray = new JSONArray(jsonString);                                 </span>
<span class="1915657714539023329" onmouseenter="enter('1915657714539023329');" onmouseout="out('1915657714539023329');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 182                         write(mPebbleProtocol.encodeApplicationMessageFromJSON(uuid, jsonArray));        </span>
<span class="4286948008967663548" onmouseenter="enter('4286948008967663548');" onmouseout="out('4286948008967663548');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 183                         sendAppMessageAck(transaction_id);                                               </span>
<span  style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 184                                                                                                          </span>
<span class="2021063483207698984" onmouseenter="enter('2021063483207698984');" onmouseout="out('2021063483207698984');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 185                     } catch (JSONException e) {                                                          </span>
<span class="4090663313211582937" onmouseenter="enter('4090663313211582937');" onmouseout="out('4090663313211582937');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 186                         e.printStackTrace();                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 187                     }                                                                                    </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 188                     break;                                                                               </span>
<span class="-4575626246346919371" onmouseenter="enter('-4575626246346919371');" onmouseout="out('-4575626246346919371');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 189                 case PEBBLEKIT_ACTION_APP_ACK:                                                           </span>
<span class="-5397546053733935151" onmouseenter="enter('-5397546053733935151');" onmouseout="out('-5397546053733935151');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 190                     // we do not get a uuid and cannot map a transaction id to it, so we ack in PebbleProtocol early"> 190                     // we do not get a uuid and cannot map a transaction id to it, so we ack in PebbleProðŸ”µ</abbr></span>
<span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 191                     /*                                                                                   </span>
<span class="-185467528302823505" onmouseenter="enter('-185467528302823505');" onmouseout="out('-185467528302823505');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 192                     uuid = (UUID) intent.getSerializableExtra(&quot;uuid&quot;);                                   </span>
<span class="8746871362101842242" onmouseenter="enter('8746871362101842242');" onmouseout="out('8746871362101842242');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 193                     int transaction_id = intent.getIntExtra(&quot;transaction_id&quot;, -1);                       </span>
<span class="-5460339056046386879" onmouseenter="enter('-5460339056046386879');" onmouseout="out('-5460339056046386879');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 194                     if (transaction_id &gt;= 0 &amp;&amp; transaction_id &lt;= 255) {                                  </span>
<span class="-1247931610264669179" onmouseenter="enter('-1247931610264669179');" onmouseout="out('-1247931610264669179');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 195                         write(mPebbleProtocol.encodeApplicationMessageAck(uuid, (byte) transaction_id)); </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 196                     } else {                                                                             </span>
<span class="9187855197608677341" onmouseenter="enter('9187855197608677341');" onmouseout="out('9187855197608677341');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 197                         LOG.warn(&quot;illegal transacktion id &quot; + transaction_id);                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 198                     }                                                                                    </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 199                     */                                                                                   </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 200                     break;                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 201             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 202         }                                                                                                </span>
<span class="2468309323999483380" onmouseenter="enter('2468309323999483380');" onmouseout="out('2468309323999483380');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 203     };                                                                                                   </span>
<span  style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 204                                                                                                          </span>
<span class="-7621847952583919612" onmouseenter="enter('-7621847952583919612');" onmouseout="out('-7621847952583919612');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 205     private void sendAppMessageIntent(GBDeviceEventAppMessage appMessage) {                              </span>
<span class="535862575394010177" onmouseenter="enter('535862575394010177');" onmouseout="out('535862575394010177');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 206         Intent intent = new Intent();                                                                    </span>
<span class="-308940498243775713" onmouseenter="enter('-308940498243775713');" onmouseout="out('-308940498243775713');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 207         intent.setAction(PEBBLEKIT_ACTION_APP_RECEIVE);                                                  </span>
<span class="-4819521277987879596" onmouseenter="enter('-4819521277987879596');" onmouseout="out('-4819521277987879596');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 208         intent.putExtra(&quot;uuid&quot;, appMessage.appUUID);                                                     </span>
<span class="-4518626450248788495" onmouseenter="enter('-4518626450248788495');" onmouseout="out('-4518626450248788495');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 209         intent.putExtra(&quot;msg_data&quot;, appMessage.message);                                                 </span>
<span class="788400804283391840" onmouseenter="enter('788400804283391840');" onmouseout="out('788400804283391840');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 210         intent.putExtra(&quot;transaction_id&quot;, appMessage.id);                                                </span>
<span class="-877666395707968466" onmouseenter="enter('-877666395707968466');" onmouseout="out('-877666395707968466');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 211         LOG.info(&quot;broadcasting to uuid &quot; + appMessage.appUUID + &quot; transaction id: &quot; + appMessage.id + &quot; JSON: &quot; + appMessage.message);"> 211         LOG.info(&quot;broadcasting to uuid &quot; + appMessage.appUUID + &quot; transaction id: &quot; + appMessage.id + &quot; JðŸ”µ</abbr></span>
<span class="5781834444291540387" onmouseenter="enter('5781834444291540387');" onmouseout="out('5781834444291540387');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 212         getContext().sendBroadcast(intent);                                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 213     }                                                                                                    </span>
<span  style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 214                                                                                                          </span>
<span class="-1707422926868996417" onmouseenter="enter('-1707422926868996417');" onmouseout="out('-1707422926868996417');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 215     PebbleIoThread(PebbleSupport pebbleSupport, GBDevice gbDevice, GBDeviceProtocol gbDeviceProtocol, BluetoothAdapter btAdapter, Context context) {"> 215     PebbleIoThread(PebbleSupport pebbleSupport, GBDevice gbDevice, GBDeviceProtocol gbDeviceProtocol, BluðŸ”µ</abbr></span>
<span class="-4446577987516131269" onmouseenter="enter('-4446577987516131269');" onmouseout="out('-4446577987516131269');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 216         super(gbDevice, context);                                                                        </span>
<span class="-535847603056830094" onmouseenter="enter('-535847603056830094');" onmouseout="out('-535847603056830094');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 217         mPebbleProtocol = (PebbleProtocol) gbDeviceProtocol;                                             </span>
<span class="-7802515276203668031" onmouseenter="enter('-7802515276203668031');" onmouseout="out('-7802515276203668031');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 218         mBtAdapter = btAdapter;                                                                          </span>
<span class="-175348863880720182" onmouseenter="enter('-175348863880720182');" onmouseout="out('-175348863880720182');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 219         mPebbleSupport = pebbleSupport;                                                                  </span>
<span class="-766654887411083682" onmouseenter="enter('-766654887411083682');" onmouseout="out('-766654887411083682');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 220         mEnablePebblekit = prefs.getBoolean(&quot;pebble_enable_pebblekit&quot;, false);                           </span>
<span class="3796057323931724632" onmouseenter="enter('3796057323931724632');" onmouseout="out('3796057323931724632');" style=""> 221 =======                                                                                                  </span>
<span class="-1382546150375666264" onmouseenter="enter('-1382546150375666264');" onmouseout="out('-1382546150375666264');" style=""> 222 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs                                                                           </span>
<span class="-1707422926868996417" onmouseenter="enter('-1707422926868996417');" onmouseout="out('-1707422926868996417');" style=""><abbr title=" 223     PebbleIoThread(PebbleSupport pebbleSupport, GBDevice gbDevice, GBDeviceProtocol gbDeviceProtocol, BluetoothAdapter btAdapter, Context context) {"> 223     PebbleIoThread(PebbleSupport pebbleSupport, GBDevice gbDevice, GBDeviceProtocol gbDeviceProtocol, BluðŸ”µ</abbr></span>
<span class="-4446577987516131269" onmouseenter="enter('-4446577987516131269');" onmouseout="out('-4446577987516131269');" style=""> 224         super(gbDevice, context);                                                                        </span>
<span class="-535847603056830094" onmouseenter="enter('-535847603056830094');" onmouseout="out('-535847603056830094');" style=""> 225         mPebbleProtocol = (PebbleProtocol) gbDeviceProtocol;                                             </span>
<span class="-7802515276203668031" onmouseenter="enter('-7802515276203668031');" onmouseout="out('-7802515276203668031');" style=""> 226         mBtAdapter = btAdapter;                                                                          </span>
<span class="-175348863880720182" onmouseenter="enter('-175348863880720182');" onmouseout="out('-175348863880720182');" style=""> 227         mPebbleSupport = pebbleSupport;                                                                  </span>
<span class="-766654887411083682" onmouseenter="enter('-766654887411083682');" onmouseout="out('-766654887411083682');" style=""> 228         mEnablePebblekit = prefs.getBoolean(&quot;pebble_enable_pebblekit&quot;, false);                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 229     }                                                                                                    </span>
<span  style=""> 230                                                                                                          </span>
<span class="-2292081679562824726" onmouseenter="enter('-2292081679562824726');" onmouseout="out('-2292081679562824726');" style=""><abbr title=" 231     private int readWithException(InputStream inputStream, byte[] buffer, int byteOffset, int byteCount) throws IOException {"> 231     private int readWithException(InputStream inputStream, byte[] buffer, int byteOffset, int byteCount) ðŸ”µ</abbr></span>
<span class="4268945675950741459" onmouseenter="enter('4268945675950741459');" onmouseout="out('4268945675950741459');" style=""> 232         int ret = inputStream.read(buffer, byteOffset, byteCount);                                       </span>
<span class="3796083344931271004" onmouseenter="enter('3796083344931271004');" onmouseout="out('3796083344931271004');" style=""> 233         if (ret == -1) {                                                                                 </span>
<span class="8493867222528380496" onmouseenter="enter('8493867222528380496');" onmouseout="out('8493867222528380496');" style=""> 234             throw new IOException(&quot;broken pipe&quot;);                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 235         }                                                                                                </span>
<span class="1456633081770441725" onmouseenter="enter('1456633081770441725');" onmouseout="out('1456633081770441725');" style=""> 236         return ret;                                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 237     }                                                                                                    </span>
<span  style=""> 238                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 239     @Override                                                                                            </span>
<span class="-689441939839417419" onmouseenter="enter('-689441939839417419');" onmouseout="out('-689441939839417419');" style=""> 240     protected boolean connect() {                                                                        </span>
<span class="7179548470555074529" onmouseenter="enter('7179548470555074529');" onmouseout="out('7179548470555074529');" style=""> 241         String deviceAddress = gbDevice.getAddress();                                                    </span>
<span class="8603377014623514599" onmouseenter="enter('8603377014623514599');" onmouseout="out('8603377014623514599');" style=""> 242         GBDevice.State originalState = gbDevice.getState();                                              </span>
<span class="-2168554989878345062" onmouseenter="enter('-2168554989878345062');" onmouseout="out('-2168554989878345062');" style=""> 243         gbDevice.setState(GBDevice.State.CONNECTING);                                                    </span>
<span class="-6083303279196581322" onmouseenter="enter('-6083303279196581322');" onmouseout="out('-6083303279196581322');" style=""> 244         gbDevice.sendDeviceUpdateIntent(getContext());                                                   </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 245         try {                                                                                            </span>
<span class="-8563020019953546005" onmouseenter="enter('-8563020019953546005');" onmouseout="out('-8563020019953546005');" style=""> 246             // contains only one &quot;:&quot;? then it is addr:port                                               </span>
<span class="-146660580149754487" onmouseenter="enter('-146660580149754487');" onmouseout="out('-146660580149754487');" style=""> 247             int firstColon = deviceAddress.indexOf(&quot;:&quot;);                                                 </span>
<span class="5048700417952215836" onmouseenter="enter('5048700417952215836');" onmouseout="out('5048700417952215836');" style=""> 248             if (firstColon == deviceAddress.lastIndexOf(&quot;:&quot;)) {                                          </span>
<span class="-8977049560738769524" onmouseenter="enter('-8977049560738769524');" onmouseout="out('-8977049560738769524');" style=""> 249                 mIsTCP = true;                                                                           </span>
<span class="-6378857250762995034" onmouseenter="enter('-6378857250762995034');" onmouseout="out('-6378857250762995034');" style=""> 250                 InetAddress serverAddr = InetAddress.getByName(deviceAddress.substring(0, firstColon));  </span>
<span class="3468657720829688371" onmouseenter="enter('3468657720829688371');" onmouseout="out('3468657720829688371');" style=""><abbr title=" 251                 mTCPSocket = new Socket(serverAddr, Integer.parseInt(deviceAddress.substring(firstColon + 1)));"> 251                 mTCPSocket = new Socket(serverAddr, Integer.parseInt(deviceAddress.substring(firstColon +ðŸ”µ</abbr></span>
<span class="-6670767050188612078" onmouseenter="enter('-6670767050188612078');" onmouseout="out('-6670767050188612078');" style=""> 252                 mInStream = mTCPSocket.getInputStream();                                                 </span>
<span class="-6104065159882353101" onmouseenter="enter('-6104065159882353101');" onmouseout="out('-6104065159882353101');" style=""> 253                 mOutStream = mTCPSocket.getOutputStream();                                               </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 254             } else {                                                                                     </span>
<span class="4347759254647630465" onmouseenter="enter('4347759254647630465');" onmouseout="out('4347759254647630465');" style=""> 255                 mIsTCP = false;                                                                          </span>
<span class="6443654244968138967" onmouseenter="enter('6443654244968138967');" onmouseout="out('6443654244968138967');" style=""><abbr title=" 256                 if (gbDevice.getVolatileAddress() != null &amp;&amp; prefs.getBoolean(&quot;pebble_force_le&quot;, false)) {"> 256                 if (gbDevice.getVolatileAddress() != null &amp;&amp; prefs.getBoolean(&quot;pebble_force_le&quot;, false)) ðŸ”µ</abbr></span>
<span class="915290997518797062" onmouseenter="enter('915290997518797062');" onmouseout="out('915290997518797062');" style=""> 257                     deviceAddress = gbDevice.getVolatileAddress();                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 258                 }                                                                                        </span>
<span class="4786675468629518746" onmouseenter="enter('4786675468629518746');" onmouseout="out('4786675468629518746');" style=""> 259                 BluetoothDevice btDevice = mBtAdapter.getRemoteDevice(deviceAddress);                    </span>
<span class="335623565325713065" onmouseenter="enter('335623565325713065');" onmouseout="out('335623565325713065');" style=""> 260                 if (btDevice.getType() == BluetoothDevice.DEVICE_TYPE_LE) {                              </span>
<span class="8333508526895931889" onmouseenter="enter('8333508526895931889');" onmouseout="out('8333508526895931889');" style=""> 261                     LOG.info(&quot;This is a Pebble 2 or Pebble-LE/Pebble Time LE, will use BLE&quot;);            </span>
<span class="-3562679261979772904" onmouseenter="enter('-3562679261979772904');" onmouseout="out('-3562679261979772904');" style=""> 262                     mInStream = new PipedInputStream();                                                  </span>
<span class="6393093760748525382" onmouseenter="enter('6393093760748525382');" onmouseout="out('6393093760748525382');" style=""> 263                     mOutStream = new PipedOutputStream();                                                </span>
<span class="2915722355401222377" onmouseenter="enter('2915722355401222377');" onmouseout="out('2915722355401222377');" style=""><abbr title=" 264                     mPebbleLESupport = new PebbleLESupport(this.getContext(), btDevice, (PipedInputStream) mInStream, (PipedOutputStream) mOutStream);"> 264                     mPebbleLESupport = new PebbleLESupport(this.getContext(), btDevice, (PipedInputStreamðŸ”µ</abbr></span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 265                 } else {                                                                                 </span>
<span class="8228468292686787155" onmouseenter="enter('8228468292686787155');" onmouseout="out('8228468292686787155');" style=""> 266                     ParcelUuid uuids[] = btDevice.getUuids();                                            </span>
<span class="2503839032557077084" onmouseenter="enter('2503839032557077084');" onmouseout="out('2503839032557077084');" style=""> 267                     if (uuids == null) {                                                                 </span>
<span class="-5432226360745882584" onmouseenter="enter('-5432226360745882584');" onmouseout="out('-5432226360745882584');" style=""> 268                         return false;                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 269                     }                                                                                    </span>
<span class="8104594939174164082" onmouseenter="enter('8104594939174164082');" onmouseout="out('8104594939174164082');" style=""> 270                     for (ParcelUuid uuid : uuids) {                                                      </span>
<span class="5496152670479511454" onmouseenter="enter('5496152670479511454');" onmouseout="out('5496152670479511454');" style=""> 271                         LOG.info(&quot;found service UUID &quot; + uuid);                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 272                     }                                                                                    </span>
<span class="-2085322778834697972" onmouseenter="enter('-2085322778834697972');" onmouseout="out('-2085322778834697972');" style=""> 273                     mBtSocket = btDevice.createRfcommSocketToServiceRecord(uuids[0].getUuid());          </span>
<span class="-617547228937795237" onmouseenter="enter('-617547228937795237');" onmouseout="out('-617547228937795237');" style=""> 274                     mBtSocket.connect();                                                                 </span>
<span class="-4553264448616972703" onmouseenter="enter('-4553264448616972703');" onmouseout="out('-4553264448616972703');" style=""> 275                     mInStream = mBtSocket.getInputStream();                                              </span>
<span class="-4296883704518407532" onmouseenter="enter('-4296883704518407532');" onmouseout="out('-4296883704518407532');" style=""> 276                     mOutStream = mBtSocket.getOutputStream();                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 277                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 278             }                                                                                            </span>
<span class="7080241092423381085" onmouseenter="enter('7080241092423381085');" onmouseout="out('7080241092423381085');" style=""> 279         } catch (IOException e) {                                                                        </span>
<span class="4090663313211582937" onmouseenter="enter('4090663313211582937');" onmouseout="out('4090663313211582937');" style=""> 280             e.printStackTrace();                                                                         </span>
<span class="5984241666527947087" onmouseenter="enter('5984241666527947087');" onmouseout="out('5984241666527947087');" style=""> 281             gbDevice.setState(originalState);                                                            </span>
<span class="-6083303279196581322" onmouseenter="enter('-6083303279196581322');" onmouseout="out('-6083303279196581322');" style=""> 282             gbDevice.sendDeviceUpdateIntent(getContext());                                               </span>
<span  style=""> 283                                                                                                          </span>
<span class="3085765988076808372" onmouseenter="enter('3085765988076808372');" onmouseout="out('3085765988076808372');" style=""> 284             mInStream = null;                                                                            </span>
<span class="4968882532143556776" onmouseenter="enter('4968882532143556776');" onmouseout="out('4968882532143556776');" style=""> 285             mOutStream = null;                                                                           </span>
<span class="-4534501040604870855" onmouseenter="enter('-4534501040604870855');" onmouseout="out('-4534501040604870855');" style=""> 286             mBtSocket = null;                                                                            </span>
<span class="-5432226360745882584" onmouseenter="enter('-5432226360745882584');" onmouseout="out('-5432226360745882584');" style=""> 287             return false;                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 288         }                                                                                                </span>
<span  style=""> 289                                                                                                          </span>
<span class="1677595949374963054" onmouseenter="enter('1677595949374963054');" onmouseout="out('1677595949374963054');" style=""> 290         mPebbleProtocol.setForceProtocol(prefs.getBoolean(&quot;pebble_force_protocol&quot;, false));              </span>
<span  style=""> 291                                                                                                          </span>
<span class="5928608366163593597" onmouseenter="enter('5928608366163593597');" onmouseout="out('5928608366163593597');" style=""> 292         mIsConnected = true;                                                                             </span>
<span class="3321416181738117978" onmouseenter="enter('3321416181738117978');" onmouseout="out('3321416181738117978');" style=""> 293         write(mPebbleProtocol.encodeFirmwareVersionReq());                                               </span>
<span class="-7904642316416307948" onmouseenter="enter('-7904642316416307948');" onmouseout="out('-7904642316416307948');" style=""> 294         gbDevice.setState(GBDevice.State.CONNECTED);                                                     </span>
<span class="-6083303279196581322" onmouseenter="enter('-6083303279196581322');" onmouseout="out('-6083303279196581322');" style=""> 295         gbDevice.sendDeviceUpdateIntent(getContext());                                                   </span>
<span  style=""> 296                                                                                                          </span>
<span class="-3118901906653197100" onmouseenter="enter('-3118901906653197100');" onmouseout="out('-3118901906653197100');" style=""> 297         return true;                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 298     }                                                                                                    </span>
<span  style=""> 299                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 300     @Override                                                                                            </span>
<span class="5292860430507443886" onmouseenter="enter('5292860430507443886');" onmouseout="out('5292860430507443886');" style=""> 301     public void run() {                                                                                  </span>
<span class="-2588539367217579258" onmouseenter="enter('-2588539367217579258');" onmouseout="out('-2588539367217579258');" style=""> 302         mIsConnected = connect();                                                                        </span>
<span class="-245134013635442990" onmouseenter="enter('-245134013635442990');" onmouseout="out('-245134013635442990');" style=""> 303         if (!mIsConnected) {                                                                             </span>
<span class="2633273029186728772" onmouseenter="enter('2633273029186728772');" onmouseout="out('2633273029186728772');" style=""> 304             if (GBApplication.getGBPrefs().getAutoReconnect() &amp;&amp; !mQuit) {                               </span>
<span class="3557129149179391090" onmouseenter="enter('3557129149179391090');" onmouseout="out('3557129149179391090');" style=""> 305                 gbDevice.setState(GBDevice.State.WAITING_FOR_RECONNECT);                                 </span>
<span class="-6083303279196581322" onmouseenter="enter('-6083303279196581322');" onmouseout="out('-6083303279196581322');" style=""> 306                 gbDevice.sendDeviceUpdateIntent(getContext());                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 307             }                                                                                            </span>
<span class="4043029072030362567" onmouseenter="enter('4043029072030362567');" onmouseout="out('4043029072030362567');" style=""> 308             return;                                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 309         }                                                                                                </span>
<span  style=""> 310                                                                                                          </span>
<span class="2624641968800564380" onmouseenter="enter('2624641968800564380');" onmouseout="out('2624641968800564380');" style=""> 311         byte[] buffer = new byte[8192];                                                                  </span>
<span class="8018073170313256099" onmouseenter="enter('8018073170313256099');" onmouseout="out('8018073170313256099');" style=""> 312         enablePebbleKitSupport(true);                                                                    </span>
<span class="-8765366791852935627" onmouseenter="enter('-8765366791852935627');" onmouseout="out('-8765366791852935627');" style=""> 313         mQuit = false;                                                                                   </span>
<span class="-6588719847383972316" onmouseenter="enter('-6588719847383972316');" onmouseout="out('-6588719847383972316');" style=""> 314         while (!mQuit) {                                                                                 </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 315             try {                                                                                        </span>
<span class="-8278348814669106484" onmouseenter="enter('-8278348814669106484');" onmouseout="out('-8278348814669106484');" style=""> 316                 if (mIsInstalling) {                                                                     </span>
<span class="8684367013652331710" onmouseenter="enter('8684367013652331710');" onmouseout="out('8684367013652331710');" style=""> 317                     switch (mInstallState) {                                                             </span>
<span class="7026400303061140058" onmouseenter="enter('7026400303061140058');" onmouseout="out('7026400303061140058');" style=""> 318                         case WAIT_SLOT:                                                                  </span>
<span class="-2690055123266986251" onmouseenter="enter('-2690055123266986251');" onmouseout="out('-2690055123266986251');" style=""> 319                             if (mInstallSlot == -1) {                                                    </span>
<span class="-3606888775151099353" onmouseenter="enter('-3606888775151099353');" onmouseout="out('-3606888775151099353');" style=""> 320                                 finishInstall(true); // no slots available                               </span>
<span class="2295401759568749857" onmouseenter="enter('2295401759568749857');" onmouseout="out('2295401759568749857');" style=""> 321                             } else if (mInstallSlot &gt;= 0) {                                              </span>
<span class="6147346456613268497" onmouseenter="enter('6147346456613268497');" onmouseout="out('6147346456613268497');" style=""> 322                                 mInstallState = PebbleAppInstallState.START_INSTALL;                     </span>
<span class="-6362435147834875541" onmouseenter="enter('-6362435147834875541');" onmouseout="out('-6362435147834875541');" style=""> 323                                 continue;                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 324                             }                                                                            </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 325                             break;                                                                       </span>
<span class="-3962643594977912505" onmouseenter="enter('-3962643594977912505');" onmouseout="out('-3962643594977912505');" style=""> 326                         case START_INSTALL:                                                              </span>
<span class="-5574718196482043222" onmouseenter="enter('-5574718196482043222');" onmouseout="out('-5574718196482043222');" style=""> 327                             LOG.info(&quot;start installing app binary&quot;);                                     </span>
<span class="5478053508733530178" onmouseenter="enter('5478053508733530178');" onmouseout="out('5478053508733530178');" style=""> 328                             PebbleInstallable pi = mPebbleInstallables[mCurrentInstallableIndex];        </span>
<span class="3659756883627403325" onmouseenter="enter('3659756883627403325');" onmouseout="out('3659756883627403325');" style=""> 329                             mFis = mPBWReader.getInputStreamFile(pi.getFileName());                      </span>
<span class="5016659144309369034" onmouseenter="enter('5016659144309369034');" onmouseout="out('5016659144309369034');" style=""> 330                             mCRC = pi.getCRC();                                                          </span>
<span class="3142625636824209099" onmouseenter="enter('3142625636824209099');" onmouseout="out('3142625636824209099');" style=""> 331                             mBinarySize = pi.getFileSize();                                              </span>
<span class="4161899041554384973" onmouseenter="enter('4161899041554384973');" onmouseout="out('4161899041554384973');" style=""> 332                             mBytesWritten = 0;                                                           </span>
<span class="-1767419274223935649" onmouseenter="enter('-1767419274223935649');" onmouseout="out('-1767419274223935649');" style=""><abbr title=" 333                             writeInstallApp(mPebbleProtocol.encodeUploadStart(pi.getType(), mInstallSlot, mBinarySize, mPBWReader.isLanguage() ? &quot;lang&quot; : null));"> 333                             writeInstallApp(mPebbleProtocol.encodeUploadStart(pi.getType(), mInstallSlot,ðŸ”µ</abbr></span>
<span class="-556680889075439690" onmouseenter="enter('-556680889075439690');" onmouseout="out('-556680889075439690');" style=""> 334                             mAppInstallToken = -1;                                                       </span>
<span class="-7999689873557895203" onmouseenter="enter('-7999689873557895203');" onmouseout="out('-7999689873557895203');" style=""> 335                             mInstallState = PebbleAppInstallState.WAIT_TOKEN;                            </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 336                             break;                                                                       </span>
<span class="6792169580692674220" onmouseenter="enter('6792169580692674220');" onmouseout="out('6792169580692674220');" style=""> 337                         case WAIT_TOKEN:                                                                 </span>
<span class="-3832708479724599095" onmouseenter="enter('-3832708479724599095');" onmouseout="out('-3832708479724599095');" style=""> 338                             if (mAppInstallToken != -1) {                                                </span>
<span class="-8049659333726333512" onmouseenter="enter('-8049659333726333512');" onmouseout="out('-8049659333726333512');" style=""> 339                                 LOG.info(&quot;got token &quot; + mAppInstallToken);                               </span>
<span class="5531590291586303132" onmouseenter="enter('5531590291586303132');" onmouseout="out('5531590291586303132');" style=""> 340                                 mInstallState = PebbleAppInstallState.UPLOAD_CHUNK;                      </span>
<span class="-6362435147834875541" onmouseenter="enter('-6362435147834875541');" onmouseout="out('-6362435147834875541');" style=""> 341                                 continue;                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 342                             }                                                                            </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 343                             break;                                                                       </span>
<span class="-584114172413593495" onmouseenter="enter('-584114172413593495');" onmouseout="out('-584114172413593495');" style=""> 344                         case UPLOAD_CHUNK:                                                               </span>
<span class="1528466301664079417" onmouseenter="enter('1528466301664079417');" onmouseout="out('1528466301664079417');" style=""> 345                             int bytes = 0;                                                               </span>
<span class="3052837437029247759" onmouseenter="enter('3052837437029247759');" onmouseout="out('3052837437029247759');" style=""> 346                             do {                                                                         </span>
<span class="1834678701284410601" onmouseenter="enter('1834678701284410601');" onmouseout="out('1834678701284410601');" style=""> 347                                 int read = mFis.read(buffer, bytes, 2000 - bytes);                       </span>
<span class="-6442970889778139424" onmouseenter="enter('-6442970889778139424');" onmouseout="out('-6442970889778139424');" style=""> 348                                 if (read &lt;= 0) break;                                                    </span>
<span class="-8945043921272536992" onmouseenter="enter('-8945043921272536992');" onmouseout="out('-8945043921272536992');" style=""> 349                                 bytes += read;                                                           </span>
<span class="451207650617133464" onmouseenter="enter('451207650617133464');" onmouseout="out('451207650617133464');" style=""> 350                             } while (bytes &lt; 2000);                                                      </span>
<span  style=""> 351                                                                                                          </span>
<span class="6794246418348616673" onmouseenter="enter('6794246418348616673');" onmouseout="out('6794246418348616673');" style=""> 352                             if (bytes &gt; 0) {                                                             </span>
<span class="-5617191400623126363" onmouseenter="enter('-5617191400623126363');" onmouseout="out('-5617191400623126363');" style=""> 353                                 GB.updateInstallNotification(getContext().getString(                     </span>
<span class="4050487273412981374" onmouseenter="enter('4050487273412981374');" onmouseout="out('4050487273412981374');" style=""><abbr title=" 354                                         R.string.installing_binary_d_d, (mCurrentInstallableIndex + 1), mPebbleInstallables.length), true, (int) (((float) mBytesWritten / mBinarySize) * 100), getContext());"> 354                                         R.string.installing_binary_d_d, (mCurrentInstallableIndex + 1), mðŸ”µ</abbr></span>
<span class="-7477526339537165687" onmouseenter="enter('-7477526339537165687');" onmouseout="out('-7477526339537165687');" style=""><abbr title=" 355                                 writeInstallApp(mPebbleProtocol.encodeUploadChunk(mAppInstallToken, buffer, bytes));"> 355                                 writeInstallApp(mPebbleProtocol.encodeUploadChunk(mAppInstallToken, buffeðŸ”µ</abbr></span>
<span class="-4728151037181866094" onmouseenter="enter('-4728151037181866094');" onmouseout="out('-4728151037181866094');" style=""> 356                                 mBytesWritten += bytes;                                                  </span>
<span class="-556680889075439690" onmouseenter="enter('-556680889075439690');" onmouseout="out('-556680889075439690');" style=""> 357                                 mAppInstallToken = -1;                                                   </span>
<span class="-7999689873557895203" onmouseenter="enter('-7999689873557895203');" onmouseout="out('-7999689873557895203');" style=""> 358                                 mInstallState = PebbleAppInstallState.WAIT_TOKEN;                        </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 359                             } else {                                                                     </span>
<span class="-5094680563432242000" onmouseenter="enter('-5094680563432242000');" onmouseout="out('-5094680563432242000');" style=""> 360                                 mInstallState = PebbleAppInstallState.UPLOAD_COMMIT;                     </span>
<span class="-6362435147834875541" onmouseenter="enter('-6362435147834875541');" onmouseout="out('-6362435147834875541');" style=""> 361                                 continue;                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 362                             }                                                                            </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 363                             break;                                                                       </span>
<span class="4124538925361105547" onmouseenter="enter('4124538925361105547');" onmouseout="out('4124538925361105547');" style=""> 364                         case UPLOAD_COMMIT:                                                              </span>
<span class="-2966405575206880121" onmouseenter="enter('-2966405575206880121');" onmouseout="out('-2966405575206880121');" style=""> 365                             writeInstallApp(mPebbleProtocol.encodeUploadCommit(mAppInstallToken, mCRC)); </span>
<span class="-556680889075439690" onmouseenter="enter('-556680889075439690');" onmouseout="out('-556680889075439690');" style=""> 366                             mAppInstallToken = -1;                                                       </span>
<span class="-6886437457702083289" onmouseenter="enter('-6886437457702083289');" onmouseout="out('-6886437457702083289');" style=""> 367                             mInstallState = PebbleAppInstallState.WAIT_COMMIT;                           </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 368                             break;                                                                       </span>
<span class="-6760167966557106950" onmouseenter="enter('-6760167966557106950');" onmouseout="out('-6760167966557106950');" style=""> 369                         case WAIT_COMMIT:                                                                </span>
<span class="-3832708479724599095" onmouseenter="enter('-3832708479724599095');" onmouseout="out('-3832708479724599095');" style=""> 370                             if (mAppInstallToken != -1) {                                                </span>
<span class="-8049659333726333512" onmouseenter="enter('-8049659333726333512');" onmouseout="out('-8049659333726333512');" style=""> 371                                 LOG.info(&quot;got token &quot; + mAppInstallToken);                               </span>
<span class="-6772897424369466346" onmouseenter="enter('-6772897424369466346');" onmouseout="out('-6772897424369466346');" style=""> 372                                 mInstallState = PebbleAppInstallState.UPLOAD_COMPLETE;                   </span>
<span class="-6362435147834875541" onmouseenter="enter('-6362435147834875541');" onmouseout="out('-6362435147834875541');" style=""> 373                                 continue;                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 374                             }                                                                            </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 375                             break;                                                                       </span>
<span class="7185565864054148536" onmouseenter="enter('7185565864054148536');" onmouseout="out('7185565864054148536');" style=""> 376                         case UPLOAD_COMPLETE:                                                            </span>
<span class="5024538798090815598" onmouseenter="enter('5024538798090815598');" onmouseout="out('5024538798090815598');" style=""> 377                             writeInstallApp(mPebbleProtocol.encodeUploadComplete(mAppInstallToken));     </span>
<span class="-937796524014974666" onmouseenter="enter('-937796524014974666');" onmouseout="out('-937796524014974666');" style=""> 378                             if (++mCurrentInstallableIndex &lt; mPebbleInstallables.length) {               </span>
<span class="6147346456613268497" onmouseenter="enter('6147346456613268497');" onmouseout="out('6147346456613268497');" style=""> 379                                 mInstallState = PebbleAppInstallState.START_INSTALL;                     </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 380                             } else {                                                                     </span>
<span class="4645923661994641503" onmouseenter="enter('4645923661994641503');" onmouseout="out('4645923661994641503');" style=""> 381                                 mInstallState = PebbleAppInstallState.APP_REFRESH;                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 382                             }                                                                            </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 383                             break;                                                                       </span>
<span class="-4660819450142864885" onmouseenter="enter('-4660819450142864885');" onmouseout="out('-4660819450142864885');" style=""> 384                         case APP_REFRESH:                                                                </span>
<span class="1423594820264173048" onmouseenter="enter('1423594820264173048');" onmouseout="out('1423594820264173048');" style=""> 385                             if (mPBWReader.isFirmware()) {                                               </span>
<span class="7979692944967033784" onmouseenter="enter('7979692944967033784');" onmouseout="out('7979692944967033784');" style=""> 386                                 writeInstallApp(mPebbleProtocol.encodeInstallFirmwareComplete());        </span>
<span class="8670418135173104454" onmouseenter="enter('8670418135173104454');" onmouseout="out('8670418135173104454');" style=""> 387                                 finishInstall(false);                                                    </span>
<span class="-3229195631780864145" onmouseenter="enter('-3229195631780864145');" onmouseout="out('-3229195631780864145');" style=""> 388                             } else if (mPBWReader.isLanguage() || mPebbleProtocol.mFwMajor &gt;= 3) {       </span>
<span class="-3079811230585835514" onmouseenter="enter('-3079811230585835514');" onmouseout="out('-3079811230585835514');" style=""> 389                                 finishInstall(false); // FIXME: don&#x27;t know yet how to detect success     </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 390                             } else {                                                                     </span>
<span class="-3742154807253834306" onmouseenter="enter('-3742154807253834306');" onmouseout="out('-3742154807253834306');" style=""> 391                                 writeInstallApp(mPebbleProtocol.encodeAppRefresh(mInstallSlot));         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 392                             }                                                                            </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 393                             break;                                                                       </span>
<span class="-8178136317704390296" onmouseenter="enter('-8178136317704390296');" onmouseout="out('-8178136317704390296');" style=""> 394                         default:                                                                         </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 395                             break;                                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 396                     }                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 397                 }                                                                                        </span>
<span class="5578850974519966568" onmouseenter="enter('5578850974519966568');" onmouseout="out('5578850974519966568');" style=""> 398                 if (mIsTCP) {                                                                            </span>
<span class="4471698368272895479" onmouseenter="enter('4471698368272895479');" onmouseout="out('4471698368272895479');" style=""> 399                     mInStream.skip(6);                                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 400                 }                                                                                        </span>
<span class="2796952267402194740" onmouseenter="enter('2796952267402194740');" onmouseout="out('2796952267402194740');" style=""> 401                 int bytes = readWithException(mInStream, buffer, 0, 4);                                  </span>
<span  style=""> 402                                                                                                          </span>
<span class="-2171789871350536014" onmouseenter="enter('-2171789871350536014');" onmouseout="out('-2171789871350536014');" style=""> 403                 while (bytes &lt; 4) {                                                                      </span>
<span class="-5884925481451326841" onmouseenter="enter('-5884925481451326841');" onmouseout="out('-5884925481451326841');" style=""> 404                     bytes += readWithException(mInStream, buffer, bytes, 4 - bytes);                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 405                 }                                                                                        </span>
<span  style=""> 406                                                                                                          </span>
<span class="-7296955466977945724" onmouseenter="enter('-7296955466977945724');" onmouseout="out('-7296955466977945724');" style=""> 407                 ByteBuffer buf = ByteBuffer.wrap(buffer);                                                </span>
<span class="-8522898317938558799" onmouseenter="enter('-8522898317938558799');" onmouseout="out('-8522898317938558799');" style=""> 408                 buf.order(ByteOrder.BIG_ENDIAN);                                                         </span>
<span class="2800045307834810060" onmouseenter="enter('2800045307834810060');" onmouseout="out('2800045307834810060');" style=""> 409                 short length = buf.getShort();                                                           </span>
<span class="-8125815031192715923" onmouseenter="enter('-8125815031192715923');" onmouseout="out('-8125815031192715923');" style=""> 410                 short endpoint = buf.getShort();                                                         </span>
<span class="9045200348604116826" onmouseenter="enter('9045200348604116826');" onmouseout="out('9045200348604116826');" style=""> 411                 if (length &lt; 0 || length &gt; 8192) {                                                       </span>
<span class="9194134393824457103" onmouseenter="enter('9194134393824457103');" onmouseout="out('9194134393824457103');" style=""> 412                     LOG.info(&quot;invalid length &quot; + length);                                                </span>
<span class="-967764297694162849" onmouseenter="enter('-967764297694162849');" onmouseout="out('-967764297694162849');" style=""> 413                     while (mInStream.available() &gt; 0) {                                                  </span>
<span class="-1967224316023950474" onmouseenter="enter('-1967224316023950474');" onmouseout="out('-1967224316023950474');" style=""> 414                         readWithException(mInStream, buffer, 0, buffer.length); // read all              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 415                     }                                                                                    </span>
<span class="-6362435147834875541" onmouseenter="enter('-6362435147834875541');" onmouseout="out('-6362435147834875541');" style=""> 416                     continue;                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 417                 }                                                                                        </span>
<span  style=""> 418                                                                                                          </span>
<span class="8513682448486197246" onmouseenter="enter('8513682448486197246');" onmouseout="out('8513682448486197246');" style=""> 419                 bytes = readWithException(mInStream, buffer, 4, length);                                 </span>
<span class="-1011005986067945864" onmouseenter="enter('-1011005986067945864');" onmouseout="out('-1011005986067945864');" style=""> 420                 while (bytes &lt; length) {                                                                 </span>
<span class="-7104003189991341630" onmouseenter="enter('-7104003189991341630');" onmouseout="out('-7104003189991341630');" style=""> 421                     bytes += readWithException(mInStream, buffer, bytes + 4, length - bytes);            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 422                 }                                                                                        </span>
<span  style=""> 423                                                                                                          </span>
<span class="5578850974519966568" onmouseenter="enter('5578850974519966568');" onmouseout="out('5578850974519966568');" style=""> 424                 if (mIsTCP) {                                                                            </span>
<span class="5401038970459668826" onmouseenter="enter('5401038970459668826');" onmouseout="out('5401038970459668826');" style=""> 425                     mInStream.skip(2);                                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 426                 }                                                                                        </span>
<span  style=""> 427                                                                                                          </span>
<span class="-7909466471492476851" onmouseenter="enter('-7909466471492476851');" onmouseout="out('-7909466471492476851');" style=""> 428                 GBDeviceEvent deviceEvents[] = mPebbleProtocol.decodeResponse(buffer);                   </span>
<span class="-638626929611439615" onmouseenter="enter('-638626929611439615');" onmouseout="out('-638626929611439615');" style=""> 429                 if (deviceEvents == null) {                                                              </span>
<span class="-7056050649624941936" onmouseenter="enter('-7056050649624941936');" onmouseout="out('-7056050649624941936');" style=""> 430                     LOG.info(&quot;unhandled message to endpoint &quot; + endpoint + &quot; (&quot; + length + &quot; bytes)&quot;);   </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 431                 } else {                                                                                 </span>
<span class="1477693521293066497" onmouseenter="enter('1477693521293066497');" onmouseout="out('1477693521293066497');" style=""> 432                     for (GBDeviceEvent deviceEvent : deviceEvents) {                                     </span>
<span class="2097356587238774416" onmouseenter="enter('2097356587238774416');" onmouseout="out('2097356587238774416');" style=""> 433                         if (deviceEvent == null) {                                                       </span>
<span class="-6362435147834875541" onmouseenter="enter('-6362435147834875541');" onmouseout="out('-6362435147834875541');" style=""> 434                             continue;                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 435                         }                                                                                </span>
<span class="-236987672843521774" onmouseenter="enter('-236987672843521774');" onmouseout="out('-236987672843521774');" style=""> 436                         if (!evaluateGBDeviceEventPebble(deviceEvent)) {                                 </span>
<span class="7042821987734772133" onmouseenter="enter('7042821987734772133');" onmouseout="out('7042821987734772133');" style=""> 437                             mPebbleSupport.evaluateGBDeviceEvent(deviceEvent);                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 438                         }                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 439                     }                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 440                 }                                                                                        </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 441                 try {                                                                                    </span>
<span class="1958254861600319008" onmouseenter="enter('1958254861600319008');" onmouseout="out('1958254861600319008');" style=""> 442                     Thread.sleep(100);                                                                   </span>
<span class="-7528533024404460182" onmouseenter="enter('-7528533024404460182');" onmouseout="out('-7528533024404460182');" style=""> 443                 } catch (InterruptedException e) {                                                       </span>
<span class="4090663313211582937" onmouseenter="enter('4090663313211582937');" onmouseout="out('4090663313211582937');" style=""> 444                     e.printStackTrace();                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 445                 }                                                                                        </span>
<span class="7080241092423381085" onmouseenter="enter('7080241092423381085');" onmouseout="out('7080241092423381085');" style=""> 446             } catch (IOException e) {                                                                    </span>
<span class="-508556787667332479" onmouseenter="enter('-508556787667332479');" onmouseout="out('-508556787667332479');" style=""><abbr title=" 447                 if (e.getMessage() != null &amp;&amp; (e.getMessage().equals(&quot;broken pipe&quot;) || e.getMessage().contains(&quot;socket closed&quot;))) { //FIXME: this does not feel right"> 447                 if (e.getMessage() != null &amp;&amp; (e.getMessage().equals(&quot;broken pipe&quot;) || e.getMessage().conðŸ”µ</abbr></span>
<span class="3941064908834146545" onmouseenter="enter('3941064908834146545');" onmouseout="out('3941064908834146545');" style=""> 448                     LOG.info(e.getMessage());                                                            </span>
<span class="1054919517095572489" onmouseenter="enter('1054919517095572489');" onmouseout="out('1054919517095572489');" style=""> 449                     mIsConnected = false;                                                                </span>
<span class="1961225799194435069" onmouseenter="enter('1961225799194435069');" onmouseout="out('1961225799194435069');" style=""> 450                     int reconnectAttempts = prefs.getInt(&quot;pebble_reconnect_attempts&quot;, 10);               </span>
<span class="-786112365036832199" onmouseenter="enter('-786112365036832199');" onmouseout="out('-786112365036832199');" style=""><abbr title=" 451                     if (!mQuit &amp;&amp; GBApplication.getGBPrefs().getAutoReconnect() &amp;&amp; reconnectAttempts &gt; 0) {"> 451                     if (!mQuit &amp;&amp; GBApplication.getGBPrefs().getAutoReconnect() &amp;&amp; reconnectAttempts &gt; 0)ðŸ”µ</abbr></span>
<span class="3557129149179391090" onmouseenter="enter('3557129149179391090');" onmouseout="out('3557129149179391090');" style=""> 452                         gbDevice.setState(GBDevice.State.WAITING_FOR_RECONNECT);                         </span>
<span class="-6083303279196581322" onmouseenter="enter('-6083303279196581322');" onmouseout="out('-6083303279196581322');" style=""> 453                         gbDevice.sendDeviceUpdateIntent(getContext());                                   </span>
<span  style=""> 454                                                                                                          </span>
<span class="6110344959180570674" onmouseenter="enter('6110344959180570674');" onmouseout="out('6110344959180570674');" style=""> 455                         int delaySeconds = 1;                                                            </span>
<span class="-5190003264224859806" onmouseenter="enter('-5190003264224859806');" onmouseout="out('-5190003264224859806');" style=""> 456                         while (reconnectAttempts-- &gt; 0 &amp;&amp; !mQuit &amp;&amp; !mIsConnected) {                     </span>
<span class="-7641363597792416938" onmouseenter="enter('-7641363597792416938');" onmouseout="out('-7641363597792416938');" style=""> 457                             LOG.info(&quot;Trying to reconnect (attempts left &quot; + reconnectAttempts + &quot;)&quot;);   </span>
<span class="-2588539367217579258" onmouseenter="enter('-2588539367217579258');" onmouseout="out('-2588539367217579258');" style=""> 458                             mIsConnected = connect();                                                    </span>
<span class="-245134013635442990" onmouseenter="enter('-245134013635442990');" onmouseout="out('-245134013635442990');" style=""> 459                             if (!mIsConnected) {                                                         </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 460                                 try {                                                                    </span>
<span class="-3669672008793578674" onmouseenter="enter('-3669672008793578674');" onmouseout="out('-3669672008793578674');" style=""> 461                                     Thread.sleep(delaySeconds * 1000);                                   </span>
<span class="1010771762618413361" onmouseenter="enter('1010771762618413361');" onmouseout="out('1010771762618413361');" style=""> 462                                 } catch (InterruptedException ignored) {                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 463                                 }                                                                        </span>
<span class="-8988961353399164519" onmouseenter="enter('-8988961353399164519');" onmouseout="out('-8988961353399164519');" style=""> 464                                 if (delaySeconds &lt; 64) {                                                 </span>
<span class="4518640925202616859" onmouseenter="enter('4518640925202616859');" onmouseout="out('4518640925202616859');" style=""> 465                                     delaySeconds *= 2;                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 466                                 }                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 467                             }                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 468                         }                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 469                     }                                                                                    </span>
<span class="-245134013635442990" onmouseenter="enter('-245134013635442990');" onmouseout="out('-245134013635442990');" style=""> 470                     if (!mIsConnected) {                                                                 </span>
<span class="-4534501040604870855" onmouseenter="enter('-4534501040604870855');" onmouseout="out('-4534501040604870855');" style=""> 471                         mBtSocket = null;                                                                </span>
<span class="-3119559015644534035" onmouseenter="enter('-3119559015644534035');" onmouseout="out('-3119559015644534035');" style=""> 472                         LOG.info(&quot;Bluetooth socket closed, will quit IO Thread&quot;);                        </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 473                         break;                                                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 474                     }                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 475                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 476             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 477         }                                                                                                </span>
<span class="1054919517095572489" onmouseenter="enter('1054919517095572489');" onmouseout="out('1054919517095572489');" style=""> 478         mIsConnected = false;                                                                            </span>
<span class="-3944229288018059276" onmouseenter="enter('-3944229288018059276');" onmouseout="out('-3944229288018059276');" style=""> 479         if (mBtSocket != null) {                                                                         </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 480             try {                                                                                        </span>
<span class="4957759683762229483" onmouseenter="enter('4957759683762229483');" onmouseout="out('4957759683762229483');" style=""> 481                 mBtSocket.close();                                                                       </span>
<span class="7080241092423381085" onmouseenter="enter('7080241092423381085');" onmouseout="out('7080241092423381085');" style=""> 482             } catch (IOException e) {                                                                    </span>
<span class="4090663313211582937" onmouseenter="enter('4090663313211582937');" onmouseout="out('4090663313211582937');" style=""> 483                 e.printStackTrace();                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 484             }                                                                                            </span>
<span class="-4534501040604870855" onmouseenter="enter('-4534501040604870855');" onmouseout="out('-4534501040604870855');" style=""> 485             mBtSocket = null;                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 486         }                                                                                                </span>
<span  style=""> 487                                                                                                          </span>
<span class="-8029876522886293743" onmouseenter="enter('-8029876522886293743');" onmouseout="out('-8029876522886293743');" style=""> 488         enablePebbleKitSupport(false);                                                                   </span>
<span  style=""> 489                                                                                                          </span>
<span class="754428857450446437" onmouseenter="enter('754428857450446437');" onmouseout="out('754428857450446437');" style=""> 490         if (mQuit) {                                                                                     </span>
<span class="3251995130332618727" onmouseenter="enter('3251995130332618727');" onmouseout="out('3251995130332618727');" style=""> 491             gbDevice.setState(GBDevice.State.NOT_CONNECTED);                                             </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 492         } else {                                                                                         </span>
<span class="3557129149179391090" onmouseenter="enter('3557129149179391090');" onmouseout="out('3557129149179391090');" style=""> 493             gbDevice.setState(GBDevice.State.WAITING_FOR_RECONNECT);                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 494         }                                                                                                </span>
<span  style=""> 495                                                                                                          </span>
<span class="3956366137427967177" onmouseenter="enter('3956366137427967177');" onmouseout="out('3956366137427967177');" style=""> 496         WebViewSingleton.disposeWebView();                                                               </span>
<span  style=""> 497                                                                                                          </span>
<span class="-6083303279196581322" onmouseenter="enter('-6083303279196581322');" onmouseout="out('-6083303279196581322');" style=""> 498         gbDevice.sendDeviceUpdateIntent(getContext());                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 499     }                                                                                                    </span>
<span  style=""> 500                                                                                                          </span>
<span class="6912900349290733332" onmouseenter="enter('6912900349290733332');" onmouseout="out('6912900349290733332');" style=""> 501     private void enablePebbleKitSupport(boolean enable) {                                                </span>
<span class="-4986567876401497765" onmouseenter="enter('-4986567876401497765');" onmouseout="out('-4986567876401497765');" style=""> 502         if (enable &amp;&amp; mEnablePebblekit) {                                                                </span>
<span class="6988208637409175545" onmouseenter="enter('6988208637409175545');" onmouseout="out('6988208637409175545');" style=""> 503             mPebbleKitSupport = new PebbleKitSupport(getContext(), PebbleIoThread.this, mPebbleProtocol);</span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 504         } else {                                                                                         </span>
<span class="1872000704840757529" onmouseenter="enter('1872000704840757529');" onmouseout="out('1872000704840757529');" style=""> 505             if (mPebbleKitSupport != null) {                                                             </span>
<span class="2355950174103684288" onmouseenter="enter('2355950174103684288');" onmouseout="out('2355950174103684288');" style=""> 506                 mPebbleKitSupport.close();                                                               </span>
<span class="-7890594263237719778" onmouseenter="enter('-7890594263237719778');" onmouseout="out('-7890594263237719778');" style=""> 507                 mPebbleKitSupport = null;                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 508             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 509         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 510     }                                                                                                    </span>
<span  style=""> 511                                                                                                          </span>
<span  style=""> 512                                                                                                          </span>
<span class="5266958563097079524" onmouseenter="enter('5266958563097079524');" onmouseout="out('5266958563097079524');" style=""> 513     private void write_real(byte[] bytes) {                                                              </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 514         try {                                                                                            </span>
<span class="5578850974519966568" onmouseenter="enter('5578850974519966568');" onmouseout="out('5578850974519966568');" style=""> 515             if (mIsTCP) {                                                                                </span>
<span class="7452866671884685289" onmouseenter="enter('7452866671884685289');" onmouseout="out('7452866671884685289');" style=""> 516                 ByteBuffer buf = ByteBuffer.allocate(bytes.length + 8);                                  </span>
<span class="-8522898317938558799" onmouseenter="enter('-8522898317938558799');" onmouseout="out('-8522898317938558799');" style=""> 517                 buf.order(ByteOrder.BIG_ENDIAN);                                                         </span>
<span class="5585321854972752725" onmouseenter="enter('5585321854972752725');" onmouseout="out('5585321854972752725');" style=""> 518                 buf.putShort((short) 0xfeed);                                                            </span>
<span class="7507473664785459909" onmouseenter="enter('7507473664785459909');" onmouseout="out('7507473664785459909');" style=""> 519                 buf.putShort((short) 1);                                                                 </span>
<span class="-8123162661289444091" onmouseenter="enter('-8123162661289444091');" onmouseout="out('-8123162661289444091');" style=""> 520                 buf.putShort((short) bytes.length);                                                      </span>
<span class="-7064269165968803859" onmouseenter="enter('-7064269165968803859');" onmouseout="out('-7064269165968803859');" style=""> 521                 buf.put(bytes);                                                                          </span>
<span class="488045024517500594" onmouseenter="enter('488045024517500594');" onmouseout="out('488045024517500594');" style=""> 522                 buf.putShort((short) 0xbeef);                                                            </span>
<span class="5890011760749412055" onmouseenter="enter('5890011760749412055');" onmouseout="out('5890011760749412055');" style=""> 523                 mOutStream.write(buf.array());                                                           </span>
<span class="5447277003517706714" onmouseenter="enter('5447277003517706714');" onmouseout="out('5447277003517706714');" style=""> 524                 mOutStream.flush();                                                                      </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 525             } else {                                                                                     </span>
<span class="-446832387142219515" onmouseenter="enter('-446832387142219515');" onmouseout="out('-446832387142219515');" style=""> 526                 mOutStream.write(bytes);                                                                 </span>
<span class="5447277003517706714" onmouseenter="enter('5447277003517706714');" onmouseout="out('5447277003517706714');" style=""> 527                 mOutStream.flush();                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 528             }                                                                                            </span>
<span class="7080241092423381085" onmouseenter="enter('7080241092423381085');" onmouseout="out('7080241092423381085');" style=""> 529         } catch (IOException e) {                                                                        </span>
<span class="886800052852078092" onmouseenter="enter('886800052852078092');" onmouseout="out('886800052852078092');" style=""> 530             LOG.error(&quot;Error writing.&quot;, e.getMessage());                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 531         }                                                                                                </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 532         try {                                                                                            </span>
<span class="1958254861600319008" onmouseenter="enter('1958254861600319008');" onmouseout="out('1958254861600319008');" style=""> 533             Thread.sleep(100);                                                                           </span>
<span class="1010771762618413361" onmouseenter="enter('1010771762618413361');" onmouseout="out('1010771762618413361');" style=""> 534         } catch (InterruptedException ignored) {                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 535         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 536     }                                                                                                    </span>
<span  style=""> 537                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 538     @Override                                                                                            </span>
<span class="2194193333899452301" onmouseenter="enter('2194193333899452301');" onmouseout="out('2194193333899452301');" style=""> 539     synchronized public void write(byte[] bytes) {                                                       </span>
<span class="7962173391634007539" onmouseenter="enter('7962173391634007539');" onmouseout="out('7962173391634007539');" style=""> 540         if (bytes == null) {                                                                             </span>
<span class="4043029072030362567" onmouseenter="enter('4043029072030362567');" onmouseout="out('4043029072030362567');" style=""> 541             return;                                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 542         }                                                                                                </span>
<span class="-1647178201768949716" onmouseenter="enter('-1647178201768949716');" onmouseout="out('-1647178201768949716');" style=""> 543         // on FW &lt; 3.0 block writes if app installation in in progress                                   </span>
<span class="-6700324623621105863" onmouseenter="enter('-6700324623621105863');" onmouseout="out('-6700324623621105863');" style=""><abbr title=" 544         if (!mIsConnected || (mPebbleProtocol.mFwMajor &lt; 3 &amp;&amp; mIsInstalling &amp;&amp; mInstallState != PebbleAppInstallState.WAIT_SLOT)) {"> 544         if (!mIsConnected || (mPebbleProtocol.mFwMajor &lt; 3 &amp;&amp; mIsInstalling &amp;&amp; mInstallState != PebbleAppðŸ”µ</abbr></span>
<span class="4043029072030362567" onmouseenter="enter('4043029072030362567');" onmouseout="out('4043029072030362567');" style=""> 545             return;                                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 546         }                                                                                                </span>
<span class="-5136181704666404560" onmouseenter="enter('-5136181704666404560');" onmouseout="out('-5136181704666404560');" style=""> 547         write_real(bytes);                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 548     }                                                                                                    </span>
<span  style=""> 549                                                                                                          </span>
<span class="3670289587241327133" onmouseenter="enter('3670289587241327133');" onmouseout="out('3670289587241327133');" style=""> 550     // FIXME: parts are supporsed to be generic code                                                     </span>
<span class="-7489026152941302055" onmouseenter="enter('-7489026152941302055');" onmouseout="out('-7489026152941302055');" style=""> 551     private boolean evaluateGBDeviceEventPebble(GBDeviceEvent deviceEvent) {                             </span>
<span  style=""> 552                                                                                                          </span>
<span class="-1739566276849801616" onmouseenter="enter('-1739566276849801616');" onmouseout="out('-1739566276849801616');" style=""> 553         if (deviceEvent instanceof GBDeviceEventVersionInfo) {                                           </span>
<span class="1668658004022497081" onmouseenter="enter('1668658004022497081');" onmouseout="out('1668658004022497081');" style=""> 554             if (prefs.getBoolean(&quot;datetime_synconconnect&quot;, true)) {                                      </span>
<span class="-3451867859378415609" onmouseenter="enter('-3451867859378415609');" onmouseout="out('-3451867859378415609');" style=""> 555                 LOG.info(&quot;syncing time&quot;);                                                                </span>
<span class="5993925069998187867" onmouseenter="enter('5993925069998187867');" onmouseout="out('5993925069998187867');" style=""> 556                 write(mPebbleProtocol.encodeSetTime());                                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 557             }                                                                                            </span>
<span class="-7386980641954546377" onmouseenter="enter('-7386980641954546377');" onmouseout="out('-7386980641954546377');" style=""> 558             write(mPebbleProtocol.encodeEnableAppLogs(prefs.getBoolean(&quot;pebble_enable_applogs&quot;, false)));</span>
<span class="-4097828168322802160" onmouseenter="enter('-4097828168322802160');" onmouseout="out('-4097828168322802160');" style=""> 559             write(mPebbleProtocol.encodeReportDataLogSessions());                                        </span>
<span class="6586859092027978564" onmouseenter="enter('6586859092027978564');" onmouseout="out('6586859092027978564');" style=""> 560             gbDevice.setState(GBDevice.State.INITIALIZED);                                               </span>
<span class="-5432226360745882584" onmouseenter="enter('-5432226360745882584');" onmouseout="out('-5432226360745882584');" style=""> 561             return false;                                                                                </span>
<span class="-4499044239010675675" onmouseenter="enter('-4499044239010675675');" onmouseout="out('-4499044239010675675');" style=""> 562         } else if (deviceEvent instanceof GBDeviceEventAppManagement) {                                  </span>
<span class="974736254576981019" onmouseenter="enter('974736254576981019');" onmouseout="out('974736254576981019');" style=""> 563             GBDeviceEventAppManagement appMgmt = (GBDeviceEventAppManagement) deviceEvent;               </span>
<span class="-8405891147776704968" onmouseenter="enter('-8405891147776704968');" onmouseout="out('-8405891147776704968');" style=""> 564             switch (appMgmt.type) {                                                                      </span>
<span class="493585282467505488" onmouseenter="enter('493585282467505488');" onmouseout="out('493585282467505488');" style=""> 565                 case DELETE:                                                                             </span>
<span class="3296704790396586230" onmouseenter="enter('3296704790396586230');" onmouseout="out('3296704790396586230');" style=""><abbr title=" 566                     // right now on the Pebble we also receive this on a failed/successful installation ;/"> 566                     // right now on the Pebble we also receive this on a failed/successful installation ;ðŸ”µ</abbr></span>
<span class="-5581198847294356355" onmouseenter="enter('-5581198847294356355');" onmouseout="out('-5581198847294356355');" style=""> 567                     switch (appMgmt.event) {                                                             </span>
<span class="6749187966539498077" onmouseenter="enter('6749187966539498077');" onmouseout="out('6749187966539498077');" style=""> 568                         case FAILURE:                                                                    </span>
<span class="-8278348814669106484" onmouseenter="enter('-8278348814669106484');" onmouseout="out('-8278348814669106484');" style=""> 569                             if (mIsInstalling) {                                                         </span>
<span class="5202677886896781243" onmouseenter="enter('5202677886896781243');" onmouseout="out('5202677886896781243');" style=""> 570                                 if (mInstallState == PebbleAppInstallState.WAIT_SLOT) {                  </span>
<span class="-3834429542028013887" onmouseenter="enter('-3834429542028013887');" onmouseout="out('-3834429542028013887');" style=""> 571                                     // get the free slot                                                 </span>
<span class="-1078532123174136932" onmouseenter="enter('-1078532123174136932');" onmouseout="out('-1078532123174136932');" style=""> 572                                     writeInstallApp(mPebbleProtocol.encodeAppInfoReq());                 </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 573                                 } else {                                                                 </span>
<span class="2061814158740359960" onmouseenter="enter('2061814158740359960');" onmouseout="out('2061814158740359960');" style=""> 574                                     finishInstall(true);                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 575                                 }                                                                        </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 576                             } else {                                                                     </span>
<span class="-3730390778602920424" onmouseenter="enter('-3730390778602920424');" onmouseout="out('-3730390778602920424');" style=""> 577                                 LOG.info(&quot;failure removing app&quot;);                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 578                             }                                                                            </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 579                             break;                                                                       </span>
<span class="3349111062118052514" onmouseenter="enter('3349111062118052514');" onmouseout="out('3349111062118052514');" style=""> 580                         case SUCCESS:                                                                    </span>
<span class="-8278348814669106484" onmouseenter="enter('-8278348814669106484');" onmouseout="out('-8278348814669106484');" style=""> 581                             if (mIsInstalling) {                                                         </span>
<span class="5202677886896781243" onmouseenter="enter('5202677886896781243');" onmouseout="out('5202677886896781243');" style=""> 582                                 if (mInstallState == PebbleAppInstallState.WAIT_SLOT) {                  </span>
<span class="-3834429542028013887" onmouseenter="enter('-3834429542028013887');" onmouseout="out('-3834429542028013887');" style=""> 583                                     // get the free slot                                                 </span>
<span class="-1078532123174136932" onmouseenter="enter('-1078532123174136932');" onmouseout="out('-1078532123174136932');" style=""> 584                                     writeInstallApp(mPebbleProtocol.encodeAppInfoReq());                 </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 585                                 } else {                                                                 </span>
<span class="8670418135173104454" onmouseenter="enter('8670418135173104454');" onmouseout="out('8670418135173104454');" style=""> 586                                     finishInstall(false);                                                </span>
<span class="5558136677444980843" onmouseenter="enter('5558136677444980843');" onmouseout="out('5558136677444980843');" style=""> 587                                     // refresh app list                                                  </span>
<span class="-6896285502301651077" onmouseenter="enter('-6896285502301651077');" onmouseout="out('-6896285502301651077');" style=""> 588                                     write(mPebbleProtocol.encodeAppInfoReq());                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 589                                 }                                                                        </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 590                             } else {                                                                     </span>
<span class="-205908887212722760" onmouseenter="enter('-205908887212722760');" onmouseout="out('-205908887212722760');" style=""> 591                                 LOG.info(&quot;successfully removed app&quot;);                                    </span>
<span class="-6896285502301651077" onmouseenter="enter('-6896285502301651077');" onmouseout="out('-6896285502301651077');" style=""> 592                                 write(mPebbleProtocol.encodeAppInfoReq());                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 593                             }                                                                            </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 594                             break;                                                                       </span>
<span class="-8178136317704390296" onmouseenter="enter('-8178136317704390296');" onmouseout="out('-8178136317704390296');" style=""> 595                         default:                                                                         </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 596                             break;                                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 597                     }                                                                                    </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 598                     break;                                                                               </span>
<span class="870820606107259995" onmouseenter="enter('870820606107259995');" onmouseout="out('870820606107259995');" style=""> 599                 case INSTALL:                                                                            </span>
<span class="-5581198847294356355" onmouseenter="enter('-5581198847294356355');" onmouseout="out('-5581198847294356355');" style=""> 600                     switch (appMgmt.event) {                                                             </span>
<span class="6749187966539498077" onmouseenter="enter('6749187966539498077');" onmouseout="out('6749187966539498077');" style=""> 601                         case FAILURE:                                                                    </span>
<span class="-7112250469089022370" onmouseenter="enter('-7112250469089022370');" onmouseout="out('-7112250469089022370');" style=""> 602                             LOG.info(&quot;failure installing app&quot;); // TODO: report to Installer             </span>
<span class="2061814158740359960" onmouseenter="enter('2061814158740359960');" onmouseout="out('2061814158740359960');" style=""> 603                             finishInstall(true);                                                         </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 604                             break;                                                                       </span>
<span class="3349111062118052514" onmouseenter="enter('3349111062118052514');" onmouseout="out('3349111062118052514');" style=""> 605                         case SUCCESS:                                                                    </span>
<span class="6209162457835083814" onmouseenter="enter('6209162457835083814');" onmouseout="out('6209162457835083814');" style=""> 606                             setToken(appMgmt.token);                                                     </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 607                             break;                                                                       </span>
<span class="6051906179244859750" onmouseenter="enter('6051906179244859750');" onmouseout="out('6051906179244859750');" style=""> 608                         case REQUEST:                                                                    </span>
<span class="2049455602208269446" onmouseenter="enter('2049455602208269446');" onmouseout="out('2049455602208269446');" style=""> 609                             LOG.info(&quot;APPFETCH request: &quot; + appMgmt.uuid + &quot; / &quot; + appMgmt.token);       </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 610                             try {                                                                        </span>
<span class="1545743734028545488" onmouseenter="enter('1545743734028545488');" onmouseout="out('1545743734028545488');" style=""><abbr title=" 611                                 installApp(Uri.fromFile(new File(FileUtils.getExternalFilesDir() + &quot;/pbw-cache/&quot; + appMgmt.uuid.toString() + &quot;.pbw&quot;)), appMgmt.token);"> 611                                 installApp(Uri.fromFile(new File(FileUtils.getExternalFilesDir() + &quot;/pbw-ðŸ”µ</abbr></span>
<span class="7080241092423381085" onmouseenter="enter('7080241092423381085');" onmouseout="out('7080241092423381085');" style=""> 612                             } catch (IOException e) {                                                    </span>
<span class="-531769948700903766" onmouseenter="enter('-531769948700903766');" onmouseout="out('-531769948700903766');" style=""> 613                                 LOG.error(&quot;Error installing app: &quot; + e.getMessage(), e);                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 614                             }                                                                            </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 615                             break;                                                                       </span>
<span class="-8178136317704390296" onmouseenter="enter('-8178136317704390296');" onmouseout="out('-8178136317704390296');" style=""> 616                         default:                                                                         </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 617                             break;                                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 618                     }                                                                                    </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 619                     break;                                                                               </span>
<span class="-2079449841199557933" onmouseenter="enter('-2079449841199557933');" onmouseout="out('-2079449841199557933');" style=""> 620                 case START:                                                                              </span>
<span class="8092140248813269968" onmouseenter="enter('8092140248813269968');" onmouseout="out('8092140248813269968');" style=""> 621                     LOG.info(&quot;got GBDeviceEventAppManagement START event for uuid: &quot; + appMgmt.uuid);    </span>
<span class="-7700571972479023893" onmouseenter="enter('-7700571972479023893');" onmouseout="out('-7700571972479023893');" style=""> 622                     WebViewSingleton.getorInitWebView(getContext(), gbDevice, appMgmt.uuid);             </span>
<span class="3757214281746876643" onmouseenter="enter('3757214281746876643');" onmouseout="out('3757214281746876643');" style=""><abbr title=" 623                     //TODO: the method call above will not work the first time as we need an activity. Either we find a way to have one here, or replace it with a local broadcast"> 623                     //TODO: the method call above will not work the first time as we need an activity. EiðŸ”µ</abbr></span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 624                     break;                                                                               </span>
<span class="-8178136317704390296" onmouseenter="enter('-8178136317704390296');" onmouseout="out('-8178136317704390296');" style=""> 625                 default:                                                                                 </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 626                     break;                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 627             }                                                                                            </span>
<span class="-3118901906653197100" onmouseenter="enter('-3118901906653197100');" onmouseout="out('-3118901906653197100');" style=""> 628             return true;                                                                                 </span>
<span class="-6358653040411049512" onmouseenter="enter('-6358653040411049512');" onmouseout="out('-6358653040411049512');" style=""> 629         } else if (deviceEvent instanceof GBDeviceEventAppInfo) {                                        </span>
<span class="3946899054861776294" onmouseenter="enter('3946899054861776294');" onmouseout="out('3946899054861776294');" style=""> 630             LOG.info(&quot;Got event for APP_INFO&quot;);                                                          </span>
<span class="1502569219724801591" onmouseenter="enter('1502569219724801591');" onmouseout="out('1502569219724801591');" style=""> 631             GBDeviceEventAppInfo appInfoEvent = (GBDeviceEventAppInfo) deviceEvent;                      </span>
<span class="-8959429837223401007" onmouseenter="enter('-8959429837223401007');" onmouseout="out('-8959429837223401007');" style=""> 632             setInstallSlot(appInfoEvent.freeSlot);                                                       </span>
<span class="-5432226360745882584" onmouseenter="enter('-5432226360745882584');" onmouseout="out('-5432226360745882584');" style=""> 633             return false;                                                                                </span>
<span class="3212296093301006379" onmouseenter="enter('3212296093301006379');" onmouseout="out('3212296093301006379');" style=""> 634         } else if (deviceEvent instanceof GBDeviceEventAppMessage) {                                     </span>
<span class="3695639456947057183" onmouseenter="enter('3695639456947057183');" onmouseout="out('3695639456947057183');" style=""> 635             sendAppMessageJS((GBDeviceEventAppMessage) deviceEvent);                                     </span>
<span class="-2519217701585576846" onmouseenter="enter('-2519217701585576846');" onmouseout="out('-2519217701585576846');" style=""> 636             if (mEnablePebblekit) {                                                                      </span>
<span class="3587206773966788552" onmouseenter="enter('3587206773966788552');" onmouseout="out('3587206773966788552');" style=""> 637                 LOG.info(&quot;Got AppMessage event&quot;);                                                        </span>
<span class="1872000704840757529" onmouseenter="enter('1872000704840757529');" onmouseout="out('1872000704840757529');" style=""> 638                 if (mPebbleKitSupport != null) {                                                         </span>
<span class="-6825766400209744371" onmouseenter="enter('-6825766400209744371');" onmouseout="out('-6825766400209744371');" style=""> 639                     mPebbleKitSupport.sendAppMessageIntent((GBDeviceEventAppMessage) deviceEvent);       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 640                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 641             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 642         }                                                                                                </span>
<span  style=""> 643                                                                                                          </span>
<span class="-5432226360745882584" onmouseenter="enter('-5432226360745882584');" onmouseout="out('-5432226360745882584');" style=""> 644         return false;                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 645     }                                                                                                    </span>
<span  style=""> 646                                                                                                          </span>
<span class="1330519925695971168" onmouseenter="enter('1330519925695971168');" onmouseout="out('1330519925695971168');" style=""> 647     private void setToken(int token) {                                                                   </span>
<span class="5683710649022739399" onmouseenter="enter('5683710649022739399');" onmouseout="out('5683710649022739399');" style=""> 648         mAppInstallToken = token;                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 649     }                                                                                                    </span>
<span  style=""> 650                                                                                                          </span>
<span class="3305301500785286694" onmouseenter="enter('3305301500785286694');" onmouseout="out('3305301500785286694');" style=""> 651     private void setInstallSlot(int slot) {                                                              </span>
<span class="-8278348814669106484" onmouseenter="enter('-8278348814669106484');" onmouseout="out('-8278348814669106484');" style=""> 652         if (mIsInstalling) {                                                                             </span>
<span class="7826340306873194751" onmouseenter="enter('7826340306873194751');" onmouseout="out('7826340306873194751');" style=""> 653             mInstallSlot = slot;                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 654         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 655     }                                                                                                    </span>
<span  style=""> 656                                                                                                          </span>
<span class="-8792508792922317323" onmouseenter="enter('-8792508792922317323');" onmouseout="out('-8792508792922317323');" style=""> 657     synchronized private void writeInstallApp(byte[] bytes) {                                            </span>
<span class="1640300515722317364" onmouseenter="enter('1640300515722317364');" onmouseout="out('1640300515722317364');" style=""> 658         if (!mIsInstalling) {                                                                            </span>
<span class="4043029072030362567" onmouseenter="enter('4043029072030362567');" onmouseout="out('4043029072030362567');" style=""> 659             return;                                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 660         }                                                                                                </span>
<span class="546783514848998195" onmouseenter="enter('546783514848998195');" onmouseout="out('546783514848998195');" style=""> 661         LOG.info(&quot;got &quot; + bytes.length + &quot;bytes for writeInstallApp()&quot;);                                 </span>
<span class="-5136181704666404560" onmouseenter="enter('-5136181704666404560');" onmouseout="out('-5136181704666404560');" style=""> 662         write_real(bytes);                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 663     }                                                                                                    </span>
<span  style=""> 664                                                                                                          </span>
<span class="-1924531441297190559" onmouseenter="enter('-1924531441297190559');" onmouseout="out('-1924531441297190559');" style=""> 665     void installApp(Uri uri, int appId) {                                                                </span>
<span class="4219320778876848093" onmouseenter="enter('4219320778876848093');" onmouseout="out('4219320778876848093');" style=""> 666         if (uri.equals(Uri.parse(&quot;fake://health&quot;))) {                                                    </span>
<span class="-4500321340045240107" onmouseenter="enter('-4500321340045240107');" onmouseout="out('-4500321340045240107');" style=""> 667             write(mPebbleProtocol.encodeActivateHealth(true));                                           </span>
<span class="-9057759845463359663" onmouseenter="enter('-9057759845463359663');" onmouseout="out('-9057759845463359663');" style=""> 668             write(mPebbleProtocol.encodeSetSaneDistanceUnit(true));                                      </span>
<span class="4043029072030362567" onmouseenter="enter('4043029072030362567');" onmouseout="out('4043029072030362567');" style=""> 669             return;                                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 670         }                                                                                                </span>
<span class="-2579506686933905796" onmouseenter="enter('-2579506686933905796');" onmouseout="out('-2579506686933905796');" style=""> 671         if (uri.equals(Uri.parse(&quot;fake://hrm&quot;))) {                                                       </span>
<span class="-8562013736932235665" onmouseenter="enter('-8562013736932235665');" onmouseout="out('-8562013736932235665');" style=""> 672             write(mPebbleProtocol.encodeActivateHRM(true));                                              </span>
<span class="4043029072030362567" onmouseenter="enter('4043029072030362567');" onmouseout="out('4043029072030362567');" style=""> 673             return;                                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 674         }                                                                                                </span>
<span class="-1212047709466619456" onmouseenter="enter('-1212047709466619456');" onmouseout="out('-1212047709466619456');" style=""> 675         if (uri.equals(Uri.parse(&quot;fake://weather&quot;))) {                                                   </span>
<span class="2684404709669173657" onmouseenter="enter('2684404709669173657');" onmouseout="out('2684404709669173657');" style=""> 676             write(mPebbleProtocol.encodeActivateWeather(true));                                          </span>
<span class="4043029072030362567" onmouseenter="enter('4043029072030362567');" onmouseout="out('4043029072030362567');" style=""> 677             return;                                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 678         }                                                                                                </span>
<span  style=""> 679                                                                                                          </span>
<span class="-8278348814669106484" onmouseenter="enter('-8278348814669106484');" onmouseout="out('-8278348814669106484');" style=""> 680         if (mIsInstalling) {                                                                             </span>
<span class="4043029072030362567" onmouseenter="enter('4043029072030362567');" onmouseout="out('4043029072030362567');" style=""> 681             return;                                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 682         }                                                                                                </span>
<span  style=""> 683                                                                                                          </span>
<span class="6375141335175677190" onmouseenter="enter('6375141335175677190');" onmouseout="out('6375141335175677190');" style=""> 684         String platformName = PebbleUtils.getPlatformName(gbDevice.getModel());                          </span>
<span  style=""> 685                                                                                                          </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 686         try {                                                                                            </span>
<span class="7221939422125416648" onmouseenter="enter('7221939422125416648');" onmouseout="out('7221939422125416648');" style=""> 687             mPBWReader = new PBWReader(uri, getContext(), platformName);                                 </span>
<span class="400908373044587289" onmouseenter="enter('400908373044587289');" onmouseout="out('400908373044587289');" style=""> 688         } catch (FileNotFoundException e) {                                                              </span>
<span class="769608185211968952" onmouseenter="enter('769608185211968952');" onmouseout="out('769608185211968952');" style=""> 689             LOG.warn(&quot;file not found: &quot; + e.getMessage(), e);                                            </span>
<span class="4043029072030362567" onmouseenter="enter('4043029072030362567');" onmouseout="out('4043029072030362567');" style=""> 690             return;                                                                                      </span>
<span class="7080241092423381085" onmouseenter="enter('7080241092423381085');" onmouseout="out('7080241092423381085');" style=""> 691         } catch (IOException e) {                                                                        </span>
<span class="8483156789856269109" onmouseenter="enter('8483156789856269109');" onmouseout="out('8483156789856269109');" style=""> 692             LOG.warn(&quot;unable to read file: &quot; + e.getMessage(), e);                                       </span>
<span class="4043029072030362567" onmouseenter="enter('4043029072030362567');" onmouseout="out('4043029072030362567');" style=""> 693             return;                                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 694         }                                                                                                </span>
<span  style=""> 695                                                                                                          </span>
<span class="-8518332035217489539" onmouseenter="enter('-8518332035217489539');" onmouseout="out('-8518332035217489539');" style=""> 696         mPebbleInstallables = mPBWReader.getPebbleInstallables();                                        </span>
<span class="5818194705482022298" onmouseenter="enter('5818194705482022298');" onmouseout="out('5818194705482022298');" style=""> 697         mCurrentInstallableIndex = 0;                                                                    </span>
<span  style=""> 698                                                                                                          </span>
<span class="1423594820264173048" onmouseenter="enter('1423594820264173048');" onmouseout="out('1423594820264173048');" style=""> 699         if (mPBWReader.isFirmware()) {                                                                   </span>
<span class="-6874615797996941970" onmouseenter="enter('-6874615797996941970');" onmouseout="out('-6874615797996941970');" style=""> 700             LOG.info(&quot;starting firmware installation&quot;);                                                  </span>
<span class="-7893027413776683580" onmouseenter="enter('-7893027413776683580');" onmouseout="out('-7893027413776683580');" style=""> 701             mIsInstalling = true;                                                                        </span>
<span class="2991380117683144492" onmouseenter="enter('2991380117683144492');" onmouseout="out('2991380117683144492');" style=""> 702             mInstallSlot = 0;                                                                            </span>
<span class="5938608831368473017" onmouseenter="enter('5938608831368473017');" onmouseout="out('5938608831368473017');" style=""> 703             writeInstallApp(mPebbleProtocol.encodeInstallFirmwareStart());                               </span>
<span class="6147346456613268497" onmouseenter="enter('6147346456613268497');" onmouseout="out('6147346456613268497');" style=""> 704             mInstallState = PebbleAppInstallState.START_INSTALL;                                         </span>
<span  style=""> 705                                                                                                          </span>
<span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style=""> 706             /*                                                                                           </span>
<span class="4272043072413570034" onmouseenter="enter('4272043072413570034');" onmouseout="out('4272043072413570034');" style=""> 707              * This is a hack for recovery mode, in which the blocking read has no timeout and the       </span>
<span class="5399824784620980403" onmouseenter="enter('5399824784620980403');" onmouseout="out('5399824784620980403');" style=""> 708              * firmware installation command does not return any ack.                                    </span>
<span class="5951082934844106568" onmouseenter="enter('5951082934844106568');" onmouseout="out('5951082934844106568');" style=""> 709              * In normal mode we would got at least out of the blocking read call after a while.         </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 710              *                                                                                           </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 711              *                                                                                           </span>
<span class="1478144735136743177" onmouseenter="enter('1478144735136743177');" onmouseout="out('1478144735136743177');" style=""> 712              * ... we should really not handle installation from thread that does the blocking read      </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 713              *                                                                                           </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 714              */                                                                                          </span>
<span class="-4151709780636609521" onmouseenter="enter('-4151709780636609521');" onmouseout="out('-4151709780636609521');" style=""> 715             writeInstallApp(mPebbleProtocol.encodeGetTime());                                            </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 716         } else {                                                                                         </span>
<span class="5609914623056246065" onmouseenter="enter('5609914623056246065');" onmouseout="out('5609914623056246065');" style=""> 717             mCurrentlyInstallingApp = mPBWReader.getGBDeviceApp();                                       </span>
<span class="-492152501567437702" onmouseenter="enter('-492152501567437702');" onmouseout="out('-492152501567437702');" style=""> 718             if (mPebbleProtocol.mFwMajor &gt;= 3 &amp;&amp; !mPBWReader.isLanguage()) {                             </span>
<span class="2714123758730002125" onmouseenter="enter('2714123758730002125');" onmouseout="out('2714123758730002125');" style=""> 719                 if (appId == 0) {                                                                        </span>
<span class="-403761314332683960" onmouseenter="enter('-403761314332683960');" onmouseout="out('-403761314332683960');" style=""> 720                     // only install metadata - not the binaries                                          </span>
<span class="4867948988198814512" onmouseenter="enter('4867948988198814512');" onmouseout="out('4867948988198814512');" style=""><abbr title=" 721                     write(mPebbleProtocol.encodeInstallMetadata(mCurrentlyInstallingApp.getUUID(), mCurrentlyInstallingApp.getName(), mPBWReader.getAppVersion(), mPBWReader.getSdkVersion(), mPBWReader.getFlags(), mPBWReader.getIconId()));"> 721                     write(mPebbleProtocol.encodeInstallMetadata(mCurrentlyInstallingApp.getUUID(), mCurreðŸ”µ</abbr></span>
<span class="-4051160554063647465" onmouseenter="enter('-4051160554063647465');" onmouseout="out('-4051160554063647465');" style=""> 722                     write(mPebbleProtocol.encodeAppStart(mCurrentlyInstallingApp.getUUID(), true));      </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 723                 } else {                                                                                 </span>
<span class="268321394733795474" onmouseenter="enter('268321394733795474');" onmouseout="out('268321394733795474');" style=""> 724                     // this came from an app fetch request, so do the real stuff                         </span>
<span class="-7893027413776683580" onmouseenter="enter('-7893027413776683580');" onmouseout="out('-7893027413776683580');" style=""> 725                     mIsInstalling = true;                                                                </span>
<span class="6866943522579684341" onmouseenter="enter('6866943522579684341');" onmouseout="out('6866943522579684341');" style=""> 726                     mInstallSlot = appId;                                                                </span>
<span class="6147346456613268497" onmouseenter="enter('6147346456613268497');" onmouseout="out('6147346456613268497');" style=""> 727                     mInstallState = PebbleAppInstallState.START_INSTALL;                                 </span>
<span  style=""> 728                                                                                                          </span>
<span class="1406564667829072525" onmouseenter="enter('1406564667829072525');" onmouseout="out('1406564667829072525');" style=""> 729                     writeInstallApp(mPebbleProtocol.encodeAppFetchAck());                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 730                 }                                                                                        </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 731             } else {                                                                                     </span>
<span class="-7893027413776683580" onmouseenter="enter('-7893027413776683580');" onmouseout="out('-7893027413776683580');" style=""> 732                 mIsInstalling = true;                                                                    </span>
<span class="7854043658495457291" onmouseenter="enter('7854043658495457291');" onmouseout="out('7854043658495457291');" style=""> 733                 if (mPBWReader.isLanguage()) {                                                           </span>
<span class="2991380117683144492" onmouseenter="enter('2991380117683144492');" onmouseout="out('2991380117683144492');" style=""> 734                     mInstallSlot = 0;                                                                    </span>
<span class="6147346456613268497" onmouseenter="enter('6147346456613268497');" onmouseout="out('6147346456613268497');" style=""> 735                     mInstallState = PebbleAppInstallState.START_INSTALL;                                 </span>
<span  style=""> 736                                                                                                          </span>
<span class="-9169766034690988699" onmouseenter="enter('-9169766034690988699');" onmouseout="out('-9169766034690988699');" style=""> 737                     // unblock HACK                                                                      </span>
<span class="-4151709780636609521" onmouseenter="enter('-4151709780636609521');" onmouseout="out('-4151709780636609521');" style=""> 738                     writeInstallApp(mPebbleProtocol.encodeGetTime());                                    </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 739                 } else {                                                                                 </span>
<span class="6749245896015366249" onmouseenter="enter('6749245896015366249');" onmouseout="out('6749245896015366249');" style=""> 740                     mInstallState = PebbleAppInstallState.WAIT_SLOT;                                     </span>
<span class="-5557276013487860944" onmouseenter="enter('-5557276013487860944');" onmouseout="out('-5557276013487860944');" style=""> 741                     writeInstallApp(mPebbleProtocol.encodeAppDelete(mCurrentlyInstallingApp.getUUID())); </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 742                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 743             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 744         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 745     }                                                                                                    </span>
<span  style=""> 746                                                                                                          </span>
<span class="-3632958031962272509" onmouseenter="enter('-3632958031962272509');" onmouseout="out('-3632958031962272509');" style=""> 747     private void finishInstall(boolean hadError) {                                                       </span>
<span class="1640300515722317364" onmouseenter="enter('1640300515722317364');" onmouseout="out('1640300515722317364');" style=""> 748         if (!mIsInstalling) {                                                                            </span>
<span class="4043029072030362567" onmouseenter="enter('4043029072030362567');" onmouseout="out('4043029072030362567');" style=""> 749             return;                                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 750         }                                                                                                </span>
<span class="7546809272471924454" onmouseenter="enter('7546809272471924454');" onmouseout="out('7546809272471924454');" style=""> 751         if (hadError) {                                                                                  </span>
<span class="1510893224061013550" onmouseenter="enter('1510893224061013550');" onmouseout="out('1510893224061013550');" style=""><abbr title=" 752             GB.updateInstallNotification(getContext().getString(R.string.installation_failed_), false, 0, getContext());"> 752             GB.updateInstallNotification(getContext().getString(R.string.installation_failed_), false, 0,ðŸ”µ</abbr></span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 753         } else {                                                                                         </span>
<span class="-1798755310811164062" onmouseenter="enter('-1798755310811164062');" onmouseout="out('-1798755310811164062');" style=""><abbr title=" 754             GB.updateInstallNotification(getContext().getString(R.string.installation_successful), false, 0, getContext());"> 754             GB.updateInstallNotification(getContext().getString(R.string.installation_successful), false,ðŸ”µ</abbr></span>
<span class="-1022673267036805326" onmouseenter="enter('-1022673267036805326');" onmouseout="out('-1022673267036805326');" style=""> 755             if (mPebbleProtocol.mFwMajor &gt;= 3) {                                                         </span>
<span class="-6972336671826040876" onmouseenter="enter('-6972336671826040876');" onmouseout="out('-6972336671826040876');" style=""> 756                 String filenameSuffix;                                                                   </span>
<span class="-4516041174588684958" onmouseenter="enter('-4516041174588684958');" onmouseout="out('-4516041174588684958');" style=""> 757                 if (mCurrentlyInstallingApp != null) {                                                   </span>
<span class="-1977040827148362152" onmouseenter="enter('-1977040827148362152');" onmouseout="out('-1977040827148362152');" style=""> 758                     if (mCurrentlyInstallingApp.getType() == GBDeviceApp.Type.WATCHFACE) {               </span>
<span class="4066163442843372701" onmouseenter="enter('4066163442843372701');" onmouseout="out('4066163442843372701');" style=""> 759                         filenameSuffix = &quot;.watchfaces&quot;;                                                  </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 760                     } else {                                                                             </span>
<span class="-1542718791393148177" onmouseenter="enter('-1542718791393148177');" onmouseout="out('-1542718791393148177');" style=""> 761                         filenameSuffix = &quot;.watchapps&quot;;                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 762                     }                                                                                    </span>
<span class="7434590360240997484" onmouseenter="enter('7434590360240997484');" onmouseout="out('7434590360240997484');" style=""><abbr title=" 763                     AppManagerActivity.addToAppOrderFile(gbDevice.getAddress() + filenameSuffix, mCurrentlyInstallingApp.getUUID());"> 763                     AppManagerActivity.addToAppOrderFile(gbDevice.getAddress() + filenameSuffix, mCurrentðŸ”µ</abbr></span>
<span class="7935209901888052732" onmouseenter="enter('7935209901888052732');" onmouseout="out('7935209901888052732');" style=""> 764                     Intent refreshIntent = new Intent(AbstractAppManagerFragment.ACTION_REFRESH_APPLIST);</span>
<span class="-1350396105067022557" onmouseenter="enter('-1350396105067022557');" onmouseout="out('-1350396105067022557');" style=""> 765                     LocalBroadcastManager.getInstance(getContext()).sendBroadcast(refreshIntent);        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 766                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 767             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 768         }                                                                                                </span>
<span class="3442713773628960689" onmouseenter="enter('3442713773628960689');" onmouseout="out('3442713773628960689');" style=""> 769         mInstallState = PebbleAppInstallState.UNKNOWN;                                                   </span>
<span  style=""> 770                                                                                                          </span>
<span class="6208081448933219418" onmouseenter="enter('6208081448933219418');" onmouseout="out('6208081448933219418');" style=""> 771         if (hadError &amp;&amp; mAppInstallToken != -1) {                                                        </span>
<span class="1039411603055838770" onmouseenter="enter('1039411603055838770');" onmouseout="out('1039411603055838770');" style=""> 772             writeInstallApp(mPebbleProtocol.encodeUploadCancel(mAppInstallToken));                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 773         }                                                                                                </span>
<span  style=""> 774                                                                                                          </span>
<span class="5124188328891976822" onmouseenter="enter('5124188328891976822');" onmouseout="out('5124188328891976822');" style=""> 775         mPBWReader = null;                                                                               </span>
<span class="1304182622527867961" onmouseenter="enter('1304182622527867961');" onmouseout="out('1304182622527867961');" style=""> 776         mIsInstalling = false;                                                                           </span>
<span class="3809401643932021573" onmouseenter="enter('3809401643932021573');" onmouseout="out('3809401643932021573');" style=""> 777         mCurrentlyInstallingApp = null;                                                                  </span>
<span  style=""> 778                                                                                                          </span>
<span class="5599892338312940306" onmouseenter="enter('5599892338312940306');" onmouseout="out('5599892338312940306');" style=""> 779         if (mFis != null) {                                                                              </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 780             try {                                                                                        </span>
<span class="5464107653723318031" onmouseenter="enter('5464107653723318031');" onmouseout="out('5464107653723318031');" style=""> 781                 mFis.close();                                                                            </span>
<span class="7080241092423381085" onmouseenter="enter('7080241092423381085');" onmouseout="out('7080241092423381085');" style=""> 782             } catch (IOException e) {                                                                    </span>
<span class="-4407835218921977391" onmouseenter="enter('-4407835218921977391');" onmouseout="out('-4407835218921977391');" style=""> 783                 // ignore                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 784             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 785         }                                                                                                </span>
<span class="6718599516057736481" onmouseenter="enter('6718599516057736481');" onmouseout="out('6718599516057736481');" style=""> 786         mFis = null;                                                                                     </span>
<span class="-556680889075439690" onmouseenter="enter('-556680889075439690');" onmouseout="out('-556680889075439690');" style=""> 787         mAppInstallToken = -1;                                                                           </span>
<span class="-4341770816803766254" onmouseenter="enter('-4341770816803766254');" onmouseout="out('-4341770816803766254');" style=""> 788         mInstallSlot = -2;                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 789     }                                                                                                    </span>
<span  style=""> 790                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 791     @Override                                                                                            </span>
<span class="-4556626830840513273" onmouseenter="enter('-4556626830840513273');" onmouseout="out('-4556626830840513273');" style=""> 792     public void quit() {                                                                                 </span>
<span class="-2245059810018305386" onmouseenter="enter('-2245059810018305386');" onmouseout="out('-2245059810018305386');" style=""> 793         mQuit = true;                                                                                    </span>
<span class="-3944229288018059276" onmouseenter="enter('-3944229288018059276');" onmouseout="out('-3944229288018059276');" style=""> 794         if (mBtSocket != null) {                                                                         </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 795             try {                                                                                        </span>
<span class="4957759683762229483" onmouseenter="enter('4957759683762229483');" onmouseout="out('4957759683762229483');" style=""> 796                 mBtSocket.close();                                                                       </span>
<span class="-8338918978083861071" onmouseenter="enter('-8338918978083861071');" onmouseout="out('-8338918978083861071');" style=""> 797             } catch (IOException ignored) {                                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 798             }                                                                                            </span>
<span class="-4534501040604870855" onmouseenter="enter('-4534501040604870855');" onmouseout="out('-4534501040604870855');" style=""> 799             mBtSocket = null;                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 800         }                                                                                                </span>
<span class="3388558050890258608" onmouseenter="enter('3388558050890258608');" onmouseout="out('3388558050890258608');" style=""> 801         if (mTCPSocket != null) {                                                                        </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 802             try {                                                                                        </span>
<span class="1317722495006749576" onmouseenter="enter('1317722495006749576');" onmouseout="out('1317722495006749576');" style=""> 803                 mTCPSocket.close();                                                                      </span>
<span class="-8338918978083861071" onmouseenter="enter('-8338918978083861071');" onmouseout="out('-8338918978083861071');" style=""> 804             } catch (IOException ignored) {                                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 805             }                                                                                            </span>
<span class="4396162940795265492" onmouseenter="enter('4396162940795265492');" onmouseout="out('4396162940795265492');" style=""> 806             mTCPSocket = null;                                                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 807         }                                                                                                </span>
<span class="-5320890524666996917" onmouseenter="enter('-5320890524666996917');" onmouseout="out('-5320890524666996917');" style=""> 808         if (mPebbleLESupport != null) {                                                                  </span>
<span class="-997532962857791838" onmouseenter="enter('-997532962857791838');" onmouseout="out('-997532962857791838');" style=""> 809             mPebbleLESupport.close();                                                                    </span>
<span class="-2496993078705938002" onmouseenter="enter('-2496993078705938002');" onmouseout="out('-2496993078705938002');" style=""> 810             mPebbleLESupport = null;                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 811         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 812     }                                                                                                    </span>
<span  style=""> 813                                                                                                          </span>
<span class="-4681179840421673206" onmouseenter="enter('-4681179840421673206');" onmouseout="out('-4681179840421673206');" style=""> 814     private enum PebbleAppInstallState {                                                                 </span>
<span class="8504698099528295248" onmouseenter="enter('8504698099528295248');" onmouseout="out('8504698099528295248');" style=""> 815         UNKNOWN,                                                                                         </span>
<span class="-8062507015798429311" onmouseenter="enter('-8062507015798429311');" onmouseout="out('-8062507015798429311');" style=""> 816         WAIT_SLOT,                                                                                       </span>
<span class="-668951604036061853" onmouseenter="enter('-668951604036061853');" onmouseout="out('-668951604036061853');" style=""> 817         START_INSTALL,                                                                                   </span>
<span class="-1678353837526561027" onmouseenter="enter('-1678353837526561027');" onmouseout="out('-1678353837526561027');" style=""> 818         WAIT_TOKEN,                                                                                      </span>
<span class="-2676567537573092080" onmouseenter="enter('-2676567537573092080');" onmouseout="out('-2676567537573092080');" style=""> 819         UPLOAD_CHUNK,                                                                                    </span>
<span class="-1008243733279055296" onmouseenter="enter('-1008243733279055296');" onmouseout="out('-1008243733279055296');" style=""> 820         UPLOAD_COMMIT,                                                                                   </span>
<span class="-8287073352459983195" onmouseenter="enter('-8287073352459983195');" onmouseout="out('-8287073352459983195');" style=""> 821         WAIT_COMMIT,                                                                                     </span>
<span class="-4008830795114372846" onmouseenter="enter('-4008830795114372846');" onmouseout="out('-4008830795114372846');" style=""> 822         UPLOAD_COMPLETE,                                                                                 </span>
<span class="667328612202802083" onmouseenter="enter('667328612202802083');" onmouseout="out('667328612202802083');" style=""> 823         APP_REFRESH,                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 824     }                                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 825 }                                                                                                        </span></pre></td>
                            <td><pre><span class="-5771549642386131488" onmouseenter="enter('-5771549642386131488');" onmouseout="out('-5771549642386131488');" style="">   1 package nodomain.freeyourgadget.gadgetbridge.service.devices.pebble;                                     </span>
<span  style="">   2                                                                                                          </span>
<span class="-8028506601233233593" onmouseenter="enter('-8028506601233233593');" onmouseout="out('-8028506601233233593');" style="">   3 import android.bluetooth.BluetoothAdapter;                                                               </span>
<span class="2859895893394018468" onmouseenter="enter('2859895893394018468');" onmouseout="out('2859895893394018468');" style="">   4 import android.bluetooth.BluetoothDevice;                                                                </span>
<span class="634810844753697830" onmouseenter="enter('634810844753697830');" onmouseout="out('634810844753697830');" style="">   5 import android.bluetooth.BluetoothSocket;                                                                </span>
<span class="5922045460006936195" onmouseenter="enter('5922045460006936195');" onmouseout="out('5922045460006936195');" style="">   6 import android.content.Context;                                                                          </span>
<span class="6568903789857736568" onmouseenter="enter('6568903789857736568');" onmouseout="out('6568903789857736568');" style="">   7 import android.content.Intent;                                                                           </span>
<span class="-8750621697125156872" onmouseenter="enter('-8750621697125156872');" onmouseout="out('-8750621697125156872');" style="">   8 import android.net.Uri;                                                                                  </span>
<span class="8301908088148850736" onmouseenter="enter('8301908088148850736');" onmouseout="out('8301908088148850736');" style="">   9 import android.os.ParcelUuid;                                                                            </span>
<span class="2517521963771876570" onmouseenter="enter('2517521963771876570');" onmouseout="out('2517521963771876570');" style="">  10 import android.support.v4.content.LocalBroadcastManager;                                                 </span>
<span  style="">  11                                                                                                          </span>
<span class="9072327285961251154" onmouseenter="enter('9072327285961251154');" onmouseout="out('9072327285961251154');" style="">  12 import org.slf4j.Logger;                                                                                 </span>
<span class="697043352225962606" onmouseenter="enter('697043352225962606');" onmouseout="out('697043352225962606');" style="">  13 import org.slf4j.LoggerFactory;                                                                          </span>
<span  style="">  14                                                                                                          </span>
<span class="-3926401431737521278" onmouseenter="enter('-3926401431737521278');" onmouseout="out('-3926401431737521278');" style="">  15 import java.io.File;                                                                                     </span>
<span class="-75475733228177869" onmouseenter="enter('-75475733228177869');" onmouseout="out('-75475733228177869');" style="">  16 import java.io.FileNotFoundException;                                                                    </span>
<span class="103340661636203254" onmouseenter="enter('103340661636203254');" onmouseout="out('103340661636203254');" style="">  17 import java.io.IOException;                                                                              </span>
<span class="5631563232245871054" onmouseenter="enter('5631563232245871054');" onmouseout="out('5631563232245871054');" style="">  18 import java.io.InputStream;                                                                              </span>
<span class="4621164050749610193" onmouseenter="enter('4621164050749610193');" onmouseout="out('4621164050749610193');" style="">  19 import java.io.OutputStream;                                                                             </span>
<span class="-4777627942089262832" onmouseenter="enter('-4777627942089262832');" onmouseout="out('-4777627942089262832');" style="">  20 import java.io.PipedInputStream;                                                                         </span>
<span class="5026237307424376420" onmouseenter="enter('5026237307424376420');" onmouseout="out('5026237307424376420');" style="">  21 import java.io.PipedOutputStream;                                                                        </span>
<span class="-5790770097715703577" onmouseenter="enter('-5790770097715703577');" onmouseout="out('-5790770097715703577');" style="">  22 import java.net.InetAddress;                                                                             </span>
<span class="-623186069646925252" onmouseenter="enter('-623186069646925252');" onmouseout="out('-623186069646925252');" style="">  23 import java.net.Socket;                                                                                  </span>
<span class="-6886346622632588502" onmouseenter="enter('-6886346622632588502');" onmouseout="out('-6886346622632588502');" style="">  24 import java.nio.ByteBuffer;                                                                              </span>
<span class="-4536046119683402321" onmouseenter="enter('-4536046119683402321');" onmouseout="out('-4536046119683402321');" style="">  25 import java.nio.ByteOrder;                                                                               </span>
<span  style="">  26                                                                                                          </span>
<span class="-8113221927992302576" onmouseenter="enter('-8113221927992302576');" onmouseout="out('-8113221927992302576');" style="">  27 import nodomain.freeyourgadget.gadgetbridge.GBApplication;                                               </span>
<span class="-7198279398549834921" onmouseenter="enter('-7198279398549834921');" onmouseout="out('-7198279398549834921');" style="">  28 import nodomain.freeyourgadget.gadgetbridge.R;                                                           </span>
<span class="5959948573825064529" onmouseenter="enter('5959948573825064529');" onmouseout="out('5959948573825064529');" style="">  29 import nodomain.freeyourgadget.gadgetbridge.activities.appmanager.AbstractAppManagerFragment;            </span>
<span class="-7454882487459214858" onmouseenter="enter('-7454882487459214858');" onmouseout="out('-7454882487459214858');" style="">  30 import nodomain.freeyourgadget.gadgetbridge.activities.appmanager.AppManagerActivity;                    </span>
<span class="8774236294555479386" onmouseenter="enter('8774236294555479386');" onmouseout="out('8774236294555479386');" style="">  31 import nodomain.freeyourgadget.gadgetbridge.deviceevents.GBDeviceEvent;                                  </span>
<span class="-4700446920707564194" onmouseenter="enter('-4700446920707564194');" onmouseout="out('-4700446920707564194');" style="">  32 import nodomain.freeyourgadget.gadgetbridge.deviceevents.GBDeviceEventAppInfo;                           </span>
<span class="-5686102242644058946" onmouseenter="enter('-5686102242644058946');" onmouseout="out('-5686102242644058946');" style="">  33 import nodomain.freeyourgadget.gadgetbridge.deviceevents.GBDeviceEventAppManagement;                     </span>
<span class="2791890994602016761" onmouseenter="enter('2791890994602016761');" onmouseout="out('2791890994602016761');" style="">  34 import nodomain.freeyourgadget.gadgetbridge.deviceevents.GBDeviceEventAppMessage;                        </span>
<span class="7456778970616733409" onmouseenter="enter('7456778970616733409');" onmouseout="out('7456778970616733409');" style="">  35 import nodomain.freeyourgadget.gadgetbridge.deviceevents.GBDeviceEventVersionInfo;                       </span>
<span class="-8786909529118259831" onmouseenter="enter('-8786909529118259831');" onmouseout="out('-8786909529118259831');" style="">  36 import nodomain.freeyourgadget.gadgetbridge.devices.pebble.PBWReader;                                    </span>
<span class="-6745962823678362300" onmouseenter="enter('-6745962823678362300');" onmouseout="out('-6745962823678362300');" style="">  37 import nodomain.freeyourgadget.gadgetbridge.devices.pebble.PebbleInstallable;                            </span>
<span class="4836892992022606579" onmouseenter="enter('4836892992022606579');" onmouseout="out('4836892992022606579');" style="">  38 import nodomain.freeyourgadget.gadgetbridge.impl.GBDevice;                                               </span>
<span class="-6775704228596592306" onmouseenter="enter('-6775704228596592306');" onmouseout="out('-6775704228596592306');" style="">  39 import nodomain.freeyourgadget.gadgetbridge.impl.GBDeviceApp;                                            </span>
<span class="-1754164907108633436" onmouseenter="enter('-1754164907108633436');" onmouseout="out('-1754164907108633436');" style="">  40 import nodomain.freeyourgadget.gadgetbridge.service.devices.pebble.ble.PebbleLESupport;                  </span>
<span class="-211901022449891328" onmouseenter="enter('-211901022449891328');" onmouseout="out('-211901022449891328');" style="">  41 import nodomain.freeyourgadget.gadgetbridge.service.serial.GBDeviceIoThread;                             </span>
<span class="-2195471833159259314" onmouseenter="enter('-2195471833159259314');" onmouseout="out('-2195471833159259314');" style="">  42 import nodomain.freeyourgadget.gadgetbridge.service.serial.GBDeviceProtocol;                             </span>
<span class="-2020231768395052380" onmouseenter="enter('-2020231768395052380');" onmouseout="out('-2020231768395052380');" style="">  43 import nodomain.freeyourgadget.gadgetbridge.util.FileUtils;                                              </span>
<span class="-3798970344596478499" onmouseenter="enter('-3798970344596478499');" onmouseout="out('-3798970344596478499');" style="">  44 import nodomain.freeyourgadget.gadgetbridge.util.GB;                                                     </span>
<span class="4645284583739884744" onmouseenter="enter('4645284583739884744');" onmouseout="out('4645284583739884744');" style="">  45 import nodomain.freeyourgadget.gadgetbridge.util.PebbleUtils;                                            </span>
<span class="-600862318521663319" onmouseenter="enter('-600862318521663319');" onmouseout="out('-600862318521663319');" style="">  46 import nodomain.freeyourgadget.gadgetbridge.util.Prefs;                                                  </span>
<span class="-425744571032727695" onmouseenter="enter('-425744571032727695');" onmouseout="out('-425744571032727695');" style="">  47 import nodomain.freeyourgadget.gadgetbridge.util.WebViewSingleton;                                       </span>
<span  style="">  48                                                                                                          </span>
<span class="2468896418036970449" onmouseenter="enter('2468896418036970449');" onmouseout="out('2468896418036970449');" style="">  49 class PebbleIoThread extends GBDeviceIoThread {                                                          </span>
<span class="2529670288626938632" onmouseenter="enter('2529670288626938632');" onmouseout="out('2529670288626938632');" style="">  50     private static final Logger LOG = LoggerFactory.getLogger(PebbleIoThread.class);                     </span>
<span  style="">  51                                                                                                          </span>
<span class="-4632193205469069671" onmouseenter="enter('-4632193205469069671');" onmouseout="out('-4632193205469069671');" style="">  52     private final Prefs prefs = GBApplication.getPrefs();                                                </span>
<span  style="">  53                                                                                                          </span>
<span class="-6631401332787692352" onmouseenter="enter('-6631401332787692352');" onmouseout="out('-6631401332787692352');" style="">  54     private final PebbleProtocol mPebbleProtocol;                                                        </span>
<span class="1328262475374241602" onmouseenter="enter('1328262475374241602');" onmouseout="out('1328262475374241602');" style="">  55     private final PebbleSupport mPebbleSupport;                                                          </span>
<span class="-2685935515172486802" onmouseenter="enter('-2685935515172486802');" onmouseout="out('-2685935515172486802');" style="">  56     private PebbleKitSupport mPebbleKitSupport;                                                          </span>
<span class="5255281464364524557" onmouseenter="enter('5255281464364524557');" onmouseout="out('5255281464364524557');" style="">  57     private final boolean mEnablePebblekit;                                                              </span>
<span  style="">  58                                                                                                          </span>
<span class="-1663504808667212623" onmouseenter="enter('-1663504808667212623');" onmouseout="out('-1663504808667212623');" style="">  59     private boolean mIsTCP = false;                                                                      </span>
<span class="7891956114489637668" onmouseenter="enter('7891956114489637668');" onmouseout="out('7891956114489637668');" style="">  60     private BluetoothAdapter mBtAdapter = null;                                                          </span>
<span class="-3474230100367526093" onmouseenter="enter('-3474230100367526093');" onmouseout="out('-3474230100367526093');" style="">  61     private BluetoothSocket mBtSocket = null;                                                            </span>
<span class="4972621324459114153" onmouseenter="enter('4972621324459114153');" onmouseout="out('4972621324459114153');" style="">  62     private Socket mTCPSocket = null; // for emulator                                                    </span>
<span class="8464954913827308931" onmouseenter="enter('8464954913827308931');" onmouseout="out('8464954913827308931');" style="">  63     private InputStream mInStream = null;                                                                </span>
<span class="176817746371882191" onmouseenter="enter('176817746371882191');" onmouseout="out('176817746371882191');" style="">  64     private OutputStream mOutStream = null;                                                              </span>
<span class="3507668063671934062" onmouseenter="enter('3507668063671934062');" onmouseout="out('3507668063671934062');" style="">  65     private PebbleLESupport mPebbleLESupport;                                                            </span>
<span  style="">  66                                                                                                          </span>
<span class="8291227991234502986" onmouseenter="enter('8291227991234502986');" onmouseout="out('8291227991234502986');" style="">  67     private boolean mQuit = false;                                                                       </span>
<span class="-4308649044970502514" onmouseenter="enter('-4308649044970502514');" onmouseout="out('-4308649044970502514');" style="">  68     private boolean mIsConnected = false;                                                                </span>
<span class="591172670703241498" onmouseenter="enter('591172670703241498');" onmouseout="out('591172670703241498');" style="">  69     private boolean mIsInstalling = false;                                                               </span>
<span  style="">  70                                                                                                          </span>
<span class="7746276727914849634" onmouseenter="enter('7746276727914849634');" onmouseout="out('7746276727914849634');" style="">  71     private PBWReader mPBWReader = null;                                                                 </span>
<span class="1166586313023966318" onmouseenter="enter('1166586313023966318');" onmouseout="out('1166586313023966318');" style="">  72     private GBDeviceApp mCurrentlyInstallingApp = null;                                                  </span>
<span class="-1645742411754742536" onmouseenter="enter('-1645742411754742536');" onmouseout="out('-1645742411754742536');" style="">  73     private int mAppInstallToken = -1;                                                                   </span>
<span class="-3680441812231545667" onmouseenter="enter('-3680441812231545667');" onmouseout="out('-3680441812231545667');" style="">  74     private InputStream mFis = null;                                                                     </span>
<span class="8056811120544011853" onmouseenter="enter('8056811120544011853');" onmouseout="out('8056811120544011853');" style="">  75     private PebbleAppInstallState mInstallState = PebbleAppInstallState.UNKNOWN;                         </span>
<span class="2315852437300231853" onmouseenter="enter('2315852437300231853');" onmouseout="out('2315852437300231853');" style="">  76     private PebbleInstallable[] mPebbleInstallables = null;                                              </span>
<span class="-6610002799635202363" onmouseenter="enter('-6610002799635202363');" onmouseout="out('-6610002799635202363');" style="">  77     private int mCurrentInstallableIndex = -1;                                                           </span>
<span class="-6569382683370215618" onmouseenter="enter('-6569382683370215618');" onmouseout="out('-6569382683370215618');" style="">  78     private int mInstallSlot = -2;                                                                       </span>
<span class="-8194648222476538160" onmouseenter="enter('-8194648222476538160');" onmouseout="out('-8194648222476538160');" style="">  79     private int mCRC = -1;                                                                               </span>
<span class="-2481332028036817904" onmouseenter="enter('-2481332028036817904');" onmouseout="out('-2481332028036817904');" style="">  80     private int mBinarySize = -1;                                                                        </span>
<span class="-1832879895999614218" onmouseenter="enter('-1832879895999614218');" onmouseout="out('-1832879895999614218');" style="">  81     private int mBytesWritten = -1;                                                                      </span>
<span  style="">  82                                                                                                          </span>
<span class="-8000809992863847428" onmouseenter="enter('-8000809992863847428');" onmouseout="out('-8000809992863847428');" style="">  83     private void sendAppMessageJS(GBDeviceEventAppMessage appMessage) {                                  </span>
<span class="5061350280559930277" onmouseenter="enter('5061350280559930277');" onmouseout="out('5061350280559930277');" style="">  84         WebViewSingleton.getorInitWebView(getContext(), gbDevice, appMessage.appUUID);                   </span>
<span class="-2478103463940331708" onmouseenter="enter('-2478103463940331708');" onmouseout="out('-2478103463940331708');" style="">  85         WebViewSingleton.appMessage(appMessage.message);                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  86     }                                                                                                    </span>
<span  style="">  87                                                                                                          </span>
<span class="-1707422926868996417" onmouseenter="enter('-1707422926868996417');" onmouseout="out('-1707422926868996417');" style=""><abbr title="  88     PebbleIoThread(PebbleSupport pebbleSupport, GBDevice gbDevice, GBDeviceProtocol gbDeviceProtocol, BluetoothAdapter btAdapter, Context context) {">  88     PebbleIoThread(PebbleSupport pebbleSupport, GBDevice gbDevice, GBDeviceProtocol gbDeviceProtocol, BluðŸ”µ</abbr></span>
<span class="-4446577987516131269" onmouseenter="enter('-4446577987516131269');" onmouseout="out('-4446577987516131269');" style="">  89         super(gbDevice, context);                                                                        </span>
<span class="-535847603056830094" onmouseenter="enter('-535847603056830094');" onmouseout="out('-535847603056830094');" style="">  90         mPebbleProtocol = (PebbleProtocol) gbDeviceProtocol;                                             </span>
<span class="-7802515276203668031" onmouseenter="enter('-7802515276203668031');" onmouseout="out('-7802515276203668031');" style="">  91         mBtAdapter = btAdapter;                                                                          </span>
<span class="-175348863880720182" onmouseenter="enter('-175348863880720182');" onmouseout="out('-175348863880720182');" style="">  92         mPebbleSupport = pebbleSupport;                                                                  </span>
<span class="-766654887411083682" onmouseenter="enter('-766654887411083682');" onmouseout="out('-766654887411083682');" style="">  93         mEnablePebblekit = prefs.getBoolean(&quot;pebble_enable_pebblekit&quot;, false);                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  94     }                                                                                                    </span>
<span  style="">  95                                                                                                          </span>
<span class="-2292081679562824726" onmouseenter="enter('-2292081679562824726');" onmouseout="out('-2292081679562824726');" style=""><abbr title="  96     private int readWithException(InputStream inputStream, byte[] buffer, int byteOffset, int byteCount) throws IOException {">  96     private int readWithException(InputStream inputStream, byte[] buffer, int byteOffset, int byteCount) ðŸ”µ</abbr></span>
<span class="4268945675950741459" onmouseenter="enter('4268945675950741459');" onmouseout="out('4268945675950741459');" style="">  97         int ret = inputStream.read(buffer, byteOffset, byteCount);                                       </span>
<span class="3796083344931271004" onmouseenter="enter('3796083344931271004');" onmouseout="out('3796083344931271004');" style="">  98         if (ret == -1) {                                                                                 </span>
<span class="8493867222528380496" onmouseenter="enter('8493867222528380496');" onmouseout="out('8493867222528380496');" style="">  99             throw new IOException(&quot;broken pipe&quot;);                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 100         }                                                                                                </span>
<span class="1456633081770441725" onmouseenter="enter('1456633081770441725');" onmouseout="out('1456633081770441725');" style=""> 101         return ret;                                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 102     }                                                                                                    </span>
<span  style=""> 103                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 104     @Override                                                                                            </span>
<span class="-689441939839417419" onmouseenter="enter('-689441939839417419');" onmouseout="out('-689441939839417419');" style=""> 105     protected boolean connect() {                                                                        </span>
<span class="7179548470555074529" onmouseenter="enter('7179548470555074529');" onmouseout="out('7179548470555074529');" style=""> 106         String deviceAddress = gbDevice.getAddress();                                                    </span>
<span class="8603377014623514599" onmouseenter="enter('8603377014623514599');" onmouseout="out('8603377014623514599');" style=""> 107         GBDevice.State originalState = gbDevice.getState();                                              </span>
<span class="-2168554989878345062" onmouseenter="enter('-2168554989878345062');" onmouseout="out('-2168554989878345062');" style=""> 108         gbDevice.setState(GBDevice.State.CONNECTING);                                                    </span>
<span class="-6083303279196581322" onmouseenter="enter('-6083303279196581322');" onmouseout="out('-6083303279196581322');" style=""> 109         gbDevice.sendDeviceUpdateIntent(getContext());                                                   </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 110         try {                                                                                            </span>
<span class="-8563020019953546005" onmouseenter="enter('-8563020019953546005');" onmouseout="out('-8563020019953546005');" style=""> 111             // contains only one &quot;:&quot;? then it is addr:port                                               </span>
<span class="-146660580149754487" onmouseenter="enter('-146660580149754487');" onmouseout="out('-146660580149754487');" style=""> 112             int firstColon = deviceAddress.indexOf(&quot;:&quot;);                                                 </span>
<span class="5048700417952215836" onmouseenter="enter('5048700417952215836');" onmouseout="out('5048700417952215836');" style=""> 113             if (firstColon == deviceAddress.lastIndexOf(&quot;:&quot;)) {                                          </span>
<span class="-8977049560738769524" onmouseenter="enter('-8977049560738769524');" onmouseout="out('-8977049560738769524');" style=""> 114                 mIsTCP = true;                                                                           </span>
<span class="-6378857250762995034" onmouseenter="enter('-6378857250762995034');" onmouseout="out('-6378857250762995034');" style=""> 115                 InetAddress serverAddr = InetAddress.getByName(deviceAddress.substring(0, firstColon));  </span>
<span class="3468657720829688371" onmouseenter="enter('3468657720829688371');" onmouseout="out('3468657720829688371');" style=""><abbr title=" 116                 mTCPSocket = new Socket(serverAddr, Integer.parseInt(deviceAddress.substring(firstColon + 1)));"> 116                 mTCPSocket = new Socket(serverAddr, Integer.parseInt(deviceAddress.substring(firstColon +ðŸ”µ</abbr></span>
<span class="-6670767050188612078" onmouseenter="enter('-6670767050188612078');" onmouseout="out('-6670767050188612078');" style=""> 117                 mInStream = mTCPSocket.getInputStream();                                                 </span>
<span class="-6104065159882353101" onmouseenter="enter('-6104065159882353101');" onmouseout="out('-6104065159882353101');" style=""> 118                 mOutStream = mTCPSocket.getOutputStream();                                               </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 119             } else {                                                                                     </span>
<span class="4347759254647630465" onmouseenter="enter('4347759254647630465');" onmouseout="out('4347759254647630465');" style=""> 120                 mIsTCP = false;                                                                          </span>
<span class="6443654244968138967" onmouseenter="enter('6443654244968138967');" onmouseout="out('6443654244968138967');" style=""><abbr title=" 121                 if (gbDevice.getVolatileAddress() != null &amp;&amp; prefs.getBoolean(&quot;pebble_force_le&quot;, false)) {"> 121                 if (gbDevice.getVolatileAddress() != null &amp;&amp; prefs.getBoolean(&quot;pebble_force_le&quot;, false)) ðŸ”µ</abbr></span>
<span class="915290997518797062" onmouseenter="enter('915290997518797062');" onmouseout="out('915290997518797062');" style=""> 122                     deviceAddress = gbDevice.getVolatileAddress();                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 123                 }                                                                                        </span>
<span class="4786675468629518746" onmouseenter="enter('4786675468629518746');" onmouseout="out('4786675468629518746');" style=""> 124                 BluetoothDevice btDevice = mBtAdapter.getRemoteDevice(deviceAddress);                    </span>
<span class="335623565325713065" onmouseenter="enter('335623565325713065');" onmouseout="out('335623565325713065');" style=""> 125                 if (btDevice.getType() == BluetoothDevice.DEVICE_TYPE_LE) {                              </span>
<span class="8333508526895931889" onmouseenter="enter('8333508526895931889');" onmouseout="out('8333508526895931889');" style=""> 126                     LOG.info(&quot;This is a Pebble 2 or Pebble-LE/Pebble Time LE, will use BLE&quot;);            </span>
<span class="-3562679261979772904" onmouseenter="enter('-3562679261979772904');" onmouseout="out('-3562679261979772904');" style=""> 127                     mInStream = new PipedInputStream();                                                  </span>
<span class="6393093760748525382" onmouseenter="enter('6393093760748525382');" onmouseout="out('6393093760748525382');" style=""> 128                     mOutStream = new PipedOutputStream();                                                </span>
<span class="2915722355401222377" onmouseenter="enter('2915722355401222377');" onmouseout="out('2915722355401222377');" style=""><abbr title=" 129                     mPebbleLESupport = new PebbleLESupport(this.getContext(), btDevice, (PipedInputStream) mInStream, (PipedOutputStream) mOutStream);"> 129                     mPebbleLESupport = new PebbleLESupport(this.getContext(), btDevice, (PipedInputStreamðŸ”µ</abbr></span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 130                 } else {                                                                                 </span>
<span class="8228468292686787155" onmouseenter="enter('8228468292686787155');" onmouseout="out('8228468292686787155');" style=""> 131                     ParcelUuid uuids[] = btDevice.getUuids();                                            </span>
<span class="2503839032557077084" onmouseenter="enter('2503839032557077084');" onmouseout="out('2503839032557077084');" style=""> 132                     if (uuids == null) {                                                                 </span>
<span class="-5432226360745882584" onmouseenter="enter('-5432226360745882584');" onmouseout="out('-5432226360745882584');" style=""> 133                         return false;                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 134                     }                                                                                    </span>
<span class="8104594939174164082" onmouseenter="enter('8104594939174164082');" onmouseout="out('8104594939174164082');" style=""> 135                     for (ParcelUuid uuid : uuids) {                                                      </span>
<span class="5496152670479511454" onmouseenter="enter('5496152670479511454');" onmouseout="out('5496152670479511454');" style=""> 136                         LOG.info(&quot;found service UUID &quot; + uuid);                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 137                     }                                                                                    </span>
<span class="-2085322778834697972" onmouseenter="enter('-2085322778834697972');" onmouseout="out('-2085322778834697972');" style=""> 138                     mBtSocket = btDevice.createRfcommSocketToServiceRecord(uuids[0].getUuid());          </span>
<span class="-617547228937795237" onmouseenter="enter('-617547228937795237');" onmouseout="out('-617547228937795237');" style=""> 139                     mBtSocket.connect();                                                                 </span>
<span class="-4553264448616972703" onmouseenter="enter('-4553264448616972703');" onmouseout="out('-4553264448616972703');" style=""> 140                     mInStream = mBtSocket.getInputStream();                                              </span>
<span class="-4296883704518407532" onmouseenter="enter('-4296883704518407532');" onmouseout="out('-4296883704518407532');" style=""> 141                     mOutStream = mBtSocket.getOutputStream();                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 142                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 143             }                                                                                            </span>
<span class="7080241092423381085" onmouseenter="enter('7080241092423381085');" onmouseout="out('7080241092423381085');" style=""> 144         } catch (IOException e) {                                                                        </span>
<span class="4090663313211582937" onmouseenter="enter('4090663313211582937');" onmouseout="out('4090663313211582937');" style=""> 145             e.printStackTrace();                                                                         </span>
<span class="5984241666527947087" onmouseenter="enter('5984241666527947087');" onmouseout="out('5984241666527947087');" style=""> 146             gbDevice.setState(originalState);                                                            </span>
<span class="-6083303279196581322" onmouseenter="enter('-6083303279196581322');" onmouseout="out('-6083303279196581322');" style=""> 147             gbDevice.sendDeviceUpdateIntent(getContext());                                               </span>
<span  style=""> 148                                                                                                          </span>
<span class="3085765988076808372" onmouseenter="enter('3085765988076808372');" onmouseout="out('3085765988076808372');" style=""> 149             mInStream = null;                                                                            </span>
<span class="4968882532143556776" onmouseenter="enter('4968882532143556776');" onmouseout="out('4968882532143556776');" style=""> 150             mOutStream = null;                                                                           </span>
<span class="-4534501040604870855" onmouseenter="enter('-4534501040604870855');" onmouseout="out('-4534501040604870855');" style=""> 151             mBtSocket = null;                                                                            </span>
<span class="-5432226360745882584" onmouseenter="enter('-5432226360745882584');" onmouseout="out('-5432226360745882584');" style=""> 152             return false;                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 153         }                                                                                                </span>
<span  style=""> 154                                                                                                          </span>
<span class="1677595949374963054" onmouseenter="enter('1677595949374963054');" onmouseout="out('1677595949374963054');" style=""> 155         mPebbleProtocol.setForceProtocol(prefs.getBoolean(&quot;pebble_force_protocol&quot;, false));              </span>
<span  style=""> 156                                                                                                          </span>
<span class="5928608366163593597" onmouseenter="enter('5928608366163593597');" onmouseout="out('5928608366163593597');" style=""> 157         mIsConnected = true;                                                                             </span>
<span class="3321416181738117978" onmouseenter="enter('3321416181738117978');" onmouseout="out('3321416181738117978');" style=""> 158         write(mPebbleProtocol.encodeFirmwareVersionReq());                                               </span>
<span class="-7904642316416307948" onmouseenter="enter('-7904642316416307948');" onmouseout="out('-7904642316416307948');" style=""> 159         gbDevice.setState(GBDevice.State.CONNECTED);                                                     </span>
<span class="-6083303279196581322" onmouseenter="enter('-6083303279196581322');" onmouseout="out('-6083303279196581322');" style=""> 160         gbDevice.sendDeviceUpdateIntent(getContext());                                                   </span>
<span  style=""> 161                                                                                                          </span>
<span class="-3118901906653197100" onmouseenter="enter('-3118901906653197100');" onmouseout="out('-3118901906653197100');" style=""> 162         return true;                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 163     }                                                                                                    </span>
<span  style=""> 164                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 165     @Override                                                                                            </span>
<span class="5292860430507443886" onmouseenter="enter('5292860430507443886');" onmouseout="out('5292860430507443886');" style=""> 166     public void run() {                                                                                  </span>
<span class="-2588539367217579258" onmouseenter="enter('-2588539367217579258');" onmouseout="out('-2588539367217579258');" style=""> 167         mIsConnected = connect();                                                                        </span>
<span class="-245134013635442990" onmouseenter="enter('-245134013635442990');" onmouseout="out('-245134013635442990');" style=""> 168         if (!mIsConnected) {                                                                             </span>
<span class="2633273029186728772" onmouseenter="enter('2633273029186728772');" onmouseout="out('2633273029186728772');" style=""> 169             if (GBApplication.getGBPrefs().getAutoReconnect() &amp;&amp; !mQuit) {                               </span>
<span class="3557129149179391090" onmouseenter="enter('3557129149179391090');" onmouseout="out('3557129149179391090');" style=""> 170                 gbDevice.setState(GBDevice.State.WAITING_FOR_RECONNECT);                                 </span>
<span class="-6083303279196581322" onmouseenter="enter('-6083303279196581322');" onmouseout="out('-6083303279196581322');" style=""> 171                 gbDevice.sendDeviceUpdateIntent(getContext());                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 172             }                                                                                            </span>
<span class="4043029072030362567" onmouseenter="enter('4043029072030362567');" onmouseout="out('4043029072030362567');" style=""> 173             return;                                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 174         }                                                                                                </span>
<span  style=""> 175                                                                                                          </span>
<span class="2624641968800564380" onmouseenter="enter('2624641968800564380');" onmouseout="out('2624641968800564380');" style=""> 176         byte[] buffer = new byte[8192];                                                                  </span>
<span class="8018073170313256099" onmouseenter="enter('8018073170313256099');" onmouseout="out('8018073170313256099');" style=""> 177         enablePebbleKitSupport(true);                                                                    </span>
<span class="-8765366791852935627" onmouseenter="enter('-8765366791852935627');" onmouseout="out('-8765366791852935627');" style=""> 178         mQuit = false;                                                                                   </span>
<span class="-6588719847383972316" onmouseenter="enter('-6588719847383972316');" onmouseout="out('-6588719847383972316');" style=""> 179         while (!mQuit) {                                                                                 </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 180             try {                                                                                        </span>
<span class="-8278348814669106484" onmouseenter="enter('-8278348814669106484');" onmouseout="out('-8278348814669106484');" style=""> 181                 if (mIsInstalling) {                                                                     </span>
<span class="8684367013652331710" onmouseenter="enter('8684367013652331710');" onmouseout="out('8684367013652331710');" style=""> 182                     switch (mInstallState) {                                                             </span>
<span class="7026400303061140058" onmouseenter="enter('7026400303061140058');" onmouseout="out('7026400303061140058');" style=""> 183                         case WAIT_SLOT:                                                                  </span>
<span class="-2690055123266986251" onmouseenter="enter('-2690055123266986251');" onmouseout="out('-2690055123266986251');" style=""> 184                             if (mInstallSlot == -1) {                                                    </span>
<span class="-3606888775151099353" onmouseenter="enter('-3606888775151099353');" onmouseout="out('-3606888775151099353');" style=""> 185                                 finishInstall(true); // no slots available                               </span>
<span class="2295401759568749857" onmouseenter="enter('2295401759568749857');" onmouseout="out('2295401759568749857');" style=""> 186                             } else if (mInstallSlot &gt;= 0) {                                              </span>
<span class="6147346456613268497" onmouseenter="enter('6147346456613268497');" onmouseout="out('6147346456613268497');" style=""> 187                                 mInstallState = PebbleAppInstallState.START_INSTALL;                     </span>
<span class="-6362435147834875541" onmouseenter="enter('-6362435147834875541');" onmouseout="out('-6362435147834875541');" style=""> 188                                 continue;                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 189                             }                                                                            </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 190                             break;                                                                       </span>
<span class="-3962643594977912505" onmouseenter="enter('-3962643594977912505');" onmouseout="out('-3962643594977912505');" style=""> 191                         case START_INSTALL:                                                              </span>
<span class="-5574718196482043222" onmouseenter="enter('-5574718196482043222');" onmouseout="out('-5574718196482043222');" style=""> 192                             LOG.info(&quot;start installing app binary&quot;);                                     </span>
<span class="5478053508733530178" onmouseenter="enter('5478053508733530178');" onmouseout="out('5478053508733530178');" style=""> 193                             PebbleInstallable pi = mPebbleInstallables[mCurrentInstallableIndex];        </span>
<span class="3659756883627403325" onmouseenter="enter('3659756883627403325');" onmouseout="out('3659756883627403325');" style=""> 194                             mFis = mPBWReader.getInputStreamFile(pi.getFileName());                      </span>
<span class="5016659144309369034" onmouseenter="enter('5016659144309369034');" onmouseout="out('5016659144309369034');" style=""> 195                             mCRC = pi.getCRC();                                                          </span>
<span class="3142625636824209099" onmouseenter="enter('3142625636824209099');" onmouseout="out('3142625636824209099');" style=""> 196                             mBinarySize = pi.getFileSize();                                              </span>
<span class="4161899041554384973" onmouseenter="enter('4161899041554384973');" onmouseout="out('4161899041554384973');" style=""> 197                             mBytesWritten = 0;                                                           </span>
<span class="-1767419274223935649" onmouseenter="enter('-1767419274223935649');" onmouseout="out('-1767419274223935649');" style=""><abbr title=" 198                             writeInstallApp(mPebbleProtocol.encodeUploadStart(pi.getType(), mInstallSlot, mBinarySize, mPBWReader.isLanguage() ? &quot;lang&quot; : null));"> 198                             writeInstallApp(mPebbleProtocol.encodeUploadStart(pi.getType(), mInstallSlot,ðŸ”µ</abbr></span>
<span class="-556680889075439690" onmouseenter="enter('-556680889075439690');" onmouseout="out('-556680889075439690');" style=""> 199                             mAppInstallToken = -1;                                                       </span>
<span class="-7999689873557895203" onmouseenter="enter('-7999689873557895203');" onmouseout="out('-7999689873557895203');" style=""> 200                             mInstallState = PebbleAppInstallState.WAIT_TOKEN;                            </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 201                             break;                                                                       </span>
<span class="6792169580692674220" onmouseenter="enter('6792169580692674220');" onmouseout="out('6792169580692674220');" style=""> 202                         case WAIT_TOKEN:                                                                 </span>
<span class="-3832708479724599095" onmouseenter="enter('-3832708479724599095');" onmouseout="out('-3832708479724599095');" style=""> 203                             if (mAppInstallToken != -1) {                                                </span>
<span class="-8049659333726333512" onmouseenter="enter('-8049659333726333512');" onmouseout="out('-8049659333726333512');" style=""> 204                                 LOG.info(&quot;got token &quot; + mAppInstallToken);                               </span>
<span class="5531590291586303132" onmouseenter="enter('5531590291586303132');" onmouseout="out('5531590291586303132');" style=""> 205                                 mInstallState = PebbleAppInstallState.UPLOAD_CHUNK;                      </span>
<span class="-6362435147834875541" onmouseenter="enter('-6362435147834875541');" onmouseout="out('-6362435147834875541');" style=""> 206                                 continue;                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 207                             }                                                                            </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 208                             break;                                                                       </span>
<span class="-584114172413593495" onmouseenter="enter('-584114172413593495');" onmouseout="out('-584114172413593495');" style=""> 209                         case UPLOAD_CHUNK:                                                               </span>
<span class="1528466301664079417" onmouseenter="enter('1528466301664079417');" onmouseout="out('1528466301664079417');" style=""> 210                             int bytes = 0;                                                               </span>
<span class="3052837437029247759" onmouseenter="enter('3052837437029247759');" onmouseout="out('3052837437029247759');" style=""> 211                             do {                                                                         </span>
<span class="1834678701284410601" onmouseenter="enter('1834678701284410601');" onmouseout="out('1834678701284410601');" style=""> 212                                 int read = mFis.read(buffer, bytes, 2000 - bytes);                       </span>
<span class="-6442970889778139424" onmouseenter="enter('-6442970889778139424');" onmouseout="out('-6442970889778139424');" style=""> 213                                 if (read &lt;= 0) break;                                                    </span>
<span class="-8945043921272536992" onmouseenter="enter('-8945043921272536992');" onmouseout="out('-8945043921272536992');" style=""> 214                                 bytes += read;                                                           </span>
<span class="451207650617133464" onmouseenter="enter('451207650617133464');" onmouseout="out('451207650617133464');" style=""> 215                             } while (bytes &lt; 2000);                                                      </span>
<span  style=""> 216                                                                                                          </span>
<span class="6794246418348616673" onmouseenter="enter('6794246418348616673');" onmouseout="out('6794246418348616673');" style=""> 217                             if (bytes &gt; 0) {                                                             </span>
<span class="-5617191400623126363" onmouseenter="enter('-5617191400623126363');" onmouseout="out('-5617191400623126363');" style=""> 218                                 GB.updateInstallNotification(getContext().getString(                     </span>
<span class="4050487273412981374" onmouseenter="enter('4050487273412981374');" onmouseout="out('4050487273412981374');" style=""><abbr title=" 219                                         R.string.installing_binary_d_d, (mCurrentInstallableIndex + 1), mPebbleInstallables.length), true, (int) (((float) mBytesWritten / mBinarySize) * 100), getContext());"> 219                                         R.string.installing_binary_d_d, (mCurrentInstallableIndex + 1), mðŸ”µ</abbr></span>
<span class="-7477526339537165687" onmouseenter="enter('-7477526339537165687');" onmouseout="out('-7477526339537165687');" style=""><abbr title=" 220                                 writeInstallApp(mPebbleProtocol.encodeUploadChunk(mAppInstallToken, buffer, bytes));"> 220                                 writeInstallApp(mPebbleProtocol.encodeUploadChunk(mAppInstallToken, buffeðŸ”µ</abbr></span>
<span class="-4728151037181866094" onmouseenter="enter('-4728151037181866094');" onmouseout="out('-4728151037181866094');" style=""> 221                                 mBytesWritten += bytes;                                                  </span>
<span class="-556680889075439690" onmouseenter="enter('-556680889075439690');" onmouseout="out('-556680889075439690');" style=""> 222                                 mAppInstallToken = -1;                                                   </span>
<span class="-7999689873557895203" onmouseenter="enter('-7999689873557895203');" onmouseout="out('-7999689873557895203');" style=""> 223                                 mInstallState = PebbleAppInstallState.WAIT_TOKEN;                        </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 224                             } else {                                                                     </span>
<span class="-5094680563432242000" onmouseenter="enter('-5094680563432242000');" onmouseout="out('-5094680563432242000');" style=""> 225                                 mInstallState = PebbleAppInstallState.UPLOAD_COMMIT;                     </span>
<span class="-6362435147834875541" onmouseenter="enter('-6362435147834875541');" onmouseout="out('-6362435147834875541');" style=""> 226                                 continue;                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 227                             }                                                                            </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 228                             break;                                                                       </span>
<span class="4124538925361105547" onmouseenter="enter('4124538925361105547');" onmouseout="out('4124538925361105547');" style=""> 229                         case UPLOAD_COMMIT:                                                              </span>
<span class="-2966405575206880121" onmouseenter="enter('-2966405575206880121');" onmouseout="out('-2966405575206880121');" style=""> 230                             writeInstallApp(mPebbleProtocol.encodeUploadCommit(mAppInstallToken, mCRC)); </span>
<span class="-556680889075439690" onmouseenter="enter('-556680889075439690');" onmouseout="out('-556680889075439690');" style=""> 231                             mAppInstallToken = -1;                                                       </span>
<span class="-6886437457702083289" onmouseenter="enter('-6886437457702083289');" onmouseout="out('-6886437457702083289');" style=""> 232                             mInstallState = PebbleAppInstallState.WAIT_COMMIT;                           </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 233                             break;                                                                       </span>
<span class="-6760167966557106950" onmouseenter="enter('-6760167966557106950');" onmouseout="out('-6760167966557106950');" style=""> 234                         case WAIT_COMMIT:                                                                </span>
<span class="-3832708479724599095" onmouseenter="enter('-3832708479724599095');" onmouseout="out('-3832708479724599095');" style=""> 235                             if (mAppInstallToken != -1) {                                                </span>
<span class="-8049659333726333512" onmouseenter="enter('-8049659333726333512');" onmouseout="out('-8049659333726333512');" style=""> 236                                 LOG.info(&quot;got token &quot; + mAppInstallToken);                               </span>
<span class="-6772897424369466346" onmouseenter="enter('-6772897424369466346');" onmouseout="out('-6772897424369466346');" style=""> 237                                 mInstallState = PebbleAppInstallState.UPLOAD_COMPLETE;                   </span>
<span class="-6362435147834875541" onmouseenter="enter('-6362435147834875541');" onmouseout="out('-6362435147834875541');" style=""> 238                                 continue;                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 239                             }                                                                            </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 240                             break;                                                                       </span>
<span class="7185565864054148536" onmouseenter="enter('7185565864054148536');" onmouseout="out('7185565864054148536');" style=""> 241                         case UPLOAD_COMPLETE:                                                            </span>
<span class="5024538798090815598" onmouseenter="enter('5024538798090815598');" onmouseout="out('5024538798090815598');" style=""> 242                             writeInstallApp(mPebbleProtocol.encodeUploadComplete(mAppInstallToken));     </span>
<span class="-937796524014974666" onmouseenter="enter('-937796524014974666');" onmouseout="out('-937796524014974666');" style=""> 243                             if (++mCurrentInstallableIndex &lt; mPebbleInstallables.length) {               </span>
<span class="6147346456613268497" onmouseenter="enter('6147346456613268497');" onmouseout="out('6147346456613268497');" style=""> 244                                 mInstallState = PebbleAppInstallState.START_INSTALL;                     </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 245                             } else {                                                                     </span>
<span class="4645923661994641503" onmouseenter="enter('4645923661994641503');" onmouseout="out('4645923661994641503');" style=""> 246                                 mInstallState = PebbleAppInstallState.APP_REFRESH;                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 247                             }                                                                            </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 248                             break;                                                                       </span>
<span class="-4660819450142864885" onmouseenter="enter('-4660819450142864885');" onmouseout="out('-4660819450142864885');" style=""> 249                         case APP_REFRESH:                                                                </span>
<span class="1423594820264173048" onmouseenter="enter('1423594820264173048');" onmouseout="out('1423594820264173048');" style=""> 250                             if (mPBWReader.isFirmware()) {                                               </span>
<span class="7979692944967033784" onmouseenter="enter('7979692944967033784');" onmouseout="out('7979692944967033784');" style=""> 251                                 writeInstallApp(mPebbleProtocol.encodeInstallFirmwareComplete());        </span>
<span class="8670418135173104454" onmouseenter="enter('8670418135173104454');" onmouseout="out('8670418135173104454');" style=""> 252                                 finishInstall(false);                                                    </span>
<span class="-3229195631780864145" onmouseenter="enter('-3229195631780864145');" onmouseout="out('-3229195631780864145');" style=""> 253                             } else if (mPBWReader.isLanguage() || mPebbleProtocol.mFwMajor &gt;= 3) {       </span>
<span class="-3079811230585835514" onmouseenter="enter('-3079811230585835514');" onmouseout="out('-3079811230585835514');" style=""> 254                                 finishInstall(false); // FIXME: don&#x27;t know yet how to detect success     </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 255                             } else {                                                                     </span>
<span class="-3742154807253834306" onmouseenter="enter('-3742154807253834306');" onmouseout="out('-3742154807253834306');" style=""> 256                                 writeInstallApp(mPebbleProtocol.encodeAppRefresh(mInstallSlot));         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 257                             }                                                                            </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 258                             break;                                                                       </span>
<span class="-8178136317704390296" onmouseenter="enter('-8178136317704390296');" onmouseout="out('-8178136317704390296');" style=""> 259                         default:                                                                         </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 260                             break;                                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 261                     }                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 262                 }                                                                                        </span>
<span class="5578850974519966568" onmouseenter="enter('5578850974519966568');" onmouseout="out('5578850974519966568');" style=""> 263                 if (mIsTCP) {                                                                            </span>
<span class="4471698368272895479" onmouseenter="enter('4471698368272895479');" onmouseout="out('4471698368272895479');" style=""> 264                     mInStream.skip(6);                                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 265                 }                                                                                        </span>
<span class="2796952267402194740" onmouseenter="enter('2796952267402194740');" onmouseout="out('2796952267402194740');" style=""> 266                 int bytes = readWithException(mInStream, buffer, 0, 4);                                  </span>
<span  style=""> 267                                                                                                          </span>
<span class="-2171789871350536014" onmouseenter="enter('-2171789871350536014');" onmouseout="out('-2171789871350536014');" style=""> 268                 while (bytes &lt; 4) {                                                                      </span>
<span class="-5884925481451326841" onmouseenter="enter('-5884925481451326841');" onmouseout="out('-5884925481451326841');" style=""> 269                     bytes += readWithException(mInStream, buffer, bytes, 4 - bytes);                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 270                 }                                                                                        </span>
<span  style=""> 271                                                                                                          </span>
<span class="-7296955466977945724" onmouseenter="enter('-7296955466977945724');" onmouseout="out('-7296955466977945724');" style=""> 272                 ByteBuffer buf = ByteBuffer.wrap(buffer);                                                </span>
<span class="-8522898317938558799" onmouseenter="enter('-8522898317938558799');" onmouseout="out('-8522898317938558799');" style=""> 273                 buf.order(ByteOrder.BIG_ENDIAN);                                                         </span>
<span class="2800045307834810060" onmouseenter="enter('2800045307834810060');" onmouseout="out('2800045307834810060');" style=""> 274                 short length = buf.getShort();                                                           </span>
<span class="-8125815031192715923" onmouseenter="enter('-8125815031192715923');" onmouseout="out('-8125815031192715923');" style=""> 275                 short endpoint = buf.getShort();                                                         </span>
<span class="9045200348604116826" onmouseenter="enter('9045200348604116826');" onmouseout="out('9045200348604116826');" style=""> 276                 if (length &lt; 0 || length &gt; 8192) {                                                       </span>
<span class="9194134393824457103" onmouseenter="enter('9194134393824457103');" onmouseout="out('9194134393824457103');" style=""> 277                     LOG.info(&quot;invalid length &quot; + length);                                                </span>
<span class="-967764297694162849" onmouseenter="enter('-967764297694162849');" onmouseout="out('-967764297694162849');" style=""> 278                     while (mInStream.available() &gt; 0) {                                                  </span>
<span class="-1967224316023950474" onmouseenter="enter('-1967224316023950474');" onmouseout="out('-1967224316023950474');" style=""> 279                         readWithException(mInStream, buffer, 0, buffer.length); // read all              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 280                     }                                                                                    </span>
<span class="-6362435147834875541" onmouseenter="enter('-6362435147834875541');" onmouseout="out('-6362435147834875541');" style=""> 281                     continue;                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 282                 }                                                                                        </span>
<span  style=""> 283                                                                                                          </span>
<span class="8513682448486197246" onmouseenter="enter('8513682448486197246');" onmouseout="out('8513682448486197246');" style=""> 284                 bytes = readWithException(mInStream, buffer, 4, length);                                 </span>
<span class="-1011005986067945864" onmouseenter="enter('-1011005986067945864');" onmouseout="out('-1011005986067945864');" style=""> 285                 while (bytes &lt; length) {                                                                 </span>
<span class="-7104003189991341630" onmouseenter="enter('-7104003189991341630');" onmouseout="out('-7104003189991341630');" style=""> 286                     bytes += readWithException(mInStream, buffer, bytes + 4, length - bytes);            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 287                 }                                                                                        </span>
<span  style=""> 288                                                                                                          </span>
<span class="5578850974519966568" onmouseenter="enter('5578850974519966568');" onmouseout="out('5578850974519966568');" style=""> 289                 if (mIsTCP) {                                                                            </span>
<span class="5401038970459668826" onmouseenter="enter('5401038970459668826');" onmouseout="out('5401038970459668826');" style=""> 290                     mInStream.skip(2);                                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 291                 }                                                                                        </span>
<span  style=""> 292                                                                                                          </span>
<span class="-7909466471492476851" onmouseenter="enter('-7909466471492476851');" onmouseout="out('-7909466471492476851');" style=""> 293                 GBDeviceEvent deviceEvents[] = mPebbleProtocol.decodeResponse(buffer);                   </span>
<span class="-638626929611439615" onmouseenter="enter('-638626929611439615');" onmouseout="out('-638626929611439615');" style=""> 294                 if (deviceEvents == null) {                                                              </span>
<span class="-7056050649624941936" onmouseenter="enter('-7056050649624941936');" onmouseout="out('-7056050649624941936');" style=""> 295                     LOG.info(&quot;unhandled message to endpoint &quot; + endpoint + &quot; (&quot; + length + &quot; bytes)&quot;);   </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 296                 } else {                                                                                 </span>
<span class="1477693521293066497" onmouseenter="enter('1477693521293066497');" onmouseout="out('1477693521293066497');" style=""> 297                     for (GBDeviceEvent deviceEvent : deviceEvents) {                                     </span>
<span class="2097356587238774416" onmouseenter="enter('2097356587238774416');" onmouseout="out('2097356587238774416');" style=""> 298                         if (deviceEvent == null) {                                                       </span>
<span class="-6362435147834875541" onmouseenter="enter('-6362435147834875541');" onmouseout="out('-6362435147834875541');" style=""> 299                             continue;                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 300                         }                                                                                </span>
<span class="-236987672843521774" onmouseenter="enter('-236987672843521774');" onmouseout="out('-236987672843521774');" style=""> 301                         if (!evaluateGBDeviceEventPebble(deviceEvent)) {                                 </span>
<span class="7042821987734772133" onmouseenter="enter('7042821987734772133');" onmouseout="out('7042821987734772133');" style=""> 302                             mPebbleSupport.evaluateGBDeviceEvent(deviceEvent);                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 303                         }                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 304                     }                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 305                 }                                                                                        </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 306                 try {                                                                                    </span>
<span class="1958254861600319008" onmouseenter="enter('1958254861600319008');" onmouseout="out('1958254861600319008');" style=""> 307                     Thread.sleep(100);                                                                   </span>
<span class="-7528533024404460182" onmouseenter="enter('-7528533024404460182');" onmouseout="out('-7528533024404460182');" style=""> 308                 } catch (InterruptedException e) {                                                       </span>
<span class="4090663313211582937" onmouseenter="enter('4090663313211582937');" onmouseout="out('4090663313211582937');" style=""> 309                     e.printStackTrace();                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 310                 }                                                                                        </span>
<span class="7080241092423381085" onmouseenter="enter('7080241092423381085');" onmouseout="out('7080241092423381085');" style=""> 311             } catch (IOException e) {                                                                    </span>
<span class="-508556787667332479" onmouseenter="enter('-508556787667332479');" onmouseout="out('-508556787667332479');" style=""><abbr title=" 312                 if (e.getMessage() != null &amp;&amp; (e.getMessage().equals(&quot;broken pipe&quot;) || e.getMessage().contains(&quot;socket closed&quot;))) { //FIXME: this does not feel right"> 312                 if (e.getMessage() != null &amp;&amp; (e.getMessage().equals(&quot;broken pipe&quot;) || e.getMessage().conðŸ”µ</abbr></span>
<span class="3941064908834146545" onmouseenter="enter('3941064908834146545');" onmouseout="out('3941064908834146545');" style=""> 313                     LOG.info(e.getMessage());                                                            </span>
<span class="1054919517095572489" onmouseenter="enter('1054919517095572489');" onmouseout="out('1054919517095572489');" style=""> 314                     mIsConnected = false;                                                                </span>
<span class="1961225799194435069" onmouseenter="enter('1961225799194435069');" onmouseout="out('1961225799194435069');" style=""> 315                     int reconnectAttempts = prefs.getInt(&quot;pebble_reconnect_attempts&quot;, 10);               </span>
<span class="-786112365036832199" onmouseenter="enter('-786112365036832199');" onmouseout="out('-786112365036832199');" style=""><abbr title=" 316                     if (!mQuit &amp;&amp; GBApplication.getGBPrefs().getAutoReconnect() &amp;&amp; reconnectAttempts &gt; 0) {"> 316                     if (!mQuit &amp;&amp; GBApplication.getGBPrefs().getAutoReconnect() &amp;&amp; reconnectAttempts &gt; 0)ðŸ”µ</abbr></span>
<span class="3557129149179391090" onmouseenter="enter('3557129149179391090');" onmouseout="out('3557129149179391090');" style=""> 317                         gbDevice.setState(GBDevice.State.WAITING_FOR_RECONNECT);                         </span>
<span class="-6083303279196581322" onmouseenter="enter('-6083303279196581322');" onmouseout="out('-6083303279196581322');" style=""> 318                         gbDevice.sendDeviceUpdateIntent(getContext());                                   </span>
<span  style=""> 319                                                                                                          </span>
<span class="6110344959180570674" onmouseenter="enter('6110344959180570674');" onmouseout="out('6110344959180570674');" style=""> 320                         int delaySeconds = 1;                                                            </span>
<span class="-5190003264224859806" onmouseenter="enter('-5190003264224859806');" onmouseout="out('-5190003264224859806');" style=""> 321                         while (reconnectAttempts-- &gt; 0 &amp;&amp; !mQuit &amp;&amp; !mIsConnected) {                     </span>
<span class="-7641363597792416938" onmouseenter="enter('-7641363597792416938');" onmouseout="out('-7641363597792416938');" style=""> 322                             LOG.info(&quot;Trying to reconnect (attempts left &quot; + reconnectAttempts + &quot;)&quot;);   </span>
<span class="-2588539367217579258" onmouseenter="enter('-2588539367217579258');" onmouseout="out('-2588539367217579258');" style=""> 323                             mIsConnected = connect();                                                    </span>
<span class="-245134013635442990" onmouseenter="enter('-245134013635442990');" onmouseout="out('-245134013635442990');" style=""> 324                             if (!mIsConnected) {                                                         </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 325                                 try {                                                                    </span>
<span class="-3669672008793578674" onmouseenter="enter('-3669672008793578674');" onmouseout="out('-3669672008793578674');" style=""> 326                                     Thread.sleep(delaySeconds * 1000);                                   </span>
<span class="1010771762618413361" onmouseenter="enter('1010771762618413361');" onmouseout="out('1010771762618413361');" style=""> 327                                 } catch (InterruptedException ignored) {                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 328                                 }                                                                        </span>
<span class="-8988961353399164519" onmouseenter="enter('-8988961353399164519');" onmouseout="out('-8988961353399164519');" style=""> 329                                 if (delaySeconds &lt; 64) {                                                 </span>
<span class="4518640925202616859" onmouseenter="enter('4518640925202616859');" onmouseout="out('4518640925202616859');" style=""> 330                                     delaySeconds *= 2;                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 331                                 }                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 332                             }                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 333                         }                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 334                     }                                                                                    </span>
<span class="-245134013635442990" onmouseenter="enter('-245134013635442990');" onmouseout="out('-245134013635442990');" style=""> 335                     if (!mIsConnected) {                                                                 </span>
<span class="-4534501040604870855" onmouseenter="enter('-4534501040604870855');" onmouseout="out('-4534501040604870855');" style=""> 336                         mBtSocket = null;                                                                </span>
<span class="-3119559015644534035" onmouseenter="enter('-3119559015644534035');" onmouseout="out('-3119559015644534035');" style=""> 337                         LOG.info(&quot;Bluetooth socket closed, will quit IO Thread&quot;);                        </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 338                         break;                                                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 339                     }                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 340                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 341             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 342         }                                                                                                </span>
<span class="1054919517095572489" onmouseenter="enter('1054919517095572489');" onmouseout="out('1054919517095572489');" style=""> 343         mIsConnected = false;                                                                            </span>
<span class="-3944229288018059276" onmouseenter="enter('-3944229288018059276');" onmouseout="out('-3944229288018059276');" style=""> 344         if (mBtSocket != null) {                                                                         </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 345             try {                                                                                        </span>
<span class="4957759683762229483" onmouseenter="enter('4957759683762229483');" onmouseout="out('4957759683762229483');" style=""> 346                 mBtSocket.close();                                                                       </span>
<span class="7080241092423381085" onmouseenter="enter('7080241092423381085');" onmouseout="out('7080241092423381085');" style=""> 347             } catch (IOException e) {                                                                    </span>
<span class="4090663313211582937" onmouseenter="enter('4090663313211582937');" onmouseout="out('4090663313211582937');" style=""> 348                 e.printStackTrace();                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 349             }                                                                                            </span>
<span class="-4534501040604870855" onmouseenter="enter('-4534501040604870855');" onmouseout="out('-4534501040604870855');" style=""> 350             mBtSocket = null;                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 351         }                                                                                                </span>
<span  style=""> 352                                                                                                          </span>
<span class="-8029876522886293743" onmouseenter="enter('-8029876522886293743');" onmouseout="out('-8029876522886293743');" style=""> 353         enablePebbleKitSupport(false);                                                                   </span>
<span  style=""> 354                                                                                                          </span>
<span class="754428857450446437" onmouseenter="enter('754428857450446437');" onmouseout="out('754428857450446437');" style=""> 355         if (mQuit) {                                                                                     </span>
<span class="3251995130332618727" onmouseenter="enter('3251995130332618727');" onmouseout="out('3251995130332618727');" style=""> 356             gbDevice.setState(GBDevice.State.NOT_CONNECTED);                                             </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 357         } else {                                                                                         </span>
<span class="3557129149179391090" onmouseenter="enter('3557129149179391090');" onmouseout="out('3557129149179391090');" style=""> 358             gbDevice.setState(GBDevice.State.WAITING_FOR_RECONNECT);                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 359         }                                                                                                </span>
<span  style=""> 360                                                                                                          </span>
<span class="3956366137427967177" onmouseenter="enter('3956366137427967177');" onmouseout="out('3956366137427967177');" style=""> 361         WebViewSingleton.disposeWebView();                                                               </span>
<span  style=""> 362                                                                                                          </span>
<span class="-6083303279196581322" onmouseenter="enter('-6083303279196581322');" onmouseout="out('-6083303279196581322');" style=""> 363         gbDevice.sendDeviceUpdateIntent(getContext());                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 364     }                                                                                                    </span>
<span  style=""> 365                                                                                                          </span>
<span class="6912900349290733332" onmouseenter="enter('6912900349290733332');" onmouseout="out('6912900349290733332');" style=""> 366     private void enablePebbleKitSupport(boolean enable) {                                                </span>
<span class="-4986567876401497765" onmouseenter="enter('-4986567876401497765');" onmouseout="out('-4986567876401497765');" style=""> 367         if (enable &amp;&amp; mEnablePebblekit) {                                                                </span>
<span class="6988208637409175545" onmouseenter="enter('6988208637409175545');" onmouseout="out('6988208637409175545');" style=""> 368             mPebbleKitSupport = new PebbleKitSupport(getContext(), PebbleIoThread.this, mPebbleProtocol);</span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 369         } else {                                                                                         </span>
<span class="1872000704840757529" onmouseenter="enter('1872000704840757529');" onmouseout="out('1872000704840757529');" style=""> 370             if (mPebbleKitSupport != null) {                                                             </span>
<span class="2355950174103684288" onmouseenter="enter('2355950174103684288');" onmouseout="out('2355950174103684288');" style=""> 371                 mPebbleKitSupport.close();                                                               </span>
<span class="-7890594263237719778" onmouseenter="enter('-7890594263237719778');" onmouseout="out('-7890594263237719778');" style=""> 372                 mPebbleKitSupport = null;                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 373             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 374         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 375     }                                                                                                    </span>
<span  style=""> 376                                                                                                          </span>
<span  style=""> 377                                                                                                          </span>
<span class="5266958563097079524" onmouseenter="enter('5266958563097079524');" onmouseout="out('5266958563097079524');" style=""> 378     private void write_real(byte[] bytes) {                                                              </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 379         try {                                                                                            </span>
<span class="5578850974519966568" onmouseenter="enter('5578850974519966568');" onmouseout="out('5578850974519966568');" style=""> 380             if (mIsTCP) {                                                                                </span>
<span class="7452866671884685289" onmouseenter="enter('7452866671884685289');" onmouseout="out('7452866671884685289');" style=""> 381                 ByteBuffer buf = ByteBuffer.allocate(bytes.length + 8);                                  </span>
<span class="-8522898317938558799" onmouseenter="enter('-8522898317938558799');" onmouseout="out('-8522898317938558799');" style=""> 382                 buf.order(ByteOrder.BIG_ENDIAN);                                                         </span>
<span class="5585321854972752725" onmouseenter="enter('5585321854972752725');" onmouseout="out('5585321854972752725');" style=""> 383                 buf.putShort((short) 0xfeed);                                                            </span>
<span class="7507473664785459909" onmouseenter="enter('7507473664785459909');" onmouseout="out('7507473664785459909');" style=""> 384                 buf.putShort((short) 1);                                                                 </span>
<span class="-8123162661289444091" onmouseenter="enter('-8123162661289444091');" onmouseout="out('-8123162661289444091');" style=""> 385                 buf.putShort((short) bytes.length);                                                      </span>
<span class="-7064269165968803859" onmouseenter="enter('-7064269165968803859');" onmouseout="out('-7064269165968803859');" style=""> 386                 buf.put(bytes);                                                                          </span>
<span class="488045024517500594" onmouseenter="enter('488045024517500594');" onmouseout="out('488045024517500594');" style=""> 387                 buf.putShort((short) 0xbeef);                                                            </span>
<span class="5890011760749412055" onmouseenter="enter('5890011760749412055');" onmouseout="out('5890011760749412055');" style=""> 388                 mOutStream.write(buf.array());                                                           </span>
<span class="5447277003517706714" onmouseenter="enter('5447277003517706714');" onmouseout="out('5447277003517706714');" style=""> 389                 mOutStream.flush();                                                                      </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 390             } else {                                                                                     </span>
<span class="-446832387142219515" onmouseenter="enter('-446832387142219515');" onmouseout="out('-446832387142219515');" style=""> 391                 mOutStream.write(bytes);                                                                 </span>
<span class="5447277003517706714" onmouseenter="enter('5447277003517706714');" onmouseout="out('5447277003517706714');" style=""> 392                 mOutStream.flush();                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 393             }                                                                                            </span>
<span class="7080241092423381085" onmouseenter="enter('7080241092423381085');" onmouseout="out('7080241092423381085');" style=""> 394         } catch (IOException e) {                                                                        </span>
<span class="886800052852078092" onmouseenter="enter('886800052852078092');" onmouseout="out('886800052852078092');" style=""> 395             LOG.error(&quot;Error writing.&quot;, e.getMessage());                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 396         }                                                                                                </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 397         try {                                                                                            </span>
<span class="1958254861600319008" onmouseenter="enter('1958254861600319008');" onmouseout="out('1958254861600319008');" style=""> 398             Thread.sleep(100);                                                                           </span>
<span class="1010771762618413361" onmouseenter="enter('1010771762618413361');" onmouseout="out('1010771762618413361');" style=""> 399         } catch (InterruptedException ignored) {                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 400         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 401     }                                                                                                    </span>
<span  style=""> 402                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 403     @Override                                                                                            </span>
<span class="2194193333899452301" onmouseenter="enter('2194193333899452301');" onmouseout="out('2194193333899452301');" style=""> 404     synchronized public void write(byte[] bytes) {                                                       </span>
<span class="7962173391634007539" onmouseenter="enter('7962173391634007539');" onmouseout="out('7962173391634007539');" style=""> 405         if (bytes == null) {                                                                             </span>
<span class="4043029072030362567" onmouseenter="enter('4043029072030362567');" onmouseout="out('4043029072030362567');" style=""> 406             return;                                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 407         }                                                                                                </span>
<span class="-1647178201768949716" onmouseenter="enter('-1647178201768949716');" onmouseout="out('-1647178201768949716');" style=""> 408         // on FW &lt; 3.0 block writes if app installation in in progress                                   </span>
<span class="-6700324623621105863" onmouseenter="enter('-6700324623621105863');" onmouseout="out('-6700324623621105863');" style=""><abbr title=" 409         if (!mIsConnected || (mPebbleProtocol.mFwMajor &lt; 3 &amp;&amp; mIsInstalling &amp;&amp; mInstallState != PebbleAppInstallState.WAIT_SLOT)) {"> 409         if (!mIsConnected || (mPebbleProtocol.mFwMajor &lt; 3 &amp;&amp; mIsInstalling &amp;&amp; mInstallState != PebbleAppðŸ”µ</abbr></span>
<span class="4043029072030362567" onmouseenter="enter('4043029072030362567');" onmouseout="out('4043029072030362567');" style=""> 410             return;                                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 411         }                                                                                                </span>
<span class="-5136181704666404560" onmouseenter="enter('-5136181704666404560');" onmouseout="out('-5136181704666404560');" style=""> 412         write_real(bytes);                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 413     }                                                                                                    </span>
<span  style=""> 414                                                                                                          </span>
<span class="3670289587241327133" onmouseenter="enter('3670289587241327133');" onmouseout="out('3670289587241327133');" style=""> 415     // FIXME: parts are supporsed to be generic code                                                     </span>
<span class="-7489026152941302055" onmouseenter="enter('-7489026152941302055');" onmouseout="out('-7489026152941302055');" style=""> 416     private boolean evaluateGBDeviceEventPebble(GBDeviceEvent deviceEvent) {                             </span>
<span  style=""> 417                                                                                                          </span>
<span class="-1739566276849801616" onmouseenter="enter('-1739566276849801616');" onmouseout="out('-1739566276849801616');" style=""> 418         if (deviceEvent instanceof GBDeviceEventVersionInfo) {                                           </span>
<span class="1668658004022497081" onmouseenter="enter('1668658004022497081');" onmouseout="out('1668658004022497081');" style=""> 419             if (prefs.getBoolean(&quot;datetime_synconconnect&quot;, true)) {                                      </span>
<span class="-3451867859378415609" onmouseenter="enter('-3451867859378415609');" onmouseout="out('-3451867859378415609');" style=""> 420                 LOG.info(&quot;syncing time&quot;);                                                                </span>
<span class="5993925069998187867" onmouseenter="enter('5993925069998187867');" onmouseout="out('5993925069998187867');" style=""> 421                 write(mPebbleProtocol.encodeSetTime());                                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 422             }                                                                                            </span>
<span class="-7386980641954546377" onmouseenter="enter('-7386980641954546377');" onmouseout="out('-7386980641954546377');" style=""> 423             write(mPebbleProtocol.encodeEnableAppLogs(prefs.getBoolean(&quot;pebble_enable_applogs&quot;, false)));</span>
<span class="-4097828168322802160" onmouseenter="enter('-4097828168322802160');" onmouseout="out('-4097828168322802160');" style=""> 424             write(mPebbleProtocol.encodeReportDataLogSessions());                                        </span>
<span class="6586859092027978564" onmouseenter="enter('6586859092027978564');" onmouseout="out('6586859092027978564');" style=""> 425             gbDevice.setState(GBDevice.State.INITIALIZED);                                               </span>
<span class="-5432226360745882584" onmouseenter="enter('-5432226360745882584');" onmouseout="out('-5432226360745882584');" style=""> 426             return false;                                                                                </span>
<span class="-4499044239010675675" onmouseenter="enter('-4499044239010675675');" onmouseout="out('-4499044239010675675');" style=""> 427         } else if (deviceEvent instanceof GBDeviceEventAppManagement) {                                  </span>
<span class="974736254576981019" onmouseenter="enter('974736254576981019');" onmouseout="out('974736254576981019');" style=""> 428             GBDeviceEventAppManagement appMgmt = (GBDeviceEventAppManagement) deviceEvent;               </span>
<span class="-8405891147776704968" onmouseenter="enter('-8405891147776704968');" onmouseout="out('-8405891147776704968');" style=""> 429             switch (appMgmt.type) {                                                                      </span>
<span class="493585282467505488" onmouseenter="enter('493585282467505488');" onmouseout="out('493585282467505488');" style=""> 430                 case DELETE:                                                                             </span>
<span class="3296704790396586230" onmouseenter="enter('3296704790396586230');" onmouseout="out('3296704790396586230');" style=""><abbr title=" 431                     // right now on the Pebble we also receive this on a failed/successful installation ;/"> 431                     // right now on the Pebble we also receive this on a failed/successful installation ;ðŸ”µ</abbr></span>
<span class="-5581198847294356355" onmouseenter="enter('-5581198847294356355');" onmouseout="out('-5581198847294356355');" style=""> 432                     switch (appMgmt.event) {                                                             </span>
<span class="6749187966539498077" onmouseenter="enter('6749187966539498077');" onmouseout="out('6749187966539498077');" style=""> 433                         case FAILURE:                                                                    </span>
<span class="-8278348814669106484" onmouseenter="enter('-8278348814669106484');" onmouseout="out('-8278348814669106484');" style=""> 434                             if (mIsInstalling) {                                                         </span>
<span class="5202677886896781243" onmouseenter="enter('5202677886896781243');" onmouseout="out('5202677886896781243');" style=""> 435                                 if (mInstallState == PebbleAppInstallState.WAIT_SLOT) {                  </span>
<span class="-3834429542028013887" onmouseenter="enter('-3834429542028013887');" onmouseout="out('-3834429542028013887');" style=""> 436                                     // get the free slot                                                 </span>
<span class="-1078532123174136932" onmouseenter="enter('-1078532123174136932');" onmouseout="out('-1078532123174136932');" style=""> 437                                     writeInstallApp(mPebbleProtocol.encodeAppInfoReq());                 </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 438                                 } else {                                                                 </span>
<span class="2061814158740359960" onmouseenter="enter('2061814158740359960');" onmouseout="out('2061814158740359960');" style=""> 439                                     finishInstall(true);                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 440                                 }                                                                        </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 441                             } else {                                                                     </span>
<span class="-3730390778602920424" onmouseenter="enter('-3730390778602920424');" onmouseout="out('-3730390778602920424');" style=""> 442                                 LOG.info(&quot;failure removing app&quot;);                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 443                             }                                                                            </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 444                             break;                                                                       </span>
<span class="3349111062118052514" onmouseenter="enter('3349111062118052514');" onmouseout="out('3349111062118052514');" style=""> 445                         case SUCCESS:                                                                    </span>
<span class="-8278348814669106484" onmouseenter="enter('-8278348814669106484');" onmouseout="out('-8278348814669106484');" style=""> 446                             if (mIsInstalling) {                                                         </span>
<span class="5202677886896781243" onmouseenter="enter('5202677886896781243');" onmouseout="out('5202677886896781243');" style=""> 447                                 if (mInstallState == PebbleAppInstallState.WAIT_SLOT) {                  </span>
<span class="-3834429542028013887" onmouseenter="enter('-3834429542028013887');" onmouseout="out('-3834429542028013887');" style=""> 448                                     // get the free slot                                                 </span>
<span class="-1078532123174136932" onmouseenter="enter('-1078532123174136932');" onmouseout="out('-1078532123174136932');" style=""> 449                                     writeInstallApp(mPebbleProtocol.encodeAppInfoReq());                 </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 450                                 } else {                                                                 </span>
<span class="8670418135173104454" onmouseenter="enter('8670418135173104454');" onmouseout="out('8670418135173104454');" style=""> 451                                     finishInstall(false);                                                </span>
<span class="5558136677444980843" onmouseenter="enter('5558136677444980843');" onmouseout="out('5558136677444980843');" style=""> 452                                     // refresh app list                                                  </span>
<span class="-6896285502301651077" onmouseenter="enter('-6896285502301651077');" onmouseout="out('-6896285502301651077');" style=""> 453                                     write(mPebbleProtocol.encodeAppInfoReq());                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 454                                 }                                                                        </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 455                             } else {                                                                     </span>
<span class="-205908887212722760" onmouseenter="enter('-205908887212722760');" onmouseout="out('-205908887212722760');" style=""> 456                                 LOG.info(&quot;successfully removed app&quot;);                                    </span>
<span class="-6896285502301651077" onmouseenter="enter('-6896285502301651077');" onmouseout="out('-6896285502301651077');" style=""> 457                                 write(mPebbleProtocol.encodeAppInfoReq());                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 458                             }                                                                            </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 459                             break;                                                                       </span>
<span class="-8178136317704390296" onmouseenter="enter('-8178136317704390296');" onmouseout="out('-8178136317704390296');" style=""> 460                         default:                                                                         </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 461                             break;                                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 462                     }                                                                                    </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 463                     break;                                                                               </span>
<span class="870820606107259995" onmouseenter="enter('870820606107259995');" onmouseout="out('870820606107259995');" style=""> 464                 case INSTALL:                                                                            </span>
<span class="-5581198847294356355" onmouseenter="enter('-5581198847294356355');" onmouseout="out('-5581198847294356355');" style=""> 465                     switch (appMgmt.event) {                                                             </span>
<span class="6749187966539498077" onmouseenter="enter('6749187966539498077');" onmouseout="out('6749187966539498077');" style=""> 466                         case FAILURE:                                                                    </span>
<span class="-7112250469089022370" onmouseenter="enter('-7112250469089022370');" onmouseout="out('-7112250469089022370');" style=""> 467                             LOG.info(&quot;failure installing app&quot;); // TODO: report to Installer             </span>
<span class="2061814158740359960" onmouseenter="enter('2061814158740359960');" onmouseout="out('2061814158740359960');" style=""> 468                             finishInstall(true);                                                         </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 469                             break;                                                                       </span>
<span class="3349111062118052514" onmouseenter="enter('3349111062118052514');" onmouseout="out('3349111062118052514');" style=""> 470                         case SUCCESS:                                                                    </span>
<span class="6209162457835083814" onmouseenter="enter('6209162457835083814');" onmouseout="out('6209162457835083814');" style=""> 471                             setToken(appMgmt.token);                                                     </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 472                             break;                                                                       </span>
<span class="6051906179244859750" onmouseenter="enter('6051906179244859750');" onmouseout="out('6051906179244859750');" style=""> 473                         case REQUEST:                                                                    </span>
<span class="2049455602208269446" onmouseenter="enter('2049455602208269446');" onmouseout="out('2049455602208269446');" style=""> 474                             LOG.info(&quot;APPFETCH request: &quot; + appMgmt.uuid + &quot; / &quot; + appMgmt.token);       </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 475                             try {                                                                        </span>
<span class="1545743734028545488" onmouseenter="enter('1545743734028545488');" onmouseout="out('1545743734028545488');" style=""><abbr title=" 476                                 installApp(Uri.fromFile(new File(FileUtils.getExternalFilesDir() + &quot;/pbw-cache/&quot; + appMgmt.uuid.toString() + &quot;.pbw&quot;)), appMgmt.token);"> 476                                 installApp(Uri.fromFile(new File(FileUtils.getExternalFilesDir() + &quot;/pbw-ðŸ”µ</abbr></span>
<span class="7080241092423381085" onmouseenter="enter('7080241092423381085');" onmouseout="out('7080241092423381085');" style=""> 477                             } catch (IOException e) {                                                    </span>
<span class="-531769948700903766" onmouseenter="enter('-531769948700903766');" onmouseout="out('-531769948700903766');" style=""> 478                                 LOG.error(&quot;Error installing app: &quot; + e.getMessage(), e);                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 479                             }                                                                            </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 480                             break;                                                                       </span>
<span class="-8178136317704390296" onmouseenter="enter('-8178136317704390296');" onmouseout="out('-8178136317704390296');" style=""> 481                         default:                                                                         </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 482                             break;                                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 483                     }                                                                                    </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 484                     break;                                                                               </span>
<span class="-2079449841199557933" onmouseenter="enter('-2079449841199557933');" onmouseout="out('-2079449841199557933');" style=""> 485                 case START:                                                                              </span>
<span class="8092140248813269968" onmouseenter="enter('8092140248813269968');" onmouseout="out('8092140248813269968');" style=""> 486                     LOG.info(&quot;got GBDeviceEventAppManagement START event for uuid: &quot; + appMgmt.uuid);    </span>
<span class="-7700571972479023893" onmouseenter="enter('-7700571972479023893');" onmouseout="out('-7700571972479023893');" style=""> 487                     WebViewSingleton.getorInitWebView(getContext(), gbDevice, appMgmt.uuid);             </span>
<span class="3757214281746876643" onmouseenter="enter('3757214281746876643');" onmouseout="out('3757214281746876643');" style=""><abbr title=" 488                     //TODO: the method call above will not work the first time as we need an activity. Either we find a way to have one here, or replace it with a local broadcast"> 488                     //TODO: the method call above will not work the first time as we need an activity. EiðŸ”µ</abbr></span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 489                     break;                                                                               </span>
<span class="-8178136317704390296" onmouseenter="enter('-8178136317704390296');" onmouseout="out('-8178136317704390296');" style=""> 490                 default:                                                                                 </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 491                     break;                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 492             }                                                                                            </span>
<span class="-3118901906653197100" onmouseenter="enter('-3118901906653197100');" onmouseout="out('-3118901906653197100');" style=""> 493             return true;                                                                                 </span>
<span class="-6358653040411049512" onmouseenter="enter('-6358653040411049512');" onmouseout="out('-6358653040411049512');" style=""> 494         } else if (deviceEvent instanceof GBDeviceEventAppInfo) {                                        </span>
<span class="3946899054861776294" onmouseenter="enter('3946899054861776294');" onmouseout="out('3946899054861776294');" style=""> 495             LOG.info(&quot;Got event for APP_INFO&quot;);                                                          </span>
<span class="1502569219724801591" onmouseenter="enter('1502569219724801591');" onmouseout="out('1502569219724801591');" style=""> 496             GBDeviceEventAppInfo appInfoEvent = (GBDeviceEventAppInfo) deviceEvent;                      </span>
<span class="-8959429837223401007" onmouseenter="enter('-8959429837223401007');" onmouseout="out('-8959429837223401007');" style=""> 497             setInstallSlot(appInfoEvent.freeSlot);                                                       </span>
<span class="-5432226360745882584" onmouseenter="enter('-5432226360745882584');" onmouseout="out('-5432226360745882584');" style=""> 498             return false;                                                                                </span>
<span class="3212296093301006379" onmouseenter="enter('3212296093301006379');" onmouseout="out('3212296093301006379');" style=""> 499         } else if (deviceEvent instanceof GBDeviceEventAppMessage) {                                     </span>
<span class="3695639456947057183" onmouseenter="enter('3695639456947057183');" onmouseout="out('3695639456947057183');" style=""> 500             sendAppMessageJS((GBDeviceEventAppMessage) deviceEvent);                                     </span>
<span class="-2519217701585576846" onmouseenter="enter('-2519217701585576846');" onmouseout="out('-2519217701585576846');" style=""> 501             if (mEnablePebblekit) {                                                                      </span>
<span class="3587206773966788552" onmouseenter="enter('3587206773966788552');" onmouseout="out('3587206773966788552');" style=""> 502                 LOG.info(&quot;Got AppMessage event&quot;);                                                        </span>
<span class="1872000704840757529" onmouseenter="enter('1872000704840757529');" onmouseout="out('1872000704840757529');" style=""> 503                 if (mPebbleKitSupport != null) {                                                         </span>
<span class="-6825766400209744371" onmouseenter="enter('-6825766400209744371');" onmouseout="out('-6825766400209744371');" style=""> 504                     mPebbleKitSupport.sendAppMessageIntent((GBDeviceEventAppMessage) deviceEvent);       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 505                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 506             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 507         }                                                                                                </span>
<span  style=""> 508                                                                                                          </span>
<span class="-5432226360745882584" onmouseenter="enter('-5432226360745882584');" onmouseout="out('-5432226360745882584');" style=""> 509         return false;                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 510     }                                                                                                    </span>
<span  style=""> 511                                                                                                          </span>
<span class="1330519925695971168" onmouseenter="enter('1330519925695971168');" onmouseout="out('1330519925695971168');" style=""> 512     private void setToken(int token) {                                                                   </span>
<span class="5683710649022739399" onmouseenter="enter('5683710649022739399');" onmouseout="out('5683710649022739399');" style=""> 513         mAppInstallToken = token;                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 514     }                                                                                                    </span>
<span  style=""> 515                                                                                                          </span>
<span class="3305301500785286694" onmouseenter="enter('3305301500785286694');" onmouseout="out('3305301500785286694');" style=""> 516     private void setInstallSlot(int slot) {                                                              </span>
<span class="-8278348814669106484" onmouseenter="enter('-8278348814669106484');" onmouseout="out('-8278348814669106484');" style=""> 517         if (mIsInstalling) {                                                                             </span>
<span class="7826340306873194751" onmouseenter="enter('7826340306873194751');" onmouseout="out('7826340306873194751');" style=""> 518             mInstallSlot = slot;                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 519         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 520     }                                                                                                    </span>
<span  style=""> 521                                                                                                          </span>
<span class="-8792508792922317323" onmouseenter="enter('-8792508792922317323');" onmouseout="out('-8792508792922317323');" style=""> 522     synchronized private void writeInstallApp(byte[] bytes) {                                            </span>
<span class="1640300515722317364" onmouseenter="enter('1640300515722317364');" onmouseout="out('1640300515722317364');" style=""> 523         if (!mIsInstalling) {                                                                            </span>
<span class="4043029072030362567" onmouseenter="enter('4043029072030362567');" onmouseout="out('4043029072030362567');" style=""> 524             return;                                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 525         }                                                                                                </span>
<span class="546783514848998195" onmouseenter="enter('546783514848998195');" onmouseout="out('546783514848998195');" style=""> 526         LOG.info(&quot;got &quot; + bytes.length + &quot;bytes for writeInstallApp()&quot;);                                 </span>
<span class="-5136181704666404560" onmouseenter="enter('-5136181704666404560');" onmouseout="out('-5136181704666404560');" style=""> 527         write_real(bytes);                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 528     }                                                                                                    </span>
<span  style=""> 529                                                                                                          </span>
<span class="-1924531441297190559" onmouseenter="enter('-1924531441297190559');" onmouseout="out('-1924531441297190559');" style=""> 530     void installApp(Uri uri, int appId) {                                                                </span>
<span class="4219320778876848093" onmouseenter="enter('4219320778876848093');" onmouseout="out('4219320778876848093');" style=""> 531         if (uri.equals(Uri.parse(&quot;fake://health&quot;))) {                                                    </span>
<span class="-4500321340045240107" onmouseenter="enter('-4500321340045240107');" onmouseout="out('-4500321340045240107');" style=""> 532             write(mPebbleProtocol.encodeActivateHealth(true));                                           </span>
<span class="-9057759845463359663" onmouseenter="enter('-9057759845463359663');" onmouseout="out('-9057759845463359663');" style=""> 533             write(mPebbleProtocol.encodeSetSaneDistanceUnit(true));                                      </span>
<span class="4043029072030362567" onmouseenter="enter('4043029072030362567');" onmouseout="out('4043029072030362567');" style=""> 534             return;                                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 535         }                                                                                                </span>
<span class="-2579506686933905796" onmouseenter="enter('-2579506686933905796');" onmouseout="out('-2579506686933905796');" style=""> 536         if (uri.equals(Uri.parse(&quot;fake://hrm&quot;))) {                                                       </span>
<span class="-8562013736932235665" onmouseenter="enter('-8562013736932235665');" onmouseout="out('-8562013736932235665');" style=""> 537             write(mPebbleProtocol.encodeActivateHRM(true));                                              </span>
<span class="4043029072030362567" onmouseenter="enter('4043029072030362567');" onmouseout="out('4043029072030362567');" style=""> 538             return;                                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 539         }                                                                                                </span>
<span class="-1212047709466619456" onmouseenter="enter('-1212047709466619456');" onmouseout="out('-1212047709466619456');" style=""> 540         if (uri.equals(Uri.parse(&quot;fake://weather&quot;))) {                                                   </span>
<span class="2684404709669173657" onmouseenter="enter('2684404709669173657');" onmouseout="out('2684404709669173657');" style=""> 541             write(mPebbleProtocol.encodeActivateWeather(true));                                          </span>
<span class="4043029072030362567" onmouseenter="enter('4043029072030362567');" onmouseout="out('4043029072030362567');" style=""> 542             return;                                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 543         }                                                                                                </span>
<span  style=""> 544                                                                                                          </span>
<span class="-8278348814669106484" onmouseenter="enter('-8278348814669106484');" onmouseout="out('-8278348814669106484');" style=""> 545         if (mIsInstalling) {                                                                             </span>
<span class="4043029072030362567" onmouseenter="enter('4043029072030362567');" onmouseout="out('4043029072030362567');" style=""> 546             return;                                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 547         }                                                                                                </span>
<span  style=""> 548                                                                                                          </span>
<span class="6375141335175677190" onmouseenter="enter('6375141335175677190');" onmouseout="out('6375141335175677190');" style=""> 549         String platformName = PebbleUtils.getPlatformName(gbDevice.getModel());                          </span>
<span  style=""> 550                                                                                                          </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 551         try {                                                                                            </span>
<span class="7221939422125416648" onmouseenter="enter('7221939422125416648');" onmouseout="out('7221939422125416648');" style=""> 552             mPBWReader = new PBWReader(uri, getContext(), platformName);                                 </span>
<span class="400908373044587289" onmouseenter="enter('400908373044587289');" onmouseout="out('400908373044587289');" style=""> 553         } catch (FileNotFoundException e) {                                                              </span>
<span class="769608185211968952" onmouseenter="enter('769608185211968952');" onmouseout="out('769608185211968952');" style=""> 554             LOG.warn(&quot;file not found: &quot; + e.getMessage(), e);                                            </span>
<span class="4043029072030362567" onmouseenter="enter('4043029072030362567');" onmouseout="out('4043029072030362567');" style=""> 555             return;                                                                                      </span>
<span class="7080241092423381085" onmouseenter="enter('7080241092423381085');" onmouseout="out('7080241092423381085');" style=""> 556         } catch (IOException e) {                                                                        </span>
<span class="8483156789856269109" onmouseenter="enter('8483156789856269109');" onmouseout="out('8483156789856269109');" style=""> 557             LOG.warn(&quot;unable to read file: &quot; + e.getMessage(), e);                                       </span>
<span class="4043029072030362567" onmouseenter="enter('4043029072030362567');" onmouseout="out('4043029072030362567');" style=""> 558             return;                                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 559         }                                                                                                </span>
<span  style=""> 560                                                                                                          </span>
<span class="-8518332035217489539" onmouseenter="enter('-8518332035217489539');" onmouseout="out('-8518332035217489539');" style=""> 561         mPebbleInstallables = mPBWReader.getPebbleInstallables();                                        </span>
<span class="5818194705482022298" onmouseenter="enter('5818194705482022298');" onmouseout="out('5818194705482022298');" style=""> 562         mCurrentInstallableIndex = 0;                                                                    </span>
<span  style=""> 563                                                                                                          </span>
<span class="1423594820264173048" onmouseenter="enter('1423594820264173048');" onmouseout="out('1423594820264173048');" style=""> 564         if (mPBWReader.isFirmware()) {                                                                   </span>
<span class="-6874615797996941970" onmouseenter="enter('-6874615797996941970');" onmouseout="out('-6874615797996941970');" style=""> 565             LOG.info(&quot;starting firmware installation&quot;);                                                  </span>
<span class="-7893027413776683580" onmouseenter="enter('-7893027413776683580');" onmouseout="out('-7893027413776683580');" style=""> 566             mIsInstalling = true;                                                                        </span>
<span class="2991380117683144492" onmouseenter="enter('2991380117683144492');" onmouseout="out('2991380117683144492');" style=""> 567             mInstallSlot = 0;                                                                            </span>
<span class="5938608831368473017" onmouseenter="enter('5938608831368473017');" onmouseout="out('5938608831368473017');" style=""> 568             writeInstallApp(mPebbleProtocol.encodeInstallFirmwareStart());                               </span>
<span class="6147346456613268497" onmouseenter="enter('6147346456613268497');" onmouseout="out('6147346456613268497');" style=""> 569             mInstallState = PebbleAppInstallState.START_INSTALL;                                         </span>
<span  style=""> 570                                                                                                          </span>
<span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style=""> 571             /*                                                                                           </span>
<span class="4272043072413570034" onmouseenter="enter('4272043072413570034');" onmouseout="out('4272043072413570034');" style=""> 572              * This is a hack for recovery mode, in which the blocking read has no timeout and the       </span>
<span class="5399824784620980403" onmouseenter="enter('5399824784620980403');" onmouseout="out('5399824784620980403');" style=""> 573              * firmware installation command does not return any ack.                                    </span>
<span class="5951082934844106568" onmouseenter="enter('5951082934844106568');" onmouseout="out('5951082934844106568');" style=""> 574              * In normal mode we would got at least out of the blocking read call after a while.         </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 575              *                                                                                           </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 576              *                                                                                           </span>
<span class="1478144735136743177" onmouseenter="enter('1478144735136743177');" onmouseout="out('1478144735136743177');" style=""> 577              * ... we should really not handle installation from thread that does the blocking read      </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 578              *                                                                                           </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 579              */                                                                                          </span>
<span class="-4151709780636609521" onmouseenter="enter('-4151709780636609521');" onmouseout="out('-4151709780636609521');" style=""> 580             writeInstallApp(mPebbleProtocol.encodeGetTime());                                            </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 581         } else {                                                                                         </span>
<span class="5609914623056246065" onmouseenter="enter('5609914623056246065');" onmouseout="out('5609914623056246065');" style=""> 582             mCurrentlyInstallingApp = mPBWReader.getGBDeviceApp();                                       </span>
<span class="-492152501567437702" onmouseenter="enter('-492152501567437702');" onmouseout="out('-492152501567437702');" style=""> 583             if (mPebbleProtocol.mFwMajor &gt;= 3 &amp;&amp; !mPBWReader.isLanguage()) {                             </span>
<span class="2714123758730002125" onmouseenter="enter('2714123758730002125');" onmouseout="out('2714123758730002125');" style=""> 584                 if (appId == 0) {                                                                        </span>
<span class="-403761314332683960" onmouseenter="enter('-403761314332683960');" onmouseout="out('-403761314332683960');" style=""> 585                     // only install metadata - not the binaries                                          </span>
<span class="4867948988198814512" onmouseenter="enter('4867948988198814512');" onmouseout="out('4867948988198814512');" style=""><abbr title=" 586                     write(mPebbleProtocol.encodeInstallMetadata(mCurrentlyInstallingApp.getUUID(), mCurrentlyInstallingApp.getName(), mPBWReader.getAppVersion(), mPBWReader.getSdkVersion(), mPBWReader.getFlags(), mPBWReader.getIconId()));"> 586                     write(mPebbleProtocol.encodeInstallMetadata(mCurrentlyInstallingApp.getUUID(), mCurreðŸ”µ</abbr></span>
<span class="-4051160554063647465" onmouseenter="enter('-4051160554063647465');" onmouseout="out('-4051160554063647465');" style=""> 587                     write(mPebbleProtocol.encodeAppStart(mCurrentlyInstallingApp.getUUID(), true));      </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 588                 } else {                                                                                 </span>
<span class="268321394733795474" onmouseenter="enter('268321394733795474');" onmouseout="out('268321394733795474');" style=""> 589                     // this came from an app fetch request, so do the real stuff                         </span>
<span class="-7893027413776683580" onmouseenter="enter('-7893027413776683580');" onmouseout="out('-7893027413776683580');" style=""> 590                     mIsInstalling = true;                                                                </span>
<span class="6866943522579684341" onmouseenter="enter('6866943522579684341');" onmouseout="out('6866943522579684341');" style=""> 591                     mInstallSlot = appId;                                                                </span>
<span class="6147346456613268497" onmouseenter="enter('6147346456613268497');" onmouseout="out('6147346456613268497');" style=""> 592                     mInstallState = PebbleAppInstallState.START_INSTALL;                                 </span>
<span  style=""> 593                                                                                                          </span>
<span class="1406564667829072525" onmouseenter="enter('1406564667829072525');" onmouseout="out('1406564667829072525');" style=""> 594                     writeInstallApp(mPebbleProtocol.encodeAppFetchAck());                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 595                 }                                                                                        </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 596             } else {                                                                                     </span>
<span class="-7893027413776683580" onmouseenter="enter('-7893027413776683580');" onmouseout="out('-7893027413776683580');" style=""> 597                 mIsInstalling = true;                                                                    </span>
<span class="7854043658495457291" onmouseenter="enter('7854043658495457291');" onmouseout="out('7854043658495457291');" style=""> 598                 if (mPBWReader.isLanguage()) {                                                           </span>
<span class="2991380117683144492" onmouseenter="enter('2991380117683144492');" onmouseout="out('2991380117683144492');" style=""> 599                     mInstallSlot = 0;                                                                    </span>
<span class="6147346456613268497" onmouseenter="enter('6147346456613268497');" onmouseout="out('6147346456613268497');" style=""> 600                     mInstallState = PebbleAppInstallState.START_INSTALL;                                 </span>
<span  style=""> 601                                                                                                          </span>
<span class="-9169766034690988699" onmouseenter="enter('-9169766034690988699');" onmouseout="out('-9169766034690988699');" style=""> 602                     // unblock HACK                                                                      </span>
<span class="-4151709780636609521" onmouseenter="enter('-4151709780636609521');" onmouseout="out('-4151709780636609521');" style=""> 603                     writeInstallApp(mPebbleProtocol.encodeGetTime());                                    </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 604                 } else {                                                                                 </span>
<span class="6749245896015366249" onmouseenter="enter('6749245896015366249');" onmouseout="out('6749245896015366249');" style=""> 605                     mInstallState = PebbleAppInstallState.WAIT_SLOT;                                     </span>
<span class="-5557276013487860944" onmouseenter="enter('-5557276013487860944');" onmouseout="out('-5557276013487860944');" style=""> 606                     writeInstallApp(mPebbleProtocol.encodeAppDelete(mCurrentlyInstallingApp.getUUID())); </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 607                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 608             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 609         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 610     }                                                                                                    </span>
<span  style=""> 611                                                                                                          </span>
<span class="-3632958031962272509" onmouseenter="enter('-3632958031962272509');" onmouseout="out('-3632958031962272509');" style=""> 612     private void finishInstall(boolean hadError) {                                                       </span>
<span class="1640300515722317364" onmouseenter="enter('1640300515722317364');" onmouseout="out('1640300515722317364');" style=""> 613         if (!mIsInstalling) {                                                                            </span>
<span class="4043029072030362567" onmouseenter="enter('4043029072030362567');" onmouseout="out('4043029072030362567');" style=""> 614             return;                                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 615         }                                                                                                </span>
<span class="7546809272471924454" onmouseenter="enter('7546809272471924454');" onmouseout="out('7546809272471924454');" style=""> 616         if (hadError) {                                                                                  </span>
<span class="1510893224061013550" onmouseenter="enter('1510893224061013550');" onmouseout="out('1510893224061013550');" style=""><abbr title=" 617             GB.updateInstallNotification(getContext().getString(R.string.installation_failed_), false, 0, getContext());"> 617             GB.updateInstallNotification(getContext().getString(R.string.installation_failed_), false, 0,ðŸ”µ</abbr></span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 618         } else {                                                                                         </span>
<span class="-1798755310811164062" onmouseenter="enter('-1798755310811164062');" onmouseout="out('-1798755310811164062');" style=""><abbr title=" 619             GB.updateInstallNotification(getContext().getString(R.string.installation_successful), false, 0, getContext());"> 619             GB.updateInstallNotification(getContext().getString(R.string.installation_successful), false,ðŸ”µ</abbr></span>
<span class="-1022673267036805326" onmouseenter="enter('-1022673267036805326');" onmouseout="out('-1022673267036805326');" style=""> 620             if (mPebbleProtocol.mFwMajor &gt;= 3) {                                                         </span>
<span class="-6972336671826040876" onmouseenter="enter('-6972336671826040876');" onmouseout="out('-6972336671826040876');" style=""> 621                 String filenameSuffix;                                                                   </span>
<span class="-4516041174588684958" onmouseenter="enter('-4516041174588684958');" onmouseout="out('-4516041174588684958');" style=""> 622                 if (mCurrentlyInstallingApp != null) {                                                   </span>
<span class="-1977040827148362152" onmouseenter="enter('-1977040827148362152');" onmouseout="out('-1977040827148362152');" style=""> 623                     if (mCurrentlyInstallingApp.getType() == GBDeviceApp.Type.WATCHFACE) {               </span>
<span class="4066163442843372701" onmouseenter="enter('4066163442843372701');" onmouseout="out('4066163442843372701');" style=""> 624                         filenameSuffix = &quot;.watchfaces&quot;;                                                  </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 625                     } else {                                                                             </span>
<span class="-1542718791393148177" onmouseenter="enter('-1542718791393148177');" onmouseout="out('-1542718791393148177');" style=""> 626                         filenameSuffix = &quot;.watchapps&quot;;                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 627                     }                                                                                    </span>
<span class="7434590360240997484" onmouseenter="enter('7434590360240997484');" onmouseout="out('7434590360240997484');" style=""><abbr title=" 628                     AppManagerActivity.addToAppOrderFile(gbDevice.getAddress() + filenameSuffix, mCurrentlyInstallingApp.getUUID());"> 628                     AppManagerActivity.addToAppOrderFile(gbDevice.getAddress() + filenameSuffix, mCurrentðŸ”µ</abbr></span>
<span class="7935209901888052732" onmouseenter="enter('7935209901888052732');" onmouseout="out('7935209901888052732');" style=""> 629                     Intent refreshIntent = new Intent(AbstractAppManagerFragment.ACTION_REFRESH_APPLIST);</span>
<span class="-1350396105067022557" onmouseenter="enter('-1350396105067022557');" onmouseout="out('-1350396105067022557');" style=""> 630                     LocalBroadcastManager.getInstance(getContext()).sendBroadcast(refreshIntent);        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 631                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 632             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 633         }                                                                                                </span>
<span class="3442713773628960689" onmouseenter="enter('3442713773628960689');" onmouseout="out('3442713773628960689');" style=""> 634         mInstallState = PebbleAppInstallState.UNKNOWN;                                                   </span>
<span  style=""> 635                                                                                                          </span>
<span class="6208081448933219418" onmouseenter="enter('6208081448933219418');" onmouseout="out('6208081448933219418');" style=""> 636         if (hadError &amp;&amp; mAppInstallToken != -1) {                                                        </span>
<span class="1039411603055838770" onmouseenter="enter('1039411603055838770');" onmouseout="out('1039411603055838770');" style=""> 637             writeInstallApp(mPebbleProtocol.encodeUploadCancel(mAppInstallToken));                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 638         }                                                                                                </span>
<span  style=""> 639                                                                                                          </span>
<span class="5124188328891976822" onmouseenter="enter('5124188328891976822');" onmouseout="out('5124188328891976822');" style=""> 640         mPBWReader = null;                                                                               </span>
<span class="1304182622527867961" onmouseenter="enter('1304182622527867961');" onmouseout="out('1304182622527867961');" style=""> 641         mIsInstalling = false;                                                                           </span>
<span class="3809401643932021573" onmouseenter="enter('3809401643932021573');" onmouseout="out('3809401643932021573');" style=""> 642         mCurrentlyInstallingApp = null;                                                                  </span>
<span  style=""> 643                                                                                                          </span>
<span class="5599892338312940306" onmouseenter="enter('5599892338312940306');" onmouseout="out('5599892338312940306');" style=""> 644         if (mFis != null) {                                                                              </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 645             try {                                                                                        </span>
<span class="5464107653723318031" onmouseenter="enter('5464107653723318031');" onmouseout="out('5464107653723318031');" style=""> 646                 mFis.close();                                                                            </span>
<span class="7080241092423381085" onmouseenter="enter('7080241092423381085');" onmouseout="out('7080241092423381085');" style=""> 647             } catch (IOException e) {                                                                    </span>
<span class="-4407835218921977391" onmouseenter="enter('-4407835218921977391');" onmouseout="out('-4407835218921977391');" style=""> 648                 // ignore                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 649             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 650         }                                                                                                </span>
<span class="6718599516057736481" onmouseenter="enter('6718599516057736481');" onmouseout="out('6718599516057736481');" style=""> 651         mFis = null;                                                                                     </span>
<span class="-556680889075439690" onmouseenter="enter('-556680889075439690');" onmouseout="out('-556680889075439690');" style=""> 652         mAppInstallToken = -1;                                                                           </span>
<span class="-4341770816803766254" onmouseenter="enter('-4341770816803766254');" onmouseout="out('-4341770816803766254');" style=""> 653         mInstallSlot = -2;                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 654     }                                                                                                    </span>
<span  style=""> 655                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 656     @Override                                                                                            </span>
<span class="-4556626830840513273" onmouseenter="enter('-4556626830840513273');" onmouseout="out('-4556626830840513273');" style=""> 657     public void quit() {                                                                                 </span>
<span class="-2245059810018305386" onmouseenter="enter('-2245059810018305386');" onmouseout="out('-2245059810018305386');" style=""> 658         mQuit = true;                                                                                    </span>
<span class="-3944229288018059276" onmouseenter="enter('-3944229288018059276');" onmouseout="out('-3944229288018059276');" style=""> 659         if (mBtSocket != null) {                                                                         </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 660             try {                                                                                        </span>
<span class="4957759683762229483" onmouseenter="enter('4957759683762229483');" onmouseout="out('4957759683762229483');" style=""> 661                 mBtSocket.close();                                                                       </span>
<span class="-8338918978083861071" onmouseenter="enter('-8338918978083861071');" onmouseout="out('-8338918978083861071');" style=""> 662             } catch (IOException ignored) {                                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 663             }                                                                                            </span>
<span class="-4534501040604870855" onmouseenter="enter('-4534501040604870855');" onmouseout="out('-4534501040604870855');" style=""> 664             mBtSocket = null;                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 665         }                                                                                                </span>
<span class="3388558050890258608" onmouseenter="enter('3388558050890258608');" onmouseout="out('3388558050890258608');" style=""> 666         if (mTCPSocket != null) {                                                                        </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 667             try {                                                                                        </span>
<span class="1317722495006749576" onmouseenter="enter('1317722495006749576');" onmouseout="out('1317722495006749576');" style=""> 668                 mTCPSocket.close();                                                                      </span>
<span class="-8338918978083861071" onmouseenter="enter('-8338918978083861071');" onmouseout="out('-8338918978083861071');" style=""> 669             } catch (IOException ignored) {                                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 670             }                                                                                            </span>
<span class="4396162940795265492" onmouseenter="enter('4396162940795265492');" onmouseout="out('4396162940795265492');" style=""> 671             mTCPSocket = null;                                                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 672         }                                                                                                </span>
<span class="-5320890524666996917" onmouseenter="enter('-5320890524666996917');" onmouseout="out('-5320890524666996917');" style=""> 673         if (mPebbleLESupport != null) {                                                                  </span>
<span class="-997532962857791838" onmouseenter="enter('-997532962857791838');" onmouseout="out('-997532962857791838');" style=""> 674             mPebbleLESupport.close();                                                                    </span>
<span class="-2496993078705938002" onmouseenter="enter('-2496993078705938002');" onmouseout="out('-2496993078705938002');" style=""> 675             mPebbleLESupport = null;                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 676         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 677     }                                                                                                    </span>
<span  style=""> 678                                                                                                          </span>
<span class="-4681179840421673206" onmouseenter="enter('-4681179840421673206');" onmouseout="out('-4681179840421673206');" style=""> 679     private enum PebbleAppInstallState {                                                                 </span>
<span class="8504698099528295248" onmouseenter="enter('8504698099528295248');" onmouseout="out('8504698099528295248');" style=""> 680         UNKNOWN,                                                                                         </span>
<span class="-8062507015798429311" onmouseenter="enter('-8062507015798429311');" onmouseout="out('-8062507015798429311');" style=""> 681         WAIT_SLOT,                                                                                       </span>
<span class="-668951604036061853" onmouseenter="enter('-668951604036061853');" onmouseout="out('-668951604036061853');" style=""> 682         START_INSTALL,                                                                                   </span>
<span class="-1678353837526561027" onmouseenter="enter('-1678353837526561027');" onmouseout="out('-1678353837526561027');" style=""> 683         WAIT_TOKEN,                                                                                      </span>
<span class="-2676567537573092080" onmouseenter="enter('-2676567537573092080');" onmouseout="out('-2676567537573092080');" style=""> 684         UPLOAD_CHUNK,                                                                                    </span>
<span class="-1008243733279055296" onmouseenter="enter('-1008243733279055296');" onmouseout="out('-1008243733279055296');" style=""> 685         UPLOAD_COMMIT,                                                                                   </span>
<span class="-8287073352459983195" onmouseenter="enter('-8287073352459983195');" onmouseout="out('-8287073352459983195');" style=""> 686         WAIT_COMMIT,                                                                                     </span>
<span class="-4008830795114372846" onmouseenter="enter('-4008830795114372846');" onmouseout="out('-4008830795114372846');" style=""> 687         UPLOAD_COMPLETE,                                                                                 </span>
<span class="7471473985638342600" onmouseenter="enter('7471473985638342600');" onmouseout="out('7471473985638342600');" style=""> 688         APP_REFRESH                                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 689     }                                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 690 }                                                                                                        </span>





































































































































</pre></td>
                            <td><pre><span class="-5771549642386131488" onmouseenter="enter('-5771549642386131488');" onmouseout="out('-5771549642386131488');" style="">   1 package nodomain.freeyourgadget.gadgetbridge.service.devices.pebble;                                     </span>
<span  style="">   2                                                                                                          </span>
<span class="-8028506601233233593" onmouseenter="enter('-8028506601233233593');" onmouseout="out('-8028506601233233593');" style="">   3 import android.bluetooth.BluetoothAdapter;                                                               </span>
<span class="2859895893394018468" onmouseenter="enter('2859895893394018468');" onmouseout="out('2859895893394018468');" style="">   4 import android.bluetooth.BluetoothDevice;                                                                </span>
<span class="634810844753697830" onmouseenter="enter('634810844753697830');" onmouseout="out('634810844753697830');" style="">   5 import android.bluetooth.BluetoothSocket;                                                                </span>
<span class="5922045460006936195" onmouseenter="enter('5922045460006936195');" onmouseout="out('5922045460006936195');" style="">   6 import android.content.Context;                                                                          </span>
<span class="6568903789857736568" onmouseenter="enter('6568903789857736568');" onmouseout="out('6568903789857736568');" style="">   7 import android.content.Intent;                                                                           </span>
<span class="-8750621697125156872" onmouseenter="enter('-8750621697125156872');" onmouseout="out('-8750621697125156872');" style="">   8 import android.net.Uri;                                                                                  </span>
<span class="8301908088148850736" onmouseenter="enter('8301908088148850736');" onmouseout="out('8301908088148850736');" style="">   9 import android.os.ParcelUuid;                                                                            </span>
<span class="2517521963771876570" onmouseenter="enter('2517521963771876570');" onmouseout="out('2517521963771876570');" style="">  10 import android.support.v4.content.LocalBroadcastManager;                                                 </span>
<span class="-3926401431737521278" onmouseenter="enter('-3926401431737521278');" onmouseout="out('-3926401431737521278');" style="">  11 import java.io.File;                                                                                     </span>
<span class="-75475733228177869" onmouseenter="enter('-75475733228177869');" onmouseout="out('-75475733228177869');" style="">  12 import java.io.FileNotFoundException;                                                                    </span>
<span class="103340661636203254" onmouseenter="enter('103340661636203254');" onmouseout="out('103340661636203254');" style="">  13 import java.io.IOException;                                                                              </span>
<span class="5631563232245871054" onmouseenter="enter('5631563232245871054');" onmouseout="out('5631563232245871054');" style="">  14 import java.io.InputStream;                                                                              </span>
<span class="4621164050749610193" onmouseenter="enter('4621164050749610193');" onmouseout="out('4621164050749610193');" style="">  15 import java.io.OutputStream;                                                                             </span>
<span class="-4777627942089262832" onmouseenter="enter('-4777627942089262832');" onmouseout="out('-4777627942089262832');" style="">  16 import java.io.PipedInputStream;                                                                         </span>
<span class="5026237307424376420" onmouseenter="enter('5026237307424376420');" onmouseout="out('5026237307424376420');" style="">  17 import java.io.PipedOutputStream;                                                                        </span>
<span class="-5790770097715703577" onmouseenter="enter('-5790770097715703577');" onmouseout="out('-5790770097715703577');" style="">  18 import java.net.InetAddress;                                                                             </span>
<span class="-623186069646925252" onmouseenter="enter('-623186069646925252');" onmouseout="out('-623186069646925252');" style="">  19 import java.net.Socket;                                                                                  </span>
<span class="-6886346622632588502" onmouseenter="enter('-6886346622632588502');" onmouseout="out('-6886346622632588502');" style="">  20 import java.nio.ByteBuffer;                                                                              </span>
<span class="-4536046119683402321" onmouseenter="enter('-4536046119683402321');" onmouseout="out('-4536046119683402321');" style="">  21 import java.nio.ByteOrder;                                                                               </span>
<span class="-8113221927992302576" onmouseenter="enter('-8113221927992302576');" onmouseout="out('-8113221927992302576');" style="">  22 import nodomain.freeyourgadget.gadgetbridge.GBApplication;                                               </span>
<span class="-7198279398549834921" onmouseenter="enter('-7198279398549834921');" onmouseout="out('-7198279398549834921');" style="">  23 import nodomain.freeyourgadget.gadgetbridge.R;                                                           </span>
<span class="5959948573825064529" onmouseenter="enter('5959948573825064529');" onmouseout="out('5959948573825064529');" style="">  24 import nodomain.freeyourgadget.gadgetbridge.activities.appmanager.AbstractAppManagerFragment;            </span>
<span class="-7454882487459214858" onmouseenter="enter('-7454882487459214858');" onmouseout="out('-7454882487459214858');" style="">  25 import nodomain.freeyourgadget.gadgetbridge.activities.appmanager.AppManagerActivity;                    </span>
<span class="8774236294555479386" onmouseenter="enter('8774236294555479386');" onmouseout="out('8774236294555479386');" style="">  26 import nodomain.freeyourgadget.gadgetbridge.deviceevents.GBDeviceEvent;                                  </span>
<span class="-4700446920707564194" onmouseenter="enter('-4700446920707564194');" onmouseout="out('-4700446920707564194');" style="">  27 import nodomain.freeyourgadget.gadgetbridge.deviceevents.GBDeviceEventAppInfo;                           </span>
<span class="-5686102242644058946" onmouseenter="enter('-5686102242644058946');" onmouseout="out('-5686102242644058946');" style="">  28 import nodomain.freeyourgadget.gadgetbridge.deviceevents.GBDeviceEventAppManagement;                     </span>
<span class="2791890994602016761" onmouseenter="enter('2791890994602016761');" onmouseout="out('2791890994602016761');" style="">  29 import nodomain.freeyourgadget.gadgetbridge.deviceevents.GBDeviceEventAppMessage;                        </span>
<span class="7456778970616733409" onmouseenter="enter('7456778970616733409');" onmouseout="out('7456778970616733409');" style="">  30 import nodomain.freeyourgadget.gadgetbridge.deviceevents.GBDeviceEventVersionInfo;                       </span>
<span class="-8786909529118259831" onmouseenter="enter('-8786909529118259831');" onmouseout="out('-8786909529118259831');" style="">  31 import nodomain.freeyourgadget.gadgetbridge.devices.pebble.PBWReader;                                    </span>
<span class="-6745962823678362300" onmouseenter="enter('-6745962823678362300');" onmouseout="out('-6745962823678362300');" style="">  32 import nodomain.freeyourgadget.gadgetbridge.devices.pebble.PebbleInstallable;                            </span>
<span class="4836892992022606579" onmouseenter="enter('4836892992022606579');" onmouseout="out('4836892992022606579');" style="">  33 import nodomain.freeyourgadget.gadgetbridge.impl.GBDevice;                                               </span>
<span class="-6775704228596592306" onmouseenter="enter('-6775704228596592306');" onmouseout="out('-6775704228596592306');" style="">  34 import nodomain.freeyourgadget.gadgetbridge.impl.GBDeviceApp;                                            </span>
<span class="-1754164907108633436" onmouseenter="enter('-1754164907108633436');" onmouseout="out('-1754164907108633436');" style="">  35 import nodomain.freeyourgadget.gadgetbridge.service.devices.pebble.ble.PebbleLESupport;                  </span>
<span class="-211901022449891328" onmouseenter="enter('-211901022449891328');" onmouseout="out('-211901022449891328');" style="">  36 import nodomain.freeyourgadget.gadgetbridge.service.serial.GBDeviceIoThread;                             </span>
<span class="-2195471833159259314" onmouseenter="enter('-2195471833159259314');" onmouseout="out('-2195471833159259314');" style="">  37 import nodomain.freeyourgadget.gadgetbridge.service.serial.GBDeviceProtocol;                             </span>
<span class="-2020231768395052380" onmouseenter="enter('-2020231768395052380');" onmouseout="out('-2020231768395052380');" style="">  38 import nodomain.freeyourgadget.gadgetbridge.util.FileUtils;                                              </span>
<span class="-3798970344596478499" onmouseenter="enter('-3798970344596478499');" onmouseout="out('-3798970344596478499');" style="">  39 import nodomain.freeyourgadget.gadgetbridge.util.GB;                                                     </span>
<span class="4645284583739884744" onmouseenter="enter('4645284583739884744');" onmouseout="out('4645284583739884744');" style="">  40 import nodomain.freeyourgadget.gadgetbridge.util.PebbleUtils;                                            </span>
<span class="-600862318521663319" onmouseenter="enter('-600862318521663319');" onmouseout="out('-600862318521663319');" style="">  41 import nodomain.freeyourgadget.gadgetbridge.util.Prefs;                                                  </span>
<span class="-425744571032727695" onmouseenter="enter('-425744571032727695');" onmouseout="out('-425744571032727695');" style="">  42 import nodomain.freeyourgadget.gadgetbridge.util.WebViewSingleton;                                       </span>
<span class="9072327285961251154" onmouseenter="enter('9072327285961251154');" onmouseout="out('9072327285961251154');" style="">  43 import org.slf4j.Logger;                                                                                 </span>
<span class="697043352225962606" onmouseenter="enter('697043352225962606');" onmouseout="out('697043352225962606');" style="">  44 import org.slf4j.LoggerFactory;                                                                          </span>
<span  style="">  45                                                                                                          </span>
<span  style="">  46                                                                                                          </span>
<span class="2468896418036970449" onmouseenter="enter('2468896418036970449');" onmouseout="out('2468896418036970449');" style="">  47 class PebbleIoThread extends GBDeviceIoThread {                                                          </span>
<span class="2529670288626938632" onmouseenter="enter('2529670288626938632');" onmouseout="out('2529670288626938632');" style="">  48     private static final Logger LOG = LoggerFactory.getLogger(PebbleIoThread.class);                     </span>
<span  style="">  49                                                                                                          </span>
<span class="-4632193205469069671" onmouseenter="enter('-4632193205469069671');" onmouseout="out('-4632193205469069671');" style="">  50     private final Prefs prefs = GBApplication.getPrefs();                                                </span>
<span  style="">  51                                                                                                          </span>
<span class="-6631401332787692352" onmouseenter="enter('-6631401332787692352');" onmouseout="out('-6631401332787692352');" style="">  52     private final PebbleProtocol mPebbleProtocol;                                                        </span>
<span class="1328262475374241602" onmouseenter="enter('1328262475374241602');" onmouseout="out('1328262475374241602');" style="">  53     private final PebbleSupport mPebbleSupport;                                                          </span>
<span class="-2685935515172486802" onmouseenter="enter('-2685935515172486802');" onmouseout="out('-2685935515172486802');" style="">  54     private PebbleKitSupport mPebbleKitSupport;                                                          </span>
<span class="5255281464364524557" onmouseenter="enter('5255281464364524557');" onmouseout="out('5255281464364524557');" style="">  55     private final boolean mEnablePebblekit;                                                              </span>
<span  style="">  56                                                                                                          </span>
<span class="-1663504808667212623" onmouseenter="enter('-1663504808667212623');" onmouseout="out('-1663504808667212623');" style="">  57     private boolean mIsTCP = false;                                                                      </span>
<span class="7891956114489637668" onmouseenter="enter('7891956114489637668');" onmouseout="out('7891956114489637668');" style="">  58     private BluetoothAdapter mBtAdapter = null;                                                          </span>
<span class="-3474230100367526093" onmouseenter="enter('-3474230100367526093');" onmouseout="out('-3474230100367526093');" style="">  59     private BluetoothSocket mBtSocket = null;                                                            </span>
<span class="4972621324459114153" onmouseenter="enter('4972621324459114153');" onmouseout="out('4972621324459114153');" style="">  60     private Socket mTCPSocket = null; // for emulator                                                    </span>
<span class="8464954913827308931" onmouseenter="enter('8464954913827308931');" onmouseout="out('8464954913827308931');" style="">  61     private InputStream mInStream = null;                                                                </span>
<span class="176817746371882191" onmouseenter="enter('176817746371882191');" onmouseout="out('176817746371882191');" style="">  62     private OutputStream mOutStream = null;                                                              </span>
<span class="3507668063671934062" onmouseenter="enter('3507668063671934062');" onmouseout="out('3507668063671934062');" style="">  63     private PebbleLESupport mPebbleLESupport;                                                            </span>
<span  style="">  64                                                                                                          </span>
<span class="8291227991234502986" onmouseenter="enter('8291227991234502986');" onmouseout="out('8291227991234502986');" style="">  65     private boolean mQuit = false;                                                                       </span>
<span class="-4308649044970502514" onmouseenter="enter('-4308649044970502514');" onmouseout="out('-4308649044970502514');" style="">  66     private boolean mIsConnected = false;                                                                </span>
<span class="591172670703241498" onmouseenter="enter('591172670703241498');" onmouseout="out('591172670703241498');" style="">  67     private boolean mIsInstalling = false;                                                               </span>
<span  style="">  68                                                                                                          </span>
<span class="7746276727914849634" onmouseenter="enter('7746276727914849634');" onmouseout="out('7746276727914849634');" style="">  69     private PBWReader mPBWReader = null;                                                                 </span>
<span class="1166586313023966318" onmouseenter="enter('1166586313023966318');" onmouseout="out('1166586313023966318');" style="">  70     private GBDeviceApp mCurrentlyInstallingApp = null;                                                  </span>
<span class="-1645742411754742536" onmouseenter="enter('-1645742411754742536');" onmouseout="out('-1645742411754742536');" style="">  71     private int mAppInstallToken = -1;                                                                   </span>
<span class="-3680441812231545667" onmouseenter="enter('-3680441812231545667');" onmouseout="out('-3680441812231545667');" style="">  72     private InputStream mFis = null;                                                                     </span>
<span class="8056811120544011853" onmouseenter="enter('8056811120544011853');" onmouseout="out('8056811120544011853');" style="">  73     private PebbleAppInstallState mInstallState = PebbleAppInstallState.UNKNOWN;                         </span>
<span class="2315852437300231853" onmouseenter="enter('2315852437300231853');" onmouseout="out('2315852437300231853');" style="">  74     private PebbleInstallable[] mPebbleInstallables = null;                                              </span>
<span class="-6610002799635202363" onmouseenter="enter('-6610002799635202363');" onmouseout="out('-6610002799635202363');" style="">  75     private int mCurrentInstallableIndex = -1;                                                           </span>
<span class="-6569382683370215618" onmouseenter="enter('-6569382683370215618');" onmouseout="out('-6569382683370215618');" style="">  76     private int mInstallSlot = -2;                                                                       </span>
<span class="-8194648222476538160" onmouseenter="enter('-8194648222476538160');" onmouseout="out('-8194648222476538160');" style="">  77     private int mCRC = -1;                                                                               </span>
<span class="-2481332028036817904" onmouseenter="enter('-2481332028036817904');" onmouseout="out('-2481332028036817904');" style="">  78     private int mBinarySize = -1;                                                                        </span>
<span class="-1832879895999614218" onmouseenter="enter('-1832879895999614218');" onmouseout="out('-1832879895999614218');" style="">  79     private int mBytesWritten = -1;                                                                      </span>
<span  style="">  80                                                                                                          </span>
<span  style="">  81                                                                                                          </span>
<span class="-6681681893462133916" onmouseenter="enter('-6681681893462133916');" onmouseout="out('-6681681893462133916');" style="">  82 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT                                                                                             </span>
<span class="8914325663092470246" onmouseenter="enter('8914325663092470246');" onmouseout="out('8914325663092470246');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  83     private final BroadcastReceiver mPebbleKitReceiver = new BroadcastReceiver() {                       </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  84         @Override                                                                                        </span>
<span class="-1520739091809898546" onmouseenter="enter('-1520739091809898546');" onmouseout="out('-1520739091809898546');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  85         public void onReceive(Context context, Intent intent) {                                          </span>
<span class="5344227773413700857" onmouseenter="enter('5344227773413700857');" onmouseout="out('5344227773413700857');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  86             String action = intent.getAction();                                                          </span>
<span class="-2767557360944414006" onmouseenter="enter('-2767557360944414006');" onmouseout="out('-2767557360944414006');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  87             LOG.info(&quot;Got action: &quot; + action);                                                           </span>
<span class="8190723481817549581" onmouseenter="enter('8190723481817549581');" onmouseout="out('8190723481817549581');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  88             UUID uuid;                                                                                   </span>
<span class="6099627150369302694" onmouseenter="enter('6099627150369302694');" onmouseout="out('6099627150369302694');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  89             switch (action) {                                                                            </span>
<span class="-5607690174400779115" onmouseenter="enter('-5607690174400779115');" onmouseout="out('-5607690174400779115');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  90                 case PEBBLEKIT_ACTION_APP_START:                                                         </span>
<span class="-1756369772806174160" onmouseenter="enter('-1756369772806174160');" onmouseout="out('-1756369772806174160');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  91                 case PEBBLEKIT_ACTION_APP_STOP:                                                          </span>
<span class="-185467528302823505" onmouseenter="enter('-185467528302823505');" onmouseout="out('-185467528302823505');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  92                     uuid = (UUID) intent.getSerializableExtra(&quot;uuid&quot;);                                   </span>
<span class="6094803455832882033" onmouseenter="enter('6094803455832882033');" onmouseout="out('6094803455832882033');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  93                     if (uuid != null) {                                                                  </span>
<span class="-3038014536715207103" onmouseenter="enter('-3038014536715207103');" onmouseout="out('-3038014536715207103');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title="  94                         write(mPebbleProtocol.encodeAppStart(uuid, action.equals(PEBBLEKIT_ACTION_APP_START)));">  94                         write(mPebbleProtocol.encodeAppStart(uuid, action.equals(PEBBLEKIT_ACTION_APP_STAðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  95                     }                                                                                    </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  96                     break;                                                                               </span>
<span class="3550381777945223205" onmouseenter="enter('3550381777945223205');" onmouseout="out('3550381777945223205');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  97                 case PEBBLEKIT_ACTION_APP_SEND:                                                          </span>
<span class="8746871362101842242" onmouseenter="enter('8746871362101842242');" onmouseout="out('8746871362101842242');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  98                     int transaction_id = intent.getIntExtra(&quot;transaction_id&quot;, -1);                       </span>
<span class="-185467528302823505" onmouseenter="enter('-185467528302823505');" onmouseout="out('-185467528302823505');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  99                     uuid = (UUID) intent.getSerializableExtra(&quot;uuid&quot;);                                   </span>
<span class="115505315270435118" onmouseenter="enter('115505315270435118');" onmouseout="out('115505315270435118');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 100                     String jsonString = intent.getStringExtra(&quot;msg_data&quot;);                               </span>
<span class="1347360621013773363" onmouseenter="enter('1347360621013773363');" onmouseout="out('1347360621013773363');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 101                     LOG.info(&quot;json string: &quot; + jsonString);                                              </span>
<span  style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 102                                                                                                          </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 103                     try {                                                                                </span>
<span class="6685187839340796030" onmouseenter="enter('6685187839340796030');" onmouseout="out('6685187839340796030');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 104                         JSONArray jsonArray = new JSONArray(jsonString);                                 </span>
<span class="1915657714539023329" onmouseenter="enter('1915657714539023329');" onmouseout="out('1915657714539023329');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 105                         write(mPebbleProtocol.encodeApplicationMessageFromJSON(uuid, jsonArray));        </span>
<span class="4286948008967663548" onmouseenter="enter('4286948008967663548');" onmouseout="out('4286948008967663548');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 106                         sendAppMessageAck(transaction_id);                                               </span>
<span  style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 107                                                                                                          </span>
<span class="2021063483207698984" onmouseenter="enter('2021063483207698984');" onmouseout="out('2021063483207698984');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 108                     } catch (JSONException e) {                                                          </span>
<span class="4090663313211582937" onmouseenter="enter('4090663313211582937');" onmouseout="out('4090663313211582937');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 109                         e.printStackTrace();                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 110                     }                                                                                    </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 111                     break;                                                                               </span>
<span class="-4575626246346919371" onmouseenter="enter('-4575626246346919371');" onmouseout="out('-4575626246346919371');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 112                 case PEBBLEKIT_ACTION_APP_ACK:                                                           </span>
<span class="-5397546053733935151" onmouseenter="enter('-5397546053733935151');" onmouseout="out('-5397546053733935151');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 113                     // we do not get a uuid and cannot map a transaction id to it, so we ack in PebbleProtocol early"> 113                     // we do not get a uuid and cannot map a transaction id to it, so we ack in PebbleProðŸ”µ</abbr></span>
<span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 114                     /*                                                                                   </span>
<span class="-185467528302823505" onmouseenter="enter('-185467528302823505');" onmouseout="out('-185467528302823505');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 115                     uuid = (UUID) intent.getSerializableExtra(&quot;uuid&quot;);                                   </span>
<span class="8746871362101842242" onmouseenter="enter('8746871362101842242');" onmouseout="out('8746871362101842242');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 116                     int transaction_id = intent.getIntExtra(&quot;transaction_id&quot;, -1);                       </span>
<span class="-5460339056046386879" onmouseenter="enter('-5460339056046386879');" onmouseout="out('-5460339056046386879');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 117                     if (transaction_id &gt;= 0 &amp;&amp; transaction_id &lt;= 255) {                                  </span>
<span class="-1247931610264669179" onmouseenter="enter('-1247931610264669179');" onmouseout="out('-1247931610264669179');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 118                         write(mPebbleProtocol.encodeApplicationMessageAck(uuid, (byte) transaction_id)); </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 119                     } else {                                                                             </span>
<span class="9187855197608677341" onmouseenter="enter('9187855197608677341');" onmouseout="out('9187855197608677341');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 120                         LOG.warn(&quot;illegal transacktion id &quot; + transaction_id);                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 121                     }                                                                                    </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 122                     */                                                                                   </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 123                     break;                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 124             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 125         }                                                                                                </span>
<span class="2468309323999483380" onmouseenter="enter('2468309323999483380');" onmouseout="out('2468309323999483380');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 126     };                                                                                                   </span>
<span  style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 127                                                                                                          </span>
<span class="-8000809992863847428" onmouseenter="enter('-8000809992863847428');" onmouseout="out('-8000809992863847428');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 128     private void sendAppMessageJS(GBDeviceEventAppMessage appMessage) {                                  </span>
<span class="5061350280559930277" onmouseenter="enter('5061350280559930277');" onmouseout="out('5061350280559930277');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 129         WebViewSingleton.getorInitWebView(getContext(), gbDevice, appMessage.appUUID);                   </span>
<span class="-2478103463940331708" onmouseenter="enter('-2478103463940331708');" onmouseout="out('-2478103463940331708');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 130         WebViewSingleton.appMessage(appMessage.message);                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 131     }                                                                                                    </span>
<span  style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 132                                                                                                          </span>
<span class="-7621847952583919612" onmouseenter="enter('-7621847952583919612');" onmouseout="out('-7621847952583919612');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 133     private void sendAppMessageIntent(GBDeviceEventAppMessage appMessage) {                              </span>
<span class="535862575394010177" onmouseenter="enter('535862575394010177');" onmouseout="out('535862575394010177');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 134         Intent intent = new Intent();                                                                    </span>
<span class="-308940498243775713" onmouseenter="enter('-308940498243775713');" onmouseout="out('-308940498243775713');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 135         intent.setAction(PEBBLEKIT_ACTION_APP_RECEIVE);                                                  </span>
<span class="-4819521277987879596" onmouseenter="enter('-4819521277987879596');" onmouseout="out('-4819521277987879596');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 136         intent.putExtra(&quot;uuid&quot;, appMessage.appUUID);                                                     </span>
<span class="-4518626450248788495" onmouseenter="enter('-4518626450248788495');" onmouseout="out('-4518626450248788495');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 137         intent.putExtra(&quot;msg_data&quot;, appMessage.message);                                                 </span>
<span class="788400804283391840" onmouseenter="enter('788400804283391840');" onmouseout="out('788400804283391840');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 138         intent.putExtra(&quot;transaction_id&quot;, appMessage.id);                                                </span>
<span class="-877666395707968466" onmouseenter="enter('-877666395707968466');" onmouseout="out('-877666395707968466');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 139         LOG.info(&quot;broadcasting to uuid &quot; + appMessage.appUUID + &quot; transaction id: &quot; + appMessage.id + &quot; JSON: &quot; + appMessage.message);"> 139         LOG.info(&quot;broadcasting to uuid &quot; + appMessage.appUUID + &quot; transaction id: &quot; + appMessage.id + &quot; JðŸ”µ</abbr></span>
<span class="5781834444291540387" onmouseenter="enter('5781834444291540387');" onmouseout="out('5781834444291540387');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 140         getContext().sendBroadcast(intent);                                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 141     }                                                                                                    </span>
<span  style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 142                                                                                                          </span>
<span  style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 143                                                                                                          </span>
<span class="7991106586064342212" onmouseenter="enter('7991106586064342212');" onmouseout="out('7991106586064342212');" style=""> 144 ||||||| BASE                                                                                             </span>
<span class="-3639349873877828882" onmouseenter="enter('-3639349873877828882');" onmouseout="out('-3639349873877828882');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 145 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 145 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwðŸ”µ</abbr></span>
<span class="3796057323931724632" onmouseenter="enter('3796057323931724632');" onmouseout="out('3796057323931724632');" style=""> 146 =======                                                                                                  </span>
<span  style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 147                                                                                                          </span>
<span  style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 148                                                                                                          </span>
<span class="-1814092468913316143" onmouseenter="enter('-1814092468913316143');" onmouseout="out('-1814092468913316143');" style=""> 149 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT                                                                                            </span>
<span class="-1707422926868996417" onmouseenter="enter('-1707422926868996417');" onmouseout="out('-1707422926868996417');" style=""><abbr title=" 150     PebbleIoThread(PebbleSupport pebbleSupport, GBDevice gbDevice, GBDeviceProtocol gbDeviceProtocol, BluetoothAdapter btAdapter, Context context) {"> 150     PebbleIoThread(PebbleSupport pebbleSupport, GBDevice gbDevice, GBDeviceProtocol gbDeviceProtocol, BluðŸ”µ</abbr></span>
<span class="-4446577987516131269" onmouseenter="enter('-4446577987516131269');" onmouseout="out('-4446577987516131269');" style=""> 151         super(gbDevice, context);                                                                        </span>
<span class="-535847603056830094" onmouseenter="enter('-535847603056830094');" onmouseout="out('-535847603056830094');" style=""> 152         mPebbleProtocol = (PebbleProtocol) gbDeviceProtocol;                                             </span>
<span class="-7802515276203668031" onmouseenter="enter('-7802515276203668031');" onmouseout="out('-7802515276203668031');" style=""> 153         mBtAdapter = btAdapter;                                                                          </span>
<span class="-175348863880720182" onmouseenter="enter('-175348863880720182');" onmouseout="out('-175348863880720182');" style=""> 154         mPebbleSupport = pebbleSupport;                                                                  </span>
<span class="-766654887411083682" onmouseenter="enter('-766654887411083682');" onmouseout="out('-766654887411083682');" style=""> 155         mEnablePebblekit = prefs.getBoolean(&quot;pebble_enable_pebblekit&quot;, false);                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 156     }                                                                                                    </span>
<span  style=""> 157                                                                                                          </span>
<span class="-2292081679562824726" onmouseenter="enter('-2292081679562824726');" onmouseout="out('-2292081679562824726');" style=""><abbr title=" 158     private int readWithException(InputStream inputStream, byte[] buffer, int byteOffset, int byteCount) throws IOException {"> 158     private int readWithException(InputStream inputStream, byte[] buffer, int byteOffset, int byteCount) ðŸ”µ</abbr></span>
<span class="4268945675950741459" onmouseenter="enter('4268945675950741459');" onmouseout="out('4268945675950741459');" style=""> 159         int ret = inputStream.read(buffer, byteOffset, byteCount);                                       </span>
<span class="3796083344931271004" onmouseenter="enter('3796083344931271004');" onmouseout="out('3796083344931271004');" style=""> 160         if (ret == -1) {                                                                                 </span>
<span class="8493867222528380496" onmouseenter="enter('8493867222528380496');" onmouseout="out('8493867222528380496');" style=""> 161             throw new IOException(&quot;broken pipe&quot;);                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 162         }                                                                                                </span>
<span class="1456633081770441725" onmouseenter="enter('1456633081770441725');" onmouseout="out('1456633081770441725');" style=""> 163         return ret;                                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 164     }                                                                                                    </span>
<span  style=""> 165                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 166     @Override                                                                                            </span>
<span class="-689441939839417419" onmouseenter="enter('-689441939839417419');" onmouseout="out('-689441939839417419');" style=""> 167     protected boolean connect() {                                                                        </span>
<span class="7179548470555074529" onmouseenter="enter('7179548470555074529');" onmouseout="out('7179548470555074529');" style=""> 168         String deviceAddress = gbDevice.getAddress();                                                    </span>
<span class="8603377014623514599" onmouseenter="enter('8603377014623514599');" onmouseout="out('8603377014623514599');" style=""> 169         GBDevice.State originalState = gbDevice.getState();                                              </span>
<span class="-2168554989878345062" onmouseenter="enter('-2168554989878345062');" onmouseout="out('-2168554989878345062');" style=""> 170         gbDevice.setState(GBDevice.State.CONNECTING);                                                    </span>
<span class="-6083303279196581322" onmouseenter="enter('-6083303279196581322');" onmouseout="out('-6083303279196581322');" style=""> 171         gbDevice.sendDeviceUpdateIntent(getContext());                                                   </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 172         try {                                                                                            </span>
<span class="-8563020019953546005" onmouseenter="enter('-8563020019953546005');" onmouseout="out('-8563020019953546005');" style=""> 173             // contains only one &quot;:&quot;? then it is addr:port                                               </span>
<span class="-146660580149754487" onmouseenter="enter('-146660580149754487');" onmouseout="out('-146660580149754487');" style=""> 174             int firstColon = deviceAddress.indexOf(&quot;:&quot;);                                                 </span>
<span class="5048700417952215836" onmouseenter="enter('5048700417952215836');" onmouseout="out('5048700417952215836');" style=""> 175             if (firstColon == deviceAddress.lastIndexOf(&quot;:&quot;)) {                                          </span>
<span class="-8977049560738769524" onmouseenter="enter('-8977049560738769524');" onmouseout="out('-8977049560738769524');" style=""> 176                 mIsTCP = true;                                                                           </span>
<span class="-6378857250762995034" onmouseenter="enter('-6378857250762995034');" onmouseout="out('-6378857250762995034');" style=""> 177                 InetAddress serverAddr = InetAddress.getByName(deviceAddress.substring(0, firstColon));  </span>
<span class="3468657720829688371" onmouseenter="enter('3468657720829688371');" onmouseout="out('3468657720829688371');" style=""><abbr title=" 178                 mTCPSocket = new Socket(serverAddr, Integer.parseInt(deviceAddress.substring(firstColon + 1)));"> 178                 mTCPSocket = new Socket(serverAddr, Integer.parseInt(deviceAddress.substring(firstColon +ðŸ”µ</abbr></span>
<span class="-6670767050188612078" onmouseenter="enter('-6670767050188612078');" onmouseout="out('-6670767050188612078');" style=""> 179                 mInStream = mTCPSocket.getInputStream();                                                 </span>
<span class="-6104065159882353101" onmouseenter="enter('-6104065159882353101');" onmouseout="out('-6104065159882353101');" style=""> 180                 mOutStream = mTCPSocket.getOutputStream();                                               </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 181             } else {                                                                                     </span>
<span class="4347759254647630465" onmouseenter="enter('4347759254647630465');" onmouseout="out('4347759254647630465');" style=""> 182                 mIsTCP = false;                                                                          </span>
<span class="6443654244968138967" onmouseenter="enter('6443654244968138967');" onmouseout="out('6443654244968138967');" style=""><abbr title=" 183                 if (gbDevice.getVolatileAddress() != null &amp;&amp; prefs.getBoolean(&quot;pebble_force_le&quot;, false)) {"> 183                 if (gbDevice.getVolatileAddress() != null &amp;&amp; prefs.getBoolean(&quot;pebble_force_le&quot;, false)) ðŸ”µ</abbr></span>
<span class="915290997518797062" onmouseenter="enter('915290997518797062');" onmouseout="out('915290997518797062');" style=""> 184                     deviceAddress = gbDevice.getVolatileAddress();                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 185                 }                                                                                        </span>
<span class="4786675468629518746" onmouseenter="enter('4786675468629518746');" onmouseout="out('4786675468629518746');" style=""> 186                 BluetoothDevice btDevice = mBtAdapter.getRemoteDevice(deviceAddress);                    </span>
<span class="335623565325713065" onmouseenter="enter('335623565325713065');" onmouseout="out('335623565325713065');" style=""> 187                 if (btDevice.getType() == BluetoothDevice.DEVICE_TYPE_LE) {                              </span>
<span class="8333508526895931889" onmouseenter="enter('8333508526895931889');" onmouseout="out('8333508526895931889');" style=""> 188                     LOG.info(&quot;This is a Pebble 2 or Pebble-LE/Pebble Time LE, will use BLE&quot;);            </span>
<span class="-3562679261979772904" onmouseenter="enter('-3562679261979772904');" onmouseout="out('-3562679261979772904');" style=""> 189                     mInStream = new PipedInputStream();                                                  </span>
<span class="6393093760748525382" onmouseenter="enter('6393093760748525382');" onmouseout="out('6393093760748525382');" style=""> 190                     mOutStream = new PipedOutputStream();                                                </span>
<span class="2915722355401222377" onmouseenter="enter('2915722355401222377');" onmouseout="out('2915722355401222377');" style=""><abbr title=" 191                     mPebbleLESupport = new PebbleLESupport(this.getContext(), btDevice, (PipedInputStream) mInStream, (PipedOutputStream) mOutStream);"> 191                     mPebbleLESupport = new PebbleLESupport(this.getContext(), btDevice, (PipedInputStreamðŸ”µ</abbr></span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 192                 } else {                                                                                 </span>
<span class="8228468292686787155" onmouseenter="enter('8228468292686787155');" onmouseout="out('8228468292686787155');" style=""> 193                     ParcelUuid uuids[] = btDevice.getUuids();                                            </span>
<span class="2503839032557077084" onmouseenter="enter('2503839032557077084');" onmouseout="out('2503839032557077084');" style=""> 194                     if (uuids == null) {                                                                 </span>
<span class="-5432226360745882584" onmouseenter="enter('-5432226360745882584');" onmouseout="out('-5432226360745882584');" style=""> 195                         return false;                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 196                     }                                                                                    </span>
<span class="8104594939174164082" onmouseenter="enter('8104594939174164082');" onmouseout="out('8104594939174164082');" style=""> 197                     for (ParcelUuid uuid : uuids) {                                                      </span>
<span class="5496152670479511454" onmouseenter="enter('5496152670479511454');" onmouseout="out('5496152670479511454');" style=""> 198                         LOG.info(&quot;found service UUID &quot; + uuid);                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 199                     }                                                                                    </span>
<span class="-2085322778834697972" onmouseenter="enter('-2085322778834697972');" onmouseout="out('-2085322778834697972');" style=""> 200                     mBtSocket = btDevice.createRfcommSocketToServiceRecord(uuids[0].getUuid());          </span>
<span class="-617547228937795237" onmouseenter="enter('-617547228937795237');" onmouseout="out('-617547228937795237');" style=""> 201                     mBtSocket.connect();                                                                 </span>
<span class="-4553264448616972703" onmouseenter="enter('-4553264448616972703');" onmouseout="out('-4553264448616972703');" style=""> 202                     mInStream = mBtSocket.getInputStream();                                              </span>
<span class="-4296883704518407532" onmouseenter="enter('-4296883704518407532');" onmouseout="out('-4296883704518407532');" style=""> 203                     mOutStream = mBtSocket.getOutputStream();                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 204                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 205             }                                                                                            </span>
<span class="7080241092423381085" onmouseenter="enter('7080241092423381085');" onmouseout="out('7080241092423381085');" style=""> 206         } catch (IOException e) {                                                                        </span>
<span class="4090663313211582937" onmouseenter="enter('4090663313211582937');" onmouseout="out('4090663313211582937');" style=""> 207             e.printStackTrace();                                                                         </span>
<span class="5984241666527947087" onmouseenter="enter('5984241666527947087');" onmouseout="out('5984241666527947087');" style=""> 208             gbDevice.setState(originalState);                                                            </span>
<span class="-6083303279196581322" onmouseenter="enter('-6083303279196581322');" onmouseout="out('-6083303279196581322');" style=""> 209             gbDevice.sendDeviceUpdateIntent(getContext());                                               </span>
<span  style=""> 210                                                                                                          </span>
<span class="3085765988076808372" onmouseenter="enter('3085765988076808372');" onmouseout="out('3085765988076808372');" style=""> 211             mInStream = null;                                                                            </span>
<span class="4968882532143556776" onmouseenter="enter('4968882532143556776');" onmouseout="out('4968882532143556776');" style=""> 212             mOutStream = null;                                                                           </span>
<span class="-4534501040604870855" onmouseenter="enter('-4534501040604870855');" onmouseout="out('-4534501040604870855');" style=""> 213             mBtSocket = null;                                                                            </span>
<span class="-5432226360745882584" onmouseenter="enter('-5432226360745882584');" onmouseout="out('-5432226360745882584');" style=""> 214             return false;                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 215         }                                                                                                </span>
<span  style=""> 216                                                                                                          </span>
<span class="1677595949374963054" onmouseenter="enter('1677595949374963054');" onmouseout="out('1677595949374963054');" style=""> 217         mPebbleProtocol.setForceProtocol(prefs.getBoolean(&quot;pebble_force_protocol&quot;, false));              </span>
<span  style=""> 218                                                                                                          </span>
<span class="5928608366163593597" onmouseenter="enter('5928608366163593597');" onmouseout="out('5928608366163593597');" style=""> 219         mIsConnected = true;                                                                             </span>
<span class="3321416181738117978" onmouseenter="enter('3321416181738117978');" onmouseout="out('3321416181738117978');" style=""> 220         write(mPebbleProtocol.encodeFirmwareVersionReq());                                               </span>
<span class="-7904642316416307948" onmouseenter="enter('-7904642316416307948');" onmouseout="out('-7904642316416307948');" style=""> 221         gbDevice.setState(GBDevice.State.CONNECTED);                                                     </span>
<span class="-6083303279196581322" onmouseenter="enter('-6083303279196581322');" onmouseout="out('-6083303279196581322');" style=""> 222         gbDevice.sendDeviceUpdateIntent(getContext());                                                   </span>
<span  style=""> 223                                                                                                          </span>
<span class="-3118901906653197100" onmouseenter="enter('-3118901906653197100');" onmouseout="out('-3118901906653197100');" style=""> 224         return true;                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 225     }                                                                                                    </span>
<span  style=""> 226                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 227     @Override                                                                                            </span>
<span class="5292860430507443886" onmouseenter="enter('5292860430507443886');" onmouseout="out('5292860430507443886');" style=""> 228     public void run() {                                                                                  </span>
<span class="-2588539367217579258" onmouseenter="enter('-2588539367217579258');" onmouseout="out('-2588539367217579258');" style=""> 229         mIsConnected = connect();                                                                        </span>
<span class="-245134013635442990" onmouseenter="enter('-245134013635442990');" onmouseout="out('-245134013635442990');" style=""> 230         if (!mIsConnected) {                                                                             </span>
<span class="2633273029186728772" onmouseenter="enter('2633273029186728772');" onmouseout="out('2633273029186728772');" style=""> 231             if (GBApplication.getGBPrefs().getAutoReconnect() &amp;&amp; !mQuit) {                               </span>
<span class="3557129149179391090" onmouseenter="enter('3557129149179391090');" onmouseout="out('3557129149179391090');" style=""> 232                 gbDevice.setState(GBDevice.State.WAITING_FOR_RECONNECT);                                 </span>
<span class="-6083303279196581322" onmouseenter="enter('-6083303279196581322');" onmouseout="out('-6083303279196581322');" style=""> 233                 gbDevice.sendDeviceUpdateIntent(getContext());                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 234             }                                                                                            </span>
<span class="4043029072030362567" onmouseenter="enter('4043029072030362567');" onmouseout="out('4043029072030362567');" style=""> 235             return;                                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 236         }                                                                                                </span>
<span  style=""> 237                                                                                                          </span>
<span class="2624641968800564380" onmouseenter="enter('2624641968800564380');" onmouseout="out('2624641968800564380');" style=""> 238         byte[] buffer = new byte[8192];                                                                  </span>
<span class="8018073170313256099" onmouseenter="enter('8018073170313256099');" onmouseout="out('8018073170313256099');" style=""> 239         enablePebbleKitSupport(true);                                                                    </span>
<span class="-8765366791852935627" onmouseenter="enter('-8765366791852935627');" onmouseout="out('-8765366791852935627');" style=""> 240         mQuit = false;                                                                                   </span>
<span class="-6588719847383972316" onmouseenter="enter('-6588719847383972316');" onmouseout="out('-6588719847383972316');" style=""> 241         while (!mQuit) {                                                                                 </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 242             try {                                                                                        </span>
<span class="-8278348814669106484" onmouseenter="enter('-8278348814669106484');" onmouseout="out('-8278348814669106484');" style=""> 243                 if (mIsInstalling) {                                                                     </span>
<span class="8684367013652331710" onmouseenter="enter('8684367013652331710');" onmouseout="out('8684367013652331710');" style=""> 244                     switch (mInstallState) {                                                             </span>
<span class="7026400303061140058" onmouseenter="enter('7026400303061140058');" onmouseout="out('7026400303061140058');" style=""> 245                         case WAIT_SLOT:                                                                  </span>
<span class="-2690055123266986251" onmouseenter="enter('-2690055123266986251');" onmouseout="out('-2690055123266986251');" style=""> 246                             if (mInstallSlot == -1) {                                                    </span>
<span class="-3606888775151099353" onmouseenter="enter('-3606888775151099353');" onmouseout="out('-3606888775151099353');" style=""> 247                                 finishInstall(true); // no slots available                               </span>
<span class="2295401759568749857" onmouseenter="enter('2295401759568749857');" onmouseout="out('2295401759568749857');" style=""> 248                             } else if (mInstallSlot &gt;= 0) {                                              </span>
<span class="6147346456613268497" onmouseenter="enter('6147346456613268497');" onmouseout="out('6147346456613268497');" style=""> 249                                 mInstallState = PebbleAppInstallState.START_INSTALL;                     </span>
<span class="-6362435147834875541" onmouseenter="enter('-6362435147834875541');" onmouseout="out('-6362435147834875541');" style=""> 250                                 continue;                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 251                             }                                                                            </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 252                             break;                                                                       </span>
<span class="-3962643594977912505" onmouseenter="enter('-3962643594977912505');" onmouseout="out('-3962643594977912505');" style=""> 253                         case START_INSTALL:                                                              </span>
<span class="-5574718196482043222" onmouseenter="enter('-5574718196482043222');" onmouseout="out('-5574718196482043222');" style=""> 254                             LOG.info(&quot;start installing app binary&quot;);                                     </span>
<span class="5478053508733530178" onmouseenter="enter('5478053508733530178');" onmouseout="out('5478053508733530178');" style=""> 255                             PebbleInstallable pi = mPebbleInstallables[mCurrentInstallableIndex];        </span>
<span class="3659756883627403325" onmouseenter="enter('3659756883627403325');" onmouseout="out('3659756883627403325');" style=""> 256                             mFis = mPBWReader.getInputStreamFile(pi.getFileName());                      </span>
<span class="5016659144309369034" onmouseenter="enter('5016659144309369034');" onmouseout="out('5016659144309369034');" style=""> 257                             mCRC = pi.getCRC();                                                          </span>
<span class="3142625636824209099" onmouseenter="enter('3142625636824209099');" onmouseout="out('3142625636824209099');" style=""> 258                             mBinarySize = pi.getFileSize();                                              </span>
<span class="4161899041554384973" onmouseenter="enter('4161899041554384973');" onmouseout="out('4161899041554384973');" style=""> 259                             mBytesWritten = 0;                                                           </span>
<span class="-1767419274223935649" onmouseenter="enter('-1767419274223935649');" onmouseout="out('-1767419274223935649');" style=""><abbr title=" 260                             writeInstallApp(mPebbleProtocol.encodeUploadStart(pi.getType(), mInstallSlot, mBinarySize, mPBWReader.isLanguage() ? &quot;lang&quot; : null));"> 260                             writeInstallApp(mPebbleProtocol.encodeUploadStart(pi.getType(), mInstallSlot,ðŸ”µ</abbr></span>
<span class="-556680889075439690" onmouseenter="enter('-556680889075439690');" onmouseout="out('-556680889075439690');" style=""> 261                             mAppInstallToken = -1;                                                       </span>
<span class="-7999689873557895203" onmouseenter="enter('-7999689873557895203');" onmouseout="out('-7999689873557895203');" style=""> 262                             mInstallState = PebbleAppInstallState.WAIT_TOKEN;                            </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 263                             break;                                                                       </span>
<span class="6792169580692674220" onmouseenter="enter('6792169580692674220');" onmouseout="out('6792169580692674220');" style=""> 264                         case WAIT_TOKEN:                                                                 </span>
<span class="-3832708479724599095" onmouseenter="enter('-3832708479724599095');" onmouseout="out('-3832708479724599095');" style=""> 265                             if (mAppInstallToken != -1) {                                                </span>
<span class="-8049659333726333512" onmouseenter="enter('-8049659333726333512');" onmouseout="out('-8049659333726333512');" style=""> 266                                 LOG.info(&quot;got token &quot; + mAppInstallToken);                               </span>
<span class="5531590291586303132" onmouseenter="enter('5531590291586303132');" onmouseout="out('5531590291586303132');" style=""> 267                                 mInstallState = PebbleAppInstallState.UPLOAD_CHUNK;                      </span>
<span class="-6362435147834875541" onmouseenter="enter('-6362435147834875541');" onmouseout="out('-6362435147834875541');" style=""> 268                                 continue;                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 269                             }                                                                            </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 270                             break;                                                                       </span>
<span class="-584114172413593495" onmouseenter="enter('-584114172413593495');" onmouseout="out('-584114172413593495');" style=""> 271                         case UPLOAD_CHUNK:                                                               </span>
<span class="1528466301664079417" onmouseenter="enter('1528466301664079417');" onmouseout="out('1528466301664079417');" style=""> 272                             int bytes = 0;                                                               </span>
<span class="3052837437029247759" onmouseenter="enter('3052837437029247759');" onmouseout="out('3052837437029247759');" style=""> 273                             do {                                                                         </span>
<span class="1834678701284410601" onmouseenter="enter('1834678701284410601');" onmouseout="out('1834678701284410601');" style=""> 274                                 int read = mFis.read(buffer, bytes, 2000 - bytes);                       </span>
<span class="-6442970889778139424" onmouseenter="enter('-6442970889778139424');" onmouseout="out('-6442970889778139424');" style=""> 275                                 if (read &lt;= 0) break;                                                    </span>
<span class="-8945043921272536992" onmouseenter="enter('-8945043921272536992');" onmouseout="out('-8945043921272536992');" style=""> 276                                 bytes += read;                                                           </span>
<span class="451207650617133464" onmouseenter="enter('451207650617133464');" onmouseout="out('451207650617133464');" style=""> 277                             } while (bytes &lt; 2000);                                                      </span>
<span  style=""> 278                                                                                                          </span>
<span class="6794246418348616673" onmouseenter="enter('6794246418348616673');" onmouseout="out('6794246418348616673');" style=""> 279                             if (bytes &gt; 0) {                                                             </span>
<span class="-5617191400623126363" onmouseenter="enter('-5617191400623126363');" onmouseout="out('-5617191400623126363');" style=""> 280                                 GB.updateInstallNotification(getContext().getString(                     </span>
<span class="4050487273412981374" onmouseenter="enter('4050487273412981374');" onmouseout="out('4050487273412981374');" style=""><abbr title=" 281                                         R.string.installing_binary_d_d, (mCurrentInstallableIndex + 1), mPebbleInstallables.length), true, (int) (((float) mBytesWritten / mBinarySize) * 100), getContext());"> 281                                         R.string.installing_binary_d_d, (mCurrentInstallableIndex + 1), mðŸ”µ</abbr></span>
<span class="-7477526339537165687" onmouseenter="enter('-7477526339537165687');" onmouseout="out('-7477526339537165687');" style=""><abbr title=" 282                                 writeInstallApp(mPebbleProtocol.encodeUploadChunk(mAppInstallToken, buffer, bytes));"> 282                                 writeInstallApp(mPebbleProtocol.encodeUploadChunk(mAppInstallToken, buffeðŸ”µ</abbr></span>
<span class="-4728151037181866094" onmouseenter="enter('-4728151037181866094');" onmouseout="out('-4728151037181866094');" style=""> 283                                 mBytesWritten += bytes;                                                  </span>
<span class="-556680889075439690" onmouseenter="enter('-556680889075439690');" onmouseout="out('-556680889075439690');" style=""> 284                                 mAppInstallToken = -1;                                                   </span>
<span class="-7999689873557895203" onmouseenter="enter('-7999689873557895203');" onmouseout="out('-7999689873557895203');" style=""> 285                                 mInstallState = PebbleAppInstallState.WAIT_TOKEN;                        </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 286                             } else {                                                                     </span>
<span class="-5094680563432242000" onmouseenter="enter('-5094680563432242000');" onmouseout="out('-5094680563432242000');" style=""> 287                                 mInstallState = PebbleAppInstallState.UPLOAD_COMMIT;                     </span>
<span class="-6362435147834875541" onmouseenter="enter('-6362435147834875541');" onmouseout="out('-6362435147834875541');" style=""> 288                                 continue;                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 289                             }                                                                            </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 290                             break;                                                                       </span>
<span class="4124538925361105547" onmouseenter="enter('4124538925361105547');" onmouseout="out('4124538925361105547');" style=""> 291                         case UPLOAD_COMMIT:                                                              </span>
<span class="-2966405575206880121" onmouseenter="enter('-2966405575206880121');" onmouseout="out('-2966405575206880121');" style=""> 292                             writeInstallApp(mPebbleProtocol.encodeUploadCommit(mAppInstallToken, mCRC)); </span>
<span class="-556680889075439690" onmouseenter="enter('-556680889075439690');" onmouseout="out('-556680889075439690');" style=""> 293                             mAppInstallToken = -1;                                                       </span>
<span class="-6886437457702083289" onmouseenter="enter('-6886437457702083289');" onmouseout="out('-6886437457702083289');" style=""> 294                             mInstallState = PebbleAppInstallState.WAIT_COMMIT;                           </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 295                             break;                                                                       </span>
<span class="-6760167966557106950" onmouseenter="enter('-6760167966557106950');" onmouseout="out('-6760167966557106950');" style=""> 296                         case WAIT_COMMIT:                                                                </span>
<span class="-3832708479724599095" onmouseenter="enter('-3832708479724599095');" onmouseout="out('-3832708479724599095');" style=""> 297                             if (mAppInstallToken != -1) {                                                </span>
<span class="-8049659333726333512" onmouseenter="enter('-8049659333726333512');" onmouseout="out('-8049659333726333512');" style=""> 298                                 LOG.info(&quot;got token &quot; + mAppInstallToken);                               </span>
<span class="-6772897424369466346" onmouseenter="enter('-6772897424369466346');" onmouseout="out('-6772897424369466346');" style=""> 299                                 mInstallState = PebbleAppInstallState.UPLOAD_COMPLETE;                   </span>
<span class="-6362435147834875541" onmouseenter="enter('-6362435147834875541');" onmouseout="out('-6362435147834875541');" style=""> 300                                 continue;                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 301                             }                                                                            </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 302                             break;                                                                       </span>
<span class="7185565864054148536" onmouseenter="enter('7185565864054148536');" onmouseout="out('7185565864054148536');" style=""> 303                         case UPLOAD_COMPLETE:                                                            </span>
<span class="5024538798090815598" onmouseenter="enter('5024538798090815598');" onmouseout="out('5024538798090815598');" style=""> 304                             writeInstallApp(mPebbleProtocol.encodeUploadComplete(mAppInstallToken));     </span>
<span class="-937796524014974666" onmouseenter="enter('-937796524014974666');" onmouseout="out('-937796524014974666');" style=""> 305                             if (++mCurrentInstallableIndex &lt; mPebbleInstallables.length) {               </span>
<span class="6147346456613268497" onmouseenter="enter('6147346456613268497');" onmouseout="out('6147346456613268497');" style=""> 306                                 mInstallState = PebbleAppInstallState.START_INSTALL;                     </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 307                             } else {                                                                     </span>
<span class="4645923661994641503" onmouseenter="enter('4645923661994641503');" onmouseout="out('4645923661994641503');" style=""> 308                                 mInstallState = PebbleAppInstallState.APP_REFRESH;                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 309                             }                                                                            </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 310                             break;                                                                       </span>
<span class="-4660819450142864885" onmouseenter="enter('-4660819450142864885');" onmouseout="out('-4660819450142864885');" style=""> 311                         case APP_REFRESH:                                                                </span>
<span class="1423594820264173048" onmouseenter="enter('1423594820264173048');" onmouseout="out('1423594820264173048');" style=""> 312                             if (mPBWReader.isFirmware()) {                                               </span>
<span class="7979692944967033784" onmouseenter="enter('7979692944967033784');" onmouseout="out('7979692944967033784');" style=""> 313                                 writeInstallApp(mPebbleProtocol.encodeInstallFirmwareComplete());        </span>
<span class="8670418135173104454" onmouseenter="enter('8670418135173104454');" onmouseout="out('8670418135173104454');" style=""> 314                                 finishInstall(false);                                                    </span>
<span class="-3229195631780864145" onmouseenter="enter('-3229195631780864145');" onmouseout="out('-3229195631780864145');" style=""> 315                             } else if (mPBWReader.isLanguage() || mPebbleProtocol.mFwMajor &gt;= 3) {       </span>
<span class="-3079811230585835514" onmouseenter="enter('-3079811230585835514');" onmouseout="out('-3079811230585835514');" style=""> 316                                 finishInstall(false); // FIXME: don&#x27;t know yet how to detect success     </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 317                             } else {                                                                     </span>
<span class="-3742154807253834306" onmouseenter="enter('-3742154807253834306');" onmouseout="out('-3742154807253834306');" style=""> 318                                 writeInstallApp(mPebbleProtocol.encodeAppRefresh(mInstallSlot));         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 319                             }                                                                            </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 320                             break;                                                                       </span>
<span class="-8178136317704390296" onmouseenter="enter('-8178136317704390296');" onmouseout="out('-8178136317704390296');" style=""> 321                         default:                                                                         </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 322                             break;                                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 323                     }                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 324                 }                                                                                        </span>
<span class="5578850974519966568" onmouseenter="enter('5578850974519966568');" onmouseout="out('5578850974519966568');" style=""> 325                 if (mIsTCP) {                                                                            </span>
<span class="4471698368272895479" onmouseenter="enter('4471698368272895479');" onmouseout="out('4471698368272895479');" style=""> 326                     mInStream.skip(6);                                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 327                 }                                                                                        </span>
<span class="2796952267402194740" onmouseenter="enter('2796952267402194740');" onmouseout="out('2796952267402194740');" style=""> 328                 int bytes = readWithException(mInStream, buffer, 0, 4);                                  </span>
<span  style=""> 329                                                                                                          </span>
<span class="-2171789871350536014" onmouseenter="enter('-2171789871350536014');" onmouseout="out('-2171789871350536014');" style=""> 330                 while (bytes &lt; 4) {                                                                      </span>
<span class="-5884925481451326841" onmouseenter="enter('-5884925481451326841');" onmouseout="out('-5884925481451326841');" style=""> 331                     bytes += readWithException(mInStream, buffer, bytes, 4 - bytes);                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 332                 }                                                                                        </span>
<span  style=""> 333                                                                                                          </span>
<span class="-7296955466977945724" onmouseenter="enter('-7296955466977945724');" onmouseout="out('-7296955466977945724');" style=""> 334                 ByteBuffer buf = ByteBuffer.wrap(buffer);                                                </span>
<span class="-8522898317938558799" onmouseenter="enter('-8522898317938558799');" onmouseout="out('-8522898317938558799');" style=""> 335                 buf.order(ByteOrder.BIG_ENDIAN);                                                         </span>
<span class="2800045307834810060" onmouseenter="enter('2800045307834810060');" onmouseout="out('2800045307834810060');" style=""> 336                 short length = buf.getShort();                                                           </span>
<span class="-8125815031192715923" onmouseenter="enter('-8125815031192715923');" onmouseout="out('-8125815031192715923');" style=""> 337                 short endpoint = buf.getShort();                                                         </span>
<span class="9045200348604116826" onmouseenter="enter('9045200348604116826');" onmouseout="out('9045200348604116826');" style=""> 338                 if (length &lt; 0 || length &gt; 8192) {                                                       </span>
<span class="9194134393824457103" onmouseenter="enter('9194134393824457103');" onmouseout="out('9194134393824457103');" style=""> 339                     LOG.info(&quot;invalid length &quot; + length);                                                </span>
<span class="-967764297694162849" onmouseenter="enter('-967764297694162849');" onmouseout="out('-967764297694162849');" style=""> 340                     while (mInStream.available() &gt; 0) {                                                  </span>
<span class="-1967224316023950474" onmouseenter="enter('-1967224316023950474');" onmouseout="out('-1967224316023950474');" style=""> 341                         readWithException(mInStream, buffer, 0, buffer.length); // read all              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 342                     }                                                                                    </span>
<span class="-6362435147834875541" onmouseenter="enter('-6362435147834875541');" onmouseout="out('-6362435147834875541');" style=""> 343                     continue;                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 344                 }                                                                                        </span>
<span  style=""> 345                                                                                                          </span>
<span class="8513682448486197246" onmouseenter="enter('8513682448486197246');" onmouseout="out('8513682448486197246');" style=""> 346                 bytes = readWithException(mInStream, buffer, 4, length);                                 </span>
<span class="-1011005986067945864" onmouseenter="enter('-1011005986067945864');" onmouseout="out('-1011005986067945864');" style=""> 347                 while (bytes &lt; length) {                                                                 </span>
<span class="-7104003189991341630" onmouseenter="enter('-7104003189991341630');" onmouseout="out('-7104003189991341630');" style=""> 348                     bytes += readWithException(mInStream, buffer, bytes + 4, length - bytes);            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 349                 }                                                                                        </span>
<span  style=""> 350                                                                                                          </span>
<span class="5578850974519966568" onmouseenter="enter('5578850974519966568');" onmouseout="out('5578850974519966568');" style=""> 351                 if (mIsTCP) {                                                                            </span>
<span class="5401038970459668826" onmouseenter="enter('5401038970459668826');" onmouseout="out('5401038970459668826');" style=""> 352                     mInStream.skip(2);                                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 353                 }                                                                                        </span>
<span  style=""> 354                                                                                                          </span>
<span class="-7909466471492476851" onmouseenter="enter('-7909466471492476851');" onmouseout="out('-7909466471492476851');" style=""> 355                 GBDeviceEvent deviceEvents[] = mPebbleProtocol.decodeResponse(buffer);                   </span>
<span class="-638626929611439615" onmouseenter="enter('-638626929611439615');" onmouseout="out('-638626929611439615');" style=""> 356                 if (deviceEvents == null) {                                                              </span>
<span class="-7056050649624941936" onmouseenter="enter('-7056050649624941936');" onmouseout="out('-7056050649624941936');" style=""> 357                     LOG.info(&quot;unhandled message to endpoint &quot; + endpoint + &quot; (&quot; + length + &quot; bytes)&quot;);   </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 358                 } else {                                                                                 </span>
<span class="1477693521293066497" onmouseenter="enter('1477693521293066497');" onmouseout="out('1477693521293066497');" style=""> 359                     for (GBDeviceEvent deviceEvent : deviceEvents) {                                     </span>
<span class="2097356587238774416" onmouseenter="enter('2097356587238774416');" onmouseout="out('2097356587238774416');" style=""> 360                         if (deviceEvent == null) {                                                       </span>
<span class="-6362435147834875541" onmouseenter="enter('-6362435147834875541');" onmouseout="out('-6362435147834875541');" style=""> 361                             continue;                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 362                         }                                                                                </span>
<span class="-236987672843521774" onmouseenter="enter('-236987672843521774');" onmouseout="out('-236987672843521774');" style=""> 363                         if (!evaluateGBDeviceEventPebble(deviceEvent)) {                                 </span>
<span class="7042821987734772133" onmouseenter="enter('7042821987734772133');" onmouseout="out('7042821987734772133');" style=""> 364                             mPebbleSupport.evaluateGBDeviceEvent(deviceEvent);                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 365                         }                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 366                     }                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 367                 }                                                                                        </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 368                 try {                                                                                    </span>
<span class="1958254861600319008" onmouseenter="enter('1958254861600319008');" onmouseout="out('1958254861600319008');" style=""> 369                     Thread.sleep(100);                                                                   </span>
<span class="-7528533024404460182" onmouseenter="enter('-7528533024404460182');" onmouseout="out('-7528533024404460182');" style=""> 370                 } catch (InterruptedException e) {                                                       </span>
<span class="4090663313211582937" onmouseenter="enter('4090663313211582937');" onmouseout="out('4090663313211582937');" style=""> 371                     e.printStackTrace();                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 372                 }                                                                                        </span>
<span class="7080241092423381085" onmouseenter="enter('7080241092423381085');" onmouseout="out('7080241092423381085');" style=""> 373             } catch (IOException e) {                                                                    </span>
<span class="-508556787667332479" onmouseenter="enter('-508556787667332479');" onmouseout="out('-508556787667332479');" style=""><abbr title=" 374                 if (e.getMessage() != null &amp;&amp; (e.getMessage().equals(&quot;broken pipe&quot;) || e.getMessage().contains(&quot;socket closed&quot;))) { //FIXME: this does not feel right"> 374                 if (e.getMessage() != null &amp;&amp; (e.getMessage().equals(&quot;broken pipe&quot;) || e.getMessage().conðŸ”µ</abbr></span>
<span class="3941064908834146545" onmouseenter="enter('3941064908834146545');" onmouseout="out('3941064908834146545');" style=""> 375                     LOG.info(e.getMessage());                                                            </span>
<span class="1054919517095572489" onmouseenter="enter('1054919517095572489');" onmouseout="out('1054919517095572489');" style=""> 376                     mIsConnected = false;                                                                </span>
<span class="1961225799194435069" onmouseenter="enter('1961225799194435069');" onmouseout="out('1961225799194435069');" style=""> 377                     int reconnectAttempts = prefs.getInt(&quot;pebble_reconnect_attempts&quot;, 10);               </span>
<span class="-786112365036832199" onmouseenter="enter('-786112365036832199');" onmouseout="out('-786112365036832199');" style=""><abbr title=" 378                     if (!mQuit &amp;&amp; GBApplication.getGBPrefs().getAutoReconnect() &amp;&amp; reconnectAttempts &gt; 0) {"> 378                     if (!mQuit &amp;&amp; GBApplication.getGBPrefs().getAutoReconnect() &amp;&amp; reconnectAttempts &gt; 0)ðŸ”µ</abbr></span>
<span class="3557129149179391090" onmouseenter="enter('3557129149179391090');" onmouseout="out('3557129149179391090');" style=""> 379                         gbDevice.setState(GBDevice.State.WAITING_FOR_RECONNECT);                         </span>
<span class="-6083303279196581322" onmouseenter="enter('-6083303279196581322');" onmouseout="out('-6083303279196581322');" style=""> 380                         gbDevice.sendDeviceUpdateIntent(getContext());                                   </span>
<span  style=""> 381                                                                                                          </span>
<span class="6110344959180570674" onmouseenter="enter('6110344959180570674');" onmouseout="out('6110344959180570674');" style=""> 382                         int delaySeconds = 1;                                                            </span>
<span class="-5190003264224859806" onmouseenter="enter('-5190003264224859806');" onmouseout="out('-5190003264224859806');" style=""> 383                         while (reconnectAttempts-- &gt; 0 &amp;&amp; !mQuit &amp;&amp; !mIsConnected) {                     </span>
<span class="-7641363597792416938" onmouseenter="enter('-7641363597792416938');" onmouseout="out('-7641363597792416938');" style=""> 384                             LOG.info(&quot;Trying to reconnect (attempts left &quot; + reconnectAttempts + &quot;)&quot;);   </span>
<span class="-2588539367217579258" onmouseenter="enter('-2588539367217579258');" onmouseout="out('-2588539367217579258');" style=""> 385                             mIsConnected = connect();                                                    </span>
<span class="-245134013635442990" onmouseenter="enter('-245134013635442990');" onmouseout="out('-245134013635442990');" style=""> 386                             if (!mIsConnected) {                                                         </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 387                                 try {                                                                    </span>
<span class="-3669672008793578674" onmouseenter="enter('-3669672008793578674');" onmouseout="out('-3669672008793578674');" style=""> 388                                     Thread.sleep(delaySeconds * 1000);                                   </span>
<span class="1010771762618413361" onmouseenter="enter('1010771762618413361');" onmouseout="out('1010771762618413361');" style=""> 389                                 } catch (InterruptedException ignored) {                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 390                                 }                                                                        </span>
<span class="-8988961353399164519" onmouseenter="enter('-8988961353399164519');" onmouseout="out('-8988961353399164519');" style=""> 391                                 if (delaySeconds &lt; 64) {                                                 </span>
<span class="4518640925202616859" onmouseenter="enter('4518640925202616859');" onmouseout="out('4518640925202616859');" style=""> 392                                     delaySeconds *= 2;                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 393                                 }                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 394                             }                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 395                         }                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 396                     }                                                                                    </span>
<span class="-245134013635442990" onmouseenter="enter('-245134013635442990');" onmouseout="out('-245134013635442990');" style=""> 397                     if (!mIsConnected) {                                                                 </span>
<span class="-4534501040604870855" onmouseenter="enter('-4534501040604870855');" onmouseout="out('-4534501040604870855');" style=""> 398                         mBtSocket = null;                                                                </span>
<span class="-3119559015644534035" onmouseenter="enter('-3119559015644534035');" onmouseout="out('-3119559015644534035');" style=""> 399                         LOG.info(&quot;Bluetooth socket closed, will quit IO Thread&quot;);                        </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 400                         break;                                                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 401                     }                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 402                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 403             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 404         }                                                                                                </span>
<span class="1054919517095572489" onmouseenter="enter('1054919517095572489');" onmouseout="out('1054919517095572489');" style=""> 405         mIsConnected = false;                                                                            </span>
<span class="-3944229288018059276" onmouseenter="enter('-3944229288018059276');" onmouseout="out('-3944229288018059276');" style=""> 406         if (mBtSocket != null) {                                                                         </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 407             try {                                                                                        </span>
<span class="4957759683762229483" onmouseenter="enter('4957759683762229483');" onmouseout="out('4957759683762229483');" style=""> 408                 mBtSocket.close();                                                                       </span>
<span class="7080241092423381085" onmouseenter="enter('7080241092423381085');" onmouseout="out('7080241092423381085');" style=""> 409             } catch (IOException e) {                                                                    </span>
<span class="4090663313211582937" onmouseenter="enter('4090663313211582937');" onmouseout="out('4090663313211582937');" style=""> 410                 e.printStackTrace();                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 411             }                                                                                            </span>
<span class="-4534501040604870855" onmouseenter="enter('-4534501040604870855');" onmouseout="out('-4534501040604870855');" style=""> 412             mBtSocket = null;                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 413         }                                                                                                </span>
<span  style=""> 414                                                                                                          </span>
<span class="-8029876522886293743" onmouseenter="enter('-8029876522886293743');" onmouseout="out('-8029876522886293743');" style=""> 415         enablePebbleKitSupport(false);                                                                   </span>
<span  style=""> 416                                                                                                          </span>
<span class="754428857450446437" onmouseenter="enter('754428857450446437');" onmouseout="out('754428857450446437');" style=""> 417         if (mQuit) {                                                                                     </span>
<span class="3251995130332618727" onmouseenter="enter('3251995130332618727');" onmouseout="out('3251995130332618727');" style=""> 418             gbDevice.setState(GBDevice.State.NOT_CONNECTED);                                             </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 419         } else {                                                                                         </span>
<span class="3557129149179391090" onmouseenter="enter('3557129149179391090');" onmouseout="out('3557129149179391090');" style=""> 420             gbDevice.setState(GBDevice.State.WAITING_FOR_RECONNECT);                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 421         }                                                                                                </span>
<span  style=""> 422                                                                                                          </span>
<span class="3956366137427967177" onmouseenter="enter('3956366137427967177');" onmouseout="out('3956366137427967177');" style=""> 423         WebViewSingleton.disposeWebView();                                                               </span>
<span  style=""> 424                                                                                                          </span>
<span class="-6083303279196581322" onmouseenter="enter('-6083303279196581322');" onmouseout="out('-6083303279196581322');" style=""> 425         gbDevice.sendDeviceUpdateIntent(getContext());                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 426     }                                                                                                    </span>
<span  style=""> 427                                                                                                          </span>
<span class="6912900349290733332" onmouseenter="enter('6912900349290733332');" onmouseout="out('6912900349290733332');" style=""> 428     private void enablePebbleKitSupport(boolean enable) {                                                </span>
<span class="-4986567876401497765" onmouseenter="enter('-4986567876401497765');" onmouseout="out('-4986567876401497765');" style=""> 429         if (enable &amp;&amp; mEnablePebblekit) {                                                                </span>
<span class="6988208637409175545" onmouseenter="enter('6988208637409175545');" onmouseout="out('6988208637409175545');" style=""> 430             mPebbleKitSupport = new PebbleKitSupport(getContext(), PebbleIoThread.this, mPebbleProtocol);</span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 431         } else {                                                                                         </span>
<span class="1872000704840757529" onmouseenter="enter('1872000704840757529');" onmouseout="out('1872000704840757529');" style=""> 432             if (mPebbleKitSupport != null) {                                                             </span>
<span class="2355950174103684288" onmouseenter="enter('2355950174103684288');" onmouseout="out('2355950174103684288');" style=""> 433                 mPebbleKitSupport.close();                                                               </span>
<span class="-7890594263237719778" onmouseenter="enter('-7890594263237719778');" onmouseout="out('-7890594263237719778');" style=""> 434                 mPebbleKitSupport = null;                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 435             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 436         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 437     }                                                                                                    </span>
<span  style=""> 438                                                                                                          </span>
<span  style=""> 439                                                                                                          </span>
<span class="5266958563097079524" onmouseenter="enter('5266958563097079524');" onmouseout="out('5266958563097079524');" style=""> 440     private void write_real(byte[] bytes) {                                                              </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 441         try {                                                                                            </span>
<span class="5578850974519966568" onmouseenter="enter('5578850974519966568');" onmouseout="out('5578850974519966568');" style=""> 442             if (mIsTCP) {                                                                                </span>
<span class="7452866671884685289" onmouseenter="enter('7452866671884685289');" onmouseout="out('7452866671884685289');" style=""> 443                 ByteBuffer buf = ByteBuffer.allocate(bytes.length + 8);                                  </span>
<span class="-8522898317938558799" onmouseenter="enter('-8522898317938558799');" onmouseout="out('-8522898317938558799');" style=""> 444                 buf.order(ByteOrder.BIG_ENDIAN);                                                         </span>
<span class="5585321854972752725" onmouseenter="enter('5585321854972752725');" onmouseout="out('5585321854972752725');" style=""> 445                 buf.putShort((short) 0xfeed);                                                            </span>
<span class="7507473664785459909" onmouseenter="enter('7507473664785459909');" onmouseout="out('7507473664785459909');" style=""> 446                 buf.putShort((short) 1);                                                                 </span>
<span class="-8123162661289444091" onmouseenter="enter('-8123162661289444091');" onmouseout="out('-8123162661289444091');" style=""> 447                 buf.putShort((short) bytes.length);                                                      </span>
<span class="-7064269165968803859" onmouseenter="enter('-7064269165968803859');" onmouseout="out('-7064269165968803859');" style=""> 448                 buf.put(bytes);                                                                          </span>
<span class="488045024517500594" onmouseenter="enter('488045024517500594');" onmouseout="out('488045024517500594');" style=""> 449                 buf.putShort((short) 0xbeef);                                                            </span>
<span class="5890011760749412055" onmouseenter="enter('5890011760749412055');" onmouseout="out('5890011760749412055');" style=""> 450                 mOutStream.write(buf.array());                                                           </span>
<span class="5447277003517706714" onmouseenter="enter('5447277003517706714');" onmouseout="out('5447277003517706714');" style=""> 451                 mOutStream.flush();                                                                      </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 452             } else {                                                                                     </span>
<span class="-446832387142219515" onmouseenter="enter('-446832387142219515');" onmouseout="out('-446832387142219515');" style=""> 453                 mOutStream.write(bytes);                                                                 </span>
<span class="5447277003517706714" onmouseenter="enter('5447277003517706714');" onmouseout="out('5447277003517706714');" style=""> 454                 mOutStream.flush();                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 455             }                                                                                            </span>
<span class="7080241092423381085" onmouseenter="enter('7080241092423381085');" onmouseout="out('7080241092423381085');" style=""> 456         } catch (IOException e) {                                                                        </span>
<span class="886800052852078092" onmouseenter="enter('886800052852078092');" onmouseout="out('886800052852078092');" style=""> 457             LOG.error(&quot;Error writing.&quot;, e.getMessage());                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 458         }                                                                                                </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 459         try {                                                                                            </span>
<span class="1958254861600319008" onmouseenter="enter('1958254861600319008');" onmouseout="out('1958254861600319008');" style=""> 460             Thread.sleep(100);                                                                           </span>
<span class="1010771762618413361" onmouseenter="enter('1010771762618413361');" onmouseout="out('1010771762618413361');" style=""> 461         } catch (InterruptedException ignored) {                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 462         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 463     }                                                                                                    </span>
<span  style=""> 464                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 465     @Override                                                                                            </span>
<span class="2194193333899452301" onmouseenter="enter('2194193333899452301');" onmouseout="out('2194193333899452301');" style=""> 466     synchronized public void write(byte[] bytes) {                                                       </span>
<span class="7962173391634007539" onmouseenter="enter('7962173391634007539');" onmouseout="out('7962173391634007539');" style=""> 467         if (bytes == null) {                                                                             </span>
<span class="4043029072030362567" onmouseenter="enter('4043029072030362567');" onmouseout="out('4043029072030362567');" style=""> 468             return;                                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 469         }                                                                                                </span>
<span class="-1647178201768949716" onmouseenter="enter('-1647178201768949716');" onmouseout="out('-1647178201768949716');" style=""> 470         // on FW &lt; 3.0 block writes if app installation in in progress                                   </span>
<span class="-6700324623621105863" onmouseenter="enter('-6700324623621105863');" onmouseout="out('-6700324623621105863');" style=""><abbr title=" 471         if (!mIsConnected || (mPebbleProtocol.mFwMajor &lt; 3 &amp;&amp; mIsInstalling &amp;&amp; mInstallState != PebbleAppInstallState.WAIT_SLOT)) {"> 471         if (!mIsConnected || (mPebbleProtocol.mFwMajor &lt; 3 &amp;&amp; mIsInstalling &amp;&amp; mInstallState != PebbleAppðŸ”µ</abbr></span>
<span class="4043029072030362567" onmouseenter="enter('4043029072030362567');" onmouseout="out('4043029072030362567');" style=""> 472             return;                                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 473         }                                                                                                </span>
<span class="-5136181704666404560" onmouseenter="enter('-5136181704666404560');" onmouseout="out('-5136181704666404560');" style=""> 474         write_real(bytes);                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 475     }                                                                                                    </span>
<span  style=""> 476                                                                                                          </span>
<span class="3670289587241327133" onmouseenter="enter('3670289587241327133');" onmouseout="out('3670289587241327133');" style=""> 477     // FIXME: parts are supporsed to be generic code                                                     </span>
<span class="-7489026152941302055" onmouseenter="enter('-7489026152941302055');" onmouseout="out('-7489026152941302055');" style=""> 478     private boolean evaluateGBDeviceEventPebble(GBDeviceEvent deviceEvent) {                             </span>
<span  style=""> 479                                                                                                          </span>
<span class="-1739566276849801616" onmouseenter="enter('-1739566276849801616');" onmouseout="out('-1739566276849801616');" style=""> 480         if (deviceEvent instanceof GBDeviceEventVersionInfo) {                                           </span>
<span class="1668658004022497081" onmouseenter="enter('1668658004022497081');" onmouseout="out('1668658004022497081');" style=""> 481             if (prefs.getBoolean(&quot;datetime_synconconnect&quot;, true)) {                                      </span>
<span class="-3451867859378415609" onmouseenter="enter('-3451867859378415609');" onmouseout="out('-3451867859378415609');" style=""> 482                 LOG.info(&quot;syncing time&quot;);                                                                </span>
<span class="5993925069998187867" onmouseenter="enter('5993925069998187867');" onmouseout="out('5993925069998187867');" style=""> 483                 write(mPebbleProtocol.encodeSetTime());                                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 484             }                                                                                            </span>
<span class="-7386980641954546377" onmouseenter="enter('-7386980641954546377');" onmouseout="out('-7386980641954546377');" style=""> 485             write(mPebbleProtocol.encodeEnableAppLogs(prefs.getBoolean(&quot;pebble_enable_applogs&quot;, false)));</span>
<span class="-4097828168322802160" onmouseenter="enter('-4097828168322802160');" onmouseout="out('-4097828168322802160');" style=""> 486             write(mPebbleProtocol.encodeReportDataLogSessions());                                        </span>
<span class="6586859092027978564" onmouseenter="enter('6586859092027978564');" onmouseout="out('6586859092027978564');" style=""> 487             gbDevice.setState(GBDevice.State.INITIALIZED);                                               </span>
<span class="-5432226360745882584" onmouseenter="enter('-5432226360745882584');" onmouseout="out('-5432226360745882584');" style=""> 488             return false;                                                                                </span>
<span class="-4499044239010675675" onmouseenter="enter('-4499044239010675675');" onmouseout="out('-4499044239010675675');" style=""> 489         } else if (deviceEvent instanceof GBDeviceEventAppManagement) {                                  </span>
<span class="974736254576981019" onmouseenter="enter('974736254576981019');" onmouseout="out('974736254576981019');" style=""> 490             GBDeviceEventAppManagement appMgmt = (GBDeviceEventAppManagement) deviceEvent;               </span>
<span class="-8405891147776704968" onmouseenter="enter('-8405891147776704968');" onmouseout="out('-8405891147776704968');" style=""> 491             switch (appMgmt.type) {                                                                      </span>
<span class="493585282467505488" onmouseenter="enter('493585282467505488');" onmouseout="out('493585282467505488');" style=""> 492                 case DELETE:                                                                             </span>
<span class="3296704790396586230" onmouseenter="enter('3296704790396586230');" onmouseout="out('3296704790396586230');" style=""><abbr title=" 493                     // right now on the Pebble we also receive this on a failed/successful installation ;/"> 493                     // right now on the Pebble we also receive this on a failed/successful installation ;ðŸ”µ</abbr></span>
<span class="-5581198847294356355" onmouseenter="enter('-5581198847294356355');" onmouseout="out('-5581198847294356355');" style=""> 494                     switch (appMgmt.event) {                                                             </span>
<span class="6749187966539498077" onmouseenter="enter('6749187966539498077');" onmouseout="out('6749187966539498077');" style=""> 495                         case FAILURE:                                                                    </span>
<span class="-8278348814669106484" onmouseenter="enter('-8278348814669106484');" onmouseout="out('-8278348814669106484');" style=""> 496                             if (mIsInstalling) {                                                         </span>
<span class="5202677886896781243" onmouseenter="enter('5202677886896781243');" onmouseout="out('5202677886896781243');" style=""> 497                                 if (mInstallState == PebbleAppInstallState.WAIT_SLOT) {                  </span>
<span class="-3834429542028013887" onmouseenter="enter('-3834429542028013887');" onmouseout="out('-3834429542028013887');" style=""> 498                                     // get the free slot                                                 </span>
<span class="-1078532123174136932" onmouseenter="enter('-1078532123174136932');" onmouseout="out('-1078532123174136932');" style=""> 499                                     writeInstallApp(mPebbleProtocol.encodeAppInfoReq());                 </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 500                                 } else {                                                                 </span>
<span class="2061814158740359960" onmouseenter="enter('2061814158740359960');" onmouseout="out('2061814158740359960');" style=""> 501                                     finishInstall(true);                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 502                                 }                                                                        </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 503                             } else {                                                                     </span>
<span class="-3730390778602920424" onmouseenter="enter('-3730390778602920424');" onmouseout="out('-3730390778602920424');" style=""> 504                                 LOG.info(&quot;failure removing app&quot;);                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 505                             }                                                                            </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 506                             break;                                                                       </span>
<span class="3349111062118052514" onmouseenter="enter('3349111062118052514');" onmouseout="out('3349111062118052514');" style=""> 507                         case SUCCESS:                                                                    </span>
<span class="-8278348814669106484" onmouseenter="enter('-8278348814669106484');" onmouseout="out('-8278348814669106484');" style=""> 508                             if (mIsInstalling) {                                                         </span>
<span class="5202677886896781243" onmouseenter="enter('5202677886896781243');" onmouseout="out('5202677886896781243');" style=""> 509                                 if (mInstallState == PebbleAppInstallState.WAIT_SLOT) {                  </span>
<span class="-3834429542028013887" onmouseenter="enter('-3834429542028013887');" onmouseout="out('-3834429542028013887');" style=""> 510                                     // get the free slot                                                 </span>
<span class="-1078532123174136932" onmouseenter="enter('-1078532123174136932');" onmouseout="out('-1078532123174136932');" style=""> 511                                     writeInstallApp(mPebbleProtocol.encodeAppInfoReq());                 </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 512                                 } else {                                                                 </span>
<span class="8670418135173104454" onmouseenter="enter('8670418135173104454');" onmouseout="out('8670418135173104454');" style=""> 513                                     finishInstall(false);                                                </span>
<span class="5558136677444980843" onmouseenter="enter('5558136677444980843');" onmouseout="out('5558136677444980843');" style=""> 514                                     // refresh app list                                                  </span>
<span class="-6896285502301651077" onmouseenter="enter('-6896285502301651077');" onmouseout="out('-6896285502301651077');" style=""> 515                                     write(mPebbleProtocol.encodeAppInfoReq());                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 516                                 }                                                                        </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 517                             } else {                                                                     </span>
<span class="-205908887212722760" onmouseenter="enter('-205908887212722760');" onmouseout="out('-205908887212722760');" style=""> 518                                 LOG.info(&quot;successfully removed app&quot;);                                    </span>
<span class="-6896285502301651077" onmouseenter="enter('-6896285502301651077');" onmouseout="out('-6896285502301651077');" style=""> 519                                 write(mPebbleProtocol.encodeAppInfoReq());                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 520                             }                                                                            </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 521                             break;                                                                       </span>
<span class="-8178136317704390296" onmouseenter="enter('-8178136317704390296');" onmouseout="out('-8178136317704390296');" style=""> 522                         default:                                                                         </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 523                             break;                                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 524                     }                                                                                    </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 525                     break;                                                                               </span>
<span class="870820606107259995" onmouseenter="enter('870820606107259995');" onmouseout="out('870820606107259995');" style=""> 526                 case INSTALL:                                                                            </span>
<span class="-5581198847294356355" onmouseenter="enter('-5581198847294356355');" onmouseout="out('-5581198847294356355');" style=""> 527                     switch (appMgmt.event) {                                                             </span>
<span class="6749187966539498077" onmouseenter="enter('6749187966539498077');" onmouseout="out('6749187966539498077');" style=""> 528                         case FAILURE:                                                                    </span>
<span class="-7112250469089022370" onmouseenter="enter('-7112250469089022370');" onmouseout="out('-7112250469089022370');" style=""> 529                             LOG.info(&quot;failure installing app&quot;); // TODO: report to Installer             </span>
<span class="2061814158740359960" onmouseenter="enter('2061814158740359960');" onmouseout="out('2061814158740359960');" style=""> 530                             finishInstall(true);                                                         </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 531                             break;                                                                       </span>
<span class="3349111062118052514" onmouseenter="enter('3349111062118052514');" onmouseout="out('3349111062118052514');" style=""> 532                         case SUCCESS:                                                                    </span>
<span class="6209162457835083814" onmouseenter="enter('6209162457835083814');" onmouseout="out('6209162457835083814');" style=""> 533                             setToken(appMgmt.token);                                                     </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 534                             break;                                                                       </span>
<span class="6051906179244859750" onmouseenter="enter('6051906179244859750');" onmouseout="out('6051906179244859750');" style=""> 535                         case REQUEST:                                                                    </span>
<span class="2049455602208269446" onmouseenter="enter('2049455602208269446');" onmouseout="out('2049455602208269446');" style=""> 536                             LOG.info(&quot;APPFETCH request: &quot; + appMgmt.uuid + &quot; / &quot; + appMgmt.token);       </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 537                             try {                                                                        </span>
<span class="1545743734028545488" onmouseenter="enter('1545743734028545488');" onmouseout="out('1545743734028545488');" style=""><abbr title=" 538                                 installApp(Uri.fromFile(new File(FileUtils.getExternalFilesDir() + &quot;/pbw-cache/&quot; + appMgmt.uuid.toString() + &quot;.pbw&quot;)), appMgmt.token);"> 538                                 installApp(Uri.fromFile(new File(FileUtils.getExternalFilesDir() + &quot;/pbw-ðŸ”µ</abbr></span>
<span class="7080241092423381085" onmouseenter="enter('7080241092423381085');" onmouseout="out('7080241092423381085');" style=""> 539                             } catch (IOException e) {                                                    </span>
<span class="-531769948700903766" onmouseenter="enter('-531769948700903766');" onmouseout="out('-531769948700903766');" style=""> 540                                 LOG.error(&quot;Error installing app: &quot; + e.getMessage(), e);                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 541                             }                                                                            </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 542                             break;                                                                       </span>
<span class="-8178136317704390296" onmouseenter="enter('-8178136317704390296');" onmouseout="out('-8178136317704390296');" style=""> 543                         default:                                                                         </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 544                             break;                                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 545                     }                                                                                    </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 546                     break;                                                                               </span>
<span class="-2079449841199557933" onmouseenter="enter('-2079449841199557933');" onmouseout="out('-2079449841199557933');" style=""> 547                 case START:                                                                              </span>
<span class="8092140248813269968" onmouseenter="enter('8092140248813269968');" onmouseout="out('8092140248813269968');" style=""> 548                     LOG.info(&quot;got GBDeviceEventAppManagement START event for uuid: &quot; + appMgmt.uuid);    </span>
<span class="-7700571972479023893" onmouseenter="enter('-7700571972479023893');" onmouseout="out('-7700571972479023893');" style=""> 549                     WebViewSingleton.getorInitWebView(getContext(), gbDevice, appMgmt.uuid);             </span>
<span class="3757214281746876643" onmouseenter="enter('3757214281746876643');" onmouseout="out('3757214281746876643');" style=""><abbr title=" 550                     //TODO: the method call above will not work the first time as we need an activity. Either we find a way to have one here, or replace it with a local broadcast"> 550                     //TODO: the method call above will not work the first time as we need an activity. EiðŸ”µ</abbr></span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 551                     break;                                                                               </span>
<span class="-8178136317704390296" onmouseenter="enter('-8178136317704390296');" onmouseout="out('-8178136317704390296');" style=""> 552                 default:                                                                                 </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 553                     break;                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 554             }                                                                                            </span>
<span class="-3118901906653197100" onmouseenter="enter('-3118901906653197100');" onmouseout="out('-3118901906653197100');" style=""> 555             return true;                                                                                 </span>
<span class="-6358653040411049512" onmouseenter="enter('-6358653040411049512');" onmouseout="out('-6358653040411049512');" style=""> 556         } else if (deviceEvent instanceof GBDeviceEventAppInfo) {                                        </span>
<span class="3946899054861776294" onmouseenter="enter('3946899054861776294');" onmouseout="out('3946899054861776294');" style=""> 557             LOG.info(&quot;Got event for APP_INFO&quot;);                                                          </span>
<span class="1502569219724801591" onmouseenter="enter('1502569219724801591');" onmouseout="out('1502569219724801591');" style=""> 558             GBDeviceEventAppInfo appInfoEvent = (GBDeviceEventAppInfo) deviceEvent;                      </span>
<span class="-8959429837223401007" onmouseenter="enter('-8959429837223401007');" onmouseout="out('-8959429837223401007');" style=""> 559             setInstallSlot(appInfoEvent.freeSlot);                                                       </span>
<span class="-5432226360745882584" onmouseenter="enter('-5432226360745882584');" onmouseout="out('-5432226360745882584');" style=""> 560             return false;                                                                                </span>
<span class="3212296093301006379" onmouseenter="enter('3212296093301006379');" onmouseout="out('3212296093301006379');" style=""> 561         } else if (deviceEvent instanceof GBDeviceEventAppMessage) {                                     </span>
<span class="3695639456947057183" onmouseenter="enter('3695639456947057183');" onmouseout="out('3695639456947057183');" style=""> 562             sendAppMessageJS((GBDeviceEventAppMessage) deviceEvent);                                     </span>
<span class="-2519217701585576846" onmouseenter="enter('-2519217701585576846');" onmouseout="out('-2519217701585576846');" style=""> 563             if (mEnablePebblekit) {                                                                      </span>
<span class="3587206773966788552" onmouseenter="enter('3587206773966788552');" onmouseout="out('3587206773966788552');" style=""> 564                 LOG.info(&quot;Got AppMessage event&quot;);                                                        </span>
<span class="1872000704840757529" onmouseenter="enter('1872000704840757529');" onmouseout="out('1872000704840757529');" style=""> 565                 if (mPebbleKitSupport != null) {                                                         </span>
<span class="-6825766400209744371" onmouseenter="enter('-6825766400209744371');" onmouseout="out('-6825766400209744371');" style=""> 566                     mPebbleKitSupport.sendAppMessageIntent((GBDeviceEventAppMessage) deviceEvent);       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 567                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 568             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 569         }                                                                                                </span>
<span  style=""> 570                                                                                                          </span>
<span class="-5432226360745882584" onmouseenter="enter('-5432226360745882584');" onmouseout="out('-5432226360745882584');" style=""> 571         return false;                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 572     }                                                                                                    </span>
<span  style=""> 573                                                                                                          </span>
<span class="1330519925695971168" onmouseenter="enter('1330519925695971168');" onmouseout="out('1330519925695971168');" style=""> 574     private void setToken(int token) {                                                                   </span>
<span class="5683710649022739399" onmouseenter="enter('5683710649022739399');" onmouseout="out('5683710649022739399');" style=""> 575         mAppInstallToken = token;                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 576     }                                                                                                    </span>
<span  style=""> 577                                                                                                          </span>
<span class="3305301500785286694" onmouseenter="enter('3305301500785286694');" onmouseout="out('3305301500785286694');" style=""> 578     private void setInstallSlot(int slot) {                                                              </span>
<span class="-8278348814669106484" onmouseenter="enter('-8278348814669106484');" onmouseout="out('-8278348814669106484');" style=""> 579         if (mIsInstalling) {                                                                             </span>
<span class="7826340306873194751" onmouseenter="enter('7826340306873194751');" onmouseout="out('7826340306873194751');" style=""> 580             mInstallSlot = slot;                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 581         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 582     }                                                                                                    </span>
<span  style=""> 583                                                                                                          </span>
<span class="-8792508792922317323" onmouseenter="enter('-8792508792922317323');" onmouseout="out('-8792508792922317323');" style=""> 584     synchronized private void writeInstallApp(byte[] bytes) {                                            </span>
<span class="1640300515722317364" onmouseenter="enter('1640300515722317364');" onmouseout="out('1640300515722317364');" style=""> 585         if (!mIsInstalling) {                                                                            </span>
<span class="4043029072030362567" onmouseenter="enter('4043029072030362567');" onmouseout="out('4043029072030362567');" style=""> 586             return;                                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 587         }                                                                                                </span>
<span class="546783514848998195" onmouseenter="enter('546783514848998195');" onmouseout="out('546783514848998195');" style=""> 588         LOG.info(&quot;got &quot; + bytes.length + &quot;bytes for writeInstallApp()&quot;);                                 </span>
<span class="-5136181704666404560" onmouseenter="enter('-5136181704666404560');" onmouseout="out('-5136181704666404560');" style=""> 589         write_real(bytes);                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 590     }                                                                                                    </span>
<span  style=""> 591                                                                                                          </span>
<span class="-1924531441297190559" onmouseenter="enter('-1924531441297190559');" onmouseout="out('-1924531441297190559');" style=""> 592     void installApp(Uri uri, int appId) {                                                                </span>
<span class="4219320778876848093" onmouseenter="enter('4219320778876848093');" onmouseout="out('4219320778876848093');" style=""> 593         if (uri.equals(Uri.parse(&quot;fake://health&quot;))) {                                                    </span>
<span class="-4500321340045240107" onmouseenter="enter('-4500321340045240107');" onmouseout="out('-4500321340045240107');" style=""> 594             write(mPebbleProtocol.encodeActivateHealth(true));                                           </span>
<span class="-9057759845463359663" onmouseenter="enter('-9057759845463359663');" onmouseout="out('-9057759845463359663');" style=""> 595             write(mPebbleProtocol.encodeSetSaneDistanceUnit(true));                                      </span>
<span class="4043029072030362567" onmouseenter="enter('4043029072030362567');" onmouseout="out('4043029072030362567');" style=""> 596             return;                                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 597         }                                                                                                </span>
<span class="-2579506686933905796" onmouseenter="enter('-2579506686933905796');" onmouseout="out('-2579506686933905796');" style=""> 598         if (uri.equals(Uri.parse(&quot;fake://hrm&quot;))) {                                                       </span>
<span class="-8562013736932235665" onmouseenter="enter('-8562013736932235665');" onmouseout="out('-8562013736932235665');" style=""> 599             write(mPebbleProtocol.encodeActivateHRM(true));                                              </span>
<span class="4043029072030362567" onmouseenter="enter('4043029072030362567');" onmouseout="out('4043029072030362567');" style=""> 600             return;                                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 601         }                                                                                                </span>
<span class="-1212047709466619456" onmouseenter="enter('-1212047709466619456');" onmouseout="out('-1212047709466619456');" style=""> 602         if (uri.equals(Uri.parse(&quot;fake://weather&quot;))) {                                                   </span>
<span class="2684404709669173657" onmouseenter="enter('2684404709669173657');" onmouseout="out('2684404709669173657');" style=""> 603             write(mPebbleProtocol.encodeActivateWeather(true));                                          </span>
<span class="4043029072030362567" onmouseenter="enter('4043029072030362567');" onmouseout="out('4043029072030362567');" style=""> 604             return;                                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 605         }                                                                                                </span>
<span  style=""> 606                                                                                                          </span>
<span class="-8278348814669106484" onmouseenter="enter('-8278348814669106484');" onmouseout="out('-8278348814669106484');" style=""> 607         if (mIsInstalling) {                                                                             </span>
<span class="4043029072030362567" onmouseenter="enter('4043029072030362567');" onmouseout="out('4043029072030362567');" style=""> 608             return;                                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 609         }                                                                                                </span>
<span  style=""> 610                                                                                                          </span>
<span class="6375141335175677190" onmouseenter="enter('6375141335175677190');" onmouseout="out('6375141335175677190');" style=""> 611         String platformName = PebbleUtils.getPlatformName(gbDevice.getModel());                          </span>
<span  style=""> 612                                                                                                          </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 613         try {                                                                                            </span>
<span class="7221939422125416648" onmouseenter="enter('7221939422125416648');" onmouseout="out('7221939422125416648');" style=""> 614             mPBWReader = new PBWReader(uri, getContext(), platformName);                                 </span>
<span class="400908373044587289" onmouseenter="enter('400908373044587289');" onmouseout="out('400908373044587289');" style=""> 615         } catch (FileNotFoundException e) {                                                              </span>
<span class="769608185211968952" onmouseenter="enter('769608185211968952');" onmouseout="out('769608185211968952');" style=""> 616             LOG.warn(&quot;file not found: &quot; + e.getMessage(), e);                                            </span>
<span class="4043029072030362567" onmouseenter="enter('4043029072030362567');" onmouseout="out('4043029072030362567');" style=""> 617             return;                                                                                      </span>
<span class="7080241092423381085" onmouseenter="enter('7080241092423381085');" onmouseout="out('7080241092423381085');" style=""> 618         } catch (IOException e) {                                                                        </span>
<span class="8483156789856269109" onmouseenter="enter('8483156789856269109');" onmouseout="out('8483156789856269109');" style=""> 619             LOG.warn(&quot;unable to read file: &quot; + e.getMessage(), e);                                       </span>
<span class="4043029072030362567" onmouseenter="enter('4043029072030362567');" onmouseout="out('4043029072030362567');" style=""> 620             return;                                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 621         }                                                                                                </span>
<span  style=""> 622                                                                                                          </span>
<span class="-8518332035217489539" onmouseenter="enter('-8518332035217489539');" onmouseout="out('-8518332035217489539');" style=""> 623         mPebbleInstallables = mPBWReader.getPebbleInstallables();                                        </span>
<span class="5818194705482022298" onmouseenter="enter('5818194705482022298');" onmouseout="out('5818194705482022298');" style=""> 624         mCurrentInstallableIndex = 0;                                                                    </span>
<span  style=""> 625                                                                                                          </span>
<span class="1423594820264173048" onmouseenter="enter('1423594820264173048');" onmouseout="out('1423594820264173048');" style=""> 626         if (mPBWReader.isFirmware()) {                                                                   </span>
<span class="-6874615797996941970" onmouseenter="enter('-6874615797996941970');" onmouseout="out('-6874615797996941970');" style=""> 627             LOG.info(&quot;starting firmware installation&quot;);                                                  </span>
<span class="-7893027413776683580" onmouseenter="enter('-7893027413776683580');" onmouseout="out('-7893027413776683580');" style=""> 628             mIsInstalling = true;                                                                        </span>
<span class="2991380117683144492" onmouseenter="enter('2991380117683144492');" onmouseout="out('2991380117683144492');" style=""> 629             mInstallSlot = 0;                                                                            </span>
<span class="5938608831368473017" onmouseenter="enter('5938608831368473017');" onmouseout="out('5938608831368473017');" style=""> 630             writeInstallApp(mPebbleProtocol.encodeInstallFirmwareStart());                               </span>
<span class="6147346456613268497" onmouseenter="enter('6147346456613268497');" onmouseout="out('6147346456613268497');" style=""> 631             mInstallState = PebbleAppInstallState.START_INSTALL;                                         </span>
<span  style=""> 632                                                                                                          </span>
<span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style=""> 633             /*                                                                                           </span>
<span class="4272043072413570034" onmouseenter="enter('4272043072413570034');" onmouseout="out('4272043072413570034');" style=""> 634              * This is a hack for recovery mode, in which the blocking read has no timeout and the       </span>
<span class="5399824784620980403" onmouseenter="enter('5399824784620980403');" onmouseout="out('5399824784620980403');" style=""> 635              * firmware installation command does not return any ack.                                    </span>
<span class="5951082934844106568" onmouseenter="enter('5951082934844106568');" onmouseout="out('5951082934844106568');" style=""> 636              * In normal mode we would got at least out of the blocking read call after a while.         </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 637              *                                                                                           </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 638              *                                                                                           </span>
<span class="1478144735136743177" onmouseenter="enter('1478144735136743177');" onmouseout="out('1478144735136743177');" style=""> 639              * ... we should really not handle installation from thread that does the blocking read      </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 640              *                                                                                           </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 641              */                                                                                          </span>
<span class="-4151709780636609521" onmouseenter="enter('-4151709780636609521');" onmouseout="out('-4151709780636609521');" style=""> 642             writeInstallApp(mPebbleProtocol.encodeGetTime());                                            </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 643         } else {                                                                                         </span>
<span class="5609914623056246065" onmouseenter="enter('5609914623056246065');" onmouseout="out('5609914623056246065');" style=""> 644             mCurrentlyInstallingApp = mPBWReader.getGBDeviceApp();                                       </span>
<span class="-492152501567437702" onmouseenter="enter('-492152501567437702');" onmouseout="out('-492152501567437702');" style=""> 645             if (mPebbleProtocol.mFwMajor &gt;= 3 &amp;&amp; !mPBWReader.isLanguage()) {                             </span>
<span class="2714123758730002125" onmouseenter="enter('2714123758730002125');" onmouseout="out('2714123758730002125');" style=""> 646                 if (appId == 0) {                                                                        </span>
<span class="-403761314332683960" onmouseenter="enter('-403761314332683960');" onmouseout="out('-403761314332683960');" style=""> 647                     // only install metadata - not the binaries                                          </span>
<span class="4867948988198814512" onmouseenter="enter('4867948988198814512');" onmouseout="out('4867948988198814512');" style=""><abbr title=" 648                     write(mPebbleProtocol.encodeInstallMetadata(mCurrentlyInstallingApp.getUUID(), mCurrentlyInstallingApp.getName(), mPBWReader.getAppVersion(), mPBWReader.getSdkVersion(), mPBWReader.getFlags(), mPBWReader.getIconId()));"> 648                     write(mPebbleProtocol.encodeInstallMetadata(mCurrentlyInstallingApp.getUUID(), mCurreðŸ”µ</abbr></span>
<span class="-4051160554063647465" onmouseenter="enter('-4051160554063647465');" onmouseout="out('-4051160554063647465');" style=""> 649                     write(mPebbleProtocol.encodeAppStart(mCurrentlyInstallingApp.getUUID(), true));      </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 650                 } else {                                                                                 </span>
<span class="268321394733795474" onmouseenter="enter('268321394733795474');" onmouseout="out('268321394733795474');" style=""> 651                     // this came from an app fetch request, so do the real stuff                         </span>
<span class="-7893027413776683580" onmouseenter="enter('-7893027413776683580');" onmouseout="out('-7893027413776683580');" style=""> 652                     mIsInstalling = true;                                                                </span>
<span class="6866943522579684341" onmouseenter="enter('6866943522579684341');" onmouseout="out('6866943522579684341');" style=""> 653                     mInstallSlot = appId;                                                                </span>
<span class="6147346456613268497" onmouseenter="enter('6147346456613268497');" onmouseout="out('6147346456613268497');" style=""> 654                     mInstallState = PebbleAppInstallState.START_INSTALL;                                 </span>
<span  style=""> 655                                                                                                          </span>
<span class="1406564667829072525" onmouseenter="enter('1406564667829072525');" onmouseout="out('1406564667829072525');" style=""> 656                     writeInstallApp(mPebbleProtocol.encodeAppFetchAck());                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 657                 }                                                                                        </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 658             } else {                                                                                     </span>
<span class="-7893027413776683580" onmouseenter="enter('-7893027413776683580');" onmouseout="out('-7893027413776683580');" style=""> 659                 mIsInstalling = true;                                                                    </span>
<span class="7854043658495457291" onmouseenter="enter('7854043658495457291');" onmouseout="out('7854043658495457291');" style=""> 660                 if (mPBWReader.isLanguage()) {                                                           </span>
<span class="2991380117683144492" onmouseenter="enter('2991380117683144492');" onmouseout="out('2991380117683144492');" style=""> 661                     mInstallSlot = 0;                                                                    </span>
<span class="6147346456613268497" onmouseenter="enter('6147346456613268497');" onmouseout="out('6147346456613268497');" style=""> 662                     mInstallState = PebbleAppInstallState.START_INSTALL;                                 </span>
<span  style=""> 663                                                                                                          </span>
<span class="-9169766034690988699" onmouseenter="enter('-9169766034690988699');" onmouseout="out('-9169766034690988699');" style=""> 664                     // unblock HACK                                                                      </span>
<span class="-4151709780636609521" onmouseenter="enter('-4151709780636609521');" onmouseout="out('-4151709780636609521');" style=""> 665                     writeInstallApp(mPebbleProtocol.encodeGetTime());                                    </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 666                 } else {                                                                                 </span>
<span class="6749245896015366249" onmouseenter="enter('6749245896015366249');" onmouseout="out('6749245896015366249');" style=""> 667                     mInstallState = PebbleAppInstallState.WAIT_SLOT;                                     </span>
<span class="-5557276013487860944" onmouseenter="enter('-5557276013487860944');" onmouseout="out('-5557276013487860944');" style=""> 668                     writeInstallApp(mPebbleProtocol.encodeAppDelete(mCurrentlyInstallingApp.getUUID())); </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 669                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 670             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 671         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 672     }                                                                                                    </span>
<span  style=""> 673                                                                                                          </span>
<span class="-3632958031962272509" onmouseenter="enter('-3632958031962272509');" onmouseout="out('-3632958031962272509');" style=""> 674     private void finishInstall(boolean hadError) {                                                       </span>
<span class="1640300515722317364" onmouseenter="enter('1640300515722317364');" onmouseout="out('1640300515722317364');" style=""> 675         if (!mIsInstalling) {                                                                            </span>
<span class="4043029072030362567" onmouseenter="enter('4043029072030362567');" onmouseout="out('4043029072030362567');" style=""> 676             return;                                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 677         }                                                                                                </span>
<span class="7546809272471924454" onmouseenter="enter('7546809272471924454');" onmouseout="out('7546809272471924454');" style=""> 678         if (hadError) {                                                                                  </span>
<span class="1510893224061013550" onmouseenter="enter('1510893224061013550');" onmouseout="out('1510893224061013550');" style=""><abbr title=" 679             GB.updateInstallNotification(getContext().getString(R.string.installation_failed_), false, 0, getContext());"> 679             GB.updateInstallNotification(getContext().getString(R.string.installation_failed_), false, 0,ðŸ”µ</abbr></span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 680         } else {                                                                                         </span>
<span class="-1798755310811164062" onmouseenter="enter('-1798755310811164062');" onmouseout="out('-1798755310811164062');" style=""><abbr title=" 681             GB.updateInstallNotification(getContext().getString(R.string.installation_successful), false, 0, getContext());"> 681             GB.updateInstallNotification(getContext().getString(R.string.installation_successful), false,ðŸ”µ</abbr></span>
<span class="-1022673267036805326" onmouseenter="enter('-1022673267036805326');" onmouseout="out('-1022673267036805326');" style=""> 682             if (mPebbleProtocol.mFwMajor &gt;= 3) {                                                         </span>
<span class="-6972336671826040876" onmouseenter="enter('-6972336671826040876');" onmouseout="out('-6972336671826040876');" style=""> 683                 String filenameSuffix;                                                                   </span>
<span class="-4516041174588684958" onmouseenter="enter('-4516041174588684958');" onmouseout="out('-4516041174588684958');" style=""> 684                 if (mCurrentlyInstallingApp != null) {                                                   </span>
<span class="-1977040827148362152" onmouseenter="enter('-1977040827148362152');" onmouseout="out('-1977040827148362152');" style=""> 685                     if (mCurrentlyInstallingApp.getType() == GBDeviceApp.Type.WATCHFACE) {               </span>
<span class="4066163442843372701" onmouseenter="enter('4066163442843372701');" onmouseout="out('4066163442843372701');" style=""> 686                         filenameSuffix = &quot;.watchfaces&quot;;                                                  </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 687                     } else {                                                                             </span>
<span class="-1542718791393148177" onmouseenter="enter('-1542718791393148177');" onmouseout="out('-1542718791393148177');" style=""> 688                         filenameSuffix = &quot;.watchapps&quot;;                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 689                     }                                                                                    </span>
<span class="7434590360240997484" onmouseenter="enter('7434590360240997484');" onmouseout="out('7434590360240997484');" style=""><abbr title=" 690                     AppManagerActivity.addToAppOrderFile(gbDevice.getAddress() + filenameSuffix, mCurrentlyInstallingApp.getUUID());"> 690                     AppManagerActivity.addToAppOrderFile(gbDevice.getAddress() + filenameSuffix, mCurrentðŸ”µ</abbr></span>
<span class="7935209901888052732" onmouseenter="enter('7935209901888052732');" onmouseout="out('7935209901888052732');" style=""> 691                     Intent refreshIntent = new Intent(AbstractAppManagerFragment.ACTION_REFRESH_APPLIST);</span>
<span class="-1350396105067022557" onmouseenter="enter('-1350396105067022557');" onmouseout="out('-1350396105067022557');" style=""> 692                     LocalBroadcastManager.getInstance(getContext()).sendBroadcast(refreshIntent);        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 693                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 694             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 695         }                                                                                                </span>
<span class="3442713773628960689" onmouseenter="enter('3442713773628960689');" onmouseout="out('3442713773628960689');" style=""> 696         mInstallState = PebbleAppInstallState.UNKNOWN;                                                   </span>
<span  style=""> 697                                                                                                          </span>
<span class="6208081448933219418" onmouseenter="enter('6208081448933219418');" onmouseout="out('6208081448933219418');" style=""> 698         if (hadError &amp;&amp; mAppInstallToken != -1) {                                                        </span>
<span class="1039411603055838770" onmouseenter="enter('1039411603055838770');" onmouseout="out('1039411603055838770');" style=""> 699             writeInstallApp(mPebbleProtocol.encodeUploadCancel(mAppInstallToken));                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 700         }                                                                                                </span>
<span  style=""> 701                                                                                                          </span>
<span class="5124188328891976822" onmouseenter="enter('5124188328891976822');" onmouseout="out('5124188328891976822');" style=""> 702         mPBWReader = null;                                                                               </span>
<span class="1304182622527867961" onmouseenter="enter('1304182622527867961');" onmouseout="out('1304182622527867961');" style=""> 703         mIsInstalling = false;                                                                           </span>
<span class="3809401643932021573" onmouseenter="enter('3809401643932021573');" onmouseout="out('3809401643932021573');" style=""> 704         mCurrentlyInstallingApp = null;                                                                  </span>
<span  style=""> 705                                                                                                          </span>
<span class="5599892338312940306" onmouseenter="enter('5599892338312940306');" onmouseout="out('5599892338312940306');" style=""> 706         if (mFis != null) {                                                                              </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 707             try {                                                                                        </span>
<span class="5464107653723318031" onmouseenter="enter('5464107653723318031');" onmouseout="out('5464107653723318031');" style=""> 708                 mFis.close();                                                                            </span>
<span class="7080241092423381085" onmouseenter="enter('7080241092423381085');" onmouseout="out('7080241092423381085');" style=""> 709             } catch (IOException e) {                                                                    </span>
<span class="-4407835218921977391" onmouseenter="enter('-4407835218921977391');" onmouseout="out('-4407835218921977391');" style=""> 710                 // ignore                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 711             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 712         }                                                                                                </span>
<span class="6718599516057736481" onmouseenter="enter('6718599516057736481');" onmouseout="out('6718599516057736481');" style=""> 713         mFis = null;                                                                                     </span>
<span class="-556680889075439690" onmouseenter="enter('-556680889075439690');" onmouseout="out('-556680889075439690');" style=""> 714         mAppInstallToken = -1;                                                                           </span>
<span class="-4341770816803766254" onmouseenter="enter('-4341770816803766254');" onmouseout="out('-4341770816803766254');" style=""> 715         mInstallSlot = -2;                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 716     }                                                                                                    </span>
<span  style=""> 717                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 718     @Override                                                                                            </span>
<span class="-4556626830840513273" onmouseenter="enter('-4556626830840513273');" onmouseout="out('-4556626830840513273');" style=""> 719     public void quit() {                                                                                 </span>
<span class="-2245059810018305386" onmouseenter="enter('-2245059810018305386');" onmouseout="out('-2245059810018305386');" style=""> 720         mQuit = true;                                                                                    </span>
<span class="-3944229288018059276" onmouseenter="enter('-3944229288018059276');" onmouseout="out('-3944229288018059276');" style=""> 721         if (mBtSocket != null) {                                                                         </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 722             try {                                                                                        </span>
<span class="4957759683762229483" onmouseenter="enter('4957759683762229483');" onmouseout="out('4957759683762229483');" style=""> 723                 mBtSocket.close();                                                                       </span>
<span class="-8338918978083861071" onmouseenter="enter('-8338918978083861071');" onmouseout="out('-8338918978083861071');" style=""> 724             } catch (IOException ignored) {                                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 725             }                                                                                            </span>
<span class="-4534501040604870855" onmouseenter="enter('-4534501040604870855');" onmouseout="out('-4534501040604870855');" style=""> 726             mBtSocket = null;                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 727         }                                                                                                </span>
<span class="3388558050890258608" onmouseenter="enter('3388558050890258608');" onmouseout="out('3388558050890258608');" style=""> 728         if (mTCPSocket != null) {                                                                        </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 729             try {                                                                                        </span>
<span class="1317722495006749576" onmouseenter="enter('1317722495006749576');" onmouseout="out('1317722495006749576');" style=""> 730                 mTCPSocket.close();                                                                      </span>
<span class="-8338918978083861071" onmouseenter="enter('-8338918978083861071');" onmouseout="out('-8338918978083861071');" style=""> 731             } catch (IOException ignored) {                                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 732             }                                                                                            </span>
<span class="4396162940795265492" onmouseenter="enter('4396162940795265492');" onmouseout="out('4396162940795265492');" style=""> 733             mTCPSocket = null;                                                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 734         }                                                                                                </span>
<span class="-5320890524666996917" onmouseenter="enter('-5320890524666996917');" onmouseout="out('-5320890524666996917');" style=""> 735         if (mPebbleLESupport != null) {                                                                  </span>
<span class="-997532962857791838" onmouseenter="enter('-997532962857791838');" onmouseout="out('-997532962857791838');" style=""> 736             mPebbleLESupport.close();                                                                    </span>
<span class="-2496993078705938002" onmouseenter="enter('-2496993078705938002');" onmouseout="out('-2496993078705938002');" style=""> 737             mPebbleLESupport = null;                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 738         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 739     }                                                                                                    </span>
<span  style=""> 740                                                                                                          </span>
<span class="-4681179840421673206" onmouseenter="enter('-4681179840421673206');" onmouseout="out('-4681179840421673206');" style=""> 741     private enum PebbleAppInstallState {                                                                 </span>
<span class="8504698099528295248" onmouseenter="enter('8504698099528295248');" onmouseout="out('8504698099528295248');" style=""> 742         UNKNOWN,                                                                                         </span>
<span class="-8062507015798429311" onmouseenter="enter('-8062507015798429311');" onmouseout="out('-8062507015798429311');" style=""> 743         WAIT_SLOT,                                                                                       </span>
<span class="-668951604036061853" onmouseenter="enter('-668951604036061853');" onmouseout="out('-668951604036061853');" style=""> 744         START_INSTALL,                                                                                   </span>
<span class="-1678353837526561027" onmouseenter="enter('-1678353837526561027');" onmouseout="out('-1678353837526561027');" style=""> 745         WAIT_TOKEN,                                                                                      </span>
<span class="-2676567537573092080" onmouseenter="enter('-2676567537573092080');" onmouseout="out('-2676567537573092080');" style=""> 746         UPLOAD_CHUNK,                                                                                    </span>
<span class="-1008243733279055296" onmouseenter="enter('-1008243733279055296');" onmouseout="out('-1008243733279055296');" style=""> 747         UPLOAD_COMMIT,                                                                                   </span>
<span class="-8287073352459983195" onmouseenter="enter('-8287073352459983195');" onmouseout="out('-8287073352459983195');" style=""> 748         WAIT_COMMIT,                                                                                     </span>
<span class="-4008830795114372846" onmouseenter="enter('-4008830795114372846');" onmouseout="out('-4008830795114372846');" style=""> 749         UPLOAD_COMPLETE,                                                                                 </span>
<span class="667328612202802083" onmouseenter="enter('667328612202802083');" onmouseout="out('667328612202802083');" style=""> 750         APP_REFRESH,                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 751     }                                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 752 }                                                                                                        </span>







































































</pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre><span class="-5771549642386131488" onmouseenter="enter('-5771549642386131488');" onmouseout="out('-5771549642386131488');" style="">   1  package nodomain.freeyourgadget.gadgetbridge.service.devices.pebble;                                              </span>
<span  style="">   2                                                                                                                    </span>
<span class="-8028506601233233593" onmouseenter="enter('-8028506601233233593');" onmouseout="out('-8028506601233233593');" style="">   3  import android.bluetooth.BluetoothAdapter;                                                                        </span>
<span class="2859895893394018468" onmouseenter="enter('2859895893394018468');" onmouseout="out('2859895893394018468');" style="">   4  import android.bluetooth.BluetoothDevice;                                                                         </span>
<span class="634810844753697830" onmouseenter="enter('634810844753697830');" onmouseout="out('634810844753697830');" style="">   5  import android.bluetooth.BluetoothSocket;                                                                         </span>
<span class="-489389385851058391" onmouseenter="enter('-489389385851058391');" onmouseout="out('-489389385851058391');" style="">   6  import android.content.BroadcastReceiver;                                                                         </span>
<span class="5922045460006936195" onmouseenter="enter('5922045460006936195');" onmouseout="out('5922045460006936195');" style="">   7  import android.content.Context;                                                                                   </span>
<span class="6568903789857736568" onmouseenter="enter('6568903789857736568');" onmouseout="out('6568903789857736568');" style="">   8  import android.content.Intent;                                                                                    </span>
<span class="8697221465021235869" onmouseenter="enter('8697221465021235869');" onmouseout="out('8697221465021235869');" style="">   9  import android.content.IntentFilter;                                                                              </span>
<span class="-8750621697125156872" onmouseenter="enter('-8750621697125156872');" onmouseout="out('-8750621697125156872');" style="">  10  import android.net.Uri;                                                                                           </span>
<span class="8301908088148850736" onmouseenter="enter('8301908088148850736');" onmouseout="out('8301908088148850736');" style="">  11  import android.os.ParcelUuid;                                                                                     </span>
<span class="2517521963771876570" onmouseenter="enter('2517521963771876570');" onmouseout="out('2517521963771876570');" style="">  12  import android.support.v4.content.LocalBroadcastManager;                                                          </span>
<span  style="">  13                                                                                                                    </span>
<span class="-9193129351684262878" onmouseenter="enter('-9193129351684262878');" onmouseout="out('-9193129351684262878');" style="">  14  import org.json.JSONArray;                                                                                        </span>
<span class="-8573375701834280359" onmouseenter="enter('-8573375701834280359');" onmouseout="out('-8573375701834280359');" style="">  15  import org.json.JSONException;                                                                                    </span>
<span class="9072327285961251154" onmouseenter="enter('9072327285961251154');" onmouseout="out('9072327285961251154');" style="">  16  import org.slf4j.Logger;                                                                                          </span>
<span class="697043352225962606" onmouseenter="enter('697043352225962606');" onmouseout="out('697043352225962606');" style="">  17  import org.slf4j.LoggerFactory;                                                                                   </span>
<span  style="">  18                                                                                                                    </span>
<span class="-3926401431737521278" onmouseenter="enter('-3926401431737521278');" onmouseout="out('-3926401431737521278');" style="">  19  import java.io.File;                                                                                              </span>
<span class="-75475733228177869" onmouseenter="enter('-75475733228177869');" onmouseout="out('-75475733228177869');" style="">  20  import java.io.FileNotFoundException;                                                                             </span>
<span class="103340661636203254" onmouseenter="enter('103340661636203254');" onmouseout="out('103340661636203254');" style="">  21  import java.io.IOException;                                                                                       </span>
<span class="5631563232245871054" onmouseenter="enter('5631563232245871054');" onmouseout="out('5631563232245871054');" style="">  22  import java.io.InputStream;                                                                                       </span>
<span class="4621164050749610193" onmouseenter="enter('4621164050749610193');" onmouseout="out('4621164050749610193');" style="">  23  import java.io.OutputStream;                                                                                      </span>
<span class="-4777627942089262832" onmouseenter="enter('-4777627942089262832');" onmouseout="out('-4777627942089262832');" style="">  24  import java.io.PipedInputStream;                                                                                  </span>
<span class="5026237307424376420" onmouseenter="enter('5026237307424376420');" onmouseout="out('5026237307424376420');" style="">  25  import java.io.PipedOutputStream;                                                                                 </span>
<span class="-5790770097715703577" onmouseenter="enter('-5790770097715703577');" onmouseout="out('-5790770097715703577');" style="">  26  import java.net.InetAddress;                                                                                      </span>
<span class="-623186069646925252" onmouseenter="enter('-623186069646925252');" onmouseout="out('-623186069646925252');" style="">  27  import java.net.Socket;                                                                                           </span>
<span class="-6886346622632588502" onmouseenter="enter('-6886346622632588502');" onmouseout="out('-6886346622632588502');" style="">  28  import java.nio.ByteBuffer;                                                                                       </span>
<span class="-4536046119683402321" onmouseenter="enter('-4536046119683402321');" onmouseout="out('-4536046119683402321');" style="">  29  import java.nio.ByteOrder;                                                                                        </span>
<span class="2390503830490498598" onmouseenter="enter('2390503830490498598');" onmouseout="out('2390503830490498598');" style="">  30  import java.util.UUID;                                                                                            </span>
<span  style="">  31                                                                                                                    </span>
<span class="-8113221927992302576" onmouseenter="enter('-8113221927992302576');" onmouseout="out('-8113221927992302576');" style="">  32  import nodomain.freeyourgadget.gadgetbridge.GBApplication;                                                        </span>
<span class="-7198279398549834921" onmouseenter="enter('-7198279398549834921');" onmouseout="out('-7198279398549834921');" style="">  33  import nodomain.freeyourgadget.gadgetbridge.R;                                                                    </span>
<span class="5959948573825064529" onmouseenter="enter('5959948573825064529');" onmouseout="out('5959948573825064529');" style="">  34  import nodomain.freeyourgadget.gadgetbridge.activities.appmanager.AbstractAppManagerFragment;                     </span>
<span class="-7454882487459214858" onmouseenter="enter('-7454882487459214858');" onmouseout="out('-7454882487459214858');" style="">  35  import nodomain.freeyourgadget.gadgetbridge.activities.appmanager.AppManagerActivity;                             </span>
<span class="8774236294555479386" onmouseenter="enter('8774236294555479386');" onmouseout="out('8774236294555479386');" style="">  36  import nodomain.freeyourgadget.gadgetbridge.deviceevents.GBDeviceEvent;                                           </span>
<span class="-4700446920707564194" onmouseenter="enter('-4700446920707564194');" onmouseout="out('-4700446920707564194');" style="">  37  import nodomain.freeyourgadget.gadgetbridge.deviceevents.GBDeviceEventAppInfo;                                    </span>
<span class="-5686102242644058946" onmouseenter="enter('-5686102242644058946');" onmouseout="out('-5686102242644058946');" style="">  38  import nodomain.freeyourgadget.gadgetbridge.deviceevents.GBDeviceEventAppManagement;                              </span>
<span class="2791890994602016761" onmouseenter="enter('2791890994602016761');" onmouseout="out('2791890994602016761');" style="">  39  import nodomain.freeyourgadget.gadgetbridge.deviceevents.GBDeviceEventAppMessage;                                 </span>
<span class="7456778970616733409" onmouseenter="enter('7456778970616733409');" onmouseout="out('7456778970616733409');" style="">  40  import nodomain.freeyourgadget.gadgetbridge.deviceevents.GBDeviceEventVersionInfo;                                </span>
<span class="-8786909529118259831" onmouseenter="enter('-8786909529118259831');" onmouseout="out('-8786909529118259831');" style="">  41  import nodomain.freeyourgadget.gadgetbridge.devices.pebble.PBWReader;                                             </span>
<span class="-6745962823678362300" onmouseenter="enter('-6745962823678362300');" onmouseout="out('-6745962823678362300');" style="">  42  import nodomain.freeyourgadget.gadgetbridge.devices.pebble.PebbleInstallable;                                     </span>
<span class="4836892992022606579" onmouseenter="enter('4836892992022606579');" onmouseout="out('4836892992022606579');" style="">  43  import nodomain.freeyourgadget.gadgetbridge.impl.GBDevice;                                                        </span>
<span class="-6775704228596592306" onmouseenter="enter('-6775704228596592306');" onmouseout="out('-6775704228596592306');" style="">  44  import nodomain.freeyourgadget.gadgetbridge.impl.GBDeviceApp;                                                     </span>
<span class="-1754164907108633436" onmouseenter="enter('-1754164907108633436');" onmouseout="out('-1754164907108633436');" style="">  45  import nodomain.freeyourgadget.gadgetbridge.service.devices.pebble.ble.PebbleLESupport;                           </span>
<span class="-211901022449891328" onmouseenter="enter('-211901022449891328');" onmouseout="out('-211901022449891328');" style="">  46  import nodomain.freeyourgadget.gadgetbridge.service.serial.GBDeviceIoThread;                                      </span>
<span class="-2195471833159259314" onmouseenter="enter('-2195471833159259314');" onmouseout="out('-2195471833159259314');" style="">  47  import nodomain.freeyourgadget.gadgetbridge.service.serial.GBDeviceProtocol;                                      </span>
<span class="-2020231768395052380" onmouseenter="enter('-2020231768395052380');" onmouseout="out('-2020231768395052380');" style="">  48  import nodomain.freeyourgadget.gadgetbridge.util.FileUtils;                                                       </span>
<span class="-3798970344596478499" onmouseenter="enter('-3798970344596478499');" onmouseout="out('-3798970344596478499');" style="">  49  import nodomain.freeyourgadget.gadgetbridge.util.GB;                                                              </span>
<span class="4645284583739884744" onmouseenter="enter('4645284583739884744');" onmouseout="out('4645284583739884744');" style="">  50  import nodomain.freeyourgadget.gadgetbridge.util.PebbleUtils;                                                     </span>
<span class="-600862318521663319" onmouseenter="enter('-600862318521663319');" onmouseout="out('-600862318521663319');" style="">  51  import nodomain.freeyourgadget.gadgetbridge.util.Prefs;                                                           </span>
<span class="-425744571032727695" onmouseenter="enter('-425744571032727695');" onmouseout="out('-425744571032727695');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  52 +import nodomain.freeyourgadget.gadgetbridge.util.WebViewSingleton;                                                </span>
<span  style="">  53                                                                                                                    </span>
<span class="2468896418036970449" onmouseenter="enter('2468896418036970449');" onmouseout="out('2468896418036970449');" style="">  54  class PebbleIoThread extends GBDeviceIoThread {                                                                   </span>
<span class="2529670288626938632" onmouseenter="enter('2529670288626938632');" onmouseout="out('2529670288626938632');" style="">  55      private static final Logger LOG = LoggerFactory.getLogger(PebbleIoThread.class);                              </span>
<span  style="">  56                                                                                                                    </span>
<span class="1479268761712237268" onmouseenter="enter('1479268761712237268');" onmouseout="out('1479268761712237268');" style="">  57      public static final String PEBBLEKIT_ACTION_PEBBLE_CONNECTED = &quot;com.getpebble.action.PEBBLE_CONNECTED&quot;;       </span>
<span class="-8930340505705554172" onmouseenter="enter('-8930340505705554172');" onmouseout="out('-8930340505705554172');" style="">  58      public static final String PEBBLEKIT_ACTION_PEBBLE_DISCONNECTED = &quot;com.getpebble.action.PEBBLE_DISCONNECTED&quot;; </span>
<span class="-590329691308595480" onmouseenter="enter('-590329691308595480');" onmouseout="out('-590329691308595480');" style="">  59      public static final String PEBBLEKIT_ACTION_APP_ACK = &quot;com.getpebble.action.app.ACK&quot;;                         </span>
<span class="-4316471762220819117" onmouseenter="enter('-4316471762220819117');" onmouseout="out('-4316471762220819117');" style="">  60      public static final String PEBBLEKIT_ACTION_APP_NACK = &quot;com.getpebble.action.app.NACK&quot;;                       </span>
<span class="-515673483701715475" onmouseenter="enter('-515673483701715475');" onmouseout="out('-515673483701715475');" style="">  61      public static final String PEBBLEKIT_ACTION_APP_RECEIVE = &quot;com.getpebble.action.app.RECEIVE&quot;;                 </span>
<span class="7680988297485466728" onmouseenter="enter('7680988297485466728');" onmouseout="out('7680988297485466728');" style="">  62      public static final String PEBBLEKIT_ACTION_APP_RECEIVE_ACK = &quot;com.getpebble.action.app.RECEIVE_ACK&quot;;         </span>
<span class="-5341535895791433959" onmouseenter="enter('-5341535895791433959');" onmouseout="out('-5341535895791433959');" style="">  63      public static final String PEBBLEKIT_ACTION_APP_RECEIVE_NACK = &quot;com.getpebble.action.app.RECEIVE_NACK&quot;;       </span>
<span class="-5791901289448816338" onmouseenter="enter('-5791901289448816338');" onmouseout="out('-5791901289448816338');" style="">  64      public static final String PEBBLEKIT_ACTION_APP_SEND = &quot;com.getpebble.action.app.SEND&quot;;                       </span>
<span class="-578296603915012056" onmouseenter="enter('-578296603915012056');" onmouseout="out('-578296603915012056');" style="">  65      public static final String PEBBLEKIT_ACTION_APP_START = &quot;com.getpebble.action.app.START&quot;;                     </span>
<span class="118647857632734400" onmouseenter="enter('118647857632734400');" onmouseout="out('118647857632734400');" style="">  66      public static final String PEBBLEKIT_ACTION_APP_STOP = &quot;com.getpebble.action.app.STOP&quot;;                       </span>
<span  style="">  67                                                                                                                    </span>
<span class="-4632193205469069671" onmouseenter="enter('-4632193205469069671');" onmouseout="out('-4632193205469069671');" style="">  68      private final Prefs prefs = GBApplication.getPrefs();                                                         </span>
<span  style="">  69                                                                                                                    </span>
<span class="-6631401332787692352" onmouseenter="enter('-6631401332787692352');" onmouseout="out('-6631401332787692352');" style="">  70      private final PebbleProtocol mPebbleProtocol;                                                                 </span>
<span class="1328262475374241602" onmouseenter="enter('1328262475374241602');" onmouseout="out('1328262475374241602');" style="">  71      private final PebbleSupport mPebbleSupport;                                                                   </span>

<span class="5255281464364524557" onmouseenter="enter('5255281464364524557');" onmouseout="out('5255281464364524557');" style="">  72      private final boolean mEnablePebblekit;                                                                       </span>
<span  style="">  73                                                                                                                    </span>
<span class="-1663504808667212623" onmouseenter="enter('-1663504808667212623');" onmouseout="out('-1663504808667212623');" style="">  74      private boolean mIsTCP = false;                                                                               </span>
<span class="7891956114489637668" onmouseenter="enter('7891956114489637668');" onmouseout="out('7891956114489637668');" style="">  75      private BluetoothAdapter mBtAdapter = null;                                                                   </span>
<span class="-3474230100367526093" onmouseenter="enter('-3474230100367526093');" onmouseout="out('-3474230100367526093');" style="">  76      private BluetoothSocket mBtSocket = null;                                                                     </span>
<span class="4972621324459114153" onmouseenter="enter('4972621324459114153');" onmouseout="out('4972621324459114153');" style="">  77      private Socket mTCPSocket = null; // for emulator                                                             </span>
<span class="8464954913827308931" onmouseenter="enter('8464954913827308931');" onmouseout="out('8464954913827308931');" style="">  78      private InputStream mInStream = null;                                                                         </span>
<span class="176817746371882191" onmouseenter="enter('176817746371882191');" onmouseout="out('176817746371882191');" style="">  79      private OutputStream mOutStream = null;                                                                       </span>
<span class="3507668063671934062" onmouseenter="enter('3507668063671934062');" onmouseout="out('3507668063671934062');" style="">  80      private PebbleLESupport mPebbleLESupport;                                                                     </span>
<span  style="">  81                                                                                                                    </span>
<span class="8291227991234502986" onmouseenter="enter('8291227991234502986');" onmouseout="out('8291227991234502986');" style="">  82      private boolean mQuit = false;                                                                                </span>
<span class="-4308649044970502514" onmouseenter="enter('-4308649044970502514');" onmouseout="out('-4308649044970502514');" style="">  83      private boolean mIsConnected = false;                                                                         </span>
<span class="591172670703241498" onmouseenter="enter('591172670703241498');" onmouseout="out('591172670703241498');" style="">  84      private boolean mIsInstalling = false;                                                                        </span>
<span  style="">  85                                                                                                                    </span>
<span class="7746276727914849634" onmouseenter="enter('7746276727914849634');" onmouseout="out('7746276727914849634');" style="">  86      private PBWReader mPBWReader = null;                                                                          </span>
<span class="1166586313023966318" onmouseenter="enter('1166586313023966318');" onmouseout="out('1166586313023966318');" style="">  87      private GBDeviceApp mCurrentlyInstallingApp = null;                                                           </span>
<span class="-1645742411754742536" onmouseenter="enter('-1645742411754742536');" onmouseout="out('-1645742411754742536');" style="">  88      private int mAppInstallToken = -1;                                                                            </span>
<span class="-3680441812231545667" onmouseenter="enter('-3680441812231545667');" onmouseout="out('-3680441812231545667');" style="">  89      private InputStream mFis = null;                                                                              </span>
<span class="8056811120544011853" onmouseenter="enter('8056811120544011853');" onmouseout="out('8056811120544011853');" style="">  90      private PebbleAppInstallState mInstallState = PebbleAppInstallState.UNKNOWN;                                  </span>
<span class="2315852437300231853" onmouseenter="enter('2315852437300231853');" onmouseout="out('2315852437300231853');" style="">  91      private PebbleInstallable[] mPebbleInstallables = null;                                                       </span>
<span class="-6610002799635202363" onmouseenter="enter('-6610002799635202363');" onmouseout="out('-6610002799635202363');" style="">  92      private int mCurrentInstallableIndex = -1;                                                                    </span>
<span class="-6569382683370215618" onmouseenter="enter('-6569382683370215618');" onmouseout="out('-6569382683370215618');" style="">  93      private int mInstallSlot = -2;                                                                                </span>
<span class="-8194648222476538160" onmouseenter="enter('-8194648222476538160');" onmouseout="out('-8194648222476538160');" style="">  94      private int mCRC = -1;                                                                                        </span>
<span class="-2481332028036817904" onmouseenter="enter('-2481332028036817904');" onmouseout="out('-2481332028036817904');" style="">  95      private int mBinarySize = -1;                                                                                 </span>
<span class="-1832879895999614218" onmouseenter="enter('-1832879895999614218');" onmouseout="out('-1832879895999614218');" style="">  96      private int mBytesWritten = -1;                                                                               </span>
<span  style="">  97                                                                                                                    </span>
<span class="8914325663092470246" onmouseenter="enter('8914325663092470246');" onmouseout="out('8914325663092470246');" style="">  98      private final BroadcastReceiver mPebbleKitReceiver = new BroadcastReceiver() {                                </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style="">  99          @Override                                                                                                 </span>
<span class="-1520739091809898546" onmouseenter="enter('-1520739091809898546');" onmouseout="out('-1520739091809898546');" style=""> 100          public void onReceive(Context context, Intent intent) {                                                   </span>
<span class="5344227773413700857" onmouseenter="enter('5344227773413700857');" onmouseout="out('5344227773413700857');" style=""> 101              String action = intent.getAction();                                                                   </span>
<span class="-2767557360944414006" onmouseenter="enter('-2767557360944414006');" onmouseout="out('-2767557360944414006');" style=""> 102              LOG.info(&quot;Got action: &quot; + action);                                                                    </span>
<span class="8190723481817549581" onmouseenter="enter('8190723481817549581');" onmouseout="out('8190723481817549581');" style=""> 103              UUID uuid;                                                                                            </span>
<span class="6099627150369302694" onmouseenter="enter('6099627150369302694');" onmouseout="out('6099627150369302694');" style=""> 104              switch (action) {                                                                                     </span>
<span class="-5607690174400779115" onmouseenter="enter('-5607690174400779115');" onmouseout="out('-5607690174400779115');" style=""> 105                  case PEBBLEKIT_ACTION_APP_START:                                                                  </span>
<span class="-1756369772806174160" onmouseenter="enter('-1756369772806174160');" onmouseout="out('-1756369772806174160');" style=""> 106                  case PEBBLEKIT_ACTION_APP_STOP:                                                                   </span>
<span class="-185467528302823505" onmouseenter="enter('-185467528302823505');" onmouseout="out('-185467528302823505');" style=""> 107                      uuid = (UUID) intent.getSerializableExtra(&quot;uuid&quot;);                                            </span>
<span class="6094803455832882033" onmouseenter="enter('6094803455832882033');" onmouseout="out('6094803455832882033');" style=""> 108                      if (uuid != null) {                                                                           </span>
<span class="-3038014536715207103" onmouseenter="enter('-3038014536715207103');" onmouseout="out('-3038014536715207103');" style=""> 109                          write(mPebbleProtocol.encodeAppStart(uuid, action.equals(PEBBLEKIT_ACTION_APP_START)));   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 110                      }                                                                                             </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 111                      break;                                                                                        </span>
<span class="3550381777945223205" onmouseenter="enter('3550381777945223205');" onmouseout="out('3550381777945223205');" style=""> 112                  case PEBBLEKIT_ACTION_APP_SEND:                                                                   </span>
<span class="8746871362101842242" onmouseenter="enter('8746871362101842242');" onmouseout="out('8746871362101842242');" style=""> 113                      int transaction_id = intent.getIntExtra(&quot;transaction_id&quot;, -1);                                </span>
<span class="-185467528302823505" onmouseenter="enter('-185467528302823505');" onmouseout="out('-185467528302823505');" style=""> 114                      uuid = (UUID) intent.getSerializableExtra(&quot;uuid&quot;);                                            </span>
<span class="115505315270435118" onmouseenter="enter('115505315270435118');" onmouseout="out('115505315270435118');" style=""> 115                      String jsonString = intent.getStringExtra(&quot;msg_data&quot;);                                        </span>
<span class="1347360621013773363" onmouseenter="enter('1347360621013773363');" onmouseout="out('1347360621013773363');" style=""> 116                      LOG.info(&quot;json string: &quot; + jsonString);                                                       </span>
<span  style=""> 117                                                                                                                    </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 118                      try {                                                                                         </span>
<span class="6685187839340796030" onmouseenter="enter('6685187839340796030');" onmouseout="out('6685187839340796030');" style=""> 119                          JSONArray jsonArray = new JSONArray(jsonString);                                          </span>
<span class="1915657714539023329" onmouseenter="enter('1915657714539023329');" onmouseout="out('1915657714539023329');" style=""> 120                          write(mPebbleProtocol.encodeApplicationMessageFromJSON(uuid, jsonArray));                 </span>
<span class="4286948008967663548" onmouseenter="enter('4286948008967663548');" onmouseout="out('4286948008967663548');" style=""> 121                          sendAppMessageAck(transaction_id);                                                        </span>
<span  style=""> 122                                                                                                                    </span>
<span class="2021063483207698984" onmouseenter="enter('2021063483207698984');" onmouseout="out('2021063483207698984');" style=""> 123                      } catch (JSONException e) {                                                                   </span>
<span class="4090663313211582937" onmouseenter="enter('4090663313211582937');" onmouseout="out('4090663313211582937');" style=""> 124                          e.printStackTrace();                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 125                      }                                                                                             </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 126                      break;                                                                                        </span>
<span class="-4575626246346919371" onmouseenter="enter('-4575626246346919371');" onmouseout="out('-4575626246346919371');" style=""> 127                  case PEBBLEKIT_ACTION_APP_ACK:                                                                    </span>
<span class="-5397546053733935151" onmouseenter="enter('-5397546053733935151');" onmouseout="out('-5397546053733935151');" style=""><abbr title=" 128                      // we do not get a uuid and cannot map a transaction id to it, so we ack in PebbleProtocol early"> 128                      // we do not get a uuid and cannot map a transaction id to it, so we ack in PebbleProtocol earðŸ”µ</abbr></span>
<span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style=""> 129                      /*                                                                                            </span>
<span class="-185467528302823505" onmouseenter="enter('-185467528302823505');" onmouseout="out('-185467528302823505');" style=""> 130                      uuid = (UUID) intent.getSerializableExtra(&quot;uuid&quot;);                                            </span>
<span class="8746871362101842242" onmouseenter="enter('8746871362101842242');" onmouseout="out('8746871362101842242');" style=""> 131                      int transaction_id = intent.getIntExtra(&quot;transaction_id&quot;, -1);                                </span>
<span class="-5460339056046386879" onmouseenter="enter('-5460339056046386879');" onmouseout="out('-5460339056046386879');" style=""> 132                      if (transaction_id &gt;= 0 &amp;&amp; transaction_id &lt;= 255) {                                           </span>
<span class="-1247931610264669179" onmouseenter="enter('-1247931610264669179');" onmouseout="out('-1247931610264669179');" style=""> 133                          write(mPebbleProtocol.encodeApplicationMessageAck(uuid, (byte) transaction_id));          </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 134                      } else {                                                                                      </span>
<span class="9187855197608677341" onmouseenter="enter('9187855197608677341');" onmouseout="out('9187855197608677341');" style=""> 135                          LOG.warn(&quot;illegal transacktion id &quot; + transaction_id);                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 136                      }                                                                                             </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 137                      */                                                                                            </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 138                      break;                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 139              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 140          }                                                                                                         </span>
<span class="2468309323999483380" onmouseenter="enter('2468309323999483380');" onmouseout="out('2468309323999483380');" style=""> 141      };                                                                                                            </span>
<span  style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 142 +                                                                                                                  </span>
<span class="-8000809992863847428" onmouseenter="enter('-8000809992863847428');" onmouseout="out('-8000809992863847428');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 143 +    private void sendAppMessageJS(GBDeviceEventAppMessage appMessage) {                                           </span>
<span class="5061350280559930277" onmouseenter="enter('5061350280559930277');" onmouseout="out('5061350280559930277');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 144 +        WebViewSingleton.getorInitWebView(getContext(), gbDevice, appMessage.appUUID);                            </span>
<span class="-2478103463940331708" onmouseenter="enter('-2478103463940331708');" onmouseout="out('-2478103463940331708');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 145 +        WebViewSingleton.appMessage(appMessage.message);                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 146 +    }                                                                                                             </span>
<span  style=""> 147                                                                                                                    </span>
<span class="-7621847952583919612" onmouseenter="enter('-7621847952583919612');" onmouseout="out('-7621847952583919612');" style=""> 148      private void sendAppMessageIntent(GBDeviceEventAppMessage appMessage) {                                       </span>
<span class="535862575394010177" onmouseenter="enter('535862575394010177');" onmouseout="out('535862575394010177');" style=""> 149          Intent intent = new Intent();                                                                             </span>
<span class="-308940498243775713" onmouseenter="enter('-308940498243775713');" onmouseout="out('-308940498243775713');" style=""> 150          intent.setAction(PEBBLEKIT_ACTION_APP_RECEIVE);                                                           </span>
<span class="-4819521277987879596" onmouseenter="enter('-4819521277987879596');" onmouseout="out('-4819521277987879596');" style=""> 151          intent.putExtra(&quot;uuid&quot;, appMessage.appUUID);                                                              </span>
<span class="-4518626450248788495" onmouseenter="enter('-4518626450248788495');" onmouseout="out('-4518626450248788495');" style=""> 152          intent.putExtra(&quot;msg_data&quot;, appMessage.message);                                                          </span>
<span class="788400804283391840" onmouseenter="enter('788400804283391840');" onmouseout="out('788400804283391840');" style=""> 153          intent.putExtra(&quot;transaction_id&quot;, appMessage.id);                                                         </span>
<span class="-877666395707968466" onmouseenter="enter('-877666395707968466');" onmouseout="out('-877666395707968466');" style=""><abbr title=" 154          LOG.info(&quot;broadcasting to uuid &quot; + appMessage.appUUID + &quot; transaction id: &quot; + appMessage.id + &quot; JSON: &quot; + appMessage.message);"> 154          LOG.info(&quot;broadcasting to uuid &quot; + appMessage.appUUID + &quot; transaction id: &quot; + appMessage.id + &quot; JSON: &quot; + ðŸ”µ</abbr></span>
<span class="5781834444291540387" onmouseenter="enter('5781834444291540387');" onmouseout="out('5781834444291540387');" style=""> 155          getContext().sendBroadcast(intent);                                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 156      }                                                                                                             </span>
<span  style=""> 157                                                                                                                    </span>
<span class="-1707422926868996417" onmouseenter="enter('-1707422926868996417');" onmouseout="out('-1707422926868996417');" style=""><abbr title=" 158      PebbleIoThread(PebbleSupport pebbleSupport, GBDevice gbDevice, GBDeviceProtocol gbDeviceProtocol, BluetoothAdapter btAdapter, Context context) {"> 158      PebbleIoThread(PebbleSupport pebbleSupport, GBDevice gbDevice, GBDeviceProtocol gbDeviceProtocol, BluetoothAdaðŸ”µ</abbr></span>
<span class="-4446577987516131269" onmouseenter="enter('-4446577987516131269');" onmouseout="out('-4446577987516131269');" style=""> 159          super(gbDevice, context);                                                                                 </span>
<span class="-535847603056830094" onmouseenter="enter('-535847603056830094');" onmouseout="out('-535847603056830094');" style=""> 160          mPebbleProtocol = (PebbleProtocol) gbDeviceProtocol;                                                      </span>
<span class="-7802515276203668031" onmouseenter="enter('-7802515276203668031');" onmouseout="out('-7802515276203668031');" style=""> 161          mBtAdapter = btAdapter;                                                                                   </span>
<span class="-175348863880720182" onmouseenter="enter('-175348863880720182');" onmouseout="out('-175348863880720182');" style=""> 162          mPebbleSupport = pebbleSupport;                                                                           </span>
<span class="-766654887411083682" onmouseenter="enter('-766654887411083682');" onmouseout="out('-766654887411083682');" style=""> 163          mEnablePebblekit = prefs.getBoolean(&quot;pebble_enable_pebblekit&quot;, false);                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 164      }                                                                                                             </span>
<span  style=""> 165                                                                                                                    </span>
<span class="-2292081679562824726" onmouseenter="enter('-2292081679562824726');" onmouseout="out('-2292081679562824726');" style=""><abbr title=" 166      private int readWithException(InputStream inputStream, byte[] buffer, int byteOffset, int byteCount) throws IOException {"> 166      private int readWithException(InputStream inputStream, byte[] buffer, int byteOffset, int byteCount) throws IOðŸ”µ</abbr></span>
<span class="4268945675950741459" onmouseenter="enter('4268945675950741459');" onmouseout="out('4268945675950741459');" style=""> 167          int ret = inputStream.read(buffer, byteOffset, byteCount);                                                </span>
<span class="3796083344931271004" onmouseenter="enter('3796083344931271004');" onmouseout="out('3796083344931271004');" style=""> 168          if (ret == -1) {                                                                                          </span>
<span class="8493867222528380496" onmouseenter="enter('8493867222528380496');" onmouseout="out('8493867222528380496');" style=""> 169              throw new IOException(&quot;broken pipe&quot;);                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 170          }                                                                                                         </span>
<span class="1456633081770441725" onmouseenter="enter('1456633081770441725');" onmouseout="out('1456633081770441725');" style=""> 171          return ret;                                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 172      }                                                                                                             </span>
<span  style=""> 173                                                                                                                    </span>
<span class="6736273159384894223" onmouseenter="enter('6736273159384894223');" onmouseout="out('6736273159384894223');" style=""> 174      private void sendAppMessageAck(int transactionId) {                                                           </span>
<span class="535862575394010177" onmouseenter="enter('535862575394010177');" onmouseout="out('535862575394010177');" style=""> 175          Intent intent = new Intent();                                                                             </span>
<span class="6082629123571614655" onmouseenter="enter('6082629123571614655');" onmouseout="out('6082629123571614655');" style=""> 176          intent.setAction(PEBBLEKIT_ACTION_APP_RECEIVE_ACK);                                                       </span>
<span class="8324089998886508665" onmouseenter="enter('8324089998886508665');" onmouseout="out('8324089998886508665');" style=""> 177          intent.putExtra(&quot;transaction_id&quot;, transactionId);                                                         </span>
<span class="2649247922579921710" onmouseenter="enter('2649247922579921710');" onmouseout="out('2649247922579921710');" style=""> 178          LOG.info(&quot;broadcasting ACK (transaction id &quot; + transactionId + &quot;)&quot;);                                      </span>
<span class="5781834444291540387" onmouseenter="enter('5781834444291540387');" onmouseout="out('5781834444291540387');" style=""> 179          getContext().sendBroadcast(intent);                                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 180      }                                                                                                             </span>
<span  style=""> 181                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 182      @Override                                                                                                     </span>
<span class="-689441939839417419" onmouseenter="enter('-689441939839417419');" onmouseout="out('-689441939839417419');" style=""> 183      protected boolean connect() {                                                                                 </span>
<span class="7179548470555074529" onmouseenter="enter('7179548470555074529');" onmouseout="out('7179548470555074529');" style=""> 184          String deviceAddress = gbDevice.getAddress();                                                             </span>
<span class="8603377014623514599" onmouseenter="enter('8603377014623514599');" onmouseout="out('8603377014623514599');" style=""> 185          GBDevice.State originalState = gbDevice.getState();                                                       </span>
<span class="-2168554989878345062" onmouseenter="enter('-2168554989878345062');" onmouseout="out('-2168554989878345062');" style=""> 186          gbDevice.setState(GBDevice.State.CONNECTING);                                                             </span>
<span class="-6083303279196581322" onmouseenter="enter('-6083303279196581322');" onmouseout="out('-6083303279196581322');" style=""> 187          gbDevice.sendDeviceUpdateIntent(getContext());                                                            </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 188          try {                                                                                                     </span>
<span class="-8563020019953546005" onmouseenter="enter('-8563020019953546005');" onmouseout="out('-8563020019953546005');" style=""> 189              // contains only one &quot;:&quot;? then it is addr:port                                                        </span>
<span class="-146660580149754487" onmouseenter="enter('-146660580149754487');" onmouseout="out('-146660580149754487');" style=""> 190              int firstColon = deviceAddress.indexOf(&quot;:&quot;);                                                          </span>
<span class="5048700417952215836" onmouseenter="enter('5048700417952215836');" onmouseout="out('5048700417952215836');" style=""> 191              if (firstColon == deviceAddress.lastIndexOf(&quot;:&quot;)) {                                                   </span>
<span class="-8977049560738769524" onmouseenter="enter('-8977049560738769524');" onmouseout="out('-8977049560738769524');" style=""> 192                  mIsTCP = true;                                                                                    </span>
<span class="-6378857250762995034" onmouseenter="enter('-6378857250762995034');" onmouseout="out('-6378857250762995034');" style=""> 193                  InetAddress serverAddr = InetAddress.getByName(deviceAddress.substring(0, firstColon));           </span>
<span class="3468657720829688371" onmouseenter="enter('3468657720829688371');" onmouseout="out('3468657720829688371');" style=""> 194                  mTCPSocket = new Socket(serverAddr, Integer.parseInt(deviceAddress.substring(firstColon + 1)));   </span>
<span class="-6670767050188612078" onmouseenter="enter('-6670767050188612078');" onmouseout="out('-6670767050188612078');" style=""> 195                  mInStream = mTCPSocket.getInputStream();                                                          </span>
<span class="-6104065159882353101" onmouseenter="enter('-6104065159882353101');" onmouseout="out('-6104065159882353101');" style=""> 196                  mOutStream = mTCPSocket.getOutputStream();                                                        </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 197              } else {                                                                                              </span>
<span class="4347759254647630465" onmouseenter="enter('4347759254647630465');" onmouseout="out('4347759254647630465');" style=""> 198                  mIsTCP = false;                                                                                   </span>
<span class="6443654244968138967" onmouseenter="enter('6443654244968138967');" onmouseout="out('6443654244968138967');" style=""> 199                  if (gbDevice.getVolatileAddress() != null &amp;&amp; prefs.getBoolean(&quot;pebble_force_le&quot;, false)) {        </span>
<span class="915290997518797062" onmouseenter="enter('915290997518797062');" onmouseout="out('915290997518797062');" style=""> 200                      deviceAddress = gbDevice.getVolatileAddress();                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 201                  }                                                                                                 </span>
<span class="4786675468629518746" onmouseenter="enter('4786675468629518746');" onmouseout="out('4786675468629518746');" style=""> 202                  BluetoothDevice btDevice = mBtAdapter.getRemoteDevice(deviceAddress);                             </span>
<span class="335623565325713065" onmouseenter="enter('335623565325713065');" onmouseout="out('335623565325713065');" style=""> 203                  if (btDevice.getType() == BluetoothDevice.DEVICE_TYPE_LE) {                                       </span>
<span class="8333508526895931889" onmouseenter="enter('8333508526895931889');" onmouseout="out('8333508526895931889');" style=""> 204                      LOG.info(&quot;This is a Pebble 2 or Pebble-LE/Pebble Time LE, will use BLE&quot;);                     </span>
<span class="-3562679261979772904" onmouseenter="enter('-3562679261979772904');" onmouseout="out('-3562679261979772904');" style=""> 205                      mInStream = new PipedInputStream();                                                           </span>
<span class="6393093760748525382" onmouseenter="enter('6393093760748525382');" onmouseout="out('6393093760748525382');" style=""> 206                      mOutStream = new PipedOutputStream();                                                         </span>
<span class="2915722355401222377" onmouseenter="enter('2915722355401222377');" onmouseout="out('2915722355401222377');" style=""><abbr title=" 207                      mPebbleLESupport = new PebbleLESupport(this.getContext(), btDevice, (PipedInputStream) mInStream, (PipedOutputStream) mOutStream);"> 207                      mPebbleLESupport = new PebbleLESupport(this.getContext(), btDevice, (PipedInputStream) mInStreðŸ”µ</abbr></span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 208                  } else {                                                                                          </span>
<span class="8228468292686787155" onmouseenter="enter('8228468292686787155');" onmouseout="out('8228468292686787155');" style=""> 209                      ParcelUuid uuids[] = btDevice.getUuids();                                                     </span>
<span class="2503839032557077084" onmouseenter="enter('2503839032557077084');" onmouseout="out('2503839032557077084');" style=""> 210                      if (uuids == null) {                                                                          </span>
<span class="-5432226360745882584" onmouseenter="enter('-5432226360745882584');" onmouseout="out('-5432226360745882584');" style=""> 211                          return false;                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 212                      }                                                                                             </span>
<span class="8104594939174164082" onmouseenter="enter('8104594939174164082');" onmouseout="out('8104594939174164082');" style=""> 213                      for (ParcelUuid uuid : uuids) {                                                               </span>
<span class="5496152670479511454" onmouseenter="enter('5496152670479511454');" onmouseout="out('5496152670479511454');" style=""> 214                          LOG.info(&quot;found service UUID &quot; + uuid);                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 215                      }                                                                                             </span>
<span class="-2085322778834697972" onmouseenter="enter('-2085322778834697972');" onmouseout="out('-2085322778834697972');" style=""> 216                      mBtSocket = btDevice.createRfcommSocketToServiceRecord(uuids[0].getUuid());                   </span>
<span class="-617547228937795237" onmouseenter="enter('-617547228937795237');" onmouseout="out('-617547228937795237');" style=""> 217                      mBtSocket.connect();                                                                          </span>
<span class="-4553264448616972703" onmouseenter="enter('-4553264448616972703');" onmouseout="out('-4553264448616972703');" style=""> 218                      mInStream = mBtSocket.getInputStream();                                                       </span>
<span class="-4296883704518407532" onmouseenter="enter('-4296883704518407532');" onmouseout="out('-4296883704518407532');" style=""> 219                      mOutStream = mBtSocket.getOutputStream();                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 220                  }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 221              }                                                                                                     </span>
<span class="7080241092423381085" onmouseenter="enter('7080241092423381085');" onmouseout="out('7080241092423381085');" style=""> 222          } catch (IOException e) {                                                                                 </span>
<span class="4090663313211582937" onmouseenter="enter('4090663313211582937');" onmouseout="out('4090663313211582937');" style=""> 223              e.printStackTrace();                                                                                  </span>
<span class="5984241666527947087" onmouseenter="enter('5984241666527947087');" onmouseout="out('5984241666527947087');" style=""> 224              gbDevice.setState(originalState);                                                                     </span>
<span class="-6083303279196581322" onmouseenter="enter('-6083303279196581322');" onmouseout="out('-6083303279196581322');" style=""> 225              gbDevice.sendDeviceUpdateIntent(getContext());                                                        </span>
<span  style=""> 226                                                                                                                    </span>
<span class="3085765988076808372" onmouseenter="enter('3085765988076808372');" onmouseout="out('3085765988076808372');" style=""> 227              mInStream = null;                                                                                     </span>
<span class="4968882532143556776" onmouseenter="enter('4968882532143556776');" onmouseout="out('4968882532143556776');" style=""> 228              mOutStream = null;                                                                                    </span>
<span class="-4534501040604870855" onmouseenter="enter('-4534501040604870855');" onmouseout="out('-4534501040604870855');" style=""> 229              mBtSocket = null;                                                                                     </span>
<span class="-5432226360745882584" onmouseenter="enter('-5432226360745882584');" onmouseout="out('-5432226360745882584');" style=""> 230              return false;                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 231          }                                                                                                         </span>
<span  style=""> 232                                                                                                                    </span>
<span class="1677595949374963054" onmouseenter="enter('1677595949374963054');" onmouseout="out('1677595949374963054');" style=""> 233          mPebbleProtocol.setForceProtocol(prefs.getBoolean(&quot;pebble_force_protocol&quot;, false));                       </span>
<span  style=""> 234                                                                                                                    </span>
<span class="5928608366163593597" onmouseenter="enter('5928608366163593597');" onmouseout="out('5928608366163593597');" style=""> 235          mIsConnected = true;                                                                                      </span>
<span class="3321416181738117978" onmouseenter="enter('3321416181738117978');" onmouseout="out('3321416181738117978');" style=""> 236          write(mPebbleProtocol.encodeFirmwareVersionReq());                                                        </span>
<span class="-7904642316416307948" onmouseenter="enter('-7904642316416307948');" onmouseout="out('-7904642316416307948');" style=""> 237          gbDevice.setState(GBDevice.State.CONNECTED);                                                              </span>
<span class="-6083303279196581322" onmouseenter="enter('-6083303279196581322');" onmouseout="out('-6083303279196581322');" style=""> 238          gbDevice.sendDeviceUpdateIntent(getContext());                                                            </span>
<span  style=""> 239                                                                                                                    </span>
<span class="-3118901906653197100" onmouseenter="enter('-3118901906653197100');" onmouseout="out('-3118901906653197100');" style=""> 240          return true;                                                                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 241      }                                                                                                             </span>
<span  style=""> 242                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 243      @Override                                                                                                     </span>
<span class="5292860430507443886" onmouseenter="enter('5292860430507443886');" onmouseout="out('5292860430507443886');" style=""> 244      public void run() {                                                                                           </span>
<span class="-2588539367217579258" onmouseenter="enter('-2588539367217579258');" onmouseout="out('-2588539367217579258');" style=""> 245          mIsConnected = connect();                                                                                 </span>
<span class="-245134013635442990" onmouseenter="enter('-245134013635442990');" onmouseout="out('-245134013635442990');" style=""> 246          if (!mIsConnected) {                                                                                      </span>
<span class="2633273029186728772" onmouseenter="enter('2633273029186728772');" onmouseout="out('2633273029186728772');" style=""> 247              if (GBApplication.getGBPrefs().getAutoReconnect() &amp;&amp; !mQuit) {                                        </span>
<span class="3557129149179391090" onmouseenter="enter('3557129149179391090');" onmouseout="out('3557129149179391090');" style=""> 248                  gbDevice.setState(GBDevice.State.WAITING_FOR_RECONNECT);                                          </span>
<span class="-6083303279196581322" onmouseenter="enter('-6083303279196581322');" onmouseout="out('-6083303279196581322');" style=""> 249                  gbDevice.sendDeviceUpdateIntent(getContext());                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 250              }                                                                                                     </span>
<span class="4043029072030362567" onmouseenter="enter('4043029072030362567');" onmouseout="out('4043029072030362567');" style=""> 251              return;                                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 252          }                                                                                                         </span>
<span  style=""> 253                                                                                                                    </span>
<span class="2624641968800564380" onmouseenter="enter('2624641968800564380');" onmouseout="out('2624641968800564380');" style=""> 254          byte[] buffer = new byte[8192];                                                                           </span>
<span class="4927755373081257077" onmouseenter="enter('4927755373081257077');" onmouseout="out('4927755373081257077');" style=""> 255          enablePebbleKitReceiver(true);                                                                            </span>

<span class="-8765366791852935627" onmouseenter="enter('-8765366791852935627');" onmouseout="out('-8765366791852935627');" style=""> 256          mQuit = false;                                                                                            </span>
<span class="-6588719847383972316" onmouseenter="enter('-6588719847383972316');" onmouseout="out('-6588719847383972316');" style=""> 257          while (!mQuit) {                                                                                          </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 258              try {                                                                                                 </span>
<span class="-8278348814669106484" onmouseenter="enter('-8278348814669106484');" onmouseout="out('-8278348814669106484');" style=""> 259                  if (mIsInstalling) {                                                                              </span>
<span class="8684367013652331710" onmouseenter="enter('8684367013652331710');" onmouseout="out('8684367013652331710');" style=""> 260                      switch (mInstallState) {                                                                      </span>
<span class="7026400303061140058" onmouseenter="enter('7026400303061140058');" onmouseout="out('7026400303061140058');" style=""> 261                          case WAIT_SLOT:                                                                           </span>
<span class="-2690055123266986251" onmouseenter="enter('-2690055123266986251');" onmouseout="out('-2690055123266986251');" style=""> 262                              if (mInstallSlot == -1) {                                                             </span>
<span class="-3606888775151099353" onmouseenter="enter('-3606888775151099353');" onmouseout="out('-3606888775151099353');" style=""> 263                                  finishInstall(true); // no slots available                                        </span>
<span class="2295401759568749857" onmouseenter="enter('2295401759568749857');" onmouseout="out('2295401759568749857');" style=""> 264                              } else if (mInstallSlot &gt;= 0) {                                                       </span>
<span class="6147346456613268497" onmouseenter="enter('6147346456613268497');" onmouseout="out('6147346456613268497');" style=""> 265                                  mInstallState = PebbleAppInstallState.START_INSTALL;                              </span>
<span class="-6362435147834875541" onmouseenter="enter('-6362435147834875541');" onmouseout="out('-6362435147834875541');" style=""> 266                                  continue;                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 267                              }                                                                                     </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 268                              break;                                                                                </span>
<span class="-3962643594977912505" onmouseenter="enter('-3962643594977912505');" onmouseout="out('-3962643594977912505');" style=""> 269                          case START_INSTALL:                                                                       </span>
<span class="-5574718196482043222" onmouseenter="enter('-5574718196482043222');" onmouseout="out('-5574718196482043222');" style=""> 270                              LOG.info(&quot;start installing app binary&quot;);                                              </span>
<span class="5478053508733530178" onmouseenter="enter('5478053508733530178');" onmouseout="out('5478053508733530178');" style=""> 271                              PebbleInstallable pi = mPebbleInstallables[mCurrentInstallableIndex];                 </span>
<span class="3659756883627403325" onmouseenter="enter('3659756883627403325');" onmouseout="out('3659756883627403325');" style=""> 272                              mFis = mPBWReader.getInputStreamFile(pi.getFileName());                               </span>
<span class="5016659144309369034" onmouseenter="enter('5016659144309369034');" onmouseout="out('5016659144309369034');" style=""> 273                              mCRC = pi.getCRC();                                                                   </span>
<span class="3142625636824209099" onmouseenter="enter('3142625636824209099');" onmouseout="out('3142625636824209099');" style=""> 274                              mBinarySize = pi.getFileSize();                                                       </span>
<span class="4161899041554384973" onmouseenter="enter('4161899041554384973');" onmouseout="out('4161899041554384973');" style=""> 275                              mBytesWritten = 0;                                                                    </span>
<span class="-1767419274223935649" onmouseenter="enter('-1767419274223935649');" onmouseout="out('-1767419274223935649');" style=""><abbr title=" 276                              writeInstallApp(mPebbleProtocol.encodeUploadStart(pi.getType(), mInstallSlot, mBinarySize, mPBWReader.isLanguage() ? &quot;lang&quot; : null));"> 276                              writeInstallApp(mPebbleProtocol.encodeUploadStart(pi.getType(), mInstallSlot, mBinarySðŸ”µ</abbr></span>
<span class="-556680889075439690" onmouseenter="enter('-556680889075439690');" onmouseout="out('-556680889075439690');" style=""> 277                              mAppInstallToken = -1;                                                                </span>
<span class="-7999689873557895203" onmouseenter="enter('-7999689873557895203');" onmouseout="out('-7999689873557895203');" style=""> 278                              mInstallState = PebbleAppInstallState.WAIT_TOKEN;                                     </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 279                              break;                                                                                </span>
<span class="6792169580692674220" onmouseenter="enter('6792169580692674220');" onmouseout="out('6792169580692674220');" style=""> 280                          case WAIT_TOKEN:                                                                          </span>
<span class="-3832708479724599095" onmouseenter="enter('-3832708479724599095');" onmouseout="out('-3832708479724599095');" style=""> 281                              if (mAppInstallToken != -1) {                                                         </span>
<span class="-8049659333726333512" onmouseenter="enter('-8049659333726333512');" onmouseout="out('-8049659333726333512');" style=""> 282                                  LOG.info(&quot;got token &quot; + mAppInstallToken);                                        </span>
<span class="5531590291586303132" onmouseenter="enter('5531590291586303132');" onmouseout="out('5531590291586303132');" style=""> 283                                  mInstallState = PebbleAppInstallState.UPLOAD_CHUNK;                               </span>
<span class="-6362435147834875541" onmouseenter="enter('-6362435147834875541');" onmouseout="out('-6362435147834875541');" style=""> 284                                  continue;                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 285                              }                                                                                     </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 286                              break;                                                                                </span>
<span class="-584114172413593495" onmouseenter="enter('-584114172413593495');" onmouseout="out('-584114172413593495');" style=""> 287                          case UPLOAD_CHUNK:                                                                        </span>
<span class="1528466301664079417" onmouseenter="enter('1528466301664079417');" onmouseout="out('1528466301664079417');" style=""> 288                              int bytes = 0;                                                                        </span>
<span class="3052837437029247759" onmouseenter="enter('3052837437029247759');" onmouseout="out('3052837437029247759');" style=""> 289                              do {                                                                                  </span>
<span class="1834678701284410601" onmouseenter="enter('1834678701284410601');" onmouseout="out('1834678701284410601');" style=""> 290                                  int read = mFis.read(buffer, bytes, 2000 - bytes);                                </span>
<span class="-6442970889778139424" onmouseenter="enter('-6442970889778139424');" onmouseout="out('-6442970889778139424');" style=""> 291                                  if (read &lt;= 0) break;                                                             </span>
<span class="-8945043921272536992" onmouseenter="enter('-8945043921272536992');" onmouseout="out('-8945043921272536992');" style=""> 292                                  bytes += read;                                                                    </span>
<span class="451207650617133464" onmouseenter="enter('451207650617133464');" onmouseout="out('451207650617133464');" style=""> 293                              } while (bytes &lt; 2000);                                                               </span>
<span  style=""> 294                                                                                                                    </span>
<span class="6794246418348616673" onmouseenter="enter('6794246418348616673');" onmouseout="out('6794246418348616673');" style=""> 295                              if (bytes &gt; 0) {                                                                      </span>
<span class="-5617191400623126363" onmouseenter="enter('-5617191400623126363');" onmouseout="out('-5617191400623126363');" style=""> 296                                  GB.updateInstallNotification(getContext().getString(                              </span>
<span class="4050487273412981374" onmouseenter="enter('4050487273412981374');" onmouseout="out('4050487273412981374');" style=""><abbr title=" 297                                          R.string.installing_binary_d_d, (mCurrentInstallableIndex + 1), mPebbleInstallables.length), true, (int) (((float) mBytesWritten / mBinarySize) * 100), getContext());"> 297                                          R.string.installing_binary_d_d, (mCurrentInstallableIndex + 1), mPebbleInsðŸ”µ</abbr></span>
<span class="-7477526339537165687" onmouseenter="enter('-7477526339537165687');" onmouseout="out('-7477526339537165687');" style=""><abbr title=" 298                                  writeInstallApp(mPebbleProtocol.encodeUploadChunk(mAppInstallToken, buffer, bytes));"> 298                                  writeInstallApp(mPebbleProtocol.encodeUploadChunk(mAppInstallToken, buffer, bytes)ðŸ”µ</abbr></span>
<span class="-4728151037181866094" onmouseenter="enter('-4728151037181866094');" onmouseout="out('-4728151037181866094');" style=""> 299                                  mBytesWritten += bytes;                                                           </span>
<span class="-556680889075439690" onmouseenter="enter('-556680889075439690');" onmouseout="out('-556680889075439690');" style=""> 300                                  mAppInstallToken = -1;                                                            </span>
<span class="-7999689873557895203" onmouseenter="enter('-7999689873557895203');" onmouseout="out('-7999689873557895203');" style=""> 301                                  mInstallState = PebbleAppInstallState.WAIT_TOKEN;                                 </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 302                              } else {                                                                              </span>
<span class="-5094680563432242000" onmouseenter="enter('-5094680563432242000');" onmouseout="out('-5094680563432242000');" style=""> 303                                  mInstallState = PebbleAppInstallState.UPLOAD_COMMIT;                              </span>
<span class="-6362435147834875541" onmouseenter="enter('-6362435147834875541');" onmouseout="out('-6362435147834875541');" style=""> 304                                  continue;                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 305                              }                                                                                     </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 306                              break;                                                                                </span>
<span class="4124538925361105547" onmouseenter="enter('4124538925361105547');" onmouseout="out('4124538925361105547');" style=""> 307                          case UPLOAD_COMMIT:                                                                       </span>
<span class="-2966405575206880121" onmouseenter="enter('-2966405575206880121');" onmouseout="out('-2966405575206880121');" style=""> 308                              writeInstallApp(mPebbleProtocol.encodeUploadCommit(mAppInstallToken, mCRC));          </span>
<span class="-556680889075439690" onmouseenter="enter('-556680889075439690');" onmouseout="out('-556680889075439690');" style=""> 309                              mAppInstallToken = -1;                                                                </span>
<span class="-6886437457702083289" onmouseenter="enter('-6886437457702083289');" onmouseout="out('-6886437457702083289');" style=""> 310                              mInstallState = PebbleAppInstallState.WAIT_COMMIT;                                    </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 311                              break;                                                                                </span>
<span class="-6760167966557106950" onmouseenter="enter('-6760167966557106950');" onmouseout="out('-6760167966557106950');" style=""> 312                          case WAIT_COMMIT:                                                                         </span>
<span class="-3832708479724599095" onmouseenter="enter('-3832708479724599095');" onmouseout="out('-3832708479724599095');" style=""> 313                              if (mAppInstallToken != -1) {                                                         </span>
<span class="-8049659333726333512" onmouseenter="enter('-8049659333726333512');" onmouseout="out('-8049659333726333512');" style=""> 314                                  LOG.info(&quot;got token &quot; + mAppInstallToken);                                        </span>
<span class="-6772897424369466346" onmouseenter="enter('-6772897424369466346');" onmouseout="out('-6772897424369466346');" style=""> 315                                  mInstallState = PebbleAppInstallState.UPLOAD_COMPLETE;                            </span>
<span class="-6362435147834875541" onmouseenter="enter('-6362435147834875541');" onmouseout="out('-6362435147834875541');" style=""> 316                                  continue;                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 317                              }                                                                                     </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 318                              break;                                                                                </span>
<span class="7185565864054148536" onmouseenter="enter('7185565864054148536');" onmouseout="out('7185565864054148536');" style=""> 319                          case UPLOAD_COMPLETE:                                                                     </span>
<span class="5024538798090815598" onmouseenter="enter('5024538798090815598');" onmouseout="out('5024538798090815598');" style=""> 320                              writeInstallApp(mPebbleProtocol.encodeUploadComplete(mAppInstallToken));              </span>
<span class="-937796524014974666" onmouseenter="enter('-937796524014974666');" onmouseout="out('-937796524014974666');" style=""> 321                              if (++mCurrentInstallableIndex &lt; mPebbleInstallables.length) {                        </span>
<span class="6147346456613268497" onmouseenter="enter('6147346456613268497');" onmouseout="out('6147346456613268497');" style=""> 322                                  mInstallState = PebbleAppInstallState.START_INSTALL;                              </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 323                              } else {                                                                              </span>
<span class="4645923661994641503" onmouseenter="enter('4645923661994641503');" onmouseout="out('4645923661994641503');" style=""> 324                                  mInstallState = PebbleAppInstallState.APP_REFRESH;                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 325                              }                                                                                     </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 326                              break;                                                                                </span>
<span class="-4660819450142864885" onmouseenter="enter('-4660819450142864885');" onmouseout="out('-4660819450142864885');" style=""> 327                          case APP_REFRESH:                                                                         </span>
<span class="1423594820264173048" onmouseenter="enter('1423594820264173048');" onmouseout="out('1423594820264173048');" style=""> 328                              if (mPBWReader.isFirmware()) {                                                        </span>
<span class="7979692944967033784" onmouseenter="enter('7979692944967033784');" onmouseout="out('7979692944967033784');" style=""> 329                                  writeInstallApp(mPebbleProtocol.encodeInstallFirmwareComplete());                 </span>
<span class="8670418135173104454" onmouseenter="enter('8670418135173104454');" onmouseout="out('8670418135173104454');" style=""> 330                                  finishInstall(false);                                                             </span>
<span class="-3229195631780864145" onmouseenter="enter('-3229195631780864145');" onmouseout="out('-3229195631780864145');" style=""> 331                              } else if (mPBWReader.isLanguage() || mPebbleProtocol.mFwMajor &gt;= 3) {                </span>
<span class="-3079811230585835514" onmouseenter="enter('-3079811230585835514');" onmouseout="out('-3079811230585835514');" style=""> 332                                  finishInstall(false); // FIXME: don&#x27;t know yet how to detect success              </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 333                              } else {                                                                              </span>
<span class="-3742154807253834306" onmouseenter="enter('-3742154807253834306');" onmouseout="out('-3742154807253834306');" style=""> 334                                  writeInstallApp(mPebbleProtocol.encodeAppRefresh(mInstallSlot));                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 335                              }                                                                                     </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 336                              break;                                                                                </span>
<span class="-8178136317704390296" onmouseenter="enter('-8178136317704390296');" onmouseout="out('-8178136317704390296');" style=""> 337                          default:                                                                                  </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 338                              break;                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 339                      }                                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 340                  }                                                                                                 </span>
<span class="5578850974519966568" onmouseenter="enter('5578850974519966568');" onmouseout="out('5578850974519966568');" style=""> 341                  if (mIsTCP) {                                                                                     </span>
<span class="4471698368272895479" onmouseenter="enter('4471698368272895479');" onmouseout="out('4471698368272895479');" style=""> 342                      mInStream.skip(6);                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 343                  }                                                                                                 </span>
<span class="2796952267402194740" onmouseenter="enter('2796952267402194740');" onmouseout="out('2796952267402194740');" style=""> 344                  int bytes = readWithException(mInStream, buffer, 0, 4);                                           </span>
<span  style=""> 345                                                                                                                    </span>
<span class="-2171789871350536014" onmouseenter="enter('-2171789871350536014');" onmouseout="out('-2171789871350536014');" style=""> 346                  while (bytes &lt; 4) {                                                                               </span>
<span class="-5884925481451326841" onmouseenter="enter('-5884925481451326841');" onmouseout="out('-5884925481451326841');" style=""> 347                      bytes += readWithException(mInStream, buffer, bytes, 4 - bytes);                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 348                  }                                                                                                 </span>
<span  style=""> 349                                                                                                                    </span>
<span class="-7296955466977945724" onmouseenter="enter('-7296955466977945724');" onmouseout="out('-7296955466977945724');" style=""> 350                  ByteBuffer buf = ByteBuffer.wrap(buffer);                                                         </span>
<span class="-8522898317938558799" onmouseenter="enter('-8522898317938558799');" onmouseout="out('-8522898317938558799');" style=""> 351                  buf.order(ByteOrder.BIG_ENDIAN);                                                                  </span>
<span class="2800045307834810060" onmouseenter="enter('2800045307834810060');" onmouseout="out('2800045307834810060');" style=""> 352                  short length = buf.getShort();                                                                    </span>
<span class="-8125815031192715923" onmouseenter="enter('-8125815031192715923');" onmouseout="out('-8125815031192715923');" style=""> 353                  short endpoint = buf.getShort();                                                                  </span>
<span class="9045200348604116826" onmouseenter="enter('9045200348604116826');" onmouseout="out('9045200348604116826');" style=""> 354                  if (length &lt; 0 || length &gt; 8192) {                                                                </span>
<span class="9194134393824457103" onmouseenter="enter('9194134393824457103');" onmouseout="out('9194134393824457103');" style=""> 355                      LOG.info(&quot;invalid length &quot; + length);                                                         </span>
<span class="-967764297694162849" onmouseenter="enter('-967764297694162849');" onmouseout="out('-967764297694162849');" style=""> 356                      while (mInStream.available() &gt; 0) {                                                           </span>
<span class="-1967224316023950474" onmouseenter="enter('-1967224316023950474');" onmouseout="out('-1967224316023950474');" style=""> 357                          readWithException(mInStream, buffer, 0, buffer.length); // read all                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 358                      }                                                                                             </span>
<span class="-6362435147834875541" onmouseenter="enter('-6362435147834875541');" onmouseout="out('-6362435147834875541');" style=""> 359                      continue;                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 360                  }                                                                                                 </span>
<span  style=""> 361                                                                                                                    </span>
<span class="8513682448486197246" onmouseenter="enter('8513682448486197246');" onmouseout="out('8513682448486197246');" style=""> 362                  bytes = readWithException(mInStream, buffer, 4, length);                                          </span>
<span class="-1011005986067945864" onmouseenter="enter('-1011005986067945864');" onmouseout="out('-1011005986067945864');" style=""> 363                  while (bytes &lt; length) {                                                                          </span>
<span class="-7104003189991341630" onmouseenter="enter('-7104003189991341630');" onmouseout="out('-7104003189991341630');" style=""> 364                      bytes += readWithException(mInStream, buffer, bytes + 4, length - bytes);                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 365                  }                                                                                                 </span>
<span  style=""> 366                                                                                                                    </span>
<span class="5578850974519966568" onmouseenter="enter('5578850974519966568');" onmouseout="out('5578850974519966568');" style=""> 367                  if (mIsTCP) {                                                                                     </span>
<span class="5401038970459668826" onmouseenter="enter('5401038970459668826');" onmouseout="out('5401038970459668826');" style=""> 368                      mInStream.skip(2);                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 369                  }                                                                                                 </span>
<span  style=""> 370                                                                                                                    </span>
<span class="-7909466471492476851" onmouseenter="enter('-7909466471492476851');" onmouseout="out('-7909466471492476851');" style=""> 371                  GBDeviceEvent deviceEvents[] = mPebbleProtocol.decodeResponse(buffer);                            </span>
<span class="-638626929611439615" onmouseenter="enter('-638626929611439615');" onmouseout="out('-638626929611439615');" style=""> 372                  if (deviceEvents == null) {                                                                       </span>
<span class="-7056050649624941936" onmouseenter="enter('-7056050649624941936');" onmouseout="out('-7056050649624941936');" style=""> 373                      LOG.info(&quot;unhandled message to endpoint &quot; + endpoint + &quot; (&quot; + length + &quot; bytes)&quot;);            </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 374                  } else {                                                                                          </span>
<span class="1477693521293066497" onmouseenter="enter('1477693521293066497');" onmouseout="out('1477693521293066497');" style=""> 375                      for (GBDeviceEvent deviceEvent : deviceEvents) {                                              </span>
<span class="2097356587238774416" onmouseenter="enter('2097356587238774416');" onmouseout="out('2097356587238774416');" style=""> 376                          if (deviceEvent == null) {                                                                </span>
<span class="-6362435147834875541" onmouseenter="enter('-6362435147834875541');" onmouseout="out('-6362435147834875541');" style=""> 377                              continue;                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 378                          }                                                                                         </span>
<span class="-236987672843521774" onmouseenter="enter('-236987672843521774');" onmouseout="out('-236987672843521774');" style=""> 379                          if (!evaluateGBDeviceEventPebble(deviceEvent)) {                                          </span>
<span class="7042821987734772133" onmouseenter="enter('7042821987734772133');" onmouseout="out('7042821987734772133');" style=""> 380                              mPebbleSupport.evaluateGBDeviceEvent(deviceEvent);                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 381                          }                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 382                      }                                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 383                  }                                                                                                 </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 384                  try {                                                                                             </span>
<span class="1958254861600319008" onmouseenter="enter('1958254861600319008');" onmouseout="out('1958254861600319008');" style=""> 385                      Thread.sleep(100);                                                                            </span>
<span class="-7528533024404460182" onmouseenter="enter('-7528533024404460182');" onmouseout="out('-7528533024404460182');" style=""> 386                  } catch (InterruptedException e) {                                                                </span>
<span class="4090663313211582937" onmouseenter="enter('4090663313211582937');" onmouseout="out('4090663313211582937');" style=""> 387                      e.printStackTrace();                                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 388                  }                                                                                                 </span>
<span class="7080241092423381085" onmouseenter="enter('7080241092423381085');" onmouseout="out('7080241092423381085');" style=""> 389              } catch (IOException e) {                                                                             </span>
<span class="-508556787667332479" onmouseenter="enter('-508556787667332479');" onmouseout="out('-508556787667332479');" style=""><abbr title=" 390                  if (e.getMessage() != null &amp;&amp; (e.getMessage().equals(&quot;broken pipe&quot;) || e.getMessage().contains(&quot;socket closed&quot;))) { //FIXME: this does not feel right"> 390                  if (e.getMessage() != null &amp;&amp; (e.getMessage().equals(&quot;broken pipe&quot;) || e.getMessage().contains(&quot;soðŸ”µ</abbr></span>
<span class="3941064908834146545" onmouseenter="enter('3941064908834146545');" onmouseout="out('3941064908834146545');" style=""> 391                      LOG.info(e.getMessage());                                                                     </span>
<span class="1054919517095572489" onmouseenter="enter('1054919517095572489');" onmouseout="out('1054919517095572489');" style=""> 392                      mIsConnected = false;                                                                         </span>
<span class="1961225799194435069" onmouseenter="enter('1961225799194435069');" onmouseout="out('1961225799194435069');" style=""> 393                      int reconnectAttempts = prefs.getInt(&quot;pebble_reconnect_attempts&quot;, 10);                        </span>
<span class="-786112365036832199" onmouseenter="enter('-786112365036832199');" onmouseout="out('-786112365036832199');" style=""> 394                      if (!mQuit &amp;&amp; GBApplication.getGBPrefs().getAutoReconnect() &amp;&amp; reconnectAttempts &gt; 0) {       </span>
<span class="3557129149179391090" onmouseenter="enter('3557129149179391090');" onmouseout="out('3557129149179391090');" style=""> 395                          gbDevice.setState(GBDevice.State.WAITING_FOR_RECONNECT);                                  </span>
<span class="-6083303279196581322" onmouseenter="enter('-6083303279196581322');" onmouseout="out('-6083303279196581322');" style=""> 396                          gbDevice.sendDeviceUpdateIntent(getContext());                                            </span>
<span  style=""> 397                                                                                                                    </span>
<span class="6110344959180570674" onmouseenter="enter('6110344959180570674');" onmouseout="out('6110344959180570674');" style=""> 398                          int delaySeconds = 1;                                                                     </span>
<span class="-5190003264224859806" onmouseenter="enter('-5190003264224859806');" onmouseout="out('-5190003264224859806');" style=""> 399                          while (reconnectAttempts-- &gt; 0 &amp;&amp; !mQuit &amp;&amp; !mIsConnected) {                              </span>
<span class="-7641363597792416938" onmouseenter="enter('-7641363597792416938');" onmouseout="out('-7641363597792416938');" style=""> 400                              LOG.info(&quot;Trying to reconnect (attempts left &quot; + reconnectAttempts + &quot;)&quot;);            </span>
<span class="-2588539367217579258" onmouseenter="enter('-2588539367217579258');" onmouseout="out('-2588539367217579258');" style=""> 401                              mIsConnected = connect();                                                             </span>
<span class="-245134013635442990" onmouseenter="enter('-245134013635442990');" onmouseout="out('-245134013635442990');" style=""> 402                              if (!mIsConnected) {                                                                  </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 403                                  try {                                                                             </span>
<span class="-3669672008793578674" onmouseenter="enter('-3669672008793578674');" onmouseout="out('-3669672008793578674');" style=""> 404                                      Thread.sleep(delaySeconds * 1000);                                            </span>
<span class="1010771762618413361" onmouseenter="enter('1010771762618413361');" onmouseout="out('1010771762618413361');" style=""> 405                                  } catch (InterruptedException ignored) {                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 406                                  }                                                                                 </span>
<span class="-8988961353399164519" onmouseenter="enter('-8988961353399164519');" onmouseout="out('-8988961353399164519');" style=""> 407                                  if (delaySeconds &lt; 64) {                                                          </span>
<span class="4518640925202616859" onmouseenter="enter('4518640925202616859');" onmouseout="out('4518640925202616859');" style=""> 408                                      delaySeconds *= 2;                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 409                                  }                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 410                              }                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 411                          }                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 412                      }                                                                                             </span>
<span class="-245134013635442990" onmouseenter="enter('-245134013635442990');" onmouseout="out('-245134013635442990');" style=""> 413                      if (!mIsConnected) {                                                                          </span>
<span class="-4534501040604870855" onmouseenter="enter('-4534501040604870855');" onmouseout="out('-4534501040604870855');" style=""> 414                          mBtSocket = null;                                                                         </span>
<span class="-3119559015644534035" onmouseenter="enter('-3119559015644534035');" onmouseout="out('-3119559015644534035');" style=""> 415                          LOG.info(&quot;Bluetooth socket closed, will quit IO Thread&quot;);                                 </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 416                          break;                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 417                      }                                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 418                  }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 419              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 420          }                                                                                                         </span>
<span class="1054919517095572489" onmouseenter="enter('1054919517095572489');" onmouseout="out('1054919517095572489');" style=""> 421          mIsConnected = false;                                                                                     </span>
<span class="-3944229288018059276" onmouseenter="enter('-3944229288018059276');" onmouseout="out('-3944229288018059276');" style=""> 422          if (mBtSocket != null) {                                                                                  </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 423              try {                                                                                                 </span>
<span class="4957759683762229483" onmouseenter="enter('4957759683762229483');" onmouseout="out('4957759683762229483');" style=""> 424                  mBtSocket.close();                                                                                </span>
<span class="7080241092423381085" onmouseenter="enter('7080241092423381085');" onmouseout="out('7080241092423381085');" style=""> 425              } catch (IOException e) {                                                                             </span>
<span class="4090663313211582937" onmouseenter="enter('4090663313211582937');" onmouseout="out('4090663313211582937');" style=""> 426                  e.printStackTrace();                                                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 427              }                                                                                                     </span>
<span class="-4534501040604870855" onmouseenter="enter('-4534501040604870855');" onmouseout="out('-4534501040604870855');" style=""> 428              mBtSocket = null;                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 429          }                                                                                                         </span>
<span  style=""> 430                                                                                                                    </span>
<span class="-177389763488354281" onmouseenter="enter('-177389763488354281');" onmouseout="out('-177389763488354281');" style=""> 431          enablePebbleKitReceiver(false);                                                                           </span>

<span  style=""> 432                                                                                                                    </span>
<span class="754428857450446437" onmouseenter="enter('754428857450446437');" onmouseout="out('754428857450446437');" style=""> 433          if (mQuit) {                                                                                              </span>
<span class="3251995130332618727" onmouseenter="enter('3251995130332618727');" onmouseout="out('3251995130332618727');" style=""> 434              gbDevice.setState(GBDevice.State.NOT_CONNECTED);                                                      </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 435          } else {                                                                                                  </span>
<span class="3557129149179391090" onmouseenter="enter('3557129149179391090');" onmouseout="out('3557129149179391090');" style=""> 436              gbDevice.setState(GBDevice.State.WAITING_FOR_RECONNECT);                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 437          }                                                                                                         </span>
<span  style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 438 +                                                                                                                  </span>
<span class="3956366137427967177" onmouseenter="enter('3956366137427967177');" onmouseout="out('3956366137427967177');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 439 +        WebViewSingleton.disposeWebView();                                                                        </span>
<span  style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 440 +                                                                                                                  </span>
<span class="-6083303279196581322" onmouseenter="enter('-6083303279196581322');" onmouseout="out('-6083303279196581322');" style=""> 441          gbDevice.sendDeviceUpdateIntent(getContext());                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 442      }                                                                                                             </span>
<span  style=""> 443                                                                                                                    </span>
<span class="4689325899265566877" onmouseenter="enter('4689325899265566877');" onmouseout="out('4689325899265566877');" style=""> 444      private void enablePebbleKitReceiver(boolean enable) {                                                        </span>
<span  style=""> 445                                                                                                                    </span>

<span class="-4986567876401497765" onmouseenter="enter('-4986567876401497765');" onmouseout="out('-4986567876401497765');" style=""> 446          if (enable &amp;&amp; mEnablePebblekit) {                                                                         </span>
<span class="-6475340056070675924" onmouseenter="enter('-6475340056070675924');" onmouseout="out('-6475340056070675924');" style=""> 447              IntentFilter intentFilter = new IntentFilter();                                                       </span>
<span class="-7999529314326405456" onmouseenter="enter('-7999529314326405456');" onmouseout="out('-7999529314326405456');" style=""> 448              intentFilter.addAction(PEBBLEKIT_ACTION_APP_ACK);                                                     </span>
<span class="-3927463604442628729" onmouseenter="enter('-3927463604442628729');" onmouseout="out('-3927463604442628729');" style=""> 449              intentFilter.addAction(PEBBLEKIT_ACTION_APP_NACK);                                                    </span>
<span class="-4792672716090115405" onmouseenter="enter('-4792672716090115405');" onmouseout="out('-4792672716090115405');" style=""> 450              intentFilter.addAction(PEBBLEKIT_ACTION_APP_SEND);                                                    </span>
<span class="5431224225228670983" onmouseenter="enter('5431224225228670983');" onmouseout="out('5431224225228670983');" style=""> 451              intentFilter.addAction(PEBBLEKIT_ACTION_APP_START);                                                   </span>
<span class="488268930261420957" onmouseenter="enter('488268930261420957');" onmouseout="out('488268930261420957');" style=""> 452              intentFilter.addAction(PEBBLEKIT_ACTION_APP_STOP);                                                    </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 453              try {                                                                                                 </span>
<span class="3118385057142063191" onmouseenter="enter('3118385057142063191');" onmouseout="out('3118385057142063191');" style=""> 454                  getContext().registerReceiver(mPebbleKitReceiver, intentFilter);                                  </span>
<span class="-1471183022667940231" onmouseenter="enter('-1471183022667940231');" onmouseout="out('-1471183022667940231');" style=""> 455              } catch (IllegalArgumentException e) {                                                                </span>
<span class="-4407835218921977391" onmouseenter="enter('-4407835218921977391');" onmouseout="out('-4407835218921977391');" style=""> 456                  // ignore                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 457              }                                                                                                     </span>

<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 458          } else {                                                                                                  </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 459              try {                                                                                                 </span>
<span class="2931362315099817520" onmouseenter="enter('2931362315099817520');" onmouseout="out('2931362315099817520');" style=""> 460                  getContext().unregisterReceiver(mPebbleKitReceiver);                                              </span>
<span class="-1471183022667940231" onmouseenter="enter('-1471183022667940231');" onmouseout="out('-1471183022667940231');" style=""> 461              } catch (IllegalArgumentException e) {                                                                </span>
<span class="-4407835218921977391" onmouseenter="enter('-4407835218921977391');" onmouseout="out('-4407835218921977391');" style=""> 462                  // ignore                                                                                         </span>



<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 463              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 464          }                                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 465      }                                                                                                             </span>
<span  style=""> 466                                                                                                                    </span>
<span  style=""> 467                                                                                                                    </span>
<span class="5266958563097079524" onmouseenter="enter('5266958563097079524');" onmouseout="out('5266958563097079524');" style=""> 468      private void write_real(byte[] bytes) {                                                                       </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 469          try {                                                                                                     </span>
<span class="5578850974519966568" onmouseenter="enter('5578850974519966568');" onmouseout="out('5578850974519966568');" style=""> 470              if (mIsTCP) {                                                                                         </span>
<span class="7452866671884685289" onmouseenter="enter('7452866671884685289');" onmouseout="out('7452866671884685289');" style=""> 471                  ByteBuffer buf = ByteBuffer.allocate(bytes.length + 8);                                           </span>
<span class="-8522898317938558799" onmouseenter="enter('-8522898317938558799');" onmouseout="out('-8522898317938558799');" style=""> 472                  buf.order(ByteOrder.BIG_ENDIAN);                                                                  </span>
<span class="5585321854972752725" onmouseenter="enter('5585321854972752725');" onmouseout="out('5585321854972752725');" style=""> 473                  buf.putShort((short) 0xfeed);                                                                     </span>
<span class="7507473664785459909" onmouseenter="enter('7507473664785459909');" onmouseout="out('7507473664785459909');" style=""> 474                  buf.putShort((short) 1);                                                                          </span>
<span class="-8123162661289444091" onmouseenter="enter('-8123162661289444091');" onmouseout="out('-8123162661289444091');" style=""> 475                  buf.putShort((short) bytes.length);                                                               </span>
<span class="-7064269165968803859" onmouseenter="enter('-7064269165968803859');" onmouseout="out('-7064269165968803859');" style=""> 476                  buf.put(bytes);                                                                                   </span>
<span class="488045024517500594" onmouseenter="enter('488045024517500594');" onmouseout="out('488045024517500594');" style=""> 477                  buf.putShort((short) 0xbeef);                                                                     </span>
<span class="5890011760749412055" onmouseenter="enter('5890011760749412055');" onmouseout="out('5890011760749412055');" style=""> 478                  mOutStream.write(buf.array());                                                                    </span>
<span class="5447277003517706714" onmouseenter="enter('5447277003517706714');" onmouseout="out('5447277003517706714');" style=""> 479                  mOutStream.flush();                                                                               </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 480              } else {                                                                                              </span>
<span class="-446832387142219515" onmouseenter="enter('-446832387142219515');" onmouseout="out('-446832387142219515');" style=""> 481                  mOutStream.write(bytes);                                                                          </span>
<span class="5447277003517706714" onmouseenter="enter('5447277003517706714');" onmouseout="out('5447277003517706714');" style=""> 482                  mOutStream.flush();                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 483              }                                                                                                     </span>
<span class="7080241092423381085" onmouseenter="enter('7080241092423381085');" onmouseout="out('7080241092423381085');" style=""> 484          } catch (IOException e) {                                                                                 </span>
<span class="886800052852078092" onmouseenter="enter('886800052852078092');" onmouseout="out('886800052852078092');" style=""> 485              LOG.error(&quot;Error writing.&quot;, e.getMessage());                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 486          }                                                                                                         </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 487          try {                                                                                                     </span>
<span class="1958254861600319008" onmouseenter="enter('1958254861600319008');" onmouseout="out('1958254861600319008');" style=""> 488              Thread.sleep(100);                                                                                    </span>
<span class="1010771762618413361" onmouseenter="enter('1010771762618413361');" onmouseout="out('1010771762618413361');" style=""> 489          } catch (InterruptedException ignored) {                                                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 490          }                                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 491      }                                                                                                             </span>
<span  style=""> 492                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 493      @Override                                                                                                     </span>
<span class="2194193333899452301" onmouseenter="enter('2194193333899452301');" onmouseout="out('2194193333899452301');" style=""> 494      synchronized public void write(byte[] bytes) {                                                                </span>
<span class="7962173391634007539" onmouseenter="enter('7962173391634007539');" onmouseout="out('7962173391634007539');" style=""> 495          if (bytes == null) {                                                                                      </span>
<span class="4043029072030362567" onmouseenter="enter('4043029072030362567');" onmouseout="out('4043029072030362567');" style=""> 496              return;                                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 497          }                                                                                                         </span>
<span class="-1647178201768949716" onmouseenter="enter('-1647178201768949716');" onmouseout="out('-1647178201768949716');" style=""> 498          // on FW &lt; 3.0 block writes if app installation in in progress                                            </span>
<span class="-6700324623621105863" onmouseenter="enter('-6700324623621105863');" onmouseout="out('-6700324623621105863');" style=""><abbr title=" 499          if (!mIsConnected || (mPebbleProtocol.mFwMajor &lt; 3 &amp;&amp; mIsInstalling &amp;&amp; mInstallState != PebbleAppInstallState.WAIT_SLOT)) {"> 499          if (!mIsConnected || (mPebbleProtocol.mFwMajor &lt; 3 &amp;&amp; mIsInstalling &amp;&amp; mInstallState != PebbleAppInstallStðŸ”µ</abbr></span>
<span class="4043029072030362567" onmouseenter="enter('4043029072030362567');" onmouseout="out('4043029072030362567');" style=""> 500              return;                                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 501          }                                                                                                         </span>
<span class="-5136181704666404560" onmouseenter="enter('-5136181704666404560');" onmouseout="out('-5136181704666404560');" style=""> 502          write_real(bytes);                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 503      }                                                                                                             </span>
<span  style=""> 504                                                                                                                    </span>
<span class="3670289587241327133" onmouseenter="enter('3670289587241327133');" onmouseout="out('3670289587241327133');" style=""> 505      // FIXME: parts are supporsed to be generic code                                                              </span>
<span class="-7489026152941302055" onmouseenter="enter('-7489026152941302055');" onmouseout="out('-7489026152941302055');" style=""> 506      private boolean evaluateGBDeviceEventPebble(GBDeviceEvent deviceEvent) {                                      </span>
<span  style=""> 507                                                                                                                    </span>
<span class="-1739566276849801616" onmouseenter="enter('-1739566276849801616');" onmouseout="out('-1739566276849801616');" style=""> 508          if (deviceEvent instanceof GBDeviceEventVersionInfo) {                                                    </span>
<span class="1668658004022497081" onmouseenter="enter('1668658004022497081');" onmouseout="out('1668658004022497081');" style=""> 509              if (prefs.getBoolean(&quot;datetime_synconconnect&quot;, true)) {                                               </span>
<span class="-3451867859378415609" onmouseenter="enter('-3451867859378415609');" onmouseout="out('-3451867859378415609');" style=""> 510                  LOG.info(&quot;syncing time&quot;);                                                                         </span>
<span class="5993925069998187867" onmouseenter="enter('5993925069998187867');" onmouseout="out('5993925069998187867');" style=""> 511                  write(mPebbleProtocol.encodeSetTime());                                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 512              }                                                                                                     </span>
<span class="-7386980641954546377" onmouseenter="enter('-7386980641954546377');" onmouseout="out('-7386980641954546377');" style=""> 513              write(mPebbleProtocol.encodeEnableAppLogs(prefs.getBoolean(&quot;pebble_enable_applogs&quot;, false)));         </span>
<span class="-4097828168322802160" onmouseenter="enter('-4097828168322802160');" onmouseout="out('-4097828168322802160');" style=""> 514              write(mPebbleProtocol.encodeReportDataLogSessions());                                                 </span>
<span class="6586859092027978564" onmouseenter="enter('6586859092027978564');" onmouseout="out('6586859092027978564');" style=""> 515              gbDevice.setState(GBDevice.State.INITIALIZED);                                                        </span>
<span class="-5432226360745882584" onmouseenter="enter('-5432226360745882584');" onmouseout="out('-5432226360745882584');" style=""> 516              return false;                                                                                         </span>
<span class="-4499044239010675675" onmouseenter="enter('-4499044239010675675');" onmouseout="out('-4499044239010675675');" style=""> 517          } else if (deviceEvent instanceof GBDeviceEventAppManagement) {                                           </span>
<span class="974736254576981019" onmouseenter="enter('974736254576981019');" onmouseout="out('974736254576981019');" style=""> 518              GBDeviceEventAppManagement appMgmt = (GBDeviceEventAppManagement) deviceEvent;                        </span>
<span class="-8405891147776704968" onmouseenter="enter('-8405891147776704968');" onmouseout="out('-8405891147776704968');" style=""> 519              switch (appMgmt.type) {                                                                               </span>
<span class="493585282467505488" onmouseenter="enter('493585282467505488');" onmouseout="out('493585282467505488');" style=""> 520                  case DELETE:                                                                                      </span>
<span class="3296704790396586230" onmouseenter="enter('3296704790396586230');" onmouseout="out('3296704790396586230');" style=""> 521                      // right now on the Pebble we also receive this on a failed/successful installation ;/        </span>
<span class="-5581198847294356355" onmouseenter="enter('-5581198847294356355');" onmouseout="out('-5581198847294356355');" style=""> 522                      switch (appMgmt.event) {                                                                      </span>
<span class="6749187966539498077" onmouseenter="enter('6749187966539498077');" onmouseout="out('6749187966539498077');" style=""> 523                          case FAILURE:                                                                             </span>
<span class="-8278348814669106484" onmouseenter="enter('-8278348814669106484');" onmouseout="out('-8278348814669106484');" style=""> 524                              if (mIsInstalling) {                                                                  </span>
<span class="5202677886896781243" onmouseenter="enter('5202677886896781243');" onmouseout="out('5202677886896781243');" style=""> 525                                  if (mInstallState == PebbleAppInstallState.WAIT_SLOT) {                           </span>
<span class="-3834429542028013887" onmouseenter="enter('-3834429542028013887');" onmouseout="out('-3834429542028013887');" style=""> 526                                      // get the free slot                                                          </span>
<span class="-1078532123174136932" onmouseenter="enter('-1078532123174136932');" onmouseout="out('-1078532123174136932');" style=""> 527                                      writeInstallApp(mPebbleProtocol.encodeAppInfoReq());                          </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 528                                  } else {                                                                          </span>
<span class="2061814158740359960" onmouseenter="enter('2061814158740359960');" onmouseout="out('2061814158740359960');" style=""> 529                                      finishInstall(true);                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 530                                  }                                                                                 </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 531                              } else {                                                                              </span>
<span class="-3730390778602920424" onmouseenter="enter('-3730390778602920424');" onmouseout="out('-3730390778602920424');" style=""> 532                                  LOG.info(&quot;failure removing app&quot;);                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 533                              }                                                                                     </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 534                              break;                                                                                </span>
<span class="3349111062118052514" onmouseenter="enter('3349111062118052514');" onmouseout="out('3349111062118052514');" style=""> 535                          case SUCCESS:                                                                             </span>
<span class="-8278348814669106484" onmouseenter="enter('-8278348814669106484');" onmouseout="out('-8278348814669106484');" style=""> 536                              if (mIsInstalling) {                                                                  </span>
<span class="5202677886896781243" onmouseenter="enter('5202677886896781243');" onmouseout="out('5202677886896781243');" style=""> 537                                  if (mInstallState == PebbleAppInstallState.WAIT_SLOT) {                           </span>
<span class="-3834429542028013887" onmouseenter="enter('-3834429542028013887');" onmouseout="out('-3834429542028013887');" style=""> 538                                      // get the free slot                                                          </span>
<span class="-1078532123174136932" onmouseenter="enter('-1078532123174136932');" onmouseout="out('-1078532123174136932');" style=""> 539                                      writeInstallApp(mPebbleProtocol.encodeAppInfoReq());                          </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 540                                  } else {                                                                          </span>
<span class="8670418135173104454" onmouseenter="enter('8670418135173104454');" onmouseout="out('8670418135173104454');" style=""> 541                                      finishInstall(false);                                                         </span>
<span class="5558136677444980843" onmouseenter="enter('5558136677444980843');" onmouseout="out('5558136677444980843');" style=""> 542                                      // refresh app list                                                           </span>
<span class="-6896285502301651077" onmouseenter="enter('-6896285502301651077');" onmouseout="out('-6896285502301651077');" style=""> 543                                      write(mPebbleProtocol.encodeAppInfoReq());                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 544                                  }                                                                                 </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 545                              } else {                                                                              </span>
<span class="-205908887212722760" onmouseenter="enter('-205908887212722760');" onmouseout="out('-205908887212722760');" style=""> 546                                  LOG.info(&quot;successfully removed app&quot;);                                             </span>
<span class="-6896285502301651077" onmouseenter="enter('-6896285502301651077');" onmouseout="out('-6896285502301651077');" style=""> 547                                  write(mPebbleProtocol.encodeAppInfoReq());                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 548                              }                                                                                     </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 549                              break;                                                                                </span>
<span class="-8178136317704390296" onmouseenter="enter('-8178136317704390296');" onmouseout="out('-8178136317704390296');" style=""> 550                          default:                                                                                  </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 551                              break;                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 552                      }                                                                                             </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 553                      break;                                                                                        </span>
<span class="870820606107259995" onmouseenter="enter('870820606107259995');" onmouseout="out('870820606107259995');" style=""> 554                  case INSTALL:                                                                                     </span>
<span class="-5581198847294356355" onmouseenter="enter('-5581198847294356355');" onmouseout="out('-5581198847294356355');" style=""> 555                      switch (appMgmt.event) {                                                                      </span>
<span class="6749187966539498077" onmouseenter="enter('6749187966539498077');" onmouseout="out('6749187966539498077');" style=""> 556                          case FAILURE:                                                                             </span>
<span class="-7112250469089022370" onmouseenter="enter('-7112250469089022370');" onmouseout="out('-7112250469089022370');" style=""> 557                              LOG.info(&quot;failure installing app&quot;); // TODO: report to Installer                      </span>
<span class="2061814158740359960" onmouseenter="enter('2061814158740359960');" onmouseout="out('2061814158740359960');" style=""> 558                              finishInstall(true);                                                                  </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 559                              break;                                                                                </span>
<span class="3349111062118052514" onmouseenter="enter('3349111062118052514');" onmouseout="out('3349111062118052514');" style=""> 560                          case SUCCESS:                                                                             </span>
<span class="6209162457835083814" onmouseenter="enter('6209162457835083814');" onmouseout="out('6209162457835083814');" style=""> 561                              setToken(appMgmt.token);                                                              </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 562                              break;                                                                                </span>
<span class="6051906179244859750" onmouseenter="enter('6051906179244859750');" onmouseout="out('6051906179244859750');" style=""> 563                          case REQUEST:                                                                             </span>
<span class="2049455602208269446" onmouseenter="enter('2049455602208269446');" onmouseout="out('2049455602208269446');" style=""> 564                              LOG.info(&quot;APPFETCH request: &quot; + appMgmt.uuid + &quot; / &quot; + appMgmt.token);                </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 565                              try {                                                                                 </span>
<span class="1545743734028545488" onmouseenter="enter('1545743734028545488');" onmouseout="out('1545743734028545488');" style=""><abbr title=" 566                                  installApp(Uri.fromFile(new File(FileUtils.getExternalFilesDir() + &quot;/pbw-cache/&quot; + appMgmt.uuid.toString() + &quot;.pbw&quot;)), appMgmt.token);"> 566                                  installApp(Uri.fromFile(new File(FileUtils.getExternalFilesDir() + &quot;/pbw-cache/&quot; +ðŸ”µ</abbr></span>
<span class="7080241092423381085" onmouseenter="enter('7080241092423381085');" onmouseout="out('7080241092423381085');" style=""> 567                              } catch (IOException e) {                                                             </span>
<span class="-531769948700903766" onmouseenter="enter('-531769948700903766');" onmouseout="out('-531769948700903766');" style=""> 568                                  LOG.error(&quot;Error installing app: &quot; + e.getMessage(), e);                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 569                              }                                                                                     </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 570                              break;                                                                                </span>
<span class="-8178136317704390296" onmouseenter="enter('-8178136317704390296');" onmouseout="out('-8178136317704390296');" style=""> 571                          default:                                                                                  </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 572                              break;                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 573                      }                                                                                             </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 574                      break;                                                                                        </span>
<span class="-2079449841199557933" onmouseenter="enter('-2079449841199557933');" onmouseout="out('-2079449841199557933');" style=""> 575                  case START:                                                                                       </span>
<span class="8092140248813269968" onmouseenter="enter('8092140248813269968');" onmouseout="out('8092140248813269968');" style=""> 576                      LOG.info(&quot;got GBDeviceEventAppManagement START event for uuid: &quot; + appMgmt.uuid);             </span>
<span class="-7700571972479023893" onmouseenter="enter('-7700571972479023893');" onmouseout="out('-7700571972479023893');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 577 +                    WebViewSingleton.getorInitWebView(getContext(), gbDevice, appMgmt.uuid);                      </span>
<span class="3757214281746876643" onmouseenter="enter('3757214281746876643');" onmouseout="out('3757214281746876643');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 578 +                    //TODO: the method call above will not work the first time as we need an activity. Either we find a way to have one here, or replace it with a local broadcast"> 578 +                    //TODO: the method call above will not work the first time as we need an activity. Either we fðŸ”µ</abbr></span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 579                      break;                                                                                        </span>
<span class="-8178136317704390296" onmouseenter="enter('-8178136317704390296');" onmouseout="out('-8178136317704390296');" style=""> 580                  default:                                                                                          </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 581                      break;                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 582              }                                                                                                     </span>
<span class="-3118901906653197100" onmouseenter="enter('-3118901906653197100');" onmouseout="out('-3118901906653197100');" style=""> 583              return true;                                                                                          </span>
<span class="-6358653040411049512" onmouseenter="enter('-6358653040411049512');" onmouseout="out('-6358653040411049512');" style=""> 584          } else if (deviceEvent instanceof GBDeviceEventAppInfo) {                                                 </span>
<span class="3946899054861776294" onmouseenter="enter('3946899054861776294');" onmouseout="out('3946899054861776294');" style=""> 585              LOG.info(&quot;Got event for APP_INFO&quot;);                                                                   </span>
<span class="1502569219724801591" onmouseenter="enter('1502569219724801591');" onmouseout="out('1502569219724801591');" style=""> 586              GBDeviceEventAppInfo appInfoEvent = (GBDeviceEventAppInfo) deviceEvent;                               </span>
<span class="-8959429837223401007" onmouseenter="enter('-8959429837223401007');" onmouseout="out('-8959429837223401007');" style=""> 587              setInstallSlot(appInfoEvent.freeSlot);                                                                </span>
<span class="-5432226360745882584" onmouseenter="enter('-5432226360745882584');" onmouseout="out('-5432226360745882584');" style=""> 588              return false;                                                                                         </span>
<span class="3212296093301006379" onmouseenter="enter('3212296093301006379');" onmouseout="out('3212296093301006379');" style=""> 589          } else if (deviceEvent instanceof GBDeviceEventAppMessage) {                                              </span>
<span class="3695639456947057183" onmouseenter="enter('3695639456947057183');" onmouseout="out('3695639456947057183');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 590 +            sendAppMessageJS((GBDeviceEventAppMessage) deviceEvent);                                              </span>
<span class="-2519217701585576846" onmouseenter="enter('-2519217701585576846');" onmouseout="out('-2519217701585576846');" style=""> 591              if (mEnablePebblekit) {                                                                               </span>
<span class="3587206773966788552" onmouseenter="enter('3587206773966788552');" onmouseout="out('3587206773966788552');" style=""> 592                  LOG.info(&quot;Got AppMessage event&quot;);                                                                 </span>
<span class="8710991571792193702" onmouseenter="enter('8710991571792193702');" onmouseout="out('8710991571792193702');" style=""> 593                  sendAppMessageIntent((GBDeviceEventAppMessage) deviceEvent);                                      </span>



<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 594              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 595          }                                                                                                         </span>
<span  style=""> 596                                                                                                                    </span>
<span class="-5432226360745882584" onmouseenter="enter('-5432226360745882584');" onmouseout="out('-5432226360745882584');" style=""> 597          return false;                                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 598      }                                                                                                             </span>
<span  style=""> 599                                                                                                                    </span>
<span class="1330519925695971168" onmouseenter="enter('1330519925695971168');" onmouseout="out('1330519925695971168');" style=""> 600      private void setToken(int token) {                                                                            </span>
<span class="5683710649022739399" onmouseenter="enter('5683710649022739399');" onmouseout="out('5683710649022739399');" style=""> 601          mAppInstallToken = token;                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 602      }                                                                                                             </span>
<span  style=""> 603                                                                                                                    </span>
<span class="3305301500785286694" onmouseenter="enter('3305301500785286694');" onmouseout="out('3305301500785286694');" style=""> 604      private void setInstallSlot(int slot) {                                                                       </span>
<span class="-8278348814669106484" onmouseenter="enter('-8278348814669106484');" onmouseout="out('-8278348814669106484');" style=""> 605          if (mIsInstalling) {                                                                                      </span>
<span class="7826340306873194751" onmouseenter="enter('7826340306873194751');" onmouseout="out('7826340306873194751');" style=""> 606              mInstallSlot = slot;                                                                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 607          }                                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 608      }                                                                                                             </span>
<span  style=""> 609                                                                                                                    </span>
<span class="-8792508792922317323" onmouseenter="enter('-8792508792922317323');" onmouseout="out('-8792508792922317323');" style=""> 610      synchronized private void writeInstallApp(byte[] bytes) {                                                     </span>
<span class="1640300515722317364" onmouseenter="enter('1640300515722317364');" onmouseout="out('1640300515722317364');" style=""> 611          if (!mIsInstalling) {                                                                                     </span>
<span class="4043029072030362567" onmouseenter="enter('4043029072030362567');" onmouseout="out('4043029072030362567');" style=""> 612              return;                                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 613          }                                                                                                         </span>
<span class="546783514848998195" onmouseenter="enter('546783514848998195');" onmouseout="out('546783514848998195');" style=""> 614          LOG.info(&quot;got &quot; + bytes.length + &quot;bytes for writeInstallApp()&quot;);                                          </span>
<span class="-5136181704666404560" onmouseenter="enter('-5136181704666404560');" onmouseout="out('-5136181704666404560');" style=""> 615          write_real(bytes);                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 616      }                                                                                                             </span>
<span  style=""> 617                                                                                                                    </span>
<span class="-1924531441297190559" onmouseenter="enter('-1924531441297190559');" onmouseout="out('-1924531441297190559');" style=""> 618      void installApp(Uri uri, int appId) {                                                                         </span>
<span class="4219320778876848093" onmouseenter="enter('4219320778876848093');" onmouseout="out('4219320778876848093');" style=""> 619          if (uri.equals(Uri.parse(&quot;fake://health&quot;))) {                                                             </span>
<span class="-4500321340045240107" onmouseenter="enter('-4500321340045240107');" onmouseout="out('-4500321340045240107');" style=""> 620              write(mPebbleProtocol.encodeActivateHealth(true));                                                    </span>
<span class="-9057759845463359663" onmouseenter="enter('-9057759845463359663');" onmouseout="out('-9057759845463359663');" style=""> 621              write(mPebbleProtocol.encodeSetSaneDistanceUnit(true));                                               </span>
<span class="4043029072030362567" onmouseenter="enter('4043029072030362567');" onmouseout="out('4043029072030362567');" style=""> 622              return;                                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 623          }                                                                                                         </span>
<span class="-2579506686933905796" onmouseenter="enter('-2579506686933905796');" onmouseout="out('-2579506686933905796');" style=""> 624          if (uri.equals(Uri.parse(&quot;fake://hrm&quot;))) {                                                                </span>
<span class="-8562013736932235665" onmouseenter="enter('-8562013736932235665');" onmouseout="out('-8562013736932235665');" style=""> 625              write(mPebbleProtocol.encodeActivateHRM(true));                                                       </span>
<span class="4043029072030362567" onmouseenter="enter('4043029072030362567');" onmouseout="out('4043029072030362567');" style=""> 626              return;                                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 627          }                                                                                                         </span>
<span class="-1212047709466619456" onmouseenter="enter('-1212047709466619456');" onmouseout="out('-1212047709466619456');" style=""> 628          if (uri.equals(Uri.parse(&quot;fake://weather&quot;))) {                                                            </span>
<span class="2684404709669173657" onmouseenter="enter('2684404709669173657');" onmouseout="out('2684404709669173657');" style=""> 629              write(mPebbleProtocol.encodeActivateWeather(true));                                                   </span>
<span class="4043029072030362567" onmouseenter="enter('4043029072030362567');" onmouseout="out('4043029072030362567');" style=""> 630              return;                                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 631          }                                                                                                         </span>
<span  style=""> 632                                                                                                                    </span>
<span class="-8278348814669106484" onmouseenter="enter('-8278348814669106484');" onmouseout="out('-8278348814669106484');" style=""> 633          if (mIsInstalling) {                                                                                      </span>
<span class="4043029072030362567" onmouseenter="enter('4043029072030362567');" onmouseout="out('4043029072030362567');" style=""> 634              return;                                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 635          }                                                                                                         </span>
<span  style=""> 636                                                                                                                    </span>
<span class="6375141335175677190" onmouseenter="enter('6375141335175677190');" onmouseout="out('6375141335175677190');" style=""> 637          String platformName = PebbleUtils.getPlatformName(gbDevice.getModel());                                   </span>
<span  style=""> 638                                                                                                                    </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 639          try {                                                                                                     </span>
<span class="7221939422125416648" onmouseenter="enter('7221939422125416648');" onmouseout="out('7221939422125416648');" style=""> 640              mPBWReader = new PBWReader(uri, getContext(), platformName);                                          </span>
<span class="400908373044587289" onmouseenter="enter('400908373044587289');" onmouseout="out('400908373044587289');" style=""> 641          } catch (FileNotFoundException e) {                                                                       </span>
<span class="769608185211968952" onmouseenter="enter('769608185211968952');" onmouseout="out('769608185211968952');" style=""> 642              LOG.warn(&quot;file not found: &quot; + e.getMessage(), e);                                                     </span>
<span class="4043029072030362567" onmouseenter="enter('4043029072030362567');" onmouseout="out('4043029072030362567');" style=""> 643              return;                                                                                               </span>
<span class="7080241092423381085" onmouseenter="enter('7080241092423381085');" onmouseout="out('7080241092423381085');" style=""> 644          } catch (IOException e) {                                                                                 </span>
<span class="8483156789856269109" onmouseenter="enter('8483156789856269109');" onmouseout="out('8483156789856269109');" style=""> 645              LOG.warn(&quot;unable to read file: &quot; + e.getMessage(), e);                                                </span>
<span class="4043029072030362567" onmouseenter="enter('4043029072030362567');" onmouseout="out('4043029072030362567');" style=""> 646              return;                                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 647          }                                                                                                         </span>
<span  style=""> 648                                                                                                                    </span>
<span class="-8518332035217489539" onmouseenter="enter('-8518332035217489539');" onmouseout="out('-8518332035217489539');" style=""> 649          mPebbleInstallables = mPBWReader.getPebbleInstallables();                                                 </span>
<span class="5818194705482022298" onmouseenter="enter('5818194705482022298');" onmouseout="out('5818194705482022298');" style=""> 650          mCurrentInstallableIndex = 0;                                                                             </span>
<span  style=""> 651                                                                                                                    </span>
<span class="1423594820264173048" onmouseenter="enter('1423594820264173048');" onmouseout="out('1423594820264173048');" style=""> 652          if (mPBWReader.isFirmware()) {                                                                            </span>
<span class="-6874615797996941970" onmouseenter="enter('-6874615797996941970');" onmouseout="out('-6874615797996941970');" style=""> 653              LOG.info(&quot;starting firmware installation&quot;);                                                           </span>
<span class="-7893027413776683580" onmouseenter="enter('-7893027413776683580');" onmouseout="out('-7893027413776683580');" style=""> 654              mIsInstalling = true;                                                                                 </span>
<span class="2991380117683144492" onmouseenter="enter('2991380117683144492');" onmouseout="out('2991380117683144492');" style=""> 655              mInstallSlot = 0;                                                                                     </span>
<span class="5938608831368473017" onmouseenter="enter('5938608831368473017');" onmouseout="out('5938608831368473017');" style=""> 656              writeInstallApp(mPebbleProtocol.encodeInstallFirmwareStart());                                        </span>
<span class="6147346456613268497" onmouseenter="enter('6147346456613268497');" onmouseout="out('6147346456613268497');" style=""> 657              mInstallState = PebbleAppInstallState.START_INSTALL;                                                  </span>
<span  style=""> 658                                                                                                                    </span>
<span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style=""> 659              /*                                                                                                    </span>
<span class="4272043072413570034" onmouseenter="enter('4272043072413570034');" onmouseout="out('4272043072413570034');" style=""> 660               * This is a hack for recovery mode, in which the blocking read has no timeout and the                </span>
<span class="5399824784620980403" onmouseenter="enter('5399824784620980403');" onmouseout="out('5399824784620980403');" style=""> 661               * firmware installation command does not return any ack.                                             </span>
<span class="5951082934844106568" onmouseenter="enter('5951082934844106568');" onmouseout="out('5951082934844106568');" style=""> 662               * In normal mode we would got at least out of the blocking read call after a while.                  </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 663               *                                                                                                    </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 664               *                                                                                                    </span>
<span class="1478144735136743177" onmouseenter="enter('1478144735136743177');" onmouseout="out('1478144735136743177');" style=""> 665               * ... we should really not handle installation from thread that does the blocking read               </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 666               *                                                                                                    </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 667               */                                                                                                   </span>
<span class="-4151709780636609521" onmouseenter="enter('-4151709780636609521');" onmouseout="out('-4151709780636609521');" style=""> 668              writeInstallApp(mPebbleProtocol.encodeGetTime());                                                     </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 669          } else {                                                                                                  </span>
<span class="5609914623056246065" onmouseenter="enter('5609914623056246065');" onmouseout="out('5609914623056246065');" style=""> 670              mCurrentlyInstallingApp = mPBWReader.getGBDeviceApp();                                                </span>
<span class="-492152501567437702" onmouseenter="enter('-492152501567437702');" onmouseout="out('-492152501567437702');" style=""> 671              if (mPebbleProtocol.mFwMajor &gt;= 3 &amp;&amp; !mPBWReader.isLanguage()) {                                      </span>
<span class="2714123758730002125" onmouseenter="enter('2714123758730002125');" onmouseout="out('2714123758730002125');" style=""> 672                  if (appId == 0) {                                                                                 </span>
<span class="-403761314332683960" onmouseenter="enter('-403761314332683960');" onmouseout="out('-403761314332683960');" style=""> 673                      // only install metadata - not the binaries                                                   </span>
<span class="4867948988198814512" onmouseenter="enter('4867948988198814512');" onmouseout="out('4867948988198814512');" style=""><abbr title=" 674                      write(mPebbleProtocol.encodeInstallMetadata(mCurrentlyInstallingApp.getUUID(), mCurrentlyInstallingApp.getName(), mPBWReader.getAppVersion(), mPBWReader.getSdkVersion(), mPBWReader.getFlags(), mPBWReader.getIconId()));"> 674                      write(mPebbleProtocol.encodeInstallMetadata(mCurrentlyInstallingApp.getUUID(), mCurrentlyInstaðŸ”µ</abbr></span>
<span class="-4051160554063647465" onmouseenter="enter('-4051160554063647465');" onmouseout="out('-4051160554063647465');" style=""> 675                      write(mPebbleProtocol.encodeAppStart(mCurrentlyInstallingApp.getUUID(), true));               </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 676                  } else {                                                                                          </span>
<span class="268321394733795474" onmouseenter="enter('268321394733795474');" onmouseout="out('268321394733795474');" style=""> 677                      // this came from an app fetch request, so do the real stuff                                  </span>
<span class="-7893027413776683580" onmouseenter="enter('-7893027413776683580');" onmouseout="out('-7893027413776683580');" style=""> 678                      mIsInstalling = true;                                                                         </span>
<span class="6866943522579684341" onmouseenter="enter('6866943522579684341');" onmouseout="out('6866943522579684341');" style=""> 679                      mInstallSlot = appId;                                                                         </span>
<span class="6147346456613268497" onmouseenter="enter('6147346456613268497');" onmouseout="out('6147346456613268497');" style=""> 680                      mInstallState = PebbleAppInstallState.START_INSTALL;                                          </span>
<span  style=""> 681                                                                                                                    </span>
<span class="1406564667829072525" onmouseenter="enter('1406564667829072525');" onmouseout="out('1406564667829072525');" style=""> 682                      writeInstallApp(mPebbleProtocol.encodeAppFetchAck());                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 683                  }                                                                                                 </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 684              } else {                                                                                              </span>
<span class="-7893027413776683580" onmouseenter="enter('-7893027413776683580');" onmouseout="out('-7893027413776683580');" style=""> 685                  mIsInstalling = true;                                                                             </span>
<span class="7854043658495457291" onmouseenter="enter('7854043658495457291');" onmouseout="out('7854043658495457291');" style=""> 686                  if (mPBWReader.isLanguage()) {                                                                    </span>
<span class="2991380117683144492" onmouseenter="enter('2991380117683144492');" onmouseout="out('2991380117683144492');" style=""> 687                      mInstallSlot = 0;                                                                             </span>
<span class="6147346456613268497" onmouseenter="enter('6147346456613268497');" onmouseout="out('6147346456613268497');" style=""> 688                      mInstallState = PebbleAppInstallState.START_INSTALL;                                          </span>
<span  style=""> 689                                                                                                                    </span>
<span class="-9169766034690988699" onmouseenter="enter('-9169766034690988699');" onmouseout="out('-9169766034690988699');" style=""> 690                      // unblock HACK                                                                               </span>
<span class="-4151709780636609521" onmouseenter="enter('-4151709780636609521');" onmouseout="out('-4151709780636609521');" style=""> 691                      writeInstallApp(mPebbleProtocol.encodeGetTime());                                             </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 692                  } else {                                                                                          </span>
<span class="6749245896015366249" onmouseenter="enter('6749245896015366249');" onmouseout="out('6749245896015366249');" style=""> 693                      mInstallState = PebbleAppInstallState.WAIT_SLOT;                                              </span>
<span class="-5557276013487860944" onmouseenter="enter('-5557276013487860944');" onmouseout="out('-5557276013487860944');" style=""> 694                      writeInstallApp(mPebbleProtocol.encodeAppDelete(mCurrentlyInstallingApp.getUUID()));          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 695                  }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 696              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 697          }                                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 698      }                                                                                                             </span>
<span  style=""> 699                                                                                                                    </span>
<span class="-3632958031962272509" onmouseenter="enter('-3632958031962272509');" onmouseout="out('-3632958031962272509');" style=""> 700      private void finishInstall(boolean hadError) {                                                                </span>
<span class="1640300515722317364" onmouseenter="enter('1640300515722317364');" onmouseout="out('1640300515722317364');" style=""> 701          if (!mIsInstalling) {                                                                                     </span>
<span class="4043029072030362567" onmouseenter="enter('4043029072030362567');" onmouseout="out('4043029072030362567');" style=""> 702              return;                                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 703          }                                                                                                         </span>
<span class="7546809272471924454" onmouseenter="enter('7546809272471924454');" onmouseout="out('7546809272471924454');" style=""> 704          if (hadError) {                                                                                           </span>
<span class="1510893224061013550" onmouseenter="enter('1510893224061013550');" onmouseout="out('1510893224061013550');" style=""><abbr title=" 705              GB.updateInstallNotification(getContext().getString(R.string.installation_failed_), false, 0, getContext());"> 705              GB.updateInstallNotification(getContext().getString(R.string.installation_failed_), false, 0, getConteðŸ”µ</abbr></span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 706          } else {                                                                                                  </span>
<span class="-1798755310811164062" onmouseenter="enter('-1798755310811164062');" onmouseout="out('-1798755310811164062');" style=""><abbr title=" 707              GB.updateInstallNotification(getContext().getString(R.string.installation_successful), false, 0, getContext());"> 707              GB.updateInstallNotification(getContext().getString(R.string.installation_successful), false, 0, getCoðŸ”µ</abbr></span>
<span class="-1022673267036805326" onmouseenter="enter('-1022673267036805326');" onmouseout="out('-1022673267036805326');" style=""> 708              if (mPebbleProtocol.mFwMajor &gt;= 3) {                                                                  </span>
<span class="-6972336671826040876" onmouseenter="enter('-6972336671826040876');" onmouseout="out('-6972336671826040876');" style=""> 709                  String filenameSuffix;                                                                            </span>
<span class="-4516041174588684958" onmouseenter="enter('-4516041174588684958');" onmouseout="out('-4516041174588684958');" style=""> 710                  if (mCurrentlyInstallingApp != null) {                                                            </span>
<span class="-1977040827148362152" onmouseenter="enter('-1977040827148362152');" onmouseout="out('-1977040827148362152');" style=""> 711                      if (mCurrentlyInstallingApp.getType() == GBDeviceApp.Type.WATCHFACE) {                        </span>
<span class="4066163442843372701" onmouseenter="enter('4066163442843372701');" onmouseout="out('4066163442843372701');" style=""> 712                          filenameSuffix = &quot;.watchfaces&quot;;                                                           </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 713                      } else {                                                                                      </span>
<span class="-1542718791393148177" onmouseenter="enter('-1542718791393148177');" onmouseout="out('-1542718791393148177');" style=""> 714                          filenameSuffix = &quot;.watchapps&quot;;                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 715                      }                                                                                             </span>
<span class="7434590360240997484" onmouseenter="enter('7434590360240997484');" onmouseout="out('7434590360240997484');" style=""><abbr title=" 716                      AppManagerActivity.addToAppOrderFile(gbDevice.getAddress() + filenameSuffix, mCurrentlyInstallingApp.getUUID());"> 716                      AppManagerActivity.addToAppOrderFile(gbDevice.getAddress() + filenameSuffix, mCurrentlyInstallðŸ”µ</abbr></span>
<span class="7935209901888052732" onmouseenter="enter('7935209901888052732');" onmouseout="out('7935209901888052732');" style=""> 717                      Intent refreshIntent = new Intent(AbstractAppManagerFragment.ACTION_REFRESH_APPLIST);         </span>
<span class="-1350396105067022557" onmouseenter="enter('-1350396105067022557');" onmouseout="out('-1350396105067022557');" style=""> 718                      LocalBroadcastManager.getInstance(getContext()).sendBroadcast(refreshIntent);                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 719                  }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 720              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 721          }                                                                                                         </span>
<span class="3442713773628960689" onmouseenter="enter('3442713773628960689');" onmouseout="out('3442713773628960689');" style=""> 722          mInstallState = PebbleAppInstallState.UNKNOWN;                                                            </span>
<span  style=""> 723                                                                                                                    </span>
<span class="6208081448933219418" onmouseenter="enter('6208081448933219418');" onmouseout="out('6208081448933219418');" style=""> 724          if (hadError &amp;&amp; mAppInstallToken != -1) {                                                                 </span>
<span class="1039411603055838770" onmouseenter="enter('1039411603055838770');" onmouseout="out('1039411603055838770');" style=""> 725              writeInstallApp(mPebbleProtocol.encodeUploadCancel(mAppInstallToken));                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 726          }                                                                                                         </span>
<span  style=""> 727                                                                                                                    </span>
<span class="5124188328891976822" onmouseenter="enter('5124188328891976822');" onmouseout="out('5124188328891976822');" style=""> 728          mPBWReader = null;                                                                                        </span>
<span class="1304182622527867961" onmouseenter="enter('1304182622527867961');" onmouseout="out('1304182622527867961');" style=""> 729          mIsInstalling = false;                                                                                    </span>
<span class="3809401643932021573" onmouseenter="enter('3809401643932021573');" onmouseout="out('3809401643932021573');" style=""> 730          mCurrentlyInstallingApp = null;                                                                           </span>
<span  style=""> 731                                                                                                                    </span>
<span class="5599892338312940306" onmouseenter="enter('5599892338312940306');" onmouseout="out('5599892338312940306');" style=""> 732          if (mFis != null) {                                                                                       </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 733              try {                                                                                                 </span>
<span class="5464107653723318031" onmouseenter="enter('5464107653723318031');" onmouseout="out('5464107653723318031');" style=""> 734                  mFis.close();                                                                                     </span>
<span class="7080241092423381085" onmouseenter="enter('7080241092423381085');" onmouseout="out('7080241092423381085');" style=""> 735              } catch (IOException e) {                                                                             </span>
<span class="-4407835218921977391" onmouseenter="enter('-4407835218921977391');" onmouseout="out('-4407835218921977391');" style=""> 736                  // ignore                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 737              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 738          }                                                                                                         </span>
<span class="6718599516057736481" onmouseenter="enter('6718599516057736481');" onmouseout="out('6718599516057736481');" style=""> 739          mFis = null;                                                                                              </span>
<span class="-556680889075439690" onmouseenter="enter('-556680889075439690');" onmouseout="out('-556680889075439690');" style=""> 740          mAppInstallToken = -1;                                                                                    </span>
<span class="-4341770816803766254" onmouseenter="enter('-4341770816803766254');" onmouseout="out('-4341770816803766254');" style=""> 741          mInstallSlot = -2;                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 742      }                                                                                                             </span>
<span  style=""> 743                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 744      @Override                                                                                                     </span>
<span class="-4556626830840513273" onmouseenter="enter('-4556626830840513273');" onmouseout="out('-4556626830840513273');" style=""> 745      public void quit() {                                                                                          </span>
<span class="-2245059810018305386" onmouseenter="enter('-2245059810018305386');" onmouseout="out('-2245059810018305386');" style=""> 746          mQuit = true;                                                                                             </span>
<span class="-3944229288018059276" onmouseenter="enter('-3944229288018059276');" onmouseout="out('-3944229288018059276');" style=""> 747          if (mBtSocket != null) {                                                                                  </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 748              try {                                                                                                 </span>
<span class="4957759683762229483" onmouseenter="enter('4957759683762229483');" onmouseout="out('4957759683762229483');" style=""> 749                  mBtSocket.close();                                                                                </span>
<span class="-8338918978083861071" onmouseenter="enter('-8338918978083861071');" onmouseout="out('-8338918978083861071');" style=""> 750              } catch (IOException ignored) {                                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 751              }                                                                                                     </span>
<span class="-4534501040604870855" onmouseenter="enter('-4534501040604870855');" onmouseout="out('-4534501040604870855');" style=""> 752              mBtSocket = null;                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 753          }                                                                                                         </span>
<span class="3388558050890258608" onmouseenter="enter('3388558050890258608');" onmouseout="out('3388558050890258608');" style=""> 754          if (mTCPSocket != null) {                                                                                 </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 755              try {                                                                                                 </span>
<span class="1317722495006749576" onmouseenter="enter('1317722495006749576');" onmouseout="out('1317722495006749576');" style=""> 756                  mTCPSocket.close();                                                                               </span>
<span class="-8338918978083861071" onmouseenter="enter('-8338918978083861071');" onmouseout="out('-8338918978083861071');" style=""> 757              } catch (IOException ignored) {                                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 758              }                                                                                                     </span>
<span class="4396162940795265492" onmouseenter="enter('4396162940795265492');" onmouseout="out('4396162940795265492');" style=""> 759              mTCPSocket = null;                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 760          }                                                                                                         </span>
<span class="-5320890524666996917" onmouseenter="enter('-5320890524666996917');" onmouseout="out('-5320890524666996917');" style=""> 761          if (mPebbleLESupport != null) {                                                                           </span>
<span class="-997532962857791838" onmouseenter="enter('-997532962857791838');" onmouseout="out('-997532962857791838');" style=""> 762              mPebbleLESupport.close();                                                                             </span>
<span class="-2496993078705938002" onmouseenter="enter('-2496993078705938002');" onmouseout="out('-2496993078705938002');" style=""> 763              mPebbleLESupport = null;                                                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 764          }                                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 765      }                                                                                                             </span>
<span  style=""> 766                                                                                                                    </span>
<span class="-4681179840421673206" onmouseenter="enter('-4681179840421673206');" onmouseout="out('-4681179840421673206');" style=""> 767      private enum PebbleAppInstallState {                                                                          </span>
<span class="8504698099528295248" onmouseenter="enter('8504698099528295248');" onmouseout="out('8504698099528295248');" style=""> 768          UNKNOWN,                                                                                                  </span>
<span class="-8062507015798429311" onmouseenter="enter('-8062507015798429311');" onmouseout="out('-8062507015798429311');" style=""> 769          WAIT_SLOT,                                                                                                </span>
<span class="-668951604036061853" onmouseenter="enter('-668951604036061853');" onmouseout="out('-668951604036061853');" style=""> 770          START_INSTALL,                                                                                            </span>
<span class="-1678353837526561027" onmouseenter="enter('-1678353837526561027');" onmouseout="out('-1678353837526561027');" style=""> 771          WAIT_TOKEN,                                                                                               </span>
<span class="-2676567537573092080" onmouseenter="enter('-2676567537573092080');" onmouseout="out('-2676567537573092080');" style=""> 772          UPLOAD_CHUNK,                                                                                             </span>
<span class="-1008243733279055296" onmouseenter="enter('-1008243733279055296');" onmouseout="out('-1008243733279055296');" style=""> 773          UPLOAD_COMMIT,                                                                                            </span>
<span class="-8287073352459983195" onmouseenter="enter('-8287073352459983195');" onmouseout="out('-8287073352459983195');" style=""> 774          WAIT_COMMIT,                                                                                              </span>
<span class="-4008830795114372846" onmouseenter="enter('-4008830795114372846');" onmouseout="out('-4008830795114372846');" style=""> 775          UPLOAD_COMPLETE,                                                                                          </span>
<span class="667328612202802083" onmouseenter="enter('667328612202802083');" onmouseout="out('667328612202802083');" style=""> 776          APP_REFRESH,                                                                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 777      }                                                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 778  }                                                                                                                 </span></pre></td>
                            <td><pre><span class="-5771549642386131488" onmouseenter="enter('-5771549642386131488');" onmouseout="out('-5771549642386131488');" style="">   1  package nodomain.freeyourgadget.gadgetbridge.service.devices.pebble;                                              </span>
<span  style="">   2                                                                                                                    </span>
<span class="-8028506601233233593" onmouseenter="enter('-8028506601233233593');" onmouseout="out('-8028506601233233593');" style="">   3  import android.bluetooth.BluetoothAdapter;                                                                        </span>
<span class="2859895893394018468" onmouseenter="enter('2859895893394018468');" onmouseout="out('2859895893394018468');" style="">   4  import android.bluetooth.BluetoothDevice;                                                                         </span>
<span class="634810844753697830" onmouseenter="enter('634810844753697830');" onmouseout="out('634810844753697830');" style="">   5  import android.bluetooth.BluetoothSocket;                                                                         </span>
<span class="-489389385851058391" onmouseenter="enter('-489389385851058391');" onmouseout="out('-489389385851058391');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">   6 -import android.content.BroadcastReceiver;                                                                         </span>
<span class="5922045460006936195" onmouseenter="enter('5922045460006936195');" onmouseout="out('5922045460006936195');" style="">   7  import android.content.Context;                                                                                   </span>
<span class="6568903789857736568" onmouseenter="enter('6568903789857736568');" onmouseout="out('6568903789857736568');" style="">   8  import android.content.Intent;                                                                                    </span>
<span class="8697221465021235869" onmouseenter="enter('8697221465021235869');" onmouseout="out('8697221465021235869');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">   9 -import android.content.IntentFilter;                                                                              </span>
<span class="-8750621697125156872" onmouseenter="enter('-8750621697125156872');" onmouseout="out('-8750621697125156872');" style="">  10  import android.net.Uri;                                                                                           </span>
<span class="8301908088148850736" onmouseenter="enter('8301908088148850736');" onmouseout="out('8301908088148850736');" style="">  11  import android.os.ParcelUuid;                                                                                     </span>
<span class="2517521963771876570" onmouseenter="enter('2517521963771876570');" onmouseout="out('2517521963771876570');" style="">  12  import android.support.v4.content.LocalBroadcastManager;                                                          </span>
<span  style="">  13                                                                                                                    </span>
<span class="-9193129351684262878" onmouseenter="enter('-9193129351684262878');" onmouseout="out('-9193129351684262878');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  14 -import org.json.JSONArray;                                                                                        </span>
<span class="-8573375701834280359" onmouseenter="enter('-8573375701834280359');" onmouseout="out('-8573375701834280359');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  15 -import org.json.JSONException;                                                                                    </span>
<span class="9072327285961251154" onmouseenter="enter('9072327285961251154');" onmouseout="out('9072327285961251154');" style="">  16  import org.slf4j.Logger;                                                                                          </span>
<span class="697043352225962606" onmouseenter="enter('697043352225962606');" onmouseout="out('697043352225962606');" style="">  17  import org.slf4j.LoggerFactory;                                                                                   </span>
<span  style="">  18                                                                                                                    </span>
<span class="-3926401431737521278" onmouseenter="enter('-3926401431737521278');" onmouseout="out('-3926401431737521278');" style="">  19  import java.io.File;                                                                                              </span>
<span class="-75475733228177869" onmouseenter="enter('-75475733228177869');" onmouseout="out('-75475733228177869');" style="">  20  import java.io.FileNotFoundException;                                                                             </span>
<span class="103340661636203254" onmouseenter="enter('103340661636203254');" onmouseout="out('103340661636203254');" style="">  21  import java.io.IOException;                                                                                       </span>
<span class="5631563232245871054" onmouseenter="enter('5631563232245871054');" onmouseout="out('5631563232245871054');" style="">  22  import java.io.InputStream;                                                                                       </span>
<span class="4621164050749610193" onmouseenter="enter('4621164050749610193');" onmouseout="out('4621164050749610193');" style="">  23  import java.io.OutputStream;                                                                                      </span>
<span class="-4777627942089262832" onmouseenter="enter('-4777627942089262832');" onmouseout="out('-4777627942089262832');" style="">  24  import java.io.PipedInputStream;                                                                                  </span>
<span class="5026237307424376420" onmouseenter="enter('5026237307424376420');" onmouseout="out('5026237307424376420');" style="">  25  import java.io.PipedOutputStream;                                                                                 </span>
<span class="-5790770097715703577" onmouseenter="enter('-5790770097715703577');" onmouseout="out('-5790770097715703577');" style="">  26  import java.net.InetAddress;                                                                                      </span>
<span class="-623186069646925252" onmouseenter="enter('-623186069646925252');" onmouseout="out('-623186069646925252');" style="">  27  import java.net.Socket;                                                                                           </span>
<span class="-6886346622632588502" onmouseenter="enter('-6886346622632588502');" onmouseout="out('-6886346622632588502');" style="">  28  import java.nio.ByteBuffer;                                                                                       </span>
<span class="-4536046119683402321" onmouseenter="enter('-4536046119683402321');" onmouseout="out('-4536046119683402321');" style="">  29  import java.nio.ByteOrder;                                                                                        </span>
<span class="2390503830490498598" onmouseenter="enter('2390503830490498598');" onmouseout="out('2390503830490498598');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  30 -import java.util.UUID;                                                                                            </span>
<span  style="">  31                                                                                                                    </span>
<span class="-8113221927992302576" onmouseenter="enter('-8113221927992302576');" onmouseout="out('-8113221927992302576');" style="">  32  import nodomain.freeyourgadget.gadgetbridge.GBApplication;                                                        </span>
<span class="-7198279398549834921" onmouseenter="enter('-7198279398549834921');" onmouseout="out('-7198279398549834921');" style="">  33  import nodomain.freeyourgadget.gadgetbridge.R;                                                                    </span>
<span class="5959948573825064529" onmouseenter="enter('5959948573825064529');" onmouseout="out('5959948573825064529');" style="">  34  import nodomain.freeyourgadget.gadgetbridge.activities.appmanager.AbstractAppManagerFragment;                     </span>
<span class="-7454882487459214858" onmouseenter="enter('-7454882487459214858');" onmouseout="out('-7454882487459214858');" style="">  35  import nodomain.freeyourgadget.gadgetbridge.activities.appmanager.AppManagerActivity;                             </span>
<span class="8774236294555479386" onmouseenter="enter('8774236294555479386');" onmouseout="out('8774236294555479386');" style="">  36  import nodomain.freeyourgadget.gadgetbridge.deviceevents.GBDeviceEvent;                                           </span>
<span class="-4700446920707564194" onmouseenter="enter('-4700446920707564194');" onmouseout="out('-4700446920707564194');" style="">  37  import nodomain.freeyourgadget.gadgetbridge.deviceevents.GBDeviceEventAppInfo;                                    </span>
<span class="-5686102242644058946" onmouseenter="enter('-5686102242644058946');" onmouseout="out('-5686102242644058946');" style="">  38  import nodomain.freeyourgadget.gadgetbridge.deviceevents.GBDeviceEventAppManagement;                              </span>
<span class="2791890994602016761" onmouseenter="enter('2791890994602016761');" onmouseout="out('2791890994602016761');" style="">  39  import nodomain.freeyourgadget.gadgetbridge.deviceevents.GBDeviceEventAppMessage;                                 </span>
<span class="7456778970616733409" onmouseenter="enter('7456778970616733409');" onmouseout="out('7456778970616733409');" style="">  40  import nodomain.freeyourgadget.gadgetbridge.deviceevents.GBDeviceEventVersionInfo;                                </span>
<span class="-8786909529118259831" onmouseenter="enter('-8786909529118259831');" onmouseout="out('-8786909529118259831');" style="">  41  import nodomain.freeyourgadget.gadgetbridge.devices.pebble.PBWReader;                                             </span>
<span class="-6745962823678362300" onmouseenter="enter('-6745962823678362300');" onmouseout="out('-6745962823678362300');" style="">  42  import nodomain.freeyourgadget.gadgetbridge.devices.pebble.PebbleInstallable;                                     </span>
<span class="4836892992022606579" onmouseenter="enter('4836892992022606579');" onmouseout="out('4836892992022606579');" style="">  43  import nodomain.freeyourgadget.gadgetbridge.impl.GBDevice;                                                        </span>
<span class="-6775704228596592306" onmouseenter="enter('-6775704228596592306');" onmouseout="out('-6775704228596592306');" style="">  44  import nodomain.freeyourgadget.gadgetbridge.impl.GBDeviceApp;                                                     </span>
<span class="-1754164907108633436" onmouseenter="enter('-1754164907108633436');" onmouseout="out('-1754164907108633436');" style="">  45  import nodomain.freeyourgadget.gadgetbridge.service.devices.pebble.ble.PebbleLESupport;                           </span>
<span class="-211901022449891328" onmouseenter="enter('-211901022449891328');" onmouseout="out('-211901022449891328');" style="">  46  import nodomain.freeyourgadget.gadgetbridge.service.serial.GBDeviceIoThread;                                      </span>
<span class="-2195471833159259314" onmouseenter="enter('-2195471833159259314');" onmouseout="out('-2195471833159259314');" style="">  47  import nodomain.freeyourgadget.gadgetbridge.service.serial.GBDeviceProtocol;                                      </span>
<span class="-2020231768395052380" onmouseenter="enter('-2020231768395052380');" onmouseout="out('-2020231768395052380');" style="">  48  import nodomain.freeyourgadget.gadgetbridge.util.FileUtils;                                                       </span>
<span class="-3798970344596478499" onmouseenter="enter('-3798970344596478499');" onmouseout="out('-3798970344596478499');" style="">  49  import nodomain.freeyourgadget.gadgetbridge.util.GB;                                                              </span>
<span class="4645284583739884744" onmouseenter="enter('4645284583739884744');" onmouseout="out('4645284583739884744');" style="">  50  import nodomain.freeyourgadget.gadgetbridge.util.PebbleUtils;                                                     </span>
<span class="-600862318521663319" onmouseenter="enter('-600862318521663319');" onmouseout="out('-600862318521663319');" style="">  51  import nodomain.freeyourgadget.gadgetbridge.util.Prefs;                                                           </span>

<span  style="">  52                                                                                                                    </span>
<span class="2468896418036970449" onmouseenter="enter('2468896418036970449');" onmouseout="out('2468896418036970449');" style="">  53  class PebbleIoThread extends GBDeviceIoThread {                                                                   </span>
<span class="2529670288626938632" onmouseenter="enter('2529670288626938632');" onmouseout="out('2529670288626938632');" style="">  54      private static final Logger LOG = LoggerFactory.getLogger(PebbleIoThread.class);                              </span>
<span  style="">  55                                                                                                                    </span>
<span class="1479268761712237268" onmouseenter="enter('1479268761712237268');" onmouseout="out('1479268761712237268');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  56 -    public static final String PEBBLEKIT_ACTION_PEBBLE_CONNECTED = &quot;com.getpebble.action.PEBBLE_CONNECTED&quot;;       </span>
<span class="-8930340505705554172" onmouseenter="enter('-8930340505705554172');" onmouseout="out('-8930340505705554172');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  57 -    public static final String PEBBLEKIT_ACTION_PEBBLE_DISCONNECTED = &quot;com.getpebble.action.PEBBLE_DISCONNECTED&quot;; </span>
<span class="-590329691308595480" onmouseenter="enter('-590329691308595480');" onmouseout="out('-590329691308595480');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  58 -    public static final String PEBBLEKIT_ACTION_APP_ACK = &quot;com.getpebble.action.app.ACK&quot;;                         </span>
<span class="-4316471762220819117" onmouseenter="enter('-4316471762220819117');" onmouseout="out('-4316471762220819117');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  59 -    public static final String PEBBLEKIT_ACTION_APP_NACK = &quot;com.getpebble.action.app.NACK&quot;;                       </span>
<span class="-515673483701715475" onmouseenter="enter('-515673483701715475');" onmouseout="out('-515673483701715475');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  60 -    public static final String PEBBLEKIT_ACTION_APP_RECEIVE = &quot;com.getpebble.action.app.RECEIVE&quot;;                 </span>
<span class="7680988297485466728" onmouseenter="enter('7680988297485466728');" onmouseout="out('7680988297485466728');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  61 -    public static final String PEBBLEKIT_ACTION_APP_RECEIVE_ACK = &quot;com.getpebble.action.app.RECEIVE_ACK&quot;;         </span>
<span class="-5341535895791433959" onmouseenter="enter('-5341535895791433959');" onmouseout="out('-5341535895791433959');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  62 -    public static final String PEBBLEKIT_ACTION_APP_RECEIVE_NACK = &quot;com.getpebble.action.app.RECEIVE_NACK&quot;;       </span>
<span class="-5791901289448816338" onmouseenter="enter('-5791901289448816338');" onmouseout="out('-5791901289448816338');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  63 -    public static final String PEBBLEKIT_ACTION_APP_SEND = &quot;com.getpebble.action.app.SEND&quot;;                       </span>
<span class="-578296603915012056" onmouseenter="enter('-578296603915012056');" onmouseout="out('-578296603915012056');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  64 -    public static final String PEBBLEKIT_ACTION_APP_START = &quot;com.getpebble.action.app.START&quot;;                     </span>
<span class="118647857632734400" onmouseenter="enter('118647857632734400');" onmouseout="out('118647857632734400');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  65 -    public static final String PEBBLEKIT_ACTION_APP_STOP = &quot;com.getpebble.action.app.STOP&quot;;                       </span>
<span  style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  66 -                                                                                                                  </span>
<span class="-4632193205469069671" onmouseenter="enter('-4632193205469069671');" onmouseout="out('-4632193205469069671');" style="">  67      private final Prefs prefs = GBApplication.getPrefs();                                                         </span>
<span  style="">  68                                                                                                                    </span>
<span class="-6631401332787692352" onmouseenter="enter('-6631401332787692352');" onmouseout="out('-6631401332787692352');" style="">  69      private final PebbleProtocol mPebbleProtocol;                                                                 </span>
<span class="1328262475374241602" onmouseenter="enter('1328262475374241602');" onmouseout="out('1328262475374241602');" style="">  70      private final PebbleSupport mPebbleSupport;                                                                   </span>
<span class="-2685935515172486802" onmouseenter="enter('-2685935515172486802');" onmouseout="out('-2685935515172486802');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  71 +    private PebbleKitSupport mPebbleKitSupport;                                                                   </span>
<span class="5255281464364524557" onmouseenter="enter('5255281464364524557');" onmouseout="out('5255281464364524557');" style="">  72      private final boolean mEnablePebblekit;                                                                       </span>
<span  style="">  73                                                                                                                    </span>
<span class="-1663504808667212623" onmouseenter="enter('-1663504808667212623');" onmouseout="out('-1663504808667212623');" style="">  74      private boolean mIsTCP = false;                                                                               </span>
<span class="7891956114489637668" onmouseenter="enter('7891956114489637668');" onmouseout="out('7891956114489637668');" style="">  75      private BluetoothAdapter mBtAdapter = null;                                                                   </span>
<span class="-3474230100367526093" onmouseenter="enter('-3474230100367526093');" onmouseout="out('-3474230100367526093');" style="">  76      private BluetoothSocket mBtSocket = null;                                                                     </span>
<span class="4972621324459114153" onmouseenter="enter('4972621324459114153');" onmouseout="out('4972621324459114153');" style="">  77      private Socket mTCPSocket = null; // for emulator                                                             </span>
<span class="8464954913827308931" onmouseenter="enter('8464954913827308931');" onmouseout="out('8464954913827308931');" style="">  78      private InputStream mInStream = null;                                                                         </span>
<span class="176817746371882191" onmouseenter="enter('176817746371882191');" onmouseout="out('176817746371882191');" style="">  79      private OutputStream mOutStream = null;                                                                       </span>
<span class="3507668063671934062" onmouseenter="enter('3507668063671934062');" onmouseout="out('3507668063671934062');" style="">  80      private PebbleLESupport mPebbleLESupport;                                                                     </span>
<span  style="">  81                                                                                                                    </span>
<span class="8291227991234502986" onmouseenter="enter('8291227991234502986');" onmouseout="out('8291227991234502986');" style="">  82      private boolean mQuit = false;                                                                                </span>
<span class="-4308649044970502514" onmouseenter="enter('-4308649044970502514');" onmouseout="out('-4308649044970502514');" style="">  83      private boolean mIsConnected = false;                                                                         </span>
<span class="591172670703241498" onmouseenter="enter('591172670703241498');" onmouseout="out('591172670703241498');" style="">  84      private boolean mIsInstalling = false;                                                                        </span>
<span  style="">  85                                                                                                                    </span>
<span class="7746276727914849634" onmouseenter="enter('7746276727914849634');" onmouseout="out('7746276727914849634');" style="">  86      private PBWReader mPBWReader = null;                                                                          </span>
<span class="1166586313023966318" onmouseenter="enter('1166586313023966318');" onmouseout="out('1166586313023966318');" style="">  87      private GBDeviceApp mCurrentlyInstallingApp = null;                                                           </span>
<span class="-1645742411754742536" onmouseenter="enter('-1645742411754742536');" onmouseout="out('-1645742411754742536');" style="">  88      private int mAppInstallToken = -1;                                                                            </span>
<span class="-3680441812231545667" onmouseenter="enter('-3680441812231545667');" onmouseout="out('-3680441812231545667');" style="">  89      private InputStream mFis = null;                                                                              </span>
<span class="8056811120544011853" onmouseenter="enter('8056811120544011853');" onmouseout="out('8056811120544011853');" style="">  90      private PebbleAppInstallState mInstallState = PebbleAppInstallState.UNKNOWN;                                  </span>
<span class="2315852437300231853" onmouseenter="enter('2315852437300231853');" onmouseout="out('2315852437300231853');" style="">  91      private PebbleInstallable[] mPebbleInstallables = null;                                                       </span>
<span class="-6610002799635202363" onmouseenter="enter('-6610002799635202363');" onmouseout="out('-6610002799635202363');" style="">  92      private int mCurrentInstallableIndex = -1;                                                                    </span>
<span class="-6569382683370215618" onmouseenter="enter('-6569382683370215618');" onmouseout="out('-6569382683370215618');" style="">  93      private int mInstallSlot = -2;                                                                                </span>
<span class="-8194648222476538160" onmouseenter="enter('-8194648222476538160');" onmouseout="out('-8194648222476538160');" style="">  94      private int mCRC = -1;                                                                                        </span>
<span class="-2481332028036817904" onmouseenter="enter('-2481332028036817904');" onmouseout="out('-2481332028036817904');" style="">  95      private int mBinarySize = -1;                                                                                 </span>
<span class="-1832879895999614218" onmouseenter="enter('-1832879895999614218');" onmouseout="out('-1832879895999614218');" style="">  96      private int mBytesWritten = -1;                                                                               </span>
<span  style="">  97                                                                                                                    </span>
<span class="8914325663092470246" onmouseenter="enter('8914325663092470246');" onmouseout="out('8914325663092470246');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  98 -    private final BroadcastReceiver mPebbleKitReceiver = new BroadcastReceiver() {                                </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  99 -        @Override                                                                                                 </span>
<span class="-1520739091809898546" onmouseenter="enter('-1520739091809898546');" onmouseout="out('-1520739091809898546');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 100 -        public void onReceive(Context context, Intent intent) {                                                   </span>
<span class="5344227773413700857" onmouseenter="enter('5344227773413700857');" onmouseout="out('5344227773413700857');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 101 -            String action = intent.getAction();                                                                   </span>
<span class="-2767557360944414006" onmouseenter="enter('-2767557360944414006');" onmouseout="out('-2767557360944414006');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 102 -            LOG.info(&quot;Got action: &quot; + action);                                                                    </span>
<span class="8190723481817549581" onmouseenter="enter('8190723481817549581');" onmouseout="out('8190723481817549581');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 103 -            UUID uuid;                                                                                            </span>
<span class="6099627150369302694" onmouseenter="enter('6099627150369302694');" onmouseout="out('6099627150369302694');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 104 -            switch (action) {                                                                                     </span>
<span class="-5607690174400779115" onmouseenter="enter('-5607690174400779115');" onmouseout="out('-5607690174400779115');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 105 -                case PEBBLEKIT_ACTION_APP_START:                                                                  </span>
<span class="-1756369772806174160" onmouseenter="enter('-1756369772806174160');" onmouseout="out('-1756369772806174160');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 106 -                case PEBBLEKIT_ACTION_APP_STOP:                                                                   </span>
<span class="-185467528302823505" onmouseenter="enter('-185467528302823505');" onmouseout="out('-185467528302823505');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 107 -                    uuid = (UUID) intent.getSerializableExtra(&quot;uuid&quot;);                                            </span>
<span class="6094803455832882033" onmouseenter="enter('6094803455832882033');" onmouseout="out('6094803455832882033');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 108 -                    if (uuid != null) {                                                                           </span>
<span class="-3038014536715207103" onmouseenter="enter('-3038014536715207103');" onmouseout="out('-3038014536715207103');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 109 -                        write(mPebbleProtocol.encodeAppStart(uuid, action.equals(PEBBLEKIT_ACTION_APP_START)));   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 110 -                    }                                                                                             </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 111 -                    break;                                                                                        </span>
<span class="3550381777945223205" onmouseenter="enter('3550381777945223205');" onmouseout="out('3550381777945223205');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 112 -                case PEBBLEKIT_ACTION_APP_SEND:                                                                   </span>
<span class="8746871362101842242" onmouseenter="enter('8746871362101842242');" onmouseout="out('8746871362101842242');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 113 -                    int transaction_id = intent.getIntExtra(&quot;transaction_id&quot;, -1);                                </span>
<span class="-185467528302823505" onmouseenter="enter('-185467528302823505');" onmouseout="out('-185467528302823505');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 114 -                    uuid = (UUID) intent.getSerializableExtra(&quot;uuid&quot;);                                            </span>
<span class="115505315270435118" onmouseenter="enter('115505315270435118');" onmouseout="out('115505315270435118');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 115 -                    String jsonString = intent.getStringExtra(&quot;msg_data&quot;);                                        </span>
<span class="1347360621013773363" onmouseenter="enter('1347360621013773363');" onmouseout="out('1347360621013773363');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 116 -                    LOG.info(&quot;json string: &quot; + jsonString);                                                       </span>
<span  style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 117 -                                                                                                                  </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 118 -                    try {                                                                                         </span>
<span class="6685187839340796030" onmouseenter="enter('6685187839340796030');" onmouseout="out('6685187839340796030');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 119 -                        JSONArray jsonArray = new JSONArray(jsonString);                                          </span>
<span class="1915657714539023329" onmouseenter="enter('1915657714539023329');" onmouseout="out('1915657714539023329');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 120 -                        write(mPebbleProtocol.encodeApplicationMessageFromJSON(uuid, jsonArray));                 </span>
<span class="4286948008967663548" onmouseenter="enter('4286948008967663548');" onmouseout="out('4286948008967663548');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 121 -                        sendAppMessageAck(transaction_id);                                                        </span>
<span  style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 122 -                                                                                                                  </span>
<span class="2021063483207698984" onmouseenter="enter('2021063483207698984');" onmouseout="out('2021063483207698984');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 123 -                    } catch (JSONException e) {                                                                   </span>
<span class="4090663313211582937" onmouseenter="enter('4090663313211582937');" onmouseout="out('4090663313211582937');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 124 -                        e.printStackTrace();                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 125 -                    }                                                                                             </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 126 -                    break;                                                                                        </span>
<span class="-4575626246346919371" onmouseenter="enter('-4575626246346919371');" onmouseout="out('-4575626246346919371');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 127 -                case PEBBLEKIT_ACTION_APP_ACK:                                                                    </span>
<span class="-5397546053733935151" onmouseenter="enter('-5397546053733935151');" onmouseout="out('-5397546053733935151');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"><abbr title=" 128 -                    // we do not get a uuid and cannot map a transaction id to it, so we ack in PebbleProtocol early"> 128 -                    // we do not get a uuid and cannot map a transaction id to it, so we ack in PebbleProtocol earðŸ”µ</abbr></span>
<span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 129 -                    /*                                                                                            </span>
<span class="-185467528302823505" onmouseenter="enter('-185467528302823505');" onmouseout="out('-185467528302823505');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 130 -                    uuid = (UUID) intent.getSerializableExtra(&quot;uuid&quot;);                                            </span>
<span class="8746871362101842242" onmouseenter="enter('8746871362101842242');" onmouseout="out('8746871362101842242');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 131 -                    int transaction_id = intent.getIntExtra(&quot;transaction_id&quot;, -1);                                </span>
<span class="-5460339056046386879" onmouseenter="enter('-5460339056046386879');" onmouseout="out('-5460339056046386879');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 132 -                    if (transaction_id &gt;= 0 &amp;&amp; transaction_id &lt;= 255) {                                           </span>
<span class="-1247931610264669179" onmouseenter="enter('-1247931610264669179');" onmouseout="out('-1247931610264669179');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 133 -                        write(mPebbleProtocol.encodeApplicationMessageAck(uuid, (byte) transaction_id));          </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 134 -                    } else {                                                                                      </span>
<span class="9187855197608677341" onmouseenter="enter('9187855197608677341');" onmouseout="out('9187855197608677341');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 135 -                        LOG.warn(&quot;illegal transacktion id &quot; + transaction_id);                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 136 -                    }                                                                                             </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 137 -                    */                                                                                            </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 138 -                    break;                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 139 -            }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 140 -        }                                                                                                         </span>
<span class="2468309323999483380" onmouseenter="enter('2468309323999483380');" onmouseout="out('2468309323999483380');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 141 -    };                                                                                                            </span>





<span  style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 142 -                                                                                                                  </span>
<span class="-7621847952583919612" onmouseenter="enter('-7621847952583919612');" onmouseout="out('-7621847952583919612');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 143 -    private void sendAppMessageIntent(GBDeviceEventAppMessage appMessage) {                                       </span>
<span class="535862575394010177" onmouseenter="enter('535862575394010177');" onmouseout="out('535862575394010177');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 144 -        Intent intent = new Intent();                                                                             </span>
<span class="-308940498243775713" onmouseenter="enter('-308940498243775713');" onmouseout="out('-308940498243775713');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 145 -        intent.setAction(PEBBLEKIT_ACTION_APP_RECEIVE);                                                           </span>
<span class="-4819521277987879596" onmouseenter="enter('-4819521277987879596');" onmouseout="out('-4819521277987879596');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 146 -        intent.putExtra(&quot;uuid&quot;, appMessage.appUUID);                                                              </span>
<span class="-4518626450248788495" onmouseenter="enter('-4518626450248788495');" onmouseout="out('-4518626450248788495');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 147 -        intent.putExtra(&quot;msg_data&quot;, appMessage.message);                                                          </span>
<span class="788400804283391840" onmouseenter="enter('788400804283391840');" onmouseout="out('788400804283391840');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 148 -        intent.putExtra(&quot;transaction_id&quot;, appMessage.id);                                                         </span>
<span class="-877666395707968466" onmouseenter="enter('-877666395707968466');" onmouseout="out('-877666395707968466');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"><abbr title=" 149 -        LOG.info(&quot;broadcasting to uuid &quot; + appMessage.appUUID + &quot; transaction id: &quot; + appMessage.id + &quot; JSON: &quot; + appMessage.message);"> 149 -        LOG.info(&quot;broadcasting to uuid &quot; + appMessage.appUUID + &quot; transaction id: &quot; + appMessage.id + &quot; JSON: &quot; + ðŸ”µ</abbr></span>
<span class="5781834444291540387" onmouseenter="enter('5781834444291540387');" onmouseout="out('5781834444291540387');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 150 -        getContext().sendBroadcast(intent);                                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 151 -    }                                                                                                             </span>
<span  style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 152 -                                                                                                                  </span>
<span class="-1707422926868996417" onmouseenter="enter('-1707422926868996417');" onmouseout="out('-1707422926868996417');" style=""><abbr title=" 153      PebbleIoThread(PebbleSupport pebbleSupport, GBDevice gbDevice, GBDeviceProtocol gbDeviceProtocol, BluetoothAdapter btAdapter, Context context) {"> 153      PebbleIoThread(PebbleSupport pebbleSupport, GBDevice gbDevice, GBDeviceProtocol gbDeviceProtocol, BluetoothAdaðŸ”µ</abbr></span>
<span class="-4446577987516131269" onmouseenter="enter('-4446577987516131269');" onmouseout="out('-4446577987516131269');" style=""> 154          super(gbDevice, context);                                                                                 </span>
<span class="-535847603056830094" onmouseenter="enter('-535847603056830094');" onmouseout="out('-535847603056830094');" style=""> 155          mPebbleProtocol = (PebbleProtocol) gbDeviceProtocol;                                                      </span>
<span class="-7802515276203668031" onmouseenter="enter('-7802515276203668031');" onmouseout="out('-7802515276203668031');" style=""> 156          mBtAdapter = btAdapter;                                                                                   </span>
<span class="-175348863880720182" onmouseenter="enter('-175348863880720182');" onmouseout="out('-175348863880720182');" style=""> 157          mPebbleSupport = pebbleSupport;                                                                           </span>
<span class="-766654887411083682" onmouseenter="enter('-766654887411083682');" onmouseout="out('-766654887411083682');" style=""> 158          mEnablePebblekit = prefs.getBoolean(&quot;pebble_enable_pebblekit&quot;, false);                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 159      }                                                                                                             </span>
<span  style=""> 160                                                                                                                    </span>
<span class="-2292081679562824726" onmouseenter="enter('-2292081679562824726');" onmouseout="out('-2292081679562824726');" style=""><abbr title=" 161      private int readWithException(InputStream inputStream, byte[] buffer, int byteOffset, int byteCount) throws IOException {"> 161      private int readWithException(InputStream inputStream, byte[] buffer, int byteOffset, int byteCount) throws IOðŸ”µ</abbr></span>
<span class="4268945675950741459" onmouseenter="enter('4268945675950741459');" onmouseout="out('4268945675950741459');" style=""> 162          int ret = inputStream.read(buffer, byteOffset, byteCount);                                                </span>
<span class="3796083344931271004" onmouseenter="enter('3796083344931271004');" onmouseout="out('3796083344931271004');" style=""> 163          if (ret == -1) {                                                                                          </span>
<span class="8493867222528380496" onmouseenter="enter('8493867222528380496');" onmouseout="out('8493867222528380496');" style=""> 164              throw new IOException(&quot;broken pipe&quot;);                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 165          }                                                                                                         </span>
<span class="1456633081770441725" onmouseenter="enter('1456633081770441725');" onmouseout="out('1456633081770441725');" style=""> 166          return ret;                                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 167 -    }                                                                                                             </span>
<span  style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 168 -                                                                                                                  </span>
<span class="6736273159384894223" onmouseenter="enter('6736273159384894223');" onmouseout="out('6736273159384894223');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 169 -    private void sendAppMessageAck(int transactionId) {                                                           </span>
<span class="535862575394010177" onmouseenter="enter('535862575394010177');" onmouseout="out('535862575394010177');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 170 -        Intent intent = new Intent();                                                                             </span>
<span class="6082629123571614655" onmouseenter="enter('6082629123571614655');" onmouseout="out('6082629123571614655');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 171 -        intent.setAction(PEBBLEKIT_ACTION_APP_RECEIVE_ACK);                                                       </span>
<span class="8324089998886508665" onmouseenter="enter('8324089998886508665');" onmouseout="out('8324089998886508665');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 172 -        intent.putExtra(&quot;transaction_id&quot;, transactionId);                                                         </span>
<span class="2649247922579921710" onmouseenter="enter('2649247922579921710');" onmouseout="out('2649247922579921710');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 173 -        LOG.info(&quot;broadcasting ACK (transaction id &quot; + transactionId + &quot;)&quot;);                                      </span>
<span class="5781834444291540387" onmouseenter="enter('5781834444291540387');" onmouseout="out('5781834444291540387');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 174 -        getContext().sendBroadcast(intent);                                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 175      }                                                                                                             </span>
<span  style=""> 176                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 177      @Override                                                                                                     </span>
<span class="-689441939839417419" onmouseenter="enter('-689441939839417419');" onmouseout="out('-689441939839417419');" style=""> 178      protected boolean connect() {                                                                                 </span>
<span class="7179548470555074529" onmouseenter="enter('7179548470555074529');" onmouseout="out('7179548470555074529');" style=""> 179          String deviceAddress = gbDevice.getAddress();                                                             </span>
<span class="8603377014623514599" onmouseenter="enter('8603377014623514599');" onmouseout="out('8603377014623514599');" style=""> 180          GBDevice.State originalState = gbDevice.getState();                                                       </span>
<span class="-2168554989878345062" onmouseenter="enter('-2168554989878345062');" onmouseout="out('-2168554989878345062');" style=""> 181          gbDevice.setState(GBDevice.State.CONNECTING);                                                             </span>
<span class="-6083303279196581322" onmouseenter="enter('-6083303279196581322');" onmouseout="out('-6083303279196581322');" style=""> 182          gbDevice.sendDeviceUpdateIntent(getContext());                                                            </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 183          try {                                                                                                     </span>
<span class="-8563020019953546005" onmouseenter="enter('-8563020019953546005');" onmouseout="out('-8563020019953546005');" style=""> 184              // contains only one &quot;:&quot;? then it is addr:port                                                        </span>
<span class="-146660580149754487" onmouseenter="enter('-146660580149754487');" onmouseout="out('-146660580149754487');" style=""> 185              int firstColon = deviceAddress.indexOf(&quot;:&quot;);                                                          </span>
<span class="5048700417952215836" onmouseenter="enter('5048700417952215836');" onmouseout="out('5048700417952215836');" style=""> 186              if (firstColon == deviceAddress.lastIndexOf(&quot;:&quot;)) {                                                   </span>
<span class="-8977049560738769524" onmouseenter="enter('-8977049560738769524');" onmouseout="out('-8977049560738769524');" style=""> 187                  mIsTCP = true;                                                                                    </span>
<span class="-6378857250762995034" onmouseenter="enter('-6378857250762995034');" onmouseout="out('-6378857250762995034');" style=""> 188                  InetAddress serverAddr = InetAddress.getByName(deviceAddress.substring(0, firstColon));           </span>
<span class="3468657720829688371" onmouseenter="enter('3468657720829688371');" onmouseout="out('3468657720829688371');" style=""> 189                  mTCPSocket = new Socket(serverAddr, Integer.parseInt(deviceAddress.substring(firstColon + 1)));   </span>
<span class="-6670767050188612078" onmouseenter="enter('-6670767050188612078');" onmouseout="out('-6670767050188612078');" style=""> 190                  mInStream = mTCPSocket.getInputStream();                                                          </span>
<span class="-6104065159882353101" onmouseenter="enter('-6104065159882353101');" onmouseout="out('-6104065159882353101');" style=""> 191                  mOutStream = mTCPSocket.getOutputStream();                                                        </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 192              } else {                                                                                              </span>
<span class="4347759254647630465" onmouseenter="enter('4347759254647630465');" onmouseout="out('4347759254647630465');" style=""> 193                  mIsTCP = false;                                                                                   </span>
<span class="6443654244968138967" onmouseenter="enter('6443654244968138967');" onmouseout="out('6443654244968138967');" style=""> 194                  if (gbDevice.getVolatileAddress() != null &amp;&amp; prefs.getBoolean(&quot;pebble_force_le&quot;, false)) {        </span>
<span class="915290997518797062" onmouseenter="enter('915290997518797062');" onmouseout="out('915290997518797062');" style=""> 195                      deviceAddress = gbDevice.getVolatileAddress();                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 196                  }                                                                                                 </span>
<span class="4786675468629518746" onmouseenter="enter('4786675468629518746');" onmouseout="out('4786675468629518746');" style=""> 197                  BluetoothDevice btDevice = mBtAdapter.getRemoteDevice(deviceAddress);                             </span>
<span class="335623565325713065" onmouseenter="enter('335623565325713065');" onmouseout="out('335623565325713065');" style=""> 198                  if (btDevice.getType() == BluetoothDevice.DEVICE_TYPE_LE) {                                       </span>
<span class="8333508526895931889" onmouseenter="enter('8333508526895931889');" onmouseout="out('8333508526895931889');" style=""> 199                      LOG.info(&quot;This is a Pebble 2 or Pebble-LE/Pebble Time LE, will use BLE&quot;);                     </span>
<span class="-3562679261979772904" onmouseenter="enter('-3562679261979772904');" onmouseout="out('-3562679261979772904');" style=""> 200                      mInStream = new PipedInputStream();                                                           </span>
<span class="6393093760748525382" onmouseenter="enter('6393093760748525382');" onmouseout="out('6393093760748525382');" style=""> 201                      mOutStream = new PipedOutputStream();                                                         </span>
<span class="2915722355401222377" onmouseenter="enter('2915722355401222377');" onmouseout="out('2915722355401222377');" style=""><abbr title=" 202                      mPebbleLESupport = new PebbleLESupport(this.getContext(), btDevice, (PipedInputStream) mInStream, (PipedOutputStream) mOutStream);"> 202                      mPebbleLESupport = new PebbleLESupport(this.getContext(), btDevice, (PipedInputStream) mInStreðŸ”µ</abbr></span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 203                  } else {                                                                                          </span>
<span class="8228468292686787155" onmouseenter="enter('8228468292686787155');" onmouseout="out('8228468292686787155');" style=""> 204                      ParcelUuid uuids[] = btDevice.getUuids();                                                     </span>
<span class="2503839032557077084" onmouseenter="enter('2503839032557077084');" onmouseout="out('2503839032557077084');" style=""> 205                      if (uuids == null) {                                                                          </span>
<span class="-5432226360745882584" onmouseenter="enter('-5432226360745882584');" onmouseout="out('-5432226360745882584');" style=""> 206                          return false;                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 207                      }                                                                                             </span>
<span class="8104594939174164082" onmouseenter="enter('8104594939174164082');" onmouseout="out('8104594939174164082');" style=""> 208                      for (ParcelUuid uuid : uuids) {                                                               </span>
<span class="5496152670479511454" onmouseenter="enter('5496152670479511454');" onmouseout="out('5496152670479511454');" style=""> 209                          LOG.info(&quot;found service UUID &quot; + uuid);                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 210                      }                                                                                             </span>
<span class="-2085322778834697972" onmouseenter="enter('-2085322778834697972');" onmouseout="out('-2085322778834697972');" style=""> 211                      mBtSocket = btDevice.createRfcommSocketToServiceRecord(uuids[0].getUuid());                   </span>
<span class="-617547228937795237" onmouseenter="enter('-617547228937795237');" onmouseout="out('-617547228937795237');" style=""> 212                      mBtSocket.connect();                                                                          </span>
<span class="-4553264448616972703" onmouseenter="enter('-4553264448616972703');" onmouseout="out('-4553264448616972703');" style=""> 213                      mInStream = mBtSocket.getInputStream();                                                       </span>
<span class="-4296883704518407532" onmouseenter="enter('-4296883704518407532');" onmouseout="out('-4296883704518407532');" style=""> 214                      mOutStream = mBtSocket.getOutputStream();                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 215                  }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 216              }                                                                                                     </span>
<span class="7080241092423381085" onmouseenter="enter('7080241092423381085');" onmouseout="out('7080241092423381085');" style=""> 217          } catch (IOException e) {                                                                                 </span>
<span class="4090663313211582937" onmouseenter="enter('4090663313211582937');" onmouseout="out('4090663313211582937');" style=""> 218              e.printStackTrace();                                                                                  </span>
<span class="5984241666527947087" onmouseenter="enter('5984241666527947087');" onmouseout="out('5984241666527947087');" style=""> 219              gbDevice.setState(originalState);                                                                     </span>
<span class="-6083303279196581322" onmouseenter="enter('-6083303279196581322');" onmouseout="out('-6083303279196581322');" style=""> 220              gbDevice.sendDeviceUpdateIntent(getContext());                                                        </span>
<span  style=""> 221                                                                                                                    </span>
<span class="3085765988076808372" onmouseenter="enter('3085765988076808372');" onmouseout="out('3085765988076808372');" style=""> 222              mInStream = null;                                                                                     </span>
<span class="4968882532143556776" onmouseenter="enter('4968882532143556776');" onmouseout="out('4968882532143556776');" style=""> 223              mOutStream = null;                                                                                    </span>
<span class="-4534501040604870855" onmouseenter="enter('-4534501040604870855');" onmouseout="out('-4534501040604870855');" style=""> 224              mBtSocket = null;                                                                                     </span>
<span class="-5432226360745882584" onmouseenter="enter('-5432226360745882584');" onmouseout="out('-5432226360745882584');" style=""> 225              return false;                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 226          }                                                                                                         </span>
<span  style=""> 227                                                                                                                    </span>
<span class="1677595949374963054" onmouseenter="enter('1677595949374963054');" onmouseout="out('1677595949374963054');" style=""> 228          mPebbleProtocol.setForceProtocol(prefs.getBoolean(&quot;pebble_force_protocol&quot;, false));                       </span>
<span  style=""> 229                                                                                                                    </span>
<span class="5928608366163593597" onmouseenter="enter('5928608366163593597');" onmouseout="out('5928608366163593597');" style=""> 230          mIsConnected = true;                                                                                      </span>
<span class="3321416181738117978" onmouseenter="enter('3321416181738117978');" onmouseout="out('3321416181738117978');" style=""> 231          write(mPebbleProtocol.encodeFirmwareVersionReq());                                                        </span>
<span class="-7904642316416307948" onmouseenter="enter('-7904642316416307948');" onmouseout="out('-7904642316416307948');" style=""> 232          gbDevice.setState(GBDevice.State.CONNECTED);                                                              </span>
<span class="-6083303279196581322" onmouseenter="enter('-6083303279196581322');" onmouseout="out('-6083303279196581322');" style=""> 233          gbDevice.sendDeviceUpdateIntent(getContext());                                                            </span>
<span  style=""> 234                                                                                                                    </span>
<span class="-3118901906653197100" onmouseenter="enter('-3118901906653197100');" onmouseout="out('-3118901906653197100');" style=""> 235          return true;                                                                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 236      }                                                                                                             </span>
<span  style=""> 237                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 238      @Override                                                                                                     </span>
<span class="5292860430507443886" onmouseenter="enter('5292860430507443886');" onmouseout="out('5292860430507443886');" style=""> 239      public void run() {                                                                                           </span>
<span class="-2588539367217579258" onmouseenter="enter('-2588539367217579258');" onmouseout="out('-2588539367217579258');" style=""> 240          mIsConnected = connect();                                                                                 </span>
<span class="-245134013635442990" onmouseenter="enter('-245134013635442990');" onmouseout="out('-245134013635442990');" style=""> 241          if (!mIsConnected) {                                                                                      </span>
<span class="2633273029186728772" onmouseenter="enter('2633273029186728772');" onmouseout="out('2633273029186728772');" style=""> 242              if (GBApplication.getGBPrefs().getAutoReconnect() &amp;&amp; !mQuit) {                                        </span>
<span class="3557129149179391090" onmouseenter="enter('3557129149179391090');" onmouseout="out('3557129149179391090');" style=""> 243                  gbDevice.setState(GBDevice.State.WAITING_FOR_RECONNECT);                                          </span>
<span class="-6083303279196581322" onmouseenter="enter('-6083303279196581322');" onmouseout="out('-6083303279196581322');" style=""> 244                  gbDevice.sendDeviceUpdateIntent(getContext());                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 245              }                                                                                                     </span>
<span class="4043029072030362567" onmouseenter="enter('4043029072030362567');" onmouseout="out('4043029072030362567');" style=""> 246              return;                                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 247          }                                                                                                         </span>
<span  style=""> 248                                                                                                                    </span>
<span class="2624641968800564380" onmouseenter="enter('2624641968800564380');" onmouseout="out('2624641968800564380');" style=""> 249          byte[] buffer = new byte[8192];                                                                           </span>
<span class="4927755373081257077" onmouseenter="enter('4927755373081257077');" onmouseout="out('4927755373081257077');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 250 -        enablePebbleKitReceiver(true);                                                                            </span>
<span class="8018073170313256099" onmouseenter="enter('8018073170313256099');" onmouseout="out('8018073170313256099');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 251 +        enablePebbleKitSupport(true);                                                                             </span>
<span class="-8765366791852935627" onmouseenter="enter('-8765366791852935627');" onmouseout="out('-8765366791852935627');" style=""> 252          mQuit = false;                                                                                            </span>
<span class="-6588719847383972316" onmouseenter="enter('-6588719847383972316');" onmouseout="out('-6588719847383972316');" style=""> 253          while (!mQuit) {                                                                                          </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 254              try {                                                                                                 </span>
<span class="-8278348814669106484" onmouseenter="enter('-8278348814669106484');" onmouseout="out('-8278348814669106484');" style=""> 255                  if (mIsInstalling) {                                                                              </span>
<span class="8684367013652331710" onmouseenter="enter('8684367013652331710');" onmouseout="out('8684367013652331710');" style=""> 256                      switch (mInstallState) {                                                                      </span>
<span class="7026400303061140058" onmouseenter="enter('7026400303061140058');" onmouseout="out('7026400303061140058');" style=""> 257                          case WAIT_SLOT:                                                                           </span>
<span class="-2690055123266986251" onmouseenter="enter('-2690055123266986251');" onmouseout="out('-2690055123266986251');" style=""> 258                              if (mInstallSlot == -1) {                                                             </span>
<span class="-3606888775151099353" onmouseenter="enter('-3606888775151099353');" onmouseout="out('-3606888775151099353');" style=""> 259                                  finishInstall(true); // no slots available                                        </span>
<span class="2295401759568749857" onmouseenter="enter('2295401759568749857');" onmouseout="out('2295401759568749857');" style=""> 260                              } else if (mInstallSlot &gt;= 0) {                                                       </span>
<span class="6147346456613268497" onmouseenter="enter('6147346456613268497');" onmouseout="out('6147346456613268497');" style=""> 261                                  mInstallState = PebbleAppInstallState.START_INSTALL;                              </span>
<span class="-6362435147834875541" onmouseenter="enter('-6362435147834875541');" onmouseout="out('-6362435147834875541');" style=""> 262                                  continue;                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 263                              }                                                                                     </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 264                              break;                                                                                </span>
<span class="-3962643594977912505" onmouseenter="enter('-3962643594977912505');" onmouseout="out('-3962643594977912505');" style=""> 265                          case START_INSTALL:                                                                       </span>
<span class="-5574718196482043222" onmouseenter="enter('-5574718196482043222');" onmouseout="out('-5574718196482043222');" style=""> 266                              LOG.info(&quot;start installing app binary&quot;);                                              </span>
<span class="5478053508733530178" onmouseenter="enter('5478053508733530178');" onmouseout="out('5478053508733530178');" style=""> 267                              PebbleInstallable pi = mPebbleInstallables[mCurrentInstallableIndex];                 </span>
<span class="3659756883627403325" onmouseenter="enter('3659756883627403325');" onmouseout="out('3659756883627403325');" style=""> 268                              mFis = mPBWReader.getInputStreamFile(pi.getFileName());                               </span>
<span class="5016659144309369034" onmouseenter="enter('5016659144309369034');" onmouseout="out('5016659144309369034');" style=""> 269                              mCRC = pi.getCRC();                                                                   </span>
<span class="3142625636824209099" onmouseenter="enter('3142625636824209099');" onmouseout="out('3142625636824209099');" style=""> 270                              mBinarySize = pi.getFileSize();                                                       </span>
<span class="4161899041554384973" onmouseenter="enter('4161899041554384973');" onmouseout="out('4161899041554384973');" style=""> 271                              mBytesWritten = 0;                                                                    </span>
<span class="-1767419274223935649" onmouseenter="enter('-1767419274223935649');" onmouseout="out('-1767419274223935649');" style=""><abbr title=" 272                              writeInstallApp(mPebbleProtocol.encodeUploadStart(pi.getType(), mInstallSlot, mBinarySize, mPBWReader.isLanguage() ? &quot;lang&quot; : null));"> 272                              writeInstallApp(mPebbleProtocol.encodeUploadStart(pi.getType(), mInstallSlot, mBinarySðŸ”µ</abbr></span>
<span class="-556680889075439690" onmouseenter="enter('-556680889075439690');" onmouseout="out('-556680889075439690');" style=""> 273                              mAppInstallToken = -1;                                                                </span>
<span class="-7999689873557895203" onmouseenter="enter('-7999689873557895203');" onmouseout="out('-7999689873557895203');" style=""> 274                              mInstallState = PebbleAppInstallState.WAIT_TOKEN;                                     </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 275                              break;                                                                                </span>
<span class="6792169580692674220" onmouseenter="enter('6792169580692674220');" onmouseout="out('6792169580692674220');" style=""> 276                          case WAIT_TOKEN:                                                                          </span>
<span class="-3832708479724599095" onmouseenter="enter('-3832708479724599095');" onmouseout="out('-3832708479724599095');" style=""> 277                              if (mAppInstallToken != -1) {                                                         </span>
<span class="-8049659333726333512" onmouseenter="enter('-8049659333726333512');" onmouseout="out('-8049659333726333512');" style=""> 278                                  LOG.info(&quot;got token &quot; + mAppInstallToken);                                        </span>
<span class="5531590291586303132" onmouseenter="enter('5531590291586303132');" onmouseout="out('5531590291586303132');" style=""> 279                                  mInstallState = PebbleAppInstallState.UPLOAD_CHUNK;                               </span>
<span class="-6362435147834875541" onmouseenter="enter('-6362435147834875541');" onmouseout="out('-6362435147834875541');" style=""> 280                                  continue;                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 281                              }                                                                                     </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 282                              break;                                                                                </span>
<span class="-584114172413593495" onmouseenter="enter('-584114172413593495');" onmouseout="out('-584114172413593495');" style=""> 283                          case UPLOAD_CHUNK:                                                                        </span>
<span class="1528466301664079417" onmouseenter="enter('1528466301664079417');" onmouseout="out('1528466301664079417');" style=""> 284                              int bytes = 0;                                                                        </span>
<span class="3052837437029247759" onmouseenter="enter('3052837437029247759');" onmouseout="out('3052837437029247759');" style=""> 285                              do {                                                                                  </span>
<span class="1834678701284410601" onmouseenter="enter('1834678701284410601');" onmouseout="out('1834678701284410601');" style=""> 286                                  int read = mFis.read(buffer, bytes, 2000 - bytes);                                </span>
<span class="-6442970889778139424" onmouseenter="enter('-6442970889778139424');" onmouseout="out('-6442970889778139424');" style=""> 287                                  if (read &lt;= 0) break;                                                             </span>
<span class="-8945043921272536992" onmouseenter="enter('-8945043921272536992');" onmouseout="out('-8945043921272536992');" style=""> 288                                  bytes += read;                                                                    </span>
<span class="451207650617133464" onmouseenter="enter('451207650617133464');" onmouseout="out('451207650617133464');" style=""> 289                              } while (bytes &lt; 2000);                                                               </span>
<span  style=""> 290                                                                                                                    </span>
<span class="6794246418348616673" onmouseenter="enter('6794246418348616673');" onmouseout="out('6794246418348616673');" style=""> 291                              if (bytes &gt; 0) {                                                                      </span>
<span class="-5617191400623126363" onmouseenter="enter('-5617191400623126363');" onmouseout="out('-5617191400623126363');" style=""> 292                                  GB.updateInstallNotification(getContext().getString(                              </span>
<span class="4050487273412981374" onmouseenter="enter('4050487273412981374');" onmouseout="out('4050487273412981374');" style=""><abbr title=" 293                                          R.string.installing_binary_d_d, (mCurrentInstallableIndex + 1), mPebbleInstallables.length), true, (int) (((float) mBytesWritten / mBinarySize) * 100), getContext());"> 293                                          R.string.installing_binary_d_d, (mCurrentInstallableIndex + 1), mPebbleInsðŸ”µ</abbr></span>
<span class="-7477526339537165687" onmouseenter="enter('-7477526339537165687');" onmouseout="out('-7477526339537165687');" style=""><abbr title=" 294                                  writeInstallApp(mPebbleProtocol.encodeUploadChunk(mAppInstallToken, buffer, bytes));"> 294                                  writeInstallApp(mPebbleProtocol.encodeUploadChunk(mAppInstallToken, buffer, bytes)ðŸ”µ</abbr></span>
<span class="-4728151037181866094" onmouseenter="enter('-4728151037181866094');" onmouseout="out('-4728151037181866094');" style=""> 295                                  mBytesWritten += bytes;                                                           </span>
<span class="-556680889075439690" onmouseenter="enter('-556680889075439690');" onmouseout="out('-556680889075439690');" style=""> 296                                  mAppInstallToken = -1;                                                            </span>
<span class="-7999689873557895203" onmouseenter="enter('-7999689873557895203');" onmouseout="out('-7999689873557895203');" style=""> 297                                  mInstallState = PebbleAppInstallState.WAIT_TOKEN;                                 </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 298                              } else {                                                                              </span>
<span class="-5094680563432242000" onmouseenter="enter('-5094680563432242000');" onmouseout="out('-5094680563432242000');" style=""> 299                                  mInstallState = PebbleAppInstallState.UPLOAD_COMMIT;                              </span>
<span class="-6362435147834875541" onmouseenter="enter('-6362435147834875541');" onmouseout="out('-6362435147834875541');" style=""> 300                                  continue;                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 301                              }                                                                                     </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 302                              break;                                                                                </span>
<span class="4124538925361105547" onmouseenter="enter('4124538925361105547');" onmouseout="out('4124538925361105547');" style=""> 303                          case UPLOAD_COMMIT:                                                                       </span>
<span class="-2966405575206880121" onmouseenter="enter('-2966405575206880121');" onmouseout="out('-2966405575206880121');" style=""> 304                              writeInstallApp(mPebbleProtocol.encodeUploadCommit(mAppInstallToken, mCRC));          </span>
<span class="-556680889075439690" onmouseenter="enter('-556680889075439690');" onmouseout="out('-556680889075439690');" style=""> 305                              mAppInstallToken = -1;                                                                </span>
<span class="-6886437457702083289" onmouseenter="enter('-6886437457702083289');" onmouseout="out('-6886437457702083289');" style=""> 306                              mInstallState = PebbleAppInstallState.WAIT_COMMIT;                                    </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 307                              break;                                                                                </span>
<span class="-6760167966557106950" onmouseenter="enter('-6760167966557106950');" onmouseout="out('-6760167966557106950');" style=""> 308                          case WAIT_COMMIT:                                                                         </span>
<span class="-3832708479724599095" onmouseenter="enter('-3832708479724599095');" onmouseout="out('-3832708479724599095');" style=""> 309                              if (mAppInstallToken != -1) {                                                         </span>
<span class="-8049659333726333512" onmouseenter="enter('-8049659333726333512');" onmouseout="out('-8049659333726333512');" style=""> 310                                  LOG.info(&quot;got token &quot; + mAppInstallToken);                                        </span>
<span class="-6772897424369466346" onmouseenter="enter('-6772897424369466346');" onmouseout="out('-6772897424369466346');" style=""> 311                                  mInstallState = PebbleAppInstallState.UPLOAD_COMPLETE;                            </span>
<span class="-6362435147834875541" onmouseenter="enter('-6362435147834875541');" onmouseout="out('-6362435147834875541');" style=""> 312                                  continue;                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 313                              }                                                                                     </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 314                              break;                                                                                </span>
<span class="7185565864054148536" onmouseenter="enter('7185565864054148536');" onmouseout="out('7185565864054148536');" style=""> 315                          case UPLOAD_COMPLETE:                                                                     </span>
<span class="5024538798090815598" onmouseenter="enter('5024538798090815598');" onmouseout="out('5024538798090815598');" style=""> 316                              writeInstallApp(mPebbleProtocol.encodeUploadComplete(mAppInstallToken));              </span>
<span class="-937796524014974666" onmouseenter="enter('-937796524014974666');" onmouseout="out('-937796524014974666');" style=""> 317                              if (++mCurrentInstallableIndex &lt; mPebbleInstallables.length) {                        </span>
<span class="6147346456613268497" onmouseenter="enter('6147346456613268497');" onmouseout="out('6147346456613268497');" style=""> 318                                  mInstallState = PebbleAppInstallState.START_INSTALL;                              </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 319                              } else {                                                                              </span>
<span class="4645923661994641503" onmouseenter="enter('4645923661994641503');" onmouseout="out('4645923661994641503');" style=""> 320                                  mInstallState = PebbleAppInstallState.APP_REFRESH;                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 321                              }                                                                                     </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 322                              break;                                                                                </span>
<span class="-4660819450142864885" onmouseenter="enter('-4660819450142864885');" onmouseout="out('-4660819450142864885');" style=""> 323                          case APP_REFRESH:                                                                         </span>
<span class="1423594820264173048" onmouseenter="enter('1423594820264173048');" onmouseout="out('1423594820264173048');" style=""> 324                              if (mPBWReader.isFirmware()) {                                                        </span>
<span class="7979692944967033784" onmouseenter="enter('7979692944967033784');" onmouseout="out('7979692944967033784');" style=""> 325                                  writeInstallApp(mPebbleProtocol.encodeInstallFirmwareComplete());                 </span>
<span class="8670418135173104454" onmouseenter="enter('8670418135173104454');" onmouseout="out('8670418135173104454');" style=""> 326                                  finishInstall(false);                                                             </span>
<span class="-3229195631780864145" onmouseenter="enter('-3229195631780864145');" onmouseout="out('-3229195631780864145');" style=""> 327                              } else if (mPBWReader.isLanguage() || mPebbleProtocol.mFwMajor &gt;= 3) {                </span>
<span class="-3079811230585835514" onmouseenter="enter('-3079811230585835514');" onmouseout="out('-3079811230585835514');" style=""> 328                                  finishInstall(false); // FIXME: don&#x27;t know yet how to detect success              </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 329                              } else {                                                                              </span>
<span class="-3742154807253834306" onmouseenter="enter('-3742154807253834306');" onmouseout="out('-3742154807253834306');" style=""> 330                                  writeInstallApp(mPebbleProtocol.encodeAppRefresh(mInstallSlot));                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 331                              }                                                                                     </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 332                              break;                                                                                </span>
<span class="-8178136317704390296" onmouseenter="enter('-8178136317704390296');" onmouseout="out('-8178136317704390296');" style=""> 333                          default:                                                                                  </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 334                              break;                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 335                      }                                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 336                  }                                                                                                 </span>
<span class="5578850974519966568" onmouseenter="enter('5578850974519966568');" onmouseout="out('5578850974519966568');" style=""> 337                  if (mIsTCP) {                                                                                     </span>
<span class="4471698368272895479" onmouseenter="enter('4471698368272895479');" onmouseout="out('4471698368272895479');" style=""> 338                      mInStream.skip(6);                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 339                  }                                                                                                 </span>
<span class="2796952267402194740" onmouseenter="enter('2796952267402194740');" onmouseout="out('2796952267402194740');" style=""> 340                  int bytes = readWithException(mInStream, buffer, 0, 4);                                           </span>
<span  style=""> 341                                                                                                                    </span>
<span class="-2171789871350536014" onmouseenter="enter('-2171789871350536014');" onmouseout="out('-2171789871350536014');" style=""> 342                  while (bytes &lt; 4) {                                                                               </span>
<span class="-5884925481451326841" onmouseenter="enter('-5884925481451326841');" onmouseout="out('-5884925481451326841');" style=""> 343                      bytes += readWithException(mInStream, buffer, bytes, 4 - bytes);                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 344                  }                                                                                                 </span>
<span  style=""> 345                                                                                                                    </span>
<span class="-7296955466977945724" onmouseenter="enter('-7296955466977945724');" onmouseout="out('-7296955466977945724');" style=""> 346                  ByteBuffer buf = ByteBuffer.wrap(buffer);                                                         </span>
<span class="-8522898317938558799" onmouseenter="enter('-8522898317938558799');" onmouseout="out('-8522898317938558799');" style=""> 347                  buf.order(ByteOrder.BIG_ENDIAN);                                                                  </span>
<span class="2800045307834810060" onmouseenter="enter('2800045307834810060');" onmouseout="out('2800045307834810060');" style=""> 348                  short length = buf.getShort();                                                                    </span>
<span class="-8125815031192715923" onmouseenter="enter('-8125815031192715923');" onmouseout="out('-8125815031192715923');" style=""> 349                  short endpoint = buf.getShort();                                                                  </span>
<span class="9045200348604116826" onmouseenter="enter('9045200348604116826');" onmouseout="out('9045200348604116826');" style=""> 350                  if (length &lt; 0 || length &gt; 8192) {                                                                </span>
<span class="9194134393824457103" onmouseenter="enter('9194134393824457103');" onmouseout="out('9194134393824457103');" style=""> 351                      LOG.info(&quot;invalid length &quot; + length);                                                         </span>
<span class="-967764297694162849" onmouseenter="enter('-967764297694162849');" onmouseout="out('-967764297694162849');" style=""> 352                      while (mInStream.available() &gt; 0) {                                                           </span>
<span class="-1967224316023950474" onmouseenter="enter('-1967224316023950474');" onmouseout="out('-1967224316023950474');" style=""> 353                          readWithException(mInStream, buffer, 0, buffer.length); // read all                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 354                      }                                                                                             </span>
<span class="-6362435147834875541" onmouseenter="enter('-6362435147834875541');" onmouseout="out('-6362435147834875541');" style=""> 355                      continue;                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 356                  }                                                                                                 </span>
<span  style=""> 357                                                                                                                    </span>
<span class="8513682448486197246" onmouseenter="enter('8513682448486197246');" onmouseout="out('8513682448486197246');" style=""> 358                  bytes = readWithException(mInStream, buffer, 4, length);                                          </span>
<span class="-1011005986067945864" onmouseenter="enter('-1011005986067945864');" onmouseout="out('-1011005986067945864');" style=""> 359                  while (bytes &lt; length) {                                                                          </span>
<span class="-7104003189991341630" onmouseenter="enter('-7104003189991341630');" onmouseout="out('-7104003189991341630');" style=""> 360                      bytes += readWithException(mInStream, buffer, bytes + 4, length - bytes);                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 361                  }                                                                                                 </span>
<span  style=""> 362                                                                                                                    </span>
<span class="5578850974519966568" onmouseenter="enter('5578850974519966568');" onmouseout="out('5578850974519966568');" style=""> 363                  if (mIsTCP) {                                                                                     </span>
<span class="5401038970459668826" onmouseenter="enter('5401038970459668826');" onmouseout="out('5401038970459668826');" style=""> 364                      mInStream.skip(2);                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 365                  }                                                                                                 </span>
<span  style=""> 366                                                                                                                    </span>
<span class="-7909466471492476851" onmouseenter="enter('-7909466471492476851');" onmouseout="out('-7909466471492476851');" style=""> 367                  GBDeviceEvent deviceEvents[] = mPebbleProtocol.decodeResponse(buffer);                            </span>
<span class="-638626929611439615" onmouseenter="enter('-638626929611439615');" onmouseout="out('-638626929611439615');" style=""> 368                  if (deviceEvents == null) {                                                                       </span>
<span class="-7056050649624941936" onmouseenter="enter('-7056050649624941936');" onmouseout="out('-7056050649624941936');" style=""> 369                      LOG.info(&quot;unhandled message to endpoint &quot; + endpoint + &quot; (&quot; + length + &quot; bytes)&quot;);            </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 370                  } else {                                                                                          </span>
<span class="1477693521293066497" onmouseenter="enter('1477693521293066497');" onmouseout="out('1477693521293066497');" style=""> 371                      for (GBDeviceEvent deviceEvent : deviceEvents) {                                              </span>
<span class="2097356587238774416" onmouseenter="enter('2097356587238774416');" onmouseout="out('2097356587238774416');" style=""> 372                          if (deviceEvent == null) {                                                                </span>
<span class="-6362435147834875541" onmouseenter="enter('-6362435147834875541');" onmouseout="out('-6362435147834875541');" style=""> 373                              continue;                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 374                          }                                                                                         </span>
<span class="-236987672843521774" onmouseenter="enter('-236987672843521774');" onmouseout="out('-236987672843521774');" style=""> 375                          if (!evaluateGBDeviceEventPebble(deviceEvent)) {                                          </span>
<span class="7042821987734772133" onmouseenter="enter('7042821987734772133');" onmouseout="out('7042821987734772133');" style=""> 376                              mPebbleSupport.evaluateGBDeviceEvent(deviceEvent);                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 377                          }                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 378                      }                                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 379                  }                                                                                                 </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 380                  try {                                                                                             </span>
<span class="1958254861600319008" onmouseenter="enter('1958254861600319008');" onmouseout="out('1958254861600319008');" style=""> 381                      Thread.sleep(100);                                                                            </span>
<span class="-7528533024404460182" onmouseenter="enter('-7528533024404460182');" onmouseout="out('-7528533024404460182');" style=""> 382                  } catch (InterruptedException e) {                                                                </span>
<span class="4090663313211582937" onmouseenter="enter('4090663313211582937');" onmouseout="out('4090663313211582937');" style=""> 383                      e.printStackTrace();                                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 384                  }                                                                                                 </span>
<span class="7080241092423381085" onmouseenter="enter('7080241092423381085');" onmouseout="out('7080241092423381085');" style=""> 385              } catch (IOException e) {                                                                             </span>
<span class="-508556787667332479" onmouseenter="enter('-508556787667332479');" onmouseout="out('-508556787667332479');" style=""><abbr title=" 386                  if (e.getMessage() != null &amp;&amp; (e.getMessage().equals(&quot;broken pipe&quot;) || e.getMessage().contains(&quot;socket closed&quot;))) { //FIXME: this does not feel right"> 386                  if (e.getMessage() != null &amp;&amp; (e.getMessage().equals(&quot;broken pipe&quot;) || e.getMessage().contains(&quot;soðŸ”µ</abbr></span>
<span class="3941064908834146545" onmouseenter="enter('3941064908834146545');" onmouseout="out('3941064908834146545');" style=""> 387                      LOG.info(e.getMessage());                                                                     </span>
<span class="1054919517095572489" onmouseenter="enter('1054919517095572489');" onmouseout="out('1054919517095572489');" style=""> 388                      mIsConnected = false;                                                                         </span>
<span class="1961225799194435069" onmouseenter="enter('1961225799194435069');" onmouseout="out('1961225799194435069');" style=""> 389                      int reconnectAttempts = prefs.getInt(&quot;pebble_reconnect_attempts&quot;, 10);                        </span>
<span class="-786112365036832199" onmouseenter="enter('-786112365036832199');" onmouseout="out('-786112365036832199');" style=""> 390                      if (!mQuit &amp;&amp; GBApplication.getGBPrefs().getAutoReconnect() &amp;&amp; reconnectAttempts &gt; 0) {       </span>
<span class="3557129149179391090" onmouseenter="enter('3557129149179391090');" onmouseout="out('3557129149179391090');" style=""> 391                          gbDevice.setState(GBDevice.State.WAITING_FOR_RECONNECT);                                  </span>
<span class="-6083303279196581322" onmouseenter="enter('-6083303279196581322');" onmouseout="out('-6083303279196581322');" style=""> 392                          gbDevice.sendDeviceUpdateIntent(getContext());                                            </span>
<span  style=""> 393                                                                                                                    </span>
<span class="6110344959180570674" onmouseenter="enter('6110344959180570674');" onmouseout="out('6110344959180570674');" style=""> 394                          int delaySeconds = 1;                                                                     </span>
<span class="-5190003264224859806" onmouseenter="enter('-5190003264224859806');" onmouseout="out('-5190003264224859806');" style=""> 395                          while (reconnectAttempts-- &gt; 0 &amp;&amp; !mQuit &amp;&amp; !mIsConnected) {                              </span>
<span class="-7641363597792416938" onmouseenter="enter('-7641363597792416938');" onmouseout="out('-7641363597792416938');" style=""> 396                              LOG.info(&quot;Trying to reconnect (attempts left &quot; + reconnectAttempts + &quot;)&quot;);            </span>
<span class="-2588539367217579258" onmouseenter="enter('-2588539367217579258');" onmouseout="out('-2588539367217579258');" style=""> 397                              mIsConnected = connect();                                                             </span>
<span class="-245134013635442990" onmouseenter="enter('-245134013635442990');" onmouseout="out('-245134013635442990');" style=""> 398                              if (!mIsConnected) {                                                                  </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 399                                  try {                                                                             </span>
<span class="-3669672008793578674" onmouseenter="enter('-3669672008793578674');" onmouseout="out('-3669672008793578674');" style=""> 400                                      Thread.sleep(delaySeconds * 1000);                                            </span>
<span class="1010771762618413361" onmouseenter="enter('1010771762618413361');" onmouseout="out('1010771762618413361');" style=""> 401                                  } catch (InterruptedException ignored) {                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 402                                  }                                                                                 </span>
<span class="-8988961353399164519" onmouseenter="enter('-8988961353399164519');" onmouseout="out('-8988961353399164519');" style=""> 403                                  if (delaySeconds &lt; 64) {                                                          </span>
<span class="4518640925202616859" onmouseenter="enter('4518640925202616859');" onmouseout="out('4518640925202616859');" style=""> 404                                      delaySeconds *= 2;                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 405                                  }                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 406                              }                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 407                          }                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 408                      }                                                                                             </span>
<span class="-245134013635442990" onmouseenter="enter('-245134013635442990');" onmouseout="out('-245134013635442990');" style=""> 409                      if (!mIsConnected) {                                                                          </span>
<span class="-4534501040604870855" onmouseenter="enter('-4534501040604870855');" onmouseout="out('-4534501040604870855');" style=""> 410                          mBtSocket = null;                                                                         </span>
<span class="-3119559015644534035" onmouseenter="enter('-3119559015644534035');" onmouseout="out('-3119559015644534035');" style=""> 411                          LOG.info(&quot;Bluetooth socket closed, will quit IO Thread&quot;);                                 </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 412                          break;                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 413                      }                                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 414                  }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 415              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 416          }                                                                                                         </span>
<span class="1054919517095572489" onmouseenter="enter('1054919517095572489');" onmouseout="out('1054919517095572489');" style=""> 417          mIsConnected = false;                                                                                     </span>
<span class="-3944229288018059276" onmouseenter="enter('-3944229288018059276');" onmouseout="out('-3944229288018059276');" style=""> 418          if (mBtSocket != null) {                                                                                  </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 419              try {                                                                                                 </span>
<span class="4957759683762229483" onmouseenter="enter('4957759683762229483');" onmouseout="out('4957759683762229483');" style=""> 420                  mBtSocket.close();                                                                                </span>
<span class="7080241092423381085" onmouseenter="enter('7080241092423381085');" onmouseout="out('7080241092423381085');" style=""> 421              } catch (IOException e) {                                                                             </span>
<span class="4090663313211582937" onmouseenter="enter('4090663313211582937');" onmouseout="out('4090663313211582937');" style=""> 422                  e.printStackTrace();                                                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 423              }                                                                                                     </span>
<span class="-4534501040604870855" onmouseenter="enter('-4534501040604870855');" onmouseout="out('-4534501040604870855');" style=""> 424              mBtSocket = null;                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 425          }                                                                                                         </span>
<span  style=""> 426                                                                                                                    </span>
<span class="-177389763488354281" onmouseenter="enter('-177389763488354281');" onmouseout="out('-177389763488354281');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 427 -        enablePebbleKitReceiver(false);                                                                           </span>
<span class="-8029876522886293743" onmouseenter="enter('-8029876522886293743');" onmouseout="out('-8029876522886293743');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 428 +        enablePebbleKitSupport(false);                                                                            </span>
<span  style=""> 429                                                                                                                    </span>
<span class="754428857450446437" onmouseenter="enter('754428857450446437');" onmouseout="out('754428857450446437');" style=""> 430          if (mQuit) {                                                                                              </span>
<span class="3251995130332618727" onmouseenter="enter('3251995130332618727');" onmouseout="out('3251995130332618727');" style=""> 431              gbDevice.setState(GBDevice.State.NOT_CONNECTED);                                                      </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 432          } else {                                                                                                  </span>
<span class="3557129149179391090" onmouseenter="enter('3557129149179391090');" onmouseout="out('3557129149179391090');" style=""> 433              gbDevice.setState(GBDevice.State.WAITING_FOR_RECONNECT);                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 434          }                                                                                                         </span>



<span class="-6083303279196581322" onmouseenter="enter('-6083303279196581322');" onmouseout="out('-6083303279196581322');" style=""> 435          gbDevice.sendDeviceUpdateIntent(getContext());                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 436      }                                                                                                             </span>
<span  style=""> 437                                                                                                                    </span>
<span class="4689325899265566877" onmouseenter="enter('4689325899265566877');" onmouseout="out('4689325899265566877');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 438 -    private void enablePebbleKitReceiver(boolean enable) {                                                        </span>
<span  style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 439 -                                                                                                                  </span>
<span class="6912900349290733332" onmouseenter="enter('6912900349290733332');" onmouseout="out('6912900349290733332');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 440 +    private void enablePebbleKitSupport(boolean enable) {                                                         </span>
<span class="-4986567876401497765" onmouseenter="enter('-4986567876401497765');" onmouseout="out('-4986567876401497765');" style=""> 441          if (enable &amp;&amp; mEnablePebblekit) {                                                                         </span>
<span class="-6475340056070675924" onmouseenter="enter('-6475340056070675924');" onmouseout="out('-6475340056070675924');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 442 -            IntentFilter intentFilter = new IntentFilter();                                                       </span>
<span class="-7999529314326405456" onmouseenter="enter('-7999529314326405456');" onmouseout="out('-7999529314326405456');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 443 -            intentFilter.addAction(PEBBLEKIT_ACTION_APP_ACK);                                                     </span>
<span class="-3927463604442628729" onmouseenter="enter('-3927463604442628729');" onmouseout="out('-3927463604442628729');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 444 -            intentFilter.addAction(PEBBLEKIT_ACTION_APP_NACK);                                                    </span>
<span class="-4792672716090115405" onmouseenter="enter('-4792672716090115405');" onmouseout="out('-4792672716090115405');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 445 -            intentFilter.addAction(PEBBLEKIT_ACTION_APP_SEND);                                                    </span>
<span class="5431224225228670983" onmouseenter="enter('5431224225228670983');" onmouseout="out('5431224225228670983');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 446 -            intentFilter.addAction(PEBBLEKIT_ACTION_APP_START);                                                   </span>
<span class="488268930261420957" onmouseenter="enter('488268930261420957');" onmouseout="out('488268930261420957');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 447 -            intentFilter.addAction(PEBBLEKIT_ACTION_APP_STOP);                                                    </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 448 -            try {                                                                                                 </span>
<span class="3118385057142063191" onmouseenter="enter('3118385057142063191');" onmouseout="out('3118385057142063191');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 449 -                getContext().registerReceiver(mPebbleKitReceiver, intentFilter);                                  </span>
<span class="-1471183022667940231" onmouseenter="enter('-1471183022667940231');" onmouseout="out('-1471183022667940231');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 450 -            } catch (IllegalArgumentException e) {                                                                </span>
<span class="-4407835218921977391" onmouseenter="enter('-4407835218921977391');" onmouseout="out('-4407835218921977391');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 451 -                // ignore                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 452 -            }                                                                                                     </span>
<span class="6988208637409175545" onmouseenter="enter('6988208637409175545');" onmouseout="out('6988208637409175545');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 453 +            mPebbleKitSupport = new PebbleKitSupport(getContext(), PebbleIoThread.this, mPebbleProtocol);         </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 454          } else {                                                                                                  </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 455 -            try {                                                                                                 </span>
<span class="2931362315099817520" onmouseenter="enter('2931362315099817520');" onmouseout="out('2931362315099817520');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 456 -                getContext().unregisterReceiver(mPebbleKitReceiver);                                              </span>
<span class="-1471183022667940231" onmouseenter="enter('-1471183022667940231');" onmouseout="out('-1471183022667940231');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 457 -            } catch (IllegalArgumentException e) {                                                                </span>
<span class="-4407835218921977391" onmouseenter="enter('-4407835218921977391');" onmouseout="out('-4407835218921977391');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 458 -                // ignore                                                                                         </span>
<span class="1872000704840757529" onmouseenter="enter('1872000704840757529');" onmouseout="out('1872000704840757529');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 459 +            if (mPebbleKitSupport != null) {                                                                      </span>
<span class="2355950174103684288" onmouseenter="enter('2355950174103684288');" onmouseout="out('2355950174103684288');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 460 +                mPebbleKitSupport.close();                                                                        </span>
<span class="-7890594263237719778" onmouseenter="enter('-7890594263237719778');" onmouseout="out('-7890594263237719778');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 461 +                mPebbleKitSupport = null;                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 462              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 463          }                                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 464      }                                                                                                             </span>
<span  style=""> 465                                                                                                                    </span>
<span  style=""> 466                                                                                                                    </span>
<span class="5266958563097079524" onmouseenter="enter('5266958563097079524');" onmouseout="out('5266958563097079524');" style=""> 467      private void write_real(byte[] bytes) {                                                                       </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 468          try {                                                                                                     </span>
<span class="5578850974519966568" onmouseenter="enter('5578850974519966568');" onmouseout="out('5578850974519966568');" style=""> 469              if (mIsTCP) {                                                                                         </span>
<span class="7452866671884685289" onmouseenter="enter('7452866671884685289');" onmouseout="out('7452866671884685289');" style=""> 470                  ByteBuffer buf = ByteBuffer.allocate(bytes.length + 8);                                           </span>
<span class="-8522898317938558799" onmouseenter="enter('-8522898317938558799');" onmouseout="out('-8522898317938558799');" style=""> 471                  buf.order(ByteOrder.BIG_ENDIAN);                                                                  </span>
<span class="5585321854972752725" onmouseenter="enter('5585321854972752725');" onmouseout="out('5585321854972752725');" style=""> 472                  buf.putShort((short) 0xfeed);                                                                     </span>
<span class="7507473664785459909" onmouseenter="enter('7507473664785459909');" onmouseout="out('7507473664785459909');" style=""> 473                  buf.putShort((short) 1);                                                                          </span>
<span class="-8123162661289444091" onmouseenter="enter('-8123162661289444091');" onmouseout="out('-8123162661289444091');" style=""> 474                  buf.putShort((short) bytes.length);                                                               </span>
<span class="-7064269165968803859" onmouseenter="enter('-7064269165968803859');" onmouseout="out('-7064269165968803859');" style=""> 475                  buf.put(bytes);                                                                                   </span>
<span class="488045024517500594" onmouseenter="enter('488045024517500594');" onmouseout="out('488045024517500594');" style=""> 476                  buf.putShort((short) 0xbeef);                                                                     </span>
<span class="5890011760749412055" onmouseenter="enter('5890011760749412055');" onmouseout="out('5890011760749412055');" style=""> 477                  mOutStream.write(buf.array());                                                                    </span>
<span class="5447277003517706714" onmouseenter="enter('5447277003517706714');" onmouseout="out('5447277003517706714');" style=""> 478                  mOutStream.flush();                                                                               </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 479              } else {                                                                                              </span>
<span class="-446832387142219515" onmouseenter="enter('-446832387142219515');" onmouseout="out('-446832387142219515');" style=""> 480                  mOutStream.write(bytes);                                                                          </span>
<span class="5447277003517706714" onmouseenter="enter('5447277003517706714');" onmouseout="out('5447277003517706714');" style=""> 481                  mOutStream.flush();                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 482              }                                                                                                     </span>
<span class="7080241092423381085" onmouseenter="enter('7080241092423381085');" onmouseout="out('7080241092423381085');" style=""> 483          } catch (IOException e) {                                                                                 </span>
<span class="886800052852078092" onmouseenter="enter('886800052852078092');" onmouseout="out('886800052852078092');" style=""> 484              LOG.error(&quot;Error writing.&quot;, e.getMessage());                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 485          }                                                                                                         </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 486          try {                                                                                                     </span>
<span class="1958254861600319008" onmouseenter="enter('1958254861600319008');" onmouseout="out('1958254861600319008');" style=""> 487              Thread.sleep(100);                                                                                    </span>
<span class="1010771762618413361" onmouseenter="enter('1010771762618413361');" onmouseout="out('1010771762618413361');" style=""> 488          } catch (InterruptedException ignored) {                                                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 489          }                                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 490      }                                                                                                             </span>
<span  style=""> 491                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 492      @Override                                                                                                     </span>
<span class="2194193333899452301" onmouseenter="enter('2194193333899452301');" onmouseout="out('2194193333899452301');" style=""> 493      synchronized public void write(byte[] bytes) {                                                                </span>
<span class="7962173391634007539" onmouseenter="enter('7962173391634007539');" onmouseout="out('7962173391634007539');" style=""> 494          if (bytes == null) {                                                                                      </span>
<span class="4043029072030362567" onmouseenter="enter('4043029072030362567');" onmouseout="out('4043029072030362567');" style=""> 495              return;                                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 496          }                                                                                                         </span>
<span class="-1647178201768949716" onmouseenter="enter('-1647178201768949716');" onmouseout="out('-1647178201768949716');" style=""> 497          // on FW &lt; 3.0 block writes if app installation in in progress                                            </span>
<span class="-6700324623621105863" onmouseenter="enter('-6700324623621105863');" onmouseout="out('-6700324623621105863');" style=""><abbr title=" 498          if (!mIsConnected || (mPebbleProtocol.mFwMajor &lt; 3 &amp;&amp; mIsInstalling &amp;&amp; mInstallState != PebbleAppInstallState.WAIT_SLOT)) {"> 498          if (!mIsConnected || (mPebbleProtocol.mFwMajor &lt; 3 &amp;&amp; mIsInstalling &amp;&amp; mInstallState != PebbleAppInstallStðŸ”µ</abbr></span>
<span class="4043029072030362567" onmouseenter="enter('4043029072030362567');" onmouseout="out('4043029072030362567');" style=""> 499              return;                                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 500          }                                                                                                         </span>
<span class="-5136181704666404560" onmouseenter="enter('-5136181704666404560');" onmouseout="out('-5136181704666404560');" style=""> 501          write_real(bytes);                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 502      }                                                                                                             </span>
<span  style=""> 503                                                                                                                    </span>
<span class="3670289587241327133" onmouseenter="enter('3670289587241327133');" onmouseout="out('3670289587241327133');" style=""> 504      // FIXME: parts are supporsed to be generic code                                                              </span>
<span class="-7489026152941302055" onmouseenter="enter('-7489026152941302055');" onmouseout="out('-7489026152941302055');" style=""> 505      private boolean evaluateGBDeviceEventPebble(GBDeviceEvent deviceEvent) {                                      </span>
<span  style=""> 506                                                                                                                    </span>
<span class="-1739566276849801616" onmouseenter="enter('-1739566276849801616');" onmouseout="out('-1739566276849801616');" style=""> 507          if (deviceEvent instanceof GBDeviceEventVersionInfo) {                                                    </span>
<span class="1668658004022497081" onmouseenter="enter('1668658004022497081');" onmouseout="out('1668658004022497081');" style=""> 508              if (prefs.getBoolean(&quot;datetime_synconconnect&quot;, true)) {                                               </span>
<span class="-3451867859378415609" onmouseenter="enter('-3451867859378415609');" onmouseout="out('-3451867859378415609');" style=""> 509                  LOG.info(&quot;syncing time&quot;);                                                                         </span>
<span class="5993925069998187867" onmouseenter="enter('5993925069998187867');" onmouseout="out('5993925069998187867');" style=""> 510                  write(mPebbleProtocol.encodeSetTime());                                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 511              }                                                                                                     </span>
<span class="-7386980641954546377" onmouseenter="enter('-7386980641954546377');" onmouseout="out('-7386980641954546377');" style=""> 512              write(mPebbleProtocol.encodeEnableAppLogs(prefs.getBoolean(&quot;pebble_enable_applogs&quot;, false)));         </span>
<span class="-4097828168322802160" onmouseenter="enter('-4097828168322802160');" onmouseout="out('-4097828168322802160');" style=""> 513              write(mPebbleProtocol.encodeReportDataLogSessions());                                                 </span>
<span class="6586859092027978564" onmouseenter="enter('6586859092027978564');" onmouseout="out('6586859092027978564');" style=""> 514              gbDevice.setState(GBDevice.State.INITIALIZED);                                                        </span>
<span class="-5432226360745882584" onmouseenter="enter('-5432226360745882584');" onmouseout="out('-5432226360745882584');" style=""> 515              return false;                                                                                         </span>
<span class="-4499044239010675675" onmouseenter="enter('-4499044239010675675');" onmouseout="out('-4499044239010675675');" style=""> 516          } else if (deviceEvent instanceof GBDeviceEventAppManagement) {                                           </span>
<span class="974736254576981019" onmouseenter="enter('974736254576981019');" onmouseout="out('974736254576981019');" style=""> 517              GBDeviceEventAppManagement appMgmt = (GBDeviceEventAppManagement) deviceEvent;                        </span>
<span class="-8405891147776704968" onmouseenter="enter('-8405891147776704968');" onmouseout="out('-8405891147776704968');" style=""> 518              switch (appMgmt.type) {                                                                               </span>
<span class="493585282467505488" onmouseenter="enter('493585282467505488');" onmouseout="out('493585282467505488');" style=""> 519                  case DELETE:                                                                                      </span>
<span class="3296704790396586230" onmouseenter="enter('3296704790396586230');" onmouseout="out('3296704790396586230');" style=""> 520                      // right now on the Pebble we also receive this on a failed/successful installation ;/        </span>
<span class="-5581198847294356355" onmouseenter="enter('-5581198847294356355');" onmouseout="out('-5581198847294356355');" style=""> 521                      switch (appMgmt.event) {                                                                      </span>
<span class="6749187966539498077" onmouseenter="enter('6749187966539498077');" onmouseout="out('6749187966539498077');" style=""> 522                          case FAILURE:                                                                             </span>
<span class="-8278348814669106484" onmouseenter="enter('-8278348814669106484');" onmouseout="out('-8278348814669106484');" style=""> 523                              if (mIsInstalling) {                                                                  </span>
<span class="5202677886896781243" onmouseenter="enter('5202677886896781243');" onmouseout="out('5202677886896781243');" style=""> 524                                  if (mInstallState == PebbleAppInstallState.WAIT_SLOT) {                           </span>
<span class="-3834429542028013887" onmouseenter="enter('-3834429542028013887');" onmouseout="out('-3834429542028013887');" style=""> 525                                      // get the free slot                                                          </span>
<span class="-1078532123174136932" onmouseenter="enter('-1078532123174136932');" onmouseout="out('-1078532123174136932');" style=""> 526                                      writeInstallApp(mPebbleProtocol.encodeAppInfoReq());                          </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 527                                  } else {                                                                          </span>
<span class="2061814158740359960" onmouseenter="enter('2061814158740359960');" onmouseout="out('2061814158740359960');" style=""> 528                                      finishInstall(true);                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 529                                  }                                                                                 </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 530                              } else {                                                                              </span>
<span class="-3730390778602920424" onmouseenter="enter('-3730390778602920424');" onmouseout="out('-3730390778602920424');" style=""> 531                                  LOG.info(&quot;failure removing app&quot;);                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 532                              }                                                                                     </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 533                              break;                                                                                </span>
<span class="3349111062118052514" onmouseenter="enter('3349111062118052514');" onmouseout="out('3349111062118052514');" style=""> 534                          case SUCCESS:                                                                             </span>
<span class="-8278348814669106484" onmouseenter="enter('-8278348814669106484');" onmouseout="out('-8278348814669106484');" style=""> 535                              if (mIsInstalling) {                                                                  </span>
<span class="5202677886896781243" onmouseenter="enter('5202677886896781243');" onmouseout="out('5202677886896781243');" style=""> 536                                  if (mInstallState == PebbleAppInstallState.WAIT_SLOT) {                           </span>
<span class="-3834429542028013887" onmouseenter="enter('-3834429542028013887');" onmouseout="out('-3834429542028013887');" style=""> 537                                      // get the free slot                                                          </span>
<span class="-1078532123174136932" onmouseenter="enter('-1078532123174136932');" onmouseout="out('-1078532123174136932');" style=""> 538                                      writeInstallApp(mPebbleProtocol.encodeAppInfoReq());                          </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 539                                  } else {                                                                          </span>
<span class="8670418135173104454" onmouseenter="enter('8670418135173104454');" onmouseout="out('8670418135173104454');" style=""> 540                                      finishInstall(false);                                                         </span>
<span class="5558136677444980843" onmouseenter="enter('5558136677444980843');" onmouseout="out('5558136677444980843');" style=""> 541                                      // refresh app list                                                           </span>
<span class="-6896285502301651077" onmouseenter="enter('-6896285502301651077');" onmouseout="out('-6896285502301651077');" style=""> 542                                      write(mPebbleProtocol.encodeAppInfoReq());                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 543                                  }                                                                                 </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 544                              } else {                                                                              </span>
<span class="-205908887212722760" onmouseenter="enter('-205908887212722760');" onmouseout="out('-205908887212722760');" style=""> 545                                  LOG.info(&quot;successfully removed app&quot;);                                             </span>
<span class="-6896285502301651077" onmouseenter="enter('-6896285502301651077');" onmouseout="out('-6896285502301651077');" style=""> 546                                  write(mPebbleProtocol.encodeAppInfoReq());                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 547                              }                                                                                     </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 548                              break;                                                                                </span>
<span class="-8178136317704390296" onmouseenter="enter('-8178136317704390296');" onmouseout="out('-8178136317704390296');" style=""> 549                          default:                                                                                  </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 550                              break;                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 551                      }                                                                                             </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 552                      break;                                                                                        </span>
<span class="870820606107259995" onmouseenter="enter('870820606107259995');" onmouseout="out('870820606107259995');" style=""> 553                  case INSTALL:                                                                                     </span>
<span class="-5581198847294356355" onmouseenter="enter('-5581198847294356355');" onmouseout="out('-5581198847294356355');" style=""> 554                      switch (appMgmt.event) {                                                                      </span>
<span class="6749187966539498077" onmouseenter="enter('6749187966539498077');" onmouseout="out('6749187966539498077');" style=""> 555                          case FAILURE:                                                                             </span>
<span class="-7112250469089022370" onmouseenter="enter('-7112250469089022370');" onmouseout="out('-7112250469089022370');" style=""> 556                              LOG.info(&quot;failure installing app&quot;); // TODO: report to Installer                      </span>
<span class="2061814158740359960" onmouseenter="enter('2061814158740359960');" onmouseout="out('2061814158740359960');" style=""> 557                              finishInstall(true);                                                                  </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 558                              break;                                                                                </span>
<span class="3349111062118052514" onmouseenter="enter('3349111062118052514');" onmouseout="out('3349111062118052514');" style=""> 559                          case SUCCESS:                                                                             </span>
<span class="6209162457835083814" onmouseenter="enter('6209162457835083814');" onmouseout="out('6209162457835083814');" style=""> 560                              setToken(appMgmt.token);                                                              </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 561                              break;                                                                                </span>
<span class="6051906179244859750" onmouseenter="enter('6051906179244859750');" onmouseout="out('6051906179244859750');" style=""> 562                          case REQUEST:                                                                             </span>
<span class="2049455602208269446" onmouseenter="enter('2049455602208269446');" onmouseout="out('2049455602208269446');" style=""> 563                              LOG.info(&quot;APPFETCH request: &quot; + appMgmt.uuid + &quot; / &quot; + appMgmt.token);                </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 564                              try {                                                                                 </span>
<span class="1545743734028545488" onmouseenter="enter('1545743734028545488');" onmouseout="out('1545743734028545488');" style=""><abbr title=" 565                                  installApp(Uri.fromFile(new File(FileUtils.getExternalFilesDir() + &quot;/pbw-cache/&quot; + appMgmt.uuid.toString() + &quot;.pbw&quot;)), appMgmt.token);"> 565                                  installApp(Uri.fromFile(new File(FileUtils.getExternalFilesDir() + &quot;/pbw-cache/&quot; +ðŸ”µ</abbr></span>
<span class="7080241092423381085" onmouseenter="enter('7080241092423381085');" onmouseout="out('7080241092423381085');" style=""> 566                              } catch (IOException e) {                                                             </span>
<span class="-531769948700903766" onmouseenter="enter('-531769948700903766');" onmouseout="out('-531769948700903766');" style=""> 567                                  LOG.error(&quot;Error installing app: &quot; + e.getMessage(), e);                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 568                              }                                                                                     </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 569                              break;                                                                                </span>
<span class="-8178136317704390296" onmouseenter="enter('-8178136317704390296');" onmouseout="out('-8178136317704390296');" style=""> 570                          default:                                                                                  </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 571                              break;                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 572                      }                                                                                             </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 573                      break;                                                                                        </span>
<span class="-2079449841199557933" onmouseenter="enter('-2079449841199557933');" onmouseout="out('-2079449841199557933');" style=""> 574                  case START:                                                                                       </span>
<span class="8092140248813269968" onmouseenter="enter('8092140248813269968');" onmouseout="out('8092140248813269968');" style=""> 575                      LOG.info(&quot;got GBDeviceEventAppManagement START event for uuid: &quot; + appMgmt.uuid);             </span>


<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 576                      break;                                                                                        </span>
<span class="-8178136317704390296" onmouseenter="enter('-8178136317704390296');" onmouseout="out('-8178136317704390296');" style=""> 577                  default:                                                                                          </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 578                      break;                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 579              }                                                                                                     </span>
<span class="-3118901906653197100" onmouseenter="enter('-3118901906653197100');" onmouseout="out('-3118901906653197100');" style=""> 580              return true;                                                                                          </span>
<span class="-6358653040411049512" onmouseenter="enter('-6358653040411049512');" onmouseout="out('-6358653040411049512');" style=""> 581          } else if (deviceEvent instanceof GBDeviceEventAppInfo) {                                                 </span>
<span class="3946899054861776294" onmouseenter="enter('3946899054861776294');" onmouseout="out('3946899054861776294');" style=""> 582              LOG.info(&quot;Got event for APP_INFO&quot;);                                                                   </span>
<span class="1502569219724801591" onmouseenter="enter('1502569219724801591');" onmouseout="out('1502569219724801591');" style=""> 583              GBDeviceEventAppInfo appInfoEvent = (GBDeviceEventAppInfo) deviceEvent;                               </span>
<span class="-8959429837223401007" onmouseenter="enter('-8959429837223401007');" onmouseout="out('-8959429837223401007');" style=""> 584              setInstallSlot(appInfoEvent.freeSlot);                                                                </span>
<span class="-5432226360745882584" onmouseenter="enter('-5432226360745882584');" onmouseout="out('-5432226360745882584');" style=""> 585              return false;                                                                                         </span>
<span class="3212296093301006379" onmouseenter="enter('3212296093301006379');" onmouseout="out('3212296093301006379');" style=""> 586          } else if (deviceEvent instanceof GBDeviceEventAppMessage) {                                              </span>

<span class="-2519217701585576846" onmouseenter="enter('-2519217701585576846');" onmouseout="out('-2519217701585576846');" style=""> 587              if (mEnablePebblekit) {                                                                               </span>
<span class="3587206773966788552" onmouseenter="enter('3587206773966788552');" onmouseout="out('3587206773966788552');" style=""> 588                  LOG.info(&quot;Got AppMessage event&quot;);                                                                 </span>
<span class="8710991571792193702" onmouseenter="enter('8710991571792193702');" onmouseout="out('8710991571792193702');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 589 -                sendAppMessageIntent((GBDeviceEventAppMessage) deviceEvent);                                      </span>
<span class="1872000704840757529" onmouseenter="enter('1872000704840757529');" onmouseout="out('1872000704840757529');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 590 +                if (mPebbleKitSupport != null) {                                                                  </span>
<span class="-6825766400209744371" onmouseenter="enter('-6825766400209744371');" onmouseout="out('-6825766400209744371');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 591 +                    mPebbleKitSupport.sendAppMessageIntent((GBDeviceEventAppMessage) deviceEvent);                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 592 +                }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 593              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 594          }                                                                                                         </span>
<span  style=""> 595                                                                                                                    </span>
<span class="-5432226360745882584" onmouseenter="enter('-5432226360745882584');" onmouseout="out('-5432226360745882584');" style=""> 596          return false;                                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 597      }                                                                                                             </span>
<span  style=""> 598                                                                                                                    </span>
<span class="1330519925695971168" onmouseenter="enter('1330519925695971168');" onmouseout="out('1330519925695971168');" style=""> 599      private void setToken(int token) {                                                                            </span>
<span class="5683710649022739399" onmouseenter="enter('5683710649022739399');" onmouseout="out('5683710649022739399');" style=""> 600          mAppInstallToken = token;                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 601      }                                                                                                             </span>
<span  style=""> 602                                                                                                                    </span>
<span class="3305301500785286694" onmouseenter="enter('3305301500785286694');" onmouseout="out('3305301500785286694');" style=""> 603      private void setInstallSlot(int slot) {                                                                       </span>
<span class="-8278348814669106484" onmouseenter="enter('-8278348814669106484');" onmouseout="out('-8278348814669106484');" style=""> 604          if (mIsInstalling) {                                                                                      </span>
<span class="7826340306873194751" onmouseenter="enter('7826340306873194751');" onmouseout="out('7826340306873194751');" style=""> 605              mInstallSlot = slot;                                                                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 606          }                                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 607      }                                                                                                             </span>
<span  style=""> 608                                                                                                                    </span>
<span class="-8792508792922317323" onmouseenter="enter('-8792508792922317323');" onmouseout="out('-8792508792922317323');" style=""> 609      synchronized private void writeInstallApp(byte[] bytes) {                                                     </span>
<span class="1640300515722317364" onmouseenter="enter('1640300515722317364');" onmouseout="out('1640300515722317364');" style=""> 610          if (!mIsInstalling) {                                                                                     </span>
<span class="4043029072030362567" onmouseenter="enter('4043029072030362567');" onmouseout="out('4043029072030362567');" style=""> 611              return;                                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 612          }                                                                                                         </span>
<span class="546783514848998195" onmouseenter="enter('546783514848998195');" onmouseout="out('546783514848998195');" style=""> 613          LOG.info(&quot;got &quot; + bytes.length + &quot;bytes for writeInstallApp()&quot;);                                          </span>
<span class="-5136181704666404560" onmouseenter="enter('-5136181704666404560');" onmouseout="out('-5136181704666404560');" style=""> 614          write_real(bytes);                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 615      }                                                                                                             </span>
<span  style=""> 616                                                                                                                    </span>
<span class="-1924531441297190559" onmouseenter="enter('-1924531441297190559');" onmouseout="out('-1924531441297190559');" style=""> 617      void installApp(Uri uri, int appId) {                                                                         </span>
<span class="4219320778876848093" onmouseenter="enter('4219320778876848093');" onmouseout="out('4219320778876848093');" style=""> 618          if (uri.equals(Uri.parse(&quot;fake://health&quot;))) {                                                             </span>
<span class="-4500321340045240107" onmouseenter="enter('-4500321340045240107');" onmouseout="out('-4500321340045240107');" style=""> 619              write(mPebbleProtocol.encodeActivateHealth(true));                                                    </span>
<span class="-9057759845463359663" onmouseenter="enter('-9057759845463359663');" onmouseout="out('-9057759845463359663');" style=""> 620              write(mPebbleProtocol.encodeSetSaneDistanceUnit(true));                                               </span>
<span class="4043029072030362567" onmouseenter="enter('4043029072030362567');" onmouseout="out('4043029072030362567');" style=""> 621              return;                                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 622          }                                                                                                         </span>
<span class="-2579506686933905796" onmouseenter="enter('-2579506686933905796');" onmouseout="out('-2579506686933905796');" style=""> 623          if (uri.equals(Uri.parse(&quot;fake://hrm&quot;))) {                                                                </span>
<span class="-8562013736932235665" onmouseenter="enter('-8562013736932235665');" onmouseout="out('-8562013736932235665');" style=""> 624              write(mPebbleProtocol.encodeActivateHRM(true));                                                       </span>
<span class="4043029072030362567" onmouseenter="enter('4043029072030362567');" onmouseout="out('4043029072030362567');" style=""> 625              return;                                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 626          }                                                                                                         </span>
<span class="-1212047709466619456" onmouseenter="enter('-1212047709466619456');" onmouseout="out('-1212047709466619456');" style=""> 627          if (uri.equals(Uri.parse(&quot;fake://weather&quot;))) {                                                            </span>
<span class="2684404709669173657" onmouseenter="enter('2684404709669173657');" onmouseout="out('2684404709669173657');" style=""> 628              write(mPebbleProtocol.encodeActivateWeather(true));                                                   </span>
<span class="4043029072030362567" onmouseenter="enter('4043029072030362567');" onmouseout="out('4043029072030362567');" style=""> 629              return;                                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 630          }                                                                                                         </span>
<span  style=""> 631                                                                                                                    </span>
<span class="-8278348814669106484" onmouseenter="enter('-8278348814669106484');" onmouseout="out('-8278348814669106484');" style=""> 632          if (mIsInstalling) {                                                                                      </span>
<span class="4043029072030362567" onmouseenter="enter('4043029072030362567');" onmouseout="out('4043029072030362567');" style=""> 633              return;                                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 634          }                                                                                                         </span>
<span  style=""> 635                                                                                                                    </span>
<span class="6375141335175677190" onmouseenter="enter('6375141335175677190');" onmouseout="out('6375141335175677190');" style=""> 636          String platformName = PebbleUtils.getPlatformName(gbDevice.getModel());                                   </span>
<span  style=""> 637                                                                                                                    </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 638          try {                                                                                                     </span>
<span class="7221939422125416648" onmouseenter="enter('7221939422125416648');" onmouseout="out('7221939422125416648');" style=""> 639              mPBWReader = new PBWReader(uri, getContext(), platformName);                                          </span>
<span class="400908373044587289" onmouseenter="enter('400908373044587289');" onmouseout="out('400908373044587289');" style=""> 640          } catch (FileNotFoundException e) {                                                                       </span>
<span class="769608185211968952" onmouseenter="enter('769608185211968952');" onmouseout="out('769608185211968952');" style=""> 641              LOG.warn(&quot;file not found: &quot; + e.getMessage(), e);                                                     </span>
<span class="4043029072030362567" onmouseenter="enter('4043029072030362567');" onmouseout="out('4043029072030362567');" style=""> 642              return;                                                                                               </span>
<span class="7080241092423381085" onmouseenter="enter('7080241092423381085');" onmouseout="out('7080241092423381085');" style=""> 643          } catch (IOException e) {                                                                                 </span>
<span class="8483156789856269109" onmouseenter="enter('8483156789856269109');" onmouseout="out('8483156789856269109');" style=""> 644              LOG.warn(&quot;unable to read file: &quot; + e.getMessage(), e);                                                </span>
<span class="4043029072030362567" onmouseenter="enter('4043029072030362567');" onmouseout="out('4043029072030362567');" style=""> 645              return;                                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 646          }                                                                                                         </span>
<span  style=""> 647                                                                                                                    </span>
<span class="-8518332035217489539" onmouseenter="enter('-8518332035217489539');" onmouseout="out('-8518332035217489539');" style=""> 648          mPebbleInstallables = mPBWReader.getPebbleInstallables();                                                 </span>
<span class="5818194705482022298" onmouseenter="enter('5818194705482022298');" onmouseout="out('5818194705482022298');" style=""> 649          mCurrentInstallableIndex = 0;                                                                             </span>
<span  style=""> 650                                                                                                                    </span>
<span class="1423594820264173048" onmouseenter="enter('1423594820264173048');" onmouseout="out('1423594820264173048');" style=""> 651          if (mPBWReader.isFirmware()) {                                                                            </span>
<span class="-6874615797996941970" onmouseenter="enter('-6874615797996941970');" onmouseout="out('-6874615797996941970');" style=""> 652              LOG.info(&quot;starting firmware installation&quot;);                                                           </span>
<span class="-7893027413776683580" onmouseenter="enter('-7893027413776683580');" onmouseout="out('-7893027413776683580');" style=""> 653              mIsInstalling = true;                                                                                 </span>
<span class="2991380117683144492" onmouseenter="enter('2991380117683144492');" onmouseout="out('2991380117683144492');" style=""> 654              mInstallSlot = 0;                                                                                     </span>
<span class="5938608831368473017" onmouseenter="enter('5938608831368473017');" onmouseout="out('5938608831368473017');" style=""> 655              writeInstallApp(mPebbleProtocol.encodeInstallFirmwareStart());                                        </span>
<span class="6147346456613268497" onmouseenter="enter('6147346456613268497');" onmouseout="out('6147346456613268497');" style=""> 656              mInstallState = PebbleAppInstallState.START_INSTALL;                                                  </span>
<span  style=""> 657                                                                                                                    </span>
<span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style=""> 658              /*                                                                                                    </span>
<span class="4272043072413570034" onmouseenter="enter('4272043072413570034');" onmouseout="out('4272043072413570034');" style=""> 659               * This is a hack for recovery mode, in which the blocking read has no timeout and the                </span>
<span class="5399824784620980403" onmouseenter="enter('5399824784620980403');" onmouseout="out('5399824784620980403');" style=""> 660               * firmware installation command does not return any ack.                                             </span>
<span class="5951082934844106568" onmouseenter="enter('5951082934844106568');" onmouseout="out('5951082934844106568');" style=""> 661               * In normal mode we would got at least out of the blocking read call after a while.                  </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 662               *                                                                                                    </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 663               *                                                                                                    </span>
<span class="1478144735136743177" onmouseenter="enter('1478144735136743177');" onmouseout="out('1478144735136743177');" style=""> 664               * ... we should really not handle installation from thread that does the blocking read               </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 665               *                                                                                                    </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 666               */                                                                                                   </span>
<span class="-4151709780636609521" onmouseenter="enter('-4151709780636609521');" onmouseout="out('-4151709780636609521');" style=""> 667              writeInstallApp(mPebbleProtocol.encodeGetTime());                                                     </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 668          } else {                                                                                                  </span>
<span class="5609914623056246065" onmouseenter="enter('5609914623056246065');" onmouseout="out('5609914623056246065');" style=""> 669              mCurrentlyInstallingApp = mPBWReader.getGBDeviceApp();                                                </span>
<span class="-492152501567437702" onmouseenter="enter('-492152501567437702');" onmouseout="out('-492152501567437702');" style=""> 670              if (mPebbleProtocol.mFwMajor &gt;= 3 &amp;&amp; !mPBWReader.isLanguage()) {                                      </span>
<span class="2714123758730002125" onmouseenter="enter('2714123758730002125');" onmouseout="out('2714123758730002125');" style=""> 671                  if (appId == 0) {                                                                                 </span>
<span class="-403761314332683960" onmouseenter="enter('-403761314332683960');" onmouseout="out('-403761314332683960');" style=""> 672                      // only install metadata - not the binaries                                                   </span>
<span class="4867948988198814512" onmouseenter="enter('4867948988198814512');" onmouseout="out('4867948988198814512');" style=""><abbr title=" 673                      write(mPebbleProtocol.encodeInstallMetadata(mCurrentlyInstallingApp.getUUID(), mCurrentlyInstallingApp.getName(), mPBWReader.getAppVersion(), mPBWReader.getSdkVersion(), mPBWReader.getFlags(), mPBWReader.getIconId()));"> 673                      write(mPebbleProtocol.encodeInstallMetadata(mCurrentlyInstallingApp.getUUID(), mCurrentlyInstaðŸ”µ</abbr></span>
<span class="-4051160554063647465" onmouseenter="enter('-4051160554063647465');" onmouseout="out('-4051160554063647465');" style=""> 674                      write(mPebbleProtocol.encodeAppStart(mCurrentlyInstallingApp.getUUID(), true));               </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 675                  } else {                                                                                          </span>
<span class="268321394733795474" onmouseenter="enter('268321394733795474');" onmouseout="out('268321394733795474');" style=""> 676                      // this came from an app fetch request, so do the real stuff                                  </span>
<span class="-7893027413776683580" onmouseenter="enter('-7893027413776683580');" onmouseout="out('-7893027413776683580');" style=""> 677                      mIsInstalling = true;                                                                         </span>
<span class="6866943522579684341" onmouseenter="enter('6866943522579684341');" onmouseout="out('6866943522579684341');" style=""> 678                      mInstallSlot = appId;                                                                         </span>
<span class="6147346456613268497" onmouseenter="enter('6147346456613268497');" onmouseout="out('6147346456613268497');" style=""> 679                      mInstallState = PebbleAppInstallState.START_INSTALL;                                          </span>
<span  style=""> 680                                                                                                                    </span>
<span class="1406564667829072525" onmouseenter="enter('1406564667829072525');" onmouseout="out('1406564667829072525');" style=""> 681                      writeInstallApp(mPebbleProtocol.encodeAppFetchAck());                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 682                  }                                                                                                 </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 683              } else {                                                                                              </span>
<span class="-7893027413776683580" onmouseenter="enter('-7893027413776683580');" onmouseout="out('-7893027413776683580');" style=""> 684                  mIsInstalling = true;                                                                             </span>
<span class="7854043658495457291" onmouseenter="enter('7854043658495457291');" onmouseout="out('7854043658495457291');" style=""> 685                  if (mPBWReader.isLanguage()) {                                                                    </span>
<span class="2991380117683144492" onmouseenter="enter('2991380117683144492');" onmouseout="out('2991380117683144492');" style=""> 686                      mInstallSlot = 0;                                                                             </span>
<span class="6147346456613268497" onmouseenter="enter('6147346456613268497');" onmouseout="out('6147346456613268497');" style=""> 687                      mInstallState = PebbleAppInstallState.START_INSTALL;                                          </span>
<span  style=""> 688                                                                                                                    </span>
<span class="-9169766034690988699" onmouseenter="enter('-9169766034690988699');" onmouseout="out('-9169766034690988699');" style=""> 689                      // unblock HACK                                                                               </span>
<span class="-4151709780636609521" onmouseenter="enter('-4151709780636609521');" onmouseout="out('-4151709780636609521');" style=""> 690                      writeInstallApp(mPebbleProtocol.encodeGetTime());                                             </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 691                  } else {                                                                                          </span>
<span class="6749245896015366249" onmouseenter="enter('6749245896015366249');" onmouseout="out('6749245896015366249');" style=""> 692                      mInstallState = PebbleAppInstallState.WAIT_SLOT;                                              </span>
<span class="-5557276013487860944" onmouseenter="enter('-5557276013487860944');" onmouseout="out('-5557276013487860944');" style=""> 693                      writeInstallApp(mPebbleProtocol.encodeAppDelete(mCurrentlyInstallingApp.getUUID()));          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 694                  }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 695              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 696          }                                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 697      }                                                                                                             </span>
<span  style=""> 698                                                                                                                    </span>
<span class="-3632958031962272509" onmouseenter="enter('-3632958031962272509');" onmouseout="out('-3632958031962272509');" style=""> 699      private void finishInstall(boolean hadError) {                                                                </span>
<span class="1640300515722317364" onmouseenter="enter('1640300515722317364');" onmouseout="out('1640300515722317364');" style=""> 700          if (!mIsInstalling) {                                                                                     </span>
<span class="4043029072030362567" onmouseenter="enter('4043029072030362567');" onmouseout="out('4043029072030362567');" style=""> 701              return;                                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 702          }                                                                                                         </span>
<span class="7546809272471924454" onmouseenter="enter('7546809272471924454');" onmouseout="out('7546809272471924454');" style=""> 703          if (hadError) {                                                                                           </span>
<span class="1510893224061013550" onmouseenter="enter('1510893224061013550');" onmouseout="out('1510893224061013550');" style=""><abbr title=" 704              GB.updateInstallNotification(getContext().getString(R.string.installation_failed_), false, 0, getContext());"> 704              GB.updateInstallNotification(getContext().getString(R.string.installation_failed_), false, 0, getConteðŸ”µ</abbr></span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 705          } else {                                                                                                  </span>
<span class="-1798755310811164062" onmouseenter="enter('-1798755310811164062');" onmouseout="out('-1798755310811164062');" style=""><abbr title=" 706              GB.updateInstallNotification(getContext().getString(R.string.installation_successful), false, 0, getContext());"> 706              GB.updateInstallNotification(getContext().getString(R.string.installation_successful), false, 0, getCoðŸ”µ</abbr></span>
<span class="-1022673267036805326" onmouseenter="enter('-1022673267036805326');" onmouseout="out('-1022673267036805326');" style=""> 707              if (mPebbleProtocol.mFwMajor &gt;= 3) {                                                                  </span>
<span class="-6972336671826040876" onmouseenter="enter('-6972336671826040876');" onmouseout="out('-6972336671826040876');" style=""> 708                  String filenameSuffix;                                                                            </span>
<span class="-4516041174588684958" onmouseenter="enter('-4516041174588684958');" onmouseout="out('-4516041174588684958');" style=""> 709                  if (mCurrentlyInstallingApp != null) {                                                            </span>
<span class="-1977040827148362152" onmouseenter="enter('-1977040827148362152');" onmouseout="out('-1977040827148362152');" style=""> 710                      if (mCurrentlyInstallingApp.getType() == GBDeviceApp.Type.WATCHFACE) {                        </span>
<span class="4066163442843372701" onmouseenter="enter('4066163442843372701');" onmouseout="out('4066163442843372701');" style=""> 711                          filenameSuffix = &quot;.watchfaces&quot;;                                                           </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 712                      } else {                                                                                      </span>
<span class="-1542718791393148177" onmouseenter="enter('-1542718791393148177');" onmouseout="out('-1542718791393148177');" style=""> 713                          filenameSuffix = &quot;.watchapps&quot;;                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 714                      }                                                                                             </span>
<span class="7434590360240997484" onmouseenter="enter('7434590360240997484');" onmouseout="out('7434590360240997484');" style=""><abbr title=" 715                      AppManagerActivity.addToAppOrderFile(gbDevice.getAddress() + filenameSuffix, mCurrentlyInstallingApp.getUUID());"> 715                      AppManagerActivity.addToAppOrderFile(gbDevice.getAddress() + filenameSuffix, mCurrentlyInstallðŸ”µ</abbr></span>
<span class="7935209901888052732" onmouseenter="enter('7935209901888052732');" onmouseout="out('7935209901888052732');" style=""> 716                      Intent refreshIntent = new Intent(AbstractAppManagerFragment.ACTION_REFRESH_APPLIST);         </span>
<span class="-1350396105067022557" onmouseenter="enter('-1350396105067022557');" onmouseout="out('-1350396105067022557');" style=""> 717                      LocalBroadcastManager.getInstance(getContext()).sendBroadcast(refreshIntent);                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 718                  }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 719              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 720          }                                                                                                         </span>
<span class="3442713773628960689" onmouseenter="enter('3442713773628960689');" onmouseout="out('3442713773628960689');" style=""> 721          mInstallState = PebbleAppInstallState.UNKNOWN;                                                            </span>
<span  style=""> 722                                                                                                                    </span>
<span class="6208081448933219418" onmouseenter="enter('6208081448933219418');" onmouseout="out('6208081448933219418');" style=""> 723          if (hadError &amp;&amp; mAppInstallToken != -1) {                                                                 </span>
<span class="1039411603055838770" onmouseenter="enter('1039411603055838770');" onmouseout="out('1039411603055838770');" style=""> 724              writeInstallApp(mPebbleProtocol.encodeUploadCancel(mAppInstallToken));                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 725          }                                                                                                         </span>
<span  style=""> 726                                                                                                                    </span>
<span class="5124188328891976822" onmouseenter="enter('5124188328891976822');" onmouseout="out('5124188328891976822');" style=""> 727          mPBWReader = null;                                                                                        </span>
<span class="1304182622527867961" onmouseenter="enter('1304182622527867961');" onmouseout="out('1304182622527867961');" style=""> 728          mIsInstalling = false;                                                                                    </span>
<span class="3809401643932021573" onmouseenter="enter('3809401643932021573');" onmouseout="out('3809401643932021573');" style=""> 729          mCurrentlyInstallingApp = null;                                                                           </span>
<span  style=""> 730                                                                                                                    </span>
<span class="5599892338312940306" onmouseenter="enter('5599892338312940306');" onmouseout="out('5599892338312940306');" style=""> 731          if (mFis != null) {                                                                                       </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 732              try {                                                                                                 </span>
<span class="5464107653723318031" onmouseenter="enter('5464107653723318031');" onmouseout="out('5464107653723318031');" style=""> 733                  mFis.close();                                                                                     </span>
<span class="7080241092423381085" onmouseenter="enter('7080241092423381085');" onmouseout="out('7080241092423381085');" style=""> 734              } catch (IOException e) {                                                                             </span>
<span class="-4407835218921977391" onmouseenter="enter('-4407835218921977391');" onmouseout="out('-4407835218921977391');" style=""> 735                  // ignore                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 736              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 737          }                                                                                                         </span>
<span class="6718599516057736481" onmouseenter="enter('6718599516057736481');" onmouseout="out('6718599516057736481');" style=""> 738          mFis = null;                                                                                              </span>
<span class="-556680889075439690" onmouseenter="enter('-556680889075439690');" onmouseout="out('-556680889075439690');" style=""> 739          mAppInstallToken = -1;                                                                                    </span>
<span class="-4341770816803766254" onmouseenter="enter('-4341770816803766254');" onmouseout="out('-4341770816803766254');" style=""> 740          mInstallSlot = -2;                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 741      }                                                                                                             </span>
<span  style=""> 742                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 743      @Override                                                                                                     </span>
<span class="-4556626830840513273" onmouseenter="enter('-4556626830840513273');" onmouseout="out('-4556626830840513273');" style=""> 744      public void quit() {                                                                                          </span>
<span class="-2245059810018305386" onmouseenter="enter('-2245059810018305386');" onmouseout="out('-2245059810018305386');" style=""> 745          mQuit = true;                                                                                             </span>
<span class="-3944229288018059276" onmouseenter="enter('-3944229288018059276');" onmouseout="out('-3944229288018059276');" style=""> 746          if (mBtSocket != null) {                                                                                  </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 747              try {                                                                                                 </span>
<span class="4957759683762229483" onmouseenter="enter('4957759683762229483');" onmouseout="out('4957759683762229483');" style=""> 748                  mBtSocket.close();                                                                                </span>
<span class="-8338918978083861071" onmouseenter="enter('-8338918978083861071');" onmouseout="out('-8338918978083861071');" style=""> 749              } catch (IOException ignored) {                                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 750              }                                                                                                     </span>
<span class="-4534501040604870855" onmouseenter="enter('-4534501040604870855');" onmouseout="out('-4534501040604870855');" style=""> 751              mBtSocket = null;                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 752          }                                                                                                         </span>
<span class="3388558050890258608" onmouseenter="enter('3388558050890258608');" onmouseout="out('3388558050890258608');" style=""> 753          if (mTCPSocket != null) {                                                                                 </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 754              try {                                                                                                 </span>
<span class="1317722495006749576" onmouseenter="enter('1317722495006749576');" onmouseout="out('1317722495006749576');" style=""> 755                  mTCPSocket.close();                                                                               </span>
<span class="-8338918978083861071" onmouseenter="enter('-8338918978083861071');" onmouseout="out('-8338918978083861071');" style=""> 756              } catch (IOException ignored) {                                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 757              }                                                                                                     </span>
<span class="4396162940795265492" onmouseenter="enter('4396162940795265492');" onmouseout="out('4396162940795265492');" style=""> 758              mTCPSocket = null;                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 759          }                                                                                                         </span>
<span class="-5320890524666996917" onmouseenter="enter('-5320890524666996917');" onmouseout="out('-5320890524666996917');" style=""> 760          if (mPebbleLESupport != null) {                                                                           </span>
<span class="-997532962857791838" onmouseenter="enter('-997532962857791838');" onmouseout="out('-997532962857791838');" style=""> 761              mPebbleLESupport.close();                                                                             </span>
<span class="-2496993078705938002" onmouseenter="enter('-2496993078705938002');" onmouseout="out('-2496993078705938002');" style=""> 762              mPebbleLESupport = null;                                                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 763          }                                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 764      }                                                                                                             </span>
<span  style=""> 765                                                                                                                    </span>
<span class="-4681179840421673206" onmouseenter="enter('-4681179840421673206');" onmouseout="out('-4681179840421673206');" style=""> 766      private enum PebbleAppInstallState {                                                                          </span>
<span class="8504698099528295248" onmouseenter="enter('8504698099528295248');" onmouseout="out('8504698099528295248');" style=""> 767          UNKNOWN,                                                                                                  </span>
<span class="-8062507015798429311" onmouseenter="enter('-8062507015798429311');" onmouseout="out('-8062507015798429311');" style=""> 768          WAIT_SLOT,                                                                                                </span>
<span class="-668951604036061853" onmouseenter="enter('-668951604036061853');" onmouseout="out('-668951604036061853');" style=""> 769          START_INSTALL,                                                                                            </span>
<span class="-1678353837526561027" onmouseenter="enter('-1678353837526561027');" onmouseout="out('-1678353837526561027');" style=""> 770          WAIT_TOKEN,                                                                                               </span>
<span class="-2676567537573092080" onmouseenter="enter('-2676567537573092080');" onmouseout="out('-2676567537573092080');" style=""> 771          UPLOAD_CHUNK,                                                                                             </span>
<span class="-1008243733279055296" onmouseenter="enter('-1008243733279055296');" onmouseout="out('-1008243733279055296');" style=""> 772          UPLOAD_COMMIT,                                                                                            </span>
<span class="-8287073352459983195" onmouseenter="enter('-8287073352459983195');" onmouseout="out('-8287073352459983195');" style=""> 773          WAIT_COMMIT,                                                                                              </span>
<span class="-4008830795114372846" onmouseenter="enter('-4008830795114372846');" onmouseout="out('-4008830795114372846');" style=""> 774          UPLOAD_COMPLETE,                                                                                          </span>
<span class="667328612202802083" onmouseenter="enter('667328612202802083');" onmouseout="out('667328612202802083');" style=""> 775          APP_REFRESH,                                                                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 776      }                                                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 777  }                                                                                                                 </span></pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            