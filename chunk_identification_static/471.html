<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>471</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    471
                    <a href="470.html">prev</a>
                    <a href="472.html">next</a>
                    <a href="471_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    DTStack/flinkStreamSQL_e346a804d69c8cd0124b4eb3d35156cfb5cd0779_core/src/main/java/com/dtstack/flink/sql/side/SideSqlExec.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;e346a804d69c8cd0124b4eb3d35156cfb5cd0779:core/src/main/java/com/dtstack/flink/sql/side/SideSqlExec.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;e346a804d69c8cd0124b4eb3d35156cfb5cd0779^1:core/src/main/java/com/dtstack/flink/sql/side/SideSqlExec.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;e346a804d69c8cd0124b4eb3d35156cfb5cd0779^2:core/src/main/java/com/dtstack/flink/sql/side/SideSqlExec.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;6e351a99f6e8449c76ad55e517a5da6cbb108379:core/src/main/java/com/dtstack/flink/sql/side/SideSqlExec.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[b], [b], [sbj], [sbj], [sbj], [j]], subset: [[bj], [b], [sbj], [sbj], [sbj]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 /*
   2  * Licensed to the Apache Software Foundation (ASF) under one
   3  * or more contributor license agreements.  See the NOTICE file
   4  * distributed with this work for additional information
   5  * regarding copyright ownership.  The ASF licenses this file
   6  * to you under the Apache License, Version 2.0 (the
   7  * &quot;License&quot;); you may not use this file except in compliance
   8  * with the License.  You may obtain a copy of the License at
   9  *
  10  *     http://www.apache.org/licenses/LICENSE-2.0
  11  *
  12  * Unless required by applicable law or agreed to in writing, software
  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15  * See the License for the specific language governing permissions and
  16  * limitations under the License.
  17  */
  18 
  19 
  20 
  21 package com.dtstack.flink.sql.side;
  22 
  23 import org.apache.flink.api.common.typeinfo.TypeInformation;
  24 import org.apache.flink.api.common.typeinfo.Types;
  25 import org.apache.flink.api.java.tuple.Tuple2;
  26 import org.apache.flink.api.java.typeutils.RowTypeInfo;
  27 import org.apache.flink.api.java.typeutils.TupleTypeInfo;
  28 import org.apache.flink.streaming.api.datastream.DataStream;
  29 import org.apache.flink.table.api.Table;
  30 import org.apache.flink.table.api.TableSchema;
  31 import org.apache.flink.table.api.java.StreamTableEnvironment;
  32 import org.apache.flink.table.typeutils.TimeIndicatorTypeInfo;
  33 import org.apache.flink.types.Row;
  34 
  35 import com.dtstack.flink.sql.enums.ECacheType;
  36 import com.dtstack.flink.sql.exec.FlinkSQLExec;
  37 import com.dtstack.flink.sql.parser.CreateTmpTableParser;
  38 import com.dtstack.flink.sql.side.operator.SideAsyncOperator;
  39 import com.dtstack.flink.sql.side.operator.SideWithAllCacheOperator;
  40 import com.dtstack.flink.sql.util.ClassUtil;
  41 import com.dtstack.flink.sql.util.ParseUtils;
  42 import com.dtstack.flink.sql.util.TableUtils;
  43 import com.google.common.base.Preconditions;
  44 import com.google.common.collect.HashBasedTable;
  45 import com.google.common.collect.Lists;
  46 import com.google.common.collect.Maps;
  47 import com.google.common.collect.Sets;
  48 import org.apache.calcite.sql.SqlBasicCall;
  49 import org.apache.calcite.sql.SqlIdentifier;
  50 import org.apache.calcite.sql.SqlKind;
  51 import org.apache.calcite.sql.SqlNode;
  52 import org.apache.calcite.sql.SqlSelect;
  53 import org.apache.calcite.sql.SqlWithItem;
  54 import org.apache.calcite.sql.parser.SqlParseException;
  55 import org.apache.commons.collections.CollectionUtils;
  56 import org.apache.commons.lang3.StringUtils;
  57 import org.slf4j.Logger;
  58 import org.slf4j.LoggerFactory;
  59 
  60 import java.sql.Timestamp;
  61 import java.time.LocalDateTime;
  62 import java.util.Arrays;
  63 import java.util.LinkedList;
  64 import java.util.List;
  65 import java.util.Map;
  66 import java.util.Queue;
  67 import java.util.Set;
  68 
  69 import static org.apache.calcite.sql.SqlKind.*;
  70 
  71 /**
  72  * Reason:
  73  * Date: 2018/7/24
  74  * Company: www.dtstack.com
  75  * @author xuchao
  76  */
  77 
  78 public class SideSqlExec {
  79 
  80     private static final Logger LOG = LoggerFactory.getLogger(SideSqlExec.class);
  81 
  82     private String localSqlPluginPath = null;
  83 
  84     private String tmpFields = null;
  85 
  86     private SidePredicatesParser sidePredicatesParser = new SidePredicatesParser();
  87 
  88     private Map&lt;String, Table&gt; localTableCache = Maps.newHashMap();
  89 
  90 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title="  91     public void exec(String sql, Map&lt;String, AbstractSideTableInfo&gt; sideTableMap, StreamTableEnvironment tableEnv,">  91     public void exec(String sql, Map&lt;String, AbstractSideTableInfo&gt; sideTableMap, StreamTableEnvironment 🔵</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title="  92                      Map&lt;String, Table&gt; tableCache, CreateTmpTableParser.SqlParserResult createView) throws Exception {">  92                      Map&lt;String, Table&gt; tableCache, CreateTmpTableParser.SqlParserResult createView) thro🔵</abbr></span>
  93 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  94 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  95     private static final Logger LOG = LoggerFactory.getLogger(SideSqlExec.class);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  96 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  97     private String localSqlPluginPath = null;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  98 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  99     private String tmpFields = null;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 100 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 101     private SidePredicatesParser sidePredicatesParser = new SidePredicatesParser();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 102 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 103     private Map&lt;String, Table&gt; localTableCache = Maps.newHashMap();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 104 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 105     public void exec(String sql, Map&lt;String, AbstractSideTableInfo&gt; sideTableMap, StreamTableEnvironment tableEnv,"> 105     public void exec(String sql, Map&lt;String, AbstractSideTableInfo&gt; sideTableMap, StreamTableEnvironment 🔵</abbr></span>
 106 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 107     public void exec(String sql,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 108                      Map&lt;String, AbstractSideTableInfo&gt; sideTableMap,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 109                      StreamTableEnvironment tableEnv,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 110                      Map&lt;String, Table&gt; tableCache,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 111                      StreamQueryConfig queryConfig,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 112                      CreateTmpTableParser.SqlParserResult createView,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 113                      String scope) throws Exception {</span>
 114 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 115         if(localSqlPluginPath == null){
 116             throw new RuntimeException(&quot;need to set localSqlPluginPath&quot;);
 117         }
 118 
 119         localTableCache.putAll(tableCache);
 120         try {
 121             sidePredicatesParser.fillPredicatesForSideTable(sql, sideTableMap);
 122         } catch (Exception e) {
 123             LOG.error(&quot;fill predicates for sideTable fail &quot;, e);
 124         }
 125 
 126         if(createView != null){
 127             LOG.warn(&quot;create view info\n&quot;);
 128             LOG.warn(createView.getExecSql());
 129             LOG.warn(&quot;-----------------&quot;);
 130         }
 131 
 132         SideSQLParser sideSQLParser = new SideSQLParser();
 133         sideSQLParser.setLocalTableCache(localTableCache);
 134 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 135         Queue&lt;Object&gt; exeQueue = sideSQLParser.getExeQueue(sql, sideTableMap.keySet());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 136         Object pollObj;</span>
 137 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 138             LOG.warn(createView.getExecSql());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 139             LOG.warn(&quot;-----------------&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 140         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 141 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 142         SideSQLParser sideSQLParser = new SideSQLParser();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 143         sideSQLParser.setLocalTableCache(localTableCache);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 144         Queue&lt;Object&gt; exeQueue = sideSQLParser.getExeQueue(sql, sideTableMap.keySet());</span>
 145 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 146         Queue&lt;Object&gt; exeQueue = sideSQLParser.getExeQueue(sql, sideTableMap.keySet(), scope);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 147         Object pollObj = null;</span>
 148 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 149 
 150         while((pollObj = exeQueue.poll()) != null){
 151 
 152             if(pollObj instanceof SqlNode){
 153                 SqlNode pollSqlNode = (SqlNode) pollObj;
 154 
 155 
 156                 if(pollSqlNode.getKind() == INSERT){
 157                     FlinkSQLExec.sqlUpdate(tableEnv, pollSqlNode.toString());
 158                     if(LOG.isInfoEnabled()){
 159                         LOG.info(&quot;----------real exec sql-----------\n{}&quot;, pollSqlNode.toString());
 160                     }
 161 
 162                 }else if(pollSqlNode.getKind() == AS){
 163                     dealAsSourceTable(tableEnv, pollSqlNode, tableCache);
 164 
 165                 } else if (pollSqlNode.getKind() == WITH_ITEM) {
 166                     SqlWithItem sqlWithItem = (SqlWithItem) pollSqlNode;
 167                     String TableAlias = sqlWithItem.name.toString();
 168                     Table table = tableEnv.sqlQuery(sqlWithItem.query.toString());
 169                     tableEnv.registerTable(TableAlias, table);
 170 
 171                 } else if (pollSqlNode.getKind() == SELECT){
<abbr title=" 172                     Preconditions.checkState(createView != null, &quot;select sql must included by create view&quot;);"> 172                     Preconditions.checkState(createView != null, &quot;select sql must included by create view🔵</abbr>
 173                     Table table = tableEnv.sqlQuery(pollObj.toString());
 174 
 175                     if (createView.getFieldsInfoStr() == null){
 176                         tableEnv.registerTable(createView.getTableName(), table);
 177                     } else {
 178                         if (checkFieldsInfo(createView, table)){
 179                             table = table.as(tmpFields);
 180                             tableEnv.registerTable(createView.getTableName(), table);
 181                         } else {
 182                             throw new RuntimeException(&quot;Fields mismatch&quot;);
 183                         }
 184                     }
 185 
 186                     localTableCache.put(createView.getTableName(), table);
 187                 }
 188 
 189             }else if (pollObj instanceof JoinInfo){
 190                 LOG.info(&quot;----------exec join info----------\n{}&quot;, pollObj.toString());
 191                 joinFun(pollObj, localTableCache, sideTableMap, tableEnv);
 192             }
 193         }
 194 
 195     }
 196 
 197 
 198     /**
 199      * 解析出as查询的表和字段的关系
 200      * @param asSqlNode
 201      * @param tableCache
 202      * @return
 203      */
 204     private FieldReplaceInfo parseAsQuery(SqlBasicCall asSqlNode, Map&lt;String, Table&gt; tableCache){
 205         SqlNode info = asSqlNode.getOperands()[0];
 206         SqlNode alias = asSqlNode.getOperands()[1];
 207 
 208         SqlKind infoKind = info.getKind();
 209         if(infoKind != SELECT){
 210             return null;
 211         }
 212 
 213         List&lt;FieldInfo&gt; extractFieldList = TableUtils.parserSelectField((SqlSelect) info, tableCache);
 214 
 215         HashBasedTable&lt;String, String, String&gt; mappingTable = HashBasedTable.create();
 216         for (FieldInfo fieldInfo : extractFieldList) {
 217             String tableName = fieldInfo.getTable();
 218             String fieldName = fieldInfo.getFieldName();
 219             String mappingFieldName = ParseUtils.dealDuplicateFieldName(mappingTable, fieldName);
 220             mappingTable.put(tableName, fieldName, mappingFieldName);
 221         }
 222 
 223         FieldReplaceInfo replaceInfo = new FieldReplaceInfo();
 224         replaceInfo.setMappingTable(mappingTable);
 225         replaceInfo.setTargetTableName(alias.toString());
 226         replaceInfo.setTargetTableAlias(alias.toString());
 227         return replaceInfo;
 228     }
 229 
 230 
 231     public AliasInfo parseASNode(SqlNode sqlNode) throws SqlParseException {
 232         SqlKind sqlKind = sqlNode.getKind();
 233         if(sqlKind != AS){
 234             throw new RuntimeException(sqlNode + &quot; is not &#x27;as&#x27; operator&quot;);
 235         }
 236 
 237         SqlNode info = ((SqlBasicCall)sqlNode).getOperands()[0];
 238         SqlNode alias = ((SqlBasicCall) sqlNode).getOperands()[1];
 239 
 240         AliasInfo aliasInfo = new AliasInfo();
 241         aliasInfo.setName(info.toString());
 242         aliasInfo.setAlias(alias.toString());
 243 
 244         return aliasInfo;
 245     }
 246 
 247     public RowTypeInfo buildOutRowTypeInfo(List&lt;FieldInfo&gt; sideJoinFieldInfo,
 248                                            HashBasedTable&lt;String, String, String&gt; mappingTable) {
 249         TypeInformation[] sideOutTypes = new TypeInformation[sideJoinFieldInfo.size()];
 250         String[] sideOutNames = new String[sideJoinFieldInfo.size()];
 251         for (int i = 0; i &lt; sideJoinFieldInfo.size(); i++) {
 252             FieldInfo fieldInfo = sideJoinFieldInfo.get(i);
 253             String tableName = fieldInfo.getTable();
 254             String fieldName = fieldInfo.getFieldName();
 255 
 256             String mappingFieldName = mappingTable.get(tableName, fieldName);
<abbr title=" 257             Preconditions.checkNotNull(mappingFieldName, fieldInfo + &quot; not mapping any field! it may be frame bug&quot;);"> 257             Preconditions.checkNotNull(mappingFieldName, fieldInfo + &quot; not mapping any field! it may be f🔵</abbr>
 258 
 259             sideOutTypes[i] = fieldInfo.getTypeInformation();
 260             sideOutNames[i] = mappingFieldName;
 261         }
 262         return new RowTypeInfo(sideOutTypes, sideOutNames);
 263     }
 264 
 265 
 266 
 267     private TypeInformation convertTimeAttributeType(TypeInformation typeInformation) {
 268         if (typeInformation instanceof TimeIndicatorTypeInfo) {
 269             return TypeInformation.of(LocalDateTime.class);
 270         }
 271         return typeInformation;
 272     }
 273 
 274 
 275 
 276 
 277 
 278 
 279     public void setLocalSqlPluginPath(String localSqlPluginPath) {
 280         this.localSqlPluginPath = localSqlPluginPath;
 281     }
 282 
<abbr title=" 283     private Table getTableFromCache(Map&lt;String, Table&gt; localTableCache, String tableAlias, String tableName){"> 283     private Table getTableFromCache(Map&lt;String, Table&gt; localTableCache, String tableAlias, String tableNa🔵</abbr>
 284         Table table = localTableCache.get(tableAlias);
 285         if(table == null){
 286             table = localTableCache.get(tableName);
 287         }
 288 
 289         if(table == null){
 290             throw new RuntimeException(&quot;not register table &quot; + tableAlias);
 291         }
 292 
 293         return table;
 294     }
 295 
 296 
 297     /**
<abbr title=" 298      * Analyzing conditions are very join the dimension tables include all equivalent conditions (i.e., dimension table is the primary key definition"> 298      * Analyzing conditions are very join the dimension tables include all equivalent conditions (i.e., d🔵</abbr>
 299      *
 300      * @return
 301      */
<abbr title=" 302     private boolean checkJoinCondition(SqlNode conditionNode, String sideTableAlias, AbstractSideTableInfo sideTableInfo) {"> 302     private boolean checkJoinCondition(SqlNode conditionNode, String sideTableAlias, AbstractSideTableInf🔵</abbr>
 303         List&lt;String&gt; conditionFields = getConditionFields(conditionNode, sideTableAlias, sideTableInfo);
 304         if(CollectionUtils.isEqualCollection(conditionFields, convertPrimaryAlias(sideTableInfo))){
 305             return true;
 306         }
 307         return false;
 308     }
 309 
 310     private List&lt;String&gt; convertPrimaryAlias(AbstractSideTableInfo sideTableInfo) {
 311         List&lt;String&gt; res = Lists.newArrayList();
 312         sideTableInfo.getPrimaryKeys().forEach(field -&gt; {
 313             res.add(sideTableInfo.getPhysicalFields().getOrDefault(field, field));
 314         });
 315         return res;
 316     }
 317 
<abbr title=" 318     public List&lt;String&gt; getConditionFields(SqlNode conditionNode, String specifyTableName, AbstractSideTableInfo sideTableInfo){"> 318     public List&lt;String&gt; getConditionFields(SqlNode conditionNode, String specifyTableName, AbstractSideTa🔵</abbr>
 319         List&lt;SqlNode&gt; sqlNodeList = Lists.newArrayList();
 320         ParseUtils.parseAnd(conditionNode, sqlNodeList);
 321         List&lt;String&gt; conditionFields = Lists.newArrayList();
 322         for(SqlNode sqlNode : sqlNodeList){
 323             if (!SqlKind.COMPARISON.contains(sqlNode.getKind())) {
 324                 throw new RuntimeException(&quot;not compare operator.&quot;);
 325             }
 326 
 327             SqlIdentifier left = (SqlIdentifier)((SqlBasicCall)sqlNode).getOperands()[0];
 328             SqlIdentifier right = (SqlIdentifier)((SqlBasicCall)sqlNode).getOperands()[1];
 329 
 330             String leftTableName = left.getComponent(0).getSimple();
 331             String rightTableName = right.getComponent(0).getSimple();
 332 
 333             String tableCol = &quot;&quot;;
 334             if(leftTableName.equalsIgnoreCase(specifyTableName)){
 335                 tableCol = left.getComponent(1).getSimple();
 336             }else if(rightTableName.equalsIgnoreCase(specifyTableName)){
 337                 tableCol = right.getComponent(1).getSimple();
 338             }else{
<abbr title=" 339                 throw new RuntimeException(String.format(&quot;side table:%s join condition is wrong&quot;, specifyTableName));"> 339                 throw new RuntimeException(String.format(&quot;side table:%s join condition is wrong&quot;, specify🔵</abbr>
 340             }
 341             tableCol = sideTableInfo.getPhysicalFields().getOrDefault(tableCol, tableCol);
 342             conditionFields.add(tableCol);
 343         }
 344 
 345         return conditionFields;
 346     }
 347 
 348     protected void dealAsSourceTable(StreamTableEnvironment tableEnv,
 349                                      SqlNode pollSqlNode,
 350                                      Map&lt;String, Table&gt; tableCache) throws SqlParseException {
 351 
 352         AliasInfo aliasInfo = parseASNode(pollSqlNode);
 353         if (localTableCache.containsKey(aliasInfo.getName())) {
 354             return;
 355         }
 356 
 357         Table table = tableEnv.sqlQuery(aliasInfo.getName());
 358         tableEnv.registerTable(aliasInfo.getAlias(), table);
 359         localTableCache.put(aliasInfo.getAlias(), table);
 360 
 361         LOG.info(&quot;Register Table {} by {}&quot;, aliasInfo.getAlias(), aliasInfo.getName());
 362 
 363         FieldReplaceInfo fieldReplaceInfo = parseAsQuery((SqlBasicCall) pollSqlNode, tableCache);
 364         if(fieldReplaceInfo == null){
 365            return;
 366         }
 367 
 368         //as 的源表
 369         Set&lt;String&gt; fromTableNameSet = Sets.newHashSet();
 370         SqlNode fromNode = ((SqlBasicCall)pollSqlNode).getOperands()[0];
 371         TableUtils.getFromTableInfo(fromNode, fromTableNameSet);
 372 
 373     }
 374 
 375     private void joinFun(Object pollObj,
 376                          Map&lt;String, Table&gt; localTableCache,
 377                          Map&lt;String, AbstractSideTableInfo&gt; sideTableMap,
 378                          StreamTableEnvironment tableEnv) throws Exception{
 379         JoinInfo joinInfo = (JoinInfo) pollObj;
 380 
 381         JoinScope joinScope = new JoinScope();
 382         JoinScope.ScopeChild leftScopeChild = new JoinScope.ScopeChild();
 383         leftScopeChild.setAlias(joinInfo.getLeftTableAlias());
 384         leftScopeChild.setTableName(joinInfo.getLeftTableName());
 385 
<abbr title=" 386         Table leftTable = getTableFromCache(localTableCache, joinInfo.getLeftTableAlias(), joinInfo.getLeftTableName());"> 386         Table leftTable = getTableFromCache(localTableCache, joinInfo.getLeftTableAlias(), joinInfo.getLe🔵</abbr>
 387 
<abbr title=" 388         RowTypeInfo leftTypeInfo = new RowTypeInfo(leftTable.getSchema().getFieldTypes(), leftTable.getSchema().getFieldNames());"> 388         RowTypeInfo leftTypeInfo = new RowTypeInfo(leftTable.getSchema().getFieldTypes(), leftTable.getSc🔵</abbr>
 389         leftScopeChild.setRowTypeInfo(leftTypeInfo);
 390 
 391         JoinScope.ScopeChild rightScopeChild = new JoinScope.ScopeChild();
 392         rightScopeChild.setAlias(joinInfo.getRightTableAlias());
 393         rightScopeChild.setTableName(joinInfo.getRightTableName());
 394         AbstractSideTableInfo sideTableInfo = sideTableMap.get(joinInfo.getRightTableName());
 395         if(sideTableInfo == null){
 396             sideTableInfo = sideTableMap.get(joinInfo.getRightTableAlias());
 397         }
 398 
 399         if(sideTableInfo == null){
 400             throw new RuntimeException(&quot;can&#x27;t not find side table:&quot; + joinInfo.getRightTableName());
 401         }
 402 
 403 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 404         if(!checkJoinCondition(joinInfo.getCondition(), joinInfo.getRightTableAlias(), sideTableInfo)){</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 405             throw new RuntimeException(&quot;ON condition must contain all equal fields!!!&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 406         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 407 </span>
 408 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 409                         SqlNodeList newSelectList = new SqlNodeList(newSelectNodeList, sqlSelectList.getParserPosition());"> 409                         SqlNodeList newSelectList = new SqlNodeList(newSelectNodeList, sqlSelectList.getP🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 410                         sqlSelect.setSelectList(newSelectList);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 411 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 412                         //where</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 413                         if(whereNode != null){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 414                             SqlNode[] sqlNodeList = ((SqlBasicCall)whereNode).getOperands();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 415                             for(int i =0; i&lt;sqlNodeList.length; i++) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 416                                 SqlNode whereSqlNode = sqlNodeList[i];</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 417                                 SqlNode replaceNode = replaceNodeInfo(whereSqlNode, replaceInfo);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 418                                 sqlNodeList[i] = replaceNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 419                             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 420                         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 421                         if(sqlGroup != null &amp;&amp; CollectionUtils.isNotEmpty(sqlGroup.getList())){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 422                             for( int i=0; i&lt;sqlGroup.getList().size(); i++){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 423                                 SqlNode selectNode = sqlGroup.getList().get(i);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 424                                 SqlNode replaceNode = replaceNodeInfo(selectNode, replaceInfo);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 425                                 sqlGroup.set(i, replaceNode);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 426                             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 427                         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 428                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 429                 }else{</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 430                     throw new RuntimeException(&quot;---not deal type:&quot; + sqlNode);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 431                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 432 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 433                 break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 434             case UNION:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 435                 SqlNode unionLeft = ((SqlBasicCall) sqlNode).getOperands()[0];</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 436                 SqlNode unionRight = ((SqlBasicCall) sqlNode).getOperands()[1];</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 437                 replaceFieldName(unionLeft, replaceInfo);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 438                 replaceFieldName(unionRight, replaceInfo);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 439 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 440                 break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 441             case ORDER_BY:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 442                 SqlOrderBy sqlOrderBy  = (SqlOrderBy) sqlNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 443                 replaceFieldName(sqlOrderBy.query, replaceInfo);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 444                 SqlNodeList orderFiledList = sqlOrderBy.orderList;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 445                 for (int i=0 ;i&lt;orderFiledList.size();i++) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 446                     SqlNode replaceNode = replaceOrderByTableName(orderFiledList.get(i), replaceInfo.getTargetTableAlias());"> 446                     SqlNode replaceNode = replaceOrderByTableName(orderFiledList.get(i), replaceInfo.getT🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 447                     orderFiledList.set(i, replaceNode);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 448                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 449 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 450             default:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 451                 break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 452         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 453     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 454 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 455     private SqlNode replaceOrderByTableName(SqlNode orderNode, String tableAlias) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 456         if(orderNode.getKind() == IDENTIFIER){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 457             SqlIdentifier sqlIdentifier = (SqlIdentifier) orderNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 458             if (sqlIdentifier.names.size() == 1) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 459                 return orderNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 460             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 461             return sqlIdentifier.setName(0, tableAlias);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 462         } else if (orderNode instanceof  SqlBasicCall) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 463             SqlBasicCall sqlBasicCall = (SqlBasicCall) orderNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 464             for(int i=0; i&lt;sqlBasicCall.getOperandList().size(); i++){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 465                 SqlNode sqlNode = sqlBasicCall.getOperandList().get(i);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 466                 sqlBasicCall.getOperands()[i] = replaceOrderByTableName(sqlNode , tableAlias);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 467             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 468             return sqlBasicCall;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 469         } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 470             return orderNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 471         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 472     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 473 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 474     private SqlNode replaceNodeInfo(SqlNode groupNode, FieldReplaceInfo replaceInfo){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 475         if(groupNode.getKind() == IDENTIFIER){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 476             SqlIdentifier sqlIdentifier = (SqlIdentifier) groupNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 477             if(sqlIdentifier.names.size() == 1){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 478                 return sqlIdentifier;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 479             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 480 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 481             String mappingFieldName = replaceInfo.getTargetFieldName(sqlIdentifier.getComponent(0).getSimple(), sqlIdentifier.getComponent(1).getSimple());"> 481             String mappingFieldName = replaceInfo.getTargetFieldName(sqlIdentifier.getComponent(0).getSim🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 482             if(mappingFieldName == null){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 483                 throw new RuntimeException(&quot;can&#x27;t find mapping fieldName:&quot; + sqlIdentifier.toString() );</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 484             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 485 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 486             sqlIdentifier = sqlIdentifier.setName(0, replaceInfo.getTargetTableAlias());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 487             return sqlIdentifier.setName(1, mappingFieldName);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 488         }else if(groupNode instanceof  SqlBasicCall){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 489             SqlBasicCall sqlBasicCall = (SqlBasicCall) groupNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 490             for(int i=0; i&lt;sqlBasicCall.getOperandList().size(); i++){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 491                 SqlNode sqlNode = sqlBasicCall.getOperandList().get(i);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 492                 SqlNode replaceNode = replaceSelectFieldName(sqlNode, replaceInfo);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 493                 sqlBasicCall.getOperands()[i] = replaceNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 494             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 495 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 496             return sqlBasicCall;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 497         }else{</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 498             return groupNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 499         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 500     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 501 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 502     public SqlNode filterNodeWithTargetName(SqlNode sqlNode, String targetTableName) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 503 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 504         SqlKind sqlKind = sqlNode.getKind();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 505         switch (sqlKind){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 506             case SELECT:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 507                 SqlNode fromNode = ((SqlSelect)sqlNode).getFrom();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 508                 if(fromNode.getKind() == AS &amp;&amp; ((SqlBasicCall)fromNode).getOperands()[0].getKind() == IDENTIFIER){"> 508                 if(fromNode.getKind() == AS &amp;&amp; ((SqlBasicCall)fromNode).getOperands()[0].getKind() == IDE🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 509                     if(((SqlBasicCall)fromNode).getOperands()[0].toString().equalsIgnoreCase(targetTableName)){"> 509                     if(((SqlBasicCall)fromNode).getOperands()[0].toString().equalsIgnoreCase(targetTableN🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 510                         return sqlNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 511                     }else{</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 512                         return null;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 513                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 514                 }else{</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 515                     return filterNodeWithTargetName(fromNode, targetTableName);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 516                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 517             case AS:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 518                 SqlNode childNode = ((SqlBasicCall)sqlNode).getOperands()[0];</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 519                 return filterNodeWithTargetName(childNode, targetTableName);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 520             case JOIN:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 521                 SqlNode leftNode = ((SqlJoin)sqlNode).getLeft();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 522                 SqlNode rightNode =  ((SqlJoin)sqlNode).getRight();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 523                 SqlNode leftReturnNode = filterNodeWithTargetName(leftNode, targetTableName);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 524                 SqlNode rightReturnNode = filterNodeWithTargetName(rightNode, targetTableName);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 525 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 526                 if(leftReturnNode != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 527                     return leftReturnNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 528                 }else if(rightReturnNode != null){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 529                     return rightReturnNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 530                 }else{</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 531                     return null;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 532                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 533             default:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 534                 break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 535         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 536 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 537         return null;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 538     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 539 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 540 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 541     public void setLocalSqlPluginPath(String localSqlPluginPath) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 542         this.localSqlPluginPath = localSqlPluginPath;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 543     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 544 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 545     private Table getTableFromCache(Map&lt;String, Table&gt; localTableCache, String tableAlias, String tableName){"> 545     private Table getTableFromCache(Map&lt;String, Table&gt; localTableCache, String tableAlias, String tableNa🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 546         Table table = localTableCache.get(tableAlias);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 547         if(table == null){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 548             table = localTableCache.get(tableName);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 549         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 550 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 551         if(table == null){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 552             throw new RuntimeException(&quot;not register table &quot; + tableName);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 553         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 554 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 555         return table;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 556     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 557 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 558     private List&lt;SqlNode&gt; replaceSelectStarFieldName(SqlNode selectNode, FieldReplaceInfo replaceInfo){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 559         SqlIdentifier sqlIdentifier = (SqlIdentifier) selectNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 560         List&lt;SqlNode&gt; sqlNodes = Lists.newArrayList();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 561         if(sqlIdentifier.isStar()){//处理 [* or table.*]</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 562             int identifierSize = sqlIdentifier.names.size();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 563             Collection&lt;String&gt; columns = null;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 564             if(identifierSize == 1){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 565                 columns = replaceInfo.getMappingTable().values();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 566             }else{</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 567                 columns = replaceInfo.getMappingTable().row(sqlIdentifier.names.get(0)).values();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 568             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 569 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 570             for(String colAlias : columns){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 571                 SqlParserPos sqlParserPos = new SqlParserPos(0, 0);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 572                 List&lt;String&gt; columnInfo = Lists.newArrayList();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 573                 columnInfo.add(replaceInfo.getTargetTableAlias());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 574                 columnInfo.add(colAlias);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 575                 SqlIdentifier sqlIdentifierAlias = new SqlIdentifier(columnInfo, sqlParserPos);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 576                 sqlNodes.add(sqlIdentifierAlias);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 577             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 578 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 579             return sqlNodes;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 580         }else{</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 581             throw new RuntimeException(&quot;is not a star select field.&quot; + selectNode);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 582         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 583     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 584 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 585     private SqlNode replaceSelectFieldName(SqlNode selectNode, FieldReplaceInfo replaceInfo) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 586         if (selectNode.getKind() == AS) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 587             SqlNode leftNode = ((SqlBasicCall) selectNode).getOperands()[0];</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 588             SqlNode replaceNode = replaceSelectFieldName(leftNode, replaceInfo);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 589             if (replaceNode != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 590                 ((SqlBasicCall) selectNode).getOperands()[0] = replaceNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 591             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 592 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 593             return selectNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 594         }else if(selectNode.getKind() == IDENTIFIER){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 595             SqlIdentifier sqlIdentifier = (SqlIdentifier) selectNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 596 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 597             if(sqlIdentifier.names.size() == 1){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 598                 return selectNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 599             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 600 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 601             //Same level mappingTable</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 602             String mappingFieldName = replaceInfo.getTargetFieldName(sqlIdentifier.getComponent(0).getSimple(), sqlIdentifier.getComponent(1).getSimple());"> 602             String mappingFieldName = replaceInfo.getTargetFieldName(sqlIdentifier.getComponent(0).getSim🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 603             if (mappingFieldName == null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 604                 throw new RuntimeException(&quot;can&#x27;t find mapping fieldName:&quot; + selectNode.toString() );</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 605             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 606 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 607             sqlIdentifier = sqlIdentifier.setName(0, replaceInfo.getTargetTableAlias());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 608             sqlIdentifier = sqlIdentifier.setName(1, mappingFieldName);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 609             return sqlIdentifier;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 610         }else if(selectNode.getKind() == LITERAL || selectNode.getKind() == LITERAL_CHAIN){//字面含义</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 611             return selectNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 612         }else if(  AGGREGATE.contains(selectNode.getKind())</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 613                 || AVG_AGG_FUNCTIONS.contains(selectNode.getKind())</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 614                 || COMPARISON.contains(selectNode.getKind())</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 615                 || selectNode.getKind() == OTHER_FUNCTION</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 616                 || selectNode.getKind() == DIVIDE</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 617                 || selectNode.getKind() == CAST</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 618                 || selectNode.getKind() == TRIM</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 619                 || selectNode.getKind() == TIMES</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 620                 || selectNode.getKind() == PLUS</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 621                 || selectNode.getKind() == NOT_IN</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 622                 || selectNode.getKind() == OR</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 623                 || selectNode.getKind() == AND</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 624                 || selectNode.getKind() == MINUS</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 625                 || selectNode.getKind() == TUMBLE</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 626                 || selectNode.getKind() == TUMBLE_START</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 627                 || selectNode.getKind() == TUMBLE_END</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 628                 || selectNode.getKind() == SESSION</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 629                 || selectNode.getKind() == SESSION_START</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 630                 || selectNode.getKind() == SESSION_END</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 631                 || selectNode.getKind() == HOP</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 632                 || selectNode.getKind() == HOP_START</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 633                 || selectNode.getKind() == HOP_END</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 634                 || selectNode.getKind() == BETWEEN</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 635                 || selectNode.getKind() == IS_NULL</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 636                 || selectNode.getKind() == IS_NOT_NULL</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 637                 || selectNode.getKind() == CONTAINS</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 638                 || selectNode.getKind() == TIMESTAMP_ADD</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 639                 || selectNode.getKind() == TIMESTAMP_DIFF</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 640                 || selectNode.getKind() == LIKE</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 641 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 642                 ){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 643             SqlBasicCall sqlBasicCall = (SqlBasicCall) selectNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 644             for(int i=0; i&lt;sqlBasicCall.getOperands().length; i++){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 645                 SqlNode sqlNode = sqlBasicCall.getOperands()[i];</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 646                 if(sqlNode instanceof SqlLiteral){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 647                     continue;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 648                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 649 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 650                 if(sqlNode instanceof SqlDataTypeSpec){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 651                     continue;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 652                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 653 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 654                 SqlNode replaceNode = replaceSelectFieldName(sqlNode, replaceInfo);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 655                 if(replaceNode == null){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 656                     continue;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 657                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 658 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 659                 sqlBasicCall.getOperands()[i] = replaceNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 660             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 661 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 662             return selectNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 663         }else if(selectNode.getKind() == CASE){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 664             SqlCase sqlCase = (SqlCase) selectNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 665             SqlNodeList whenOperands = sqlCase.getWhenOperands();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 666             SqlNodeList thenOperands = sqlCase.getThenOperands();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 667             SqlNode elseNode = sqlCase.getElseOperand();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 668 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 669             for(int i=0; i&lt;whenOperands.size(); i++){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 670                 SqlNode oneOperand = whenOperands.get(i);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 671                 SqlNode replaceNode = replaceSelectFieldName(oneOperand, replaceInfo);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 672                 if (replaceNode != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 673                     whenOperands.set(i, replaceNode);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 674                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 675             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 676 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 677             for(int i=0; i&lt;thenOperands.size(); i++){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 678                 SqlNode oneOperand = thenOperands.get(i);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 679                 SqlNode replaceNode = replaceSelectFieldName(oneOperand, replaceInfo);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 680                 if (replaceNode != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 681                     thenOperands.set(i, replaceNode);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 682                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 683             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 684 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 685             ((SqlCase) selectNode).setOperand(3, replaceSelectFieldName(elseNode, replaceInfo));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 686             return selectNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 687         }else if(selectNode.getKind() == OTHER){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 688             //不处理</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 689             return selectNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 690         }else{</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 691             throw new RuntimeException(String.format(&quot;not support node kind of %s to replace name now.&quot;, selectNode.getKind()));"> 691             throw new RuntimeException(String.format(&quot;not support node kind of %s to replace name now.&quot;, 🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 692         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 693     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 694 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 695     /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 696      * Analyzing conditions are very join the dimension tables include all equivalent conditions (i.e., dimension table is the primary key definition"> 696      * Analyzing conditions are very join the dimension tables include all equivalent conditions (i.e., d🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 697      *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 698      * @return</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 699      */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 700     private boolean checkJoinCondition(SqlNode conditionNode, String sideTableAlias, AbstractSideTableInfo sideTableInfo) {"> 700     private boolean checkJoinCondition(SqlNode conditionNode, String sideTableAlias, AbstractSideTableInf🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 701         List&lt;String&gt; conditionFields = getConditionFields(conditionNode, sideTableAlias, sideTableInfo);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 702         if(CollectionUtils.isEqualCollection(conditionFields, convertPrimaryAlias(sideTableInfo))){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 703             return true;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 704         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 705         return false;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 706     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 707 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 708     private List&lt;String&gt; convertPrimaryAlias(AbstractSideTableInfo sideTableInfo) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 709         List&lt;String&gt; res = Lists.newArrayList();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 710         sideTableInfo.getPrimaryKeys().forEach(field -&gt; {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 711             res.add(sideTableInfo.getPhysicalFields().getOrDefault(field, field));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 712         });</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 713         return res;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 714     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 715 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 716     public List&lt;String&gt; getConditionFields(SqlNode conditionNode, String specifyTableName, AbstractSideTableInfo sideTableInfo){"> 716     public List&lt;String&gt; getConditionFields(SqlNode conditionNode, String specifyTableName, AbstractSideTa🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 717         List&lt;SqlNode&gt; sqlNodeList = Lists.newArrayList();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 718         ParseUtils.parseAnd(conditionNode, sqlNodeList);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 719         List&lt;String&gt; conditionFields = Lists.newArrayList();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 720         for(SqlNode sqlNode : sqlNodeList){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 721             if (!SqlKind.COMPARISON.contains(sqlNode.getKind())) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 722                 throw new RuntimeException(&quot;not compare operator.&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 723             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 724 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 725             SqlIdentifier left = (SqlIdentifier)((SqlBasicCall)sqlNode).getOperands()[0];</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 726             SqlIdentifier right = (SqlIdentifier)((SqlBasicCall)sqlNode).getOperands()[1];</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 727 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 728             String leftTableName = left.getComponent(0).getSimple();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 729             String rightTableName = right.getComponent(0).getSimple();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 730 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 731             String tableCol = &quot;&quot;;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 732             if(leftTableName.equalsIgnoreCase(specifyTableName)){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 733                 tableCol = left.getComponent(1).getSimple();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 734             }else if(rightTableName.equalsIgnoreCase(specifyTableName)){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 735                 tableCol = right.getComponent(1).getSimple();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 736             }else{</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 737                 throw new RuntimeException(String.format(&quot;side table:%s join condition is wrong&quot;, specifyTableName));"> 737                 throw new RuntimeException(String.format(&quot;side table:%s join condition is wrong&quot;, specify🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 738             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 739             tableCol = sideTableInfo.getPhysicalFields().getOrDefault(tableCol, tableCol);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 740             conditionFields.add(tableCol);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 741         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 742 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 743         return conditionFields;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 744     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 745 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 746     protected void dealAsSourceTable(StreamTableEnvironment tableEnv,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 747                                      SqlNode pollSqlNode,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 748                                      Map&lt;String, Table&gt; tableCache,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 749                                      List&lt;FieldReplaceInfo&gt; replaceInfoList) throws SqlParseException {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 750 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 751         AliasInfo aliasInfo = parseAsNode(pollSqlNode);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 752         if (localTableCache.containsKey(aliasInfo.getName())) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 753             return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 754         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 755 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 756         Table table = tableEnv.sqlQuery(aliasInfo.getName());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 757         tableEnv.registerTable(aliasInfo.getAlias(), table);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 758         localTableCache.put(aliasInfo.getAlias(), table);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 759 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 760         LOG.info(&quot;Register Table {} by {}&quot;, aliasInfo.getAlias(), aliasInfo.getName());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 761 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 762         FieldReplaceInfo fieldReplaceInfo = parseAsQuery((SqlBasicCall) pollSqlNode, tableCache);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 763         if(fieldReplaceInfo == null){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 764            return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 765         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 766 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 767         //as 的源表</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 768         Set&lt;String&gt; fromTableNameSet = Sets.newHashSet();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 769         SqlNode fromNode = ((SqlBasicCall)pollSqlNode).getOperands()[0];</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 770         TableUtils.getFromTableInfo(fromNode, fromTableNameSet);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 771         for(FieldReplaceInfo tmp : replaceInfoList){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 772             if(fromTableNameSet.contains(tmp.getTargetTableName())</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 773                     || fromTableNameSet.contains(tmp.getTargetTableAlias())){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 774                 fieldReplaceInfo.setPreNode(tmp);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 775                 break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 776             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 777         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 778         replaceInfoList.add(fieldReplaceInfo);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 779     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 780 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 781     private void joinFun(Object pollObj, Map&lt;String, Table&gt; localTableCache,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 782                          Map&lt;String, AbstractSideTableInfo&gt; sideTableMap, StreamTableEnvironment tableEnv,"> 782                          Map&lt;String, AbstractSideTableInfo&gt; sideTableMap, StreamTableEnvironment tableEnv🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 783                          List&lt;FieldReplaceInfo&gt; replaceInfoList) throws Exception{</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 784         JoinInfo joinInfo = (JoinInfo) pollObj;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 785 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 786         JoinScope joinScope = new JoinScope();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 787         JoinScope.ScopeChild leftScopeChild = new JoinScope.ScopeChild();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 788         leftScopeChild.setAlias(joinInfo.getLeftTableAlias());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 789         leftScopeChild.setTableName(joinInfo.getLeftTableName());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 790 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 791         SqlKind sqlKind = joinInfo.getLeftNode().getKind();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 792         if(sqlKind == AS){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 793             dealAsSourceTable(tableEnv, joinInfo.getLeftNode(), localTableCache, replaceInfoList);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 794         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 795 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 796         Table leftTable = getTableFromCache(localTableCache, joinInfo.getLeftTableAlias(), joinInfo.getLeftTableName());"> 796         Table leftTable = getTableFromCache(localTableCache, joinInfo.getLeftTableAlias(), joinInfo.getLe🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 797         RowTypeInfo leftTypeInfo = new RowTypeInfo(leftTable.getSchema().getTypes(), leftTable.getSchema().getColumnNames());"> 797         RowTypeInfo leftTypeInfo = new RowTypeInfo(leftTable.getSchema().getTypes(), leftTable.getSchema(🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 798         leftScopeChild.setRowTypeInfo(leftTypeInfo);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 799 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 800         JoinScope.ScopeChild rightScopeChild = new JoinScope.ScopeChild();</span>
 801 =======
 802 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 803         rightScopeChild.setRowTypeInfo(sideTableInfo.getRowTypeInfo());
 804 
 805         joinScope.addScope(leftScopeChild);
 806         joinScope.addScope(rightScopeChild);
 807 
 808         HashBasedTable&lt;String, String, String&gt; mappingTable = ((JoinInfo) pollObj).getTableFieldRef();
 809 
 810         //获取两个表的所有字段
<abbr title=" 811         List&lt;FieldInfo&gt; sideJoinFieldInfo = ParserJoinField.getRowTypeInfo(joinInfo.getSelectNode(), joinScope, true);"> 811         List&lt;FieldInfo&gt; sideJoinFieldInfo = ParserJoinField.getRowTypeInfo(joinInfo.getSelectNode(), join🔵</abbr>
 812         //通过join的查询字段信息过滤出需要的字段信息
<abbr title=" 813         sideJoinFieldInfo.removeIf(tmpFieldInfo -&gt; mappingTable.get(tmpFieldInfo.getTable(), tmpFieldInfo.getFieldName()) == null);"> 813         sideJoinFieldInfo.removeIf(tmpFieldInfo -&gt; mappingTable.get(tmpFieldInfo.getTable(), tmpFieldInfo🔵</abbr>
 814 
 815         String leftTableAlias = joinInfo.getLeftTableAlias();
 816         Table targetTable = localTableCache.get(leftTableAlias);
 817         if(targetTable == null){
 818             targetTable = localTableCache.get(joinInfo.getLeftTableName());
 819         }
 820 
<abbr title=" 821         RowTypeInfo typeInfo = new RowTypeInfo(targetTable.getSchema().getFieldTypes(), targetTable.getSchema().getFieldNames());"> 821         RowTypeInfo typeInfo = new RowTypeInfo(targetTable.getSchema().getFieldTypes(), targetTable.getSc🔵</abbr>
 822 
 823         DataStream&lt;Tuple2&lt;Boolean, Row&gt;&gt; adaptStream = tableEnv.toRetractStream(targetTable, Row.class);
 824 
 825         //join side table before keyby ===&gt; Reducing the size of each dimension table cache of async
 826         if (sideTableInfo.isPartitionedJoin()) {
<abbr title=" 827             List&lt;String&gt; leftJoinColList = getConditionFields(joinInfo.getCondition(), joinInfo.getLeftTableAlias(), sideTableInfo);"> 827             List&lt;String&gt; leftJoinColList = getConditionFields(joinInfo.getCondition(), joinInfo.getLeftTa🔵</abbr>
 828             List&lt;String&gt; fieldNames = Arrays.asList(targetTable.getSchema().getFieldNames());
 829             int[] keyIndex = leftJoinColList.stream().mapToInt(fieldNames::indexOf).toArray();
<abbr title=" 830             adaptStream = adaptStream.keyBy(new TupleKeySelector(keyIndex, projectedTypeInfo(keyIndex, targetTable.getSchema())));"> 830             adaptStream = adaptStream.keyBy(new TupleKeySelector(keyIndex, projectedTypeInfo(keyIndex, ta🔵</abbr>
 831         }
 832 
 833         DataStream&lt;Tuple2&lt;Boolean, Row&gt;&gt; dsOut = null;
 834         if(ECacheType.ALL.name().equalsIgnoreCase(sideTableInfo.getCacheType())){
<abbr title=" 835             dsOut = SideWithAllCacheOperator.getSideJoinDataStream(adaptStream, sideTableInfo.getType(), localSqlPluginPath, typeInfo, joinInfo, sideJoinFieldInfo, sideTableInfo);"> 835             dsOut = SideWithAllCacheOperator.getSideJoinDataStream(adaptStream, sideTableInfo.getType(), 🔵</abbr>
 836         }else{
<abbr title=" 837             dsOut = SideAsyncOperator.getSideJoinDataStream(adaptStream, sideTableInfo.getType(), localSqlPluginPath, typeInfo, joinInfo, sideJoinFieldInfo, sideTableInfo);"> 837             dsOut = SideAsyncOperator.getSideJoinDataStream(adaptStream, sideTableInfo.getType(), localSq🔵</abbr>
 838         }
 839 
 840 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 841         HashBasedTable&lt;String, String, String&gt; mappingTable = HashBasedTable.create();</span>
 842 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 843             default:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 844                 break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 845         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 846     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 847 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 848     private SqlNode replaceOrderByTableName(SqlNode orderNode, String tableAlias) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 849         if(orderNode.getKind() == IDENTIFIER){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 850             SqlIdentifier sqlIdentifier = (SqlIdentifier) orderNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 851             if (sqlIdentifier.names.size() == 1) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 852                 return orderNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 853             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 854             return sqlIdentifier.setName(0, tableAlias);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 855         } else if (orderNode instanceof  SqlBasicCall) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 856             SqlBasicCall sqlBasicCall = (SqlBasicCall) orderNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 857             for(int i=0; i&lt;sqlBasicCall.getOperandList().size(); i++){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 858                 SqlNode sqlNode = sqlBasicCall.getOperandList().get(i);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 859                 sqlBasicCall.getOperands()[i] = replaceOrderByTableName(sqlNode , tableAlias);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 860             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 861             return sqlBasicCall;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 862         } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 863             return orderNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 864         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 865     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 866 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 867     private SqlNode replaceNodeInfo(SqlNode groupNode, FieldReplaceInfo replaceInfo){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 868         if(groupNode.getKind() == IDENTIFIER){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 869             SqlIdentifier sqlIdentifier = (SqlIdentifier) groupNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 870             if(sqlIdentifier.names.size() == 1){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 871                 return sqlIdentifier;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 872             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 873 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 874             String mappingFieldName = replaceInfo.getTargetFieldName(sqlIdentifier.getComponent(0).getSimple(), sqlIdentifier.getComponent(1).getSimple());"> 874             String mappingFieldName = replaceInfo.getTargetFieldName(sqlIdentifier.getComponent(0).getSim🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 875             if(mappingFieldName == null){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 876                 throw new RuntimeException(&quot;can&#x27;t find mapping fieldName:&quot; + sqlIdentifier.toString() );</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 877             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 878 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 879             sqlIdentifier = sqlIdentifier.setName(0, replaceInfo.getTargetTableAlias());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 880             return sqlIdentifier.setName(1, mappingFieldName);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 881         }else if(groupNode instanceof  SqlBasicCall){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 882             SqlBasicCall sqlBasicCall = (SqlBasicCall) groupNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 883             for(int i=0; i&lt;sqlBasicCall.getOperandList().size(); i++){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 884                 SqlNode sqlNode = sqlBasicCall.getOperandList().get(i);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 885                 SqlNode replaceNode = replaceSelectFieldName(sqlNode, replaceInfo);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 886                 sqlBasicCall.getOperands()[i] = replaceNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 887             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 888 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 889             return sqlBasicCall;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 890         }else{</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 891             return groupNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 892         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 893     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 894 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 895     public SqlNode filterNodeWithTargetName(SqlNode sqlNode, String targetTableName) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 896 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 897         SqlKind sqlKind = sqlNode.getKind();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 898         switch (sqlKind){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 899             case SELECT:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 900                 SqlNode fromNode = ((SqlSelect)sqlNode).getFrom();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 901                 if(fromNode.getKind() == AS &amp;&amp; ((SqlBasicCall)fromNode).getOperands()[0].getKind() == IDENTIFIER){"> 901                 if(fromNode.getKind() == AS &amp;&amp; ((SqlBasicCall)fromNode).getOperands()[0].getKind() == IDE🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 902                     if(((SqlBasicCall)fromNode).getOperands()[0].toString().equalsIgnoreCase(targetTableName)){"> 902                     if(((SqlBasicCall)fromNode).getOperands()[0].toString().equalsIgnoreCase(targetTableN🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 903                         return sqlNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 904                     }else{</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 905                         return null;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 906                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 907                 }else{</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 908                     return filterNodeWithTargetName(fromNode, targetTableName);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 909                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 910             case AS:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 911                 SqlNode childNode = ((SqlBasicCall)sqlNode).getOperands()[0];</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 912                 return filterNodeWithTargetName(childNode, targetTableName);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 913             case JOIN:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 914                 SqlNode leftNode = ((SqlJoin)sqlNode).getLeft();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 915                 SqlNode rightNode =  ((SqlJoin)sqlNode).getRight();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 916                 SqlNode leftReturnNode = filterNodeWithTargetName(leftNode, targetTableName);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 917                 SqlNode rightReturnNode = filterNodeWithTargetName(rightNode, targetTableName);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 918 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 919                 if(leftReturnNode != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 920                     return leftReturnNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 921                 }else if(rightReturnNode != null){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 922                     return rightReturnNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 923                 }else{</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 924                     return null;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 925                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 926             default:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 927                 break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 928         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 929 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 930         return null;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 931     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 932 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 933 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 934     public void setLocalSqlPluginPath(String localSqlPluginPath) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 935         this.localSqlPluginPath = localSqlPluginPath;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 936     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 937 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 938     private Table getTableFromCache(Map&lt;String, Table&gt; localTableCache, String tableAlias, String tableName){"> 938     private Table getTableFromCache(Map&lt;String, Table&gt; localTableCache, String tableAlias, String tableNa🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 939         Table table = localTableCache.get(tableAlias);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 940         if(table == null){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 941             table = localTableCache.get(tableName);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 942         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 943 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 944         if(table == null){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 945             throw new RuntimeException(&quot;not register table &quot; + tableName);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 946         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 947 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 948         return table;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 949     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 950 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 951     private List&lt;SqlNode&gt; replaceSelectStarFieldName(SqlNode selectNode, FieldReplaceInfo replaceInfo){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 952         SqlIdentifier sqlIdentifier = (SqlIdentifier) selectNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 953         List&lt;SqlNode&gt; sqlNodes = Lists.newArrayList();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 954         if(sqlIdentifier.isStar()){//处理 [* or table.*]</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 955             int identifierSize = sqlIdentifier.names.size();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 956             Collection&lt;String&gt; columns = null;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 957             if(identifierSize == 1){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 958                 columns = replaceInfo.getMappingTable().values();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 959             }else{</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 960                 columns = replaceInfo.getMappingTable().row(sqlIdentifier.names.get(0)).values();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 961             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 962 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 963             for(String colAlias : columns){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 964                 SqlParserPos sqlParserPos = new SqlParserPos(0, 0);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 965                 List&lt;String&gt; columnInfo = Lists.newArrayList();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 966                 columnInfo.add(replaceInfo.getTargetTableAlias());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 967                 columnInfo.add(colAlias);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 968                 SqlIdentifier sqlIdentifierAlias = new SqlIdentifier(columnInfo, sqlParserPos);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 969                 sqlNodes.add(sqlIdentifierAlias);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 970             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 971 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 972             return sqlNodes;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 973         }else{</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 974             throw new RuntimeException(&quot;is not a star select field.&quot; + selectNode);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 975         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 976     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 977 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 978     private SqlNode replaceSelectFieldName(SqlNode selectNode, FieldReplaceInfo replaceInfo) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 979         if (selectNode.getKind() == AS) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 980             SqlNode leftNode = ((SqlBasicCall) selectNode).getOperands()[0];</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 981             SqlNode replaceNode = replaceSelectFieldName(leftNode, replaceInfo);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 982             if (replaceNode != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 983                 ((SqlBasicCall) selectNode).getOperands()[0] = replaceNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 984             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 985 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 986             return selectNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 987         }else if(selectNode.getKind() == IDENTIFIER){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 988             SqlIdentifier sqlIdentifier = (SqlIdentifier) selectNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 989 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 990             if(sqlIdentifier.names.size() == 1){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 991                 return selectNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 992             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 993 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 994             //Same level mappingTable</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 995             String mappingFieldName = replaceInfo.getTargetFieldName(sqlIdentifier.getComponent(0).getSimple(), sqlIdentifier.getComponent(1).getSimple());"> 995             String mappingFieldName = replaceInfo.getTargetFieldName(sqlIdentifier.getComponent(0).getSim🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 996             if (mappingFieldName == null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 997                 throw new RuntimeException(&quot;can&#x27;t find mapping fieldName:&quot; + selectNode.toString() );</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 998             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 999 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1000             sqlIdentifier = sqlIdentifier.setName(0, replaceInfo.getTargetTableAlias());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1001             sqlIdentifier = sqlIdentifier.setName(1, mappingFieldName);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1002             return sqlIdentifier;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1003         }else if(selectNode.getKind() == LITERAL || selectNode.getKind() == LITERAL_CHAIN){//字面含义</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1004             return selectNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1005         }else if(  AGGREGATE.contains(selectNode.getKind())</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1006                 || AVG_AGG_FUNCTIONS.contains(selectNode.getKind())</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1007                 || COMPARISON.contains(selectNode.getKind())</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1008                 || selectNode.getKind() == OTHER_FUNCTION</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1009                 || selectNode.getKind() == DIVIDE</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1010                 || selectNode.getKind() == CAST</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1011                 || selectNode.getKind() == TRIM</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1012                 || selectNode.getKind() == TIMES</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1013                 || selectNode.getKind() == PLUS</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1014                 || selectNode.getKind() == NOT_IN</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1015                 || selectNode.getKind() == OR</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1016                 || selectNode.getKind() == AND</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1017                 || selectNode.getKind() == MINUS</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1018                 || selectNode.getKind() == TUMBLE</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1019                 || selectNode.getKind() == TUMBLE_START</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1020                 || selectNode.getKind() == TUMBLE_END</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1021                 || selectNode.getKind() == SESSION</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1022                 || selectNode.getKind() == SESSION_START</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1023                 || selectNode.getKind() == SESSION_END</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1024                 || selectNode.getKind() == HOP</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1025                 || selectNode.getKind() == HOP_START</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1026                 || selectNode.getKind() == HOP_END</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1027                 || selectNode.getKind() == BETWEEN</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1028                 || selectNode.getKind() == IS_NULL</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1029                 || selectNode.getKind() == IS_NOT_NULL</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1030                 || selectNode.getKind() == CONTAINS</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1031                 || selectNode.getKind() == TIMESTAMP_ADD</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1032                 || selectNode.getKind() == TIMESTAMP_DIFF</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1033                 || selectNode.getKind() == LIKE</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1034 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1035                 ){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1036             SqlBasicCall sqlBasicCall = (SqlBasicCall) selectNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1037             for(int i=0; i&lt;sqlBasicCall.getOperands().length; i++){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1038                 SqlNode sqlNode = sqlBasicCall.getOperands()[i];</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1039                 if(sqlNode instanceof SqlLiteral){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1040                     continue;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1041                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1042 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1043                 if(sqlNode instanceof SqlDataTypeSpec){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1044                     continue;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1045                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1046 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1047                 SqlNode replaceNode = replaceSelectFieldName(sqlNode, replaceInfo);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1048                 if(replaceNode == null){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1049                     continue;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1050                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1051 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1052                 sqlBasicCall.getOperands()[i] = replaceNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1053             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1054 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1055             return selectNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1056         }else if(selectNode.getKind() == CASE){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1057             SqlCase sqlCase = (SqlCase) selectNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1058             SqlNodeList whenOperands = sqlCase.getWhenOperands();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1059             SqlNodeList thenOperands = sqlCase.getThenOperands();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1060             SqlNode elseNode = sqlCase.getElseOperand();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1061 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1062             for(int i=0; i&lt;whenOperands.size(); i++){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1063                 SqlNode oneOperand = whenOperands.get(i);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1064                 SqlNode replaceNode = replaceSelectFieldName(oneOperand, replaceInfo);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1065                 if (replaceNode != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1066                     whenOperands.set(i, replaceNode);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1067                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1068             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1069 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1070             for(int i=0; i&lt;thenOperands.size(); i++){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1071                 SqlNode oneOperand = thenOperands.get(i);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1072                 SqlNode replaceNode = replaceSelectFieldName(oneOperand, replaceInfo);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1073                 if (replaceNode != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1074                     thenOperands.set(i, replaceNode);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1075                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1076             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1077 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1078             ((SqlCase) selectNode).setOperand(3, replaceSelectFieldName(elseNode, replaceInfo));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1079             return selectNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1080         }else if(selectNode.getKind() == OTHER){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1081             //不处理</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1082             return selectNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1083         }else{</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="1084             throw new RuntimeException(String.format(&quot;not support node kind of %s to replace name now.&quot;, selectNode.getKind()));">1084             throw new RuntimeException(String.format(&quot;not support node kind of %s to replace name now.&quot;, 🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1085         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1086     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1087 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1088     /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="1089      * Analyzing conditions are very join the dimension tables include all equivalent conditions (i.e., dimension table is the primary key definition">1089      * Analyzing conditions are very join the dimension tables include all equivalent conditions (i.e., d🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1090      *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1091      * @return</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1092      */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="1093     private boolean checkJoinCondition(SqlNode conditionNode, String sideTableAlias, AbstractSideTableInfo sideTableInfo) {">1093     private boolean checkJoinCondition(SqlNode conditionNode, String sideTableAlias, AbstractSideTableInf🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1094         List&lt;String&gt; conditionFields = getConditionFields(conditionNode, sideTableAlias, sideTableInfo);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1095         if(CollectionUtils.isEqualCollection(conditionFields, convertPrimaryAlias(sideTableInfo))){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1096             return true;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1097         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1098         return false;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1099     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1100 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1101     private List&lt;String&gt; convertPrimaryAlias(AbstractSideTableInfo sideTableInfo) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1102         List&lt;String&gt; res = Lists.newArrayList();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1103         sideTableInfo.getPrimaryKeys().forEach(field -&gt; {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1104             res.add(sideTableInfo.getPhysicalFields().getOrDefault(field, field));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1105         });</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1106         return res;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1107     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1108 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="1109     public List&lt;String&gt; getConditionFields(SqlNode conditionNode, String specifyTableName, AbstractSideTableInfo sideTableInfo){">1109     public List&lt;String&gt; getConditionFields(SqlNode conditionNode, String specifyTableName, AbstractSideTa🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1110         List&lt;SqlNode&gt; sqlNodeList = Lists.newArrayList();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1111         ParseUtils.parseAnd(conditionNode, sqlNodeList);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1112         List&lt;String&gt; conditionFields = Lists.newArrayList();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1113         for(SqlNode sqlNode : sqlNodeList){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1114             if (!SqlKind.COMPARISON.contains(sqlNode.getKind())) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1115                 throw new RuntimeException(&quot;not compare operator.&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1116             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1117 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1118             SqlIdentifier left = (SqlIdentifier)((SqlBasicCall)sqlNode).getOperands()[0];</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1119             SqlIdentifier right = (SqlIdentifier)((SqlBasicCall)sqlNode).getOperands()[1];</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1120 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1121             String leftTableName = left.getComponent(0).getSimple();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1122             String rightTableName = right.getComponent(0).getSimple();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1123 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1124             String tableCol = &quot;&quot;;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1125             if(leftTableName.equalsIgnoreCase(specifyTableName)){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1126                 tableCol = left.getComponent(1).getSimple();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1127             }else if(rightTableName.equalsIgnoreCase(specifyTableName)){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1128                 tableCol = right.getComponent(1).getSimple();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1129             }else{</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="1130                 throw new RuntimeException(String.format(&quot;side table:%s join condition is wrong&quot;, specifyTableName));">1130                 throw new RuntimeException(String.format(&quot;side table:%s join condition is wrong&quot;, specify🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1131             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1132             tableCol = sideTableInfo.getPhysicalFields().getOrDefault(tableCol, tableCol);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1133             conditionFields.add(tableCol);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1134         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1135 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1136         return conditionFields;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1137     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1138 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1139     protected void dealAsSourceTable(StreamTableEnvironment tableEnv,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1140                                      SqlNode pollSqlNode,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1141                                      Map&lt;String, Table&gt; tableCache,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1142                                      List&lt;FieldReplaceInfo&gt; replaceInfoList) throws SqlParseException {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1143 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1144         AliasInfo aliasInfo = parseAsNode(pollSqlNode);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1145         if (localTableCache.containsKey(aliasInfo.getName())) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1146             return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1147         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1148 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1149         Table table = tableEnv.sqlQuery(aliasInfo.getName());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1150         tableEnv.registerTable(aliasInfo.getAlias(), table);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1151         localTableCache.put(aliasInfo.getAlias(), table);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1152 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1153         LOG.info(&quot;Register Table {} by {}&quot;, aliasInfo.getAlias(), aliasInfo.getName());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1154 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1155         FieldReplaceInfo fieldReplaceInfo = parseAsQuery((SqlBasicCall) pollSqlNode, tableCache);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1156         if(fieldReplaceInfo == null){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1157            return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1158         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1159 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1160         //as 的源表</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1161         Set&lt;String&gt; fromTableNameSet = Sets.newHashSet();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1162         SqlNode fromNode = ((SqlBasicCall)pollSqlNode).getOperands()[0];</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1163         TableUtils.getFromTableInfo(fromNode, fromTableNameSet);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1164         for(FieldReplaceInfo tmp : replaceInfoList){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1165             if(fromTableNameSet.contains(tmp.getTargetTableName())</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1166                     || fromTableNameSet.contains(tmp.getTargetTableAlias())){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1167                 fieldReplaceInfo.setPreNode(tmp);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1168                 break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1169             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1170         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1171         replaceInfoList.add(fieldReplaceInfo);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1172     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1173 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1174     private void joinFun(Object pollObj, Map&lt;String, Table&gt; localTableCache,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="1175                          Map&lt;String, AbstractSideTableInfo&gt; sideTableMap, StreamTableEnvironment tableEnv,">1175                          Map&lt;String, AbstractSideTableInfo&gt; sideTableMap, StreamTableEnvironment tableEnv🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1176                          List&lt;FieldReplaceInfo&gt; replaceInfoList) throws Exception{</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1177         JoinInfo joinInfo = (JoinInfo) pollObj;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1178 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1179         JoinScope joinScope = new JoinScope();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1180         JoinScope.ScopeChild leftScopeChild = new JoinScope.ScopeChild();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1181         leftScopeChild.setAlias(joinInfo.getLeftTableAlias());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1182         leftScopeChild.setTableName(joinInfo.getLeftTableName());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1183 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1184         SqlKind sqlKind = joinInfo.getLeftNode().getKind();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1185         if(sqlKind == AS){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1186             dealAsSourceTable(tableEnv, joinInfo.getLeftNode(), localTableCache, replaceInfoList);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1187         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1188 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="1189         Table leftTable = getTableFromCache(localTableCache, joinInfo.getLeftTableAlias(), joinInfo.getLeftTableName());">1189         Table leftTable = getTableFromCache(localTableCache, joinInfo.getLeftTableAlias(), joinInfo.getLe🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="1190         RowTypeInfo leftTypeInfo = new RowTypeInfo(leftTable.getSchema().getTypes(), leftTable.getSchema().getColumnNames());">1190         RowTypeInfo leftTypeInfo = new RowTypeInfo(leftTable.getSchema().getTypes(), leftTable.getSchema(🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1191         leftScopeChild.setRowTypeInfo(leftTypeInfo);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1192 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1193         JoinScope.ScopeChild rightScopeChild = new JoinScope.ScopeChild();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1194         rightScopeChild.setAlias(joinInfo.getRightTableAlias());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1195         rightScopeChild.setTableName(joinInfo.getRightTableName());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1196         AbstractSideTableInfo sideTableInfo = sideTableMap.get(joinInfo.getRightTableName());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1197         if(sideTableInfo == null){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1198             sideTableInfo = sideTableMap.get(joinInfo.getRightTableAlias());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1199         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1200 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1201         if(sideTableInfo == null){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1202             throw new RuntimeException(&quot;can&#x27;t not find side table:&quot; + joinInfo.getRightTableName());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1203         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1204 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1205 //        if(!checkJoinCondition(joinInfo.getCondition(), joinInfo.getRightTableAlias(), sideTableInfo)){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1206 //            throw new RuntimeException(&quot;ON condition must contain all equal fields!!!&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1207 //        }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1208 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1209         rightScopeChild.setRowTypeInfo(sideTableInfo.getRowTypeInfo());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1210 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1211         joinScope.addScope(leftScopeChild);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1212         joinScope.addScope(rightScopeChild);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1213 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1214         //获取两个表的所有字段</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="1215         List&lt;FieldInfo&gt; sideJoinFieldInfo = ParserJoinField.getRowTypeInfo(joinInfo.getSelectNode(), joinScope, true);">1215         List&lt;FieldInfo&gt; sideJoinFieldInfo = ParserJoinField.getRowTypeInfo(joinInfo.getSelectNode(), join🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1216 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1217         String leftTableAlias = joinInfo.getLeftTableAlias();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1218         Table targetTable = localTableCache.get(leftTableAlias);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1219         if(targetTable == null){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1220             targetTable = localTableCache.get(joinInfo.getLeftTableName());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1221         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1222 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="1223         RowTypeInfo typeInfo = new RowTypeInfo(targetTable.getSchema().getTypes(), targetTable.getSchema().getColumnNames());">1223         RowTypeInfo typeInfo = new RowTypeInfo(targetTable.getSchema().getTypes(), targetTable.getSchema(🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1224 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="1225         DataStream&lt;CRow&gt; adaptStream = tableEnv.toRetractStream(targetTable, org.apache.flink.types.Row.class)">1225         DataStream&lt;CRow&gt; adaptStream = tableEnv.toRetractStream(targetTable, org.apache.flink.types.Row.c🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1226                 .map((Tuple2&lt;Boolean, Row&gt; tp2) -&gt; {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1227                     return new CRow(tp2.f1, tp2.f0);</span>
1228 =======
1229 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
1230         RowTypeInfo sideOutTypeInfo = buildOutRowTypeInfo(sideJoinFieldInfo, mappingTable);
1231 
1232         TupleTypeInfo tupleTypeInfo = new TupleTypeInfo(Types.BOOLEAN, sideOutTypeInfo);
1233         dsOut.getTransformation().setOutputType(tupleTypeInfo);
1234 
1235         String targetTableName = joinInfo.getNewTableName();
1236         String targetTableAlias = joinInfo.getNewTableAlias();
1237 
1238         FieldReplaceInfo replaceInfo = new FieldReplaceInfo();
1239         replaceInfo.setMappingTable(mappingTable);
1240         replaceInfo.setTargetTableName(targetTableName);
1241         replaceInfo.setTargetTableAlias(targetTableAlias);
1242 
1243 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1244         //判断之前是不是被替换过,被替换过则设置之前的替换信息作为上一个节点</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1245         for(FieldReplaceInfo tmp : replaceInfoList){</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1246             if(tmp.getTargetTableName().equalsIgnoreCase(joinInfo.getLeftTableName())</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1247             ||tmp.getTargetTableName().equalsIgnoreCase(joinInfo.getLeftTableAlias())){</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1248                 replaceInfo.setPreNode(tmp);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1249                 break;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1250             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1251         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1252 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1253         replaceInfoList.add(replaceInfo);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1254 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1255         List&lt;String&gt; registeredTableName = Arrays.asList(tableEnv.listTables());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1256         if (!registeredTableName.contains(joinInfo.getNewTableName())){</span>
1257 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1258             SqlBasicCall sqlBasicCall = (SqlBasicCall) orderNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1259             for(int i=0; i&lt;sqlBasicCall.getOperandList().size(); i++){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1260                 SqlNode sqlNode = sqlBasicCall.getOperandList().get(i);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1261                 sqlBasicCall.getOperands()[i] = replaceOrderByTableName(sqlNode , tableAlias);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1262             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1263             return sqlBasicCall;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1264         } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1265             return orderNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1266         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1267     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1268 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1269     private SqlNode replaceNodeInfo(SqlNode groupNode, FieldReplaceInfo replaceInfo){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1270         if(groupNode.getKind() == IDENTIFIER){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1271             SqlIdentifier sqlIdentifier = (SqlIdentifier) groupNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1272             if(sqlIdentifier.names.size() == 1){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1273                 return sqlIdentifier;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1274             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1275 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="1276             String mappingFieldName = replaceInfo.getTargetFieldName(sqlIdentifier.getComponent(0).getSimple(), sqlIdentifier.getComponent(1).getSimple());">1276             String mappingFieldName = replaceInfo.getTargetFieldName(sqlIdentifier.getComponent(0).getSim🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1277             if(mappingFieldName == null){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1278                 throw new RuntimeException(&quot;can&#x27;t find mapping fieldName:&quot; + sqlIdentifier.toString() );</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1279             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1280 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1281             sqlIdentifier = sqlIdentifier.setName(0, replaceInfo.getTargetTableAlias());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1282             return sqlIdentifier.setName(1, mappingFieldName);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1283         }else if(groupNode instanceof  SqlBasicCall){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1284             SqlBasicCall sqlBasicCall = (SqlBasicCall) groupNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1285             for(int i=0; i&lt;sqlBasicCall.getOperandList().size(); i++){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1286                 SqlNode sqlNode = sqlBasicCall.getOperandList().get(i);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1287                 SqlNode replaceNode = replaceSelectFieldName(sqlNode, replaceInfo);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1288                 sqlBasicCall.getOperands()[i] = replaceNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1289             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1290 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1291             return sqlBasicCall;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1292         }else{</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1293             return groupNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1294         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1295     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1296 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1297     public SqlNode filterNodeWithTargetName(SqlNode sqlNode, String targetTableName) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1298 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1299         SqlKind sqlKind = sqlNode.getKind();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1300         switch (sqlKind){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1301             case SELECT:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1302                 SqlNode fromNode = ((SqlSelect)sqlNode).getFrom();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="1303                 if(fromNode.getKind() == AS &amp;&amp; ((SqlBasicCall)fromNode).getOperands()[0].getKind() == IDENTIFIER){">1303                 if(fromNode.getKind() == AS &amp;&amp; ((SqlBasicCall)fromNode).getOperands()[0].getKind() == IDE🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="1304                     if(((SqlBasicCall)fromNode).getOperands()[0].toString().equalsIgnoreCase(targetTableName)){">1304                     if(((SqlBasicCall)fromNode).getOperands()[0].toString().equalsIgnoreCase(targetTableN🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1305                         return sqlNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1306                     }else{</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1307                         return null;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1308                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1309                 }else{</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1310                     return filterNodeWithTargetName(fromNode, targetTableName);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1311                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1312             case AS:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1313                 SqlNode childNode = ((SqlBasicCall)sqlNode).getOperands()[0];</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1314                 return filterNodeWithTargetName(childNode, targetTableName);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1315             case JOIN:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1316                 SqlNode leftNode = ((SqlJoin)sqlNode).getLeft();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1317                 SqlNode rightNode =  ((SqlJoin)sqlNode).getRight();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1318                 SqlNode leftReturnNode = filterNodeWithTargetName(leftNode, targetTableName);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1319                 SqlNode rightReturnNode = filterNodeWithTargetName(rightNode, targetTableName);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1320 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1321                 if(leftReturnNode != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1322                     return leftReturnNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1323                 }else if(rightReturnNode != null){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1324                     return rightReturnNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1325                 }else{</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1326                     return null;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1327                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1328             default:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1329                 break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1330         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1331 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1332         return null;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1333     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1334 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1335 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1336     public void setLocalSqlPluginPath(String localSqlPluginPath) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1337         this.localSqlPluginPath = localSqlPluginPath;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1338     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1339 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="1340     private Table getTableFromCache(Map&lt;String, Table&gt; localTableCache, String tableAlias, String tableName){">1340     private Table getTableFromCache(Map&lt;String, Table&gt; localTableCache, String tableAlias, String tableNa🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1341         Table table = localTableCache.get(tableAlias);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1342         if(table == null){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1343             table = localTableCache.get(tableName);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1344         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1345 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1346         if(table == null){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1347             throw new RuntimeException(&quot;not register table &quot; + tableName);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1348         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1349 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1350         return table;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1351     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1352 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1353     private List&lt;SqlNode&gt; replaceSelectStarFieldName(SqlNode selectNode, FieldReplaceInfo replaceInfo){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1354         SqlIdentifier sqlIdentifier = (SqlIdentifier) selectNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1355         List&lt;SqlNode&gt; sqlNodes = Lists.newArrayList();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1356         if(sqlIdentifier.isStar()){//处理 [* or table.*]</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1357             int identifierSize = sqlIdentifier.names.size();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1358             Collection&lt;String&gt; columns = null;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1359             if(identifierSize == 1){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1360                 columns = replaceInfo.getMappingTable().values();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1361             }else{</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1362                 columns = replaceInfo.getMappingTable().row(sqlIdentifier.names.get(0)).values();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1363             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1364 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1365             for(String colAlias : columns){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1366                 SqlParserPos sqlParserPos = new SqlParserPos(0, 0);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1367                 List&lt;String&gt; columnInfo = Lists.newArrayList();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1368                 columnInfo.add(replaceInfo.getTargetTableAlias());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1369                 columnInfo.add(colAlias);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1370                 SqlIdentifier sqlIdentifierAlias = new SqlIdentifier(columnInfo, sqlParserPos);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1371                 sqlNodes.add(sqlIdentifierAlias);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1372             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1373 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1374             return sqlNodes;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1375         }else{</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1376             throw new RuntimeException(&quot;is not a star select field.&quot; + selectNode);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1377         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1378     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1379 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1380     private SqlNode replaceSelectFieldName(SqlNode selectNode, FieldReplaceInfo replaceInfo) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1381         if (selectNode.getKind() == AS) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1382             SqlNode leftNode = ((SqlBasicCall) selectNode).getOperands()[0];</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1383             SqlNode replaceNode = replaceSelectFieldName(leftNode, replaceInfo);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1384             if (replaceNode != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1385                 ((SqlBasicCall) selectNode).getOperands()[0] = replaceNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1386             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1387 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1388             return selectNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1389         }else if(selectNode.getKind() == IDENTIFIER){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1390             SqlIdentifier sqlIdentifier = (SqlIdentifier) selectNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1391 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1392             if(sqlIdentifier.names.size() == 1){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1393                 return selectNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1394             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1395 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1396             //Same level mappingTable</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="1397             String mappingFieldName = replaceInfo.getTargetFieldName(sqlIdentifier.getComponent(0).getSimple(), sqlIdentifier.getComponent(1).getSimple());">1397             String mappingFieldName = replaceInfo.getTargetFieldName(sqlIdentifier.getComponent(0).getSim🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1398             if (mappingFieldName == null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1399                 throw new RuntimeException(&quot;can&#x27;t find mapping fieldName:&quot; + selectNode.toString() );</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1400             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1401 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1402             sqlIdentifier = sqlIdentifier.setName(0, replaceInfo.getTargetTableAlias());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1403             sqlIdentifier = sqlIdentifier.setName(1, mappingFieldName);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1404             return sqlIdentifier;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1405         }else if(selectNode.getKind() == LITERAL || selectNode.getKind() == LITERAL_CHAIN){//字面含义</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1406             return selectNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1407         }else if(  AGGREGATE.contains(selectNode.getKind())</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1408                 || AVG_AGG_FUNCTIONS.contains(selectNode.getKind())</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1409                 || COMPARISON.contains(selectNode.getKind())</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1410                 || selectNode.getKind() == OTHER_FUNCTION</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1411                 || selectNode.getKind() == DIVIDE</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1412                 || selectNode.getKind() == CAST</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1413                 || selectNode.getKind() == TRIM</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1414                 || selectNode.getKind() == TIMES</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1415                 || selectNode.getKind() == PLUS</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1416                 || selectNode.getKind() == NOT_IN</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1417                 || selectNode.getKind() == OR</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1418                 || selectNode.getKind() == AND</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1419                 || selectNode.getKind() == MINUS</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1420                 || selectNode.getKind() == TUMBLE</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1421                 || selectNode.getKind() == TUMBLE_START</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1422                 || selectNode.getKind() == TUMBLE_END</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1423                 || selectNode.getKind() == SESSION</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1424                 || selectNode.getKind() == SESSION_START</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1425                 || selectNode.getKind() == SESSION_END</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1426                 || selectNode.getKind() == HOP</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1427                 || selectNode.getKind() == HOP_START</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1428                 || selectNode.getKind() == HOP_END</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1429                 || selectNode.getKind() == BETWEEN</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1430                 || selectNode.getKind() == IS_NULL</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1431                 || selectNode.getKind() == IS_NOT_NULL</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1432                 || selectNode.getKind() == CONTAINS</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1433                 || selectNode.getKind() == TIMESTAMP_ADD</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1434                 || selectNode.getKind() == TIMESTAMP_DIFF</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1435                 || selectNode.getKind() == LIKE</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1436 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1437                 ){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1438             SqlBasicCall sqlBasicCall = (SqlBasicCall) selectNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1439             for(int i=0; i&lt;sqlBasicCall.getOperands().length; i++){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1440                 SqlNode sqlNode = sqlBasicCall.getOperands()[i];</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1441                 if(sqlNode instanceof SqlLiteral){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1442                     continue;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1443                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1444 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1445                 if(sqlNode instanceof SqlDataTypeSpec){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1446                     continue;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1447                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1448 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1449                 SqlNode replaceNode = replaceSelectFieldName(sqlNode, replaceInfo);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1450                 if(replaceNode == null){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1451                     continue;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1452                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1453 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1454                 sqlBasicCall.getOperands()[i] = replaceNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1455             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1456 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1457             return selectNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1458         }else if(selectNode.getKind() == CASE){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1459             SqlCase sqlCase = (SqlCase) selectNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1460             SqlNodeList whenOperands = sqlCase.getWhenOperands();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1461             SqlNodeList thenOperands = sqlCase.getThenOperands();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1462             SqlNode elseNode = sqlCase.getElseOperand();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1463 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1464             for(int i=0; i&lt;whenOperands.size(); i++){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1465                 SqlNode oneOperand = whenOperands.get(i);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1466                 SqlNode replaceNode = replaceSelectFieldName(oneOperand, replaceInfo);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1467                 if (replaceNode != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1468                     whenOperands.set(i, replaceNode);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1469                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1470             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1471 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1472             for(int i=0; i&lt;thenOperands.size(); i++){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1473                 SqlNode oneOperand = thenOperands.get(i);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1474                 SqlNode replaceNode = replaceSelectFieldName(oneOperand, replaceInfo);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1475                 if (replaceNode != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1476                     thenOperands.set(i, replaceNode);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1477                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1478             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1479 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1480             ((SqlCase) selectNode).setOperand(3, replaceSelectFieldName(elseNode, replaceInfo));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1481             return selectNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1482         }else if(selectNode.getKind() == OTHER){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1483             //不处理</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1484             return selectNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1485         }else{</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="1486             throw new RuntimeException(String.format(&quot;not support node kind of %s to replace name now.&quot;, selectNode.getKind()));">1486             throw new RuntimeException(String.format(&quot;not support node kind of %s to replace name now.&quot;, 🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1487         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1488     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1489 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1490     /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="1491      * Analyzing conditions are very join the dimension tables include all equivalent conditions (i.e., dimension table is the primary key definition">1491      * Analyzing conditions are very join the dimension tables include all equivalent conditions (i.e., d🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1492      *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1493      * @return</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1494      */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="1495     private boolean checkJoinCondition(SqlNode conditionNode, String sideTableAlias, AbstractSideTableInfo sideTableInfo) {">1495     private boolean checkJoinCondition(SqlNode conditionNode, String sideTableAlias, AbstractSideTableInf🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1496         List&lt;String&gt; conditionFields = getConditionFields(conditionNode, sideTableAlias, sideTableInfo);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1497         if(CollectionUtils.isEqualCollection(conditionFields, convertPrimaryAlias(sideTableInfo))){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1498             return true;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1499         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1500         return false;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1501     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1502 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1503     private List&lt;String&gt; convertPrimaryAlias(AbstractSideTableInfo sideTableInfo) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1504         List&lt;String&gt; res = Lists.newArrayList();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1505         sideTableInfo.getPrimaryKeys().forEach(field -&gt; {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1506             res.add(sideTableInfo.getPhysicalFields().getOrDefault(field, field));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1507         });</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1508         return res;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1509     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1510 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="1511     public List&lt;String&gt; getConditionFields(SqlNode conditionNode, String specifyTableName, AbstractSideTableInfo sideTableInfo){">1511     public List&lt;String&gt; getConditionFields(SqlNode conditionNode, String specifyTableName, AbstractSideTa🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1512         List&lt;SqlNode&gt; sqlNodeList = Lists.newArrayList();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1513         ParseUtils.parseAnd(conditionNode, sqlNodeList);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1514         List&lt;String&gt; conditionFields = Lists.newArrayList();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1515         for(SqlNode sqlNode : sqlNodeList){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1516             if (!SqlKind.COMPARISON.contains(sqlNode.getKind())) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1517                 throw new RuntimeException(&quot;not compare operator.&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1518             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1519 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1520             SqlIdentifier left = (SqlIdentifier)((SqlBasicCall)sqlNode).getOperands()[0];</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1521             SqlIdentifier right = (SqlIdentifier)((SqlBasicCall)sqlNode).getOperands()[1];</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1522 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1523             String leftTableName = left.getComponent(0).getSimple();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1524             String rightTableName = right.getComponent(0).getSimple();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1525 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1526             String tableCol = &quot;&quot;;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1527             if(leftTableName.equalsIgnoreCase(specifyTableName)){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1528                 tableCol = left.getComponent(1).getSimple();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1529             }else if(rightTableName.equalsIgnoreCase(specifyTableName)){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1530                 tableCol = right.getComponent(1).getSimple();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1531             }else{</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="1532                 throw new RuntimeException(String.format(&quot;side table:%s join condition is wrong&quot;, specifyTableName));">1532                 throw new RuntimeException(String.format(&quot;side table:%s join condition is wrong&quot;, specify🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1533             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1534             tableCol = sideTableInfo.getPhysicalFields().getOrDefault(tableCol, tableCol);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1535             conditionFields.add(tableCol);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1536         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1537 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1538         return conditionFields;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1539     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1540 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1541     protected void dealAsSourceTable(StreamTableEnvironment tableEnv,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1542                                      SqlNode pollSqlNode,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1543                                      Map&lt;String, Table&gt; tableCache,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1544                                      List&lt;FieldReplaceInfo&gt; replaceInfoList) throws SqlParseException {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1545 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1546         AliasInfo aliasInfo = parseAsNode(pollSqlNode);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1547         if (localTableCache.containsKey(aliasInfo.getName())) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1548             return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1549         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1550 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1551         Table table = tableEnv.sqlQuery(aliasInfo.getName());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1552         tableEnv.registerTable(aliasInfo.getAlias(), table);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1553         localTableCache.put(aliasInfo.getAlias(), table);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1554 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1555         LOG.info(&quot;Register Table {} by {}&quot;, aliasInfo.getAlias(), aliasInfo.getName());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1556 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1557         FieldReplaceInfo fieldReplaceInfo = parseAsQuery((SqlBasicCall) pollSqlNode, tableCache);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1558         if(fieldReplaceInfo == null){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1559            return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1560         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1561 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1562         //as 的源表</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1563         Set&lt;String&gt; fromTableNameSet = Sets.newHashSet();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1564         SqlNode fromNode = ((SqlBasicCall)pollSqlNode).getOperands()[0];</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1565         TableUtils.getFromTableInfo(fromNode, fromTableNameSet);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1566         for(FieldReplaceInfo tmp : replaceInfoList){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1567             if(fromTableNameSet.contains(tmp.getTargetTableName())</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1568                     || fromTableNameSet.contains(tmp.getTargetTableAlias())){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1569                 fieldReplaceInfo.setPreNode(tmp);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1570                 break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1571             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1572         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1573         replaceInfoList.add(fieldReplaceInfo);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1574     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1575 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1576     private void joinFun(Object pollObj, Map&lt;String, Table&gt; localTableCache,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="1577                          Map&lt;String, AbstractSideTableInfo&gt; sideTableMap, StreamTableEnvironment tableEnv,">1577                          Map&lt;String, AbstractSideTableInfo&gt; sideTableMap, StreamTableEnvironment tableEnv🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1578                          List&lt;FieldReplaceInfo&gt; replaceInfoList) throws Exception{</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1579         JoinInfo joinInfo = (JoinInfo) pollObj;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1580 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1581         JoinScope joinScope = new JoinScope();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1582         JoinScope.ScopeChild leftScopeChild = new JoinScope.ScopeChild();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1583         leftScopeChild.setAlias(joinInfo.getLeftTableAlias());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1584         leftScopeChild.setTableName(joinInfo.getLeftTableName());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1585 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1586         SqlKind sqlKind = joinInfo.getLeftNode().getKind();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1587         if(sqlKind == AS){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1588             dealAsSourceTable(tableEnv, joinInfo.getLeftNode(), localTableCache, replaceInfoList);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1589         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1590 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="1591         Table leftTable = getTableFromCache(localTableCache, joinInfo.getLeftTableAlias(), joinInfo.getLeftTableName());">1591         Table leftTable = getTableFromCache(localTableCache, joinInfo.getLeftTableAlias(), joinInfo.getLe🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="1592         RowTypeInfo leftTypeInfo = new RowTypeInfo(leftTable.getSchema().getTypes(), leftTable.getSchema().getColumnNames());">1592         RowTypeInfo leftTypeInfo = new RowTypeInfo(leftTable.getSchema().getTypes(), leftTable.getSchema(🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1593         leftScopeChild.setRowTypeInfo(leftTypeInfo);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1594 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1595         JoinScope.ScopeChild rightScopeChild = new JoinScope.ScopeChild();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1596         rightScopeChild.setAlias(joinInfo.getRightTableAlias());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1597         rightScopeChild.setTableName(joinInfo.getRightTableName());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1598         AbstractSideTableInfo sideTableInfo = sideTableMap.get(joinInfo.getRightTableName());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1599         if(sideTableInfo == null){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1600             sideTableInfo = sideTableMap.get(joinInfo.getRightTableAlias());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1601         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1602 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1603         if(sideTableInfo == null){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1604             throw new RuntimeException(&quot;can&#x27;t not find side table:&quot; + joinInfo.getRightTableName());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1605         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1606 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1607 //        if(!checkJoinCondition(joinInfo.getCondition(), joinInfo.getRightTableAlias(), sideTableInfo)){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1608 //            throw new RuntimeException(&quot;ON condition must contain all equal fields!!!&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1609 //        }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1610 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1611         rightScopeChild.setRowTypeInfo(sideTableInfo.getRowTypeInfo());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1612 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1613         joinScope.addScope(leftScopeChild);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1614         joinScope.addScope(rightScopeChild);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1615 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1616         //获取两个表的所有字段</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="1617         List&lt;FieldInfo&gt; sideJoinFieldInfo = ParserJoinField.getRowTypeInfo(joinInfo.getSelectNode(), joinScope, true);">1617         List&lt;FieldInfo&gt; sideJoinFieldInfo = ParserJoinField.getRowTypeInfo(joinInfo.getSelectNode(), join🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1618 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1619         String leftTableAlias = joinInfo.getLeftTableAlias();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1620         Table targetTable = localTableCache.get(leftTableAlias);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1621         if(targetTable == null){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1622             targetTable = localTableCache.get(joinInfo.getLeftTableName());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1623         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1624 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="1625         RowTypeInfo typeInfo = new RowTypeInfo(targetTable.getSchema().getTypes(), targetTable.getSchema().getColumnNames());">1625         RowTypeInfo typeInfo = new RowTypeInfo(targetTable.getSchema().getTypes(), targetTable.getSchema(🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1626 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="1627         DataStream&lt;CRow&gt; adaptStream = tableEnv.toRetractStream(targetTable, org.apache.flink.types.Row.class)">1627         DataStream&lt;CRow&gt; adaptStream = tableEnv.toRetractStream(targetTable, org.apache.flink.types.Row.c🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1628                 .map((Tuple2&lt;Boolean, Row&gt; tp2) -&gt; {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1629                     return new CRow(tp2.f1, tp2.f0);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1630                 }).returns(CRow.class);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1631 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1632 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1633         //join side table before keyby ===&gt; Reducing the size of each dimension table cache of async</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1634         if (sideTableInfo.isPartitionedJoin()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="1635             List&lt;String&gt; leftJoinColList = getConditionFields(joinInfo.getCondition(), joinInfo.getLeftTableAlias(), sideTableInfo);">1635             List&lt;String&gt; leftJoinColList = getConditionFields(joinInfo.getCondition(), joinInfo.getLeftTa🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1636             List&lt;String&gt; fieldNames = Arrays.asList(targetTable.getSchema().getFieldNames());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1637             int[] keyIndex = leftJoinColList.stream().mapToInt(fieldNames::indexOf).toArray();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="1638             adaptStream = adaptStream.keyBy(new CRowKeySelector(keyIndex, projectedTypeInfo(keyIndex, targetTable.getSchema())));">1638             adaptStream = adaptStream.keyBy(new CRowKeySelector(keyIndex, projectedTypeInfo(keyIndex, tar🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1639         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1640 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1641         DataStream&lt;CRow&gt; dsOut = null;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1642         if(ECacheType.ALL.name().equalsIgnoreCase(sideTableInfo.getCacheType())){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="1643             dsOut = SideWithAllCacheOperator.getSideJoinDataStream(adaptStream, sideTableInfo.getType(), localSqlPluginPath, typeInfo, joinInfo, sideJoinFieldInfo, sideTableInfo);">1643             dsOut = SideWithAllCacheOperator.getSideJoinDataStream(adaptStream, sideTableInfo.getType(), 🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1644         }else{</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="1645             dsOut = SideAsyncOperator.getSideJoinDataStream(adaptStream, sideTableInfo.getType(), localSqlPluginPath, typeInfo, joinInfo, sideJoinFieldInfo, sideTableInfo);">1645             dsOut = SideAsyncOperator.getSideJoinDataStream(adaptStream, sideTableInfo.getType(), localSq🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1646         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1647 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1648         // TODO  将嵌套表中的字段传递过去, 去除冗余的ROWtime</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1649         HashBasedTable&lt;String, String, String&gt; mappingTable = HashBasedTable.create();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1650         RowTypeInfo sideOutTypeInfo = buildOutRowTypeInfo(sideJoinFieldInfo, mappingTable);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1651 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1652         CRowTypeInfo cRowTypeInfo = new CRowTypeInfo(sideOutTypeInfo);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1653         dsOut.getTransformation().setOutputType(cRowTypeInfo);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1654 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1655         String targetTableName = joinInfo.getNewTableName();</span>
1656 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1657         if (!tableEnv.isRegistered(targetTableName)){</span>
1658 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
1659             Table joinTable = tableEnv.fromDataStream(dsOut);
1660             tableEnv.registerTable(targetTableName, joinTable);
1661             localTableCache.put(joinInfo.getNewTableName(), joinTable);
1662         }
1663     }
1664 
1665     private TypeInformation&lt;Row&gt; projectedTypeInfo(int[] fields, TableSchema schema) {
1666         String[] fieldNames = schema.getFieldNames();
1667         TypeInformation&lt;?&gt;[] fieldTypes = schema.getFieldTypes();
1668 
<abbr title="1669         String[] projectedNames = Arrays.stream(fields).mapToObj(i -&gt; fieldNames[i]).toArray(String[]::new);">1669         String[] projectedNames = Arrays.stream(fields).mapToObj(i -&gt; fieldNames[i]).toArray(String[]::ne🔵</abbr>
<abbr title="1670         TypeInformation[] projectedTypes = Arrays.stream(fields).mapToObj(i -&gt; fieldTypes[i]).toArray(TypeInformation[]::new);">1670         TypeInformation[] projectedTypes = Arrays.stream(fields).mapToObj(i -&gt; fieldTypes[i]).toArray(Typ🔵</abbr>
1671         return new RowTypeInfo(projectedTypes, projectedNames);
1672     }
1673 
1674 
1675     private boolean checkFieldsInfo(CreateTmpTableParser.SqlParserResult result, Table table) {
1676         List&lt;String&gt; fieldNames = new LinkedList&lt;&gt;();
1677         String fieldsInfo = result.getFieldsInfoStr();
1678         String[] fields = StringUtils.split(fieldsInfo, &quot;,&quot;);
1679         for (int i = 0; i &lt; fields.length; i++) {
1680             String[] filed = fields[i].split(&quot;\\s&quot;);
1681             if (filed.length &lt; 2 || fields.length != table.getSchema().getFieldCount()){
1682                 return false;
1683             } else {
1684                 String[] filedNameArr = new String[filed.length - 1];
1685                 System.arraycopy(filed, 0, filedNameArr, 0, filed.length - 1);
1686                 String fieldName = String.join(&quot; &quot;, filedNameArr);
1687                 fieldNames.add(fieldName);
1688                 String fieldType = filed[filed.length - 1 ].trim();
1689                 Class fieldClass = ClassUtil.stringConvertClass(fieldType);
1690                 Class tableField = table.getSchema().getFieldType(i).get().getTypeClass();
1691                 if (fieldClass == tableField){
1692                     continue;
1693                 } else {
1694                     return false;
1695                 }
1696             }
1697         }
1698         tmpFields = String.join(&quot;,&quot;, fieldNames);
1699         return true;
1700     }
1701 
1702 }</pre></td>
                            <td><pre>   1 /*
   2  * Licensed to the Apache Software Foundation (ASF) under one
   3  * or more contributor license agreements.  See the NOTICE file
   4  * distributed with this work for additional information
   5  * regarding copyright ownership.  The ASF licenses this file
   6  * to you under the Apache License, Version 2.0 (the
   7  * &quot;License&quot;); you may not use this file except in compliance
   8  * with the License.  You may obtain a copy of the License at
   9  *
  10  *     http://www.apache.org/licenses/LICENSE-2.0
  11  *
  12  * Unless required by applicable law or agreed to in writing, software
  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15  * See the License for the specific language governing permissions and
  16  * limitations under the License.
  17  */
  18 
  19 
  20 
  21 package com.dtstack.flink.sql.side;
  22 
  23 import org.apache.flink.api.common.typeinfo.TypeInformation;
  24 import org.apache.flink.api.common.typeinfo.Types;
  25 import org.apache.flink.api.java.tuple.Tuple2;
  26 import org.apache.flink.api.java.typeutils.RowTypeInfo;
  27 import org.apache.flink.api.java.typeutils.TupleTypeInfo;
  28 import org.apache.flink.streaming.api.datastream.DataStream;
  29 import org.apache.flink.table.api.Table;
  30 import org.apache.flink.table.api.TableSchema;
  31 import org.apache.flink.table.api.java.StreamTableEnvironment;
  32 import org.apache.flink.table.typeutils.TimeIndicatorTypeInfo;
  33 import org.apache.flink.types.Row;
  34 
  35 import com.dtstack.flink.sql.enums.ECacheType;
  36 import com.dtstack.flink.sql.exec.FlinkSQLExec;
  37 import com.dtstack.flink.sql.parser.CreateTmpTableParser;
  38 import com.dtstack.flink.sql.side.operator.SideAsyncOperator;
  39 import com.dtstack.flink.sql.side.operator.SideWithAllCacheOperator;
  40 import com.dtstack.flink.sql.util.ClassUtil;
  41 import com.dtstack.flink.sql.util.ParseUtils;
  42 import com.dtstack.flink.sql.util.TableUtils;
  43 import com.google.common.base.Preconditions;
  44 import com.google.common.collect.HashBasedTable;
  45 import com.google.common.collect.Lists;
  46 import com.google.common.collect.Maps;
  47 import com.google.common.collect.Sets;
  48 import org.apache.calcite.sql.SqlBasicCall;
  49 import org.apache.calcite.sql.SqlIdentifier;
  50 import org.apache.calcite.sql.SqlKind;
  51 import org.apache.calcite.sql.SqlNode;
  52 import org.apache.calcite.sql.SqlSelect;
  53 import org.apache.calcite.sql.SqlWithItem;
  54 import org.apache.calcite.sql.parser.SqlParseException;
  55 import org.apache.commons.collections.CollectionUtils;
  56 import org.apache.commons.lang3.StringUtils;
  57 import org.slf4j.Logger;
  58 import org.slf4j.LoggerFactory;
  59 
  60 import java.sql.Timestamp;
  61 import java.time.LocalDateTime;
  62 import java.util.Arrays;
  63 import java.util.LinkedList;
  64 import java.util.List;
  65 import java.util.Map;
  66 import java.util.Queue;
  67 import java.util.Set;
  68 
  69 import static org.apache.calcite.sql.SqlKind.*;
  70 
  71 /**
  72  * Reason:
  73  * Date: 2018/7/24
  74  * Company: www.dtstack.com
  75  * @author xuchao
  76  */
  77 
  78 public class SideSqlExec {
  79 
  80     private static final Logger LOG = LoggerFactory.getLogger(SideSqlExec.class);
  81 
  82     private String localSqlPluginPath = null;
  83 
  84     private String tmpFields = null;
  85 
  86     private SidePredicatesParser sidePredicatesParser = new SidePredicatesParser();
  87 
  88     private Map&lt;String, Table&gt; localTableCache = Maps.newHashMap();
  89 
  90 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title="  91     public void exec(String sql, Map&lt;String, AbstractSideTableInfo&gt; sideTableMap, StreamTableEnvironment tableEnv,">  91     public void exec(String sql, Map&lt;String, AbstractSideTableInfo&gt; sideTableMap, StreamTableEnvironment 🔵</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title="  92                      Map&lt;String, Table&gt; tableCache, CreateTmpTableParser.SqlParserResult createView) throws Exception {">  92                      Map&lt;String, Table&gt; tableCache, CreateTmpTableParser.SqlParserResult createView) thro🔵</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  93         if(localSqlPluginPath == null){</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  94             throw new RuntimeException(&quot;need to set localSqlPluginPath&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  95         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  96 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  97         localTableCache.putAll(tableCache);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  98         try {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  99             sidePredicatesParser.fillPredicatesForSideTable(sql, sideTableMap);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 100         } catch (Exception e) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 101             LOG.error(&quot;fill predicates for sideTable fail &quot;, e);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 102         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 103 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 104         if(createView != null){</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 105             LOG.warn(&quot;create view info\n&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 106             LOG.warn(createView.getExecSql());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 107             LOG.warn(&quot;-----------------&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 108         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 109 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 110         SideSQLParser sideSQLParser = new SideSQLParser();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 111         sideSQLParser.setLocalTableCache(localTableCache);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 112         Queue&lt;Object&gt; exeQueue = sideSQLParser.getExeQueue(sql, sideTableMap.keySet());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 113         Object pollObj;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 114 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 115         //need clean</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 116         boolean preIsSideJoin = false;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 117         List&lt;FieldReplaceInfo&gt; replaceInfoList = Lists.newArrayList();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 118 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 119         while((pollObj = exeQueue.poll()) != null){</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 120 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 121             if(pollObj instanceof SqlNode){</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 122                 SqlNode pollSqlNode = (SqlNode) pollObj;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 123 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 124                 if(preIsSideJoin){</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 125                     preIsSideJoin = false;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 126                     List&lt;String&gt; fieldNames = null;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 127                     for(FieldReplaceInfo replaceInfo : replaceInfoList){</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 128                         fieldNames = Lists.newArrayList();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 129                         replaceFieldName(pollSqlNode, replaceInfo);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 130                         addAliasForFieldNode(pollSqlNode, fieldNames, replaceInfo.getMappingTable());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 131                     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 132                 }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 133 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 134                 if(pollSqlNode.getKind() == INSERT){</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 135                     FlinkSQLExec.sqlUpdate(tableEnv, pollSqlNode.toString());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 136                     if(LOG.isInfoEnabled()){</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 137                         LOG.info(&quot;----------real exec sql-----------\n{}&quot;, pollSqlNode.toString());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 138                     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 139 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 140                 }else if(pollSqlNode.getKind() == AS){</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 141                     dealAsSourceTable(tableEnv, pollSqlNode, tableCache, replaceInfoList);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 142 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 143                 } else if (pollSqlNode.getKind() == WITH_ITEM) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 144                     SqlWithItem sqlWithItem = (SqlWithItem) pollSqlNode;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 145                     String TableAlias = sqlWithItem.name.toString();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 146                     Table table = tableEnv.sqlQuery(sqlWithItem.query.toString());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 147                     tableEnv.registerTable(TableAlias, table);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 148 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 149                 } else if (pollSqlNode.getKind() == SELECT){</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 150                     Preconditions.checkState(createView != null, &quot;select sql must included by create view&quot;);"> 150                     Preconditions.checkState(createView != null, &quot;select sql must included by create view🔵</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 151                     Table table = tableEnv.sqlQuery(pollObj.toString());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 152 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 153                     if (createView.getFieldsInfoStr() == null){</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 154                         tableEnv.registerTable(createView.getTableName(), table);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 155                     } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 156                         if (checkFieldsInfo(createView, table)){</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 157                             table = table.as(tmpFields);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 158                             tableEnv.registerTable(createView.getTableName(), table);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 159                         } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 160                             throw new RuntimeException(&quot;Fields mismatch&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 161                         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 162                     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 163 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 164                     localTableCache.put(createView.getTableName(), table);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 165                 }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 166 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 167             }else if (pollObj instanceof JoinInfo){</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 168                 LOG.info(&quot;----------exec join info----------\n{}&quot;, pollObj.toString());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 169                 preIsSideJoin = true;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 170                 joinFun(pollObj, localTableCache, sideTableMap, tableEnv, replaceInfoList);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 171             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 172         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 173 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 174     }</span>
 175 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 176     public void exec(String sql, Map&lt;String, AbstractSideTableInfo&gt; sideTableMap, StreamTableEnvironment tableEnv,"> 176     public void exec(String sql, Map&lt;String, AbstractSideTableInfo&gt; sideTableMap, StreamTableEnvironment 🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 177                      Map&lt;String, Table&gt; tableCache, StreamQueryConfig queryConfig, CreateTmpTableParser.SqlParserResult createView) throws Exception {"> 177                      Map&lt;String, Table&gt; tableCache, StreamQueryConfig queryConfig, CreateTmpTableParser.S🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 178         if(localSqlPluginPath == null){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 179             throw new RuntimeException(&quot;need to set localSqlPluginPath&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 180         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 181 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 182         localTableCache.putAll(tableCache);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 183         try {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 184             sidePredicatesParser.fillPredicatesForSideTable(sql, sideTableMap);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 185         } catch (Exception e) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 186             LOG.error(&quot;fill predicates for sideTable fail &quot;, e);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 187         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 188 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 189         if(createView != null){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 190             LOG.warn(&quot;create view info\n&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 191             LOG.warn(createView.getExecSql());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 192             LOG.warn(&quot;-----------------&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 193         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 194 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 195         SideSQLParser sideSQLParser = new SideSQLParser();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 196         sideSQLParser.setLocalTableCache(localTableCache);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 197         Queue&lt;Object&gt; exeQueue = sideSQLParser.getExeQueue(sql, sideTableMap.keySet());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 198         Object pollObj = null;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 199 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 200         //need clean</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 201         boolean preIsSideJoin = false;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 202         List&lt;FieldReplaceInfo&gt; replaceInfoList = Lists.newArrayList();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 203 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 204         while((pollObj = exeQueue.poll()) != null){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 205 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 206             if(pollObj instanceof SqlNode){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 207                 SqlNode pollSqlNode = (SqlNode) pollObj;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 208 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 209                 if(preIsSideJoin){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 210                     preIsSideJoin = false;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 211                     List&lt;String&gt; fieldNames = null;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 212                     for(FieldReplaceInfo replaceInfo : replaceInfoList){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 213                         fieldNames = Lists.newArrayList();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 214                         replaceFieldName(pollSqlNode, replaceInfo);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 215                         addAliasForFieldNode(pollSqlNode, fieldNames, replaceInfo.getMappingTable());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 216                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 217                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 218 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 219                 if(pollSqlNode.getKind() == INSERT){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 220                     FlinkSQLExec.sqlUpdate(tableEnv, pollSqlNode.toString(), queryConfig);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 221                     if(LOG.isInfoEnabled()){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 222                         LOG.info(&quot;----------real exec sql-----------\n{}&quot;, pollSqlNode.toString());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 223                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 224 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 225                 }else if(pollSqlNode.getKind() == AS){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 226                     dealAsSourceTable(tableEnv, pollSqlNode, tableCache, replaceInfoList);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 227 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 228                 } else if (pollSqlNode.getKind() == WITH_ITEM) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 229                     SqlWithItem sqlWithItem = (SqlWithItem) pollSqlNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 230                     String TableAlias = sqlWithItem.name.toString();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 231                     Table table = tableEnv.sqlQuery(sqlWithItem.query.toString());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 232                     tableEnv.registerTable(TableAlias, table);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 233 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 234                 } else if (pollSqlNode.getKind() == SELECT){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 235                     Preconditions.checkState(createView != null, &quot;select sql must included by create view&quot;);"> 235                     Preconditions.checkState(createView != null, &quot;select sql must included by create view🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 236                     Table table = tableEnv.sqlQuery(pollObj.toString());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 237 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 238                     if (createView.getFieldsInfoStr() == null){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 239                         tableEnv.registerTable(createView.getTableName(), table);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 240                     } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 241                         if (checkFieldsInfo(createView, table)){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 242                             table = table.as(tmpFields);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 243                             tableEnv.registerTable(createView.getTableName(), table);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 244                         } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 245                             throw new RuntimeException(&quot;Fields mismatch&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 246                         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 247                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 248 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 249                     localTableCache.put(createView.getTableName(), table);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 250                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 251 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 252             }else if (pollObj instanceof JoinInfo){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 253                 LOG.info(&quot;----------exec join info----------\n{}&quot;, pollObj.toString());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 254                 preIsSideJoin = true;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 255                 joinFun(pollObj, localTableCache, sideTableMap, tableEnv, replaceInfoList);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 256             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 257         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 258 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 259     }</span>
 260 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 261     public void exec(String sql,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 262                      Map&lt;String, AbstractSideTableInfo&gt; sideTableMap,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 263                      StreamTableEnvironment tableEnv,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 264                      Map&lt;String, Table&gt; tableCache,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 265                      StreamQueryConfig queryConfig,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 266                      CreateTmpTableParser.SqlParserResult createView,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 267                      String scope) throws Exception {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 268         if(localSqlPluginPath == null){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 269             throw new RuntimeException(&quot;need to set localSqlPluginPath&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 270         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 271 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 272         localTableCache.putAll(tableCache);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 273         try {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 274             sidePredicatesParser.fillPredicatesForSideTable(sql, sideTableMap);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 275         } catch (Exception e) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 276             LOG.error(&quot;fill predicates for sideTable fail &quot;, e);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 277         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 278 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 279         if(createView != null){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 280             LOG.warn(&quot;create view info\n&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 281             LOG.warn(createView.getExecSql());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 282             LOG.warn(&quot;-----------------&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 283         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 284 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 285         SideSQLParser sideSQLParser = new SideSQLParser();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 286         sideSQLParser.setLocalTableCache(localTableCache);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 287         Queue&lt;Object&gt; exeQueue = sideSQLParser.getExeQueue(sql, sideTableMap.keySet(), scope);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 288         Object pollObj = null;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 289 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 290         while((pollObj = exeQueue.poll()) != null){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 291 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 292             if(pollObj instanceof SqlNode){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 293                 SqlNode pollSqlNode = (SqlNode) pollObj;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 294 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 295 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 296                 if(pollSqlNode.getKind() == INSERT){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 297                     FlinkSQLExec.sqlUpdate(tableEnv, pollSqlNode.toString(), queryConfig);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 298                     if(LOG.isInfoEnabled()){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 299                         LOG.info(&quot;----------real exec sql-----------\n{}&quot;, pollSqlNode.toString());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 300                     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 301 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 302                 }else if(pollSqlNode.getKind() == AS){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 303                     dealAsSourceTable(tableEnv, pollSqlNode, tableCache);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 304 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 305                 } else if (pollSqlNode.getKind() == WITH_ITEM) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 306                     SqlWithItem sqlWithItem = (SqlWithItem) pollSqlNode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 307                     String TableAlias = sqlWithItem.name.toString();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 308                     Table table = tableEnv.sqlQuery(sqlWithItem.query.toString());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 309                     tableEnv.registerTable(TableAlias, table);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 310 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 311                 } else if (pollSqlNode.getKind() == SELECT){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 312                     Preconditions.checkState(createView != null, &quot;select sql must included by create view&quot;);"> 312                     Preconditions.checkState(createView != null, &quot;select sql must included by create view🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 313                     Table table = tableEnv.sqlQuery(pollObj.toString());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 314 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 315                     if (createView.getFieldsInfoStr() == null){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 316                         tableEnv.registerTable(createView.getTableName(), table);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 317                     } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 318                         if (checkFieldsInfo(createView, table)){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 319                             table = table.as(tmpFields);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 320                             tableEnv.registerTable(createView.getTableName(), table);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 321                         } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 322                             throw new RuntimeException(&quot;Fields mismatch&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 323                         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 324                     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 325 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 326                     localTableCache.put(createView.getTableName(), table);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 327                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 328 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 329             }else if (pollObj instanceof JoinInfo){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 330                 LOG.info(&quot;----------exec join info----------\n{}&quot;, pollObj.toString());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 331                 joinFun(pollObj, localTableCache, sideTableMap, tableEnv);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 332             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 333         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 334 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 335     }</span>
 336 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 337 
 338 
 339     /**
 340      * 解析出as查询的表和字段的关系
 341      * @param asSqlNode
 342      * @param tableCache
 343      * @return
 344      */
 345     private FieldReplaceInfo parseAsQuery(SqlBasicCall asSqlNode, Map&lt;String, Table&gt; tableCache){
 346         SqlNode info = asSqlNode.getOperands()[0];
 347         SqlNode alias = asSqlNode.getOperands()[1];
 348 
 349         SqlKind infoKind = info.getKind();
 350         if(infoKind != SELECT){
 351             return null;
 352         }
 353 
 354         List&lt;FieldInfo&gt; extractFieldList = TableUtils.parserSelectField((SqlSelect) info, tableCache);
 355 
 356         HashBasedTable&lt;String, String, String&gt; mappingTable = HashBasedTable.create();
 357         for (FieldInfo fieldInfo : extractFieldList) {
 358             String tableName = fieldInfo.getTable();
 359             String fieldName = fieldInfo.getFieldName();
 360             String mappingFieldName = ParseUtils.dealDuplicateFieldName(mappingTable, fieldName);
 361             mappingTable.put(tableName, fieldName, mappingFieldName);
 362         }
 363 
 364         FieldReplaceInfo replaceInfo = new FieldReplaceInfo();
 365         replaceInfo.setMappingTable(mappingTable);
 366         replaceInfo.setTargetTableName(alias.toString());
 367         replaceInfo.setTargetTableAlias(alias.toString());
 368         return replaceInfo;
 369     }
 370 
 371 
 372     public AliasInfo parseASNode(SqlNode sqlNode) throws SqlParseException {
 373         SqlKind sqlKind = sqlNode.getKind();
 374         if(sqlKind != AS){
 375             throw new RuntimeException(sqlNode + &quot; is not &#x27;as&#x27; operator&quot;);
 376         }
 377 
 378         SqlNode info = ((SqlBasicCall)sqlNode).getOperands()[0];
 379         SqlNode alias = ((SqlBasicCall) sqlNode).getOperands()[1];
 380 
 381         AliasInfo aliasInfo = new AliasInfo();
 382         aliasInfo.setName(info.toString());
 383         aliasInfo.setAlias(alias.toString());
 384 
 385         return aliasInfo;
 386     }
 387 
 388     public RowTypeInfo buildOutRowTypeInfo(List&lt;FieldInfo&gt; sideJoinFieldInfo,
 389                                            HashBasedTable&lt;String, String, String&gt; mappingTable) {
 390         TypeInformation[] sideOutTypes = new TypeInformation[sideJoinFieldInfo.size()];
 391         String[] sideOutNames = new String[sideJoinFieldInfo.size()];
 392         for (int i = 0; i &lt; sideJoinFieldInfo.size(); i++) {
 393             FieldInfo fieldInfo = sideJoinFieldInfo.get(i);
 394             String tableName = fieldInfo.getTable();
 395             String fieldName = fieldInfo.getFieldName();
 396 
 397             String mappingFieldName = mappingTable.get(tableName, fieldName);
<abbr title=" 398             Preconditions.checkNotNull(mappingFieldName, fieldInfo + &quot; not mapping any field! it may be frame bug&quot;);"> 398             Preconditions.checkNotNull(mappingFieldName, fieldInfo + &quot; not mapping any field! it may be f🔵</abbr>
 399 
 400             sideOutTypes[i] = fieldInfo.getTypeInformation();
 401             sideOutNames[i] = mappingFieldName;
 402         }
 403         return new RowTypeInfo(sideOutTypes, sideOutNames);
 404     }
 405 
 406 
 407 
 408     private TypeInformation convertTimeAttributeType(TypeInformation typeInformation) {
 409         if (typeInformation instanceof TimeIndicatorTypeInfo) {
 410             return TypeInformation.of(LocalDateTime.class);
 411         }
 412         return typeInformation;
 413     }
 414 
 415 
 416 
 417 
 418 
 419 
 420     public void setLocalSqlPluginPath(String localSqlPluginPath) {
 421         this.localSqlPluginPath = localSqlPluginPath;
 422     }
 423 
<abbr title=" 424     private Table getTableFromCache(Map&lt;String, Table&gt; localTableCache, String tableAlias, String tableName){"> 424     private Table getTableFromCache(Map&lt;String, Table&gt; localTableCache, String tableAlias, String tableNa🔵</abbr>
 425         Table table = localTableCache.get(tableAlias);
 426         if(table == null){
 427             table = localTableCache.get(tableName);
 428         }
 429 
 430         if(table == null){
 431             throw new RuntimeException(&quot;not register table &quot; + tableAlias);
 432         }
 433 
 434         return table;
 435     }
 436 
 437 
 438     /**
<abbr title=" 439      * Analyzing conditions are very join the dimension tables include all equivalent conditions (i.e., dimension table is the primary key definition"> 439      * Analyzing conditions are very join the dimension tables include all equivalent conditions (i.e., d🔵</abbr>
 440      *
 441      * @return
 442      */
<abbr title=" 443     private boolean checkJoinCondition(SqlNode conditionNode, String sideTableAlias, AbstractSideTableInfo sideTableInfo) {"> 443     private boolean checkJoinCondition(SqlNode conditionNode, String sideTableAlias, AbstractSideTableInf🔵</abbr>
 444         List&lt;String&gt; conditionFields = getConditionFields(conditionNode, sideTableAlias, sideTableInfo);
 445         if(CollectionUtils.isEqualCollection(conditionFields, convertPrimaryAlias(sideTableInfo))){
 446             return true;
 447         }
 448         return false;
 449     }
 450 
 451     private List&lt;String&gt; convertPrimaryAlias(AbstractSideTableInfo sideTableInfo) {
 452         List&lt;String&gt; res = Lists.newArrayList();
 453         sideTableInfo.getPrimaryKeys().forEach(field -&gt; {
 454             res.add(sideTableInfo.getPhysicalFields().getOrDefault(field, field));
 455         });
 456         return res;
 457     }
 458 
<abbr title=" 459     public List&lt;String&gt; getConditionFields(SqlNode conditionNode, String specifyTableName, AbstractSideTableInfo sideTableInfo){"> 459     public List&lt;String&gt; getConditionFields(SqlNode conditionNode, String specifyTableName, AbstractSideTa🔵</abbr>
 460         List&lt;SqlNode&gt; sqlNodeList = Lists.newArrayList();
 461         ParseUtils.parseAnd(conditionNode, sqlNodeList);
 462         List&lt;String&gt; conditionFields = Lists.newArrayList();
 463         for(SqlNode sqlNode : sqlNodeList){
 464             if (!SqlKind.COMPARISON.contains(sqlNode.getKind())) {
 465                 throw new RuntimeException(&quot;not compare operator.&quot;);
 466             }
 467 
 468             SqlIdentifier left = (SqlIdentifier)((SqlBasicCall)sqlNode).getOperands()[0];
 469             SqlIdentifier right = (SqlIdentifier)((SqlBasicCall)sqlNode).getOperands()[1];
 470 
 471             String leftTableName = left.getComponent(0).getSimple();
 472             String rightTableName = right.getComponent(0).getSimple();
 473 
 474             String tableCol = &quot;&quot;;
 475             if(leftTableName.equalsIgnoreCase(specifyTableName)){
 476                 tableCol = left.getComponent(1).getSimple();
 477             }else if(rightTableName.equalsIgnoreCase(specifyTableName)){
 478                 tableCol = right.getComponent(1).getSimple();
 479             }else{
<abbr title=" 480                 throw new RuntimeException(String.format(&quot;side table:%s join condition is wrong&quot;, specifyTableName));"> 480                 throw new RuntimeException(String.format(&quot;side table:%s join condition is wrong&quot;, specify🔵</abbr>
 481             }
 482             tableCol = sideTableInfo.getPhysicalFields().getOrDefault(tableCol, tableCol);
 483             conditionFields.add(tableCol);
 484         }
 485 
 486         return conditionFields;
 487     }
 488 
 489     protected void dealAsSourceTable(StreamTableEnvironment tableEnv,
 490                                      SqlNode pollSqlNode,
 491                                      Map&lt;String, Table&gt; tableCache) throws SqlParseException {
 492 
 493         AliasInfo aliasInfo = parseASNode(pollSqlNode);
 494         if (localTableCache.containsKey(aliasInfo.getName())) {
 495             return;
 496         }
 497 
 498         Table table = tableEnv.sqlQuery(aliasInfo.getName());
 499         tableEnv.registerTable(aliasInfo.getAlias(), table);
 500         localTableCache.put(aliasInfo.getAlias(), table);
 501 
 502         LOG.info(&quot;Register Table {} by {}&quot;, aliasInfo.getAlias(), aliasInfo.getName());
 503 
 504         FieldReplaceInfo fieldReplaceInfo = parseAsQuery((SqlBasicCall) pollSqlNode, tableCache);
 505         if(fieldReplaceInfo == null){
 506            return;
 507         }
 508 
 509         //as 的源表
 510         Set&lt;String&gt; fromTableNameSet = Sets.newHashSet();
 511         SqlNode fromNode = ((SqlBasicCall)pollSqlNode).getOperands()[0];
 512         TableUtils.getFromTableInfo(fromNode, fromTableNameSet);
 513 
 514     }
 515 
 516     private void joinFun(Object pollObj,
 517                          Map&lt;String, Table&gt; localTableCache,
 518                          Map&lt;String, AbstractSideTableInfo&gt; sideTableMap,
 519                          StreamTableEnvironment tableEnv) throws Exception{
 520         JoinInfo joinInfo = (JoinInfo) pollObj;
 521 
 522         JoinScope joinScope = new JoinScope();
 523         JoinScope.ScopeChild leftScopeChild = new JoinScope.ScopeChild();
 524         leftScopeChild.setAlias(joinInfo.getLeftTableAlias());
 525         leftScopeChild.setTableName(joinInfo.getLeftTableName());
 526 
<abbr title=" 527         Table leftTable = getTableFromCache(localTableCache, joinInfo.getLeftTableAlias(), joinInfo.getLeftTableName());"> 527         Table leftTable = getTableFromCache(localTableCache, joinInfo.getLeftTableAlias(), joinInfo.getLe🔵</abbr>
 528 
<abbr title=" 529         RowTypeInfo leftTypeInfo = new RowTypeInfo(leftTable.getSchema().getFieldTypes(), leftTable.getSchema().getFieldNames());"> 529         RowTypeInfo leftTypeInfo = new RowTypeInfo(leftTable.getSchema().getFieldTypes(), leftTable.getSc🔵</abbr>
 530         leftScopeChild.setRowTypeInfo(leftTypeInfo);
 531 
 532         JoinScope.ScopeChild rightScopeChild = new JoinScope.ScopeChild();
 533         rightScopeChild.setAlias(joinInfo.getRightTableAlias());
 534         rightScopeChild.setTableName(joinInfo.getRightTableName());
 535         AbstractSideTableInfo sideTableInfo = sideTableMap.get(joinInfo.getRightTableName());
 536         if(sideTableInfo == null){
 537             sideTableInfo = sideTableMap.get(joinInfo.getRightTableAlias());
 538         }
 539 
 540         if(sideTableInfo == null){
 541             throw new RuntimeException(&quot;can&#x27;t not find side table:&quot; + joinInfo.getRightTableName());
 542         }
 543 
 544 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 545         if(!checkJoinCondition(joinInfo.getCondition(), joinInfo.getRightTableAlias(), sideTableInfo)){</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 546             throw new RuntimeException(&quot;ON condition must contain all equal fields!!!&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 547         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 548 </span>
 549 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 550         if(sideTableInfo == null){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 551             throw new RuntimeException(&quot;can&#x27;t not find side table:&quot; + joinInfo.getRightTableName());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 552         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 553 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 554 //        if(!checkJoinCondition(joinInfo.getCondition(), joinInfo.getRightTableAlias(), sideTableInfo)){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 555 //            throw new RuntimeException(&quot;ON condition must contain all equal fields!!!&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 556 //        }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 557 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 558         rightScopeChild.setRowTypeInfo(sideTableInfo.getRowTypeInfo());</span>
 559 =======
 560 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 561         rightScopeChild.setRowTypeInfo(sideTableInfo.getRowTypeInfo());
 562 
 563         joinScope.addScope(leftScopeChild);
 564         joinScope.addScope(rightScopeChild);
 565 
 566         HashBasedTable&lt;String, String, String&gt; mappingTable = ((JoinInfo) pollObj).getTableFieldRef();
 567 
 568         //获取两个表的所有字段
<abbr title=" 569         List&lt;FieldInfo&gt; sideJoinFieldInfo = ParserJoinField.getRowTypeInfo(joinInfo.getSelectNode(), joinScope, true);"> 569         List&lt;FieldInfo&gt; sideJoinFieldInfo = ParserJoinField.getRowTypeInfo(joinInfo.getSelectNode(), join🔵</abbr>
 570         //通过join的查询字段信息过滤出需要的字段信息
<abbr title=" 571         sideJoinFieldInfo.removeIf(tmpFieldInfo -&gt; mappingTable.get(tmpFieldInfo.getTable(), tmpFieldInfo.getFieldName()) == null);"> 571         sideJoinFieldInfo.removeIf(tmpFieldInfo -&gt; mappingTable.get(tmpFieldInfo.getTable(), tmpFieldInfo🔵</abbr>
 572 
 573         String leftTableAlias = joinInfo.getLeftTableAlias();
 574         Table targetTable = localTableCache.get(leftTableAlias);
 575         if(targetTable == null){
 576             targetTable = localTableCache.get(joinInfo.getLeftTableName());
 577         }
 578 
<abbr title=" 579         RowTypeInfo typeInfo = new RowTypeInfo(targetTable.getSchema().getFieldTypes(), targetTable.getSchema().getFieldNames());"> 579         RowTypeInfo typeInfo = new RowTypeInfo(targetTable.getSchema().getFieldTypes(), targetTable.getSc🔵</abbr>
 580 
 581         DataStream&lt;Tuple2&lt;Boolean, Row&gt;&gt; adaptStream = tableEnv.toRetractStream(targetTable, Row.class);
 582 
 583         //join side table before keyby ===&gt; Reducing the size of each dimension table cache of async
 584         if (sideTableInfo.isPartitionedJoin()) {
<abbr title=" 585             List&lt;String&gt; leftJoinColList = getConditionFields(joinInfo.getCondition(), joinInfo.getLeftTableAlias(), sideTableInfo);"> 585             List&lt;String&gt; leftJoinColList = getConditionFields(joinInfo.getCondition(), joinInfo.getLeftTa🔵</abbr>
 586             List&lt;String&gt; fieldNames = Arrays.asList(targetTable.getSchema().getFieldNames());
 587             int[] keyIndex = leftJoinColList.stream().mapToInt(fieldNames::indexOf).toArray();
<abbr title=" 588             adaptStream = adaptStream.keyBy(new TupleKeySelector(keyIndex, projectedTypeInfo(keyIndex, targetTable.getSchema())));"> 588             adaptStream = adaptStream.keyBy(new TupleKeySelector(keyIndex, projectedTypeInfo(keyIndex, ta🔵</abbr>
 589         }
 590 
 591         DataStream&lt;Tuple2&lt;Boolean, Row&gt;&gt; dsOut = null;
 592         if(ECacheType.ALL.name().equalsIgnoreCase(sideTableInfo.getCacheType())){
<abbr title=" 593             dsOut = SideWithAllCacheOperator.getSideJoinDataStream(adaptStream, sideTableInfo.getType(), localSqlPluginPath, typeInfo, joinInfo, sideJoinFieldInfo, sideTableInfo);"> 593             dsOut = SideWithAllCacheOperator.getSideJoinDataStream(adaptStream, sideTableInfo.getType(), 🔵</abbr>
 594         }else{
<abbr title=" 595             dsOut = SideAsyncOperator.getSideJoinDataStream(adaptStream, sideTableInfo.getType(), localSqlPluginPath, typeInfo, joinInfo, sideJoinFieldInfo, sideTableInfo);"> 595             dsOut = SideAsyncOperator.getSideJoinDataStream(adaptStream, sideTableInfo.getType(), localSq🔵</abbr>
 596         }
 597 
 598 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 599         HashBasedTable&lt;String, String, String&gt; mappingTable = HashBasedTable.create();</span>
 600 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 601         }else{</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 602             dsOut = SideAsyncOperator.getSideJoinDataStream(adaptStream, sideTableInfo.getType(), localSqlPluginPath, typeInfo, joinInfo, sideJoinFieldInfo, sideTableInfo);"> 602             dsOut = SideAsyncOperator.getSideJoinDataStream(adaptStream, sideTableInfo.getType(), localSq🔵</abbr></span>
 603 =======
 604 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 605         RowTypeInfo sideOutTypeInfo = buildOutRowTypeInfo(sideJoinFieldInfo, mappingTable);
 606 
 607         TupleTypeInfo tupleTypeInfo = new TupleTypeInfo(Types.BOOLEAN, sideOutTypeInfo);
 608         dsOut.getTransformation().setOutputType(tupleTypeInfo);
 609 
 610         String targetTableName = joinInfo.getNewTableName();
 611         String targetTableAlias = joinInfo.getNewTableAlias();
 612 
 613         FieldReplaceInfo replaceInfo = new FieldReplaceInfo();
 614         replaceInfo.setMappingTable(mappingTable);
 615         replaceInfo.setTargetTableName(targetTableName);
 616         replaceInfo.setTargetTableAlias(targetTableAlias);
 617 
 618 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 619         //判断之前是不是被替换过,被替换过则设置之前的替换信息作为上一个节点</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 620         for(FieldReplaceInfo tmp : replaceInfoList){</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 621             if(tmp.getTargetTableName().equalsIgnoreCase(joinInfo.getLeftTableName())</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 622             ||tmp.getTargetTableName().equalsIgnoreCase(joinInfo.getLeftTableAlias())){</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 623                 replaceInfo.setPreNode(tmp);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 624                 break;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 625             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 626         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 627 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 628         replaceInfoList.add(replaceInfo);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 629 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 630         List&lt;String&gt; registeredTableName = Arrays.asList(tableEnv.listTables());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 631         if (!registeredTableName.contains(joinInfo.getNewTableName())){</span>
 632 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 633 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 634         FieldReplaceInfo replaceInfo = new FieldReplaceInfo();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 635         replaceInfo.setMappingTable(mappingTable);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 636         replaceInfo.setTargetTableName(targetTableName);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 637         replaceInfo.setTargetTableAlias(targetTableAlias);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 638 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 639         //判断之前是不是被替换过,被替换过则设置之前的替换信息作为上一个节点</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 640         for(FieldReplaceInfo tmp : replaceInfoList){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 641             if(tmp.getTargetTableName().equalsIgnoreCase(joinInfo.getLeftTableName())</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 642             ||tmp.getTargetTableName().equalsIgnoreCase(joinInfo.getLeftTableAlias())){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 643                 replaceInfo.setPreNode(tmp);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 644                 break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 645             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 646         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 647 </span>
 648 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 649         if (!tableEnv.isRegistered(targetTableName)){</span>
 650 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 651             Table joinTable = tableEnv.fromDataStream(dsOut);
 652             tableEnv.registerTable(targetTableName, joinTable);
 653             localTableCache.put(joinInfo.getNewTableName(), joinTable);
 654         }
 655     }
 656 
 657     private TypeInformation&lt;Row&gt; projectedTypeInfo(int[] fields, TableSchema schema) {
 658         String[] fieldNames = schema.getFieldNames();
 659         TypeInformation&lt;?&gt;[] fieldTypes = schema.getFieldTypes();
 660 
<abbr title=" 661         String[] projectedNames = Arrays.stream(fields).mapToObj(i -&gt; fieldNames[i]).toArray(String[]::new);"> 661         String[] projectedNames = Arrays.stream(fields).mapToObj(i -&gt; fieldNames[i]).toArray(String[]::ne🔵</abbr>
<abbr title=" 662         TypeInformation[] projectedTypes = Arrays.stream(fields).mapToObj(i -&gt; fieldTypes[i]).toArray(TypeInformation[]::new);"> 662         TypeInformation[] projectedTypes = Arrays.stream(fields).mapToObj(i -&gt; fieldTypes[i]).toArray(Typ🔵</abbr>
 663         return new RowTypeInfo(projectedTypes, projectedNames);
 664     }
 665 
 666 
 667     private boolean checkFieldsInfo(CreateTmpTableParser.SqlParserResult result, Table table) {
 668         List&lt;String&gt; fieldNames = new LinkedList&lt;&gt;();
 669         String fieldsInfo = result.getFieldsInfoStr();
 670         String[] fields = StringUtils.split(fieldsInfo, &quot;,&quot;);
 671         for (int i = 0; i &lt; fields.length; i++) {
 672             String[] filed = fields[i].split(&quot;\\s&quot;);
 673             if (filed.length &lt; 2 || fields.length != table.getSchema().getFieldCount()){
 674                 return false;
 675             } else {
 676                 String[] filedNameArr = new String[filed.length - 1];
 677                 System.arraycopy(filed, 0, filedNameArr, 0, filed.length - 1);
 678                 String fieldName = String.join(&quot; &quot;, filedNameArr);
 679                 fieldNames.add(fieldName);
 680                 String fieldType = filed[filed.length - 1 ].trim();
 681                 Class fieldClass = ClassUtil.stringConvertClass(fieldType);
 682                 Class tableField = table.getSchema().getFieldType(i).get().getTypeClass();
 683                 if (fieldClass == tableField){
 684                     continue;
 685                 } else {
 686                     return false;
 687                 }
 688             }
 689         }
 690         tmpFields = String.join(&quot;,&quot;, fieldNames);
 691         return true;
 692     }
 693 
 694 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                            <td><pre>   1 /*
   2  * Licensed to the Apache Software Foundation (ASF) under one
   3  * or more contributor license agreements.  See the NOTICE file
   4  * distributed with this work for additional information
   5  * regarding copyright ownership.  The ASF licenses this file
   6  * to you under the Apache License, Version 2.0 (the
   7  * &quot;License&quot;); you may not use this file except in compliance
   8  * with the License.  You may obtain a copy of the License at
   9  *
  10  *     http://www.apache.org/licenses/LICENSE-2.0
  11  *
  12  * Unless required by applicable law or agreed to in writing, software
  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15  * See the License for the specific language governing permissions and
  16  * limitations under the License.
  17  */
  18 package com.dtstack.flink.sql.side;
  19 
  20 import com.dtstack.flink.sql.enums.ECacheType;
  21 import com.dtstack.flink.sql.exec.FlinkSQLExec;
  22 import com.dtstack.flink.sql.parser.CreateTmpTableParser;
  23 import com.dtstack.flink.sql.side.operator.SideAsyncOperator;
  24 import com.dtstack.flink.sql.side.operator.SideWithAllCacheOperator;
  25 import com.dtstack.flink.sql.util.ClassUtil;
  26 import com.dtstack.flink.sql.util.ParseUtils;
  27 import com.dtstack.flink.sql.util.TableUtils;
  28 import com.google.common.base.Preconditions;
  29 import com.google.common.collect.HashBasedTable;
  30 import com.google.common.collect.Lists;
  31 import com.google.common.collect.Maps;
  32 import com.google.common.collect.Sets;
  33 import java.sql.Timestamp;
  34 import java.time.LocalDateTime;
  35 import java.util.Arrays;
  36 import java.util.LinkedList;
  37 import java.util.List;
  38 import java.util.Map;
  39 import java.util.Queue;
  40 import java.util.Set;
  41 import org.apache.calcite.sql.SqlBasicCall;
  42 import org.apache.calcite.sql.SqlIdentifier;
  43 import org.apache.calcite.sql.SqlKind;
  44 import org.apache.calcite.sql.SqlNode;
  45 import org.apache.calcite.sql.SqlSelect;
  46 import org.apache.calcite.sql.SqlWithItem;
  47 import org.apache.calcite.sql.parser.SqlParseException;
  48 import org.apache.commons.collections.CollectionUtils;
  49 import org.apache.commons.lang3.StringUtils;
  50 import org.apache.flink.api.common.typeinfo.TypeInformation;
  51 import org.apache.flink.api.common.typeinfo.Types;
  52 import org.apache.flink.api.java.tuple.Tuple2;
  53 import org.apache.flink.api.java.typeutils.RowTypeInfo;
  54 import org.apache.flink.api.java.typeutils.TupleTypeInfo;
  55 import org.apache.flink.streaming.api.datastream.DataStream;
  56 import org.apache.flink.table.api.Table;
  57 import org.apache.flink.table.api.TableSchema;
  58 import org.apache.flink.table.api.java.StreamTableEnvironment;
  59 import org.apache.flink.table.typeutils.TimeIndicatorTypeInfo;
  60 import org.apache.flink.types.Row;
  61 import org.slf4j.Logger;
  62 import org.slf4j.LoggerFactory;
  63 import static org.apache.calcite.sql.SqlKind.*;
  64 
  65 
  66 /**
  67  * Reason:
  68  * Date: 2018/7/24
  69  * Company: www.dtstack.com
  70  * @author xuchao
  71  */
  72 public class SideSqlExec {
  73     private static final Logger LOG = LoggerFactory.getLogger(SideSqlExec.class);
  74 
  75     private String localSqlPluginPath = null;
  76 
  77     private String tmpFields = null;
  78 
  79     private SidePredicatesParser sidePredicatesParser = new SidePredicatesParser();
  80 
  81     private Map&lt;String, Table&gt; localTableCache = Maps.newHashMap();
  82 
<abbr title="  83     public void exec(String sql, Map&lt;String, AbstractSideTableInfo&gt; sideTableMap, StreamTableEnvironment tableEnv, Map&lt;String, Table&gt; tableCache, CreateTmpTableParser.SqlParserResult createView, String scope) throws Exception {">  83     public void exec(String sql, Map&lt;String, AbstractSideTableInfo&gt; sideTableMap, StreamTableEnvironment 🔵</abbr>
  84         if (localSqlPluginPath == null) {
  85             throw new RuntimeException(&quot;need to set localSqlPluginPath&quot;);
  86         }
  87         localTableCache.putAll(tableCache);
  88         try {
  89             sidePredicatesParser.fillPredicatesForSideTable(sql, sideTableMap);
  90         } catch (java.lang.Exception e) {
  91             LOG.error(&quot;fill predicates for sideTable fail &quot;, e);
  92         }
  93         if (createView != null) {
  94             LOG.warn(&quot;create view info\n&quot;);
  95             LOG.warn(createView.getExecSql());
  96             LOG.warn(&quot;-----------------&quot;);
  97         }
  98         SideSQLParser sideSQLParser = new SideSQLParser();
  99         sideSQLParser.setLocalTableCache(localTableCache);
 100         Queue&lt;Object&gt; exeQueue = sideSQLParser.getExeQueue(sql, sideTableMap.keySet(), scope);
 101         Object pollObj;
 102         while ((pollObj = exeQueue.poll()) != null) {
 103             if (pollObj instanceof SqlNode) {
 104                 SqlNode pollSqlNode = ((SqlNode) (pollObj));
 105                 if (pollSqlNode.getKind() == INSERT) {
 106                     FlinkSQLExec.sqlUpdate(tableEnv, pollSqlNode.toString());
 107                     if (LOG.isInfoEnabled()) {
 108                         LOG.info(&quot;----------real exec sql-----------\n{}&quot;, pollSqlNode.toString());
 109                     }
 110                 } else if (pollSqlNode.getKind() == AS) {
 111                     dealAsSourceTable(tableEnv, pollSqlNode, tableCache);
 112                 } else if (pollSqlNode.getKind() == WITH_ITEM) {
 113                     SqlWithItem sqlWithItem = ((SqlWithItem) (pollSqlNode));
 114                     String TableAlias = sqlWithItem.name.toString();
 115                     Table table = tableEnv.sqlQuery(sqlWithItem.query.toString());
 116                     tableEnv.registerTable(TableAlias, table);
 117                 } else if (pollSqlNode.getKind() == SELECT) {
<abbr title=" 118                     Preconditions.checkState(createView != null, &quot;select sql must included by create view&quot;);"> 118                     Preconditions.checkState(createView != null, &quot;select sql must included by create view🔵</abbr>
 119                     Table table = tableEnv.sqlQuery(pollObj.toString());
 120                     if (createView.getFieldsInfoStr() == null) {
 121                         tableEnv.registerTable(createView.getTableName(), table);
 122                     } else if (checkFieldsInfo(createView, table)) {
 123                         table = table.as(tmpFields);
 124                         tableEnv.registerTable(createView.getTableName(), table);
 125                     } else {
 126                         throw new RuntimeException(&quot;Fields mismatch&quot;);
 127                     }
 128                     localTableCache.put(createView.getTableName(), table);
 129                 }
 130             } else if (pollObj instanceof JoinInfo) {
 131                 LOG.info(&quot;----------exec join info----------\n{}&quot;, pollObj.toString());
 132                 joinFun(pollObj, localTableCache, sideTableMap, tableEnv);
 133             }
 134         }
 135     }
 136 
 137     /**
 138      * 解析出as查询的表和字段的关系
 139      * @param asSqlNode
 140      * @param tableCache
 141      * @return
 142      */
 143     private FieldReplaceInfo parseAsQuery(SqlBasicCall asSqlNode, Map&lt;String, Table&gt; tableCache){
 144         SqlNode info = asSqlNode.getOperands()[0];
 145         SqlNode alias = asSqlNode.getOperands()[1];
 146 
 147         SqlKind infoKind = info.getKind();
 148         if(infoKind != SELECT){
 149             return null;
 150         }
 151 
 152         List&lt;FieldInfo&gt; extractFieldList = TableUtils.parserSelectField((SqlSelect) info, tableCache);
 153 
 154         HashBasedTable&lt;String, String, String&gt; mappingTable = HashBasedTable.create();
 155         for (FieldInfo fieldInfo : extractFieldList) {
 156             String tableName = fieldInfo.getTable();
 157             String fieldName = fieldInfo.getFieldName();
 158             String mappingFieldName = ParseUtils.dealDuplicateFieldName(mappingTable, fieldName);
 159             mappingTable.put(tableName, fieldName, mappingFieldName);
 160         }
 161 
 162         FieldReplaceInfo replaceInfo = new FieldReplaceInfo();
 163         replaceInfo.setMappingTable(mappingTable);
 164         replaceInfo.setTargetTableName(alias.toString());
 165         replaceInfo.setTargetTableAlias(alias.toString());
 166         return replaceInfo;
 167     }
 168 
 169     public AliasInfo parseASNode(SqlNode sqlNode) throws SqlParseException {
 170         SqlKind sqlKind = sqlNode.getKind();
 171         if (sqlKind != AS) {
 172             throw new RuntimeException(sqlNode + &quot; is not &#x27;as&#x27; operator&quot;);
 173         }
 174         SqlNode info = ((SqlBasicCall) (sqlNode)).getOperands()[0];
 175         SqlNode alias = ((SqlBasicCall) (sqlNode)).getOperands()[1];
 176         AliasInfo aliasInfo = new AliasInfo();
 177         aliasInfo.setName(info.toString());
 178         aliasInfo.setAlias(alias.toString());
 179         return aliasInfo;
 180     }
 181 
<abbr title=" 182     public RowTypeInfo buildOutRowTypeInfo(List&lt;FieldInfo&gt; sideJoinFieldInfo, HashBasedTable&lt;String, String, String&gt; mappingTable) {"> 182     public RowTypeInfo buildOutRowTypeInfo(List&lt;FieldInfo&gt; sideJoinFieldInfo, HashBasedTable&lt;String, Stri🔵</abbr>
 183         TypeInformation[] sideOutTypes = new TypeInformation[sideJoinFieldInfo.size()];
 184         String[] sideOutNames = new String[sideJoinFieldInfo.size()];
 185         for (int i = 0; i &lt; sideJoinFieldInfo.size(); i++) {
 186             FieldInfo fieldInfo = sideJoinFieldInfo.get(i);
 187             String tableName = fieldInfo.getTable();
 188             String fieldName = fieldInfo.getFieldName();
 189             String mappingFieldName = mappingTable.get(tableName, fieldName);
<abbr title=" 190             Preconditions.checkNotNull(mappingFieldName, fieldInfo + &quot; not mapping any field! it may be frame bug&quot;);"> 190             Preconditions.checkNotNull(mappingFieldName, fieldInfo + &quot; not mapping any field! it may be f🔵</abbr>
 191             sideOutTypes[i] = fieldInfo.getTypeInformation();
 192             sideOutNames[i] = mappingFieldName;
 193         }
 194         return new RowTypeInfo(sideOutTypes, sideOutNames);
 195     }
 196 
 197     private TypeInformation convertTimeAttributeType(TypeInformation typeInformation) {
 198         if (typeInformation instanceof TimeIndicatorTypeInfo) {
 199             return TypeInformation.of(LocalDateTime.class);
 200         }
 201         return typeInformation;
 202     }
 203 
 204     public void setLocalSqlPluginPath(String localSqlPluginPath) {
 205         this.localSqlPluginPath = localSqlPluginPath;
 206     }
 207 
<abbr title=" 208     private Table getTableFromCache(Map&lt;String, Table&gt; localTableCache, String tableAlias, String tableName) {"> 208     private Table getTableFromCache(Map&lt;String, Table&gt; localTableCache, String tableAlias, String tableNa🔵</abbr>
 209         Table table = localTableCache.get(tableAlias);
 210         if (table == null) {
 211             table = localTableCache.get(tableName);
 212         }
 213         if (table == null) {
 214             throw new RuntimeException(&quot;not register table &quot; + tableAlias);
 215         }
 216         return table;
 217     }
 218 
 219     /**
<abbr title=" 220      * Analyzing conditions are very join the dimension tables include all equivalent conditions (i.e., dimension table is the primary key definition"> 220      * Analyzing conditions are very join the dimension tables include all equivalent conditions (i.e., d🔵</abbr>
 221      *
 222      * @return
 223      */
<abbr title=" 224     private boolean checkJoinCondition(SqlNode conditionNode, String sideTableAlias, AbstractSideTableInfo sideTableInfo) {"> 224     private boolean checkJoinCondition(SqlNode conditionNode, String sideTableAlias, AbstractSideTableInf🔵</abbr>
 225         List&lt;String&gt; conditionFields = getConditionFields(conditionNode, sideTableAlias, sideTableInfo);
 226         if(CollectionUtils.isEqualCollection(conditionFields, convertPrimaryAlias(sideTableInfo))){
 227             return true;
 228         }
 229         return false;
 230     }
 231 
 232     private List&lt;String&gt; convertPrimaryAlias(AbstractSideTableInfo sideTableInfo) {
 233         List&lt;String&gt; res = Lists.newArrayList();
 234         sideTableInfo.getPrimaryKeys().forEach(field -&gt; {
 235             res.add(sideTableInfo.getPhysicalFields().getOrDefault(field, field));
 236         });
 237         return res;
 238     }
 239 
<abbr title=" 240     public List&lt;String&gt; getConditionFields(SqlNode conditionNode, String specifyTableName, AbstractSideTableInfo sideTableInfo){"> 240     public List&lt;String&gt; getConditionFields(SqlNode conditionNode, String specifyTableName, AbstractSideTa🔵</abbr>
 241         List&lt;SqlNode&gt; sqlNodeList = Lists.newArrayList();
 242         ParseUtils.parseAnd(conditionNode, sqlNodeList);
 243         List&lt;String&gt; conditionFields = Lists.newArrayList();
 244         for(SqlNode sqlNode : sqlNodeList){
 245             if (!SqlKind.COMPARISON.contains(sqlNode.getKind())) {
 246                 throw new RuntimeException(&quot;not compare operator.&quot;);
 247             }
 248 
 249             SqlIdentifier left = (SqlIdentifier)((SqlBasicCall)sqlNode).getOperands()[0];
 250             SqlIdentifier right = (SqlIdentifier)((SqlBasicCall)sqlNode).getOperands()[1];
 251 
 252             String leftTableName = left.getComponent(0).getSimple();
 253             String rightTableName = right.getComponent(0).getSimple();
 254 
 255             String tableCol = &quot;&quot;;
 256             if(leftTableName.equalsIgnoreCase(specifyTableName)){
 257                 tableCol = left.getComponent(1).getSimple();
 258             }else if(rightTableName.equalsIgnoreCase(specifyTableName)){
 259                 tableCol = right.getComponent(1).getSimple();
 260             }else{
<abbr title=" 261                 throw new RuntimeException(String.format(&quot;side table:%s join condition is wrong&quot;, specifyTableName));"> 261                 throw new RuntimeException(String.format(&quot;side table:%s join condition is wrong&quot;, specify🔵</abbr>
 262             }
 263             tableCol = sideTableInfo.getPhysicalFields().getOrDefault(tableCol, tableCol);
 264             conditionFields.add(tableCol);
 265         }
 266 
 267         return conditionFields;
 268     }
 269 
<abbr title=" 270     protected void dealAsSourceTable(StreamTableEnvironment tableEnv, SqlNode pollSqlNode, Map&lt;String, Table&gt; tableCache) throws SqlParseException {"> 270     protected void dealAsSourceTable(StreamTableEnvironment tableEnv, SqlNode pollSqlNode, Map&lt;String, Ta🔵</abbr>
 271         AliasInfo aliasInfo = parseASNode(pollSqlNode);
 272         if (localTableCache.containsKey(aliasInfo.getName())) {
 273             return;
 274         }
 275         Table table = tableEnv.sqlQuery(aliasInfo.getName());
 276         tableEnv.registerTable(aliasInfo.getAlias(), table);
 277         localTableCache.put(aliasInfo.getAlias(), table);
 278         LOG.info(&quot;Register Table {} by {}&quot;, aliasInfo.getAlias(), aliasInfo.getName());
 279         FieldReplaceInfo fieldReplaceInfo = parseAsQuery(((SqlBasicCall) (pollSqlNode)), tableCache);
 280         if (fieldReplaceInfo == null) {
 281             return;
 282         }
 283         // as 的源表
 284         Set&lt;String&gt; fromTableNameSet = Sets.newHashSet();
 285         SqlNode fromNode = ((SqlBasicCall) (pollSqlNode)).getOperands()[0];
 286         TableUtils.getFromTableInfo(fromNode, fromTableNameSet);
 287     }
 288 
<abbr title=" 289     private void joinFun(Object pollObj, Map&lt;String, Table&gt; localTableCache, Map&lt;String, AbstractSideTableInfo&gt; sideTableMap, StreamTableEnvironment tableEnv) throws Exception {"> 289     private void joinFun(Object pollObj, Map&lt;String, Table&gt; localTableCache, Map&lt;String, AbstractSideTabl🔵</abbr>
 290                                 JoinInfo joinInfo = (JoinInfo) pollObj;
 291 
 292                                 JoinScope joinScope = new JoinScope();
 293                                 JoinScope.ScopeChild leftScopeChild = new JoinScope.ScopeChild();
 294                                 leftScopeChild.setAlias(joinInfo.getLeftTableAlias());
 295                                 leftScopeChild.setTableName(joinInfo.getLeftTableName());
 296 
<abbr title=" 297                                 Table leftTable = getTableFromCache(localTableCache, joinInfo.getLeftTableAlias(), joinInfo.getLeftTableName());"> 297                                 Table leftTable = getTableFromCache(localTableCache, joinInfo.getLeftTabl🔵</abbr>
 298 
<abbr title=" 299                                 RowTypeInfo leftTypeInfo = new RowTypeInfo(leftTable.getSchema().getFieldTypes(), leftTable.getSchema().getFieldNames());"> 299                                 RowTypeInfo leftTypeInfo = new RowTypeInfo(leftTable.getSchema().getField🔵</abbr>
 300                                 leftScopeChild.setRowTypeInfo(leftTypeInfo);
 301 
 302                                 JoinScope.ScopeChild rightScopeChild = new JoinScope.ScopeChild();
 303                                 rightScopeChild.setAlias(joinInfo.getRightTableAlias());
 304                                 rightScopeChild.setTableName(joinInfo.getRightTableName());
<abbr title=" 305                                 AbstractSideTableInfo sideTableInfo = sideTableMap.get(joinInfo.getRightTableName());"> 305                                 AbstractSideTableInfo sideTableInfo = sideTableMap.get(joinInfo.getRightT🔵</abbr>
 306                                 if(sideTableInfo == null){
 307                                     sideTableInfo = sideTableMap.get(joinInfo.getRightTableAlias());
 308                                 }
 309 
 310                                 if(sideTableInfo == null){
<abbr title=" 311                                     throw new RuntimeException(&quot;can&#x27;t not find side table:&quot; + joinInfo.getRightTableName());"> 311                                     throw new RuntimeException(&quot;can&#x27;t not find side table:&quot; + joinInfo.ge🔵</abbr>
 312                                 }
 313 
 314 
 315 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 316                                 if(!checkJoinCondition(joinInfo.getCondition(), joinInfo.getRightTableAlias(), sideTableInfo)){"> 316                                 if(!checkJoinCondition(joinInfo.getCondition(), joinInfo.getRightTableAli🔵</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 317                                     throw new RuntimeException(&quot;ON condition must contain all equal fields!!!&quot;);"> 317                                     throw new RuntimeException(&quot;ON condition must contain all equal field🔵</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 318                                 }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 319 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 320 </span>
 321 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 322 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 322 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kw🔵</abbr></span>
 323 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 324 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 325 </span>
 326 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 327                                 rightScopeChild.setRowTypeInfo(sideTableInfo.getRowTypeInfo());
 328 
 329                                 joinScope.addScope(leftScopeChild);
 330                                 joinScope.addScope(rightScopeChild);
 331 
<abbr title=" 332                                 HashBasedTable&lt;String, String, String&gt; mappingTable = ((JoinInfo) pollObj).getTableFieldRef();"> 332                                 HashBasedTable&lt;String, String, String&gt; mappingTable = ((JoinInfo) pollObj🔵</abbr>
 333 
 334                                 //获取两个表的所有字段
<abbr title=" 335                                 List&lt;FieldInfo&gt; sideJoinFieldInfo = ParserJoinField.getRowTypeInfo(joinInfo.getSelectNode(), joinScope, true);"> 335                                 List&lt;FieldInfo&gt; sideJoinFieldInfo = ParserJoinField.getRowTypeInfo(joinIn🔵</abbr>
 336                                 //通过join的查询字段信息过滤出需要的字段信息
<abbr title=" 337                                 sideJoinFieldInfo.removeIf(tmpFieldInfo -&gt; mappingTable.get(tmpFieldInfo.getTable(), tmpFieldInfo.getFieldName()) == null);"> 337                                 sideJoinFieldInfo.removeIf(tmpFieldInfo -&gt; mappingTable.get(tmpFieldInfo.🔵</abbr>
 338 
 339                                 String leftTableAlias = joinInfo.getLeftTableAlias();
 340                                 Table targetTable = localTableCache.get(leftTableAlias);
 341                                 if(targetTable == null){
 342                                     targetTable = localTableCache.get(joinInfo.getLeftTableName());
 343                                 }
 344 
<abbr title=" 345                                 RowTypeInfo typeInfo = new RowTypeInfo(targetTable.getSchema().getFieldTypes(), targetTable.getSchema().getFieldNames());"> 345                                 RowTypeInfo typeInfo = new RowTypeInfo(targetTable.getSchema().getFieldTy🔵</abbr>
 346 
<abbr title=" 347                                 DataStream&lt;Tuple2&lt;Boolean, Row&gt;&gt; adaptStream = tableEnv.toRetractStream(targetTable, Row.class);"> 347                                 DataStream&lt;Tuple2&lt;Boolean, Row&gt;&gt; adaptStream = tableEnv.toRetractStream(t🔵</abbr>
 348 
<abbr title=" 349                                 //join side table before keyby ===&gt; Reducing the size of each dimension table cache of async"> 349                                 //join side table before keyby ===&gt; Reducing the size of each dimension t🔵</abbr>
 350                                 if (sideTableInfo.isPartitionedJoin()) {
<abbr title=" 351                                     List&lt;String&gt; leftJoinColList = getConditionFields(joinInfo.getCondition(), joinInfo.getLeftTableAlias(), sideTableInfo);"> 351                                     List&lt;String&gt; leftJoinColList = getConditionFields(joinInfo.getConditi🔵</abbr>
<abbr title=" 352                                     List&lt;String&gt; fieldNames = Arrays.asList(targetTable.getSchema().getFieldNames());"> 352                                     List&lt;String&gt; fieldNames = Arrays.asList(targetTable.getSchema().getFi🔵</abbr>
<abbr title=" 353                                     int[] keyIndex = leftJoinColList.stream().mapToInt(fieldNames::indexOf).toArray();"> 353                                     int[] keyIndex = leftJoinColList.stream().mapToInt(fieldNames::indexO🔵</abbr>
<abbr title=" 354                                     adaptStream = adaptStream.keyBy(new TupleKeySelector(keyIndex, projectedTypeInfo(keyIndex, targetTable.getSchema())));"> 354                                     adaptStream = adaptStream.keyBy(new TupleKeySelector(keyIndex, projec🔵</abbr>
 355                                 }
 356 
 357                                 DataStream&lt;Tuple2&lt;Boolean, Row&gt;&gt; dsOut = null;
 358                                 if(ECacheType.ALL.name().equalsIgnoreCase(sideTableInfo.getCacheType())){
<abbr title=" 359                                     dsOut = SideWithAllCacheOperator.getSideJoinDataStream(adaptStream, sideTableInfo.getType(), localSqlPluginPath, typeInfo, joinInfo, sideJoinFieldInfo, sideTableInfo);"> 359                                     dsOut = SideWithAllCacheOperator.getSideJoinDataStream(adaptStream, s🔵</abbr>
 360                                 }else{
<abbr title=" 361                                     dsOut = SideAsyncOperator.getSideJoinDataStream(adaptStream, sideTableInfo.getType(), localSqlPluginPath, typeInfo, joinInfo, sideJoinFieldInfo, sideTableInfo);"> 361                                     dsOut = SideAsyncOperator.getSideJoinDataStream(adaptStream, sideTabl🔵</abbr>
 362                                 }
 363 
 364 
 365 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 366                                 HashBasedTable&lt;String, String, String&gt; mappingTable = HashBasedTable.create();"> 366                                 HashBasedTable&lt;String, String, String&gt; mappingTable = HashBasedTable.crea🔵</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 367 </span>
 368 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 369 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 369 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kw🔵</abbr></span>
 370 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 371 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 372 </span>
 373 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
<abbr title=" 374                                 RowTypeInfo sideOutTypeInfo = buildOutRowTypeInfo(sideJoinFieldInfo, mappingTable);"> 374                                 RowTypeInfo sideOutTypeInfo = buildOutRowTypeInfo(sideJoinFieldInfo, mapp🔵</abbr>
 375 
<abbr title=" 376                                 TupleTypeInfo tupleTypeInfo = new TupleTypeInfo(Types.BOOLEAN, sideOutTypeInfo);"> 376                                 TupleTypeInfo tupleTypeInfo = new TupleTypeInfo(Types.BOOLEAN, sideOutTyp🔵</abbr>
 377                                 dsOut.getTransformation().setOutputType(tupleTypeInfo);
 378 
 379                                 String targetTableName = joinInfo.getNewTableName();
 380                                 String targetTableAlias = joinInfo.getNewTableAlias();
 381 
 382                                 FieldReplaceInfo replaceInfo = new FieldReplaceInfo();
 383                                 replaceInfo.setMappingTable(mappingTable);
 384                                 replaceInfo.setTargetTableName(targetTableName);
 385                                 replaceInfo.setTargetTableAlias(targetTableAlias);
 386 
 387 
 388 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 389                                 //判断之前是不是被替换过,被替换过则设置之前的替换信息作为上一个节点</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 390                                 for(FieldReplaceInfo tmp : replaceInfoList){</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 391                                     if(tmp.getTargetTableName().equalsIgnoreCase(joinInfo.getLeftTableName())"> 391                                     if(tmp.getTargetTableName().equalsIgnoreCase(joinInfo.getLeftTableNam🔵</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 392                                     ||tmp.getTargetTableName().equalsIgnoreCase(joinInfo.getLeftTableAlias())){"> 392                                     ||tmp.getTargetTableName().equalsIgnoreCase(joinInfo.getLeftTableAlia🔵</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 393                                         replaceInfo.setPreNode(tmp);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 394                                         break;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 395                                     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 396                                 }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 397 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 398                                 replaceInfoList.add(replaceInfo);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 399 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 400                                 List&lt;String&gt; registeredTableName = Arrays.asList(tableEnv.listTables());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 401                                 if (!registeredTableName.contains(joinInfo.getNewTableName())){</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 402 </span>
 403 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 404 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 404 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kw🔵</abbr></span>
 405 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 406 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 407                                 if (!tableEnv.isRegistered(targetTableName)){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 408 </span>
 409 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 410                                     Table joinTable = tableEnv.fromDataStream(dsOut);
 411                                     tableEnv.registerTable(targetTableName, joinTable);
 412                                     localTableCache.put(joinInfo.getNewTableName(), joinTable);
 413                                 }
 414                             }
 415 
 416     private TypeInformation&lt;Row&gt; projectedTypeInfo(int[] fields, TableSchema schema) {
 417         String[] fieldNames = schema.getFieldNames();
 418         TypeInformation&lt;?&gt;[] fieldTypes = schema.getFieldTypes();
<abbr title=" 419         String[] projectedNames = Arrays.stream(fields).mapToObj(( i) -&gt; fieldNames[i]).toArray(String[]::new);"> 419         String[] projectedNames = Arrays.stream(fields).mapToObj(( i) -&gt; fieldNames[i]).toArray(String[]:🔵</abbr>
<abbr title=" 420         TypeInformation[] projectedTypes = Arrays.stream(fields).mapToObj(( i) -&gt; fieldTypes[i]).toArray(TypeInformation[]::new);"> 420         TypeInformation[] projectedTypes = Arrays.stream(fields).mapToObj(( i) -&gt; fieldTypes[i]).toArray(🔵</abbr>
 421         return new RowTypeInfo(projectedTypes, projectedNames);
 422     }
 423 
 424     private boolean checkFieldsInfo(CreateTmpTableParser.SqlParserResult result, Table table) {
 425         List&lt;String&gt; fieldNames = new LinkedList&lt;&gt;();
 426         String fieldsInfo = result.getFieldsInfoStr();
 427         String[] fields = StringUtils.split(fieldsInfo, &quot;,&quot;);
 428         for (int i = 0; i &lt; fields.length; i++) {
 429             String[] filed = fields[i].split(&quot;\\s&quot;);
 430             if ((filed.length &lt; 2) || (fields.length != table.getSchema().getFieldCount())) {
 431                 return false;
 432             } else {
 433                 String[] filedNameArr = new String[filed.length - 1];
 434                 System.arraycopy(filed, 0, filedNameArr, 0, filed.length - 1);
 435                 String fieldName = String.join(&quot; &quot;, filedNameArr);
 436                 fieldNames.add(fieldName);
 437                 String fieldType = filed[filed.length - 1].trim();
 438                 Class fieldClass = ClassUtil.stringConvertClass(fieldType);
 439                 Class tableField = table.getSchema().getFieldType(i).get().getTypeClass();
 440                 if (fieldClass == tableField) {
 441                     continue;
 442                 } else {
 443                     return false;
 444                 }
 445             }
 446         }
 447         tmpFields = String.join(&quot;,&quot;, fieldNames);
 448         return true;
 449     }
 450 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  /*
   2   * Licensed to the Apache Software Foundation (ASF) under one
   3   * or more contributor license agreements.  See the NOTICE file
   4   * distributed with this work for additional information
   5   * regarding copyright ownership.  The ASF licenses this file
   6   * to you under the Apache License, Version 2.0 (the
   7   * &quot;License&quot;); you may not use this file except in compliance
   8   * with the License.  You may obtain a copy of the License at
   9   *
  10   *     http://www.apache.org/licenses/LICENSE-2.0
  11   *
  12   * Unless required by applicable law or agreed to in writing, software
  13   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15   * See the License for the specific language governing permissions and
  16   * limitations under the License.
  17   */
  18  
  19  
  20  
  21  package com.dtstack.flink.sql.side;
  22  
  23  import org.apache.flink.api.common.typeinfo.TypeInformation;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  24 +import org.apache.flink.api.common.typeinfo.Types;</span>
  25  import org.apache.flink.api.java.tuple.Tuple2;
  26  import org.apache.flink.api.java.typeutils.RowTypeInfo;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  27 +import org.apache.flink.api.java.typeutils.TupleTypeInfo;</span>
  28  import org.apache.flink.streaming.api.datastream.DataStream;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  29 -import org.apache.flink.table.api.StreamQueryConfig;</span>
  30  import org.apache.flink.table.api.Table;
  31  import org.apache.flink.table.api.TableSchema;
  32  import org.apache.flink.table.api.java.StreamTableEnvironment;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  33 -import org.apache.flink.table.runtime.CRowKeySelector;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  34 -import org.apache.flink.table.runtime.types.CRow;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  35 -import org.apache.flink.table.runtime.types.CRowTypeInfo;</span>
  36  import org.apache.flink.table.typeutils.TimeIndicatorTypeInfo;
  37  import org.apache.flink.types.Row;
  38  
  39  import com.dtstack.flink.sql.enums.ECacheType;
  40  import com.dtstack.flink.sql.exec.FlinkSQLExec;
  41  import com.dtstack.flink.sql.parser.CreateTmpTableParser;
  42  import com.dtstack.flink.sql.side.operator.SideAsyncOperator;
  43  import com.dtstack.flink.sql.side.operator.SideWithAllCacheOperator;
  44  import com.dtstack.flink.sql.util.ClassUtil;
  45  import com.dtstack.flink.sql.util.ParseUtils;
  46  import com.dtstack.flink.sql.util.TableUtils;
  47  import com.google.common.base.Preconditions;
  48  import com.google.common.collect.HashBasedTable;
  49  import com.google.common.collect.Lists;
  50  import com.google.common.collect.Maps;
  51  import com.google.common.collect.Sets;
  52  import org.apache.calcite.sql.SqlAsOperator;
  53  import org.apache.calcite.sql.SqlBasicCall;
  54  import org.apache.calcite.sql.SqlDataTypeSpec;
  55  import org.apache.calcite.sql.SqlIdentifier;
  56  import org.apache.calcite.sql.SqlInsert;
  57  import org.apache.calcite.sql.SqlJoin;
  58  import org.apache.calcite.sql.SqlKind;
  59  import org.apache.calcite.sql.SqlLiteral;
  60  import org.apache.calcite.sql.SqlNode;
  61  import org.apache.calcite.sql.SqlNodeList;
  62  import org.apache.calcite.sql.SqlOperator;
  63  import org.apache.calcite.sql.SqlOrderBy;
  64  import org.apache.calcite.sql.SqlSelect;
  65  import org.apache.calcite.sql.SqlWithItem;
  66  import org.apache.calcite.sql.fun.SqlCase;
  67  import org.apache.calcite.sql.parser.SqlParseException;
  68  import org.apache.calcite.sql.parser.SqlParserPos;
  69  import org.apache.commons.collections.CollectionUtils;
  70  import org.apache.commons.lang3.StringUtils;
  71  import org.slf4j.Logger;
  72  import org.slf4j.LoggerFactory;
  73  
  74  import java.sql.Timestamp;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  75 +import java.time.LocalDateTime;</span>
  76  import java.util.Arrays;
  77  import java.util.Collection;
  78  import java.util.LinkedList;
  79  import java.util.List;
  80  import java.util.Map;
  81  import java.util.Queue;
  82  import java.util.Set;
  83  
  84  import static org.apache.calcite.sql.SqlKind.*;
  85  
  86  /**
  87   * Reason:
  88   * Date: 2018/7/24
  89   * Company: www.dtstack.com
  90   * @author xuchao
  91   */
  92  
  93  public class SideSqlExec {
  94  
  95      private static final Logger LOG = LoggerFactory.getLogger(SideSqlExec.class);
  96  
  97      private String localSqlPluginPath = null;
  98  
  99      private String tmpFields = null;
 100  
 101      private SidePredicatesParser sidePredicatesParser = new SidePredicatesParser();
 102  
 103      private Map&lt;String, Table&gt; localTableCache = Maps.newHashMap();
 104  
 105      public void exec(String sql, Map&lt;String, AbstractSideTableInfo&gt; sideTableMap, StreamTableEnvironment tableEnv,
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 106 -                     Map&lt;String, Table&gt; tableCache, StreamQueryConfig queryConfig, CreateTmpTableParser.SqlParserResult createView) throws Exception {"> 106 -                     Map&lt;String, Table&gt; tableCache, StreamQueryConfig queryConfig, CreateTmpTableParser.SqlParserR🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 107 +                     Map&lt;String, Table&gt; tableCache, CreateTmpTableParser.SqlParserResult createView) throws Exception {"> 107 +                     Map&lt;String, Table&gt; tableCache, CreateTmpTableParser.SqlParserResult createView) throws Except🔵</abbr></span>






 108          if(localSqlPluginPath == null){
 109              throw new RuntimeException(&quot;need to set localSqlPluginPath&quot;);
 110          }
 111  
 112          localTableCache.putAll(tableCache);
 113          try {
 114              sidePredicatesParser.fillPredicatesForSideTable(sql, sideTableMap);
 115          } catch (Exception e) {
 116              LOG.error(&quot;fill predicates for sideTable fail &quot;, e);
 117          }
 118  
 119          if(createView != null){
 120              LOG.warn(&quot;create view info\n&quot;);
 121              LOG.warn(createView.getExecSql());
 122              LOG.warn(&quot;-----------------&quot;);
 123          }
 124  
 125          SideSQLParser sideSQLParser = new SideSQLParser();
 126          sideSQLParser.setLocalTableCache(localTableCache);
 127          Queue&lt;Object&gt; exeQueue = sideSQLParser.getExeQueue(sql, sideTableMap.keySet());

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 128 -        Object pollObj = null;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 129 +        Object pollObj;</span>
 130  
 131          //need clean
 132          boolean preIsSideJoin = false;
 133          List&lt;FieldReplaceInfo&gt; replaceInfoList = Lists.newArrayList();
 134  
 135          while((pollObj = exeQueue.poll()) != null){
 136  
 137              if(pollObj instanceof SqlNode){
 138                  SqlNode pollSqlNode = (SqlNode) pollObj;
 139  
 140                  if(preIsSideJoin){
 141                      preIsSideJoin = false;
 142                      List&lt;String&gt; fieldNames = null;
 143                      for(FieldReplaceInfo replaceInfo : replaceInfoList){
 144                          fieldNames = Lists.newArrayList();
 145                          replaceFieldName(pollSqlNode, replaceInfo);
 146                          addAliasForFieldNode(pollSqlNode, fieldNames, replaceInfo.getMappingTable());
 147                      }
 148                  }
 149  
 150                  if(pollSqlNode.getKind() == INSERT){
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 151 -                    FlinkSQLExec.sqlUpdate(tableEnv, pollSqlNode.toString(), queryConfig);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 152 +                    FlinkSQLExec.sqlUpdate(tableEnv, pollSqlNode.toString());</span>
 153                      if(LOG.isInfoEnabled()){
 154                          LOG.info(&quot;----------real exec sql-----------\n{}&quot;, pollSqlNode.toString());
 155                      }
 156  
 157                  }else if(pollSqlNode.getKind() == AS){
 158                      dealAsSourceTable(tableEnv, pollSqlNode, tableCache, replaceInfoList);

 159  
 160                  } else if (pollSqlNode.getKind() == WITH_ITEM) {
 161                      SqlWithItem sqlWithItem = (SqlWithItem) pollSqlNode;
 162                      String TableAlias = sqlWithItem.name.toString();
 163                      Table table = tableEnv.sqlQuery(sqlWithItem.query.toString());
 164                      tableEnv.registerTable(TableAlias, table);
 165  
 166                  } else if (pollSqlNode.getKind() == SELECT){
 167                      Preconditions.checkState(createView != null, &quot;select sql must included by create view&quot;);
 168                      Table table = tableEnv.sqlQuery(pollObj.toString());
 169  
 170                      if (createView.getFieldsInfoStr() == null){
 171                          tableEnv.registerTable(createView.getTableName(), table);
 172                      } else {
 173                          if (checkFieldsInfo(createView, table)){
 174                              table = table.as(tmpFields);
 175                              tableEnv.registerTable(createView.getTableName(), table);
 176                          } else {
 177                              throw new RuntimeException(&quot;Fields mismatch&quot;);
 178                          }
 179                      }
 180  
 181                      localTableCache.put(createView.getTableName(), table);
 182                  }
 183  
 184              }else if (pollObj instanceof JoinInfo){
 185                  LOG.info(&quot;----------exec join info----------\n{}&quot;, pollObj.toString());
 186                  preIsSideJoin = true;
 187                  joinFun(pollObj, localTableCache, sideTableMap, tableEnv, replaceInfoList);

 188              }
 189          }
 190  
 191      }
 192  
 193  
 194      /**
 195       * 解析出as查询的表和字段的关系
 196       * @param asSqlNode
 197       * @param tableCache
 198       * @return
 199       */
 200      private FieldReplaceInfo parseAsQuery(SqlBasicCall asSqlNode, Map&lt;String, Table&gt; tableCache){
 201          SqlNode info = asSqlNode.getOperands()[0];
 202          SqlNode alias = asSqlNode.getOperands()[1];
 203  
 204          SqlKind infoKind = info.getKind();
 205          if(infoKind != SELECT){
 206              return null;
 207          }
 208  
 209          List&lt;FieldInfo&gt; extractFieldList = TableUtils.parserSelectField((SqlSelect) info, tableCache);
 210  
 211          HashBasedTable&lt;String, String, String&gt; mappingTable = HashBasedTable.create();
 212          for (FieldInfo fieldInfo : extractFieldList) {
 213              String tableName = fieldInfo.getTable();
 214              String fieldName = fieldInfo.getFieldName();
 215              String mappingFieldName = ParseUtils.dealDuplicateFieldName(mappingTable, fieldName);
 216              mappingTable.put(tableName, fieldName, mappingFieldName);
 217          }
 218  
 219          FieldReplaceInfo replaceInfo = new FieldReplaceInfo();
 220          replaceInfo.setMappingTable(mappingTable);
 221          replaceInfo.setTargetTableName(alias.toString());
 222          replaceInfo.setTargetTableAlias(alias.toString());
 223          return replaceInfo;
 224      }
 225  
 226  
 227      /**
 228       * 添加字段别名
 229       * @param pollSqlNode
 230       * @param fieldList
 231       * @param mappingTable
 232       */
<abbr title=" 233      private void addAliasForFieldNode(SqlNode pollSqlNode, List&lt;String&gt; fieldList, HashBasedTable&lt;String, String, String&gt; mappingTable) {"> 233      private void addAliasForFieldNode(SqlNode pollSqlNode, List&lt;String&gt; fieldList, HashBasedTable&lt;String, String, 🔵</abbr>
 234          SqlKind sqlKind = pollSqlNode.getKind();
 235          switch (sqlKind) {
 236              case INSERT:
 237                  SqlNode source = ((SqlInsert) pollSqlNode).getSource();
 238                  addAliasForFieldNode(source, fieldList, mappingTable);
 239                  break;
 240              case AS:
 241                  addAliasForFieldNode(((SqlBasicCall) pollSqlNode).getOperands()[0], fieldList, mappingTable);
 242                  break;
 243              case SELECT:
 244                  SqlNodeList selectList = ((SqlSelect) pollSqlNode).getSelectList();
 245                  selectList.getList().forEach(node -&gt; {
 246                      if (node.getKind() == IDENTIFIER) {
 247                          SqlIdentifier sqlIdentifier = (SqlIdentifier) node;
 248                          if (sqlIdentifier.names.size() == 1) {
 249                              return;
 250                          }
 251                          // save real field
 252                          String fieldName = sqlIdentifier.names.get(1);
<abbr title=" 253                          if (!fieldName.endsWith(&quot;0&quot;) || fieldName.endsWith(&quot;0&quot;) &amp;&amp; mappingTable.columnMap().containsKey(fieldName)) {"> 253                          if (!fieldName.endsWith(&quot;0&quot;) || fieldName.endsWith(&quot;0&quot;) &amp;&amp; mappingTable.columnMap().contai🔵</abbr>
 254                              fieldList.add(fieldName);
 255                          }
 256  
 257                      }
 258                  });
 259                  for (int i = 0; i &lt; selectList.getList().size(); i++) {
 260                      SqlNode node = selectList.get(i);
 261                      if (node.getKind() == IDENTIFIER) {
 262                          SqlIdentifier sqlIdentifier = (SqlIdentifier) node;
 263                          if (sqlIdentifier.names.size() == 1) {
 264                              return;
 265                          }
 266                          String name = sqlIdentifier.names.get(1);
 267                          // avoid real field pv0 convert pv
<abbr title=" 268                          if (name.endsWith(&quot;0&quot;) &amp;&amp;  !fieldList.contains(name) &amp;&amp; !fieldList.contains(name.substring(0, name.length() - 1))) {"> 268                          if (name.endsWith(&quot;0&quot;) &amp;&amp;  !fieldList.contains(name) &amp;&amp; !fieldList.contains(name.substring🔵</abbr>
 269                              SqlOperator operator = new SqlAsOperator();
 270                              SqlParserPos sqlParserPos = new SqlParserPos(0, 0);
 271  
<abbr title=" 272                              SqlIdentifier sqlIdentifierAlias = new SqlIdentifier(name.substring(0, name.length() - 1), null, sqlParserPos);"> 272                              SqlIdentifier sqlIdentifierAlias = new SqlIdentifier(name.substring(0, name.length() -🔵</abbr>
 273                              SqlNode[] sqlNodes = new SqlNode[2];
 274                              sqlNodes[0] = sqlIdentifier;
 275                              sqlNodes[1] = sqlIdentifierAlias;
 276                              SqlBasicCall sqlBasicCall = new SqlBasicCall(operator, sqlNodes, sqlParserPos);
 277  
 278                              selectList.set(i, sqlBasicCall);
 279                          }
 280                      }
 281                  }
 282                  break;
 283              default:
 284                  break;
 285          }
 286      }
 287  
 288  
 289      public AliasInfo parseAsNode(SqlNode sqlNode) throws SqlParseException {

 290          SqlKind sqlKind = sqlNode.getKind();
 291          if(sqlKind != AS){
 292              throw new RuntimeException(sqlNode + &quot; is not &#x27;as&#x27; operator&quot;);
 293          }
 294  
 295          SqlNode info = ((SqlBasicCall)sqlNode).getOperands()[0];
 296          SqlNode alias = ((SqlBasicCall) sqlNode).getOperands()[1];
 297  
 298          AliasInfo aliasInfo = new AliasInfo();
 299          aliasInfo.setName(info.toString());
 300          aliasInfo.setAlias(alias.toString());
 301  
 302          return aliasInfo;
 303      }
 304  
<abbr title=" 305      public RowTypeInfo buildOutRowTypeInfo(List&lt;FieldInfo&gt; sideJoinFieldInfo, HashBasedTable&lt;String, String, String&gt; mappingTable) {"> 305      public RowTypeInfo buildOutRowTypeInfo(List&lt;FieldInfo&gt; sideJoinFieldInfo, HashBasedTable&lt;String, String, Strin🔵</abbr>


 306          TypeInformation[] sideOutTypes = new TypeInformation[sideJoinFieldInfo.size()];
 307          String[] sideOutNames = new String[sideJoinFieldInfo.size()];
 308          for (int i = 0; i &lt; sideJoinFieldInfo.size(); i++) {
 309              FieldInfo fieldInfo = sideJoinFieldInfo.get(i);
 310              String tableName = fieldInfo.getTable();
 311              String fieldName = fieldInfo.getFieldName();
 312              String mappingFieldName = ParseUtils.dealDuplicateFieldName(mappingTable, fieldName);
 313              mappingTable.put(tableName, fieldName, mappingFieldName);



 314  
 315              sideOutTypes[i] = fieldInfo.getTypeInformation();
 316              sideOutNames[i] = mappingFieldName;
 317          }
 318          return new RowTypeInfo(sideOutTypes, sideOutNames);
 319      }
 320  
 321  
 322  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 323 -    /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 324 -     *  对时间类型进行类型转换</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 325 -     * @param leftTypeInfo</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 326 -     * @return</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 327 -     */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 328 -    private RowTypeInfo buildLeftTableOutType(RowTypeInfo leftTypeInfo) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 329 -        TypeInformation[] sideOutTypes = new TypeInformation[leftTypeInfo.getFieldNames().length];</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 330 -        TypeInformation&lt;?&gt;[] fieldTypes = leftTypeInfo.getFieldTypes();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 331 -        for (int i = 0; i &lt; sideOutTypes.length; i++) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 332 -            sideOutTypes[i] = convertTimeAttributeType(fieldTypes[i]);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 333 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 334 -        RowTypeInfo rowTypeInfo = new RowTypeInfo(sideOutTypes, leftTypeInfo.getFieldNames());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 335 -        return rowTypeInfo;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 336 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 337 -</span>
 338      private TypeInformation convertTimeAttributeType(TypeInformation typeInformation) {
 339          if (typeInformation instanceof TimeIndicatorTypeInfo) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 340 -            return TypeInformation.of(Timestamp.class);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 341 +            return TypeInformation.of(LocalDateTime.class);</span>
 342          }
 343          return typeInformation;
 344      }
 345  
 346      //需要考虑更多的情况
 347      private void replaceFieldName(SqlNode sqlNode, FieldReplaceInfo replaceInfo) {
 348          SqlKind sqlKind = sqlNode.getKind();
 349          switch (sqlKind) {
 350              case INSERT:
 351                  SqlNode sqlSource = ((SqlInsert) sqlNode).getSource();
 352                  replaceFieldName(sqlSource, replaceInfo);
 353                  break;
 354              case AS:
 355                  SqlNode asNode = ((SqlBasicCall) sqlNode).getOperands()[0];
 356                  replaceFieldName(asNode, replaceInfo);
 357                  break;
 358              case SELECT:
<abbr title=" 359                  SqlSelect sqlSelect = (SqlSelect) filterNodeWithTargetName(sqlNode, replaceInfo.getTargetTableName());"> 359                  SqlSelect sqlSelect = (SqlSelect) filterNodeWithTargetName(sqlNode, replaceInfo.getTargetTableName🔵</abbr>
 360                  if(sqlSelect == null){
 361                      return;
 362                  }
 363  
 364                  SqlNode sqlSource1 = sqlSelect.getFrom();
 365                  if(sqlSource1.getKind() == AS){
 366                      String tableName = ((SqlBasicCall)sqlSource1).getOperands()[0].toString();
 367                      if(tableName.equalsIgnoreCase(replaceInfo.getTargetTableName())){
 368                          SqlNodeList sqlSelectList = sqlSelect.getSelectList();
 369                          SqlNode whereNode = sqlSelect.getWhere();
 370                          SqlNodeList sqlGroup = sqlSelect.getGroup();
 371  
 372                          //TODO 暂时不处理having
 373                          SqlNode sqlHaving = sqlSelect.getHaving();
 374  
 375                          List&lt;SqlNode&gt; newSelectNodeList = Lists.newArrayList();
 376                          for( int i=0; i&lt;sqlSelectList.getList().size(); i++){
 377                              SqlNode selectNode = sqlSelectList.getList().get(i);
 378                              //特殊处理 isStar的标识
 379                              if(selectNode.getKind() == IDENTIFIER &amp;&amp; ((SqlIdentifier) selectNode).isStar()){
<abbr title=" 380                                  List&lt;SqlNode&gt; replaceNodeList = replaceSelectStarFieldName(selectNode, replaceInfo);"> 380                                  List&lt;SqlNode&gt; replaceNodeList = replaceSelectStarFieldName(selectNode, replaceInfo🔵</abbr>
 381                                  newSelectNodeList.addAll(replaceNodeList);
 382                                  continue;
 383                              }
 384  
 385                              SqlNode replaceNode = replaceSelectFieldName(selectNode, replaceInfo);
 386                              if(replaceNode == null){
 387                                  continue;
 388                              }
 389  
 390                              //sqlSelectList.set(i, replaceNode);
 391                              newSelectNodeList.add(replaceNode);
 392                          }
 393  
<abbr title=" 394                          SqlNodeList newSelectList = new SqlNodeList(newSelectNodeList, sqlSelectList.getParserPosition());"> 394                          SqlNodeList newSelectList = new SqlNodeList(newSelectNodeList, sqlSelectList.getParserPosi🔵</abbr>
 395                          sqlSelect.setSelectList(newSelectList);
 396  
 397                          //where
 398                          if(whereNode != null){
 399                              SqlNode[] sqlNodeList = ((SqlBasicCall)whereNode).getOperands();
 400                              for(int i =0; i&lt;sqlNodeList.length; i++) {
 401                                  SqlNode whereSqlNode = sqlNodeList[i];
 402                                  SqlNode replaceNode = replaceNodeInfo(whereSqlNode, replaceInfo);
 403                                  sqlNodeList[i] = replaceNode;
 404                              }
 405                          }
 406                          if(sqlGroup != null &amp;&amp; CollectionUtils.isNotEmpty(sqlGroup.getList())){
 407                              for( int i=0; i&lt;sqlGroup.getList().size(); i++){
 408                                  SqlNode selectNode = sqlGroup.getList().get(i);
 409                                  SqlNode replaceNode = replaceNodeInfo(selectNode, replaceInfo);
 410                                  sqlGroup.set(i, replaceNode);
 411                              }
 412                          }
 413                      }
 414                  }else{
 415                      throw new RuntimeException(&quot;---not deal type:&quot; + sqlNode);
 416                  }
 417  
 418                  break;
 419              case UNION:
 420                  SqlNode unionLeft = ((SqlBasicCall) sqlNode).getOperands()[0];
 421                  SqlNode unionRight = ((SqlBasicCall) sqlNode).getOperands()[1];
 422                  replaceFieldName(unionLeft, replaceInfo);
 423                  replaceFieldName(unionRight, replaceInfo);
 424  
 425                  break;
 426              case ORDER_BY:
 427                  SqlOrderBy sqlOrderBy  = (SqlOrderBy) sqlNode;
 428                  replaceFieldName(sqlOrderBy.query, replaceInfo);
 429                  SqlNodeList orderFiledList = sqlOrderBy.orderList;
 430                  for (int i=0 ;i&lt;orderFiledList.size();i++) {
<abbr title=" 431                      SqlNode replaceNode = replaceOrderByTableName(orderFiledList.get(i), replaceInfo.getTargetTableAlias());"> 431                      SqlNode replaceNode = replaceOrderByTableName(orderFiledList.get(i), replaceInfo.getTargetTabl🔵</abbr>
 432                      orderFiledList.set(i, replaceNode);
 433                  }
 434  
 435              default:
 436                  break;
 437          }
 438      }
 439  
 440      private SqlNode replaceOrderByTableName(SqlNode orderNode, String tableAlias) {
 441          if(orderNode.getKind() == IDENTIFIER){
 442              SqlIdentifier sqlIdentifier = (SqlIdentifier) orderNode;
 443              if (sqlIdentifier.names.size() == 1) {
 444                  return orderNode;
 445              }
 446              return sqlIdentifier.setName(0, tableAlias);
 447          } else if (orderNode instanceof  SqlBasicCall) {
 448              SqlBasicCall sqlBasicCall = (SqlBasicCall) orderNode;
 449              for(int i=0; i&lt;sqlBasicCall.getOperandList().size(); i++){
 450                  SqlNode sqlNode = sqlBasicCall.getOperandList().get(i);
 451                  sqlBasicCall.getOperands()[i] = replaceOrderByTableName(sqlNode , tableAlias);
 452              }
 453              return sqlBasicCall;
 454          } else {
 455              return orderNode;
 456          }
 457      }
 458  
 459      private SqlNode replaceNodeInfo(SqlNode groupNode, FieldReplaceInfo replaceInfo){
 460          if(groupNode.getKind() == IDENTIFIER){
 461              SqlIdentifier sqlIdentifier = (SqlIdentifier) groupNode;
 462              if(sqlIdentifier.names.size() == 1){
 463                  return sqlIdentifier;
 464              }
 465  
<abbr title=" 466              String mappingFieldName = replaceInfo.getTargetFieldName(sqlIdentifier.getComponent(0).getSimple(), sqlIdentifier.getComponent(1).getSimple());"> 466              String mappingFieldName = replaceInfo.getTargetFieldName(sqlIdentifier.getComponent(0).getSimple(), sq🔵</abbr>
 467              if(mappingFieldName == null){
 468                  throw new RuntimeException(&quot;can&#x27;t find mapping fieldName:&quot; + sqlIdentifier.toString() );
 469              }
 470  
 471              sqlIdentifier = sqlIdentifier.setName(0, replaceInfo.getTargetTableAlias());
 472              return sqlIdentifier.setName(1, mappingFieldName);
 473          }else if(groupNode instanceof  SqlBasicCall){
 474              SqlBasicCall sqlBasicCall = (SqlBasicCall) groupNode;
 475              for(int i=0; i&lt;sqlBasicCall.getOperandList().size(); i++){
 476                  SqlNode sqlNode = sqlBasicCall.getOperandList().get(i);
 477                  SqlNode replaceNode = replaceSelectFieldName(sqlNode, replaceInfo);
 478                  sqlBasicCall.getOperands()[i] = replaceNode;
 479              }
 480  
 481              return sqlBasicCall;
 482          }else{
 483              return groupNode;
 484          }
 485      }
 486  
 487      public SqlNode filterNodeWithTargetName(SqlNode sqlNode, String targetTableName) {
 488  
 489          SqlKind sqlKind = sqlNode.getKind();
 490          switch (sqlKind){
 491              case SELECT:
 492                  SqlNode fromNode = ((SqlSelect)sqlNode).getFrom();
 493                  if(fromNode.getKind() == AS &amp;&amp; ((SqlBasicCall)fromNode).getOperands()[0].getKind() == IDENTIFIER){
 494                      if(((SqlBasicCall)fromNode).getOperands()[0].toString().equalsIgnoreCase(targetTableName)){
 495                          return sqlNode;
 496                      }else{
 497                          return null;
 498                      }
 499                  }else{
 500                      return filterNodeWithTargetName(fromNode, targetTableName);
 501                  }
 502              case AS:
 503                  SqlNode childNode = ((SqlBasicCall)sqlNode).getOperands()[0];
 504                  return filterNodeWithTargetName(childNode, targetTableName);
 505              case JOIN:
 506                  SqlNode leftNode = ((SqlJoin)sqlNode).getLeft();
 507                  SqlNode rightNode =  ((SqlJoin)sqlNode).getRight();
 508                  SqlNode leftReturnNode = filterNodeWithTargetName(leftNode, targetTableName);
 509                  SqlNode rightReturnNode = filterNodeWithTargetName(rightNode, targetTableName);
 510  
 511                  if(leftReturnNode != null) {
 512                      return leftReturnNode;
 513                  }else if(rightReturnNode != null){
 514                      return rightReturnNode;
 515                  }else{
 516                      return null;
 517                  }
 518              default:
 519                  break;
 520          }
 521  
 522          return null;
 523      }



 524  
 525  
 526      public void setLocalSqlPluginPath(String localSqlPluginPath) {
 527          this.localSqlPluginPath = localSqlPluginPath;
 528      }
 529  
 530      private Table getTableFromCache(Map&lt;String, Table&gt; localTableCache, String tableAlias, String tableName){
 531          Table table = localTableCache.get(tableAlias);
 532          if(table == null){
 533              table = localTableCache.get(tableName);
 534          }
 535  
 536          if(table == null){
 537              throw new RuntimeException(&quot;not register table &quot; + tableName);

 538          }
 539  
 540          return table;
 541      }
 542  
 543      private List&lt;SqlNode&gt; replaceSelectStarFieldName(SqlNode selectNode, FieldReplaceInfo replaceInfo){
 544          SqlIdentifier sqlIdentifier = (SqlIdentifier) selectNode;
 545          List&lt;SqlNode&gt; sqlNodes = Lists.newArrayList();
 546          if(sqlIdentifier.isStar()){//处理 [* or table.*]
 547              int identifierSize = sqlIdentifier.names.size();
 548              Collection&lt;String&gt; columns = null;
 549              if(identifierSize == 1){
 550                  columns = replaceInfo.getMappingTable().values();
 551              }else{
 552                  columns = replaceInfo.getMappingTable().row(sqlIdentifier.names.get(0)).values();
 553              }
 554  
 555              for(String colAlias : columns){
 556                  SqlParserPos sqlParserPos = new SqlParserPos(0, 0);
 557                  List&lt;String&gt; columnInfo = Lists.newArrayList();
 558                  columnInfo.add(replaceInfo.getTargetTableAlias());
 559                  columnInfo.add(colAlias);
 560                  SqlIdentifier sqlIdentifierAlias = new SqlIdentifier(columnInfo, sqlParserPos);
 561                  sqlNodes.add(sqlIdentifierAlias);
 562              }
 563  
 564              return sqlNodes;
 565          }else{
 566              throw new RuntimeException(&quot;is not a star select field.&quot; + selectNode);
 567          }
 568      }
 569  
 570      private SqlNode replaceSelectFieldName(SqlNode selectNode, FieldReplaceInfo replaceInfo) {
 571          if (selectNode.getKind() == AS) {
 572              SqlNode leftNode = ((SqlBasicCall) selectNode).getOperands()[0];
 573              SqlNode replaceNode = replaceSelectFieldName(leftNode, replaceInfo);
 574              if (replaceNode != null) {
 575                  ((SqlBasicCall) selectNode).getOperands()[0] = replaceNode;
 576              }
 577  
 578              return selectNode;
 579          }else if(selectNode.getKind() == IDENTIFIER){
 580              SqlIdentifier sqlIdentifier = (SqlIdentifier) selectNode;
 581  
 582              if(sqlIdentifier.names.size() == 1){
 583                  return selectNode;
 584              }
 585  
 586              //Same level mappingTable
<abbr title=" 587              String mappingFieldName = replaceInfo.getTargetFieldName(sqlIdentifier.getComponent(0).getSimple(), sqlIdentifier.getComponent(1).getSimple());"> 587              String mappingFieldName = replaceInfo.getTargetFieldName(sqlIdentifier.getComponent(0).getSimple(), sq🔵</abbr>
 588              if (mappingFieldName == null) {
 589                  throw new RuntimeException(&quot;can&#x27;t find mapping fieldName:&quot; + selectNode.toString() );
 590              }
 591  
 592              sqlIdentifier = sqlIdentifier.setName(0, replaceInfo.getTargetTableAlias());
 593              sqlIdentifier = sqlIdentifier.setName(1, mappingFieldName);
 594              return sqlIdentifier;
 595          }else if(selectNode.getKind() == LITERAL || selectNode.getKind() == LITERAL_CHAIN){//字面含义
 596              return selectNode;
 597          }else if(  AGGREGATE.contains(selectNode.getKind())
 598                  || AVG_AGG_FUNCTIONS.contains(selectNode.getKind())
 599                  || COMPARISON.contains(selectNode.getKind())
 600                  || selectNode.getKind() == OTHER_FUNCTION
 601                  || selectNode.getKind() == DIVIDE
 602                  || selectNode.getKind() == CAST
 603                  || selectNode.getKind() == TRIM
 604                  || selectNode.getKind() == TIMES
 605                  || selectNode.getKind() == PLUS
 606                  || selectNode.getKind() == NOT_IN
 607                  || selectNode.getKind() == OR
 608                  || selectNode.getKind() == AND
 609                  || selectNode.getKind() == MINUS
 610                  || selectNode.getKind() == TUMBLE
 611                  || selectNode.getKind() == TUMBLE_START
 612                  || selectNode.getKind() == TUMBLE_END
 613                  || selectNode.getKind() == SESSION
 614                  || selectNode.getKind() == SESSION_START
 615                  || selectNode.getKind() == SESSION_END
 616                  || selectNode.getKind() == HOP
 617                  || selectNode.getKind() == HOP_START
 618                  || selectNode.getKind() == HOP_END
 619                  || selectNode.getKind() == BETWEEN
 620                  || selectNode.getKind() == IS_NULL
 621                  || selectNode.getKind() == IS_NOT_NULL
 622                  || selectNode.getKind() == CONTAINS
 623                  || selectNode.getKind() == TIMESTAMP_ADD
 624                  || selectNode.getKind() == TIMESTAMP_DIFF
 625                  || selectNode.getKind() == LIKE
 626  
 627                  ){
 628              SqlBasicCall sqlBasicCall = (SqlBasicCall) selectNode;
 629              for(int i=0; i&lt;sqlBasicCall.getOperands().length; i++){
 630                  SqlNode sqlNode = sqlBasicCall.getOperands()[i];
 631                  if(sqlNode instanceof SqlLiteral){
 632                      continue;
 633                  }
 634  
 635                  if(sqlNode instanceof SqlDataTypeSpec){
 636                      continue;
 637                  }
 638  
 639                  SqlNode replaceNode = replaceSelectFieldName(sqlNode, replaceInfo);
 640                  if(replaceNode == null){
 641                      continue;
 642                  }
 643  
 644                  sqlBasicCall.getOperands()[i] = replaceNode;
 645              }
 646  
 647              return selectNode;
 648          }else if(selectNode.getKind() == CASE){
 649              SqlCase sqlCase = (SqlCase) selectNode;
 650              SqlNodeList whenOperands = sqlCase.getWhenOperands();
 651              SqlNodeList thenOperands = sqlCase.getThenOperands();
 652              SqlNode elseNode = sqlCase.getElseOperand();
 653  
 654              for(int i=0; i&lt;whenOperands.size(); i++){
 655                  SqlNode oneOperand = whenOperands.get(i);
 656                  SqlNode replaceNode = replaceSelectFieldName(oneOperand, replaceInfo);
 657                  if (replaceNode != null) {
 658                      whenOperands.set(i, replaceNode);
 659                  }
 660              }
 661  
 662              for(int i=0; i&lt;thenOperands.size(); i++){
 663                  SqlNode oneOperand = thenOperands.get(i);
 664                  SqlNode replaceNode = replaceSelectFieldName(oneOperand, replaceInfo);
 665                  if (replaceNode != null) {
 666                      thenOperands.set(i, replaceNode);
 667                  }
 668              }
 669  
 670              ((SqlCase) selectNode).setOperand(3, replaceSelectFieldName(elseNode, replaceInfo));
 671              return selectNode;
 672          }else if(selectNode.getKind() == OTHER){
 673              //不处理
 674              return selectNode;
 675          }else{
<abbr title=" 676              throw new RuntimeException(String.format(&quot;not support node kind of %s to replace name now.&quot;, selectNode.getKind()));"> 676              throw new RuntimeException(String.format(&quot;not support node kind of %s to replace name now.&quot;, selectNod🔵</abbr>
 677          }
 678      }
 679  
 680      /**
<abbr title=" 681       * Analyzing conditions are very join the dimension tables include all equivalent conditions (i.e., dimension table is the primary key definition"> 681       * Analyzing conditions are very join the dimension tables include all equivalent conditions (i.e., dimension 🔵</abbr>
 682       *
 683       * @return
 684       */
<abbr title=" 685      private boolean checkJoinCondition(SqlNode conditionNode, String sideTableAlias, AbstractSideTableInfo sideTableInfo) {"> 685      private boolean checkJoinCondition(SqlNode conditionNode, String sideTableAlias, AbstractSideTableInfo sideTab🔵</abbr>
 686          List&lt;String&gt; conditionFields = getConditionFields(conditionNode, sideTableAlias, sideTableInfo);
 687          if(CollectionUtils.isEqualCollection(conditionFields, convertPrimaryAlias(sideTableInfo))){
 688              return true;
 689          }
 690          return false;
 691      }
 692  
 693      private List&lt;String&gt; convertPrimaryAlias(AbstractSideTableInfo sideTableInfo) {
 694          List&lt;String&gt; res = Lists.newArrayList();
 695          sideTableInfo.getPrimaryKeys().forEach(field -&gt; {
 696              res.add(sideTableInfo.getPhysicalFields().getOrDefault(field, field));
 697          });
 698          return res;
 699      }
 700  
<abbr title=" 701      public List&lt;String&gt; getConditionFields(SqlNode conditionNode, String specifyTableName, AbstractSideTableInfo sideTableInfo){"> 701      public List&lt;String&gt; getConditionFields(SqlNode conditionNode, String specifyTableName, AbstractSideTableInfo s🔵</abbr>
 702          List&lt;SqlNode&gt; sqlNodeList = Lists.newArrayList();
 703          ParseUtils.parseAnd(conditionNode, sqlNodeList);
 704          List&lt;String&gt; conditionFields = Lists.newArrayList();
 705          for(SqlNode sqlNode : sqlNodeList){
 706              if (!SqlKind.COMPARISON.contains(sqlNode.getKind())) {
 707                  throw new RuntimeException(&quot;not compare operator.&quot;);
 708              }
 709  
 710              SqlIdentifier left = (SqlIdentifier)((SqlBasicCall)sqlNode).getOperands()[0];
 711              SqlIdentifier right = (SqlIdentifier)((SqlBasicCall)sqlNode).getOperands()[1];
 712  
 713              String leftTableName = left.getComponent(0).getSimple();
 714              String rightTableName = right.getComponent(0).getSimple();
 715  
 716              String tableCol = &quot;&quot;;
 717              if(leftTableName.equalsIgnoreCase(specifyTableName)){
 718                  tableCol = left.getComponent(1).getSimple();
 719              }else if(rightTableName.equalsIgnoreCase(specifyTableName)){
 720                  tableCol = right.getComponent(1).getSimple();
 721              }else{
<abbr title=" 722                  throw new RuntimeException(String.format(&quot;side table:%s join condition is wrong&quot;, specifyTableName));"> 722                  throw new RuntimeException(String.format(&quot;side table:%s join condition is wrong&quot;, specifyTableName🔵</abbr>
 723              }
 724              tableCol = sideTableInfo.getPhysicalFields().getOrDefault(tableCol, tableCol);
 725              conditionFields.add(tableCol);
 726          }
 727  
 728          return conditionFields;
 729      }
 730  
 731      protected void dealAsSourceTable(StreamTableEnvironment tableEnv,
 732                                       SqlNode pollSqlNode,
 733                                       Map&lt;String, Table&gt; tableCache,
 734                                       List&lt;FieldReplaceInfo&gt; replaceInfoList) throws SqlParseException {
 735  
 736          AliasInfo aliasInfo = parseAsNode(pollSqlNode);



 737          if (localTableCache.containsKey(aliasInfo.getName())) {
 738              return;
 739          }
 740  
 741          Table table = tableEnv.sqlQuery(aliasInfo.getName());
 742          tableEnv.registerTable(aliasInfo.getAlias(), table);
 743          localTableCache.put(aliasInfo.getAlias(), table);
 744  
 745          LOG.info(&quot;Register Table {} by {}&quot;, aliasInfo.getAlias(), aliasInfo.getName());
 746  
 747          FieldReplaceInfo fieldReplaceInfo = parseAsQuery((SqlBasicCall) pollSqlNode, tableCache);
 748          if(fieldReplaceInfo == null){
 749             return;
 750          }
 751  
 752          //as 的源表
 753          Set&lt;String&gt; fromTableNameSet = Sets.newHashSet();
 754          SqlNode fromNode = ((SqlBasicCall)pollSqlNode).getOperands()[0];
 755          TableUtils.getFromTableInfo(fromNode, fromTableNameSet);
 756          for(FieldReplaceInfo tmp : replaceInfoList){
 757              if(fromTableNameSet.contains(tmp.getTargetTableName())
 758                      || fromTableNameSet.contains(tmp.getTargetTableAlias())){
 759                  fieldReplaceInfo.setPreNode(tmp);
 760                  break;
 761              }
 762          }
 763          replaceInfoList.add(fieldReplaceInfo);
 764      }
 765  
 766      private void joinFun(Object pollObj, Map&lt;String, Table&gt; localTableCache,
 767                           Map&lt;String, AbstractSideTableInfo&gt; sideTableMap, StreamTableEnvironment tableEnv,
 768                           List&lt;FieldReplaceInfo&gt; replaceInfoList) throws Exception{







 769          JoinInfo joinInfo = (JoinInfo) pollObj;
 770  
 771          JoinScope joinScope = new JoinScope();
 772          JoinScope.ScopeChild leftScopeChild = new JoinScope.ScopeChild();
 773          leftScopeChild.setAlias(joinInfo.getLeftTableAlias());
 774          leftScopeChild.setTableName(joinInfo.getLeftTableName());
 775  
 776          SqlKind sqlKind = joinInfo.getLeftNode().getKind();
 777          if(sqlKind == AS){
 778              dealAsSourceTable(tableEnv, joinInfo.getLeftNode(), localTableCache, replaceInfoList);
 779          }
 780  
<abbr title=" 781          Table leftTable = getTableFromCache(localTableCache, joinInfo.getLeftTableAlias(), joinInfo.getLeftTableName());"> 781          Table leftTable = getTableFromCache(localTableCache, joinInfo.getLeftTableAlias(), joinInfo.getLeftTableNa🔵</abbr>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 782 -        RowTypeInfo leftTypeInfo = new RowTypeInfo(leftTable.getSchema().getTypes(), leftTable.getSchema().getColumnNames());"> 782 -        RowTypeInfo leftTypeInfo = new RowTypeInfo(leftTable.getSchema().getTypes(), leftTable.getSchema().getColu🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 783 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 784 +        RowTypeInfo leftTypeInfo = new RowTypeInfo(leftTable.getSchema().getFieldTypes(), leftTable.getSchema().getFieldNames());"> 784 +        RowTypeInfo leftTypeInfo = new RowTypeInfo(leftTable.getSchema().getFieldTypes(), leftTable.getSchema().ge🔵</abbr></span>
 785          leftScopeChild.setRowTypeInfo(leftTypeInfo);
 786  
 787          JoinScope.ScopeChild rightScopeChild = new JoinScope.ScopeChild();
 788          rightScopeChild.setAlias(joinInfo.getRightTableAlias());
 789          rightScopeChild.setTableName(joinInfo.getRightTableName());
 790          AbstractSideTableInfo sideTableInfo = sideTableMap.get(joinInfo.getRightTableName());
 791          if(sideTableInfo == null){
 792              sideTableInfo = sideTableMap.get(joinInfo.getRightTableAlias());
 793          }
 794  
 795          if(sideTableInfo == null){
 796              throw new RuntimeException(&quot;can&#x27;t not find side table:&quot; + joinInfo.getRightTableName());
 797          }
 798  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 799 -//        if(!checkJoinCondition(joinInfo.getCondition(), joinInfo.getRightTableAlias(), sideTableInfo)){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 800 -//            throw new RuntimeException(&quot;ON condition must contain all equal fields!!!&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 801 -//        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 802 +        if(!checkJoinCondition(joinInfo.getCondition(), joinInfo.getRightTableAlias(), sideTableInfo)){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 803 +            throw new RuntimeException(&quot;ON condition must contain all equal fields!!!&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 804 +        }</span>
 805  
 806          rightScopeChild.setRowTypeInfo(sideTableInfo.getRowTypeInfo());
 807  
 808          joinScope.addScope(leftScopeChild);
 809          joinScope.addScope(rightScopeChild);
 810  


 811          //获取两个表的所有字段
<abbr title=" 812          List&lt;FieldInfo&gt; sideJoinFieldInfo = ParserJoinField.getRowTypeInfo(joinInfo.getSelectNode(), joinScope, true);"> 812          List&lt;FieldInfo&gt; sideJoinFieldInfo = ParserJoinField.getRowTypeInfo(joinInfo.getSelectNode(), joinScope, tr🔵</abbr>


 813  
 814          String leftTableAlias = joinInfo.getLeftTableAlias();
 815          Table targetTable = localTableCache.get(leftTableAlias);
 816          if(targetTable == null){
 817              targetTable = localTableCache.get(joinInfo.getLeftTableName());
 818          }
 819  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 820 -        RowTypeInfo typeInfo = new RowTypeInfo(targetTable.getSchema().getTypes(), targetTable.getSchema().getColumnNames());"> 820 -        RowTypeInfo typeInfo = new RowTypeInfo(targetTable.getSchema().getTypes(), targetTable.getSchema().getColu🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 821 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 822 -        DataStream&lt;CRow&gt; adaptStream = tableEnv.toRetractStream(targetTable, org.apache.flink.types.Row.class)</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 823 -                .map((Tuple2&lt;Boolean, Row&gt; tp2) -&gt; {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 824 -                    return new CRow(tp2.f1, tp2.f0);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 825 -                }).returns(CRow.class);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 826 -</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 827 +        RowTypeInfo typeInfo = new RowTypeInfo(targetTable.getSchema().getFieldTypes(), targetTable.getSchema().getFieldNames());"> 827 +        RowTypeInfo typeInfo = new RowTypeInfo(targetTable.getSchema().getFieldTypes(), targetTable.getSchema().ge🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 828 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 829 +        DataStream&lt;Tuple2&lt;Boolean, Row&gt;&gt; adaptStream = tableEnv.toRetractStream(targetTable, Row.class);</span>
 830  
 831          //join side table before keyby ===&gt; Reducing the size of each dimension table cache of async
 832          if (sideTableInfo.isPartitionedJoin()) {
<abbr title=" 833              List&lt;String&gt; leftJoinColList = getConditionFields(joinInfo.getCondition(), joinInfo.getLeftTableAlias(), sideTableInfo);"> 833              List&lt;String&gt; leftJoinColList = getConditionFields(joinInfo.getCondition(), joinInfo.getLeftTableAlias(🔵</abbr>
 834              List&lt;String&gt; fieldNames = Arrays.asList(targetTable.getSchema().getFieldNames());
 835              int[] keyIndex = leftJoinColList.stream().mapToInt(fieldNames::indexOf).toArray();
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 836 -            adaptStream = adaptStream.keyBy(new CRowKeySelector(keyIndex, projectedTypeInfo(keyIndex, targetTable.getSchema())));"> 836 -            adaptStream = adaptStream.keyBy(new CRowKeySelector(keyIndex, projectedTypeInfo(keyIndex, targetTable.🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 837 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 838 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 839 -        DataStream&lt;CRow&gt; dsOut = null;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 840 +            adaptStream = adaptStream.keyBy(new TupleKeySelector(keyIndex, projectedTypeInfo(keyIndex, targetTable.getSchema())));"> 840 +            adaptStream = adaptStream.keyBy(new TupleKeySelector(keyIndex, projectedTypeInfo(keyIndex, targetTable🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 841 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 842 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 843 +        DataStream&lt;Tuple2&lt;Boolean, Row&gt;&gt; dsOut = null;</span>
 844          if(ECacheType.ALL.name().equalsIgnoreCase(sideTableInfo.getCacheType())){
<abbr title=" 845              dsOut = SideWithAllCacheOperator.getSideJoinDataStream(adaptStream, sideTableInfo.getType(), localSqlPluginPath, typeInfo, joinInfo, sideJoinFieldInfo, sideTableInfo);"> 845              dsOut = SideWithAllCacheOperator.getSideJoinDataStream(adaptStream, sideTableInfo.getType(), localSqlP🔵</abbr>
 846          }else{
<abbr title=" 847              dsOut = SideAsyncOperator.getSideJoinDataStream(adaptStream, sideTableInfo.getType(), localSqlPluginPath, typeInfo, joinInfo, sideJoinFieldInfo, sideTableInfo);"> 847              dsOut = SideAsyncOperator.getSideJoinDataStream(adaptStream, sideTableInfo.getType(), localSqlPluginPa🔵</abbr>
 848          }
 849  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 850 -        // TODO  将嵌套表中的字段传递过去, 去除冗余的ROWtime</span>
 851          HashBasedTable&lt;String, String, String&gt; mappingTable = HashBasedTable.create();
 852          RowTypeInfo sideOutTypeInfo = buildOutRowTypeInfo(sideJoinFieldInfo, mappingTable);
 853  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 854 -        CRowTypeInfo cRowTypeInfo = new CRowTypeInfo(sideOutTypeInfo);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 855 -        dsOut.getTransformation().setOutputType(cRowTypeInfo);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 856 +        TupleTypeInfo tupleTypeInfo = new TupleTypeInfo(Types.BOOLEAN, sideOutTypeInfo);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 857 +        dsOut.getTransformation().setOutputType(tupleTypeInfo);</span>
 858  
 859          String targetTableName = joinInfo.getNewTableName();
 860          String targetTableAlias = joinInfo.getNewTableAlias();
 861  
 862          FieldReplaceInfo replaceInfo = new FieldReplaceInfo();
 863          replaceInfo.setMappingTable(mappingTable);
 864          replaceInfo.setTargetTableName(targetTableName);
 865          replaceInfo.setTargetTableAlias(targetTableAlias);
 866  
 867          //判断之前是不是被替换过,被替换过则设置之前的替换信息作为上一个节点
 868          for(FieldReplaceInfo tmp : replaceInfoList){
 869              if(tmp.getTargetTableName().equalsIgnoreCase(joinInfo.getLeftTableName())
 870              ||tmp.getTargetTableName().equalsIgnoreCase(joinInfo.getLeftTableAlias())){
 871                  replaceInfo.setPreNode(tmp);
 872                  break;
 873              }
 874          }
 875  
 876          replaceInfoList.add(replaceInfo);
 877  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 878 -        if (!tableEnv.isRegistered(joinInfo.getNewTableName())){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 879 +        List&lt;String&gt; registeredTableName = Arrays.asList(tableEnv.listTables());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 880 +        if (!registeredTableName.contains(joinInfo.getNewTableName())){</span>
 881              Table joinTable = tableEnv.fromDataStream(dsOut);
 882              tableEnv.registerTable(joinInfo.getNewTableName(), joinTable);

 883              localTableCache.put(joinInfo.getNewTableName(), joinTable);
 884          }
 885      }
 886  
 887      private TypeInformation&lt;Row&gt; projectedTypeInfo(int[] fields, TableSchema schema) {
 888          String[] fieldNames = schema.getFieldNames();
 889          TypeInformation&lt;?&gt;[] fieldTypes = schema.getFieldTypes();
 890  
 891          String[] projectedNames = Arrays.stream(fields).mapToObj(i -&gt; fieldNames[i]).toArray(String[]::new);
<abbr title=" 892          TypeInformation[] projectedTypes = Arrays.stream(fields).mapToObj(i -&gt; fieldTypes[i]).toArray(TypeInformation[]::new);"> 892          TypeInformation[] projectedTypes = Arrays.stream(fields).mapToObj(i -&gt; fieldTypes[i]).toArray(TypeInformat🔵</abbr>
 893          return new RowTypeInfo(projectedTypes, projectedNames);
 894      }
 895  
 896  
 897      private boolean checkFieldsInfo(CreateTmpTableParser.SqlParserResult result, Table table) {
 898          List&lt;String&gt; fieldNames = new LinkedList&lt;&gt;();
 899          String fieldsInfo = result.getFieldsInfoStr();
 900          String[] fields = StringUtils.split(fieldsInfo, &quot;,&quot;);
 901          for (int i = 0; i &lt; fields.length; i++) {
 902              String[] filed = fields[i].split(&quot;\\s&quot;);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 903 -            if (filed.length &lt; 2 || fields.length != table.getSchema().getColumnNames().length){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 904 +            if (filed.length &lt; 2 || fields.length != table.getSchema().getFieldCount()){</span>
 905                  return false;
 906              } else {
 907                  String[] filedNameArr = new String[filed.length - 1];
 908                  System.arraycopy(filed, 0, filedNameArr, 0, filed.length - 1);
 909                  String fieldName = String.join(&quot; &quot;, filedNameArr);
 910                  fieldNames.add(fieldName);
 911                  String fieldType = filed[filed.length - 1 ].trim();
 912                  Class fieldClass = ClassUtil.stringConvertClass(fieldType);
 913                  Class tableField = table.getSchema().getFieldType(i).get().getTypeClass();
 914                  if (fieldClass == tableField){
 915                      continue;
 916                  } else {
 917                      return false;
 918                  }
 919              }
 920          }
 921          tmpFields = String.join(&quot;,&quot;, fieldNames);
 922          return true;
 923      }
 924  
 925  }</pre></td>
                            <td><pre>   1  /*
   2   * Licensed to the Apache Software Foundation (ASF) under one
   3   * or more contributor license agreements.  See the NOTICE file
   4   * distributed with this work for additional information
   5   * regarding copyright ownership.  The ASF licenses this file
   6   * to you under the Apache License, Version 2.0 (the
   7   * &quot;License&quot;); you may not use this file except in compliance
   8   * with the License.  You may obtain a copy of the License at
   9   *
  10   *     http://www.apache.org/licenses/LICENSE-2.0
  11   *
  12   * Unless required by applicable law or agreed to in writing, software
  13   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15   * See the License for the specific language governing permissions and
  16   * limitations under the License.
  17   */
  18  
  19  
  20  
  21  package com.dtstack.flink.sql.side;
  22  
  23  import org.apache.flink.api.common.typeinfo.TypeInformation;

  24  import org.apache.flink.api.java.tuple.Tuple2;
  25  import org.apache.flink.api.java.typeutils.RowTypeInfo;

  26  import org.apache.flink.streaming.api.datastream.DataStream;
  27  import org.apache.flink.table.api.StreamQueryConfig;
  28  import org.apache.flink.table.api.Table;
  29  import org.apache.flink.table.api.TableSchema;
  30  import org.apache.flink.table.api.java.StreamTableEnvironment;
  31  import org.apache.flink.table.runtime.CRowKeySelector;
  32  import org.apache.flink.table.runtime.types.CRow;
  33  import org.apache.flink.table.runtime.types.CRowTypeInfo;
  34  import org.apache.flink.table.typeutils.TimeIndicatorTypeInfo;
  35  import org.apache.flink.types.Row;
  36  
  37  import com.dtstack.flink.sql.enums.ECacheType;
  38  import com.dtstack.flink.sql.exec.FlinkSQLExec;
  39  import com.dtstack.flink.sql.parser.CreateTmpTableParser;
  40  import com.dtstack.flink.sql.side.operator.SideAsyncOperator;
  41  import com.dtstack.flink.sql.side.operator.SideWithAllCacheOperator;
  42  import com.dtstack.flink.sql.util.ClassUtil;
  43  import com.dtstack.flink.sql.util.ParseUtils;
  44  import com.dtstack.flink.sql.util.TableUtils;
  45  import com.google.common.base.Preconditions;
  46  import com.google.common.collect.HashBasedTable;
  47  import com.google.common.collect.Lists;
  48  import com.google.common.collect.Maps;
  49  import com.google.common.collect.Sets;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  50 -import org.apache.calcite.sql.SqlAsOperator;</span>
  51  import org.apache.calcite.sql.SqlBasicCall;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  52 -import org.apache.calcite.sql.SqlDataTypeSpec;</span>
  53  import org.apache.calcite.sql.SqlIdentifier;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  54 -import org.apache.calcite.sql.SqlInsert;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  55 -import org.apache.calcite.sql.SqlJoin;</span>
  56  import org.apache.calcite.sql.SqlKind;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  57 -import org.apache.calcite.sql.SqlLiteral;</span>
  58  import org.apache.calcite.sql.SqlNode;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  59 -import org.apache.calcite.sql.SqlNodeList;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  60 -import org.apache.calcite.sql.SqlOperator;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  61 -import org.apache.calcite.sql.SqlOrderBy;</span>
  62  import org.apache.calcite.sql.SqlSelect;
  63  import org.apache.calcite.sql.SqlWithItem;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  64 -import org.apache.calcite.sql.fun.SqlCase;</span>
  65  import org.apache.calcite.sql.parser.SqlParseException;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  66 -import org.apache.calcite.sql.parser.SqlParserPos;</span>
  67  import org.apache.commons.collections.CollectionUtils;
  68  import org.apache.commons.lang3.StringUtils;
  69  import org.slf4j.Logger;
  70  import org.slf4j.LoggerFactory;
  71  
  72  import java.sql.Timestamp;

  73  import java.util.Arrays;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  74 -import java.util.Collection;</span>
  75  import java.util.LinkedList;
  76  import java.util.List;
  77  import java.util.Map;
  78  import java.util.Queue;
  79  import java.util.Set;
  80  
  81  import static org.apache.calcite.sql.SqlKind.*;
  82  
  83  /**
  84   * Reason:
  85   * Date: 2018/7/24
  86   * Company: www.dtstack.com
  87   * @author xuchao
  88   */
  89  
  90  public class SideSqlExec {
  91  
  92      private static final Logger LOG = LoggerFactory.getLogger(SideSqlExec.class);
  93  
  94      private String localSqlPluginPath = null;
  95  
  96      private String tmpFields = null;
  97  
  98      private SidePredicatesParser sidePredicatesParser = new SidePredicatesParser();
  99  
 100      private Map&lt;String, Table&gt; localTableCache = Maps.newHashMap();
 101  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 102 -    public void exec(String sql, Map&lt;String, AbstractSideTableInfo&gt; sideTableMap, StreamTableEnvironment tableEnv,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 103 -                     Map&lt;String, Table&gt; tableCache, StreamQueryConfig queryConfig, CreateTmpTableParser.SqlParserResult createView) throws Exception {"> 103 -                     Map&lt;String, Table&gt; tableCache, StreamQueryConfig queryConfig, CreateTmpTableParser.SqlParserR🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 104 +    public void exec(String sql,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 105 +                     Map&lt;String, AbstractSideTableInfo&gt; sideTableMap,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 106 +                     StreamTableEnvironment tableEnv,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 107 +                     Map&lt;String, Table&gt; tableCache,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 108 +                     StreamQueryConfig queryConfig,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 109 +                     CreateTmpTableParser.SqlParserResult createView,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 110 +                     String scope) throws Exception {</span>
 111          if(localSqlPluginPath == null){
 112              throw new RuntimeException(&quot;need to set localSqlPluginPath&quot;);
 113          }
 114  
 115          localTableCache.putAll(tableCache);
 116          try {
 117              sidePredicatesParser.fillPredicatesForSideTable(sql, sideTableMap);
 118          } catch (Exception e) {
 119              LOG.error(&quot;fill predicates for sideTable fail &quot;, e);
 120          }
 121  
 122          if(createView != null){
 123              LOG.warn(&quot;create view info\n&quot;);
 124              LOG.warn(createView.getExecSql());
 125              LOG.warn(&quot;-----------------&quot;);
 126          }
 127  
 128          SideSQLParser sideSQLParser = new SideSQLParser();
 129          sideSQLParser.setLocalTableCache(localTableCache);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 130 -        Queue&lt;Object&gt; exeQueue = sideSQLParser.getExeQueue(sql, sideTableMap.keySet());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 131 +        Queue&lt;Object&gt; exeQueue = sideSQLParser.getExeQueue(sql, sideTableMap.keySet(), scope);</span>
 132          Object pollObj = null;

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 133 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 134 -        //need clean</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 135 -        boolean preIsSideJoin = false;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 136 -        List&lt;FieldReplaceInfo&gt; replaceInfoList = Lists.newArrayList();</span>
 137  
 138          while((pollObj = exeQueue.poll()) != null){
 139  
 140              if(pollObj instanceof SqlNode){
 141                  SqlNode pollSqlNode = (SqlNode) pollObj;
 142  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 143 -                if(preIsSideJoin){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 144 -                    preIsSideJoin = false;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 145 -                    List&lt;String&gt; fieldNames = null;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 146 -                    for(FieldReplaceInfo replaceInfo : replaceInfoList){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 147 -                        fieldNames = Lists.newArrayList();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 148 -                        replaceFieldName(pollSqlNode, replaceInfo);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 149 -                        addAliasForFieldNode(pollSqlNode, fieldNames, replaceInfo.getMappingTable());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 150 -                    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 151 -                }</span>
 152  
 153                  if(pollSqlNode.getKind() == INSERT){
 154                      FlinkSQLExec.sqlUpdate(tableEnv, pollSqlNode.toString(), queryConfig);

 155                      if(LOG.isInfoEnabled()){
 156                          LOG.info(&quot;----------real exec sql-----------\n{}&quot;, pollSqlNode.toString());
 157                      }
 158  
 159                  }else if(pollSqlNode.getKind() == AS){
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 160 -                    dealAsSourceTable(tableEnv, pollSqlNode, tableCache, replaceInfoList);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 161 +                    dealAsSourceTable(tableEnv, pollSqlNode, tableCache);</span>
 162  
 163                  } else if (pollSqlNode.getKind() == WITH_ITEM) {
 164                      SqlWithItem sqlWithItem = (SqlWithItem) pollSqlNode;
 165                      String TableAlias = sqlWithItem.name.toString();
 166                      Table table = tableEnv.sqlQuery(sqlWithItem.query.toString());
 167                      tableEnv.registerTable(TableAlias, table);
 168  
 169                  } else if (pollSqlNode.getKind() == SELECT){
 170                      Preconditions.checkState(createView != null, &quot;select sql must included by create view&quot;);
 171                      Table table = tableEnv.sqlQuery(pollObj.toString());
 172  
 173                      if (createView.getFieldsInfoStr() == null){
 174                          tableEnv.registerTable(createView.getTableName(), table);
 175                      } else {
 176                          if (checkFieldsInfo(createView, table)){
 177                              table = table.as(tmpFields);
 178                              tableEnv.registerTable(createView.getTableName(), table);
 179                          } else {
 180                              throw new RuntimeException(&quot;Fields mismatch&quot;);
 181                          }
 182                      }
 183  
 184                      localTableCache.put(createView.getTableName(), table);
 185                  }
 186  
 187              }else if (pollObj instanceof JoinInfo){
 188                  LOG.info(&quot;----------exec join info----------\n{}&quot;, pollObj.toString());
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 189 -                preIsSideJoin = true;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 190 -                joinFun(pollObj, localTableCache, sideTableMap, tableEnv, replaceInfoList);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 191 +                joinFun(pollObj, localTableCache, sideTableMap, tableEnv);</span>
 192              }
 193          }
 194  
 195      }
 196  
 197  
 198      /**
 199       * 解析出as查询的表和字段的关系
 200       * @param asSqlNode
 201       * @param tableCache
 202       * @return
 203       */
 204      private FieldReplaceInfo parseAsQuery(SqlBasicCall asSqlNode, Map&lt;String, Table&gt; tableCache){
 205          SqlNode info = asSqlNode.getOperands()[0];
 206          SqlNode alias = asSqlNode.getOperands()[1];
 207  
 208          SqlKind infoKind = info.getKind();
 209          if(infoKind != SELECT){
 210              return null;
 211          }
 212  
 213          List&lt;FieldInfo&gt; extractFieldList = TableUtils.parserSelectField((SqlSelect) info, tableCache);
 214  
 215          HashBasedTable&lt;String, String, String&gt; mappingTable = HashBasedTable.create();
 216          for (FieldInfo fieldInfo : extractFieldList) {
 217              String tableName = fieldInfo.getTable();
 218              String fieldName = fieldInfo.getFieldName();
 219              String mappingFieldName = ParseUtils.dealDuplicateFieldName(mappingTable, fieldName);
 220              mappingTable.put(tableName, fieldName, mappingFieldName);
 221          }
 222  
 223          FieldReplaceInfo replaceInfo = new FieldReplaceInfo();
 224          replaceInfo.setMappingTable(mappingTable);
 225          replaceInfo.setTargetTableName(alias.toString());
 226          replaceInfo.setTargetTableAlias(alias.toString());
 227          return replaceInfo;
 228      }
 229  
 230  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 231 -    /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 232 -     * 添加字段别名</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 233 -     * @param pollSqlNode</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 234 -     * @param fieldList</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 235 -     * @param mappingTable</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 236 -     */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 237 -    private void addAliasForFieldNode(SqlNode pollSqlNode, List&lt;String&gt; fieldList, HashBasedTable&lt;String, String, String&gt; mappingTable) {"> 237 -    private void addAliasForFieldNode(SqlNode pollSqlNode, List&lt;String&gt; fieldList, HashBasedTable&lt;String, String, 🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 238 -        SqlKind sqlKind = pollSqlNode.getKind();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 239 -        switch (sqlKind) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 240 -            case INSERT:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 241 -                SqlNode source = ((SqlInsert) pollSqlNode).getSource();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 242 -                addAliasForFieldNode(source, fieldList, mappingTable);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 243 -                break;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 244 -            case AS:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 245 -                addAliasForFieldNode(((SqlBasicCall) pollSqlNode).getOperands()[0], fieldList, mappingTable);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 246 -                break;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 247 -            case SELECT:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 248 -                SqlNodeList selectList = ((SqlSelect) pollSqlNode).getSelectList();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 249 -                selectList.getList().forEach(node -&gt; {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 250 -                    if (node.getKind() == IDENTIFIER) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 251 -                        SqlIdentifier sqlIdentifier = (SqlIdentifier) node;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 252 -                        if (sqlIdentifier.names.size() == 1) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 253 -                            return;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 254 -                        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 255 -                        // save real field</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 256 -                        String fieldName = sqlIdentifier.names.get(1);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 257 -                        if (!fieldName.endsWith(&quot;0&quot;) || fieldName.endsWith(&quot;0&quot;) &amp;&amp; mappingTable.columnMap().containsKey(fieldName)) {"> 257 -                        if (!fieldName.endsWith(&quot;0&quot;) || fieldName.endsWith(&quot;0&quot;) &amp;&amp; mappingTable.columnMap().contai🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 258 -                            fieldList.add(fieldName);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 259 -                        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 260 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 261 -                    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 262 -                });</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 263 -                for (int i = 0; i &lt; selectList.getList().size(); i++) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 264 -                    SqlNode node = selectList.get(i);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 265 -                    if (node.getKind() == IDENTIFIER) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 266 -                        SqlIdentifier sqlIdentifier = (SqlIdentifier) node;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 267 -                        if (sqlIdentifier.names.size() == 1) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 268 -                            return;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 269 -                        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 270 -                        String name = sqlIdentifier.names.get(1);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 271 -                        // avoid real field pv0 convert pv</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 272 -                        if (name.endsWith(&quot;0&quot;) &amp;&amp;  !fieldList.contains(name) &amp;&amp; !fieldList.contains(name.substring(0, name.length() - 1))) {"> 272 -                        if (name.endsWith(&quot;0&quot;) &amp;&amp;  !fieldList.contains(name) &amp;&amp; !fieldList.contains(name.substring🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 273 -                            SqlOperator operator = new SqlAsOperator();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 274 -                            SqlParserPos sqlParserPos = new SqlParserPos(0, 0);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 275 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 276 -                            SqlIdentifier sqlIdentifierAlias = new SqlIdentifier(name.substring(0, name.length() - 1), null, sqlParserPos);"> 276 -                            SqlIdentifier sqlIdentifierAlias = new SqlIdentifier(name.substring(0, name.length() -🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 277 -                            SqlNode[] sqlNodes = new SqlNode[2];</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 278 -                            sqlNodes[0] = sqlIdentifier;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 279 -                            sqlNodes[1] = sqlIdentifierAlias;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 280 -                            SqlBasicCall sqlBasicCall = new SqlBasicCall(operator, sqlNodes, sqlParserPos);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 281 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 282 -                            selectList.set(i, sqlBasicCall);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 283 -                        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 284 -                    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 285 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 286 -                break;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 287 -            default:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 288 -                break;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 289 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 290 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 291 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 292 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 293 -    public AliasInfo parseAsNode(SqlNode sqlNode) throws SqlParseException {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 294 +    public AliasInfo parseASNode(SqlNode sqlNode) throws SqlParseException {</span>
 295          SqlKind sqlKind = sqlNode.getKind();
 296          if(sqlKind != AS){
 297              throw new RuntimeException(sqlNode + &quot; is not &#x27;as&#x27; operator&quot;);
 298          }
 299  
 300          SqlNode info = ((SqlBasicCall)sqlNode).getOperands()[0];
 301          SqlNode alias = ((SqlBasicCall) sqlNode).getOperands()[1];
 302  
 303          AliasInfo aliasInfo = new AliasInfo();
 304          aliasInfo.setName(info.toString());
 305          aliasInfo.setAlias(alias.toString());
 306  
 307          return aliasInfo;
 308      }
 309  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 310 -    public RowTypeInfo buildOutRowTypeInfo(List&lt;FieldInfo&gt; sideJoinFieldInfo, HashBasedTable&lt;String, String, String&gt; mappingTable) {"> 310 -    public RowTypeInfo buildOutRowTypeInfo(List&lt;FieldInfo&gt; sideJoinFieldInfo, HashBasedTable&lt;String, String, Strin🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 311 +    public RowTypeInfo buildOutRowTypeInfo(List&lt;FieldInfo&gt; sideJoinFieldInfo,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 312 +                                           HashBasedTable&lt;String, String, String&gt; mappingTable) {</span>
 313          TypeInformation[] sideOutTypes = new TypeInformation[sideJoinFieldInfo.size()];
 314          String[] sideOutNames = new String[sideJoinFieldInfo.size()];
 315          for (int i = 0; i &lt; sideJoinFieldInfo.size(); i++) {
 316              FieldInfo fieldInfo = sideJoinFieldInfo.get(i);
 317              String tableName = fieldInfo.getTable();
 318              String fieldName = fieldInfo.getFieldName();
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 319 -            String mappingFieldName = ParseUtils.dealDuplicateFieldName(mappingTable, fieldName);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 320 -            mappingTable.put(tableName, fieldName, mappingFieldName);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 321 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 322 +            String mappingFieldName = mappingTable.get(tableName, fieldName);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 323 +            Preconditions.checkNotNull(mappingFieldName, fieldInfo + &quot; not mapping any field! it may be frame bug&quot;);"> 323 +            Preconditions.checkNotNull(mappingFieldName, fieldInfo + &quot; not mapping any field! it may be frame bug&quot;🔵</abbr></span>
 324  
 325              sideOutTypes[i] = fieldInfo.getTypeInformation();
 326              sideOutNames[i] = mappingFieldName;
 327          }
 328          return new RowTypeInfo(sideOutTypes, sideOutNames);
 329      }
 330  
 331  
 332  
 333      /**
 334       *  对时间类型进行类型转换
 335       * @param leftTypeInfo
 336       * @return
 337       */
 338      private RowTypeInfo buildLeftTableOutType(RowTypeInfo leftTypeInfo) {
 339          TypeInformation[] sideOutTypes = new TypeInformation[leftTypeInfo.getFieldNames().length];
 340          TypeInformation&lt;?&gt;[] fieldTypes = leftTypeInfo.getFieldTypes();
 341          for (int i = 0; i &lt; sideOutTypes.length; i++) {
 342              sideOutTypes[i] = convertTimeAttributeType(fieldTypes[i]);
 343          }
 344          RowTypeInfo rowTypeInfo = new RowTypeInfo(sideOutTypes, leftTypeInfo.getFieldNames());
 345          return rowTypeInfo;
 346      }
 347  
 348      private TypeInformation convertTimeAttributeType(TypeInformation typeInformation) {
 349          if (typeInformation instanceof TimeIndicatorTypeInfo) {
 350              return TypeInformation.of(Timestamp.class);

 351          }
 352          return typeInformation;
 353      }
 354  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 355 -    //需要考虑更多的情况</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 356 -    private void replaceFieldName(SqlNode sqlNode, FieldReplaceInfo replaceInfo) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 357 -        SqlKind sqlKind = sqlNode.getKind();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 358 -        switch (sqlKind) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 359 -            case INSERT:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 360 -                SqlNode sqlSource = ((SqlInsert) sqlNode).getSource();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 361 -                replaceFieldName(sqlSource, replaceInfo);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 362 -                break;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 363 -            case AS:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 364 -                SqlNode asNode = ((SqlBasicCall) sqlNode).getOperands()[0];</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 365 -                replaceFieldName(asNode, replaceInfo);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 366 -                break;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 367 -            case SELECT:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 368 -                SqlSelect sqlSelect = (SqlSelect) filterNodeWithTargetName(sqlNode, replaceInfo.getTargetTableName());"> 368 -                SqlSelect sqlSelect = (SqlSelect) filterNodeWithTargetName(sqlNode, replaceInfo.getTargetTableName🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 369 -                if(sqlSelect == null){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 370 -                    return;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 371 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 372 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 373 -                SqlNode sqlSource1 = sqlSelect.getFrom();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 374 -                if(sqlSource1.getKind() == AS){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 375 -                    String tableName = ((SqlBasicCall)sqlSource1).getOperands()[0].toString();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 376 -                    if(tableName.equalsIgnoreCase(replaceInfo.getTargetTableName())){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 377 -                        SqlNodeList sqlSelectList = sqlSelect.getSelectList();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 378 -                        SqlNode whereNode = sqlSelect.getWhere();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 379 -                        SqlNodeList sqlGroup = sqlSelect.getGroup();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 380 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 381 -                        //TODO 暂时不处理having</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 382 -                        SqlNode sqlHaving = sqlSelect.getHaving();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 383 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 384 -                        List&lt;SqlNode&gt; newSelectNodeList = Lists.newArrayList();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 385 -                        for( int i=0; i&lt;sqlSelectList.getList().size(); i++){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 386 -                            SqlNode selectNode = sqlSelectList.getList().get(i);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 387 -                            //特殊处理 isStar的标识</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 388 -                            if(selectNode.getKind() == IDENTIFIER &amp;&amp; ((SqlIdentifier) selectNode).isStar()){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 389 -                                List&lt;SqlNode&gt; replaceNodeList = replaceSelectStarFieldName(selectNode, replaceInfo);"> 389 -                                List&lt;SqlNode&gt; replaceNodeList = replaceSelectStarFieldName(selectNode, replaceInfo🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 390 -                                newSelectNodeList.addAll(replaceNodeList);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 391 -                                continue;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 392 -                            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 393 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 394 -                            SqlNode replaceNode = replaceSelectFieldName(selectNode, replaceInfo);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 395 -                            if(replaceNode == null){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 396 -                                continue;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 397 -                            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 398 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 399 -                            //sqlSelectList.set(i, replaceNode);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 400 -                            newSelectNodeList.add(replaceNode);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 401 -                        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 402 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 403 -                        SqlNodeList newSelectList = new SqlNodeList(newSelectNodeList, sqlSelectList.getParserPosition());"> 403 -                        SqlNodeList newSelectList = new SqlNodeList(newSelectNodeList, sqlSelectList.getParserPosi🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 404 -                        sqlSelect.setSelectList(newSelectList);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 405 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 406 -                        //where</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 407 -                        if(whereNode != null){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 408 -                            SqlNode[] sqlNodeList = ((SqlBasicCall)whereNode).getOperands();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 409 -                            for(int i =0; i&lt;sqlNodeList.length; i++) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 410 -                                SqlNode whereSqlNode = sqlNodeList[i];</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 411 -                                SqlNode replaceNode = replaceNodeInfo(whereSqlNode, replaceInfo);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 412 -                                sqlNodeList[i] = replaceNode;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 413 -                            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 414 -                        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 415 -                        if(sqlGroup != null &amp;&amp; CollectionUtils.isNotEmpty(sqlGroup.getList())){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 416 -                            for( int i=0; i&lt;sqlGroup.getList().size(); i++){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 417 -                                SqlNode selectNode = sqlGroup.getList().get(i);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 418 -                                SqlNode replaceNode = replaceNodeInfo(selectNode, replaceInfo);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 419 -                                sqlGroup.set(i, replaceNode);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 420 -                            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 421 -                        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 422 -                    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 423 -                }else{</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 424 -                    throw new RuntimeException(&quot;---not deal type:&quot; + sqlNode);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 425 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 426 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 427 -                break;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 428 -            case UNION:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 429 -                SqlNode unionLeft = ((SqlBasicCall) sqlNode).getOperands()[0];</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 430 -                SqlNode unionRight = ((SqlBasicCall) sqlNode).getOperands()[1];</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 431 -                replaceFieldName(unionLeft, replaceInfo);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 432 -                replaceFieldName(unionRight, replaceInfo);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 433 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 434 -                break;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 435 -            case ORDER_BY:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 436 -                SqlOrderBy sqlOrderBy  = (SqlOrderBy) sqlNode;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 437 -                replaceFieldName(sqlOrderBy.query, replaceInfo);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 438 -                SqlNodeList orderFiledList = sqlOrderBy.orderList;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 439 -                for (int i=0 ;i&lt;orderFiledList.size();i++) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 440 -                    SqlNode replaceNode = replaceOrderByTableName(orderFiledList.get(i), replaceInfo.getTargetTableAlias());"> 440 -                    SqlNode replaceNode = replaceOrderByTableName(orderFiledList.get(i), replaceInfo.getTargetTabl🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 441 -                    orderFiledList.set(i, replaceNode);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 442 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 443 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 444 -            default:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 445 -                break;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 446 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 447 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 448 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 449 -    private SqlNode replaceOrderByTableName(SqlNode orderNode, String tableAlias) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 450 -        if(orderNode.getKind() == IDENTIFIER){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 451 -            SqlIdentifier sqlIdentifier = (SqlIdentifier) orderNode;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 452 -            if (sqlIdentifier.names.size() == 1) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 453 -                return orderNode;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 454 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 455 -            return sqlIdentifier.setName(0, tableAlias);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 456 -        } else if (orderNode instanceof  SqlBasicCall) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 457 -            SqlBasicCall sqlBasicCall = (SqlBasicCall) orderNode;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 458 -            for(int i=0; i&lt;sqlBasicCall.getOperandList().size(); i++){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 459 -                SqlNode sqlNode = sqlBasicCall.getOperandList().get(i);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 460 -                sqlBasicCall.getOperands()[i] = replaceOrderByTableName(sqlNode , tableAlias);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 461 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 462 -            return sqlBasicCall;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 463 -        } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 464 -            return orderNode;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 465 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 466 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 467 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 468 -    private SqlNode replaceNodeInfo(SqlNode groupNode, FieldReplaceInfo replaceInfo){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 469 -        if(groupNode.getKind() == IDENTIFIER){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 470 -            SqlIdentifier sqlIdentifier = (SqlIdentifier) groupNode;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 471 -            if(sqlIdentifier.names.size() == 1){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 472 -                return sqlIdentifier;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 473 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 474 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 475 -            String mappingFieldName = replaceInfo.getTargetFieldName(sqlIdentifier.getComponent(0).getSimple(), sqlIdentifier.getComponent(1).getSimple());"> 475 -            String mappingFieldName = replaceInfo.getTargetFieldName(sqlIdentifier.getComponent(0).getSimple(), sq🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 476 -            if(mappingFieldName == null){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 477 -                throw new RuntimeException(&quot;can&#x27;t find mapping fieldName:&quot; + sqlIdentifier.toString() );</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 478 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 479 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 480 -            sqlIdentifier = sqlIdentifier.setName(0, replaceInfo.getTargetTableAlias());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 481 -            return sqlIdentifier.setName(1, mappingFieldName);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 482 -        }else if(groupNode instanceof  SqlBasicCall){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 483 -            SqlBasicCall sqlBasicCall = (SqlBasicCall) groupNode;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 484 -            for(int i=0; i&lt;sqlBasicCall.getOperandList().size(); i++){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 485 -                SqlNode sqlNode = sqlBasicCall.getOperandList().get(i);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 486 -                SqlNode replaceNode = replaceSelectFieldName(sqlNode, replaceInfo);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 487 -                sqlBasicCall.getOperands()[i] = replaceNode;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 488 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 489 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 490 -            return sqlBasicCall;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 491 -        }else{</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 492 -            return groupNode;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 493 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 494 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 495 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 496 -    public SqlNode filterNodeWithTargetName(SqlNode sqlNode, String targetTableName) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 497 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 498 -        SqlKind sqlKind = sqlNode.getKind();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 499 -        switch (sqlKind){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 500 -            case SELECT:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 501 -                SqlNode fromNode = ((SqlSelect)sqlNode).getFrom();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 502 -                if(fromNode.getKind() == AS &amp;&amp; ((SqlBasicCall)fromNode).getOperands()[0].getKind() == IDENTIFIER){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 503 -                    if(((SqlBasicCall)fromNode).getOperands()[0].toString().equalsIgnoreCase(targetTableName)){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 504 -                        return sqlNode;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 505 -                    }else{</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 506 -                        return null;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 507 -                    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 508 -                }else{</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 509 -                    return filterNodeWithTargetName(fromNode, targetTableName);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 510 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 511 -            case AS:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 512 -                SqlNode childNode = ((SqlBasicCall)sqlNode).getOperands()[0];</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 513 -                return filterNodeWithTargetName(childNode, targetTableName);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 514 -            case JOIN:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 515 -                SqlNode leftNode = ((SqlJoin)sqlNode).getLeft();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 516 -                SqlNode rightNode =  ((SqlJoin)sqlNode).getRight();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 517 -                SqlNode leftReturnNode = filterNodeWithTargetName(leftNode, targetTableName);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 518 -                SqlNode rightReturnNode = filterNodeWithTargetName(rightNode, targetTableName);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 519 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 520 -                if(leftReturnNode != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 521 -                    return leftReturnNode;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 522 -                }else if(rightReturnNode != null){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 523 -                    return rightReturnNode;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 524 -                }else{</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 525 -                    return null;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 526 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 527 -            default:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 528 -                break;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 529 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 530 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 531 -        return null;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 532 -    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 533 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 534 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 535 +</span>
 536  
 537  
 538      public void setLocalSqlPluginPath(String localSqlPluginPath) {
 539          this.localSqlPluginPath = localSqlPluginPath;
 540      }
 541  
 542      private Table getTableFromCache(Map&lt;String, Table&gt; localTableCache, String tableAlias, String tableName){
 543          Table table = localTableCache.get(tableAlias);
 544          if(table == null){
 545              table = localTableCache.get(tableName);
 546          }
 547  
 548          if(table == null){
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 549 -            throw new RuntimeException(&quot;not register table &quot; + tableName);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 550 +            throw new RuntimeException(&quot;not register table &quot; + tableAlias);</span>
 551          }
 552  
 553          return table;
 554      }
 555  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 556 -    private List&lt;SqlNode&gt; replaceSelectStarFieldName(SqlNode selectNode, FieldReplaceInfo replaceInfo){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 557 -        SqlIdentifier sqlIdentifier = (SqlIdentifier) selectNode;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 558 -        List&lt;SqlNode&gt; sqlNodes = Lists.newArrayList();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 559 -        if(sqlIdentifier.isStar()){//处理 [* or table.*]</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 560 -            int identifierSize = sqlIdentifier.names.size();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 561 -            Collection&lt;String&gt; columns = null;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 562 -            if(identifierSize == 1){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 563 -                columns = replaceInfo.getMappingTable().values();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 564 -            }else{</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 565 -                columns = replaceInfo.getMappingTable().row(sqlIdentifier.names.get(0)).values();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 566 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 567 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 568 -            for(String colAlias : columns){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 569 -                SqlParserPos sqlParserPos = new SqlParserPos(0, 0);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 570 -                List&lt;String&gt; columnInfo = Lists.newArrayList();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 571 -                columnInfo.add(replaceInfo.getTargetTableAlias());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 572 -                columnInfo.add(colAlias);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 573 -                SqlIdentifier sqlIdentifierAlias = new SqlIdentifier(columnInfo, sqlParserPos);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 574 -                sqlNodes.add(sqlIdentifierAlias);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 575 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 576 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 577 -            return sqlNodes;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 578 -        }else{</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 579 -            throw new RuntimeException(&quot;is not a star select field.&quot; + selectNode);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 580 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 581 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 582 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 583 -    private SqlNode replaceSelectFieldName(SqlNode selectNode, FieldReplaceInfo replaceInfo) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 584 -        if (selectNode.getKind() == AS) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 585 -            SqlNode leftNode = ((SqlBasicCall) selectNode).getOperands()[0];</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 586 -            SqlNode replaceNode = replaceSelectFieldName(leftNode, replaceInfo);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 587 -            if (replaceNode != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 588 -                ((SqlBasicCall) selectNode).getOperands()[0] = replaceNode;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 589 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 590 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 591 -            return selectNode;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 592 -        }else if(selectNode.getKind() == IDENTIFIER){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 593 -            SqlIdentifier sqlIdentifier = (SqlIdentifier) selectNode;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 594 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 595 -            if(sqlIdentifier.names.size() == 1){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 596 -                return selectNode;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 597 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 598 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 599 -            //Same level mappingTable</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 600 -            String mappingFieldName = replaceInfo.getTargetFieldName(sqlIdentifier.getComponent(0).getSimple(), sqlIdentifier.getComponent(1).getSimple());"> 600 -            String mappingFieldName = replaceInfo.getTargetFieldName(sqlIdentifier.getComponent(0).getSimple(), sq🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 601 -            if (mappingFieldName == null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 602 -                throw new RuntimeException(&quot;can&#x27;t find mapping fieldName:&quot; + selectNode.toString() );</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 603 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 604 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 605 -            sqlIdentifier = sqlIdentifier.setName(0, replaceInfo.getTargetTableAlias());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 606 -            sqlIdentifier = sqlIdentifier.setName(1, mappingFieldName);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 607 -            return sqlIdentifier;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 608 -        }else if(selectNode.getKind() == LITERAL || selectNode.getKind() == LITERAL_CHAIN){//字面含义</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 609 -            return selectNode;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 610 -        }else if(  AGGREGATE.contains(selectNode.getKind())</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 611 -                || AVG_AGG_FUNCTIONS.contains(selectNode.getKind())</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 612 -                || COMPARISON.contains(selectNode.getKind())</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 613 -                || selectNode.getKind() == OTHER_FUNCTION</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 614 -                || selectNode.getKind() == DIVIDE</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 615 -                || selectNode.getKind() == CAST</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 616 -                || selectNode.getKind() == TRIM</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 617 -                || selectNode.getKind() == TIMES</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 618 -                || selectNode.getKind() == PLUS</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 619 -                || selectNode.getKind() == NOT_IN</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 620 -                || selectNode.getKind() == OR</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 621 -                || selectNode.getKind() == AND</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 622 -                || selectNode.getKind() == MINUS</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 623 -                || selectNode.getKind() == TUMBLE</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 624 -                || selectNode.getKind() == TUMBLE_START</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 625 -                || selectNode.getKind() == TUMBLE_END</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 626 -                || selectNode.getKind() == SESSION</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 627 -                || selectNode.getKind() == SESSION_START</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 628 -                || selectNode.getKind() == SESSION_END</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 629 -                || selectNode.getKind() == HOP</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 630 -                || selectNode.getKind() == HOP_START</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 631 -                || selectNode.getKind() == HOP_END</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 632 -                || selectNode.getKind() == BETWEEN</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 633 -                || selectNode.getKind() == IS_NULL</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 634 -                || selectNode.getKind() == IS_NOT_NULL</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 635 -                || selectNode.getKind() == CONTAINS</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 636 -                || selectNode.getKind() == TIMESTAMP_ADD</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 637 -                || selectNode.getKind() == TIMESTAMP_DIFF</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 638 -                || selectNode.getKind() == LIKE</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 639 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 640 -                ){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 641 -            SqlBasicCall sqlBasicCall = (SqlBasicCall) selectNode;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 642 -            for(int i=0; i&lt;sqlBasicCall.getOperands().length; i++){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 643 -                SqlNode sqlNode = sqlBasicCall.getOperands()[i];</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 644 -                if(sqlNode instanceof SqlLiteral){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 645 -                    continue;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 646 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 647 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 648 -                if(sqlNode instanceof SqlDataTypeSpec){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 649 -                    continue;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 650 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 651 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 652 -                SqlNode replaceNode = replaceSelectFieldName(sqlNode, replaceInfo);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 653 -                if(replaceNode == null){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 654 -                    continue;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 655 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 656 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 657 -                sqlBasicCall.getOperands()[i] = replaceNode;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 658 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 659 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 660 -            return selectNode;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 661 -        }else if(selectNode.getKind() == CASE){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 662 -            SqlCase sqlCase = (SqlCase) selectNode;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 663 -            SqlNodeList whenOperands = sqlCase.getWhenOperands();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 664 -            SqlNodeList thenOperands = sqlCase.getThenOperands();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 665 -            SqlNode elseNode = sqlCase.getElseOperand();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 666 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 667 -            for(int i=0; i&lt;whenOperands.size(); i++){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 668 -                SqlNode oneOperand = whenOperands.get(i);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 669 -                SqlNode replaceNode = replaceSelectFieldName(oneOperand, replaceInfo);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 670 -                if (replaceNode != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 671 -                    whenOperands.set(i, replaceNode);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 672 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 673 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 674 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 675 -            for(int i=0; i&lt;thenOperands.size(); i++){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 676 -                SqlNode oneOperand = thenOperands.get(i);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 677 -                SqlNode replaceNode = replaceSelectFieldName(oneOperand, replaceInfo);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 678 -                if (replaceNode != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 679 -                    thenOperands.set(i, replaceNode);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 680 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 681 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 682 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 683 -            ((SqlCase) selectNode).setOperand(3, replaceSelectFieldName(elseNode, replaceInfo));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 684 -            return selectNode;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 685 -        }else if(selectNode.getKind() == OTHER){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 686 -            //不处理</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 687 -            return selectNode;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 688 -        }else{</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 689 -            throw new RuntimeException(String.format(&quot;not support node kind of %s to replace name now.&quot;, selectNode.getKind()));"> 689 -            throw new RuntimeException(String.format(&quot;not support node kind of %s to replace name now.&quot;, selectNod🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 690 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 691 -    }</span>
 692  
 693      /**
<abbr title=" 694       * Analyzing conditions are very join the dimension tables include all equivalent conditions (i.e., dimension table is the primary key definition"> 694       * Analyzing conditions are very join the dimension tables include all equivalent conditions (i.e., dimension 🔵</abbr>
 695       *
 696       * @return
 697       */
<abbr title=" 698      private boolean checkJoinCondition(SqlNode conditionNode, String sideTableAlias, AbstractSideTableInfo sideTableInfo) {"> 698      private boolean checkJoinCondition(SqlNode conditionNode, String sideTableAlias, AbstractSideTableInfo sideTab🔵</abbr>
 699          List&lt;String&gt; conditionFields = getConditionFields(conditionNode, sideTableAlias, sideTableInfo);
 700          if(CollectionUtils.isEqualCollection(conditionFields, convertPrimaryAlias(sideTableInfo))){
 701              return true;
 702          }
 703          return false;
 704      }
 705  
 706      private List&lt;String&gt; convertPrimaryAlias(AbstractSideTableInfo sideTableInfo) {
 707          List&lt;String&gt; res = Lists.newArrayList();
 708          sideTableInfo.getPrimaryKeys().forEach(field -&gt; {
 709              res.add(sideTableInfo.getPhysicalFields().getOrDefault(field, field));
 710          });
 711          return res;
 712      }
 713  
<abbr title=" 714      public List&lt;String&gt; getConditionFields(SqlNode conditionNode, String specifyTableName, AbstractSideTableInfo sideTableInfo){"> 714      public List&lt;String&gt; getConditionFields(SqlNode conditionNode, String specifyTableName, AbstractSideTableInfo s🔵</abbr>
 715          List&lt;SqlNode&gt; sqlNodeList = Lists.newArrayList();
 716          ParseUtils.parseAnd(conditionNode, sqlNodeList);
 717          List&lt;String&gt; conditionFields = Lists.newArrayList();
 718          for(SqlNode sqlNode : sqlNodeList){
 719              if (!SqlKind.COMPARISON.contains(sqlNode.getKind())) {
 720                  throw new RuntimeException(&quot;not compare operator.&quot;);
 721              }
 722  
 723              SqlIdentifier left = (SqlIdentifier)((SqlBasicCall)sqlNode).getOperands()[0];
 724              SqlIdentifier right = (SqlIdentifier)((SqlBasicCall)sqlNode).getOperands()[1];
 725  
 726              String leftTableName = left.getComponent(0).getSimple();
 727              String rightTableName = right.getComponent(0).getSimple();
 728  
 729              String tableCol = &quot;&quot;;
 730              if(leftTableName.equalsIgnoreCase(specifyTableName)){
 731                  tableCol = left.getComponent(1).getSimple();
 732              }else if(rightTableName.equalsIgnoreCase(specifyTableName)){
 733                  tableCol = right.getComponent(1).getSimple();
 734              }else{
<abbr title=" 735                  throw new RuntimeException(String.format(&quot;side table:%s join condition is wrong&quot;, specifyTableName));"> 735                  throw new RuntimeException(String.format(&quot;side table:%s join condition is wrong&quot;, specifyTableName🔵</abbr>
 736              }
 737              tableCol = sideTableInfo.getPhysicalFields().getOrDefault(tableCol, tableCol);
 738              conditionFields.add(tableCol);
 739          }
 740  
 741          return conditionFields;
 742      }
 743  
 744      protected void dealAsSourceTable(StreamTableEnvironment tableEnv,
 745                                       SqlNode pollSqlNode,
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 746 -                                     Map&lt;String, Table&gt; tableCache,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 747 -                                     List&lt;FieldReplaceInfo&gt; replaceInfoList) throws SqlParseException {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 748 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 749 -        AliasInfo aliasInfo = parseAsNode(pollSqlNode);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 750 +                                     Map&lt;String, Table&gt; tableCache) throws SqlParseException {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 751 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 752 +        AliasInfo aliasInfo = parseASNode(pollSqlNode);</span>
 753          if (localTableCache.containsKey(aliasInfo.getName())) {
 754              return;
 755          }
 756  
 757          Table table = tableEnv.sqlQuery(aliasInfo.getName());
 758          tableEnv.registerTable(aliasInfo.getAlias(), table);
 759          localTableCache.put(aliasInfo.getAlias(), table);
 760  
 761          LOG.info(&quot;Register Table {} by {}&quot;, aliasInfo.getAlias(), aliasInfo.getName());
 762  
 763          FieldReplaceInfo fieldReplaceInfo = parseAsQuery((SqlBasicCall) pollSqlNode, tableCache);
 764          if(fieldReplaceInfo == null){
 765             return;
 766          }
 767  
 768          //as 的源表
 769          Set&lt;String&gt; fromTableNameSet = Sets.newHashSet();
 770          SqlNode fromNode = ((SqlBasicCall)pollSqlNode).getOperands()[0];
 771          TableUtils.getFromTableInfo(fromNode, fromTableNameSet);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 772 -        for(FieldReplaceInfo tmp : replaceInfoList){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 773 -            if(fromTableNameSet.contains(tmp.getTargetTableName())</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 774 -                    || fromTableNameSet.contains(tmp.getTargetTableAlias())){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 775 -                fieldReplaceInfo.setPreNode(tmp);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 776 -                break;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 777 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 778 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 779 -        replaceInfoList.add(fieldReplaceInfo);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 780 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 781 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 782 -    private void joinFun(Object pollObj, Map&lt;String, Table&gt; localTableCache,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 783 -                         Map&lt;String, AbstractSideTableInfo&gt; sideTableMap, StreamTableEnvironment tableEnv,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 784 -                         List&lt;FieldReplaceInfo&gt; replaceInfoList) throws Exception{</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 785 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 786 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 787 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 788 +    private void joinFun(Object pollObj,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 789 +                         Map&lt;String, Table&gt; localTableCache,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 790 +                         Map&lt;String, AbstractSideTableInfo&gt; sideTableMap,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 791 +                         StreamTableEnvironment tableEnv) throws Exception{</span>
 792          JoinInfo joinInfo = (JoinInfo) pollObj;
 793  
 794          JoinScope joinScope = new JoinScope();
 795          JoinScope.ScopeChild leftScopeChild = new JoinScope.ScopeChild();
 796          leftScopeChild.setAlias(joinInfo.getLeftTableAlias());
 797          leftScopeChild.setTableName(joinInfo.getLeftTableName());
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 798 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 799 -        SqlKind sqlKind = joinInfo.getLeftNode().getKind();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 800 -        if(sqlKind == AS){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 801 -            dealAsSourceTable(tableEnv, joinInfo.getLeftNode(), localTableCache, replaceInfoList);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 802 -        }</span>
 803  
<abbr title=" 804          Table leftTable = getTableFromCache(localTableCache, joinInfo.getLeftTableAlias(), joinInfo.getLeftTableName());"> 804          Table leftTable = getTableFromCache(localTableCache, joinInfo.getLeftTableAlias(), joinInfo.getLeftTableNa🔵</abbr>
<abbr title=" 805          RowTypeInfo leftTypeInfo = new RowTypeInfo(leftTable.getSchema().getTypes(), leftTable.getSchema().getColumnNames());"> 805          RowTypeInfo leftTypeInfo = new RowTypeInfo(leftTable.getSchema().getTypes(), leftTable.getSchema().getColu🔵</abbr>


 806          leftScopeChild.setRowTypeInfo(leftTypeInfo);
 807  
 808          JoinScope.ScopeChild rightScopeChild = new JoinScope.ScopeChild();
 809          rightScopeChild.setAlias(joinInfo.getRightTableAlias());
 810          rightScopeChild.setTableName(joinInfo.getRightTableName());
 811          AbstractSideTableInfo sideTableInfo = sideTableMap.get(joinInfo.getRightTableName());
 812          if(sideTableInfo == null){
 813              sideTableInfo = sideTableMap.get(joinInfo.getRightTableAlias());
 814          }
 815  
 816          if(sideTableInfo == null){
 817              throw new RuntimeException(&quot;can&#x27;t not find side table:&quot; + joinInfo.getRightTableName());
 818          }
 819  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 820 -//        if(!checkJoinCondition(joinInfo.getCondition(), joinInfo.getRightTableAlias(), sideTableInfo)){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 821 -//            throw new RuntimeException(&quot;ON condition must contain all equal fields!!!&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 822 -//        }</span>



<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 823 -</span>
 824          rightScopeChild.setRowTypeInfo(sideTableInfo.getRowTypeInfo());
 825  
 826          joinScope.addScope(leftScopeChild);
 827          joinScope.addScope(rightScopeChild);
 828  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 829 +        HashBasedTable&lt;String, String, String&gt; mappingTable = ((JoinInfo) pollObj).getTableFieldRef();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 830 +</span>
 831          //获取两个表的所有字段
<abbr title=" 832          List&lt;FieldInfo&gt; sideJoinFieldInfo = ParserJoinField.getRowTypeInfo(joinInfo.getSelectNode(), joinScope, true);"> 832          List&lt;FieldInfo&gt; sideJoinFieldInfo = ParserJoinField.getRowTypeInfo(joinInfo.getSelectNode(), joinScope, tr🔵</abbr>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 833 +        //通过join的查询字段信息过滤出需要的字段信息</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 834 +        sideJoinFieldInfo.removeIf(tmpFieldInfo -&gt; mappingTable.get(tmpFieldInfo.getTable(), tmpFieldInfo.getFieldName()) == null);"> 834 +        sideJoinFieldInfo.removeIf(tmpFieldInfo -&gt; mappingTable.get(tmpFieldInfo.getTable(), tmpFieldInfo.getField🔵</abbr></span>
 835  
 836          String leftTableAlias = joinInfo.getLeftTableAlias();
 837          Table targetTable = localTableCache.get(leftTableAlias);
 838          if(targetTable == null){
 839              targetTable = localTableCache.get(joinInfo.getLeftTableName());
 840          }
 841  
<abbr title=" 842          RowTypeInfo typeInfo = new RowTypeInfo(targetTable.getSchema().getTypes(), targetTable.getSchema().getColumnNames());"> 842          RowTypeInfo typeInfo = new RowTypeInfo(targetTable.getSchema().getTypes(), targetTable.getSchema().getColu🔵</abbr>
 843  
 844          DataStream&lt;CRow&gt; adaptStream = tableEnv.toRetractStream(targetTable, org.apache.flink.types.Row.class)
 845                  .map((Tuple2&lt;Boolean, Row&gt; tp2) -&gt; {
 846                      return new CRow(tp2.f1, tp2.f0);
 847                  }).returns(CRow.class);
 848  



 849  
 850          //join side table before keyby ===&gt; Reducing the size of each dimension table cache of async
 851          if (sideTableInfo.isPartitionedJoin()) {
<abbr title=" 852              List&lt;String&gt; leftJoinColList = getConditionFields(joinInfo.getCondition(), joinInfo.getLeftTableAlias(), sideTableInfo);"> 852              List&lt;String&gt; leftJoinColList = getConditionFields(joinInfo.getCondition(), joinInfo.getLeftTableAlias(🔵</abbr>
 853              List&lt;String&gt; fieldNames = Arrays.asList(targetTable.getSchema().getFieldNames());
 854              int[] keyIndex = leftJoinColList.stream().mapToInt(fieldNames::indexOf).toArray();
<abbr title=" 855              adaptStream = adaptStream.keyBy(new CRowKeySelector(keyIndex, projectedTypeInfo(keyIndex, targetTable.getSchema())));"> 855              adaptStream = adaptStream.keyBy(new CRowKeySelector(keyIndex, projectedTypeInfo(keyIndex, targetTable.🔵</abbr>
 856          }
 857  
 858          DataStream&lt;CRow&gt; dsOut = null;




 859          if(ECacheType.ALL.name().equalsIgnoreCase(sideTableInfo.getCacheType())){
<abbr title=" 860              dsOut = SideWithAllCacheOperator.getSideJoinDataStream(adaptStream, sideTableInfo.getType(), localSqlPluginPath, typeInfo, joinInfo, sideJoinFieldInfo, sideTableInfo);"> 860              dsOut = SideWithAllCacheOperator.getSideJoinDataStream(adaptStream, sideTableInfo.getType(), localSqlP🔵</abbr>
 861          }else{
<abbr title=" 862              dsOut = SideAsyncOperator.getSideJoinDataStream(adaptStream, sideTableInfo.getType(), localSqlPluginPath, typeInfo, joinInfo, sideJoinFieldInfo, sideTableInfo);"> 862              dsOut = SideAsyncOperator.getSideJoinDataStream(adaptStream, sideTableInfo.getType(), localSqlPluginPa🔵</abbr>
 863          }
 864  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 865 -        // TODO  将嵌套表中的字段传递过去, 去除冗余的ROWtime</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 866 -        HashBasedTable&lt;String, String, String&gt; mappingTable = HashBasedTable.create();</span>
 867          RowTypeInfo sideOutTypeInfo = buildOutRowTypeInfo(sideJoinFieldInfo, mappingTable);
 868  
 869          CRowTypeInfo cRowTypeInfo = new CRowTypeInfo(sideOutTypeInfo);
 870          dsOut.getTransformation().setOutputType(cRowTypeInfo);


 871  
 872          String targetTableName = joinInfo.getNewTableName();
 873          String targetTableAlias = joinInfo.getNewTableAlias();
 874  
 875          FieldReplaceInfo replaceInfo = new FieldReplaceInfo();
 876          replaceInfo.setMappingTable(mappingTable);
 877          replaceInfo.setTargetTableName(targetTableName);
 878          replaceInfo.setTargetTableAlias(targetTableAlias);
 879  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 880 -        //判断之前是不是被替换过,被替换过则设置之前的替换信息作为上一个节点</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 881 -        for(FieldReplaceInfo tmp : replaceInfoList){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 882 -            if(tmp.getTargetTableName().equalsIgnoreCase(joinInfo.getLeftTableName())</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 883 -            ||tmp.getTargetTableName().equalsIgnoreCase(joinInfo.getLeftTableAlias())){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 884 -                replaceInfo.setPreNode(tmp);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 885 -                break;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 886 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 887 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 888 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 889 -        replaceInfoList.add(replaceInfo);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 890 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 891 -        if (!tableEnv.isRegistered(joinInfo.getNewTableName())){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 892 +        if (!tableEnv.isRegistered(targetTableName)){</span>

 893              Table joinTable = tableEnv.fromDataStream(dsOut);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 894 -            tableEnv.registerTable(joinInfo.getNewTableName(), joinTable);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 895 +            tableEnv.registerTable(targetTableName, joinTable);</span>
 896              localTableCache.put(joinInfo.getNewTableName(), joinTable);
 897          }
 898      }
 899  
 900      private TypeInformation&lt;Row&gt; projectedTypeInfo(int[] fields, TableSchema schema) {
 901          String[] fieldNames = schema.getFieldNames();
 902          TypeInformation&lt;?&gt;[] fieldTypes = schema.getFieldTypes();
 903  
 904          String[] projectedNames = Arrays.stream(fields).mapToObj(i -&gt; fieldNames[i]).toArray(String[]::new);
<abbr title=" 905          TypeInformation[] projectedTypes = Arrays.stream(fields).mapToObj(i -&gt; fieldTypes[i]).toArray(TypeInformation[]::new);"> 905          TypeInformation[] projectedTypes = Arrays.stream(fields).mapToObj(i -&gt; fieldTypes[i]).toArray(TypeInformat🔵</abbr>
 906          return new RowTypeInfo(projectedTypes, projectedNames);
 907      }
 908  
 909  
 910      private boolean checkFieldsInfo(CreateTmpTableParser.SqlParserResult result, Table table) {
 911          List&lt;String&gt; fieldNames = new LinkedList&lt;&gt;();
 912          String fieldsInfo = result.getFieldsInfoStr();
 913          String[] fields = StringUtils.split(fieldsInfo, &quot;,&quot;);
 914          for (int i = 0; i &lt; fields.length; i++) {
 915              String[] filed = fields[i].split(&quot;\\s&quot;);
 916              if (filed.length &lt; 2 || fields.length != table.getSchema().getColumnNames().length){

 917                  return false;
 918              } else {
 919                  String[] filedNameArr = new String[filed.length - 1];
 920                  System.arraycopy(filed, 0, filedNameArr, 0, filed.length - 1);
 921                  String fieldName = String.join(&quot; &quot;, filedNameArr);
 922                  fieldNames.add(fieldName);
 923                  String fieldType = filed[filed.length - 1 ].trim();
 924                  Class fieldClass = ClassUtil.stringConvertClass(fieldType);
 925                  Class tableField = table.getSchema().getFieldType(i).get().getTypeClass();
 926                  if (fieldClass == tableField){
 927                      continue;
 928                  } else {
 929                      return false;
 930                  }
 931              }
 932          }
 933          tmpFields = String.join(&quot;,&quot;, fieldNames);
 934          return true;
 935      }
 936  
 937  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            