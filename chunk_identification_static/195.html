<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>195</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    195
                    <a href="194.html">prev</a>
                    <a href="196.html">next</a>
                    <a href="195_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    BroadleafCommerce/BroadleafCommerce_ca7ad284b68b41fd53b2a9e24cafe6fadaee52e8_core/broadleaf-framework/src/main/java/org/broadleafcommerce/core/offer/service/OfferServiceImpl.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;ca7ad284b68b41fd53b2a9e24cafe6fadaee52e8:core/broadleaf-framework/src/main/java/org/broadleafcommerce/core/offer/service/OfferServiceImpl.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;ca7ad284b68b41fd53b2a9e24cafe6fadaee52e8^1:core/broadleaf-framework/src/main/java/org/broadleafcommerce/core/offer/service/OfferServiceImpl.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;ca7ad284b68b41fd53b2a9e24cafe6fadaee52e8^2:core/broadleaf-framework/src/main/java/org/broadleafcommerce/core/offer/service/OfferServiceImpl.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;1d8f70a5cd049c3d229a6ef9441390c91fb57271:core/broadleaf-framework/src/main/java/org/broadleafcommerce/core/offer/service/OfferServiceImpl.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[bj]], subset: [[bj]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Framework
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  * 
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.core.offer.service;
  19 
  20 import org.apache.commons.collections.CollectionUtils;
  21 import org.apache.commons.collections.Transformer;
  22 import org.apache.commons.logging.Log;
  23 import org.apache.commons.logging.LogFactory;
  24 import org.broadleafcommerce.common.persistence.EntityDuplicateModifier;
  25 import org.broadleafcommerce.common.persistence.EntityDuplicator;
  26 import org.broadleafcommerce.common.sandbox.SandBoxHelper;
  27 import org.broadleafcommerce.common.util.StreamCapableTransactionalOperationAdapter;
  28 import org.broadleafcommerce.common.util.StreamingTransactionCapableUtil;
  29 import org.broadleafcommerce.core.offer.dao.CustomerOfferDao;
  30 import org.broadleafcommerce.core.offer.dao.OfferCodeDao;
  31 import org.broadleafcommerce.core.offer.dao.OfferDao;
  32 import org.broadleafcommerce.core.offer.domain.Adjustment;
  33 import org.broadleafcommerce.core.offer.domain.CustomerOffer;
  34 import org.broadleafcommerce.core.offer.domain.Offer;
  35 import org.broadleafcommerce.core.offer.domain.OfferCode;
  36 import org.broadleafcommerce.core.offer.domain.OfferImpl;
  37 import org.broadleafcommerce.core.offer.domain.OrderItemPriceDetailAdjustment;
  38 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableCandidateFulfillmentGroupOffer;
  39 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableCandidateItemOffer;
  40 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableCandidateOrderOffer;
  41 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableItemFactory;
  42 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrder;
  43 import org.broadleafcommerce.core.offer.service.processor.FulfillmentGroupOfferProcessor;
  44 import org.broadleafcommerce.core.offer.service.processor.ItemOfferProcessor;
  45 import org.broadleafcommerce.core.offer.service.processor.OrderOfferProcessor;
  46 import org.broadleafcommerce.core.offer.service.type.CustomerMaxUsesStrategyType;
  47 import org.broadleafcommerce.core.offer.service.type.OfferType;
  48 import org.broadleafcommerce.core.order.domain.FulfillmentGroup;
  49 import org.broadleafcommerce.core.order.domain.Order;
  50 import org.broadleafcommerce.core.order.domain.OrderItem;
  51 import org.broadleafcommerce.core.order.domain.OrderItemPriceDetail;
  52 import org.broadleafcommerce.core.order.service.OrderService;
  53 import org.broadleafcommerce.core.pricing.service.exception.PricingException;
  54 import org.broadleafcommerce.profile.core.domain.Customer;
  55 import org.springframework.stereotype.Service;
  56 import org.springframework.transaction.annotation.Transactional;
  57 
  58 import java.util.ArrayList;
  59 import java.util.Collection;
  60 import java.util.HashMap;
  61 import java.util.HashSet;
  62 import java.util.Iterator;
  63 import java.util.List;
  64 import java.util.Map;
  65 import java.util.Objects;
  66 import java.util.Set;
  67 
  68 import javax.annotation.Resource;
  69 import javax.persistence.EntityManager;
  70 import javax.persistence.PersistenceContext;
  71 
  72 /**
  73  * The Class OfferServiceImpl.
  74  */
  75 @Service(&quot;blOfferService&quot;)
  76 public class OfferServiceImpl implements OfferService {
  77     
  78     private static final Log LOG = LogFactory.getLog(OfferServiceImpl.class);
  79 
  80     // should be called outside of Offer service after Offer service is executed
  81     @Resource(name=&quot;blCustomerOfferDao&quot;)
  82     protected CustomerOfferDao customerOfferDao;
  83 
  84     @Resource(name=&quot;blOfferCodeDao&quot;)
  85     protected OfferCodeDao offerCodeDao;
  86     
  87     @Resource(name=&quot;blOfferAuditService&quot;)
  88     protected OfferAuditService offerAuditService;
  89 
  90     @Resource(name=&quot;blOfferDao&quot;)
  91     protected OfferDao offerDao;
  92     
  93     @Resource(name=&quot;blOrderOfferProcessor&quot;)
  94     protected OrderOfferProcessor orderOfferProcessor;
  95     
  96     @Resource(name=&quot;blItemOfferProcessor&quot;)
  97     protected ItemOfferProcessor itemOfferProcessor;
  98     
  99     @Resource(name=&quot;blFulfillmentGroupOfferProcessor&quot;)
 100     protected FulfillmentGroupOfferProcessor fulfillmentGroupOfferProcessor;
 101     
 102     @Resource(name=&quot;blPromotableItemFactory&quot;)
 103     protected PromotableItemFactory promotableItemFactory;
 104 
 105     @Resource(name = &quot;blOfferServiceExtensionManager&quot;)
 106     protected OfferServiceExtensionManager extensionManager;
 107 
 108     @Resource(name = &quot;blOrderService&quot;)
 109     protected OrderService orderService;
 110 
 111     @Resource(name = &quot;blSandBoxHelper&quot;)
 112     protected SandBoxHelper sandBoxHelper;
 113 
 114     @PersistenceContext(unitName=&quot;blPU&quot;)
 115     protected EntityManager em;
 116 
 117     @Resource(name=&quot;blStreamingTransactionCapableUtil&quot;)
 118     protected StreamingTransactionCapableUtil transUtil;
 119 
 120     @Resource(name=&quot;blEntityDuplicator&quot;)
 121     protected EntityDuplicator duplicator;
 122 
 123     /**
 124      * @deprecated Add {@link EntityDuplicateModifier}s to {@code blEntityDuplicationHelpers}
 125      */
 126     @Deprecated
 127     protected EntityDuplicateModifier&lt;Offer&gt; offerDuplicateModifier;
 128 
 129     @Override
 130     public List&lt;Offer&gt; findAllOffers() {
 131         return offerDao.readAllOffers();
 132     }
 133 
 134     @Override
 135     @Transactional(&quot;blTransactionManager&quot;)
 136     public Offer save(Offer offer) {
 137         return offerDao.save(offer);
 138     }
 139 
 140     @Override
 141     @Transactional(&quot;blTransactionManager&quot;)
 142     public OfferCode saveOfferCode(OfferCode offerCode) {
 143         offerCode.setOffer(offerDao.save(offerCode.getOffer()));
 144         return offerCodeDao.save(offerCode);
 145     }
 146 
 147     /**
<abbr title=" 148      * Creates a list of offers that applies to this order.  All offers that are assigned to the customer,"> 148      * Creates a list of offers that applies to this order.  All offers that are assigned to the customerðŸ”µ</abbr>
<abbr title=" 149      * entered during checkout, or has a delivery type of automatic are added to the list.  The same offer"> 149      * entered during checkout, or has a delivery type of automatic are added to the list.  The same offeðŸ”µ</abbr>
 150      * cannot appear more than once in the list.
 151      *
 152      * @param code
 153      * @return a List of offers that may apply to this order
 154      */
 155     @Override
 156     public Offer lookupOfferByCode(String code) {
 157         Offer offer = null;
 158         OfferCode offerCode = offerCodeDao.readOfferCodeByCode(code);
 159         if (offerCode != null) {
 160             offer = offerCode.getOffer();
 161         }
 162         return offer;
 163     }
 164     
 165     @Override
 166     public OfferCode lookupOfferCodeByCode(String code){
 167         return offerCodeDao.readOfferCodeByCode(code);
 168     }
 169 
 170     @Override
 171     public List&lt;Offer&gt; lookupAllOffersByCode(String code) {
 172         List&lt;Offer&gt; offers = new ArrayList&lt;Offer&gt;();
 173         List&lt;OfferCode&gt; offerCodes = offerCodeDao.readAllOfferCodesByCode(code);
 174         for (OfferCode offerCode : offerCodes) {
 175             if (offerCode != null) {
 176                 offers.add(offerCode.getOffer());
 177             }
 178         }
 179         return offers;
 180     }
 181 
 182     @Override
 183     public List&lt;OfferCode&gt; lookupAllOfferCodesByCode(String code){
 184         return offerCodeDao.readAllOfferCodesByCode(code);
 185     }
 186 
 187     /**
<abbr title=" 188      * Creates a list of offers that applies to this order.  All offers that are assigned to the customer,"> 188      * Creates a list of offers that applies to this order.  All offers that are assigned to the customerðŸ”µ</abbr>
<abbr title=" 189      * entered during checkout, or has a delivery type of automatic are added to the list.  The same offer"> 189      * entered during checkout, or has a delivery type of automatic are added to the list.  The same offeðŸ”µ</abbr>
 190      * cannot appear more than once in the list.
 191      *
 192      * @param order
 193      * @return a List of offers that may apply to this order
 194      */
 195     @Override
 196     public List&lt;Offer&gt; buildOfferListForOrder(Order order) {
 197         List&lt;Offer&gt; offers = new ArrayList&lt;Offer&gt;();
 198         List&lt;CustomerOffer&gt; customerOffers = lookupOfferCustomerByCustomer(order.getCustomer());
 199         for (CustomerOffer customerOffer : customerOffers) {
 200             if (!offers.contains(customerOffer.getOffer())) {
 201                 offers.add(customerOffer.getOffer());
 202             }
 203         }
 204         List&lt;OfferCode&gt; orderOfferCodes = refreshOfferCodesIfApplicable(order);
 205         orderOfferCodes = removeOutOfDateOfferCodes(orderOfferCodes);
 206         for (OfferCode orderOfferCode : orderOfferCodes) {
 207             if (!offers.contains(orderOfferCode.getOffer())) {
 208                 offers.add(orderOfferCode.getOffer());
 209             }
 210             extensionManager.getProxy().addAdditionalOffersForCode(offers, orderOfferCode);
 211         }
 212         List&lt;Offer&gt; globalOffers = lookupAutomaticDeliveryOffers();
 213         for (Offer globalOffer : globalOffers) {
 214             if (!offers.contains(globalOffer) &amp;&amp; verifyMaxCustomerUsageThreshold(order, globalOffer)) {
 215                 offers.add(globalOffer);
 216             }
 217         }
 218         
 219         if (extensionManager != null) {
 220             extensionManager.applyAdditionalFilters(offers, order);
 221         }
 222         
 223         return offers;
 224     }
 225 
 226     @Override
 227     public List&lt;OfferCode&gt; buildOfferCodeListForCustomer(Order order) {
 228         Customer customer = order.getCustomer();
 229         ArrayList&lt;OfferCode&gt; offerCodes = new ArrayList&lt;&gt;();
 230         
 231         if (extensionManager != null) {
 232             extensionManager.buildOfferCodeListForCustomer(customer, offerCodes);
 233         }
 234         if (!offerCodes.isEmpty()) {
 235             Iterator&lt;OfferCode&gt; itr = offerCodes.iterator();
 236             while (itr.hasNext()) {
 237                 OfferCode offerCode = itr.next();
 238                 if (!offerCode.isActive() || !verifyMaxCustomerUsageThreshold(order, offerCode)) {
 239                     itr.remove();
 240                 }
 241             }
 242         }
 243         return offerCodes;
 244     }
 245     
 246     @Deprecated
 247     @Override
 248     public List&lt;OfferCode&gt; buildOfferCodeListForCustomer(Customer customer) {
 249         ArrayList&lt;OfferCode&gt; offerCodes = new ArrayList&lt;OfferCode&gt;();
 250         if (extensionManager != null) {
 251             extensionManager.buildOfferCodeListForCustomer(customer, offerCodes);
 252         }
 253         if (!offerCodes.isEmpty()) {
 254             Iterator&lt;OfferCode&gt; itr = offerCodes.iterator();
 255             while (itr.hasNext()) {
 256                 OfferCode offerCode = itr.next();
 257                 if (!offerCode.isActive() || !verifyMaxCustomerUsageThreshold(customer, offerCode)) {
 258                     itr.remove();
 259                 }
 260             }
 261         }
 262         return offerCodes;
 263     }
 264 
 265     /**
 266      * Private method used to retrieve all offers assigned to this customer.  These offers are
 267      * programmatically assigned to the customer.
 268      *
 269      * @param customer
 270      * @return a List of offers assigned to the customer
 271      */
 272     protected List&lt;CustomerOffer&gt; lookupOfferCustomerByCustomer(Customer customer) {
 273         List&lt;CustomerOffer&gt; offerCustomers = customerOfferDao.readCustomerOffersByCustomer(customer);
 274         return offerCustomers;
 275     }
 276 
 277     /**
 278      * Private method used to retrieve all offers with automaticallyAdded set to true
 279      *
 280      * @return a List of automatic delivery offers
 281      */
 282     protected List&lt;Offer&gt; lookupAutomaticDeliveryOffers() {
 283         List&lt;Offer&gt; globalOffers = offerDao.readOffersByAutomaticDeliveryType();
 284         return globalOffers;
 285     }
 286 
 287     /**
 288      * Removes all out of date offerCodes based on the offerCode and its offer&#x27;s start and end
 289      * date.  If an offerCode has a later start date, that offerCode will be removed.
 290      * OfferCodes without a start date will still be processed. If the offerCode
 291      * has a end date that has already passed, that offerCode will be removed.  OfferCodes
 292      * without a end date will be processed.  The start and end dates on the offer will
 293      * still need to be evaluated.
 294      *
 295      * @param offerCodes
 296      * @return a List of non-expired offers
 297      */
 298     protected List&lt;OfferCode&gt; removeOutOfDateOfferCodes(List&lt;OfferCode&gt; offerCodes){
 299         List&lt;OfferCode&gt; offerCodesToRemove = new ArrayList&lt;OfferCode&gt;();
 300         for (OfferCode offerCode : offerCodes) {
 301             if (!offerCode.isActive()){
 302                 offerCodesToRemove.add(offerCode);
 303             }
 304         }
 305         // remove all offers in the offersToRemove list from original offers list
 306         for (OfferCode offerCode : offerCodesToRemove) {
 307             offerCodes.remove(offerCode);
 308         }
 309         return offerCodes;
 310     }
 311 
 312     /**
 313      * For enterprise installations, this will refresh any OfferCodes found to be out-of-date with
 314      * current sandbox status.
 315      *
 316      * @param order the order to check
 317      * @return the refreshed list of OfferCodes
 318      */
 319     protected List&lt;OfferCode&gt; refreshOfferCodesIfApplicable(final Order order) {
 320         final List&lt;OfferCode&gt; orderOfferCodes = order.getAddedOfferCodes();
 321 
 322         transUtil.runTransactionalOperation(new StreamCapableTransactionalOperationAdapter() {
 323             @Override
 324             public void execute() {
 325                 for (OfferCode offerCode : orderOfferCodes) {
 326                     if (offerCode.getOffer() != null) {
<abbr title=" 327                         Long sandBoxVersionId = sandBoxHelper.getSandBoxVersionId(OfferImpl.class, offerCode.getOffer().getId());"> 327                         Long sandBoxVersionId = sandBoxHelper.getSandBoxVersionId(OfferImpl.class, offerCðŸ”µ</abbr>
<abbr title=" 328                         if (sandBoxVersionId != null &amp;&amp; !Objects.equals(sandBoxVersionId, offerCode.getOffer().getId())) {"> 328                         if (sandBoxVersionId != null &amp;&amp; !Objects.equals(sandBoxVersionId, offerCode.getOfðŸ”µ</abbr>
 329                             em.refresh(offerCode);
 330                         }
 331                     }
 332                 }
 333             }
 334 
 335             @Override
 336             public boolean shouldRetryOnTransactionLockAcquisitionFailure() {
 337                 return true;
 338             }
 339         }, RuntimeException.class);
 340 
 341         return orderOfferCodes;
 342     }
 343 
 344     /*
 345      *
 346      * Offers Logic:
 347      * 1) Remove all existing offers in the Order (order, item, and fulfillment)
 348      * 2) Check and remove offers
 349      *    a) Remove out of date offers
 350      *    b) Remove offers that do not apply to this customer
 351      * 3) Loop through offers
 352      *    a) Verifies type of offer (order, order item, fulfillment)
 353      *    b) Verifies if offer can be applies
 354      *    c) Assign offer to type (order, order item, or fulfillment)
 355      * 4) Sorts the order and item offers list by priority and then discount
 356      * 5) Identify the best offers to apply to order item and create adjustments for each item offer
<abbr title=" 357      * 6) Compare order item adjustment price to sales price, and remove adjustments if sale price is better"> 357      * 6) Compare order item adjustment price to sales price, and remove adjustments if sale price is betðŸ”µ</abbr>
 358      * 7) Identify the best offers to apply to the order and create adjustments for each order offer
<abbr title=" 359      * 8) If item contains non-combinable offers remove either the item or order adjustments based on discount value"> 359      * 8) If item contains non-combinable offers remove either the item or order adjustments based on disðŸ”µ</abbr>
 360      * 9) Set final order item prices and reapply order offers
 361      *
 362      * Assumptions:
 363      * 1) % off all items will be created as an item offer with no expression
 364      * 2) $ off order will be created as an order offer
 365      * 3) Order offers applies to the best price for each item (not just retail price)
 366      * 4) Fulfillment offers apply to best price for each item (not just retail price)
<abbr title=" 367      * 5) Stackable only applies to the same offer type (i.e. a not stackable order offer can be used with item offers)"> 367      * 5) Stackable only applies to the same offer type (i.e. a not stackable order offer can be used witðŸ”µ</abbr>
 368      * 6) Fulfillment offers cannot be not combinable
 369      * 7) Order offers cannot be FIXED_PRICE
 370      * 8) FIXED_PRICE offers cannot be stackable
<abbr title=" 371      * 9) Non-combinable offers only apply to the order and order items, fulfillment group offers will always apply"> 371      * 9) Non-combinable offers only apply to the order and order items, fulfillment group offers will alðŸ”µ</abbr>
 372      *
 373      */
 374     @Override
 375     @Transactional(&quot;blTransactionManager&quot;)
 376     public Order applyAndSaveOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricingException {
 377         /*
 378         TODO rather than a threadlocal, we should update the &quot;shouldPrice&quot; boolean on the service API to
 379         use a richer object to describe the parameters of the pricing call. This object would include
 380         the pricing boolean, but would also include a list of activities to include or exclude in the
 381         call - see http://jira.broadleafcommerce.org/browse/BLC-664
 382          */
 383         OfferContext offerContext = OfferContext.getOfferContext();
 384         if (offerContext == null || offerContext.executePromotionCalculation) {
 385             PromotableOrder promotableOrder = promotableItemFactory.createPromotableOrder(order, false);
 386             List&lt;Offer&gt; filteredOffers = orderOfferProcessor.filterOffers(offers, order.getCustomer());
 387             if ((filteredOffers == null) || (filteredOffers.isEmpty())) {
 388                 if (LOG.isTraceEnabled()) {
 389                     LOG.trace(&quot;No offers applicable to this order.&quot;);
 390                 }
 391             } else {
<abbr title=" 392                 List&lt;PromotableCandidateOrderOffer&gt; qualifiedOrderOffers = new ArrayList&lt;PromotableCandidateOrderOffer&gt;();"> 392                 List&lt;PromotableCandidateOrderOffer&gt; qualifiedOrderOffers = new ArrayList&lt;PromotableCandidðŸ”µ</abbr>
<abbr title=" 393                 List&lt;PromotableCandidateItemOffer&gt; qualifiedItemOffers = new ArrayList&lt;PromotableCandidateItemOffer&gt;();"> 393                 List&lt;PromotableCandidateItemOffer&gt; qualifiedItemOffers = new ArrayList&lt;PromotableCandidatðŸ”µ</abbr>
 394 
<abbr title=" 395                 itemOfferProcessor.filterOffers(promotableOrder, filteredOffers, qualifiedOrderOffers, qualifiedItemOffers);"> 395                 itemOfferProcessor.filterOffers(promotableOrder, filteredOffers, qualifiedOrderOffers, quðŸ”µ</abbr>
 396 
<abbr title=" 397                 if (! (qualifiedItemOffers.isEmpty() &amp;&amp; qualifiedOrderOffers.isEmpty())) {                "> 397                 if (! (qualifiedItemOffers.isEmpty() &amp;&amp; qualifiedOrderOffers.isEmpty())) {               ðŸ”µ</abbr>
<abbr title=" 398                     // At this point, we should have a PromotableOrder that contains PromotableItems each of which"> 398                     // At this point, we should have a PromotableOrder that contains PromotableItems eachðŸ”µ</abbr>
 399                     // has a list of candidatePromotions that might be applied.
 400 
<abbr title=" 401                     // We also have a list of orderOffers that might apply and a list of itemOffers that might apply."> 401                     // We also have a list of orderOffers that might apply and a list of itemOffers that ðŸ”µ</abbr>
<abbr title=" 402                     itemOfferProcessor.applyAndCompareOrderAndItemOffers(promotableOrder, qualifiedOrderOffers, qualifiedItemOffers);"> 402                     itemOfferProcessor.applyAndCompareOrderAndItemOffers(promotableOrder, qualifiedOrderOðŸ”µ</abbr>
 403                 }
 404             }
 405             orderOfferProcessor.synchronizeAdjustmentsAndPrices(promotableOrder);
 406             
 407             verifyAdjustments(order, true);
 408             
 409             order.setSubTotal(order.calculateSubTotal());
 410             order.finalizeItemPrices();
 411             
 412             order = orderService.save(order, false);
 413             
 414             boolean madeChange = verifyAdjustments(order, false);
 415             if (madeChange) {
 416                 order = orderService.save(order, false);
 417             }
 418         }
 419 
 420         return order;
 421     }
 422     
 423     protected boolean verifyAdjustments(Order order, boolean beforeSave) {
 424         boolean madeChange = false;
 425         
 426         if (order.getOrderItems() == null) {
 427             return madeChange;
 428         }
 429 
 430         for (OrderItem oi : order.getOrderItems()) {
 431             if (oi.getOrderItemPriceDetails() == null) {
 432                 continue;
 433             }
 434 
 435             for (OrderItemPriceDetail pd : oi.getOrderItemPriceDetails()) {
 436                 if (pd.getOrderItemPriceDetailAdjustments() == null) {
 437                     continue;
 438                 }
 439 
<abbr title=" 440                 Map&lt;Long, OrderItemPriceDetailAdjustment&gt; adjs = new HashMap&lt;Long, OrderItemPriceDetailAdjustment&gt;();"> 440                 Map&lt;Long, OrderItemPriceDetailAdjustment&gt; adjs = new HashMap&lt;Long, OrderItemPriceDetailAdðŸ”µ</abbr>
<abbr title=" 441                 List&lt;OrderItemPriceDetailAdjustment&gt; adjustmentsToRemove = new ArrayList&lt;OrderItemPriceDetailAdjustment&gt;();"> 441                 List&lt;OrderItemPriceDetailAdjustment&gt; adjustmentsToRemove = new ArrayList&lt;OrderItemPriceDeðŸ”µ</abbr>
 442                 for (OrderItemPriceDetailAdjustment adj : pd.getOrderItemPriceDetailAdjustments()) {
 443                     if (adjs.containsKey(adj.getOffer().getId())) {
 444                         adjustmentsToRemove.add(adj);
 445                         if (LOG.isDebugEnabled()) {
 446                             StringBuilder sb = new StringBuilder(&quot;Detected collisions &quot;)
 447                                 .append(beforeSave ? &quot;before saving&quot; : &quot;after saving&quot;)
 448                                 .append(&quot; with ids &quot;)
 449                                 .append(adjs.get(adj.getOffer().getId()).getId())
 450                                 .append(&quot; and &quot;)
 451                                 .append(adj.getId());
 452                             LOG.debug(sb.toString());
 453                         }
 454                     } else {
 455                         adjs.put(adj.getOffer().getId(), adj);
 456                     }
 457                 }
 458                 
 459                 for (OrderItemPriceDetailAdjustment adj : adjustmentsToRemove) {
 460                     pd.getOrderItemPriceDetailAdjustments().remove(adj);
 461                     madeChange = true;
 462                 }
 463             }
 464         }
 465 
 466         return madeChange;
 467      }
 468 
 469     @Override
 470     @Transactional(&quot;blTransactionManager&quot;)
 471     @Deprecated
 472     public void applyOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricingException {
 473         applyAndSaveOffersToOrder(offers, order);
 474     }
 475 
 476     @Override
 477     @Transactional(&quot;blTransactionManager&quot;)
 478     @Deprecated
<abbr title=" 479     public void applyFulfillmentGroupOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricingException {"> 479     public void applyFulfillmentGroupOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricingExceptiðŸ”µ</abbr>
 480         applyAndSaveFulfillmentGroupOffersToOrder(offers, order);
 481     }
 482 
 483     @Override
 484     @Transactional(&quot;blTransactionManager&quot;)
<abbr title=" 485     public Order applyAndSaveFulfillmentGroupOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricingException {"> 485     public Order applyAndSaveFulfillmentGroupOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricinðŸ”µ</abbr>
 486         OfferContext offerContext = OfferContext.getOfferContext();
 487         if (offerContext == null || offerContext.executePromotionCalculation) {
 488             PromotableOrder promotableOrder =
 489                     promotableItemFactory.createPromotableOrder(order, true);
 490             List&lt;Offer&gt; possibleFGOffers = new ArrayList&lt;Offer&gt;();
 491             for (Offer offer : offers) {
 492                 if (offer.getType().getType().equals(OfferType.FULFILLMENT_GROUP.getType())) {
 493                     possibleFGOffers.add(offer);
 494                 }
 495             }
<abbr title=" 496             List&lt;Offer&gt; filteredOffers = orderOfferProcessor.filterOffers(possibleFGOffers, order.getCustomer());"> 496             List&lt;Offer&gt; filteredOffers = orderOfferProcessor.filterOffers(possibleFGOffers, order.getCustðŸ”µ</abbr>
<abbr title=" 497             List&lt;PromotableCandidateFulfillmentGroupOffer&gt; qualifiedFGOffers = new ArrayList&lt;PromotableCandidateFulfillmentGroupOffer&gt;();"> 497             List&lt;PromotableCandidateFulfillmentGroupOffer&gt; qualifiedFGOffers = new ArrayList&lt;PromotableCaðŸ”µ</abbr>
 498             for (Offer offer : filteredOffers) {
<abbr title=" 499                 fulfillmentGroupOfferProcessor.filterFulfillmentGroupLevelOffer(promotableOrder, qualifiedFGOffers, offer);"> 499                 fulfillmentGroupOfferProcessor.filterFulfillmentGroupLevelOffer(promotableOrder, qualifieðŸ”µ</abbr>
 500             }
 501             if (!qualifiedFGOffers.isEmpty()) {
<abbr title=" 502                 fulfillmentGroupOfferProcessor.applyAllFulfillmentGroupOffers(qualifiedFGOffers, promotableOrder);"> 502                 fulfillmentGroupOfferProcessor.applyAllFulfillmentGroupOffers(qualifiedFGOffers, promotabðŸ”µ</abbr>
 503                 fulfillmentGroupOfferProcessor.calculateFulfillmentGroupTotal(promotableOrder);
 504                 orderOfferProcessor.synchronizeAdjustmentsAndPrices(promotableOrder);
 505             }
 506 
 507             return orderService.save(order, false);
 508         }
 509         return order;
 510     }
 511 
 512     @Override
 513     public boolean verifyMaxCustomerUsageThreshold(Order order, Offer offer) {
 514 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 515         if (offer.isLimitedUsePerCustomer()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 516             CustomerMaxUsesStrategyType strategy = offer.getMaxUsesStrategyType();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 517             boolean checkUsingCustomer = (strategy == null || strategy.equals(CustomerMaxUsesStrategyType.CUSTOMER));"> 517             boolean checkUsingCustomer = (strategy == null || strategy.equals(CustomerMaxUsesStrategyTypeðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 518             Long currentUses;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 519             if (checkUsingCustomer) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 520                 currentUses = offerAuditService.countUsesByCustomer(order, order.getCustomer().getId(), offer.getId(), offer.getMinimumDaysPerUsage());"> 520                 currentUses = offerAuditService.countUsesByCustomer(order, order.getCustomer().getId(), oðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 521             } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 522                 currentUses = offerAuditService.countUsesByAccount(order, order.getBroadleafAccountId(), offer.getId(), offer.getMinimumDaysPerUsage());"> 522                 currentUses = offerAuditService.countUsesByAccount(order, order.getBroadleafAccountId(), ðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 523             }</span>
 524 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 525         Customer customer = order.getCustomer();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 526         </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 527         if (offer.isLimitedUsePerCustomer()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 528             Long currentUses = offerAuditService.countUsesByCustomer(order, customer.getId(), offer.getId());"> 528             Long currentUses = offerAuditService.countUsesByCustomer(order, customer.getId(), offer.getIdðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 529             </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 530             if (currentUses &gt;= offer.getMaxUsesPerCustomer()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 531                 return false;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 532             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 533         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 534         </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 535         return true;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 536     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 537     </span>
 538 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 539         Customer customer = order.getCustomer();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 540         </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 541         if (customer != null &amp;&amp; customer.isRegistered() &amp;&amp; offer.isLimitedUsePerCustomer()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 542             Long currentUses = offerAuditService.countUsesByCustomer(order, customer.getId(), offer.getId());"> 542             Long currentUses = offerAuditService.countUsesByCustomer(order, customer.getId(), offer.getIdðŸ”µ</abbr></span>
 543 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 544             
 545             if (currentUses &gt;= offer.getMaxUsesPerCustomer()) {
 546                 return false;
 547             }
 548         }
 549         
 550         return true;
 551     }
 552     
 553     @Deprecated
 554     @Override
 555     public boolean verifyMaxCustomerUsageThreshold(Customer customer, Offer offer) {
 556         if (offer.isLimitedUsePerCustomer()) {                
 557             Long currentUses = offerAuditService.countUsesByCustomer(customer.getId(), offer.getId());
 558             
 559             if (currentUses &gt;= offer.getMaxUsesPerCustomer()) {
 560                 return false;
 561             }
 562         }
 563         
 564         return true;
 565     }
 566 
 567     @Override
 568     public boolean verifyMaxCustomerUsageThreshold(Order order, OfferCode code) {
 569         boolean underCodeMaxUses = true;
 570         
 571         if (code.isLimitedUse()) {
 572             Long currentCodeUses = offerAuditService.countOfferCodeUses(order, code.getId());
 573             underCodeMaxUses = currentCodeUses &lt; code.getMaxUses();
 574         }
 575         
 576         return underCodeMaxUses &amp;&amp; verifyMaxCustomerUsageThreshold(order, code.getOffer());
 577     }
 578 
 579     @Deprecated
 580     @Override
 581     public boolean verifyMaxCustomerUsageThreshold(Customer customer, OfferCode code) {
 582         boolean underCodeMaxUses = true;
 583         if (code.isLimitedUse()) {
 584             Long currentCodeUses = offerAuditService.countOfferCodeUses(code.getId());
 585             underCodeMaxUses = currentCodeUses &lt; code.getMaxUses();
 586         }
 587         return underCodeMaxUses &amp;&amp; verifyMaxCustomerUsageThreshold(customer, code.getOffer());
 588     }
 589     
 590     @Override
 591     @SuppressWarnings(&quot;unchecked&quot;)
 592     public Set&lt;Offer&gt; getUniqueOffersFromOrder(Order order) {
 593         HashSet&lt;Offer&gt; result = new HashSet&lt;Offer&gt;();
 594         
 595         Transformer adjustmentToOfferTransformer = new Transformer() {
 596             
 597             @Override
 598             public Object transform(Object input) {
 599                 return ((Adjustment)input).getOffer();
 600             }
 601         };
 602         
<abbr title=" 603         result.addAll(CollectionUtils.collect(order.getOrderAdjustments(), adjustmentToOfferTransformer));"> 603         result.addAll(CollectionUtils.collect(order.getOrderAdjustments(), adjustmentToOfferTransformer))ðŸ”µ</abbr>
 604 
 605         if (order.getOrderItems() != null) {
 606             for (OrderItem item : order.getOrderItems()) {
<abbr title=" 607                 result.addAll(CollectionUtils.collect(item.getOrderItemAdjustments(), adjustmentToOfferTransformer));"> 607                 result.addAll(CollectionUtils.collect(item.getOrderItemAdjustments(), adjustmentToOfferTrðŸ”µ</abbr>
 608                 
 609                 //record usage for price details on the item as well
 610                 if (item.getOrderItemPriceDetails() != null) {
 611                     for (OrderItemPriceDetail detail : item.getOrderItemPriceDetails()) {
<abbr title=" 612                         result.addAll(CollectionUtils.collect(detail.getOrderItemPriceDetailAdjustments(), adjustmentToOfferTransformer));"> 612                         result.addAll(CollectionUtils.collect(detail.getOrderItemPriceDetailAdjustments()ðŸ”µ</abbr>
 613                     }
 614                 }
 615             }
 616         }
 617 
 618         if (order.getFulfillmentGroups() != null) {
 619             for (FulfillmentGroup fg : order.getFulfillmentGroups()) {
<abbr title=" 620                 result.addAll(CollectionUtils.collect(fg.getFulfillmentGroupAdjustments(), adjustmentToOfferTransformer));"> 620                 result.addAll(CollectionUtils.collect(fg.getFulfillmentGroupAdjustments(), adjustmentToOfðŸ”µ</abbr>
 621             }
 622         }
 623         return result;
 624     }
 625     
 626     @Override
 627     public Map&lt;Offer, OfferCode&gt; getOffersRetrievedFromCodes(Order order)  {
 628         return getOffersRetrievedFromCodes(order.getAddedOfferCodes(), getUniqueOffersFromOrder(order));
 629     }
 630     
 631     @Override
<abbr title=" 632     public Map&lt;Offer, OfferCode&gt; getOffersRetrievedFromCodes(List&lt;OfferCode&gt; codes, Set&lt;Offer&gt; appliedOffers) {"> 632     public Map&lt;Offer, OfferCode&gt; getOffersRetrievedFromCodes(List&lt;OfferCode&gt; codes, Set&lt;Offer&gt; appliedOffðŸ”µ</abbr>
 633         HashMap&lt;Offer, OfferCode&gt; offerToCodeMapping = new HashMap&lt;Offer, OfferCode&gt;();
 634         for (OfferCode code : codes) {
 635             if (appliedOffers.contains(code.getOffer())) {
 636                 offerToCodeMapping.put(code.getOffer(), code);
 637             }
 638 
 639             List&lt;Offer&gt; additionalOffersToBeApplied = new ArrayList&lt;Offer&gt;();
 640 
 641             extensionManager.getProxy().addAdditionalOffersForCode(additionalOffersToBeApplied, code);
 642             for (Offer additionalOfferToBeApplied : additionalOffersToBeApplied) {
 643                 offerToCodeMapping.put(additionalOfferToBeApplied, code);
 644             }
 645         }
 646         return offerToCodeMapping;
 647     }
 648     
 649     @Override
 650     @Transactional(&quot;blTransactionManager&quot;)
 651     public Boolean deleteOfferCode(OfferCode code) {
 652         if (offerCodeDao.offerCodeIsUsed(code)) {
 653             return false;
 654         }
 655 
 656         offerCodeDao.delete(code);
 657         return true;
 658     }
 659 
 660     @Transactional(&quot;blTransactionManager&quot;)
 661     @Override
 662     public Offer duplicate(Long originalOfferId) {
 663         return duplicator.copy(OfferImpl.class, originalOfferId);
 664     }
 665 
 666     @Override
 667     public CustomerOfferDao getCustomerOfferDao() {
 668         return customerOfferDao;
 669     }
 670 
 671     @Override
 672     public void setCustomerOfferDao(CustomerOfferDao customerOfferDao) {
 673         this.customerOfferDao = customerOfferDao;
 674     }
 675 
 676     @Override
 677     public OfferCodeDao getOfferCodeDao() {
 678         return offerCodeDao;
 679     }
 680 
 681     @Override
 682     public void setOfferCodeDao(OfferCodeDao offerCodeDao) {
 683         this.offerCodeDao = offerCodeDao;
 684     }
 685 
 686     @Override
 687     public OfferDao getOfferDao() {
 688         return offerDao;
 689     }
 690 
 691     @Override
 692     public void setOfferDao(OfferDao offerDao) {
 693         this.offerDao = offerDao;
 694     }
 695 
 696     @Override
 697     public OrderOfferProcessor getOrderOfferProcessor() {
 698         return orderOfferProcessor;
 699     }
 700 
 701     @Override
 702     public void setOrderOfferProcessor(OrderOfferProcessor orderOfferProcessor) {
 703         this.orderOfferProcessor = orderOfferProcessor;
 704     }
 705 
 706     @Override
 707     public ItemOfferProcessor getItemOfferProcessor() {
 708         return itemOfferProcessor;
 709     }
 710 
 711     @Override
 712     public void setItemOfferProcessor(ItemOfferProcessor itemOfferProcessor) {
 713         this.itemOfferProcessor = itemOfferProcessor;
 714     }
 715 
 716     @Override
 717     public FulfillmentGroupOfferProcessor getFulfillmentGroupOfferProcessor() {
 718         return fulfillmentGroupOfferProcessor;
 719     }
 720 
 721     @Override
<abbr title=" 722     public void setFulfillmentGroupOfferProcessor(FulfillmentGroupOfferProcessor fulfillmentGroupOfferProcessor) {"> 722     public void setFulfillmentGroupOfferProcessor(FulfillmentGroupOfferProcessor fulfillmentGroupOfferProðŸ”µ</abbr>
 723         this.fulfillmentGroupOfferProcessor = fulfillmentGroupOfferProcessor;
 724     }
 725 
 726     @Override
 727     public PromotableItemFactory getPromotableItemFactory() {
 728         return promotableItemFactory;
 729     }
 730 
 731     @Override
 732     public void setPromotableItemFactory(PromotableItemFactory promotableItemFactory) {
 733         this.promotableItemFactory = promotableItemFactory;
 734     }
 735 
 736     @Override
 737     public OfferCode findOfferCodeById(Long id) {
 738         return offerCodeDao.readOfferCodeById(id);
 739     }
 740 
 741     @Override
 742     public List&lt;OfferCode&gt; findOfferCodesByIds(Collection&lt;Long&gt; ids) {
 743         return offerCodeDao.readOfferCodesByIds(ids);
 744     }
 745 
 746     @Override
 747     public OrderService getOrderService() {
 748         return orderService;
 749     }
 750 
 751     @Override
 752     public void setOrderService(OrderService orderService) {
 753         this.orderService = orderService;
 754     }
 755 
 756     @Override
 757     public Offer findOfferById(Long offerId) {
 758         return offerDao.readOfferById(offerId);
 759     }
 760 }</pre></td>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Framework
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  *
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.core.offer.service;
  19 
  20 import org.apache.commons.collections.CollectionUtils;
  21 import org.apache.commons.collections.Transformer;
  22 import org.apache.commons.logging.Log;
  23 import org.apache.commons.logging.LogFactory;
  24 import org.broadleafcommerce.common.persistence.EntityDuplicateModifier;
  25 import org.broadleafcommerce.common.persistence.EntityDuplicator;
  26 import org.broadleafcommerce.common.sandbox.SandBoxHelper;
  27 import org.broadleafcommerce.common.util.StreamCapableTransactionalOperationAdapter;
  28 import org.broadleafcommerce.common.util.StreamingTransactionCapableUtil;
  29 import org.broadleafcommerce.core.offer.dao.CustomerOfferDao;
  30 import org.broadleafcommerce.core.offer.dao.OfferCodeDao;
  31 import org.broadleafcommerce.core.offer.dao.OfferDao;
  32 import org.broadleafcommerce.core.offer.domain.Adjustment;
  33 import org.broadleafcommerce.core.offer.domain.CustomerOffer;
  34 import org.broadleafcommerce.core.offer.domain.Offer;
  35 import org.broadleafcommerce.core.offer.domain.OfferCode;
  36 import org.broadleafcommerce.core.offer.domain.OfferImpl;
  37 import org.broadleafcommerce.core.offer.domain.OrderItemPriceDetailAdjustment;
  38 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableCandidateFulfillmentGroupOffer;
  39 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableCandidateItemOffer;
  40 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableCandidateOrderOffer;
  41 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableItemFactory;
  42 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrder;
  43 import org.broadleafcommerce.core.offer.service.processor.FulfillmentGroupOfferProcessor;
  44 import org.broadleafcommerce.core.offer.service.processor.ItemOfferProcessor;
  45 import org.broadleafcommerce.core.offer.service.processor.OrderOfferProcessor;
  46 import org.broadleafcommerce.core.offer.service.type.CustomerMaxUsesStrategyType;
  47 import org.broadleafcommerce.core.offer.service.type.OfferType;
  48 import org.broadleafcommerce.core.order.domain.FulfillmentGroup;
  49 import org.broadleafcommerce.core.order.domain.Order;
  50 import org.broadleafcommerce.core.order.domain.OrderItem;
  51 import org.broadleafcommerce.core.order.domain.OrderItemPriceDetail;
  52 import org.broadleafcommerce.core.order.service.OrderService;
  53 import org.broadleafcommerce.core.pricing.service.exception.PricingException;
  54 import org.broadleafcommerce.profile.core.domain.Customer;
  55 import org.springframework.stereotype.Service;
  56 import org.springframework.transaction.annotation.Transactional;
  57 
  58 import java.util.ArrayList;
  59 import java.util.Collection;
  60 import java.util.HashMap;
  61 import java.util.HashSet;
  62 import java.util.Iterator;
  63 import java.util.List;
  64 import java.util.Map;
  65 import java.util.Objects;
  66 import java.util.Set;
  67 
  68 import javax.annotation.Resource;
  69 import javax.persistence.EntityManager;
  70 import javax.persistence.PersistenceContext;
  71 
  72 /**
  73  * The Class OfferServiceImpl.
  74  */
  75 @Service(&quot;blOfferService&quot;)
  76 public class OfferServiceImpl implements OfferService {
  77 
  78     private static final Log LOG = LogFactory.getLog(OfferServiceImpl.class);
  79 
  80     // should be called outside of Offer service after Offer service is executed
  81     @Resource(name=&quot;blCustomerOfferDao&quot;)
  82     protected CustomerOfferDao customerOfferDao;
  83 
  84     @Resource(name=&quot;blOfferCodeDao&quot;)
  85     protected OfferCodeDao offerCodeDao;
  86 
  87     @Resource(name=&quot;blOfferAuditService&quot;)
  88     protected OfferAuditService offerAuditService;
  89 
  90     @Resource(name=&quot;blOfferDao&quot;)
  91     protected OfferDao offerDao;
  92 
  93     @Resource(name=&quot;blOrderOfferProcessor&quot;)
  94     protected OrderOfferProcessor orderOfferProcessor;
  95 
  96     @Resource(name=&quot;blItemOfferProcessor&quot;)
  97     protected ItemOfferProcessor itemOfferProcessor;
  98 
  99     @Resource(name=&quot;blFulfillmentGroupOfferProcessor&quot;)
 100     protected FulfillmentGroupOfferProcessor fulfillmentGroupOfferProcessor;
 101 
 102     @Resource(name=&quot;blPromotableItemFactory&quot;)
 103     protected PromotableItemFactory promotableItemFactory;
 104 
 105     @Resource(name = &quot;blOfferServiceExtensionManager&quot;)
 106     protected OfferServiceExtensionManager extensionManager;
 107 
 108     @Resource(name = &quot;blOrderService&quot;)
 109     protected OrderService orderService;
 110 
 111     @Resource(name = &quot;blSandBoxHelper&quot;)
 112     protected SandBoxHelper sandBoxHelper;
 113 
 114     @PersistenceContext(unitName=&quot;blPU&quot;)
 115     protected EntityManager em;
 116 
 117     @Resource(name=&quot;blStreamingTransactionCapableUtil&quot;)
 118     protected StreamingTransactionCapableUtil transUtil;
 119 
 120     @Resource(name=&quot;blEntityDuplicator&quot;)
 121     protected EntityDuplicator duplicator;
 122 
 123     /**
 124      * @deprecated Add {@link EntityDuplicateModifier}s to {@code blEntityDuplicationHelpers}
 125      */
 126     @Deprecated
 127     protected EntityDuplicateModifier&lt;Offer&gt; offerDuplicateModifier;
 128 
 129     @Override
 130     public List&lt;Offer&gt; findAllOffers() {
 131         return offerDao.readAllOffers();
 132     }
 133 
 134     @Override
 135     @Transactional(&quot;blTransactionManager&quot;)
 136     public Offer save(Offer offer) {
 137         return offerDao.save(offer);
 138     }
 139 
 140     @Override
 141     @Transactional(&quot;blTransactionManager&quot;)
 142     public OfferCode saveOfferCode(OfferCode offerCode) {
 143         offerCode.setOffer(offerDao.save(offerCode.getOffer()));
 144         return offerCodeDao.save(offerCode);
 145     }
 146 
 147     /**
<abbr title=" 148      * Creates a list of offers that applies to this order.  All offers that are assigned to the customer,"> 148      * Creates a list of offers that applies to this order.  All offers that are assigned to the customerðŸ”µ</abbr>
<abbr title=" 149      * entered during checkout, or has a delivery type of automatic are added to the list.  The same offer"> 149      * entered during checkout, or has a delivery type of automatic are added to the list.  The same offeðŸ”µ</abbr>
 150      * cannot appear more than once in the list.
 151      *
 152      * @param code
 153      * @return a List of offers that may apply to this order
 154      */
 155     @Override
 156     public Offer lookupOfferByCode(String code) {
 157         Offer offer = null;
 158         OfferCode offerCode = offerCodeDao.readOfferCodeByCode(code);
 159         if (offerCode != null) {
 160             offer = offerCode.getOffer();
 161         }
 162         return offer;
 163     }
 164 
 165     @Override
 166     public OfferCode lookupOfferCodeByCode(String code){
 167         return offerCodeDao.readOfferCodeByCode(code);
 168     }
 169 
 170     @Override
 171     public List&lt;Offer&gt; lookupAllOffersByCode(String code) {
 172         List&lt;Offer&gt; offers = new ArrayList&lt;Offer&gt;();
 173         List&lt;OfferCode&gt; offerCodes = offerCodeDao.readAllOfferCodesByCode(code);
 174         for (OfferCode offerCode : offerCodes) {
 175             if (offerCode != null) {
 176                 offers.add(offerCode.getOffer());
 177             }
 178         }
 179         return offers;
 180     }
 181 
 182     @Override
 183     public List&lt;OfferCode&gt; lookupAllOfferCodesByCode(String code){
 184         return offerCodeDao.readAllOfferCodesByCode(code);
 185     }
 186 
 187     /**
<abbr title=" 188      * Creates a list of offers that applies to this order.  All offers that are assigned to the customer,"> 188      * Creates a list of offers that applies to this order.  All offers that are assigned to the customerðŸ”µ</abbr>
<abbr title=" 189      * entered during checkout, or has a delivery type of automatic are added to the list.  The same offer"> 189      * entered during checkout, or has a delivery type of automatic are added to the list.  The same offeðŸ”µ</abbr>
 190      * cannot appear more than once in the list.
 191      *
 192      * @param order
 193      * @return a List of offers that may apply to this order
 194      */
 195     @Override
 196     public List&lt;Offer&gt; buildOfferListForOrder(Order order) {
 197         List&lt;Offer&gt; offers = new ArrayList&lt;Offer&gt;();
 198         List&lt;CustomerOffer&gt; customerOffers = lookupOfferCustomerByCustomer(order.getCustomer());
 199         for (CustomerOffer customerOffer : customerOffers) {
 200             if (!offers.contains(customerOffer.getOffer())) {
 201                 offers.add(customerOffer.getOffer());
 202             }
 203         }
 204         List&lt;OfferCode&gt; orderOfferCodes = refreshOfferCodesIfApplicable(order);
 205         orderOfferCodes = removeOutOfDateOfferCodes(orderOfferCodes);
 206         for (OfferCode orderOfferCode : orderOfferCodes) {
 207             if (!offers.contains(orderOfferCode.getOffer())) {
 208                 offers.add(orderOfferCode.getOffer());
 209             }
 210             extensionManager.getProxy().addAdditionalOffersForCode(offers, orderOfferCode);
 211         }
 212         List&lt;Offer&gt; globalOffers = lookupAutomaticDeliveryOffers();
 213         for (Offer globalOffer : globalOffers) {
 214             if (!offers.contains(globalOffer) &amp;&amp; verifyMaxCustomerUsageThreshold(order, globalOffer)) {
 215                 offers.add(globalOffer);
 216             }
 217         }
 218 
 219         if (extensionManager != null) {
 220             extensionManager.applyAdditionalFilters(offers, order);
 221         }
 222 
 223         return offers;
 224     }
 225 
 226     @Override
 227     public List&lt;OfferCode&gt; buildOfferCodeListForCustomer(Order order) {
 228         Customer customer = order.getCustomer();
 229         ArrayList&lt;OfferCode&gt; offerCodes = new ArrayList&lt;&gt;();
 230 
 231         if (extensionManager != null) {
 232             extensionManager.buildOfferCodeListForCustomer(customer, offerCodes);
 233         }
 234         if (!offerCodes.isEmpty()) {
 235             Iterator&lt;OfferCode&gt; itr = offerCodes.iterator();
 236             while (itr.hasNext()) {
 237                 OfferCode offerCode = itr.next();
 238                 if (!offerCode.isActive() || !verifyMaxCustomerUsageThreshold(order, offerCode)) {
 239                     itr.remove();
 240                 }
 241             }
 242         }
 243         return offerCodes;
 244     }
 245 
 246     @Deprecated
 247     @Override
 248     public List&lt;OfferCode&gt; buildOfferCodeListForCustomer(Customer customer) {
 249         ArrayList&lt;OfferCode&gt; offerCodes = new ArrayList&lt;OfferCode&gt;();
 250         if (extensionManager != null) {
 251             extensionManager.buildOfferCodeListForCustomer(customer, offerCodes);
 252         }
 253         if (!offerCodes.isEmpty()) {
 254             Iterator&lt;OfferCode&gt; itr = offerCodes.iterator();
 255             while (itr.hasNext()) {
 256                 OfferCode offerCode = itr.next();
 257                 if (!offerCode.isActive() || !verifyMaxCustomerUsageThreshold(customer, offerCode)) {
 258                     itr.remove();
 259                 }
 260             }
 261         }
 262         return offerCodes;
 263     }
 264 
 265     /**
 266      * Private method used to retrieve all offers assigned to this customer.  These offers are
 267      * programmatically assigned to the customer.
 268      *
 269      * @param customer
 270      * @return a List of offers assigned to the customer
 271      */
 272     protected List&lt;CustomerOffer&gt; lookupOfferCustomerByCustomer(Customer customer) {
 273         List&lt;CustomerOffer&gt; offerCustomers = customerOfferDao.readCustomerOffersByCustomer(customer);
 274         return offerCustomers;
 275     }
 276 
 277     /**
 278      * Private method used to retrieve all offers with automaticallyAdded set to true
 279      *
 280      * @return a List of automatic delivery offers
 281      */
 282     protected List&lt;Offer&gt; lookupAutomaticDeliveryOffers() {
 283         List&lt;Offer&gt; globalOffers = offerDao.readOffersByAutomaticDeliveryType();
 284         return globalOffers;
 285     }
 286 
 287     /**
 288      * Removes all out of date offerCodes based on the offerCode and its offer&#x27;s start and end
 289      * date.  If an offerCode has a later start date, that offerCode will be removed.
 290      * OfferCodes without a start date will still be processed. If the offerCode
 291      * has a end date that has already passed, that offerCode will be removed.  OfferCodes
 292      * without a end date will be processed.  The start and end dates on the offer will
 293      * still need to be evaluated.
 294      *
 295      * @param offerCodes
 296      * @return a List of non-expired offers
 297      */
 298     protected List&lt;OfferCode&gt; removeOutOfDateOfferCodes(List&lt;OfferCode&gt; offerCodes){
 299         List&lt;OfferCode&gt; offerCodesToRemove = new ArrayList&lt;OfferCode&gt;();
 300         for (OfferCode offerCode : offerCodes) {
 301             if (!offerCode.isActive()){
 302                 offerCodesToRemove.add(offerCode);
 303             }
 304         }
 305         // remove all offers in the offersToRemove list from original offers list
 306         for (OfferCode offerCode : offerCodesToRemove) {
 307             offerCodes.remove(offerCode);
 308         }
 309         return offerCodes;
 310     }
 311 
 312     /**
 313      * For enterprise installations, this will refresh any OfferCodes found to be out-of-date with
 314      * current sandbox status.
 315      *
 316      * @param order the order to check
 317      * @return the refreshed list of OfferCodes
 318      */
 319     protected List&lt;OfferCode&gt; refreshOfferCodesIfApplicable(final Order order) {
 320         final List&lt;OfferCode&gt; orderOfferCodes = order.getAddedOfferCodes();
 321 
 322         transUtil.runTransactionalOperation(new StreamCapableTransactionalOperationAdapter() {
 323             @Override
 324             public void execute() {
 325                 for (OfferCode offerCode : orderOfferCodes) {
 326                     if (offerCode.getOffer() != null) {
<abbr title=" 327                         Long sandBoxVersionId = sandBoxHelper.getSandBoxVersionId(OfferImpl.class, offerCode.getOffer().getId());"> 327                         Long sandBoxVersionId = sandBoxHelper.getSandBoxVersionId(OfferImpl.class, offerCðŸ”µ</abbr>
<abbr title=" 328                         if (sandBoxVersionId != null &amp;&amp; !Objects.equals(sandBoxVersionId, offerCode.getOffer().getId())) {"> 328                         if (sandBoxVersionId != null &amp;&amp; !Objects.equals(sandBoxVersionId, offerCode.getOfðŸ”µ</abbr>
 329                             em.refresh(offerCode);
 330                         }
 331                     }
 332                 }
 333             }
 334 
 335             @Override
 336             public boolean shouldRetryOnTransactionLockAcquisitionFailure() {
 337                 return true;
 338             }
 339         }, RuntimeException.class);
 340 
 341         return orderOfferCodes;
 342     }
 343 
 344     /*
 345      *
 346      * Offers Logic:
 347      * 1) Remove all existing offers in the Order (order, item, and fulfillment)
 348      * 2) Check and remove offers
 349      *    a) Remove out of date offers
 350      *    b) Remove offers that do not apply to this customer
 351      * 3) Loop through offers
 352      *    a) Verifies type of offer (order, order item, fulfillment)
 353      *    b) Verifies if offer can be applies
 354      *    c) Assign offer to type (order, order item, or fulfillment)
 355      * 4) Sorts the order and item offers list by priority and then discount
 356      * 5) Identify the best offers to apply to order item and create adjustments for each item offer
<abbr title=" 357      * 6) Compare order item adjustment price to sales price, and remove adjustments if sale price is better"> 357      * 6) Compare order item adjustment price to sales price, and remove adjustments if sale price is betðŸ”µ</abbr>
 358      * 7) Identify the best offers to apply to the order and create adjustments for each order offer
<abbr title=" 359      * 8) If item contains non-combinable offers remove either the item or order adjustments based on discount value"> 359      * 8) If item contains non-combinable offers remove either the item or order adjustments based on disðŸ”µ</abbr>
 360      * 9) Set final order item prices and reapply order offers
 361      *
 362      * Assumptions:
 363      * 1) % off all items will be created as an item offer with no expression
 364      * 2) $ off order will be created as an order offer
 365      * 3) Order offers applies to the best price for each item (not just retail price)
 366      * 4) Fulfillment offers apply to best price for each item (not just retail price)
<abbr title=" 367      * 5) Stackable only applies to the same offer type (i.e. a not stackable order offer can be used with item offers)"> 367      * 5) Stackable only applies to the same offer type (i.e. a not stackable order offer can be used witðŸ”µ</abbr>
 368      * 6) Fulfillment offers cannot be not combinable
 369      * 7) Order offers cannot be FIXED_PRICE
 370      * 8) FIXED_PRICE offers cannot be stackable
<abbr title=" 371      * 9) Non-combinable offers only apply to the order and order items, fulfillment group offers will always apply"> 371      * 9) Non-combinable offers only apply to the order and order items, fulfillment group offers will alðŸ”µ</abbr>
 372      *
 373      */
 374     @Override
 375     @Transactional(&quot;blTransactionManager&quot;)
 376     public Order applyAndSaveOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricingException {
 377         /*
 378         TODO rather than a threadlocal, we should update the &quot;shouldPrice&quot; boolean on the service API to
 379         use a richer object to describe the parameters of the pricing call. This object would include
 380         the pricing boolean, but would also include a list of activities to include or exclude in the
 381         call - see http://jira.broadleafcommerce.org/browse/BLC-664
 382          */
 383         OfferContext offerContext = OfferContext.getOfferContext();
 384         if (offerContext == null || offerContext.executePromotionCalculation) {
 385             PromotableOrder promotableOrder = promotableItemFactory.createPromotableOrder(order, false);
 386             List&lt;Offer&gt; filteredOffers = orderOfferProcessor.filterOffers(offers, order.getCustomer());
 387             if ((filteredOffers == null) || (filteredOffers.isEmpty())) {
 388                 if (LOG.isTraceEnabled()) {
 389                     LOG.trace(&quot;No offers applicable to this order.&quot;);
 390                 }
 391             } else {
<abbr title=" 392                 List&lt;PromotableCandidateOrderOffer&gt; qualifiedOrderOffers = new ArrayList&lt;PromotableCandidateOrderOffer&gt;();"> 392                 List&lt;PromotableCandidateOrderOffer&gt; qualifiedOrderOffers = new ArrayList&lt;PromotableCandidðŸ”µ</abbr>
<abbr title=" 393                 List&lt;PromotableCandidateItemOffer&gt; qualifiedItemOffers = new ArrayList&lt;PromotableCandidateItemOffer&gt;();"> 393                 List&lt;PromotableCandidateItemOffer&gt; qualifiedItemOffers = new ArrayList&lt;PromotableCandidatðŸ”µ</abbr>
 394 
<abbr title=" 395                 itemOfferProcessor.filterOffers(promotableOrder, filteredOffers, qualifiedOrderOffers, qualifiedItemOffers);"> 395                 itemOfferProcessor.filterOffers(promotableOrder, filteredOffers, qualifiedOrderOffers, quðŸ”µ</abbr>
 396 
 397                 if (! (qualifiedItemOffers.isEmpty() &amp;&amp; qualifiedOrderOffers.isEmpty())) {
<abbr title=" 398                     // At this point, we should have a PromotableOrder that contains PromotableItems each of which"> 398                     // At this point, we should have a PromotableOrder that contains PromotableItems eachðŸ”µ</abbr>
 399                     // has a list of candidatePromotions that might be applied.
 400 
<abbr title=" 401                     // We also have a list of orderOffers that might apply and a list of itemOffers that might apply."> 401                     // We also have a list of orderOffers that might apply and a list of itemOffers that ðŸ”µ</abbr>
<abbr title=" 402                     itemOfferProcessor.applyAndCompareOrderAndItemOffers(promotableOrder, qualifiedOrderOffers, qualifiedItemOffers);"> 402                     itemOfferProcessor.applyAndCompareOrderAndItemOffers(promotableOrder, qualifiedOrderOðŸ”µ</abbr>
 403                 }
 404             }
 405             orderOfferProcessor.synchronizeAdjustmentsAndPrices(promotableOrder);
 406 
 407             verifyAdjustments(order, true);
 408 
 409             order.setSubTotal(order.calculateSubTotal());
 410             order.finalizeItemPrices();
 411 
 412             order = orderService.save(order, false);
 413 
 414             boolean madeChange = verifyAdjustments(order, false);
 415             if (madeChange) {
 416                 order = orderService.save(order, false);
 417             }
 418         }
 419 
 420         return order;
 421     }
 422 
 423     protected boolean verifyAdjustments(Order order, boolean beforeSave) {
 424         boolean madeChange = false;
 425 
 426         if (order.getOrderItems() == null) {
 427             return madeChange;
 428         }
 429 
 430         for (OrderItem oi : order.getOrderItems()) {
 431             if (oi.getOrderItemPriceDetails() == null) {
 432                 continue;
 433             }
 434 
 435             for (OrderItemPriceDetail pd : oi.getOrderItemPriceDetails()) {
 436                 if (pd.getOrderItemPriceDetailAdjustments() == null) {
 437                     continue;
 438                 }
 439 
<abbr title=" 440                 Map&lt;Long, OrderItemPriceDetailAdjustment&gt; adjs = new HashMap&lt;Long, OrderItemPriceDetailAdjustment&gt;();"> 440                 Map&lt;Long, OrderItemPriceDetailAdjustment&gt; adjs = new HashMap&lt;Long, OrderItemPriceDetailAdðŸ”µ</abbr>
<abbr title=" 441                 List&lt;OrderItemPriceDetailAdjustment&gt; adjustmentsToRemove = new ArrayList&lt;OrderItemPriceDetailAdjustment&gt;();"> 441                 List&lt;OrderItemPriceDetailAdjustment&gt; adjustmentsToRemove = new ArrayList&lt;OrderItemPriceDeðŸ”µ</abbr>
 442                 for (OrderItemPriceDetailAdjustment adj : pd.getOrderItemPriceDetailAdjustments()) {
 443                     if (adjs.containsKey(adj.getOffer().getId())) {
 444                         adjustmentsToRemove.add(adj);
 445                         if (LOG.isDebugEnabled()) {
 446                             StringBuilder sb = new StringBuilder(&quot;Detected collisions &quot;)
 447                                 .append(beforeSave ? &quot;before saving&quot; : &quot;after saving&quot;)
 448                                 .append(&quot; with ids &quot;)
 449                                 .append(adjs.get(adj.getOffer().getId()).getId())
 450                                 .append(&quot; and &quot;)
 451                                 .append(adj.getId());
 452                             LOG.debug(sb.toString());
 453                         }
 454                     } else {
 455                         adjs.put(adj.getOffer().getId(), adj);
 456                     }
 457                 }
 458 
 459                 for (OrderItemPriceDetailAdjustment adj : adjustmentsToRemove) {
 460                     pd.getOrderItemPriceDetailAdjustments().remove(adj);
 461                     madeChange = true;
 462                 }
 463             }
 464         }
 465 
 466         return madeChange;
 467      }
 468 
 469     @Override
 470     @Transactional(&quot;blTransactionManager&quot;)
 471     @Deprecated
 472     public void applyOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricingException {
 473         applyAndSaveOffersToOrder(offers, order);
 474     }
 475 
 476     @Override
 477     @Transactional(&quot;blTransactionManager&quot;)
 478     @Deprecated
<abbr title=" 479     public void applyFulfillmentGroupOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricingException {"> 479     public void applyFulfillmentGroupOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricingExceptiðŸ”µ</abbr>
 480         applyAndSaveFulfillmentGroupOffersToOrder(offers, order);
 481     }
 482 
 483     @Override
 484     @Transactional(&quot;blTransactionManager&quot;)
<abbr title=" 485     public Order applyAndSaveFulfillmentGroupOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricingException {"> 485     public Order applyAndSaveFulfillmentGroupOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricinðŸ”µ</abbr>
 486         OfferContext offerContext = OfferContext.getOfferContext();
 487         if (offerContext == null || offerContext.executePromotionCalculation) {
 488             PromotableOrder promotableOrder =
 489                     promotableItemFactory.createPromotableOrder(order, true);
 490             List&lt;Offer&gt; possibleFGOffers = new ArrayList&lt;Offer&gt;();
 491             for (Offer offer : offers) {
 492                 if (offer.getType().getType().equals(OfferType.FULFILLMENT_GROUP.getType())) {
 493                     possibleFGOffers.add(offer);
 494                 }
 495             }
<abbr title=" 496             List&lt;Offer&gt; filteredOffers = orderOfferProcessor.filterOffers(possibleFGOffers, order.getCustomer());"> 496             List&lt;Offer&gt; filteredOffers = orderOfferProcessor.filterOffers(possibleFGOffers, order.getCustðŸ”µ</abbr>
<abbr title=" 497             List&lt;PromotableCandidateFulfillmentGroupOffer&gt; qualifiedFGOffers = new ArrayList&lt;PromotableCandidateFulfillmentGroupOffer&gt;();"> 497             List&lt;PromotableCandidateFulfillmentGroupOffer&gt; qualifiedFGOffers = new ArrayList&lt;PromotableCaðŸ”µ</abbr>
 498             for (Offer offer : filteredOffers) {
<abbr title=" 499                 fulfillmentGroupOfferProcessor.filterFulfillmentGroupLevelOffer(promotableOrder, qualifiedFGOffers, offer);"> 499                 fulfillmentGroupOfferProcessor.filterFulfillmentGroupLevelOffer(promotableOrder, qualifieðŸ”µ</abbr>
 500             }
 501             if (!qualifiedFGOffers.isEmpty()) {
<abbr title=" 502                 fulfillmentGroupOfferProcessor.applyAllFulfillmentGroupOffers(qualifiedFGOffers, promotableOrder);"> 502                 fulfillmentGroupOfferProcessor.applyAllFulfillmentGroupOffers(qualifiedFGOffers, promotabðŸ”µ</abbr>
 503                 fulfillmentGroupOfferProcessor.calculateFulfillmentGroupTotal(promotableOrder);
 504                 orderOfferProcessor.synchronizeAdjustmentsAndPrices(promotableOrder);
 505             }
 506 
 507             return orderService.save(order, false);
 508         }
 509         return order;
 510     }
 511 
 512     @Override
 513     public boolean verifyMaxCustomerUsageThreshold(Order order, Offer offer) {
 514 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 515         if (offer.isLimitedUsePerCustomer()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 516             CustomerMaxUsesStrategyType strategy = offer.getMaxUsesStrategyType();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 517             boolean checkUsingCustomer = (strategy == null || strategy.equals(CustomerMaxUsesStrategyType.CUSTOMER));"> 517             boolean checkUsingCustomer = (strategy == null || strategy.equals(CustomerMaxUsesStrategyTypeðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 518             Long currentUses;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 519             if (checkUsingCustomer) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 520                 currentUses = offerAuditService.countUsesByCustomer(order, order.getCustomer().getId(), offer.getId(), offer.getMinimumDaysPerUsage());"> 520                 currentUses = offerAuditService.countUsesByCustomer(order, order.getCustomer().getId(), oðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 521             } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 522                 currentUses = offerAuditService.countUsesByAccount(order, order.getBroadleafAccountId(), offer.getId(), offer.getMinimumDaysPerUsage());"> 522                 currentUses = offerAuditService.countUsesByAccount(order, order.getBroadleafAccountId(), ðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 523             }</span>
 524 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 525         Customer customer = order.getCustomer();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 526 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 527         if (offer.isLimitedUsePerCustomer()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 528             Long currentUses = offerAuditService.countUsesByCustomer(order, customer.getId(), offer.getId());"> 528             Long currentUses = offerAuditService.countUsesByCustomer(order, customer.getId(), offer.getIdðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 529 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 530             if (currentUses &gt;= offer.getMaxUsesPerCustomer()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 531                 return false;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 532             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 533         }</span>
 534 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 535         Customer customer = order.getCustomer();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 536 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 537         if (customer != null &amp;&amp; customer.isRegistered() &amp;&amp; offer.isLimitedUsePerCustomer()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 538             Long currentUses = offerAuditService.countUsesByCustomer(order, customer.getId(), offer.getId());"> 538             Long currentUses = offerAuditService.countUsesByCustomer(order, customer.getId(), offer.getIdðŸ”µ</abbr></span>
 539 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 540 
 541             if (currentUses &gt;= offer.getMaxUsesPerCustomer()) {
 542                 return false;
 543             }
 544         }
 545 
 546         return true;
 547     }
 548 
 549     @Deprecated
 550     @Override
 551     public boolean verifyMaxCustomerUsageThreshold(Customer customer, Offer offer) {
 552         if (offer.isLimitedUsePerCustomer()) {
 553             Long currentUses = offerAuditService.countUsesByCustomer(customer.getId(), offer.getId());
 554 
 555             if (currentUses &gt;= offer.getMaxUsesPerCustomer()) {
 556                 return false;
 557             }
 558         }
 559 
 560         return true;
 561     }
 562 
 563     @Override
 564     public boolean verifyMaxCustomerUsageThreshold(Order order, OfferCode code) {
 565         boolean underCodeMaxUses = true;
 566 
 567         if (code.isLimitedUse()) {
 568             Long currentCodeUses = offerAuditService.countOfferCodeUses(order, code.getId());
 569             underCodeMaxUses = currentCodeUses &lt; code.getMaxUses();
 570         }
 571 
 572         return underCodeMaxUses &amp;&amp; verifyMaxCustomerUsageThreshold(order, code.getOffer());
 573     }
 574 
 575     @Deprecated
 576     @Override
 577     public boolean verifyMaxCustomerUsageThreshold(Customer customer, OfferCode code) {
 578         boolean underCodeMaxUses = true;
 579         if (code.isLimitedUse()) {
 580             Long currentCodeUses = offerAuditService.countOfferCodeUses(code.getId());
 581             underCodeMaxUses = currentCodeUses &lt; code.getMaxUses();
 582         }
 583         return underCodeMaxUses &amp;&amp; verifyMaxCustomerUsageThreshold(customer, code.getOffer());
 584     }
 585 
 586     @Override
 587     @SuppressWarnings(&quot;unchecked&quot;)
 588     public Set&lt;Offer&gt; getUniqueOffersFromOrder(Order order) {
 589         HashSet&lt;Offer&gt; result = new HashSet&lt;Offer&gt;();
 590 
 591         Transformer adjustmentToOfferTransformer = new Transformer() {
 592 
 593             @Override
 594             public Object transform(Object input) {
 595                 return ((Adjustment)input).getOffer();
 596             }
 597         };
 598 
<abbr title=" 599         result.addAll(CollectionUtils.collect(order.getOrderAdjustments(), adjustmentToOfferTransformer));"> 599         result.addAll(CollectionUtils.collect(order.getOrderAdjustments(), adjustmentToOfferTransformer))ðŸ”µ</abbr>
 600 
 601         if (order.getOrderItems() != null) {
 602             for (OrderItem item : order.getOrderItems()) {
<abbr title=" 603                 result.addAll(CollectionUtils.collect(item.getOrderItemAdjustments(), adjustmentToOfferTransformer));"> 603                 result.addAll(CollectionUtils.collect(item.getOrderItemAdjustments(), adjustmentToOfferTrðŸ”µ</abbr>
 604 
 605                 //record usage for price details on the item as well
 606                 if (item.getOrderItemPriceDetails() != null) {
 607                     for (OrderItemPriceDetail detail : item.getOrderItemPriceDetails()) {
<abbr title=" 608                         result.addAll(CollectionUtils.collect(detail.getOrderItemPriceDetailAdjustments(), adjustmentToOfferTransformer));"> 608                         result.addAll(CollectionUtils.collect(detail.getOrderItemPriceDetailAdjustments()ðŸ”µ</abbr>
 609                     }
 610                 }
 611             }
 612         }
 613 
 614         if (order.getFulfillmentGroups() != null) {
 615             for (FulfillmentGroup fg : order.getFulfillmentGroups()) {
<abbr title=" 616                 result.addAll(CollectionUtils.collect(fg.getFulfillmentGroupAdjustments(), adjustmentToOfferTransformer));"> 616                 result.addAll(CollectionUtils.collect(fg.getFulfillmentGroupAdjustments(), adjustmentToOfðŸ”µ</abbr>
 617             }
 618         }
 619         return result;
 620     }
 621 
 622     @Override
 623     public Map&lt;Offer, OfferCode&gt; getOffersRetrievedFromCodes(Order order)  {
 624         return getOffersRetrievedFromCodes(order.getAddedOfferCodes(), getUniqueOffersFromOrder(order));
 625     }
 626 
 627     @Override
<abbr title=" 628     public Map&lt;Offer, OfferCode&gt; getOffersRetrievedFromCodes(List&lt;OfferCode&gt; codes, Set&lt;Offer&gt; appliedOffers) {"> 628     public Map&lt;Offer, OfferCode&gt; getOffersRetrievedFromCodes(List&lt;OfferCode&gt; codes, Set&lt;Offer&gt; appliedOffðŸ”µ</abbr>
 629         HashMap&lt;Offer, OfferCode&gt; offerToCodeMapping = new HashMap&lt;Offer, OfferCode&gt;();
 630         for (OfferCode code : codes) {
 631             if (appliedOffers.contains(code.getOffer())) {
 632                 offerToCodeMapping.put(code.getOffer(), code);
 633             }
 634 
 635             List&lt;Offer&gt; additionalOffersToBeApplied = new ArrayList&lt;Offer&gt;();
 636 
 637             extensionManager.getProxy().addAdditionalOffersForCode(additionalOffersToBeApplied, code);
 638             for (Offer additionalOfferToBeApplied : additionalOffersToBeApplied) {
 639                 offerToCodeMapping.put(additionalOfferToBeApplied, code);
 640             }
 641         }
 642         return offerToCodeMapping;
 643     }
 644 
 645     @Override
 646     @Transactional(&quot;blTransactionManager&quot;)
 647     public Boolean deleteOfferCode(OfferCode code) {
 648         if (offerCodeDao.offerCodeIsUsed(code)) {
 649             return false;
 650         }
 651 
 652         offerCodeDao.delete(code);
 653         return true;
 654     }
 655 
 656     @Transactional(&quot;blTransactionManager&quot;)
 657     @Override
 658     public Offer duplicate(Long originalOfferId) {
 659         return duplicator.copy(OfferImpl.class, originalOfferId);
 660     }
 661 
 662     @Override
 663     public CustomerOfferDao getCustomerOfferDao() {
 664         return customerOfferDao;
 665     }
 666 
 667     @Override
 668     public void setCustomerOfferDao(CustomerOfferDao customerOfferDao) {
 669         this.customerOfferDao = customerOfferDao;
 670     }
 671 
 672     @Override
 673     public OfferCodeDao getOfferCodeDao() {
 674         return offerCodeDao;
 675     }
 676 
 677     @Override
 678     public void setOfferCodeDao(OfferCodeDao offerCodeDao) {
 679         this.offerCodeDao = offerCodeDao;
 680     }
 681 
 682     @Override
 683     public OfferDao getOfferDao() {
 684         return offerDao;
 685     }
 686 
 687     @Override
 688     public void setOfferDao(OfferDao offerDao) {
 689         this.offerDao = offerDao;
 690     }
 691 
 692     @Override
 693     public OrderOfferProcessor getOrderOfferProcessor() {
 694         return orderOfferProcessor;
 695     }
 696 
 697     @Override
 698     public void setOrderOfferProcessor(OrderOfferProcessor orderOfferProcessor) {
 699         this.orderOfferProcessor = orderOfferProcessor;
 700     }
 701 
 702     @Override
 703     public ItemOfferProcessor getItemOfferProcessor() {
 704         return itemOfferProcessor;
 705     }
 706 
 707     @Override
 708     public void setItemOfferProcessor(ItemOfferProcessor itemOfferProcessor) {
 709         this.itemOfferProcessor = itemOfferProcessor;
 710     }
 711 
 712     @Override
 713     public FulfillmentGroupOfferProcessor getFulfillmentGroupOfferProcessor() {
 714         return fulfillmentGroupOfferProcessor;
 715     }
 716 
 717     @Override
<abbr title=" 718     public void setFulfillmentGroupOfferProcessor(FulfillmentGroupOfferProcessor fulfillmentGroupOfferProcessor) {"> 718     public void setFulfillmentGroupOfferProcessor(FulfillmentGroupOfferProcessor fulfillmentGroupOfferProðŸ”µ</abbr>
 719         this.fulfillmentGroupOfferProcessor = fulfillmentGroupOfferProcessor;
 720     }
 721 
 722     @Override
 723     public PromotableItemFactory getPromotableItemFactory() {
 724         return promotableItemFactory;
 725     }
 726 
 727     @Override
 728     public void setPromotableItemFactory(PromotableItemFactory promotableItemFactory) {
 729         this.promotableItemFactory = promotableItemFactory;
 730     }
 731 
 732     @Override
 733     public OfferCode findOfferCodeById(Long id) {
 734         return offerCodeDao.readOfferCodeById(id);
 735     }
 736 
 737     @Override
 738     public List&lt;OfferCode&gt; findOfferCodesByIds(Collection&lt;Long&gt; ids) {
 739         return offerCodeDao.readOfferCodesByIds(ids);
 740     }
 741 
 742     @Override
 743     public OrderService getOrderService() {
 744         return orderService;
 745     }
 746 
 747     @Override
 748     public void setOrderService(OrderService orderService) {
 749         this.orderService = orderService;
 750     }
 751 
 752     @Override
 753     public Offer findOfferById(Long offerId) {
 754         return offerDao.readOfferById(offerId);
 755     }
 756 }
 
 
 </pre></td>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Framework
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  *
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.core.offer.service;
  19 
  20 import java.util.ArrayList;
  21 import java.util.Collection;
  22 import java.util.HashMap;
  23 import java.util.HashSet;
  24 import java.util.Iterator;
  25 import java.util.List;
  26 import java.util.Map;
  27 import java.util.Objects;
  28 import java.util.Set;
  29 import javax.annotation.Resource;
  30 import javax.persistence.EntityManager;
  31 import javax.persistence.PersistenceContext;
  32 import org.apache.commons.collections.CollectionUtils;
  33 import org.apache.commons.collections.Transformer;
  34 import org.apache.commons.logging.Log;
  35 import org.apache.commons.logging.LogFactory;
  36 import org.broadleafcommerce.common.persistence.EntityDuplicateModifier;
  37 import org.broadleafcommerce.common.persistence.EntityDuplicator;
  38 import org.broadleafcommerce.common.sandbox.SandBoxHelper;
  39 import org.broadleafcommerce.common.util.StreamCapableTransactionalOperationAdapter;
  40 import org.broadleafcommerce.common.util.StreamingTransactionCapableUtil;
  41 import org.broadleafcommerce.core.offer.dao.CustomerOfferDao;
  42 import org.broadleafcommerce.core.offer.dao.OfferCodeDao;
  43 import org.broadleafcommerce.core.offer.dao.OfferDao;
  44 import org.broadleafcommerce.core.offer.domain.Adjustment;
  45 import org.broadleafcommerce.core.offer.domain.CustomerOffer;
  46 import org.broadleafcommerce.core.offer.domain.Offer;
  47 import org.broadleafcommerce.core.offer.domain.OfferCode;
  48 import org.broadleafcommerce.core.offer.domain.OfferImpl;
  49 import org.broadleafcommerce.core.offer.domain.OrderItemPriceDetailAdjustment;
  50 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableCandidateFulfillmentGroupOffer;
  51 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableCandidateItemOffer;
  52 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableCandidateOrderOffer;
  53 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableItemFactory;
  54 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrder;
  55 import org.broadleafcommerce.core.offer.service.processor.FulfillmentGroupOfferProcessor;
  56 import org.broadleafcommerce.core.offer.service.processor.ItemOfferProcessor;
  57 import org.broadleafcommerce.core.offer.service.processor.OrderOfferProcessor;
  58 import org.broadleafcommerce.core.offer.service.type.CustomerMaxUsesStrategyType;
  59 import org.broadleafcommerce.core.offer.service.type.OfferType;
  60 import org.broadleafcommerce.core.order.domain.FulfillmentGroup;
  61 import org.broadleafcommerce.core.order.domain.Order;
  62 import org.broadleafcommerce.core.order.domain.OrderItem;
  63 import org.broadleafcommerce.core.order.domain.OrderItemPriceDetail;
  64 import org.broadleafcommerce.core.order.service.OrderService;
  65 import org.broadleafcommerce.core.pricing.service.exception.PricingException;
  66 import org.broadleafcommerce.profile.core.domain.Customer;
  67 import org.springframework.stereotype.Service;
  68 import org.springframework.transaction.annotation.Transactional;
  69 
  70 
  71 /**
  72  * The Class OfferServiceImpl.
  73  */
  74 @Service(&quot;blOfferService&quot;)
  75 public class OfferServiceImpl implements OfferService {
  76     private static final Log LOG = LogFactory.getLog(OfferServiceImpl.class);
  77 
  78     // should be called outside of Offer service after Offer service is executed
  79     // should be called outside of Offer service after Offer service is executed
  80     @Resource(name=&quot;blCustomerOfferDao&quot;)
  81     protected CustomerOfferDao customerOfferDao;
  82 
  83     @Resource(name=&quot;blOfferCodeDao&quot;)
  84     protected OfferCodeDao offerCodeDao;
  85 
  86     @Resource(name=&quot;blOfferAuditService&quot;)
  87     protected OfferAuditService offerAuditService;
  88 
  89     @Resource(name=&quot;blOfferDao&quot;)
  90     protected OfferDao offerDao;
  91 
  92     @Resource(name=&quot;blOrderOfferProcessor&quot;)
  93     protected OrderOfferProcessor orderOfferProcessor;
  94 
  95     @Resource(name=&quot;blItemOfferProcessor&quot;)
  96     protected ItemOfferProcessor itemOfferProcessor;
  97 
  98     @Resource(name=&quot;blFulfillmentGroupOfferProcessor&quot;)
  99     protected FulfillmentGroupOfferProcessor fulfillmentGroupOfferProcessor;
 100 
 101     @Resource(name=&quot;blPromotableItemFactory&quot;)
 102     protected PromotableItemFactory promotableItemFactory;
 103 
 104     @Resource(name = &quot;blOfferServiceExtensionManager&quot;)
 105     protected OfferServiceExtensionManager extensionManager;
 106 
 107     @Resource(name = &quot;blOrderService&quot;)
 108     protected OrderService orderService;
 109 
 110     @Resource(name = &quot;blSandBoxHelper&quot;)
 111     protected SandBoxHelper sandBoxHelper;
 112 
 113     @PersistenceContext(unitName=&quot;blPU&quot;)
 114     protected EntityManager em;
 115 
 116     @Resource(name=&quot;blStreamingTransactionCapableUtil&quot;)
 117     protected StreamingTransactionCapableUtil transUtil;
 118 
 119     @Resource(name=&quot;blEntityDuplicator&quot;)
 120     protected EntityDuplicator duplicator;
 121 
 122     /**
 123      * @deprecated Add {@link EntityDuplicateModifier}s to {@code blEntityDuplicationHelpers}
 124      */
 125     @Deprecated
 126     protected EntityDuplicateModifier&lt;Offer&gt; offerDuplicateModifier;
 127 
 128     @Override
 129     public List&lt;Offer&gt; findAllOffers() {
 130         return offerDao.readAllOffers();
 131     }
 132 
 133     @Override
 134     @Transactional(&quot;blTransactionManager&quot;)
 135     public Offer save(Offer offer) {
 136         return offerDao.save(offer);
 137     }
 138 
 139     @Override
 140     @Transactional(&quot;blTransactionManager&quot;)
 141     public OfferCode saveOfferCode(OfferCode offerCode) {
 142         offerCode.setOffer(offerDao.save(offerCode.getOffer()));
 143         return offerCodeDao.save(offerCode);
 144     }
 145 
 146     /**
<abbr title=" 147      * Creates a list of offers that applies to this order.  All offers that are assigned to the customer,"> 147      * Creates a list of offers that applies to this order.  All offers that are assigned to the customerðŸ”µ</abbr>
<abbr title=" 148      * entered during checkout, or has a delivery type of automatic are added to the list.  The same offer"> 148      * entered during checkout, or has a delivery type of automatic are added to the list.  The same offeðŸ”µ</abbr>
 149      * cannot appear more than once in the list.
 150      *
 151      * @param code
 152      * @return a List of offers that may apply to this order
 153      */
 154     @Override
 155     public Offer lookupOfferByCode(String code) {
 156         Offer offer = null;
 157         OfferCode offerCode = offerCodeDao.readOfferCodeByCode(code);
 158         if (offerCode != null) {
 159             offer = offerCode.getOffer();
 160         }
 161         return offer;
 162     }
 163 
 164     @Override
 165     public OfferCode lookupOfferCodeByCode(String code){
 166         return offerCodeDao.readOfferCodeByCode(code);
 167     }
 168 
 169     @Override
 170     public List&lt;Offer&gt; lookupAllOffersByCode(String code) {
 171         List&lt;Offer&gt; offers = new ArrayList&lt;Offer&gt;();
 172         List&lt;OfferCode&gt; offerCodes = offerCodeDao.readAllOfferCodesByCode(code);
 173         for (OfferCode offerCode : offerCodes) {
 174             if (offerCode != null) {
 175                 offers.add(offerCode.getOffer());
 176             }
 177         }
 178         return offers;
 179     }
 180 
 181     @Override
 182     public List&lt;OfferCode&gt; lookupAllOfferCodesByCode(String code){
 183         return offerCodeDao.readAllOfferCodesByCode(code);
 184     }
 185 
 186     /**
<abbr title=" 187      * Creates a list of offers that applies to this order.  All offers that are assigned to the customer,"> 187      * Creates a list of offers that applies to this order.  All offers that are assigned to the customerðŸ”µ</abbr>
<abbr title=" 188      * entered during checkout, or has a delivery type of automatic are added to the list.  The same offer"> 188      * entered during checkout, or has a delivery type of automatic are added to the list.  The same offeðŸ”µ</abbr>
 189      * cannot appear more than once in the list.
 190      *
 191      * @param order
 192      * @return a List of offers that may apply to this order
 193      */
 194     @Override
 195     public List&lt;Offer&gt; buildOfferListForOrder(Order order) {
 196         List&lt;Offer&gt; offers = new ArrayList&lt;Offer&gt;();
 197         List&lt;CustomerOffer&gt; customerOffers = lookupOfferCustomerByCustomer(order.getCustomer());
 198         for (CustomerOffer customerOffer : customerOffers) {
 199             if (!offers.contains(customerOffer.getOffer())) {
 200                 offers.add(customerOffer.getOffer());
 201             }
 202         }
 203         List&lt;OfferCode&gt; orderOfferCodes = refreshOfferCodesIfApplicable(order);
 204         orderOfferCodes = removeOutOfDateOfferCodes(orderOfferCodes);
 205         for (OfferCode orderOfferCode : orderOfferCodes) {
 206             if (!offers.contains(orderOfferCode.getOffer())) {
 207                 offers.add(orderOfferCode.getOffer());
 208             }
 209             extensionManager.getProxy().addAdditionalOffersForCode(offers, orderOfferCode);
 210         }
 211         List&lt;Offer&gt; globalOffers = lookupAutomaticDeliveryOffers();
 212         for (Offer globalOffer : globalOffers) {
 213             if (!offers.contains(globalOffer) &amp;&amp; verifyMaxCustomerUsageThreshold(order, globalOffer)) {
 214                 offers.add(globalOffer);
 215             }
 216         }
 217 
 218         if (extensionManager != null) {
 219             extensionManager.applyAdditionalFilters(offers, order);
 220         }
 221 
 222         return offers;
 223     }
 224 
 225     @Override
 226     public List&lt;OfferCode&gt; buildOfferCodeListForCustomer(Order order) {
 227         Customer customer = order.getCustomer();
 228         ArrayList&lt;OfferCode&gt; offerCodes = new ArrayList&lt;&gt;();
 229 
 230         if (extensionManager != null) {
 231             extensionManager.buildOfferCodeListForCustomer(customer, offerCodes);
 232         }
 233         if (!offerCodes.isEmpty()) {
 234             Iterator&lt;OfferCode&gt; itr = offerCodes.iterator();
 235             while (itr.hasNext()) {
 236                 OfferCode offerCode = itr.next();
 237                 if (!offerCode.isActive() || !verifyMaxCustomerUsageThreshold(order, offerCode)) {
 238                     itr.remove();
 239                 }
 240             }
 241         }
 242         return offerCodes;
 243     }
 244 
 245     @Deprecated
 246     @Override
 247     public List&lt;OfferCode&gt; buildOfferCodeListForCustomer(Customer customer) {
 248         ArrayList&lt;OfferCode&gt; offerCodes = new ArrayList&lt;OfferCode&gt;();
 249         if (extensionManager != null) {
 250             extensionManager.buildOfferCodeListForCustomer(customer, offerCodes);
 251         }
 252         if (!offerCodes.isEmpty()) {
 253             Iterator&lt;OfferCode&gt; itr = offerCodes.iterator();
 254             while (itr.hasNext()) {
 255                 OfferCode offerCode = itr.next();
 256                 if (!offerCode.isActive() || !verifyMaxCustomerUsageThreshold(customer, offerCode)) {
 257                     itr.remove();
 258                 }
 259             }
 260         }
 261         return offerCodes;
 262     }
 263 
 264     /**
 265      * Private method used to retrieve all offers assigned to this customer.  These offers are
 266      * programmatically assigned to the customer.
 267      *
 268      * @param customer
 269      * @return a List of offers assigned to the customer
 270      */
 271     protected List&lt;CustomerOffer&gt; lookupOfferCustomerByCustomer(Customer customer) {
 272         List&lt;CustomerOffer&gt; offerCustomers = customerOfferDao.readCustomerOffersByCustomer(customer);
 273         return offerCustomers;
 274     }
 275 
 276     /**
 277      * Private method used to retrieve all offers with automaticallyAdded set to true
 278      *
 279      * @return a List of automatic delivery offers
 280      */
 281     protected List&lt;Offer&gt; lookupAutomaticDeliveryOffers() {
 282         List&lt;Offer&gt; globalOffers = offerDao.readOffersByAutomaticDeliveryType();
 283         return globalOffers;
 284     }
 285 
 286     /**
 287      * Removes all out of date offerCodes based on the offerCode and its offer&#x27;s start and end
 288      * date.  If an offerCode has a later start date, that offerCode will be removed.
 289      * OfferCodes without a start date will still be processed. If the offerCode
 290      * has a end date that has already passed, that offerCode will be removed.  OfferCodes
 291      * without a end date will be processed.  The start and end dates on the offer will
 292      * still need to be evaluated.
 293      *
 294      * @param offerCodes
 295      * @return a List of non-expired offers
 296      */
 297     protected List&lt;OfferCode&gt; removeOutOfDateOfferCodes(List&lt;OfferCode&gt; offerCodes){
 298         List&lt;OfferCode&gt; offerCodesToRemove = new ArrayList&lt;OfferCode&gt;();
 299         for (OfferCode offerCode : offerCodes) {
 300             if (!offerCode.isActive()){
 301                 offerCodesToRemove.add(offerCode);
 302             }
 303         }
 304         // remove all offers in the offersToRemove list from original offers list
 305         for (OfferCode offerCode : offerCodesToRemove) {
 306             offerCodes.remove(offerCode);
 307         }
 308         return offerCodes;
 309     }
 310 
 311     /**
 312      * For enterprise installations, this will refresh any OfferCodes found to be out-of-date with
 313      * current sandbox status.
 314      *
 315      * @param order the order to check
 316      * @return the refreshed list of OfferCodes
 317      */
 318     protected List&lt;OfferCode&gt; refreshOfferCodesIfApplicable(final Order order) {
 319         final List&lt;OfferCode&gt; orderOfferCodes = order.getAddedOfferCodes();
 320 
 321         transUtil.runTransactionalOperation(new StreamCapableTransactionalOperationAdapter() {
 322             @Override
 323             public void execute() {
 324                 for (OfferCode offerCode : orderOfferCodes) {
 325                     if (offerCode.getOffer() != null) {
<abbr title=" 326                         Long sandBoxVersionId = sandBoxHelper.getSandBoxVersionId(OfferImpl.class, offerCode.getOffer().getId());"> 326                         Long sandBoxVersionId = sandBoxHelper.getSandBoxVersionId(OfferImpl.class, offerCðŸ”µ</abbr>
<abbr title=" 327                         if (sandBoxVersionId != null &amp;&amp; !Objects.equals(sandBoxVersionId, offerCode.getOffer().getId())) {"> 327                         if (sandBoxVersionId != null &amp;&amp; !Objects.equals(sandBoxVersionId, offerCode.getOfðŸ”µ</abbr>
 328                             em.refresh(offerCode);
 329                         }
 330                     }
 331                 }
 332             }
 333 
 334             @Override
 335             public boolean shouldRetryOnTransactionLockAcquisitionFailure() {
 336                 return true;
 337             }
 338         }, RuntimeException.class);
 339 
 340         return orderOfferCodes;
 341     }
 342 
 343     /*
 344      *
 345      * Offers Logic:
 346      * 1) Remove all existing offers in the Order (order, item, and fulfillment)
 347      * 2) Check and remove offers
 348      *    a) Remove out of date offers
 349      *    b) Remove offers that do not apply to this customer
 350      * 3) Loop through offers
 351      *    a) Verifies type of offer (order, order item, fulfillment)
 352      *    b) Verifies if offer can be applies
 353      *    c) Assign offer to type (order, order item, or fulfillment)
 354      * 4) Sorts the order and item offers list by priority and then discount
 355      * 5) Identify the best offers to apply to order item and create adjustments for each item offer
<abbr title=" 356      * 6) Compare order item adjustment price to sales price, and remove adjustments if sale price is better"> 356      * 6) Compare order item adjustment price to sales price, and remove adjustments if sale price is betðŸ”µ</abbr>
 357      * 7) Identify the best offers to apply to the order and create adjustments for each order offer
<abbr title=" 358      * 8) If item contains non-combinable offers remove either the item or order adjustments based on discount value"> 358      * 8) If item contains non-combinable offers remove either the item or order adjustments based on disðŸ”µ</abbr>
 359      * 9) Set final order item prices and reapply order offers
 360      *
 361      * Assumptions:
 362      * 1) % off all items will be created as an item offer with no expression
 363      * 2) $ off order will be created as an order offer
 364      * 3) Order offers applies to the best price for each item (not just retail price)
 365      * 4) Fulfillment offers apply to best price for each item (not just retail price)
<abbr title=" 366      * 5) Stackable only applies to the same offer type (i.e. a not stackable order offer can be used with item offers)"> 366      * 5) Stackable only applies to the same offer type (i.e. a not stackable order offer can be used witðŸ”µ</abbr>
 367      * 6) Fulfillment offers cannot be not combinable
 368      * 7) Order offers cannot be FIXED_PRICE
 369      * 8) FIXED_PRICE offers cannot be stackable
<abbr title=" 370      * 9) Non-combinable offers only apply to the order and order items, fulfillment group offers will always apply"> 370      * 9) Non-combinable offers only apply to the order and order items, fulfillment group offers will alðŸ”µ</abbr>
 371      *
 372      */
 373     @Override
 374     @Transactional(&quot;blTransactionManager&quot;)
 375     public Order applyAndSaveOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricingException {
 376         /*
 377         TODO rather than a threadlocal, we should update the &quot;shouldPrice&quot; boolean on the service API to
 378         use a richer object to describe the parameters of the pricing call. This object would include
 379         the pricing boolean, but would also include a list of activities to include or exclude in the
 380         call - see http://jira.broadleafcommerce.org/browse/BLC-664
 381          */
 382         OfferContext offerContext = OfferContext.getOfferContext();
 383         if (offerContext == null || offerContext.executePromotionCalculation) {
 384             PromotableOrder promotableOrder = promotableItemFactory.createPromotableOrder(order, false);
 385             List&lt;Offer&gt; filteredOffers = orderOfferProcessor.filterOffers(offers, order.getCustomer());
 386             if ((filteredOffers == null) || (filteredOffers.isEmpty())) {
 387                 if (LOG.isTraceEnabled()) {
 388                     LOG.trace(&quot;No offers applicable to this order.&quot;);
 389                 }
 390             } else {
<abbr title=" 391                 List&lt;PromotableCandidateOrderOffer&gt; qualifiedOrderOffers = new ArrayList&lt;PromotableCandidateOrderOffer&gt;();"> 391                 List&lt;PromotableCandidateOrderOffer&gt; qualifiedOrderOffers = new ArrayList&lt;PromotableCandidðŸ”µ</abbr>
<abbr title=" 392                 List&lt;PromotableCandidateItemOffer&gt; qualifiedItemOffers = new ArrayList&lt;PromotableCandidateItemOffer&gt;();"> 392                 List&lt;PromotableCandidateItemOffer&gt; qualifiedItemOffers = new ArrayList&lt;PromotableCandidatðŸ”µ</abbr>
 393 
<abbr title=" 394                 itemOfferProcessor.filterOffers(promotableOrder, filteredOffers, qualifiedOrderOffers, qualifiedItemOffers);"> 394                 itemOfferProcessor.filterOffers(promotableOrder, filteredOffers, qualifiedOrderOffers, quðŸ”µ</abbr>
 395 
 396                 if (! (qualifiedItemOffers.isEmpty() &amp;&amp; qualifiedOrderOffers.isEmpty())) {
<abbr title=" 397                     // At this point, we should have a PromotableOrder that contains PromotableItems each of which"> 397                     // At this point, we should have a PromotableOrder that contains PromotableItems eachðŸ”µ</abbr>
 398                     // has a list of candidatePromotions that might be applied.
 399 
<abbr title=" 400                     // We also have a list of orderOffers that might apply and a list of itemOffers that might apply."> 400                     // We also have a list of orderOffers that might apply and a list of itemOffers that ðŸ”µ</abbr>
<abbr title=" 401                     itemOfferProcessor.applyAndCompareOrderAndItemOffers(promotableOrder, qualifiedOrderOffers, qualifiedItemOffers);"> 401                     itemOfferProcessor.applyAndCompareOrderAndItemOffers(promotableOrder, qualifiedOrderOðŸ”µ</abbr>
 402                 }
 403             }
 404             orderOfferProcessor.synchronizeAdjustmentsAndPrices(promotableOrder);
 405 
 406             verifyAdjustments(order, true);
 407 
 408             order.setSubTotal(order.calculateSubTotal());
 409             order.finalizeItemPrices();
 410 
 411             order = orderService.save(order, false);
 412 
 413             boolean madeChange = verifyAdjustments(order, false);
 414             if (madeChange) {
 415                 order = orderService.save(order, false);
 416             }
 417         }
 418 
 419         return order;
 420     }
 421 
 422     protected boolean verifyAdjustments(Order order, boolean beforeSave) {
 423         boolean madeChange = false;
 424 
 425         if (order.getOrderItems() == null) {
 426             return madeChange;
 427         }
 428 
 429         for (OrderItem oi : order.getOrderItems()) {
 430             if (oi.getOrderItemPriceDetails() == null) {
 431                 continue;
 432             }
 433 
 434             for (OrderItemPriceDetail pd : oi.getOrderItemPriceDetails()) {
 435                 if (pd.getOrderItemPriceDetailAdjustments() == null) {
 436                     continue;
 437                 }
 438 
<abbr title=" 439                 Map&lt;Long, OrderItemPriceDetailAdjustment&gt; adjs = new HashMap&lt;Long, OrderItemPriceDetailAdjustment&gt;();"> 439                 Map&lt;Long, OrderItemPriceDetailAdjustment&gt; adjs = new HashMap&lt;Long, OrderItemPriceDetailAdðŸ”µ</abbr>
<abbr title=" 440                 List&lt;OrderItemPriceDetailAdjustment&gt; adjustmentsToRemove = new ArrayList&lt;OrderItemPriceDetailAdjustment&gt;();"> 440                 List&lt;OrderItemPriceDetailAdjustment&gt; adjustmentsToRemove = new ArrayList&lt;OrderItemPriceDeðŸ”µ</abbr>
 441                 for (OrderItemPriceDetailAdjustment adj : pd.getOrderItemPriceDetailAdjustments()) {
 442                     if (adjs.containsKey(adj.getOffer().getId())) {
 443                         adjustmentsToRemove.add(adj);
 444                         if (LOG.isDebugEnabled()) {
 445                             StringBuilder sb = new StringBuilder(&quot;Detected collisions &quot;)
 446                                 .append(beforeSave ? &quot;before saving&quot; : &quot;after saving&quot;)
 447                                 .append(&quot; with ids &quot;)
 448                                 .append(adjs.get(adj.getOffer().getId()).getId())
 449                                 .append(&quot; and &quot;)
 450                                 .append(adj.getId());
 451                             LOG.debug(sb.toString());
 452                         }
 453                     } else {
 454                         adjs.put(adj.getOffer().getId(), adj);
 455                     }
 456                 }
 457 
 458                 for (OrderItemPriceDetailAdjustment adj : adjustmentsToRemove) {
 459                     pd.getOrderItemPriceDetailAdjustments().remove(adj);
 460                     madeChange = true;
 461                 }
 462             }
 463         }
 464 
 465         return madeChange;
 466      }
 467 
 468     @Override
 469     @Transactional(&quot;blTransactionManager&quot;)
 470     @Deprecated
 471     public void applyOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricingException {
 472         applyAndSaveOffersToOrder(offers, order);
 473     }
 474 
 475     @Override
 476     @Transactional(&quot;blTransactionManager&quot;)
 477     @Deprecated
<abbr title=" 478     public void applyFulfillmentGroupOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricingException {"> 478     public void applyFulfillmentGroupOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricingExceptiðŸ”µ</abbr>
 479         applyAndSaveFulfillmentGroupOffersToOrder(offers, order);
 480     }
 481 
 482     @Override
 483     @Transactional(&quot;blTransactionManager&quot;)
<abbr title=" 484     public Order applyAndSaveFulfillmentGroupOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricingException {"> 484     public Order applyAndSaveFulfillmentGroupOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricinðŸ”µ</abbr>
 485         OfferContext offerContext = OfferContext.getOfferContext();
 486         if (offerContext == null || offerContext.executePromotionCalculation) {
 487             PromotableOrder promotableOrder =
 488                     promotableItemFactory.createPromotableOrder(order, true);
 489             List&lt;Offer&gt; possibleFGOffers = new ArrayList&lt;Offer&gt;();
 490             for (Offer offer : offers) {
 491                 if (offer.getType().getType().equals(OfferType.FULFILLMENT_GROUP.getType())) {
 492                     possibleFGOffers.add(offer);
 493                 }
 494             }
<abbr title=" 495             List&lt;Offer&gt; filteredOffers = orderOfferProcessor.filterOffers(possibleFGOffers, order.getCustomer());"> 495             List&lt;Offer&gt; filteredOffers = orderOfferProcessor.filterOffers(possibleFGOffers, order.getCustðŸ”µ</abbr>
<abbr title=" 496             List&lt;PromotableCandidateFulfillmentGroupOffer&gt; qualifiedFGOffers = new ArrayList&lt;PromotableCandidateFulfillmentGroupOffer&gt;();"> 496             List&lt;PromotableCandidateFulfillmentGroupOffer&gt; qualifiedFGOffers = new ArrayList&lt;PromotableCaðŸ”µ</abbr>
 497             for (Offer offer : filteredOffers) {
<abbr title=" 498                 fulfillmentGroupOfferProcessor.filterFulfillmentGroupLevelOffer(promotableOrder, qualifiedFGOffers, offer);"> 498                 fulfillmentGroupOfferProcessor.filterFulfillmentGroupLevelOffer(promotableOrder, qualifieðŸ”µ</abbr>
 499             }
 500             if (!qualifiedFGOffers.isEmpty()) {
<abbr title=" 501                 fulfillmentGroupOfferProcessor.applyAllFulfillmentGroupOffers(qualifiedFGOffers, promotableOrder);"> 501                 fulfillmentGroupOfferProcessor.applyAllFulfillmentGroupOffers(qualifiedFGOffers, promotabðŸ”µ</abbr>
 502                 fulfillmentGroupOfferProcessor.calculateFulfillmentGroupTotal(promotableOrder);
 503                 orderOfferProcessor.synchronizeAdjustmentsAndPrices(promotableOrder);
 504             }
 505 
 506             return orderService.save(order, false);
 507         }
 508         return order;
 509     }
 510 
 511     @Override
 512     public boolean verifyMaxCustomerUsageThreshold(Order order, Offer offer) {
 513         if (offer.isLimitedUsePerCustomer()) {
 514             CustomerMaxUsesStrategyType strategy = offer.getMaxUsesStrategyType();
<abbr title=" 515             boolean checkUsingCustomer = (strategy == null) || strategy.equals(CustomerMaxUsesStrategyType.CUSTOMER);"> 515             boolean checkUsingCustomer = (strategy == null) || strategy.equals(CustomerMaxUsesStrategyTypðŸ”µ</abbr>
 516             Long currentUses;
 517             if (checkUsingCustomer) {
<abbr title=" 518                 currentUses = offerAuditService.countUsesByCustomer(order, order.getCustomer().getId(), offer.getId(), offer.getMinimumDaysPerUsage());"> 518                 currentUses = offerAuditService.countUsesByCustomer(order, order.getCustomer().getId(), oðŸ”µ</abbr>
 519             } else {
<abbr title=" 520                 currentUses = offerAuditService.countUsesByAccount(order, order.getBroadleafAccountId(), offer.getId(), offer.getMinimumDaysPerUsage());"> 520                 currentUses = offerAuditService.countUsesByAccount(order, order.getBroadleafAccountId(), ðŸ”µ</abbr>
 521             }
 522             if (currentUses &gt;= offer.getMaxUsesPerCustomer()) {
 523                 return false;
 524             }
 525         }
 526         return true;
 527     }
 528 
 529     @Deprecated
 530     @Override
 531     public boolean verifyMaxCustomerUsageThreshold(Customer customer, Offer offer) {
 532         if (offer.isLimitedUsePerCustomer()) {
 533             Long currentUses = offerAuditService.countUsesByCustomer(customer.getId(), offer.getId());
 534 
 535             if (currentUses &gt;= offer.getMaxUsesPerCustomer()) {
 536                 return false;
 537             }
 538         }
 539 
 540         return true;
 541     }
 542 
 543     @Override
 544     public boolean verifyMaxCustomerUsageThreshold(Order order, OfferCode code) {
 545         boolean underCodeMaxUses = true;
 546 
 547         if (code.isLimitedUse()) {
 548             Long currentCodeUses = offerAuditService.countOfferCodeUses(order, code.getId());
 549             underCodeMaxUses = currentCodeUses &lt; code.getMaxUses();
 550         }
 551 
 552         return underCodeMaxUses &amp;&amp; verifyMaxCustomerUsageThreshold(order, code.getOffer());
 553     }
 554 
 555     @Deprecated
 556     @Override
 557     public boolean verifyMaxCustomerUsageThreshold(Customer customer, OfferCode code) {
 558         boolean underCodeMaxUses = true;
 559         if (code.isLimitedUse()) {
 560             Long currentCodeUses = offerAuditService.countOfferCodeUses(code.getId());
 561             underCodeMaxUses = currentCodeUses &lt; code.getMaxUses();
 562         }
 563         return underCodeMaxUses &amp;&amp; verifyMaxCustomerUsageThreshold(customer, code.getOffer());
 564     }
 565 
 566     @Override
 567     @SuppressWarnings(&quot;unchecked&quot;)
 568     public Set&lt;Offer&gt; getUniqueOffersFromOrder(Order order) {
 569         HashSet&lt;Offer&gt; result = new HashSet&lt;Offer&gt;();
 570 
 571         Transformer adjustmentToOfferTransformer = new Transformer() {
 572 
 573             @Override
 574             public Object transform(Object input) {
 575                 return ((Adjustment)input).getOffer();
 576             }
 577         };
 578 
<abbr title=" 579         result.addAll(CollectionUtils.collect(order.getOrderAdjustments(), adjustmentToOfferTransformer));"> 579         result.addAll(CollectionUtils.collect(order.getOrderAdjustments(), adjustmentToOfferTransformer))ðŸ”µ</abbr>
 580 
 581         if (order.getOrderItems() != null) {
 582             for (OrderItem item : order.getOrderItems()) {
<abbr title=" 583                 result.addAll(CollectionUtils.collect(item.getOrderItemAdjustments(), adjustmentToOfferTransformer));"> 583                 result.addAll(CollectionUtils.collect(item.getOrderItemAdjustments(), adjustmentToOfferTrðŸ”µ</abbr>
 584 
 585                 //record usage for price details on the item as well
 586                 if (item.getOrderItemPriceDetails() != null) {
 587                     for (OrderItemPriceDetail detail : item.getOrderItemPriceDetails()) {
<abbr title=" 588                         result.addAll(CollectionUtils.collect(detail.getOrderItemPriceDetailAdjustments(), adjustmentToOfferTransformer));"> 588                         result.addAll(CollectionUtils.collect(detail.getOrderItemPriceDetailAdjustments()ðŸ”µ</abbr>
 589                     }
 590                 }
 591             }
 592         }
 593 
 594         if (order.getFulfillmentGroups() != null) {
 595             for (FulfillmentGroup fg : order.getFulfillmentGroups()) {
<abbr title=" 596                 result.addAll(CollectionUtils.collect(fg.getFulfillmentGroupAdjustments(), adjustmentToOfferTransformer));"> 596                 result.addAll(CollectionUtils.collect(fg.getFulfillmentGroupAdjustments(), adjustmentToOfðŸ”µ</abbr>
 597             }
 598         }
 599         return result;
 600     }
 601 
 602     @Override
 603     public Map&lt;Offer, OfferCode&gt; getOffersRetrievedFromCodes(Order order)  {
 604         return getOffersRetrievedFromCodes(order.getAddedOfferCodes(), getUniqueOffersFromOrder(order));
 605     }
 606 
 607     @Override
<abbr title=" 608     public Map&lt;Offer, OfferCode&gt; getOffersRetrievedFromCodes(List&lt;OfferCode&gt; codes, Set&lt;Offer&gt; appliedOffers) {"> 608     public Map&lt;Offer, OfferCode&gt; getOffersRetrievedFromCodes(List&lt;OfferCode&gt; codes, Set&lt;Offer&gt; appliedOffðŸ”µ</abbr>
 609         HashMap&lt;Offer, OfferCode&gt; offerToCodeMapping = new HashMap&lt;Offer, OfferCode&gt;();
 610         for (OfferCode code : codes) {
 611             if (appliedOffers.contains(code.getOffer())) {
 612                 offerToCodeMapping.put(code.getOffer(), code);
 613             }
 614 
 615             List&lt;Offer&gt; additionalOffersToBeApplied = new ArrayList&lt;Offer&gt;();
 616 
 617             extensionManager.getProxy().addAdditionalOffersForCode(additionalOffersToBeApplied, code);
 618             for (Offer additionalOfferToBeApplied : additionalOffersToBeApplied) {
 619                 offerToCodeMapping.put(additionalOfferToBeApplied, code);
 620             }
 621         }
 622         return offerToCodeMapping;
 623     }
 624 
 625     @Override
 626     @Transactional(&quot;blTransactionManager&quot;)
 627     public Boolean deleteOfferCode(OfferCode code) {
 628         if (offerCodeDao.offerCodeIsUsed(code)) {
 629             return false;
 630         }
 631 
 632         offerCodeDao.delete(code);
 633         return true;
 634     }
 635 
 636     @Transactional(&quot;blTransactionManager&quot;)
 637     @Override
 638     public Offer duplicate(Long originalOfferId) {
 639         return duplicator.copy(OfferImpl.class, originalOfferId);
 640     }
 641 
 642     @Override
 643     public CustomerOfferDao getCustomerOfferDao() {
 644         return customerOfferDao;
 645     }
 646 
 647     @Override
 648     public void setCustomerOfferDao(CustomerOfferDao customerOfferDao) {
 649         this.customerOfferDao = customerOfferDao;
 650     }
 651 
 652     @Override
 653     public OfferCodeDao getOfferCodeDao() {
 654         return offerCodeDao;
 655     }
 656 
 657     @Override
 658     public void setOfferCodeDao(OfferCodeDao offerCodeDao) {
 659         this.offerCodeDao = offerCodeDao;
 660     }
 661 
 662     @Override
 663     public OfferDao getOfferDao() {
 664         return offerDao;
 665     }
 666 
 667     @Override
 668     public void setOfferDao(OfferDao offerDao) {
 669         this.offerDao = offerDao;
 670     }
 671 
 672     @Override
 673     public OrderOfferProcessor getOrderOfferProcessor() {
 674         return orderOfferProcessor;
 675     }
 676 
 677     @Override
 678     public void setOrderOfferProcessor(OrderOfferProcessor orderOfferProcessor) {
 679         this.orderOfferProcessor = orderOfferProcessor;
 680     }
 681 
 682     @Override
 683     public ItemOfferProcessor getItemOfferProcessor() {
 684         return itemOfferProcessor;
 685     }
 686 
 687     @Override
 688     public void setItemOfferProcessor(ItemOfferProcessor itemOfferProcessor) {
 689         this.itemOfferProcessor = itemOfferProcessor;
 690     }
 691 
 692     @Override
 693     public FulfillmentGroupOfferProcessor getFulfillmentGroupOfferProcessor() {
 694         return fulfillmentGroupOfferProcessor;
 695     }
 696 
 697     @Override
<abbr title=" 698     public void setFulfillmentGroupOfferProcessor(FulfillmentGroupOfferProcessor fulfillmentGroupOfferProcessor) {"> 698     public void setFulfillmentGroupOfferProcessor(FulfillmentGroupOfferProcessor fulfillmentGroupOfferProðŸ”µ</abbr>
 699         this.fulfillmentGroupOfferProcessor = fulfillmentGroupOfferProcessor;
 700     }
 701 
 702     @Override
 703     public PromotableItemFactory getPromotableItemFactory() {
 704         return promotableItemFactory;
 705     }
 706 
 707     @Override
 708     public void setPromotableItemFactory(PromotableItemFactory promotableItemFactory) {
 709         this.promotableItemFactory = promotableItemFactory;
 710     }
 711 
 712     @Override
 713     public OfferCode findOfferCodeById(Long id) {
 714         return offerCodeDao.readOfferCodeById(id);
 715     }
 716 
 717     @Override
 718     public List&lt;OfferCode&gt; findOfferCodesByIds(Collection&lt;Long&gt; ids) {
 719         return offerCodeDao.readOfferCodesByIds(ids);
 720     }
 721 
 722     @Override
 723     public OrderService getOrderService() {
 724         return orderService;
 725     }
 726 
 727     @Override
 728     public void setOrderService(OrderService orderService) {
 729         this.orderService = orderService;
 730     }
 731 
 732     @Override
 733     public Offer findOfferById(Long offerId) {
 734         return offerDao.readOfferById(offerId);
 735     }
 736 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  /*
   2   * #%L
   3   * BroadleafCommerce Framework
   4   * %%
   5   * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6   * %%
   7   * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8   * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9   * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10   * the Broadleaf End User License Agreement (EULA), Version 1.1
  11   * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12   * shall apply.
  13   *
<abbr title="  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr>
  15   * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.
  16   * #L%
  17   */
  18  package org.broadleafcommerce.core.offer.service;
  19  
  20  import org.apache.commons.collections.CollectionUtils;
  21  import org.apache.commons.collections.Transformer;
  22  import org.apache.commons.logging.Log;
  23  import org.apache.commons.logging.LogFactory;
  24  import org.broadleafcommerce.common.persistence.EntityDuplicateModifier;
  25  import org.broadleafcommerce.common.persistence.EntityDuplicator;
  26  import org.broadleafcommerce.common.sandbox.SandBoxHelper;
  27  import org.broadleafcommerce.common.util.StreamCapableTransactionalOperationAdapter;
  28  import org.broadleafcommerce.common.util.StreamingTransactionCapableUtil;
  29  import org.broadleafcommerce.core.offer.dao.CustomerOfferDao;
  30  import org.broadleafcommerce.core.offer.dao.OfferCodeDao;
  31  import org.broadleafcommerce.core.offer.dao.OfferDao;
  32  import org.broadleafcommerce.core.offer.domain.Adjustment;
  33  import org.broadleafcommerce.core.offer.domain.CustomerOffer;
  34  import org.broadleafcommerce.core.offer.domain.Offer;
  35  import org.broadleafcommerce.core.offer.domain.OfferCode;
  36  import org.broadleafcommerce.core.offer.domain.OfferImpl;
  37  import org.broadleafcommerce.core.offer.domain.OrderItemPriceDetailAdjustment;
  38  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableCandidateFulfillmentGroupOffer;
  39  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableCandidateItemOffer;
  40  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableCandidateOrderOffer;
  41  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableItemFactory;
  42  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrder;
  43  import org.broadleafcommerce.core.offer.service.processor.FulfillmentGroupOfferProcessor;
  44  import org.broadleafcommerce.core.offer.service.processor.ItemOfferProcessor;
  45  import org.broadleafcommerce.core.offer.service.processor.OrderOfferProcessor;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  46 +import org.broadleafcommerce.core.offer.service.type.CustomerMaxUsesStrategyType;</span>
  47  import org.broadleafcommerce.core.offer.service.type.OfferType;
  48  import org.broadleafcommerce.core.order.domain.FulfillmentGroup;
  49  import org.broadleafcommerce.core.order.domain.Order;
  50  import org.broadleafcommerce.core.order.domain.OrderItem;
  51  import org.broadleafcommerce.core.order.domain.OrderItemPriceDetail;
  52  import org.broadleafcommerce.core.order.service.OrderService;
  53  import org.broadleafcommerce.core.pricing.service.exception.PricingException;
  54  import org.broadleafcommerce.profile.core.domain.Customer;
  55  import org.springframework.stereotype.Service;
  56  import org.springframework.transaction.annotation.Transactional;
  57  
  58  import java.util.ArrayList;
  59  import java.util.Collection;
  60  import java.util.HashMap;
  61  import java.util.HashSet;
  62  import java.util.Iterator;
  63  import java.util.List;
  64  import java.util.Map;
  65  import java.util.Objects;
  66  import java.util.Set;
  67  
  68  import javax.annotation.Resource;
  69  import javax.persistence.EntityManager;
  70  import javax.persistence.PersistenceContext;
  71  
  72  /**
  73   * The Class OfferServiceImpl.
  74   */
  75  @Service(&quot;blOfferService&quot;)
  76  public class OfferServiceImpl implements OfferService {
  77  
  78      private static final Log LOG = LogFactory.getLog(OfferServiceImpl.class);
  79  
  80      // should be called outside of Offer service after Offer service is executed
  81      @Resource(name=&quot;blCustomerOfferDao&quot;)
  82      protected CustomerOfferDao customerOfferDao;
  83  
  84      @Resource(name=&quot;blOfferCodeDao&quot;)
  85      protected OfferCodeDao offerCodeDao;
  86  
  87      @Resource(name=&quot;blOfferAuditService&quot;)
  88      protected OfferAuditService offerAuditService;
  89  
  90      @Resource(name=&quot;blOfferDao&quot;)
  91      protected OfferDao offerDao;
  92  
  93      @Resource(name=&quot;blOrderOfferProcessor&quot;)
  94      protected OrderOfferProcessor orderOfferProcessor;
  95  
  96      @Resource(name=&quot;blItemOfferProcessor&quot;)
  97      protected ItemOfferProcessor itemOfferProcessor;
  98  
  99      @Resource(name=&quot;blFulfillmentGroupOfferProcessor&quot;)
 100      protected FulfillmentGroupOfferProcessor fulfillmentGroupOfferProcessor;
 101  
 102      @Resource(name=&quot;blPromotableItemFactory&quot;)
 103      protected PromotableItemFactory promotableItemFactory;
 104  
 105      @Resource(name = &quot;blOfferServiceExtensionManager&quot;)
 106      protected OfferServiceExtensionManager extensionManager;
 107  
 108      @Resource(name = &quot;blOrderService&quot;)
 109      protected OrderService orderService;
 110  
 111      @Resource(name = &quot;blSandBoxHelper&quot;)
 112      protected SandBoxHelper sandBoxHelper;
 113  
 114      @PersistenceContext(unitName=&quot;blPU&quot;)
 115      protected EntityManager em;
 116  
 117      @Resource(name=&quot;blStreamingTransactionCapableUtil&quot;)
 118      protected StreamingTransactionCapableUtil transUtil;
 119  
 120      @Resource(name=&quot;blEntityDuplicator&quot;)
 121      protected EntityDuplicator duplicator;
 122  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 123 -    @Resource(name=&quot;blOfferDuplicateModifier&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 124 +    /**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 125 +     * @deprecated Add {@link EntityDuplicateModifier}s to {@code blEntityDuplicationHelpers}</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 126 +     */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 127 +    @Deprecated</span>
 128      protected EntityDuplicateModifier&lt;Offer&gt; offerDuplicateModifier;
 129  
 130      @Override
 131      public List&lt;Offer&gt; findAllOffers() {
 132          return offerDao.readAllOffers();
 133      }
 134  
 135      @Override
 136      @Transactional(&quot;blTransactionManager&quot;)
 137      public Offer save(Offer offer) {
 138          return offerDao.save(offer);
 139      }
 140  
 141      @Override
 142      @Transactional(&quot;blTransactionManager&quot;)
 143      public OfferCode saveOfferCode(OfferCode offerCode) {
 144          offerCode.setOffer(offerDao.save(offerCode.getOffer()));
 145          return offerCodeDao.save(offerCode);
 146      }
 147  
 148      /**
 149       * Creates a list of offers that applies to this order.  All offers that are assigned to the customer,
 150       * entered during checkout, or has a delivery type of automatic are added to the list.  The same offer
 151       * cannot appear more than once in the list.
 152       *
 153       * @param code
 154       * @return a List of offers that may apply to this order
 155       */
 156      @Override
 157      public Offer lookupOfferByCode(String code) {
 158          Offer offer = null;
 159          OfferCode offerCode = offerCodeDao.readOfferCodeByCode(code);
 160          if (offerCode != null) {
 161              offer = offerCode.getOffer();
 162          }
 163          return offer;
 164      }
 165  
 166      @Override
 167      public OfferCode lookupOfferCodeByCode(String code){
 168          return offerCodeDao.readOfferCodeByCode(code);
 169      }
 170  
 171      @Override
 172      public List&lt;Offer&gt; lookupAllOffersByCode(String code) {
 173          List&lt;Offer&gt; offers = new ArrayList&lt;Offer&gt;();
 174          List&lt;OfferCode&gt; offerCodes = offerCodeDao.readAllOfferCodesByCode(code);
 175          for (OfferCode offerCode : offerCodes) {
 176              if (offerCode != null) {
 177                  offers.add(offerCode.getOffer());
 178              }
 179          }
 180          return offers;
 181      }
 182  
 183      @Override
 184      public List&lt;OfferCode&gt; lookupAllOfferCodesByCode(String code){
 185          return offerCodeDao.readAllOfferCodesByCode(code);
 186      }
 187  
 188      /**
 189       * Creates a list of offers that applies to this order.  All offers that are assigned to the customer,
 190       * entered during checkout, or has a delivery type of automatic are added to the list.  The same offer
 191       * cannot appear more than once in the list.
 192       *
 193       * @param order
 194       * @return a List of offers that may apply to this order
 195       */
 196      @Override
 197      public List&lt;Offer&gt; buildOfferListForOrder(Order order) {
 198          List&lt;Offer&gt; offers = new ArrayList&lt;Offer&gt;();
 199          List&lt;CustomerOffer&gt; customerOffers = lookupOfferCustomerByCustomer(order.getCustomer());
 200          for (CustomerOffer customerOffer : customerOffers) {
 201              if (!offers.contains(customerOffer.getOffer())) {
 202                  offers.add(customerOffer.getOffer());
 203              }
 204          }
 205          List&lt;OfferCode&gt; orderOfferCodes = refreshOfferCodesIfApplicable(order);
 206          orderOfferCodes = removeOutOfDateOfferCodes(orderOfferCodes);
 207          for (OfferCode orderOfferCode : orderOfferCodes) {
 208              if (!offers.contains(orderOfferCode.getOffer())) {
 209                  offers.add(orderOfferCode.getOffer());
 210              }
 211              extensionManager.getProxy().addAdditionalOffersForCode(offers, orderOfferCode);
 212          }
 213          List&lt;Offer&gt; globalOffers = lookupAutomaticDeliveryOffers();
 214          for (Offer globalOffer : globalOffers) {
 215              if (!offers.contains(globalOffer) &amp;&amp; verifyMaxCustomerUsageThreshold(order, globalOffer)) {
 216                  offers.add(globalOffer);
 217              }
 218          }
 219  
 220          if (extensionManager != null) {
 221              extensionManager.applyAdditionalFilters(offers, order);
 222          }
 223  
 224          return offers;
 225      }
 226  
 227      @Override
 228      public List&lt;OfferCode&gt; buildOfferCodeListForCustomer(Order order) {
 229          Customer customer = order.getCustomer();
 230          ArrayList&lt;OfferCode&gt; offerCodes = new ArrayList&lt;&gt;();
 231  
 232          if (extensionManager != null) {
 233              extensionManager.buildOfferCodeListForCustomer(customer, offerCodes);
 234          }
 235          if (!offerCodes.isEmpty()) {
 236              Iterator&lt;OfferCode&gt; itr = offerCodes.iterator();
 237              while (itr.hasNext()) {
 238                  OfferCode offerCode = itr.next();
 239                  if (!offerCode.isActive() || !verifyMaxCustomerUsageThreshold(order, offerCode)) {
 240                      itr.remove();
 241                  }
 242              }
 243          }
 244          return offerCodes;
 245      }
 246  
 247      @Deprecated
 248      @Override
 249      public List&lt;OfferCode&gt; buildOfferCodeListForCustomer(Customer customer) {
 250          ArrayList&lt;OfferCode&gt; offerCodes = new ArrayList&lt;OfferCode&gt;();
 251          if (extensionManager != null) {
 252              extensionManager.buildOfferCodeListForCustomer(customer, offerCodes);
 253          }
 254          if (!offerCodes.isEmpty()) {
 255              Iterator&lt;OfferCode&gt; itr = offerCodes.iterator();
 256              while (itr.hasNext()) {
 257                  OfferCode offerCode = itr.next();
 258                  if (!offerCode.isActive() || !verifyMaxCustomerUsageThreshold(customer, offerCode)) {
 259                      itr.remove();
 260                  }
 261              }
 262          }
 263          return offerCodes;
 264      }
 265  
 266      /**
 267       * Private method used to retrieve all offers assigned to this customer.  These offers are
 268       * programmatically assigned to the customer.
 269       *
 270       * @param customer
 271       * @return a List of offers assigned to the customer
 272       */
 273      protected List&lt;CustomerOffer&gt; lookupOfferCustomerByCustomer(Customer customer) {
 274          List&lt;CustomerOffer&gt; offerCustomers = customerOfferDao.readCustomerOffersByCustomer(customer);
 275          return offerCustomers;
 276      }
 277  
 278      /**
 279       * Private method used to retrieve all offers with automaticallyAdded set to true
 280       *
 281       * @return a List of automatic delivery offers
 282       */
 283      protected List&lt;Offer&gt; lookupAutomaticDeliveryOffers() {
 284          List&lt;Offer&gt; globalOffers = offerDao.readOffersByAutomaticDeliveryType();
 285          return globalOffers;
 286      }
 287  
 288      /**
 289       * Removes all out of date offerCodes based on the offerCode and its offer&#x27;s start and end
 290       * date.  If an offerCode has a later start date, that offerCode will be removed.
 291       * OfferCodes without a start date will still be processed. If the offerCode
 292       * has a end date that has already passed, that offerCode will be removed.  OfferCodes
 293       * without a end date will be processed.  The start and end dates on the offer will
 294       * still need to be evaluated.
 295       *
 296       * @param offerCodes
 297       * @return a List of non-expired offers
 298       */
 299      protected List&lt;OfferCode&gt; removeOutOfDateOfferCodes(List&lt;OfferCode&gt; offerCodes){
 300          List&lt;OfferCode&gt; offerCodesToRemove = new ArrayList&lt;OfferCode&gt;();
 301          for (OfferCode offerCode : offerCodes) {
 302              if (!offerCode.isActive()){
 303                  offerCodesToRemove.add(offerCode);
 304              }
 305          }
 306          // remove all offers in the offersToRemove list from original offers list
 307          for (OfferCode offerCode : offerCodesToRemove) {
 308              offerCodes.remove(offerCode);
 309          }
 310          return offerCodes;
 311      }
 312  
 313      /**
 314       * For enterprise installations, this will refresh any OfferCodes found to be out-of-date with
 315       * current sandbox status.
 316       *
 317       * @param order the order to check
 318       * @return the refreshed list of OfferCodes
 319       */
 320      protected List&lt;OfferCode&gt; refreshOfferCodesIfApplicable(final Order order) {
 321          final List&lt;OfferCode&gt; orderOfferCodes = order.getAddedOfferCodes();
 322  
 323          transUtil.runTransactionalOperation(new StreamCapableTransactionalOperationAdapter() {
 324              @Override
 325              public void execute() {
 326                  for (OfferCode offerCode : orderOfferCodes) {
 327                      if (offerCode.getOffer() != null) {
<abbr title=" 328                          Long sandBoxVersionId = sandBoxHelper.getSandBoxVersionId(OfferImpl.class, offerCode.getOffer().getId());"> 328                          Long sandBoxVersionId = sandBoxHelper.getSandBoxVersionId(OfferImpl.class, offerCode.getOfðŸ”µ</abbr>
<abbr title=" 329                          if (sandBoxVersionId != null &amp;&amp; !Objects.equals(sandBoxVersionId, offerCode.getOffer().getId())) {"> 329                          if (sandBoxVersionId != null &amp;&amp; !Objects.equals(sandBoxVersionId, offerCode.getOffer().getðŸ”µ</abbr>
 330                              em.refresh(offerCode);
 331                          }
 332                      }
 333                  }
 334              }
 335  
 336              @Override
 337              public boolean shouldRetryOnTransactionLockAcquisitionFailure() {
 338                  return true;
 339              }
 340          }, RuntimeException.class);
 341  
 342          return orderOfferCodes;
 343      }
 344  
 345      /*
 346       *
 347       * Offers Logic:
 348       * 1) Remove all existing offers in the Order (order, item, and fulfillment)
 349       * 2) Check and remove offers
 350       *    a) Remove out of date offers
 351       *    b) Remove offers that do not apply to this customer
 352       * 3) Loop through offers
 353       *    a) Verifies type of offer (order, order item, fulfillment)
 354       *    b) Verifies if offer can be applies
 355       *    c) Assign offer to type (order, order item, or fulfillment)
 356       * 4) Sorts the order and item offers list by priority and then discount
 357       * 5) Identify the best offers to apply to order item and create adjustments for each item offer
 358       * 6) Compare order item adjustment price to sales price, and remove adjustments if sale price is better
 359       * 7) Identify the best offers to apply to the order and create adjustments for each order offer
<abbr title=" 360       * 8) If item contains non-combinable offers remove either the item or order adjustments based on discount value"> 360       * 8) If item contains non-combinable offers remove either the item or order adjustments based on discount valðŸ”µ</abbr>
 361       * 9) Set final order item prices and reapply order offers
 362       *
 363       * Assumptions:
 364       * 1) % off all items will be created as an item offer with no expression
 365       * 2) $ off order will be created as an order offer
 366       * 3) Order offers applies to the best price for each item (not just retail price)
 367       * 4) Fulfillment offers apply to best price for each item (not just retail price)
<abbr title=" 368       * 5) Stackable only applies to the same offer type (i.e. a not stackable order offer can be used with item offers)"> 368       * 5) Stackable only applies to the same offer type (i.e. a not stackable order offer can be used with item ofðŸ”µ</abbr>
 369       * 6) Fulfillment offers cannot be not combinable
 370       * 7) Order offers cannot be FIXED_PRICE
 371       * 8) FIXED_PRICE offers cannot be stackable
<abbr title=" 372       * 9) Non-combinable offers only apply to the order and order items, fulfillment group offers will always apply"> 372       * 9) Non-combinable offers only apply to the order and order items, fulfillment group offers will always applðŸ”µ</abbr>
 373       *
 374       */
 375      @Override
 376      @Transactional(&quot;blTransactionManager&quot;)
 377      public Order applyAndSaveOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricingException {
 378          /*
 379          TODO rather than a threadlocal, we should update the &quot;shouldPrice&quot; boolean on the service API to
 380          use a richer object to describe the parameters of the pricing call. This object would include
 381          the pricing boolean, but would also include a list of activities to include or exclude in the
 382          call - see http://jira.broadleafcommerce.org/browse/BLC-664
 383           */
 384          OfferContext offerContext = OfferContext.getOfferContext();
 385          if (offerContext == null || offerContext.executePromotionCalculation) {
 386              PromotableOrder promotableOrder = promotableItemFactory.createPromotableOrder(order, false);
 387              List&lt;Offer&gt; filteredOffers = orderOfferProcessor.filterOffers(offers, order.getCustomer());
 388              if ((filteredOffers == null) || (filteredOffers.isEmpty())) {
 389                  if (LOG.isTraceEnabled()) {
 390                      LOG.trace(&quot;No offers applicable to this order.&quot;);
 391                  }
 392              } else {
<abbr title=" 393                  List&lt;PromotableCandidateOrderOffer&gt; qualifiedOrderOffers = new ArrayList&lt;PromotableCandidateOrderOffer&gt;();"> 393                  List&lt;PromotableCandidateOrderOffer&gt; qualifiedOrderOffers = new ArrayList&lt;PromotableCandidateOrderOðŸ”µ</abbr>
<abbr title=" 394                  List&lt;PromotableCandidateItemOffer&gt; qualifiedItemOffers = new ArrayList&lt;PromotableCandidateItemOffer&gt;();"> 394                  List&lt;PromotableCandidateItemOffer&gt; qualifiedItemOffers = new ArrayList&lt;PromotableCandidateItemOffeðŸ”µ</abbr>
 395  
<abbr title=" 396                  itemOfferProcessor.filterOffers(promotableOrder, filteredOffers, qualifiedOrderOffers, qualifiedItemOffers);"> 396                  itemOfferProcessor.filterOffers(promotableOrder, filteredOffers, qualifiedOrderOffers, qualifiedItðŸ”µ</abbr>
 397  
 398                  if (! (qualifiedItemOffers.isEmpty() &amp;&amp; qualifiedOrderOffers.isEmpty())) {
 399                      // At this point, we should have a PromotableOrder that contains PromotableItems each of which
 400                      // has a list of candidatePromotions that might be applied.
 401  
<abbr title=" 402                      // We also have a list of orderOffers that might apply and a list of itemOffers that might apply."> 402                      // We also have a list of orderOffers that might apply and a list of itemOffers that might appðŸ”µ</abbr>
<abbr title=" 403                      itemOfferProcessor.applyAndCompareOrderAndItemOffers(promotableOrder, qualifiedOrderOffers, qualifiedItemOffers);"> 403                      itemOfferProcessor.applyAndCompareOrderAndItemOffers(promotableOrder, qualifiedOrderOffers, quðŸ”µ</abbr>
 404                  }
 405              }
 406              orderOfferProcessor.synchronizeAdjustmentsAndPrices(promotableOrder);
 407  
 408              verifyAdjustments(order, true);
 409  
 410              order.setSubTotal(order.calculateSubTotal());
 411              order.finalizeItemPrices();
 412  
 413              order = orderService.save(order, false);
 414  
 415              boolean madeChange = verifyAdjustments(order, false);
 416              if (madeChange) {
 417                  order = orderService.save(order, false);
 418              }
 419          }
 420  
 421          return order;
 422      }
 423  
 424      protected boolean verifyAdjustments(Order order, boolean beforeSave) {
 425          boolean madeChange = false;
 426  
 427          if (order.getOrderItems() == null) {
 428              return madeChange;
 429          }
 430  
 431          for (OrderItem oi : order.getOrderItems()) {
 432              if (oi.getOrderItemPriceDetails() == null) {
 433                  continue;
 434              }
 435  
 436              for (OrderItemPriceDetail pd : oi.getOrderItemPriceDetails()) {
 437                  if (pd.getOrderItemPriceDetailAdjustments() == null) {
 438                      continue;
 439                  }
 440  
<abbr title=" 441                  Map&lt;Long, OrderItemPriceDetailAdjustment&gt; adjs = new HashMap&lt;Long, OrderItemPriceDetailAdjustment&gt;();"> 441                  Map&lt;Long, OrderItemPriceDetailAdjustment&gt; adjs = new HashMap&lt;Long, OrderItemPriceDetailAdjustment&gt;ðŸ”µ</abbr>
<abbr title=" 442                  List&lt;OrderItemPriceDetailAdjustment&gt; adjustmentsToRemove = new ArrayList&lt;OrderItemPriceDetailAdjustment&gt;();"> 442                  List&lt;OrderItemPriceDetailAdjustment&gt; adjustmentsToRemove = new ArrayList&lt;OrderItemPriceDetailAdjusðŸ”µ</abbr>
 443                  for (OrderItemPriceDetailAdjustment adj : pd.getOrderItemPriceDetailAdjustments()) {
 444                      if (adjs.containsKey(adj.getOffer().getId())) {
 445                          adjustmentsToRemove.add(adj);
 446                          if (LOG.isDebugEnabled()) {
 447                              StringBuilder sb = new StringBuilder(&quot;Detected collisions &quot;)
 448                                  .append(beforeSave ? &quot;before saving&quot; : &quot;after saving&quot;)
 449                                  .append(&quot; with ids &quot;)
 450                                  .append(adjs.get(adj.getOffer().getId()).getId())
 451                                  .append(&quot; and &quot;)
 452                                  .append(adj.getId());
 453                              LOG.debug(sb.toString());
 454                          }
 455                      } else {
 456                          adjs.put(adj.getOffer().getId(), adj);
 457                      }
 458                  }
 459  
 460                  for (OrderItemPriceDetailAdjustment adj : adjustmentsToRemove) {
 461                      pd.getOrderItemPriceDetailAdjustments().remove(adj);
 462                      madeChange = true;
 463                  }
 464              }
 465          }
 466  
 467          return madeChange;
 468       }
 469  
 470      @Override
 471      @Transactional(&quot;blTransactionManager&quot;)
 472      @Deprecated
 473      public void applyOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricingException {
 474          applyAndSaveOffersToOrder(offers, order);
 475      }
 476  
 477      @Override
 478      @Transactional(&quot;blTransactionManager&quot;)
 479      @Deprecated
 480      public void applyFulfillmentGroupOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricingException {
 481          applyAndSaveFulfillmentGroupOffersToOrder(offers, order);
 482      }
 483  
 484      @Override
 485      @Transactional(&quot;blTransactionManager&quot;)
<abbr title=" 486      public Order applyAndSaveFulfillmentGroupOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricingException {"> 486      public Order applyAndSaveFulfillmentGroupOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricingExceptioðŸ”µ</abbr>
 487          OfferContext offerContext = OfferContext.getOfferContext();
 488          if (offerContext == null || offerContext.executePromotionCalculation) {
 489              PromotableOrder promotableOrder =
 490                      promotableItemFactory.createPromotableOrder(order, true);
 491              List&lt;Offer&gt; possibleFGOffers = new ArrayList&lt;Offer&gt;();
 492              for (Offer offer : offers) {
 493                  if (offer.getType().getType().equals(OfferType.FULFILLMENT_GROUP.getType())) {
 494                      possibleFGOffers.add(offer);
 495                  }
 496              }
 497              List&lt;Offer&gt; filteredOffers = orderOfferProcessor.filterOffers(possibleFGOffers, order.getCustomer());
<abbr title=" 498              List&lt;PromotableCandidateFulfillmentGroupOffer&gt; qualifiedFGOffers = new ArrayList&lt;PromotableCandidateFulfillmentGroupOffer&gt;();"> 498              List&lt;PromotableCandidateFulfillmentGroupOffer&gt; qualifiedFGOffers = new ArrayList&lt;PromotableCandidateFuðŸ”µ</abbr>
 499              for (Offer offer : filteredOffers) {
<abbr title=" 500                  fulfillmentGroupOfferProcessor.filterFulfillmentGroupLevelOffer(promotableOrder, qualifiedFGOffers, offer);"> 500                  fulfillmentGroupOfferProcessor.filterFulfillmentGroupLevelOffer(promotableOrder, qualifiedFGOffersðŸ”µ</abbr>
 501              }
 502              if (!qualifiedFGOffers.isEmpty()) {
 503                  fulfillmentGroupOfferProcessor.applyAllFulfillmentGroupOffers(qualifiedFGOffers, promotableOrder);
 504                  fulfillmentGroupOfferProcessor.calculateFulfillmentGroupTotal(promotableOrder);
 505                  orderOfferProcessor.synchronizeAdjustmentsAndPrices(promotableOrder);
 506              }
 507  
 508              return orderService.save(order, false);
 509          }
 510          return order;
 511      }
 512  
 513      @Override
 514      public boolean verifyMaxCustomerUsageThreshold(Order order, Offer offer) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 515 -        Customer customer = order.getCustomer();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 516 -</span>
 517          if (offer.isLimitedUsePerCustomer()) {

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 518 -            Long currentUses = offerAuditService.countUsesByCustomer(order, customer.getId(), offer.getId());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 519 +            CustomerMaxUsesStrategyType strategy = offer.getMaxUsesStrategyType();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 520 +            boolean checkUsingCustomer = (strategy == null || strategy.equals(CustomerMaxUsesStrategyType.CUSTOMER));"> 520 +            boolean checkUsingCustomer = (strategy == null || strategy.equals(CustomerMaxUsesStrategyType.CUSTOMERðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 521 +            Long currentUses;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 522 +            if (checkUsingCustomer) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 523 +                currentUses = offerAuditService.countUsesByCustomer(order, order.getCustomer().getId(), offer.getId(), offer.getMinimumDaysPerUsage());"> 523 +                currentUses = offerAuditService.countUsesByCustomer(order, order.getCustomer().getId(), offer.getIðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 524 +            } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 525 +                currentUses = offerAuditService.countUsesByAccount(order, order.getBroadleafAccountId(), offer.getId(), offer.getMinimumDaysPerUsage());"> 525 +                currentUses = offerAuditService.countUsesByAccount(order, order.getBroadleafAccountId(), offer.getðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 526 +            }</span>
 527  
 528              if (currentUses &gt;= offer.getMaxUsesPerCustomer()) {
 529                  return false;
 530              }
 531          }
 532  
 533          return true;
 534      }
 535  
 536      @Deprecated
 537      @Override
 538      public boolean verifyMaxCustomerUsageThreshold(Customer customer, Offer offer) {
 539          if (offer.isLimitedUsePerCustomer()) {
 540              Long currentUses = offerAuditService.countUsesByCustomer(customer.getId(), offer.getId());
 541  
 542              if (currentUses &gt;= offer.getMaxUsesPerCustomer()) {
 543                  return false;
 544              }
 545          }
 546  
 547          return true;
 548      }
 549  
 550      @Override
 551      public boolean verifyMaxCustomerUsageThreshold(Order order, OfferCode code) {
 552          boolean underCodeMaxUses = true;
 553  
 554          if (code.isLimitedUse()) {
 555              Long currentCodeUses = offerAuditService.countOfferCodeUses(order, code.getId());
 556              underCodeMaxUses = currentCodeUses &lt; code.getMaxUses();
 557          }
 558  
 559          return underCodeMaxUses &amp;&amp; verifyMaxCustomerUsageThreshold(order, code.getOffer());
 560      }
 561  
 562      @Deprecated
 563      @Override
 564      public boolean verifyMaxCustomerUsageThreshold(Customer customer, OfferCode code) {
 565          boolean underCodeMaxUses = true;
 566          if (code.isLimitedUse()) {
 567              Long currentCodeUses = offerAuditService.countOfferCodeUses(code.getId());
 568              underCodeMaxUses = currentCodeUses &lt; code.getMaxUses();
 569          }
 570          return underCodeMaxUses &amp;&amp; verifyMaxCustomerUsageThreshold(customer, code.getOffer());
 571      }
 572  
 573      @Override
 574      @SuppressWarnings(&quot;unchecked&quot;)
 575      public Set&lt;Offer&gt; getUniqueOffersFromOrder(Order order) {
 576          HashSet&lt;Offer&gt; result = new HashSet&lt;Offer&gt;();
 577  
 578          Transformer adjustmentToOfferTransformer = new Transformer() {
 579  
 580              @Override
 581              public Object transform(Object input) {
 582                  return ((Adjustment)input).getOffer();
 583              }
 584          };
 585  
 586          result.addAll(CollectionUtils.collect(order.getOrderAdjustments(), adjustmentToOfferTransformer));
 587  
 588          if (order.getOrderItems() != null) {
 589              for (OrderItem item : order.getOrderItems()) {
<abbr title=" 590                  result.addAll(CollectionUtils.collect(item.getOrderItemAdjustments(), adjustmentToOfferTransformer));"> 590                  result.addAll(CollectionUtils.collect(item.getOrderItemAdjustments(), adjustmentToOfferTransformerðŸ”µ</abbr>
 591  
 592                  //record usage for price details on the item as well
 593                  if (item.getOrderItemPriceDetails() != null) {
 594                      for (OrderItemPriceDetail detail : item.getOrderItemPriceDetails()) {
<abbr title=" 595                          result.addAll(CollectionUtils.collect(detail.getOrderItemPriceDetailAdjustments(), adjustmentToOfferTransformer));"> 595                          result.addAll(CollectionUtils.collect(detail.getOrderItemPriceDetailAdjustments(), adjustmðŸ”µ</abbr>
 596                      }
 597                  }
 598              }
 599          }
 600  
 601          if (order.getFulfillmentGroups() != null) {
 602              for (FulfillmentGroup fg : order.getFulfillmentGroups()) {
<abbr title=" 603                  result.addAll(CollectionUtils.collect(fg.getFulfillmentGroupAdjustments(), adjustmentToOfferTransformer));"> 603                  result.addAll(CollectionUtils.collect(fg.getFulfillmentGroupAdjustments(), adjustmentToOfferTransfðŸ”µ</abbr>
 604              }
 605          }
 606          return result;
 607      }
 608  
 609      @Override
 610      public Map&lt;Offer, OfferCode&gt; getOffersRetrievedFromCodes(Order order)  {
 611          return getOffersRetrievedFromCodes(order.getAddedOfferCodes(), getUniqueOffersFromOrder(order));
 612      }
 613  
 614      @Override
 615      public Map&lt;Offer, OfferCode&gt; getOffersRetrievedFromCodes(List&lt;OfferCode&gt; codes, Set&lt;Offer&gt; appliedOffers) {
 616          HashMap&lt;Offer, OfferCode&gt; offerToCodeMapping = new HashMap&lt;Offer, OfferCode&gt;();
 617          for (OfferCode code : codes) {
 618              if (appliedOffers.contains(code.getOffer())) {
 619                  offerToCodeMapping.put(code.getOffer(), code);
 620              }
 621  
 622              List&lt;Offer&gt; additionalOffersToBeApplied = new ArrayList&lt;Offer&gt;();
 623  
 624              extensionManager.getProxy().addAdditionalOffersForCode(additionalOffersToBeApplied, code);
 625              for (Offer additionalOfferToBeApplied : additionalOffersToBeApplied) {
 626                  offerToCodeMapping.put(additionalOfferToBeApplied, code);
 627              }
 628          }
 629          return offerToCodeMapping;
 630      }
 631  
 632      @Override
 633      @Transactional(&quot;blTransactionManager&quot;)
 634      public Boolean deleteOfferCode(OfferCode code) {
 635          if (offerCodeDao.offerCodeIsUsed(code)) {
 636              return false;
 637          }
 638  
 639          offerCodeDao.delete(code);
 640          return true;
 641      }
 642  
 643      @Transactional(&quot;blTransactionManager&quot;)
 644      @Override
 645      public Offer duplicate(Long originalOfferId) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 646 -        Map&lt;String, String&gt; copyHints = new HashMap&lt;String, String&gt;();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 647 -        copyHints.put(OfferImpl.EXCLUDE_OFFERCODE_COPY_HINT, &quot;true&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 648 -        return duplicator.copy(OfferImpl.class, originalOfferId, copyHints, offerDuplicateModifier);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 649 +        return duplicator.copy(OfferImpl.class, originalOfferId);</span>
 650      }
 651  
 652      @Override
 653      public CustomerOfferDao getCustomerOfferDao() {
 654          return customerOfferDao;
 655      }
 656  
 657      @Override
 658      public void setCustomerOfferDao(CustomerOfferDao customerOfferDao) {
 659          this.customerOfferDao = customerOfferDao;
 660      }
 661  
 662      @Override
 663      public OfferCodeDao getOfferCodeDao() {
 664          return offerCodeDao;
 665      }
 666  
 667      @Override
 668      public void setOfferCodeDao(OfferCodeDao offerCodeDao) {
 669          this.offerCodeDao = offerCodeDao;
 670      }
 671  
 672      @Override
 673      public OfferDao getOfferDao() {
 674          return offerDao;
 675      }
 676  
 677      @Override
 678      public void setOfferDao(OfferDao offerDao) {
 679          this.offerDao = offerDao;
 680      }
 681  
 682      @Override
 683      public OrderOfferProcessor getOrderOfferProcessor() {
 684          return orderOfferProcessor;
 685      }
 686  
 687      @Override
 688      public void setOrderOfferProcessor(OrderOfferProcessor orderOfferProcessor) {
 689          this.orderOfferProcessor = orderOfferProcessor;
 690      }
 691  
 692      @Override
 693      public ItemOfferProcessor getItemOfferProcessor() {
 694          return itemOfferProcessor;
 695      }
 696  
 697      @Override
 698      public void setItemOfferProcessor(ItemOfferProcessor itemOfferProcessor) {
 699          this.itemOfferProcessor = itemOfferProcessor;
 700      }
 701  
 702      @Override
 703      public FulfillmentGroupOfferProcessor getFulfillmentGroupOfferProcessor() {
 704          return fulfillmentGroupOfferProcessor;
 705      }
 706  
 707      @Override
 708      public void setFulfillmentGroupOfferProcessor(FulfillmentGroupOfferProcessor fulfillmentGroupOfferProcessor) {
 709          this.fulfillmentGroupOfferProcessor = fulfillmentGroupOfferProcessor;
 710      }
 711  
 712      @Override
 713      public PromotableItemFactory getPromotableItemFactory() {
 714          return promotableItemFactory;
 715      }
 716  
 717      @Override
 718      public void setPromotableItemFactory(PromotableItemFactory promotableItemFactory) {
 719          this.promotableItemFactory = promotableItemFactory;
 720      }
 721  
 722      @Override
 723      public OfferCode findOfferCodeById(Long id) {
 724          return offerCodeDao.readOfferCodeById(id);
 725      }
 726  
 727      @Override
 728      public List&lt;OfferCode&gt; findOfferCodesByIds(Collection&lt;Long&gt; ids) {
 729          return offerCodeDao.readOfferCodesByIds(ids);
 730      }
 731  
 732      @Override
 733      public OrderService getOrderService() {
 734          return orderService;
 735      }
 736  
 737      @Override
 738      public void setOrderService(OrderService orderService) {
 739          this.orderService = orderService;
 740      }
 741  
 742      @Override
 743      public Offer findOfferById(Long offerId) {
 744          return offerDao.readOfferById(offerId);
 745      }
 746  }</pre></td>
                            <td><pre>   1  /*
   2   * #%L
   3   * BroadleafCommerce Framework
   4   * %%
   5   * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6   * %%
   7   * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8   * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9   * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10   * the Broadleaf End User License Agreement (EULA), Version 1.1
  11   * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12   * shall apply.
  13   *
<abbr title="  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr>
  15   * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.
  16   * #L%
  17   */
  18  package org.broadleafcommerce.core.offer.service;
  19  
  20  import org.apache.commons.collections.CollectionUtils;
  21  import org.apache.commons.collections.Transformer;
  22  import org.apache.commons.logging.Log;
  23  import org.apache.commons.logging.LogFactory;
  24  import org.broadleafcommerce.common.persistence.EntityDuplicateModifier;
  25  import org.broadleafcommerce.common.persistence.EntityDuplicator;
  26  import org.broadleafcommerce.common.sandbox.SandBoxHelper;
  27  import org.broadleafcommerce.common.util.StreamCapableTransactionalOperationAdapter;
  28  import org.broadleafcommerce.common.util.StreamingTransactionCapableUtil;
  29  import org.broadleafcommerce.core.offer.dao.CustomerOfferDao;
  30  import org.broadleafcommerce.core.offer.dao.OfferCodeDao;
  31  import org.broadleafcommerce.core.offer.dao.OfferDao;
  32  import org.broadleafcommerce.core.offer.domain.Adjustment;
  33  import org.broadleafcommerce.core.offer.domain.CustomerOffer;
  34  import org.broadleafcommerce.core.offer.domain.Offer;
  35  import org.broadleafcommerce.core.offer.domain.OfferCode;
  36  import org.broadleafcommerce.core.offer.domain.OfferImpl;
  37  import org.broadleafcommerce.core.offer.domain.OrderItemPriceDetailAdjustment;
  38  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableCandidateFulfillmentGroupOffer;
  39  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableCandidateItemOffer;
  40  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableCandidateOrderOffer;
  41  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableItemFactory;
  42  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrder;
  43  import org.broadleafcommerce.core.offer.service.processor.FulfillmentGroupOfferProcessor;
  44  import org.broadleafcommerce.core.offer.service.processor.ItemOfferProcessor;
  45  import org.broadleafcommerce.core.offer.service.processor.OrderOfferProcessor;

  46  import org.broadleafcommerce.core.offer.service.type.OfferType;
  47  import org.broadleafcommerce.core.order.domain.FulfillmentGroup;
  48  import org.broadleafcommerce.core.order.domain.Order;
  49  import org.broadleafcommerce.core.order.domain.OrderItem;
  50  import org.broadleafcommerce.core.order.domain.OrderItemPriceDetail;
  51  import org.broadleafcommerce.core.order.service.OrderService;
  52  import org.broadleafcommerce.core.pricing.service.exception.PricingException;
  53  import org.broadleafcommerce.profile.core.domain.Customer;
  54  import org.springframework.stereotype.Service;
  55  import org.springframework.transaction.annotation.Transactional;
  56  
  57  import java.util.ArrayList;
  58  import java.util.Collection;
  59  import java.util.HashMap;
  60  import java.util.HashSet;
  61  import java.util.Iterator;
  62  import java.util.List;
  63  import java.util.Map;
  64  import java.util.Objects;
  65  import java.util.Set;
  66  
  67  import javax.annotation.Resource;
  68  import javax.persistence.EntityManager;
  69  import javax.persistence.PersistenceContext;
  70  
  71  /**
  72   * The Class OfferServiceImpl.
  73   */
  74  @Service(&quot;blOfferService&quot;)
  75  public class OfferServiceImpl implements OfferService {
  76  
  77      private static final Log LOG = LogFactory.getLog(OfferServiceImpl.class);
  78  
  79      // should be called outside of Offer service after Offer service is executed
  80      @Resource(name=&quot;blCustomerOfferDao&quot;)
  81      protected CustomerOfferDao customerOfferDao;
  82  
  83      @Resource(name=&quot;blOfferCodeDao&quot;)
  84      protected OfferCodeDao offerCodeDao;
  85  
  86      @Resource(name=&quot;blOfferAuditService&quot;)
  87      protected OfferAuditService offerAuditService;
  88  
  89      @Resource(name=&quot;blOfferDao&quot;)
  90      protected OfferDao offerDao;
  91  
  92      @Resource(name=&quot;blOrderOfferProcessor&quot;)
  93      protected OrderOfferProcessor orderOfferProcessor;
  94  
  95      @Resource(name=&quot;blItemOfferProcessor&quot;)
  96      protected ItemOfferProcessor itemOfferProcessor;
  97  
  98      @Resource(name=&quot;blFulfillmentGroupOfferProcessor&quot;)
  99      protected FulfillmentGroupOfferProcessor fulfillmentGroupOfferProcessor;
 100  
 101      @Resource(name=&quot;blPromotableItemFactory&quot;)
 102      protected PromotableItemFactory promotableItemFactory;
 103  
 104      @Resource(name = &quot;blOfferServiceExtensionManager&quot;)
 105      protected OfferServiceExtensionManager extensionManager;
 106  
 107      @Resource(name = &quot;blOrderService&quot;)
 108      protected OrderService orderService;
 109  
 110      @Resource(name = &quot;blSandBoxHelper&quot;)
 111      protected SandBoxHelper sandBoxHelper;
 112  
 113      @PersistenceContext(unitName=&quot;blPU&quot;)
 114      protected EntityManager em;
 115  
 116      @Resource(name=&quot;blStreamingTransactionCapableUtil&quot;)
 117      protected StreamingTransactionCapableUtil transUtil;
 118  
 119      @Resource(name=&quot;blEntityDuplicator&quot;)
 120      protected EntityDuplicator duplicator;
 121  
 122      @Resource(name=&quot;blOfferDuplicateModifier&quot;)




 123      protected EntityDuplicateModifier&lt;Offer&gt; offerDuplicateModifier;
 124  
 125      @Override
 126      public List&lt;Offer&gt; findAllOffers() {
 127          return offerDao.readAllOffers();
 128      }
 129  
 130      @Override
 131      @Transactional(&quot;blTransactionManager&quot;)
 132      public Offer save(Offer offer) {
 133          return offerDao.save(offer);
 134      }
 135  
 136      @Override
 137      @Transactional(&quot;blTransactionManager&quot;)
 138      public OfferCode saveOfferCode(OfferCode offerCode) {
 139          offerCode.setOffer(offerDao.save(offerCode.getOffer()));
 140          return offerCodeDao.save(offerCode);
 141      }
 142  
 143      /**
 144       * Creates a list of offers that applies to this order.  All offers that are assigned to the customer,
 145       * entered during checkout, or has a delivery type of automatic are added to the list.  The same offer
 146       * cannot appear more than once in the list.
 147       *
 148       * @param code
 149       * @return a List of offers that may apply to this order
 150       */
 151      @Override
 152      public Offer lookupOfferByCode(String code) {
 153          Offer offer = null;
 154          OfferCode offerCode = offerCodeDao.readOfferCodeByCode(code);
 155          if (offerCode != null) {
 156              offer = offerCode.getOffer();
 157          }
 158          return offer;
 159      }
 160  
 161      @Override
 162      public OfferCode lookupOfferCodeByCode(String code){
 163          return offerCodeDao.readOfferCodeByCode(code);
 164      }
 165  
 166      @Override
 167      public List&lt;Offer&gt; lookupAllOffersByCode(String code) {
 168          List&lt;Offer&gt; offers = new ArrayList&lt;Offer&gt;();
 169          List&lt;OfferCode&gt; offerCodes = offerCodeDao.readAllOfferCodesByCode(code);
 170          for (OfferCode offerCode : offerCodes) {
 171              if (offerCode != null) {
 172                  offers.add(offerCode.getOffer());
 173              }
 174          }
 175          return offers;
 176      }
 177  
 178      @Override
 179      public List&lt;OfferCode&gt; lookupAllOfferCodesByCode(String code){
 180          return offerCodeDao.readAllOfferCodesByCode(code);
 181      }
 182  
 183      /**
 184       * Creates a list of offers that applies to this order.  All offers that are assigned to the customer,
 185       * entered during checkout, or has a delivery type of automatic are added to the list.  The same offer
 186       * cannot appear more than once in the list.
 187       *
 188       * @param order
 189       * @return a List of offers that may apply to this order
 190       */
 191      @Override
 192      public List&lt;Offer&gt; buildOfferListForOrder(Order order) {
 193          List&lt;Offer&gt; offers = new ArrayList&lt;Offer&gt;();
 194          List&lt;CustomerOffer&gt; customerOffers = lookupOfferCustomerByCustomer(order.getCustomer());
 195          for (CustomerOffer customerOffer : customerOffers) {
 196              if (!offers.contains(customerOffer.getOffer())) {
 197                  offers.add(customerOffer.getOffer());
 198              }
 199          }
 200          List&lt;OfferCode&gt; orderOfferCodes = refreshOfferCodesIfApplicable(order);
 201          orderOfferCodes = removeOutOfDateOfferCodes(orderOfferCodes);
 202          for (OfferCode orderOfferCode : orderOfferCodes) {
 203              if (!offers.contains(orderOfferCode.getOffer())) {
 204                  offers.add(orderOfferCode.getOffer());
 205              }
 206              extensionManager.getProxy().addAdditionalOffersForCode(offers, orderOfferCode);
 207          }
 208          List&lt;Offer&gt; globalOffers = lookupAutomaticDeliveryOffers();
 209          for (Offer globalOffer : globalOffers) {
 210              if (!offers.contains(globalOffer) &amp;&amp; verifyMaxCustomerUsageThreshold(order, globalOffer)) {
 211                  offers.add(globalOffer);
 212              }
 213          }
 214  
 215          if (extensionManager != null) {
 216              extensionManager.applyAdditionalFilters(offers, order);
 217          }
 218  
 219          return offers;
 220      }
 221  
 222      @Override
 223      public List&lt;OfferCode&gt; buildOfferCodeListForCustomer(Order order) {
 224          Customer customer = order.getCustomer();
 225          ArrayList&lt;OfferCode&gt; offerCodes = new ArrayList&lt;&gt;();
 226  
 227          if (extensionManager != null) {
 228              extensionManager.buildOfferCodeListForCustomer(customer, offerCodes);
 229          }
 230          if (!offerCodes.isEmpty()) {
 231              Iterator&lt;OfferCode&gt; itr = offerCodes.iterator();
 232              while (itr.hasNext()) {
 233                  OfferCode offerCode = itr.next();
 234                  if (!offerCode.isActive() || !verifyMaxCustomerUsageThreshold(order, offerCode)) {
 235                      itr.remove();
 236                  }
 237              }
 238          }
 239          return offerCodes;
 240      }
 241  
 242      @Deprecated
 243      @Override
 244      public List&lt;OfferCode&gt; buildOfferCodeListForCustomer(Customer customer) {
 245          ArrayList&lt;OfferCode&gt; offerCodes = new ArrayList&lt;OfferCode&gt;();
 246          if (extensionManager != null) {
 247              extensionManager.buildOfferCodeListForCustomer(customer, offerCodes);
 248          }
 249          if (!offerCodes.isEmpty()) {
 250              Iterator&lt;OfferCode&gt; itr = offerCodes.iterator();
 251              while (itr.hasNext()) {
 252                  OfferCode offerCode = itr.next();
 253                  if (!offerCode.isActive() || !verifyMaxCustomerUsageThreshold(customer, offerCode)) {
 254                      itr.remove();
 255                  }
 256              }
 257          }
 258          return offerCodes;
 259      }
 260  
 261      /**
 262       * Private method used to retrieve all offers assigned to this customer.  These offers are
 263       * programmatically assigned to the customer.
 264       *
 265       * @param customer
 266       * @return a List of offers assigned to the customer
 267       */
 268      protected List&lt;CustomerOffer&gt; lookupOfferCustomerByCustomer(Customer customer) {
 269          List&lt;CustomerOffer&gt; offerCustomers = customerOfferDao.readCustomerOffersByCustomer(customer);
 270          return offerCustomers;
 271      }
 272  
 273      /**
 274       * Private method used to retrieve all offers with automaticallyAdded set to true
 275       *
 276       * @return a List of automatic delivery offers
 277       */
 278      protected List&lt;Offer&gt; lookupAutomaticDeliveryOffers() {
 279          List&lt;Offer&gt; globalOffers = offerDao.readOffersByAutomaticDeliveryType();
 280          return globalOffers;
 281      }
 282  
 283      /**
 284       * Removes all out of date offerCodes based on the offerCode and its offer&#x27;s start and end
 285       * date.  If an offerCode has a later start date, that offerCode will be removed.
 286       * OfferCodes without a start date will still be processed. If the offerCode
 287       * has a end date that has already passed, that offerCode will be removed.  OfferCodes
 288       * without a end date will be processed.  The start and end dates on the offer will
 289       * still need to be evaluated.
 290       *
 291       * @param offerCodes
 292       * @return a List of non-expired offers
 293       */
 294      protected List&lt;OfferCode&gt; removeOutOfDateOfferCodes(List&lt;OfferCode&gt; offerCodes){
 295          List&lt;OfferCode&gt; offerCodesToRemove = new ArrayList&lt;OfferCode&gt;();
 296          for (OfferCode offerCode : offerCodes) {
 297              if (!offerCode.isActive()){
 298                  offerCodesToRemove.add(offerCode);
 299              }
 300          }
 301          // remove all offers in the offersToRemove list from original offers list
 302          for (OfferCode offerCode : offerCodesToRemove) {
 303              offerCodes.remove(offerCode);
 304          }
 305          return offerCodes;
 306      }
 307  
 308      /**
 309       * For enterprise installations, this will refresh any OfferCodes found to be out-of-date with
 310       * current sandbox status.
 311       *
 312       * @param order the order to check
 313       * @return the refreshed list of OfferCodes
 314       */
 315      protected List&lt;OfferCode&gt; refreshOfferCodesIfApplicable(final Order order) {
 316          final List&lt;OfferCode&gt; orderOfferCodes = order.getAddedOfferCodes();
 317  
 318          transUtil.runTransactionalOperation(new StreamCapableTransactionalOperationAdapter() {
 319              @Override
 320              public void execute() {
 321                  for (OfferCode offerCode : orderOfferCodes) {
 322                      if (offerCode.getOffer() != null) {
<abbr title=" 323                          Long sandBoxVersionId = sandBoxHelper.getSandBoxVersionId(OfferImpl.class, offerCode.getOffer().getId());"> 323                          Long sandBoxVersionId = sandBoxHelper.getSandBoxVersionId(OfferImpl.class, offerCode.getOfðŸ”µ</abbr>
<abbr title=" 324                          if (sandBoxVersionId != null &amp;&amp; !Objects.equals(sandBoxVersionId, offerCode.getOffer().getId())) {"> 324                          if (sandBoxVersionId != null &amp;&amp; !Objects.equals(sandBoxVersionId, offerCode.getOffer().getðŸ”µ</abbr>
 325                              em.refresh(offerCode);
 326                          }
 327                      }
 328                  }
 329              }
 330  
 331              @Override
 332              public boolean shouldRetryOnTransactionLockAcquisitionFailure() {
 333                  return true;
 334              }
 335          }, RuntimeException.class);
 336  
 337          return orderOfferCodes;
 338      }
 339  
 340      /*
 341       *
 342       * Offers Logic:
 343       * 1) Remove all existing offers in the Order (order, item, and fulfillment)
 344       * 2) Check and remove offers
 345       *    a) Remove out of date offers
 346       *    b) Remove offers that do not apply to this customer
 347       * 3) Loop through offers
 348       *    a) Verifies type of offer (order, order item, fulfillment)
 349       *    b) Verifies if offer can be applies
 350       *    c) Assign offer to type (order, order item, or fulfillment)
 351       * 4) Sorts the order and item offers list by priority and then discount
 352       * 5) Identify the best offers to apply to order item and create adjustments for each item offer
 353       * 6) Compare order item adjustment price to sales price, and remove adjustments if sale price is better
 354       * 7) Identify the best offers to apply to the order and create adjustments for each order offer
<abbr title=" 355       * 8) If item contains non-combinable offers remove either the item or order adjustments based on discount value"> 355       * 8) If item contains non-combinable offers remove either the item or order adjustments based on discount valðŸ”µ</abbr>
 356       * 9) Set final order item prices and reapply order offers
 357       *
 358       * Assumptions:
 359       * 1) % off all items will be created as an item offer with no expression
 360       * 2) $ off order will be created as an order offer
 361       * 3) Order offers applies to the best price for each item (not just retail price)
 362       * 4) Fulfillment offers apply to best price for each item (not just retail price)
<abbr title=" 363       * 5) Stackable only applies to the same offer type (i.e. a not stackable order offer can be used with item offers)"> 363       * 5) Stackable only applies to the same offer type (i.e. a not stackable order offer can be used with item ofðŸ”µ</abbr>
 364       * 6) Fulfillment offers cannot be not combinable
 365       * 7) Order offers cannot be FIXED_PRICE
 366       * 8) FIXED_PRICE offers cannot be stackable
<abbr title=" 367       * 9) Non-combinable offers only apply to the order and order items, fulfillment group offers will always apply"> 367       * 9) Non-combinable offers only apply to the order and order items, fulfillment group offers will always applðŸ”µ</abbr>
 368       *
 369       */
 370      @Override
 371      @Transactional(&quot;blTransactionManager&quot;)
 372      public Order applyAndSaveOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricingException {
 373          /*
 374          TODO rather than a threadlocal, we should update the &quot;shouldPrice&quot; boolean on the service API to
 375          use a richer object to describe the parameters of the pricing call. This object would include
 376          the pricing boolean, but would also include a list of activities to include or exclude in the
 377          call - see http://jira.broadleafcommerce.org/browse/BLC-664
 378           */
 379          OfferContext offerContext = OfferContext.getOfferContext();
 380          if (offerContext == null || offerContext.executePromotionCalculation) {
 381              PromotableOrder promotableOrder = promotableItemFactory.createPromotableOrder(order, false);
 382              List&lt;Offer&gt; filteredOffers = orderOfferProcessor.filterOffers(offers, order.getCustomer());
 383              if ((filteredOffers == null) || (filteredOffers.isEmpty())) {
 384                  if (LOG.isTraceEnabled()) {
 385                      LOG.trace(&quot;No offers applicable to this order.&quot;);
 386                  }
 387              } else {
<abbr title=" 388                  List&lt;PromotableCandidateOrderOffer&gt; qualifiedOrderOffers = new ArrayList&lt;PromotableCandidateOrderOffer&gt;();"> 388                  List&lt;PromotableCandidateOrderOffer&gt; qualifiedOrderOffers = new ArrayList&lt;PromotableCandidateOrderOðŸ”µ</abbr>
<abbr title=" 389                  List&lt;PromotableCandidateItemOffer&gt; qualifiedItemOffers = new ArrayList&lt;PromotableCandidateItemOffer&gt;();"> 389                  List&lt;PromotableCandidateItemOffer&gt; qualifiedItemOffers = new ArrayList&lt;PromotableCandidateItemOffeðŸ”µ</abbr>
 390  
<abbr title=" 391                  itemOfferProcessor.filterOffers(promotableOrder, filteredOffers, qualifiedOrderOffers, qualifiedItemOffers);"> 391                  itemOfferProcessor.filterOffers(promotableOrder, filteredOffers, qualifiedOrderOffers, qualifiedItðŸ”µ</abbr>
 392  
 393                  if (! (qualifiedItemOffers.isEmpty() &amp;&amp; qualifiedOrderOffers.isEmpty())) {
 394                      // At this point, we should have a PromotableOrder that contains PromotableItems each of which
 395                      // has a list of candidatePromotions that might be applied.
 396  
<abbr title=" 397                      // We also have a list of orderOffers that might apply and a list of itemOffers that might apply."> 397                      // We also have a list of orderOffers that might apply and a list of itemOffers that might appðŸ”µ</abbr>
<abbr title=" 398                      itemOfferProcessor.applyAndCompareOrderAndItemOffers(promotableOrder, qualifiedOrderOffers, qualifiedItemOffers);"> 398                      itemOfferProcessor.applyAndCompareOrderAndItemOffers(promotableOrder, qualifiedOrderOffers, quðŸ”µ</abbr>
 399                  }
 400              }
 401              orderOfferProcessor.synchronizeAdjustmentsAndPrices(promotableOrder);
 402  
 403              verifyAdjustments(order, true);
 404  
 405              order.setSubTotal(order.calculateSubTotal());
 406              order.finalizeItemPrices();
 407  
 408              order = orderService.save(order, false);
 409  
 410              boolean madeChange = verifyAdjustments(order, false);
 411              if (madeChange) {
 412                  order = orderService.save(order, false);
 413              }
 414          }
 415  
 416          return order;
 417      }
 418  
 419      protected boolean verifyAdjustments(Order order, boolean beforeSave) {
 420          boolean madeChange = false;
 421  
 422          if (order.getOrderItems() == null) {
 423              return madeChange;
 424          }
 425  
 426          for (OrderItem oi : order.getOrderItems()) {
 427              if (oi.getOrderItemPriceDetails() == null) {
 428                  continue;
 429              }
 430  
 431              for (OrderItemPriceDetail pd : oi.getOrderItemPriceDetails()) {
 432                  if (pd.getOrderItemPriceDetailAdjustments() == null) {
 433                      continue;
 434                  }
 435  
<abbr title=" 436                  Map&lt;Long, OrderItemPriceDetailAdjustment&gt; adjs = new HashMap&lt;Long, OrderItemPriceDetailAdjustment&gt;();"> 436                  Map&lt;Long, OrderItemPriceDetailAdjustment&gt; adjs = new HashMap&lt;Long, OrderItemPriceDetailAdjustment&gt;ðŸ”µ</abbr>
<abbr title=" 437                  List&lt;OrderItemPriceDetailAdjustment&gt; adjustmentsToRemove = new ArrayList&lt;OrderItemPriceDetailAdjustment&gt;();"> 437                  List&lt;OrderItemPriceDetailAdjustment&gt; adjustmentsToRemove = new ArrayList&lt;OrderItemPriceDetailAdjusðŸ”µ</abbr>
 438                  for (OrderItemPriceDetailAdjustment adj : pd.getOrderItemPriceDetailAdjustments()) {
 439                      if (adjs.containsKey(adj.getOffer().getId())) {
 440                          adjustmentsToRemove.add(adj);
 441                          if (LOG.isDebugEnabled()) {
 442                              StringBuilder sb = new StringBuilder(&quot;Detected collisions &quot;)
 443                                  .append(beforeSave ? &quot;before saving&quot; : &quot;after saving&quot;)
 444                                  .append(&quot; with ids &quot;)
 445                                  .append(adjs.get(adj.getOffer().getId()).getId())
 446                                  .append(&quot; and &quot;)
 447                                  .append(adj.getId());
 448                              LOG.debug(sb.toString());
 449                          }
 450                      } else {
 451                          adjs.put(adj.getOffer().getId(), adj);
 452                      }
 453                  }
 454  
 455                  for (OrderItemPriceDetailAdjustment adj : adjustmentsToRemove) {
 456                      pd.getOrderItemPriceDetailAdjustments().remove(adj);
 457                      madeChange = true;
 458                  }
 459              }
 460          }
 461  
 462          return madeChange;
 463       }
 464  
 465      @Override
 466      @Transactional(&quot;blTransactionManager&quot;)
 467      @Deprecated
 468      public void applyOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricingException {
 469          applyAndSaveOffersToOrder(offers, order);
 470      }
 471  
 472      @Override
 473      @Transactional(&quot;blTransactionManager&quot;)
 474      @Deprecated
 475      public void applyFulfillmentGroupOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricingException {
 476          applyAndSaveFulfillmentGroupOffersToOrder(offers, order);
 477      }
 478  
 479      @Override
 480      @Transactional(&quot;blTransactionManager&quot;)
<abbr title=" 481      public Order applyAndSaveFulfillmentGroupOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricingException {"> 481      public Order applyAndSaveFulfillmentGroupOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricingExceptioðŸ”µ</abbr>
 482          OfferContext offerContext = OfferContext.getOfferContext();
 483          if (offerContext == null || offerContext.executePromotionCalculation) {
 484              PromotableOrder promotableOrder =
 485                      promotableItemFactory.createPromotableOrder(order, true);
 486              List&lt;Offer&gt; possibleFGOffers = new ArrayList&lt;Offer&gt;();
 487              for (Offer offer : offers) {
 488                  if (offer.getType().getType().equals(OfferType.FULFILLMENT_GROUP.getType())) {
 489                      possibleFGOffers.add(offer);
 490                  }
 491              }
 492              List&lt;Offer&gt; filteredOffers = orderOfferProcessor.filterOffers(possibleFGOffers, order.getCustomer());
<abbr title=" 493              List&lt;PromotableCandidateFulfillmentGroupOffer&gt; qualifiedFGOffers = new ArrayList&lt;PromotableCandidateFulfillmentGroupOffer&gt;();"> 493              List&lt;PromotableCandidateFulfillmentGroupOffer&gt; qualifiedFGOffers = new ArrayList&lt;PromotableCandidateFuðŸ”µ</abbr>
 494              for (Offer offer : filteredOffers) {
<abbr title=" 495                  fulfillmentGroupOfferProcessor.filterFulfillmentGroupLevelOffer(promotableOrder, qualifiedFGOffers, offer);"> 495                  fulfillmentGroupOfferProcessor.filterFulfillmentGroupLevelOffer(promotableOrder, qualifiedFGOffersðŸ”µ</abbr>
 496              }
 497              if (!qualifiedFGOffers.isEmpty()) {
 498                  fulfillmentGroupOfferProcessor.applyAllFulfillmentGroupOffers(qualifiedFGOffers, promotableOrder);
 499                  fulfillmentGroupOfferProcessor.calculateFulfillmentGroupTotal(promotableOrder);
 500                  orderOfferProcessor.synchronizeAdjustmentsAndPrices(promotableOrder);
 501              }
 502  
 503              return orderService.save(order, false);
 504          }
 505          return order;
 506      }
 507  
 508      @Override
 509      public boolean verifyMaxCustomerUsageThreshold(Order order, Offer offer) {
 510          Customer customer = order.getCustomer();
 511  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 512 -        if (offer.isLimitedUsePerCustomer()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 513 +        if (customer != null &amp;&amp; customer.isRegistered() &amp;&amp; offer.isLimitedUsePerCustomer()) {</span>
 514              Long currentUses = offerAuditService.countUsesByCustomer(order, customer.getId(), offer.getId());








 515  
 516              if (currentUses &gt;= offer.getMaxUsesPerCustomer()) {
 517                  return false;
 518              }
 519          }
 520  
 521          return true;
 522      }
 523  
 524      @Deprecated
 525      @Override
 526      public boolean verifyMaxCustomerUsageThreshold(Customer customer, Offer offer) {
 527          if (offer.isLimitedUsePerCustomer()) {
 528              Long currentUses = offerAuditService.countUsesByCustomer(customer.getId(), offer.getId());
 529  
 530              if (currentUses &gt;= offer.getMaxUsesPerCustomer()) {
 531                  return false;
 532              }
 533          }
 534  
 535          return true;
 536      }
 537  
 538      @Override
 539      public boolean verifyMaxCustomerUsageThreshold(Order order, OfferCode code) {
 540          boolean underCodeMaxUses = true;
 541  
 542          if (code.isLimitedUse()) {
 543              Long currentCodeUses = offerAuditService.countOfferCodeUses(order, code.getId());
 544              underCodeMaxUses = currentCodeUses &lt; code.getMaxUses();
 545          }
 546  
 547          return underCodeMaxUses &amp;&amp; verifyMaxCustomerUsageThreshold(order, code.getOffer());
 548      }
 549  
 550      @Deprecated
 551      @Override
 552      public boolean verifyMaxCustomerUsageThreshold(Customer customer, OfferCode code) {
 553          boolean underCodeMaxUses = true;
 554          if (code.isLimitedUse()) {
 555              Long currentCodeUses = offerAuditService.countOfferCodeUses(code.getId());
 556              underCodeMaxUses = currentCodeUses &lt; code.getMaxUses();
 557          }
 558          return underCodeMaxUses &amp;&amp; verifyMaxCustomerUsageThreshold(customer, code.getOffer());
 559      }
 560  
 561      @Override
 562      @SuppressWarnings(&quot;unchecked&quot;)
 563      public Set&lt;Offer&gt; getUniqueOffersFromOrder(Order order) {
 564          HashSet&lt;Offer&gt; result = new HashSet&lt;Offer&gt;();
 565  
 566          Transformer adjustmentToOfferTransformer = new Transformer() {
 567  
 568              @Override
 569              public Object transform(Object input) {
 570                  return ((Adjustment)input).getOffer();
 571              }
 572          };
 573  
 574          result.addAll(CollectionUtils.collect(order.getOrderAdjustments(), adjustmentToOfferTransformer));
 575  
 576          if (order.getOrderItems() != null) {
 577              for (OrderItem item : order.getOrderItems()) {
<abbr title=" 578                  result.addAll(CollectionUtils.collect(item.getOrderItemAdjustments(), adjustmentToOfferTransformer));"> 578                  result.addAll(CollectionUtils.collect(item.getOrderItemAdjustments(), adjustmentToOfferTransformerðŸ”µ</abbr>
 579  
 580                  //record usage for price details on the item as well
 581                  if (item.getOrderItemPriceDetails() != null) {
 582                      for (OrderItemPriceDetail detail : item.getOrderItemPriceDetails()) {
<abbr title=" 583                          result.addAll(CollectionUtils.collect(detail.getOrderItemPriceDetailAdjustments(), adjustmentToOfferTransformer));"> 583                          result.addAll(CollectionUtils.collect(detail.getOrderItemPriceDetailAdjustments(), adjustmðŸ”µ</abbr>
 584                      }
 585                  }
 586              }
 587          }
 588  
 589          if (order.getFulfillmentGroups() != null) {
 590              for (FulfillmentGroup fg : order.getFulfillmentGroups()) {
<abbr title=" 591                  result.addAll(CollectionUtils.collect(fg.getFulfillmentGroupAdjustments(), adjustmentToOfferTransformer));"> 591                  result.addAll(CollectionUtils.collect(fg.getFulfillmentGroupAdjustments(), adjustmentToOfferTransfðŸ”µ</abbr>
 592              }
 593          }
 594          return result;
 595      }
 596  
 597      @Override
 598      public Map&lt;Offer, OfferCode&gt; getOffersRetrievedFromCodes(Order order)  {
 599          return getOffersRetrievedFromCodes(order.getAddedOfferCodes(), getUniqueOffersFromOrder(order));
 600      }
 601  
 602      @Override
 603      public Map&lt;Offer, OfferCode&gt; getOffersRetrievedFromCodes(List&lt;OfferCode&gt; codes, Set&lt;Offer&gt; appliedOffers) {
 604          HashMap&lt;Offer, OfferCode&gt; offerToCodeMapping = new HashMap&lt;Offer, OfferCode&gt;();
 605          for (OfferCode code : codes) {
 606              if (appliedOffers.contains(code.getOffer())) {
 607                  offerToCodeMapping.put(code.getOffer(), code);
 608              }
 609  
 610              List&lt;Offer&gt; additionalOffersToBeApplied = new ArrayList&lt;Offer&gt;();
 611  
 612              extensionManager.getProxy().addAdditionalOffersForCode(additionalOffersToBeApplied, code);
 613              for (Offer additionalOfferToBeApplied : additionalOffersToBeApplied) {
 614                  offerToCodeMapping.put(additionalOfferToBeApplied, code);
 615              }
 616          }
 617          return offerToCodeMapping;
 618      }
 619  
 620      @Override
 621      @Transactional(&quot;blTransactionManager&quot;)
 622      public Boolean deleteOfferCode(OfferCode code) {
 623          if (offerCodeDao.offerCodeIsUsed(code)) {
 624              return false;
 625          }
 626  
 627          offerCodeDao.delete(code);
 628          return true;
 629      }
 630  
 631      @Transactional(&quot;blTransactionManager&quot;)
 632      @Override
 633      public Offer duplicate(Long originalOfferId) {
 634          Map&lt;String, String&gt; copyHints = new HashMap&lt;String, String&gt;();
 635          copyHints.put(OfferImpl.EXCLUDE_OFFERCODE_COPY_HINT, &quot;true&quot;);
 636          return duplicator.copy(OfferImpl.class, originalOfferId, copyHints, offerDuplicateModifier);

 637      }
 638  
 639      @Override
 640      public CustomerOfferDao getCustomerOfferDao() {
 641          return customerOfferDao;
 642      }
 643  
 644      @Override
 645      public void setCustomerOfferDao(CustomerOfferDao customerOfferDao) {
 646          this.customerOfferDao = customerOfferDao;
 647      }
 648  
 649      @Override
 650      public OfferCodeDao getOfferCodeDao() {
 651          return offerCodeDao;
 652      }
 653  
 654      @Override
 655      public void setOfferCodeDao(OfferCodeDao offerCodeDao) {
 656          this.offerCodeDao = offerCodeDao;
 657      }
 658  
 659      @Override
 660      public OfferDao getOfferDao() {
 661          return offerDao;
 662      }
 663  
 664      @Override
 665      public void setOfferDao(OfferDao offerDao) {
 666          this.offerDao = offerDao;
 667      }
 668  
 669      @Override
 670      public OrderOfferProcessor getOrderOfferProcessor() {
 671          return orderOfferProcessor;
 672      }
 673  
 674      @Override
 675      public void setOrderOfferProcessor(OrderOfferProcessor orderOfferProcessor) {
 676          this.orderOfferProcessor = orderOfferProcessor;
 677      }
 678  
 679      @Override
 680      public ItemOfferProcessor getItemOfferProcessor() {
 681          return itemOfferProcessor;
 682      }
 683  
 684      @Override
 685      public void setItemOfferProcessor(ItemOfferProcessor itemOfferProcessor) {
 686          this.itemOfferProcessor = itemOfferProcessor;
 687      }
 688  
 689      @Override
 690      public FulfillmentGroupOfferProcessor getFulfillmentGroupOfferProcessor() {
 691          return fulfillmentGroupOfferProcessor;
 692      }
 693  
 694      @Override
 695      public void setFulfillmentGroupOfferProcessor(FulfillmentGroupOfferProcessor fulfillmentGroupOfferProcessor) {
 696          this.fulfillmentGroupOfferProcessor = fulfillmentGroupOfferProcessor;
 697      }
 698  
 699      @Override
 700      public PromotableItemFactory getPromotableItemFactory() {
 701          return promotableItemFactory;
 702      }
 703  
 704      @Override
 705      public void setPromotableItemFactory(PromotableItemFactory promotableItemFactory) {
 706          this.promotableItemFactory = promotableItemFactory;
 707      }
 708  
 709      @Override
 710      public OfferCode findOfferCodeById(Long id) {
 711          return offerCodeDao.readOfferCodeById(id);
 712      }
 713  
 714      @Override
 715      public List&lt;OfferCode&gt; findOfferCodesByIds(Collection&lt;Long&gt; ids) {
 716          return offerCodeDao.readOfferCodesByIds(ids);
 717      }
 718  
 719      @Override
 720      public OrderService getOrderService() {
 721          return orderService;
 722      }
 723  
 724      @Override
 725      public void setOrderService(OrderService orderService) {
 726          this.orderService = orderService;
 727      }
 728  
 729      @Override
 730      public Offer findOfferById(Long offerId) {
 731          return offerDao.readOfferById(offerId);
 732      }
 733  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            