<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>487</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    487
                    <a href="486.html">prev</a>
                    <a href="488.html">next</a>
                    <a href="487_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    DTStack/flinkStreamSQL_e346a804d69c8cd0124b4eb3d35156cfb5cd0779_cassandra/cassandra-side/cassandra-async-side/src/main/java/com/dtstack/flink/sql/side/cassandra/CassandraAsyncReqRow.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;e346a804d69c8cd0124b4eb3d35156cfb5cd0779:cassandra/cassandra-side/cassandra-async-side/src/main/java/com/dtstack/flink/sql/side/cassandra/CassandraAsyncReqRow.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;e346a804d69c8cd0124b4eb3d35156cfb5cd0779^1:cassandra/cassandra-side/cassandra-async-side/src/main/java/com/dtstack/flink/sql/side/cassandra/CassandraAsyncReqRow.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;e346a804d69c8cd0124b4eb3d35156cfb5cd0779^2:cassandra/cassandra-side/cassandra-async-side/src/main/java/com/dtstack/flink/sql/side/cassandra/CassandraAsyncReqRow.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;6e351a99f6e8449c76ad55e517a5da6cbb108379:cassandra/cassandra-side/cassandra-async-side/src/main/java/com/dtstack/flink/sql/side/cassandra/CassandraAsyncReqRow.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[bs], [bs], [bs], [bs], [j]], subset: [[bs], [sbj], [bs], [bs]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 /*
   2  * Licensed to the Apache Software Foundation (ASF) under one
   3  * or more contributor license agreements.  See the NOTICE file
   4  * distributed with this work for additional information
   5  * regarding copyright ownership.  The ASF licenses this file
   6  * to you under the Apache License, Version 2.0 (the
   7  * &quot;License&quot;); you may not use this file except in compliance
   8  * with the License.  You may obtain a copy of the License at
   9  *
  10  *     http://www.apache.org/licenses/LICENSE-2.0
  11  *
  12  * Unless required by applicable law or agreed to in writing, software
  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15  * See the License for the specific language governing permissions and
  16  * limitations under the License.
  17  */
  18 
  19 
  20 package com.dtstack.flink.sql.side.cassandra;
  21 
  22 import org.apache.flink.api.java.tuple.Tuple2;
  23 import org.apache.flink.api.java.typeutils.RowTypeInfo;
  24 import org.apache.flink.configuration.Configuration;
  25 import org.apache.flink.streaming.api.functions.async.ResultFuture;
  26 import org.apache.flink.types.Row;
  27 
  28 import com.datastax.driver.core.Cluster;
  29 import com.datastax.driver.core.ConsistencyLevel;
  30 import com.datastax.driver.core.HostDistance;
  31 import com.datastax.driver.core.PoolingOptions;
  32 import com.datastax.driver.core.QueryOptions;
  33 import com.datastax.driver.core.ResultSet;
  34 import com.datastax.driver.core.Session;
  35 import com.datastax.driver.core.SocketOptions;
  36 import com.datastax.driver.core.policies.DowngradingConsistencyRetryPolicy;
  37 import com.datastax.driver.core.policies.RetryPolicy;
  38 import com.dtstack.flink.sql.enums.ECacheContentType;
  39 import com.dtstack.flink.sql.side.BaseAsyncReqRow;
  40 import com.dtstack.flink.sql.side.CacheMissVal;
  41 import com.dtstack.flink.sql.side.FieldInfo;
  42 import com.dtstack.flink.sql.side.JoinInfo;
  43 import com.dtstack.flink.sql.side.AbstractSideTableInfo;
  44 import com.dtstack.flink.sql.side.cache.CacheObj;
  45 import com.dtstack.flink.sql.side.cassandra.table.CassandraSideTableInfo;
  46 import com.google.common.base.Function;
  47 import com.google.common.collect.Lists;
  48 import com.google.common.util.concurrent.AsyncFunction;
  49 import com.google.common.util.concurrent.FutureCallback;
  50 import com.google.common.util.concurrent.Futures;
  51 import com.google.common.util.concurrent.ListenableFuture;
  52 import io.vertx.core.json.JsonArray;
  53 import org.apache.commons.lang3.StringUtils;
  54 import org.slf4j.Logger;
  55 import org.slf4j.LoggerFactory;
  56 
  57 import java.net.InetAddress;
  58 import java.sql.Timestamp;
  59 import java.util.ArrayList;
  60 import java.util.List;
  61 import java.util.Map;
  62 
  63 /**
  64  * Reason:
  65  * Date: 2018/11/22
  66  *
  67  * @author xuqianjin
  68  */
  69 public class CassandraAsyncReqRow extends BaseAsyncReqRow {
  70 
  71     private static final long serialVersionUID = 6631584128079864735L;
  72 
  73     private static final Logger LOG = LoggerFactory.getLogger(CassandraAsyncReqRow.class);
  74 
  75     private final static int DEFAULT_VERTX_EVENT_LOOP_POOL_SIZE = 10;
  76 
  77     private final static int DEFAULT_VERTX_WORKER_POOL_SIZE = 20;
  78 
  79     private final static int DEFAULT_MAX_DB_CONN_POOL_SIZE = 20;
  80 
  81     private transient Cluster cluster;
  82     private transient ListenableFuture session;
  83     private transient CassandraSideTableInfo cassandraSideTableInfo;
  84 
<abbr title="  85     public CassandraAsyncReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, AbstractSideTableInfo sideTableInfo) {">  85     public CassandraAsyncReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoLüîµ</abbr>
<abbr title="  86         super(new com.dtstack.flink.sql.side.cassandra.CassandraAsyncSideInfo(rowTypeInfo, joinInfo, outFieldInfoList, sideTableInfo));">  86         super(new com.dtstack.flink.sql.side.cassandra.CassandraAsyncSideInfo(rowTypeInfo, joinInfo, outFüîµ</abbr>
  87     }
  88 
  89 
  90     @Override
  91     public void open(Configuration parameters) throws Exception {
  92         super.open(parameters);
  93         cassandraSideTableInfo = (CassandraSideTableInfo) sideInfo.getSideTableInfo();
  94         connCassandraDB(cassandraSideTableInfo);
  95     }
  96 
  97     private void connCassandraDB(CassandraSideTableInfo tableInfo) {
  98         try {
  99             if (session == null) {
 100                 QueryOptions queryOptions = new QueryOptions();
 101                 //The default consistency level for queries: ConsistencyLevel.TWO.
 102                 queryOptions.setConsistencyLevel(ConsistencyLevel.QUORUM);
<abbr title=" 103                 Integer maxRequestsPerConnection = tableInfo.getMaxRequestsPerConnection() == null ? 1 : tableInfo.getMaxRequestsPerConnection();"> 103                 Integer maxRequestsPerConnection = tableInfo.getMaxRequestsPerConnection() == null ? 1 : üîµ</abbr>
<abbr title=" 104                 Integer coreConnectionsPerHost = tableInfo.getCoreConnectionsPerHost() == null ? 8 : tableInfo.getCoreConnectionsPerHost();"> 104                 Integer coreConnectionsPerHost = tableInfo.getCoreConnectionsPerHost() == null ? 8 : tablüîµ</abbr>
<abbr title=" 105                 Integer maxConnectionsPerHost = tableInfo.getMaxConnectionsPerHost() == null ? 32768 : tableInfo.getMaxConnectionsPerHost();"> 105                 Integer maxConnectionsPerHost = tableInfo.getMaxConnectionsPerHost() == null ? 32768 : taüîµ</abbr>
<abbr title=" 106                 Integer maxQueueSize = tableInfo.getMaxQueueSize() == null ? 100000 : tableInfo.getMaxQueueSize();"> 106                 Integer maxQueueSize = tableInfo.getMaxQueueSize() == null ? 100000 : tableInfo.getMaxQueüîµ</abbr>
<abbr title=" 107                 Integer readTimeoutMillis = tableInfo.getReadTimeoutMillis() == null ? 60000 : tableInfo.getReadTimeoutMillis();"> 107                 Integer readTimeoutMillis = tableInfo.getReadTimeoutMillis() == null ? 60000 : tableInfo.üîµ</abbr>
<abbr title=" 108                 Integer connectTimeoutMillis = tableInfo.getConnectTimeoutMillis() == null ? 60000 : tableInfo.getConnectTimeoutMillis();"> 108                 Integer connectTimeoutMillis = tableInfo.getConnectTimeoutMillis() == null ? 60000 : tablüîµ</abbr>
<abbr title=" 109                 Integer poolTimeoutMillis = tableInfo.getPoolTimeoutMillis() == null ? 60000 : tableInfo.getPoolTimeoutMillis();"> 109                 Integer poolTimeoutMillis = tableInfo.getPoolTimeoutMillis() == null ? 60000 : tableInfo.üîµ</abbr>
 110                 Integer cassandraPort = 0;
 111                 String address = tableInfo.getAddress();
 112                 String userName = tableInfo.getUserName();
 113                 String password = tableInfo.getPassword();
 114                 String database = tableInfo.getDatabase();
 115 
 116                 ArrayList serversList = new ArrayList();
 117                 //Read timeout or connection timeout Settings
 118                 SocketOptions so = new SocketOptions()
 119                         .setReadTimeoutMillis(readTimeoutMillis)
 120                         .setConnectTimeoutMillis(connectTimeoutMillis);
 121 
 122                 //The cluster USES hostdistance.local in the same machine room
 123                 //Hostdistance. REMOTE is used for different machine rooms
 124                 //Ignore use HostDistance. IGNORED
 125                 PoolingOptions poolingOptions = new PoolingOptions()
 126                         //Each connection allows a maximum of 64 concurrent requests
 127                         .setMaxRequestsPerConnection(HostDistance.LOCAL, maxRequestsPerConnection)
 128                         //Have at least two connections to each machine in the cluster
 129                         .setCoreConnectionsPerHost(HostDistance.LOCAL, coreConnectionsPerHost)
 130                         //There are up to eight connections to each machine in the cluster
 131                         .setMaxConnectionsPerHost(HostDistance.LOCAL, maxConnectionsPerHost)
 132                         .setMaxQueueSize(maxQueueSize)
 133                         .setPoolTimeoutMillis(poolTimeoutMillis);
 134                 //ÈáçËØïÁ≠ñÁï•
 135                 RetryPolicy retryPolicy = DowngradingConsistencyRetryPolicy.INSTANCE;
 136 
 137                 for (String server : StringUtils.split(address, &quot;,&quot;)) {
 138                     cassandraPort = Integer.parseInt(StringUtils.split(server, &quot;:&quot;)[1]);
 139                     serversList.add(InetAddress.getByName(StringUtils.split(server, &quot;:&quot;)[0]));
 140                 }
 141 
 142                 if (userName == null || userName.isEmpty() || password == null || password.isEmpty()) {
<abbr title=" 143                     cluster = Cluster.builder().addContactPoints(serversList).withRetryPolicy(retryPolicy)"> 143                     cluster = Cluster.builder().addContactPoints(serversList).withRetryPolicy(retryPolicyüîµ</abbr>
 144                             .withPort(cassandraPort)
 145                             .withPoolingOptions(poolingOptions).withSocketOptions(so)
 146                             .withQueryOptions(queryOptions).build();
 147                 } else {
<abbr title=" 148                     cluster = Cluster.builder().addContactPoints(serversList).withRetryPolicy(retryPolicy)"> 148                     cluster = Cluster.builder().addContactPoints(serversList).withRetryPolicy(retryPolicyüîµ</abbr>
 149                             .withPort(cassandraPort)
 150                             .withPoolingOptions(poolingOptions).withSocketOptions(so)
 151                             .withCredentials(userName, password)
 152                             .withQueryOptions(queryOptions).build();
 153                 }
 154                 // Âª∫Á´ãËøûÊé• ËøûÊé•Â∑≤Â≠òÂú®ÁöÑÈîÆÁ©∫Èó¥
 155                 session = cluster.connectAsync(database);
 156                 LOG.info(&quot;connect cassandra is successed!&quot;);
 157             }
 158         } catch (Exception e) {
 159             LOG.error(&quot;connect cassandra is error:&quot; + e.getMessage());
 160         }
 161     }
 162 
 163     @Override
 164 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 165     public void asyncInvoke(Tuple2&lt;Boolean,Row&gt; input, ResultFuture&lt;Tuple2&lt;Boolean,Row&gt;&gt; resultFuture) throws Exception {"> 165     public void asyncInvoke(Tuple2&lt;Boolean,Row&gt; input, ResultFuture&lt;Tuple2&lt;Boolean,Row&gt;&gt; resultFuture) thüîµ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 166         Tuple2&lt;Boolean, Row&gt; inputCopy = Tuple2.of(input.f0, input.f1);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 167         JsonArray inputParams = new JsonArray();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 168         StringBuffer stringBuffer = new StringBuffer();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 169         String sqlWhere = &quot; where &quot;;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 170 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 171         for (int i = 0; i &lt; sideInfo.getEqualFieldList().size(); i++) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 172             Integer conValIndex = sideInfo.getEqualValIndex().get(i);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 173             Object equalObj = inputCopy.f1.getField(conValIndex);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 174             if (equalObj == null) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 175                 dealMissKey(inputCopy, resultFuture);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 176                 return;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 177             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 178             inputParams.add(equalObj);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 179             StringBuffer sqlTemp = stringBuffer.append(sideInfo.getEqualFieldList().get(i))</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 180                     .append(&quot; = &quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 181             if (equalObj instanceof String) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 182                 sqlTemp.append(&quot;&#x27;&quot; + equalObj + &quot;&#x27;&quot;)</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 183                         .append(&quot; and &quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 184             } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 185                 sqlTemp.append(equalObj)</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 186                         .append(&quot; and &quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 187             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 188 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 189         }</span>
 190 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 191     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 192     public void asyncInvoke(CRow input, ResultFuture&lt;CRow&gt; resultFuture) throws Exception {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 193         CRow inputCopy = new CRow(input.row(), input.change());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 194         JsonArray inputParams = new JsonArray();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 195         StringBuffer stringBuffer = new StringBuffer();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 196         String sqlWhere = &quot; where &quot;;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 197 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 198         for (int i = 0; i &lt; sideInfo.getEqualFieldList().size(); i++) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 199             Integer conValIndex = sideInfo.getEqualValIndex().get(i);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 200             Object equalObj = inputCopy.row().getField(conValIndex);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 201             if (equalObj == null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 202                 dealMissKey(inputCopy, resultFuture);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 203                 return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 204             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 205             inputParams.add(equalObj);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 206             StringBuffer sqlTemp = stringBuffer.append(sideInfo.getEqualFieldList().get(i))</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 207                     .append(&quot; = &quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 208             if (equalObj instanceof String) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 209                 sqlTemp.append(&quot;&#x27;&quot; + equalObj + &quot;&#x27;&quot;)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 210                         .append(&quot; and &quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 211             } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 212                 sqlTemp.append(equalObj)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 213                         .append(&quot; and &quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 214             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 215 </span>
 216 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 217     public void handleAsyncInvoke(Map&lt;String, Object&gt; inputParams, CRow input, ResultFuture&lt;CRow&gt; resultFuture) throws Exception {"> 217     public void handleAsyncInvoke(Map&lt;String, Object&gt; inputParams, CRow input, ResultFuture&lt;CRow&gt; resultFüîµ</abbr></span>
 218 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 219 
 220         String key = buildCacheKey(inputParams);
 221 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 222         sqlWhere = sqlWhere + stringBuffer.toString().substring(0, stringBuffer.lastIndexOf(&quot; and &quot;));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 223 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 224         if (openCache()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 225             CacheObj val = getFromCache(key);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 226             if (val != null) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 227 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 228                 if (ECacheContentType.MissVal == val.getType()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 229                     dealMissKey(inputCopy, resultFuture);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 230                     return;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 231                 } else if (ECacheContentType.MultiLine == val.getType()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 232                     List&lt;Tuple2&lt;Boolean,Row&gt;&gt; rowList = Lists.newArrayList();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 233                     for (Object jsonArray : (List) val.getContent()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 234                         Row row = fillData(inputCopy.f1, jsonArray);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 235                         rowList.add(Tuple2.of(inputCopy.f0, row));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 236                     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 237                     resultFuture.complete(rowList);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 238                 } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 239                     throw new RuntimeException(&quot;not support cache obj type &quot; + val.getType());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 240                 }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 241                 return;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 242             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 243         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 244 </span>
 245 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 246         StringBuffer stringBuffer = new StringBuffer();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 247         String sqlWhere = &quot; where &quot;;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 248 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 249         for (int i = 0; i &lt; sideInfo.getEqualFieldList().size(); i++) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 250             Integer conValIndex = sideInfo.getEqualValIndex().get(i);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 251             Object equalObj = inputCopy.row().getField(conValIndex);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 252             if (equalObj == null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 253                 dealMissKey(inputCopy, resultFuture);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 254                 return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 255             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 256             inputParams.add(equalObj);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 257             StringBuffer sqlTemp = stringBuffer.append(sideInfo.getEqualFieldList().get(i))</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 258                     .append(&quot; = &quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 259             if (equalObj instanceof String) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 260                 sqlTemp.append(&quot;&#x27;&quot; + equalObj + &quot;&#x27;&quot;)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 261                         .append(&quot; and &quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 262             } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 263                 sqlTemp.append(equalObj)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 264                         .append(&quot; and &quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 265             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 266 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 267         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 268 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 269         String key = buildCacheKey(inputParams);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 270         sqlWhere = sqlWhere + stringBuffer.toString().substring(0, stringBuffer.lastIndexOf(&quot; and &quot;));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 271 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 272         if (openCache()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 273             CacheObj val = getFromCache(key);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 274             if (val != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 275 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 276                 if (ECacheContentType.MissVal == val.getType()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 277                     dealMissKey(inputCopy, resultFuture);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 278                     return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 279                 } else if (ECacheContentType.MultiLine == val.getType()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 280                     List&lt;CRow&gt; rowList = Lists.newArrayList();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 281                     for (Object jsonArray : (List) val.getContent()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 282                         Row row = fillData(inputCopy.row(), jsonArray);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 283                         rowList.add(new CRow(row, inputCopy.change()));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 284                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 285                     resultFuture.complete(rowList);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 286                 } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 287                     throw new RuntimeException(&quot;not support cache obj type &quot; + val.getType());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 288                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 289                 return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 290             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 291         }</span>
 292 =======
 293 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 294         //connect Cassandra
 295         connCassandraDB(cassandraSideTableInfo);
 296 
<abbr title=" 297         String sqlCondition = sideInfo.getSqlCondition() + &quot; &quot; + buildWhereCondition(inputParams) + &quot;  ALLOW FILTERING &quot;;"> 297         String sqlCondition = sideInfo.getSqlCondition() + &quot; &quot; + buildWhereCondition(inputParams) + &quot;  ALüîµ</abbr>
 298         LOG.info(&quot;sqlCondition:{}&quot; + sqlCondition);
 299 
 300         ListenableFuture&lt;ResultSet&gt; resultSet = Futures.transformAsync(session,
 301                 new AsyncFunction&lt;Session, ResultSet&gt;() {
 302                     @Override
 303                     public ListenableFuture&lt;ResultSet&gt; apply(Session session) throws Exception {
 304                         return session.executeAsync(sqlCondition);
 305                     }
 306                 });
 307 
 308         ListenableFuture&lt;List&lt;com.datastax.driver.core.Row&gt;&gt; data = Futures.transform(resultSet,
 309                 new Function&lt;ResultSet, List&lt;com.datastax.driver.core.Row&gt;&gt;() {
 310                     @Override
 311                     public List&lt;com.datastax.driver.core.Row&gt; apply(ResultSet rs) {
 312                         return rs.all();
 313                     }
 314                 });
 315 
 316         Futures.addCallback(data, new FutureCallback&lt;List&lt;com.datastax.driver.core.Row&gt;&gt;() {
 317             @Override
 318             public void onSuccess(List&lt;com.datastax.driver.core.Row&gt; rows) {
 319                 cluster.closeAsync();
 320                 if (rows.size() &gt; 0) {
 321                     List&lt;com.datastax.driver.core.Row&gt; cacheContent = Lists.newArrayList();
 322                     List&lt;Tuple2&lt;Boolean,Row&gt;&gt; rowList = Lists.newArrayList();
 323                     for (com.datastax.driver.core.Row line : rows) {
 324 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 325                         Row row = fillData(inputCopy.f1, line);</span>
 326 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 327                 if (ECacheContentType.MissVal == val.getType()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 328                     dealMissKey(inputCopy, resultFuture);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 329                     return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 330                 } else if (ECacheContentType.MultiLine == val.getType()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 331                     List&lt;CRow&gt; rowList = Lists.newArrayList();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 332                     for (Object jsonArray : (List) val.getContent()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 333                         Row row = fillData(inputCopy.row(), jsonArray);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 334                         rowList.add(new CRow(row, inputCopy.change()));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 335                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 336                     resultFuture.complete(rowList);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 337                 } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 338                     throw new RuntimeException(&quot;not support cache obj type &quot; + val.getType());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 339                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 340                 return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 341             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 342         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 343 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 344         //connect Cassandra</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 345         connCassandraDB(cassandraSideTableInfo);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 346 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 347         String sqlCondition = sideInfo.getSqlCondition() + &quot; &quot; + sqlWhere + &quot;  ALLOW FILTERING &quot;;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 348         LOG.info(&quot;sqlCondition:{}&quot; + sqlCondition);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 349 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 350         ListenableFuture&lt;ResultSet&gt; resultSet = Futures.transformAsync(session,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 351                 new AsyncFunction&lt;Session, ResultSet&gt;() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 352                     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 353                     public ListenableFuture&lt;ResultSet&gt; apply(Session session) throws Exception {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 354                         return session.executeAsync(sqlCondition);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 355                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 356                 });</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 357 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 358         ListenableFuture&lt;List&lt;com.datastax.driver.core.Row&gt;&gt; data = Futures.transform(resultSet,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 359                 new Function&lt;ResultSet, List&lt;com.datastax.driver.core.Row&gt;&gt;() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 360                     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 361                     public List&lt;com.datastax.driver.core.Row&gt; apply(ResultSet rs) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 362                         return rs.all();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 363                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 364                 });</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 365 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 366         Futures.addCallback(data, new FutureCallback&lt;List&lt;com.datastax.driver.core.Row&gt;&gt;() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 367             @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 368             public void onSuccess(List&lt;com.datastax.driver.core.Row&gt; rows) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 369                 cluster.closeAsync();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 370                 if (rows.size() &gt; 0) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 371                     List&lt;com.datastax.driver.core.Row&gt; cacheContent = Lists.newArrayList();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 372                     List&lt;CRow&gt; rowList = Lists.newArrayList();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 373                     for (com.datastax.driver.core.Row line : rows) {</span>
 374 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 375                         Row row = fillData(input.row(), line);</span>
 376 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 377                         if (openCache()) {
 378                             cacheContent.add(line);
 379                         }
 380 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 381                         rowList.add(Tuple2.of(inputCopy.f0,row));</span>
 382 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 383                     List&lt;CRow&gt; rowList = Lists.newArrayList();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 384                     for (Object jsonArray : (List) val.getContent()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 385                         Row row = fillData(inputCopy.row(), jsonArray);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 386                         rowList.add(new CRow(row, inputCopy.change()));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 387                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 388                     resultFuture.complete(rowList);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 389                 } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 390                     throw new RuntimeException(&quot;not support cache obj type &quot; + val.getType());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 391                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 392                 return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 393             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 394         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 395 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 396         //connect Cassandra</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 397         connCassandraDB(cassandraSideTableInfo);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 398 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 399         String sqlCondition = sideInfo.getSqlCondition() + &quot; &quot; + sqlWhere + &quot;  ALLOW FILTERING &quot;;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 400         LOG.info(&quot;sqlCondition:{}&quot; + sqlCondition);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 401 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 402         ListenableFuture&lt;ResultSet&gt; resultSet = Futures.transformAsync(session,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 403                 new AsyncFunction&lt;Session, ResultSet&gt;() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 404                     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 405                     public ListenableFuture&lt;ResultSet&gt; apply(Session session) throws Exception {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 406                         return session.executeAsync(sqlCondition);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 407                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 408                 });</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 409 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 410         ListenableFuture&lt;List&lt;com.datastax.driver.core.Row&gt;&gt; data = Futures.transform(resultSet,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 411                 new Function&lt;ResultSet, List&lt;com.datastax.driver.core.Row&gt;&gt;() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 412                     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 413                     public List&lt;com.datastax.driver.core.Row&gt; apply(ResultSet rs) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 414                         return rs.all();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 415                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 416                 });</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 417 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 418         Futures.addCallback(data, new FutureCallback&lt;List&lt;com.datastax.driver.core.Row&gt;&gt;() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 419             @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 420             public void onSuccess(List&lt;com.datastax.driver.core.Row&gt; rows) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 421                 cluster.closeAsync();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 422                 if (rows.size() &gt; 0) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 423                     List&lt;com.datastax.driver.core.Row&gt; cacheContent = Lists.newArrayList();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 424                     List&lt;CRow&gt; rowList = Lists.newArrayList();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 425                     for (com.datastax.driver.core.Row line : rows) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 426                         Row row = fillData(inputCopy.row(), line);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 427                         if (openCache()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 428                             cacheContent.add(line);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 429                         }</span>
 430 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 431                         rowList.add(new CRow(row, input.change()));</span>
 432 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 433                     }
 434                     resultFuture.complete(rowList);
 435                     if (openCache()) {
 436                         putCache(key, CacheObj.buildCacheObj(ECacheContentType.MultiLine, cacheContent));
 437                     }
 438                 } else {
 439                     dealMissKey(input, resultFuture);
 440                     if (openCache()) {
 441                         putCache(key, CacheMissVal.getMissKeyObj());
 442                     }
 443                     resultFuture.complete(null);
 444                 }
 445             }
 446 
 447             @Override
 448             public void onFailure(Throwable t) {
 449                 LOG.error(&quot;Failed to retrieve the data: %s%n&quot;,
 450                         t.getMessage());
 451                 cluster.closeAsync();
 452                 resultFuture.completeExceptionally(t);
 453             }
 454         });
 455     }
 456 
 457     @Override
 458     public String buildCacheKey(Map&lt;String, Object&gt; inputParams) {
 459         StringBuilder sb = new StringBuilder();
 460         for (Object ele : inputParams.values()) {
 461             sb.append(ele.toString()).append(&quot;_&quot;);
 462         }
 463         return sb.toString();
 464     }
 465 
 466     private String buildWhereCondition(Map&lt;String, Object&gt; inputParams){
 467         StringBuilder sb = new StringBuilder(&quot; where &quot;);
 468         for(Map.Entry&lt;String, Object&gt; entry : inputParams.entrySet()){
<abbr title=" 469             Object value = entry.getValue() instanceof String ? &quot;&#x27;&quot; + entry.getValue() + &quot;&#x27;&quot; : entry.getValue();"> 469             Object value = entry.getValue() instanceof String ? &quot;&#x27;&quot; + entry.getValue() + &quot;&#x27;&quot; : entry.getVüîµ</abbr>
 470             sb.append(String.format(&quot;%s = %s&quot;, entry.getKey(), value));
 471         }
 472         return sb.toString();
 473     }
 474 
 475     @Override
 476     public Row fillData(Row input, Object line) {
 477         com.datastax.driver.core.Row rowArray = (com.datastax.driver.core.Row) line;
 478         Row row = new Row(sideInfo.getOutFieldInfoList().size());
 479         for (Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getInFieldIndex().entrySet()) {
 480             Object obj = input.getField(entry.getValue());
 481             obj = convertTimeIndictorTypeInfo(entry.getValue(), obj);
 482             row.setField(entry.getKey(), obj);
 483         }
 484 
 485         for (Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getSideFieldIndex().entrySet()) {
 486             if (rowArray == null) {
 487                 row.setField(entry.getKey(), null);
 488             } else {
 489                 row.setField(entry.getKey(), rowArray.getObject(entry.getValue()));
 490             }
 491         }
 492 
 493         return row;
 494     }
 495 
 496     @Override
 497     public void close() throws Exception {
 498         super.close();
 499         if (cluster != null) {
 500             cluster.close();
 501             cluster = null;
 502         }
 503     }
 504 }</pre></td>
                            <td><pre>   1 /*
   2  * Licensed to the Apache Software Foundation (ASF) under one
   3  * or more contributor license agreements.  See the NOTICE file
   4  * distributed with this work for additional information
   5  * regarding copyright ownership.  The ASF licenses this file
   6  * to you under the Apache License, Version 2.0 (the
   7  * &quot;License&quot;); you may not use this file except in compliance
   8  * with the License.  You may obtain a copy of the License at
   9  *
  10  *     http://www.apache.org/licenses/LICENSE-2.0
  11  *
  12  * Unless required by applicable law or agreed to in writing, software
  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15  * See the License for the specific language governing permissions and
  16  * limitations under the License.
  17  */
  18 
  19 
  20 package com.dtstack.flink.sql.side.cassandra;
  21 
  22 import org.apache.flink.api.java.tuple.Tuple2;
  23 import org.apache.flink.api.java.typeutils.RowTypeInfo;
  24 import org.apache.flink.configuration.Configuration;
  25 import org.apache.flink.streaming.api.functions.async.ResultFuture;
  26 import org.apache.flink.types.Row;
  27 
  28 import com.datastax.driver.core.Cluster;
  29 import com.datastax.driver.core.ConsistencyLevel;
  30 import com.datastax.driver.core.HostDistance;
  31 import com.datastax.driver.core.PoolingOptions;
  32 import com.datastax.driver.core.QueryOptions;
  33 import com.datastax.driver.core.ResultSet;
  34 import com.datastax.driver.core.Session;
  35 import com.datastax.driver.core.SocketOptions;
  36 import com.datastax.driver.core.policies.DowngradingConsistencyRetryPolicy;
  37 import com.datastax.driver.core.policies.RetryPolicy;
  38 import com.dtstack.flink.sql.enums.ECacheContentType;
  39 import com.dtstack.flink.sql.side.BaseAsyncReqRow;
  40 import com.dtstack.flink.sql.side.CacheMissVal;
  41 import com.dtstack.flink.sql.side.FieldInfo;
  42 import com.dtstack.flink.sql.side.JoinInfo;
  43 import com.dtstack.flink.sql.side.AbstractSideTableInfo;
  44 import com.dtstack.flink.sql.side.cache.CacheObj;
  45 import com.dtstack.flink.sql.side.cassandra.table.CassandraSideTableInfo;
  46 import com.google.common.base.Function;
  47 import com.google.common.collect.Lists;
  48 import com.google.common.util.concurrent.AsyncFunction;
  49 import com.google.common.util.concurrent.FutureCallback;
  50 import com.google.common.util.concurrent.Futures;
  51 import com.google.common.util.concurrent.ListenableFuture;
  52 import io.vertx.core.json.JsonArray;
  53 import org.apache.commons.lang3.StringUtils;
  54 import org.slf4j.Logger;
  55 import org.slf4j.LoggerFactory;
  56 
  57 import java.net.InetAddress;
  58 import java.sql.Timestamp;
  59 import java.util.ArrayList;
  60 import java.util.List;
  61 import java.util.Map;
  62 
  63 /**
  64  * Reason:
  65  * Date: 2018/11/22
  66  *
  67  * @author xuqianjin
  68  */
  69 public class CassandraAsyncReqRow extends BaseAsyncReqRow {
  70 
  71     private static final long serialVersionUID = 6631584128079864735L;
  72 
  73     private static final Logger LOG = LoggerFactory.getLogger(CassandraAsyncReqRow.class);
  74 
  75     private final static int DEFAULT_VERTX_EVENT_LOOP_POOL_SIZE = 10;
  76 
  77     private final static int DEFAULT_VERTX_WORKER_POOL_SIZE = 20;
  78 
  79     private final static int DEFAULT_MAX_DB_CONN_POOL_SIZE = 20;
  80 
  81     private transient Cluster cluster;
  82     private transient ListenableFuture session;
  83     private transient CassandraSideTableInfo cassandraSideTableInfo;
  84 
<abbr title="  85     public CassandraAsyncReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, AbstractSideTableInfo sideTableInfo) {">  85     public CassandraAsyncReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoLüîµ</abbr>
<abbr title="  86         super(new com.dtstack.flink.sql.side.cassandra.CassandraAsyncSideInfo(rowTypeInfo, joinInfo, outFieldInfoList, sideTableInfo));">  86         super(new com.dtstack.flink.sql.side.cassandra.CassandraAsyncSideInfo(rowTypeInfo, joinInfo, outFüîµ</abbr>
  87     }
  88 
  89 
  90     @Override
  91     public void open(Configuration parameters) throws Exception {
  92         super.open(parameters);
  93         cassandraSideTableInfo = (CassandraSideTableInfo) sideInfo.getSideTableInfo();
  94         connCassandraDB(cassandraSideTableInfo);
  95     }
  96 
  97     private void connCassandraDB(CassandraSideTableInfo tableInfo) {
  98         try {
  99             if (session == null) {
 100                 QueryOptions queryOptions = new QueryOptions();
 101                 //The default consistency level for queries: ConsistencyLevel.TWO.
 102                 queryOptions.setConsistencyLevel(ConsistencyLevel.QUORUM);
<abbr title=" 103                 Integer maxRequestsPerConnection = tableInfo.getMaxRequestsPerConnection() == null ? 1 : tableInfo.getMaxRequestsPerConnection();"> 103                 Integer maxRequestsPerConnection = tableInfo.getMaxRequestsPerConnection() == null ? 1 : üîµ</abbr>
<abbr title=" 104                 Integer coreConnectionsPerHost = tableInfo.getCoreConnectionsPerHost() == null ? 8 : tableInfo.getCoreConnectionsPerHost();"> 104                 Integer coreConnectionsPerHost = tableInfo.getCoreConnectionsPerHost() == null ? 8 : tablüîµ</abbr>
<abbr title=" 105                 Integer maxConnectionsPerHost = tableInfo.getMaxConnectionsPerHost() == null ? 32768 : tableInfo.getMaxConnectionsPerHost();"> 105                 Integer maxConnectionsPerHost = tableInfo.getMaxConnectionsPerHost() == null ? 32768 : taüîµ</abbr>
<abbr title=" 106                 Integer maxQueueSize = tableInfo.getMaxQueueSize() == null ? 100000 : tableInfo.getMaxQueueSize();"> 106                 Integer maxQueueSize = tableInfo.getMaxQueueSize() == null ? 100000 : tableInfo.getMaxQueüîµ</abbr>
<abbr title=" 107                 Integer readTimeoutMillis = tableInfo.getReadTimeoutMillis() == null ? 60000 : tableInfo.getReadTimeoutMillis();"> 107                 Integer readTimeoutMillis = tableInfo.getReadTimeoutMillis() == null ? 60000 : tableInfo.üîµ</abbr>
<abbr title=" 108                 Integer connectTimeoutMillis = tableInfo.getConnectTimeoutMillis() == null ? 60000 : tableInfo.getConnectTimeoutMillis();"> 108                 Integer connectTimeoutMillis = tableInfo.getConnectTimeoutMillis() == null ? 60000 : tablüîµ</abbr>
<abbr title=" 109                 Integer poolTimeoutMillis = tableInfo.getPoolTimeoutMillis() == null ? 60000 : tableInfo.getPoolTimeoutMillis();"> 109                 Integer poolTimeoutMillis = tableInfo.getPoolTimeoutMillis() == null ? 60000 : tableInfo.üîµ</abbr>
 110                 Integer cassandraPort = 0;
 111                 String address = tableInfo.getAddress();
 112                 String userName = tableInfo.getUserName();
 113                 String password = tableInfo.getPassword();
 114                 String database = tableInfo.getDatabase();
 115 
 116                 ArrayList serversList = new ArrayList();
 117                 //Read timeout or connection timeout Settings
 118                 SocketOptions so = new SocketOptions()
 119                         .setReadTimeoutMillis(readTimeoutMillis)
 120                         .setConnectTimeoutMillis(connectTimeoutMillis);
 121 
 122                 //The cluster USES hostdistance.local in the same machine room
 123                 //Hostdistance. REMOTE is used for different machine rooms
 124                 //Ignore use HostDistance. IGNORED
 125                 PoolingOptions poolingOptions = new PoolingOptions()
 126                         //Each connection allows a maximum of 64 concurrent requests
 127                         .setMaxRequestsPerConnection(HostDistance.LOCAL, maxRequestsPerConnection)
 128                         //Have at least two connections to each machine in the cluster
 129                         .setCoreConnectionsPerHost(HostDistance.LOCAL, coreConnectionsPerHost)
 130                         //There are up to eight connections to each machine in the cluster
 131                         .setMaxConnectionsPerHost(HostDistance.LOCAL, maxConnectionsPerHost)
 132                         .setMaxQueueSize(maxQueueSize)
 133                         .setPoolTimeoutMillis(poolTimeoutMillis);
 134                 //ÈáçËØïÁ≠ñÁï•
 135                 RetryPolicy retryPolicy = DowngradingConsistencyRetryPolicy.INSTANCE;
 136 
 137                 for (String server : StringUtils.split(address, &quot;,&quot;)) {
 138                     cassandraPort = Integer.parseInt(StringUtils.split(server, &quot;:&quot;)[1]);
 139                     serversList.add(InetAddress.getByName(StringUtils.split(server, &quot;:&quot;)[0]));
 140                 }
 141 
 142                 if (userName == null || userName.isEmpty() || password == null || password.isEmpty()) {
<abbr title=" 143                     cluster = Cluster.builder().addContactPoints(serversList).withRetryPolicy(retryPolicy)"> 143                     cluster = Cluster.builder().addContactPoints(serversList).withRetryPolicy(retryPolicyüîµ</abbr>
 144                             .withPort(cassandraPort)
 145                             .withPoolingOptions(poolingOptions).withSocketOptions(so)
 146                             .withQueryOptions(queryOptions).build();
 147                 } else {
<abbr title=" 148                     cluster = Cluster.builder().addContactPoints(serversList).withRetryPolicy(retryPolicy)"> 148                     cluster = Cluster.builder().addContactPoints(serversList).withRetryPolicy(retryPolicyüîµ</abbr>
 149                             .withPort(cassandraPort)
 150                             .withPoolingOptions(poolingOptions).withSocketOptions(so)
 151                             .withCredentials(userName, password)
 152                             .withQueryOptions(queryOptions).build();
 153                 }
 154                 // Âª∫Á´ãËøûÊé• ËøûÊé•Â∑≤Â≠òÂú®ÁöÑÈîÆÁ©∫Èó¥
 155                 session = cluster.connectAsync(database);
 156                 LOG.info(&quot;connect cassandra is successed!&quot;);
 157             }
 158         } catch (Exception e) {
 159             LOG.error(&quot;connect cassandra is error:&quot; + e.getMessage());
 160         }
 161     }
 162 
 163 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 164     @Override</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 165     public void asyncInvoke(Tuple2&lt;Boolean,Row&gt; input, ResultFuture&lt;Tuple2&lt;Boolean,Row&gt;&gt; resultFuture) throws Exception {"> 165     public void asyncInvoke(Tuple2&lt;Boolean,Row&gt; input, ResultFuture&lt;Tuple2&lt;Boolean,Row&gt;&gt; resultFuture) thüîµ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 166         Tuple2&lt;Boolean, Row&gt; inputCopy = Tuple2.of(input.f0, input.f1);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 167         JsonArray inputParams = new JsonArray();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 168         StringBuffer stringBuffer = new StringBuffer();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 169         String sqlWhere = &quot; where &quot;;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 170 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 171         for (int i = 0; i &lt; sideInfo.getEqualFieldList().size(); i++) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 172             Integer conValIndex = sideInfo.getEqualValIndex().get(i);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 173             Object equalObj = inputCopy.f1.getField(conValIndex);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 174             if (equalObj == null) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 175                 dealMissKey(inputCopy, resultFuture);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 176                 return;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 177             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 178             inputParams.add(equalObj);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 179             StringBuffer sqlTemp = stringBuffer.append(sideInfo.getEqualFieldList().get(i))</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 180                     .append(&quot; = &quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 181             if (equalObj instanceof String) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 182                 sqlTemp.append(&quot;&#x27;&quot; + equalObj + &quot;&#x27;&quot;)</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 183                         .append(&quot; and &quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 184             } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 185                 sqlTemp.append(equalObj)</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 186                         .append(&quot; and &quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 187             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 188 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 189         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 190 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 191         String key = buildCacheKey(inputParams);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 192         sqlWhere = sqlWhere + stringBuffer.toString().substring(0, stringBuffer.lastIndexOf(&quot; and &quot;));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 193 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 194         if (openCache()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 195             CacheObj val = getFromCache(key);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 196             if (val != null) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 197 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 198                 if (ECacheContentType.MissVal == val.getType()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 199                     dealMissKey(inputCopy, resultFuture);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 200                     return;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 201                 } else if (ECacheContentType.MultiLine == val.getType()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 202                     List&lt;Tuple2&lt;Boolean,Row&gt;&gt; rowList = Lists.newArrayList();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 203                     for (Object jsonArray : (List) val.getContent()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 204                         Row row = fillData(inputCopy.f1, jsonArray);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 205                         rowList.add(Tuple2.of(inputCopy.f0, row));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 206                     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 207                     resultFuture.complete(rowList);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 208                 } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 209                     throw new RuntimeException(&quot;not support cache obj type &quot; + val.getType());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 210                 }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 211                 return;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 212             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 213         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 214 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 215         //connect Cassandra</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 216         connCassandraDB(cassandraSideTableInfo);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 217 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 218         String sqlCondition = sideInfo.getSqlCondition() + &quot; &quot; + sqlWhere + &quot;  ALLOW FILTERING &quot;;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 219         LOG.info(&quot;sqlCondition:{}&quot; + sqlCondition);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 220 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 221         ListenableFuture&lt;ResultSet&gt; resultSet = Futures.transformAsync(session,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 222                 new AsyncFunction&lt;Session, ResultSet&gt;() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 223                     @Override</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 224                     public ListenableFuture&lt;ResultSet&gt; apply(Session session) throws Exception {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 225                         return session.executeAsync(sqlCondition);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 226                     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 227                 });</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 228 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 229         ListenableFuture&lt;List&lt;com.datastax.driver.core.Row&gt;&gt; data = Futures.transform(resultSet,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 230                 new Function&lt;ResultSet, List&lt;com.datastax.driver.core.Row&gt;&gt;() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 231                     @Override</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 232                     public List&lt;com.datastax.driver.core.Row&gt; apply(ResultSet rs) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 233                         return rs.all();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 234                     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 235                 });</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 236 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 237         Futures.addCallback(data, new FutureCallback&lt;List&lt;com.datastax.driver.core.Row&gt;&gt;() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 238             @Override</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 239             public void onSuccess(List&lt;com.datastax.driver.core.Row&gt; rows) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 240                 cluster.closeAsync();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 241                 if (rows.size() &gt; 0) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 242                     List&lt;com.datastax.driver.core.Row&gt; cacheContent = Lists.newArrayList();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 243                     List&lt;Tuple2&lt;Boolean,Row&gt;&gt; rowList = Lists.newArrayList();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 244                     for (com.datastax.driver.core.Row line : rows) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 245                         Row row = fillData(inputCopy.f1, line);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 246                         if (openCache()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 247                             cacheContent.add(line);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 248                         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 249                         rowList.add(Tuple2.of(inputCopy.f0,row));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 250                     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 251                     resultFuture.complete(rowList);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 252                     if (openCache()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 253                         putCache(key, CacheObj.buildCacheObj(ECacheContentType.MultiLine, cacheContent));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 254                     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 255                 } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 256                     dealMissKey(inputCopy, resultFuture);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 257                     if (openCache()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 258                         putCache(key, CacheMissVal.getMissKeyObj());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 259                     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 260                     resultFuture.complete(null);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 261                 }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 262             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 263 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 264             @Override</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 265             public void onFailure(Throwable t) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 266                 LOG.error(&quot;Failed to retrieve the data: %s%n&quot;,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 267                         t.getMessage());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 268                 cluster.closeAsync();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 269                 resultFuture.completeExceptionally(t);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 270             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 271         });</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 272     }</span>
 273 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 274     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 275     public void asyncInvoke(CRow input, ResultFuture&lt;CRow&gt; resultFuture) throws Exception {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 276         CRow inputCopy = new CRow(input.row(), input.change());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 277         JsonArray inputParams = new JsonArray();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 278         StringBuffer stringBuffer = new StringBuffer();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 279         String sqlWhere = &quot; where &quot;;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 280 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 281         for (int i = 0; i &lt; sideInfo.getEqualFieldList().size(); i++) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 282             Integer conValIndex = sideInfo.getEqualValIndex().get(i);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 283             Object equalObj = inputCopy.row().getField(conValIndex);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 284             if (equalObj == null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 285                 dealMissKey(inputCopy, resultFuture);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 286                 return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 287             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 288             inputParams.add(equalObj);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 289             StringBuffer sqlTemp = stringBuffer.append(sideInfo.getEqualFieldList().get(i))</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 290                     .append(&quot; = &quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 291             if (equalObj instanceof String) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 292                 sqlTemp.append(&quot;&#x27;&quot; + equalObj + &quot;&#x27;&quot;)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 293                         .append(&quot; and &quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 294             } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 295                 sqlTemp.append(equalObj)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 296                         .append(&quot; and &quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 297             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 298 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 299         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 300 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 301         String key = buildCacheKey(inputParams);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 302         sqlWhere = sqlWhere + stringBuffer.toString().substring(0, stringBuffer.lastIndexOf(&quot; and &quot;));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 303 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 304         if (openCache()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 305             CacheObj val = getFromCache(key);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 306             if (val != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 307 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 308                 if (ECacheContentType.MissVal == val.getType()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 309                     dealMissKey(inputCopy, resultFuture);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 310                     return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 311                 } else if (ECacheContentType.MultiLine == val.getType()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 312                     List&lt;CRow&gt; rowList = Lists.newArrayList();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 313                     for (Object jsonArray : (List) val.getContent()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 314                         Row row = fillData(inputCopy.row(), jsonArray);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 315                         rowList.add(new CRow(row, inputCopy.change()));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 316                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 317                     resultFuture.complete(rowList);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 318                 } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 319                     throw new RuntimeException(&quot;not support cache obj type &quot; + val.getType());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 320                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 321                 return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 322             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 323         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 324 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 325         //connect Cassandra</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 326         connCassandraDB(cassandraSideTableInfo);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 327 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 328         String sqlCondition = sideInfo.getSqlCondition() + &quot; &quot; + sqlWhere + &quot;  ALLOW FILTERING &quot;;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 329         LOG.info(&quot;sqlCondition:{}&quot; + sqlCondition);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 330 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 331         ListenableFuture&lt;ResultSet&gt; resultSet = Futures.transformAsync(session,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 332                 new AsyncFunction&lt;Session, ResultSet&gt;() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 333                     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 334                     public ListenableFuture&lt;ResultSet&gt; apply(Session session) throws Exception {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 335                         return session.executeAsync(sqlCondition);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 336                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 337                 });</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 338 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 339         ListenableFuture&lt;List&lt;com.datastax.driver.core.Row&gt;&gt; data = Futures.transform(resultSet,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 340                 new Function&lt;ResultSet, List&lt;com.datastax.driver.core.Row&gt;&gt;() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 341                     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 342                     public List&lt;com.datastax.driver.core.Row&gt; apply(ResultSet rs) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 343                         return rs.all();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 344                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 345                 });</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 346 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 347         Futures.addCallback(data, new FutureCallback&lt;List&lt;com.datastax.driver.core.Row&gt;&gt;() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 348             @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 349             public void onSuccess(List&lt;com.datastax.driver.core.Row&gt; rows) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 350                 cluster.closeAsync();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 351                 if (rows.size() &gt; 0) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 352                     List&lt;com.datastax.driver.core.Row&gt; cacheContent = Lists.newArrayList();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 353                     List&lt;CRow&gt; rowList = Lists.newArrayList();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 354                     for (com.datastax.driver.core.Row line : rows) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 355                         Row row = fillData(inputCopy.row(), line);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 356                         if (openCache()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 357                             cacheContent.add(line);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 358                         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 359                         rowList.add(new CRow(row,inputCopy.change()));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 360                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 361                     resultFuture.complete(rowList);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 362                     if (openCache()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 363                         putCache(key, CacheObj.buildCacheObj(ECacheContentType.MultiLine, cacheContent));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 364                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 365                 } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 366                     dealMissKey(inputCopy, resultFuture);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 367                     if (openCache()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 368                         putCache(key, CacheMissVal.getMissKeyObj());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 369                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 370                     resultFuture.complete(null);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 371                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 372             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 373 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 374             @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 375             public void onFailure(Throwable t) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 376                 LOG.error(&quot;Failed to retrieve the data: %s%n&quot;,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 377                         t.getMessage());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 378                 cluster.closeAsync();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 379                 resultFuture.completeExceptionally(t);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 380             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 381         });</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 382     }</span>
 383 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 384 </span>
 385 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 386 
 387     @Override
<abbr title=" 388     public void handleAsyncInvoke(Map&lt;String, Object&gt; inputParams, CRow input, ResultFuture&lt;CRow&gt; resultFuture) throws Exception {"> 388     public void handleAsyncInvoke(Map&lt;String, Object&gt; inputParams, CRow input, ResultFuture&lt;CRow&gt; resultFüîµ</abbr>
 389 
 390         String key = buildCacheKey(inputParams);
 391         //connect Cassandra
 392         connCassandraDB(cassandraSideTableInfo);
 393 
<abbr title=" 394         String sqlCondition = sideInfo.getSqlCondition() + &quot; &quot; + buildWhereCondition(inputParams) + &quot;  ALLOW FILTERING &quot;;"> 394         String sqlCondition = sideInfo.getSqlCondition() + &quot; &quot; + buildWhereCondition(inputParams) + &quot;  ALüîµ</abbr>
 395         LOG.info(&quot;sqlCondition:{}&quot; + sqlCondition);
 396 
 397         ListenableFuture&lt;ResultSet&gt; resultSet = Futures.transformAsync(session,
 398                 new AsyncFunction&lt;Session, ResultSet&gt;() {
 399                     @Override
 400                     public ListenableFuture&lt;ResultSet&gt; apply(Session session) throws Exception {
 401                         return session.executeAsync(sqlCondition);
 402                     }
 403                 });
 404 
 405         ListenableFuture&lt;List&lt;com.datastax.driver.core.Row&gt;&gt; data = Futures.transform(resultSet,
 406                 new Function&lt;ResultSet, List&lt;com.datastax.driver.core.Row&gt;&gt;() {
 407                     @Override
 408                     public List&lt;com.datastax.driver.core.Row&gt; apply(ResultSet rs) {
 409                         return rs.all();
 410                     }
 411                 });
 412 
 413         Futures.addCallback(data, new FutureCallback&lt;List&lt;com.datastax.driver.core.Row&gt;&gt;() {
 414             @Override
 415             public void onSuccess(List&lt;com.datastax.driver.core.Row&gt; rows) {
 416                 cluster.closeAsync();
 417                 if (rows.size() &gt; 0) {
 418                     List&lt;com.datastax.driver.core.Row&gt; cacheContent = Lists.newArrayList();
 419                     List&lt;CRow&gt; rowList = Lists.newArrayList();
 420                     for (com.datastax.driver.core.Row line : rows) {
 421                         Row row = fillData(input.row(), line);
 422                         if (openCache()) {
 423                             cacheContent.add(line);
 424                         }
 425                         rowList.add(new CRow(row, input.change()));
 426                     }
 427                     resultFuture.complete(rowList);
 428                     if (openCache()) {
 429                         putCache(key, CacheObj.buildCacheObj(ECacheContentType.MultiLine, cacheContent));
 430                     }
 431                 } else {
 432                     dealMissKey(input, resultFuture);
 433                     if (openCache()) {
 434                         putCache(key, CacheMissVal.getMissKeyObj());
 435                     }
 436                     resultFuture.complete(null);
 437                 }
 438             }
 439 
 440             @Override
 441             public void onFailure(Throwable t) {
 442                 LOG.error(&quot;Failed to retrieve the data: %s%n&quot;,
 443                         t.getMessage());
 444                 cluster.closeAsync();
 445                 resultFuture.completeExceptionally(t);
 446             }
 447         });
 448     }
 449 
 450     private String buildWhereCondition(Map&lt;String, Object&gt; inputParams){
 451         StringBuilder sb = new StringBuilder(&quot; where &quot;);
 452         for(Map.Entry&lt;String, Object&gt; entry : inputParams.entrySet()){
<abbr title=" 453             Object value = entry.getValue() instanceof String ? &quot;&#x27;&quot; + entry.getValue() + &quot;&#x27;&quot; : entry.getValue();"> 453             Object value = entry.getValue() instanceof String ? &quot;&#x27;&quot; + entry.getValue() + &quot;&#x27;&quot; : entry.getVüîµ</abbr>
 454             sb.append(String.format(&quot;%s = %s&quot;, entry.getKey(), value));
 455         }
 456         return sb.toString();
 457     }
 458 
 459     @Override
 460     public Row fillData(Row input, Object line) {
 461         com.datastax.driver.core.Row rowArray = (com.datastax.driver.core.Row) line;
 462         Row row = new Row(sideInfo.getOutFieldInfoList().size());
 463         for (Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getInFieldIndex().entrySet()) {
 464             Object obj = input.getField(entry.getValue());
 465             obj = convertTimeIndictorTypeInfo(entry.getValue(), obj);
 466             row.setField(entry.getKey(), obj);
 467         }
 468 
 469         for (Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getSideFieldIndex().entrySet()) {
 470             if (rowArray == null) {
 471                 row.setField(entry.getKey(), null);
 472             } else {
 473                 row.setField(entry.getKey(), rowArray.getObject(entry.getValue()));
 474             }
 475         }
 476 
 477         return row;
 478     }
 479 
 480     @Override
 481     public void close() throws Exception {
 482         super.close();
 483         if (cluster != null) {
 484             cluster.close();
 485             cluster = null;
 486         }
 487     }
 488 
 489     @Override
 490     public String buildCacheKey(Map&lt;String, Object&gt; inputParams) {
 491         StringBuilder sb = new StringBuilder();
 492         for (Object ele : inputParams.values()) {
 493             sb.append(ele.toString()).append(&quot;_&quot;);
 494         }
 495         return sb.toString();
 496     }
 497 }
 
 
 
 
 
 </pre></td>
                            <td><pre>   1 /*
   2  * Licensed to the Apache Software Foundation (ASF) under one
   3  * or more contributor license agreements.  See the NOTICE file
   4  * distributed with this work for additional information
   5  * regarding copyright ownership.  The ASF licenses this file
   6  * to you under the Apache License, Version 2.0 (the
   7  * &quot;License&quot;); you may not use this file except in compliance
   8  * with the License.  You may obtain a copy of the License at
   9  *
  10  *     http://www.apache.org/licenses/LICENSE-2.0
  11  *
  12  * Unless required by applicable law or agreed to in writing, software
  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15  * See the License for the specific language governing permissions and
  16  * limitations under the License.
  17  */
  18 
  19 
  20 package com.dtstack.flink.sql.side.cassandra;
  21 
  22 import org.apache.flink.api.java.tuple.Tuple2;
  23 import org.apache.flink.api.java.typeutils.RowTypeInfo;
  24 import org.apache.flink.configuration.Configuration;
  25 import org.apache.flink.streaming.api.functions.async.ResultFuture;
  26 import org.apache.flink.types.Row;
  27 
  28 import com.datastax.driver.core.Cluster;
  29 import com.datastax.driver.core.ConsistencyLevel;
  30 import com.datastax.driver.core.HostDistance;
  31 import com.datastax.driver.core.PoolingOptions;
  32 import com.datastax.driver.core.QueryOptions;
  33 import com.datastax.driver.core.ResultSet;
  34 import com.datastax.driver.core.Session;
  35 import com.datastax.driver.core.SocketOptions;
  36 import com.datastax.driver.core.policies.DowngradingConsistencyRetryPolicy;
  37 import com.datastax.driver.core.policies.RetryPolicy;
  38 import com.dtstack.flink.sql.enums.ECacheContentType;
  39 import com.dtstack.flink.sql.side.BaseAsyncReqRow;
  40 import com.dtstack.flink.sql.side.CacheMissVal;
  41 import com.dtstack.flink.sql.side.FieldInfo;
  42 import com.dtstack.flink.sql.side.JoinInfo;
  43 import com.dtstack.flink.sql.side.AbstractSideTableInfo;
  44 import com.dtstack.flink.sql.side.cache.CacheObj;
  45 import com.dtstack.flink.sql.side.cassandra.table.CassandraSideTableInfo;
  46 import com.google.common.base.Function;
  47 import com.google.common.collect.Lists;
  48 import com.google.common.util.concurrent.AsyncFunction;
  49 import com.google.common.util.concurrent.FutureCallback;
  50 import com.google.common.util.concurrent.Futures;
  51 import com.google.common.util.concurrent.ListenableFuture;
  52 import io.vertx.core.json.JsonArray;
  53 import org.apache.commons.lang3.StringUtils;
  54 import org.slf4j.Logger;
  55 import org.slf4j.LoggerFactory;
  56 
  57 import java.net.InetAddress;
  58 import java.sql.Timestamp;
  59 import java.util.ArrayList;
  60 import java.util.List;
  61 import java.util.Map;
  62 
  63 /**
  64  * Reason:
  65  * Date: 2018/11/22
  66  *
  67  * @author xuqianjin
  68  */
  69 public class CassandraAsyncReqRow extends BaseAsyncReqRow {
  70 
  71     private static final long serialVersionUID = 6631584128079864735L;
  72 
  73     private static final Logger LOG = LoggerFactory.getLogger(CassandraAsyncReqRow.class);
  74 
  75     private final static int DEFAULT_VERTX_EVENT_LOOP_POOL_SIZE = 10;
  76 
  77     private final static int DEFAULT_VERTX_WORKER_POOL_SIZE = 20;
  78 
  79     private final static int DEFAULT_MAX_DB_CONN_POOL_SIZE = 20;
  80 
  81     private transient Cluster cluster;
  82     private transient ListenableFuture session;
  83     private transient CassandraSideTableInfo cassandraSideTableInfo;
  84 
<abbr title="  85     public CassandraAsyncReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, AbstractSideTableInfo sideTableInfo) {">  85     public CassandraAsyncReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoLüîµ</abbr>
<abbr title="  86         super(new com.dtstack.flink.sql.side.cassandra.CassandraAsyncSideInfo(rowTypeInfo, joinInfo, outFieldInfoList, sideTableInfo));">  86         super(new com.dtstack.flink.sql.side.cassandra.CassandraAsyncSideInfo(rowTypeInfo, joinInfo, outFüîµ</abbr>
  87     }
  88 
  89 
  90     @Override
  91     public void open(Configuration parameters) throws Exception {
  92         super.open(parameters);
  93         cassandraSideTableInfo = (CassandraSideTableInfo) sideInfo.getSideTableInfo();
  94         connCassandraDB(cassandraSideTableInfo);
  95     }
  96 
  97     private void connCassandraDB(CassandraSideTableInfo tableInfo) {
  98         try {
  99             if (session == null) {
 100                 QueryOptions queryOptions = new QueryOptions();
 101                 //The default consistency level for queries: ConsistencyLevel.TWO.
 102                 queryOptions.setConsistencyLevel(ConsistencyLevel.QUORUM);
<abbr title=" 103                 Integer maxRequestsPerConnection = tableInfo.getMaxRequestsPerConnection() == null ? 1 : tableInfo.getMaxRequestsPerConnection();"> 103                 Integer maxRequestsPerConnection = tableInfo.getMaxRequestsPerConnection() == null ? 1 : üîµ</abbr>
<abbr title=" 104                 Integer coreConnectionsPerHost = tableInfo.getCoreConnectionsPerHost() == null ? 8 : tableInfo.getCoreConnectionsPerHost();"> 104                 Integer coreConnectionsPerHost = tableInfo.getCoreConnectionsPerHost() == null ? 8 : tablüîµ</abbr>
<abbr title=" 105                 Integer maxConnectionsPerHost = tableInfo.getMaxConnectionsPerHost() == null ? 32768 : tableInfo.getMaxConnectionsPerHost();"> 105                 Integer maxConnectionsPerHost = tableInfo.getMaxConnectionsPerHost() == null ? 32768 : taüîµ</abbr>
<abbr title=" 106                 Integer maxQueueSize = tableInfo.getMaxQueueSize() == null ? 100000 : tableInfo.getMaxQueueSize();"> 106                 Integer maxQueueSize = tableInfo.getMaxQueueSize() == null ? 100000 : tableInfo.getMaxQueüîµ</abbr>
<abbr title=" 107                 Integer readTimeoutMillis = tableInfo.getReadTimeoutMillis() == null ? 60000 : tableInfo.getReadTimeoutMillis();"> 107                 Integer readTimeoutMillis = tableInfo.getReadTimeoutMillis() == null ? 60000 : tableInfo.üîµ</abbr>
<abbr title=" 108                 Integer connectTimeoutMillis = tableInfo.getConnectTimeoutMillis() == null ? 60000 : tableInfo.getConnectTimeoutMillis();"> 108                 Integer connectTimeoutMillis = tableInfo.getConnectTimeoutMillis() == null ? 60000 : tablüîµ</abbr>
<abbr title=" 109                 Integer poolTimeoutMillis = tableInfo.getPoolTimeoutMillis() == null ? 60000 : tableInfo.getPoolTimeoutMillis();"> 109                 Integer poolTimeoutMillis = tableInfo.getPoolTimeoutMillis() == null ? 60000 : tableInfo.üîµ</abbr>
 110                 Integer cassandraPort = 0;
 111                 String address = tableInfo.getAddress();
 112                 String userName = tableInfo.getUserName();
 113                 String password = tableInfo.getPassword();
 114                 String database = tableInfo.getDatabase();
 115 
 116                 ArrayList serversList = new ArrayList();
 117                 //Read timeout or connection timeout Settings
 118                 SocketOptions so = new SocketOptions()
 119                         .setReadTimeoutMillis(readTimeoutMillis)
 120                         .setConnectTimeoutMillis(connectTimeoutMillis);
 121 
 122                 //The cluster USES hostdistance.local in the same machine room
 123                 //Hostdistance. REMOTE is used for different machine rooms
 124                 //Ignore use HostDistance. IGNORED
 125                 PoolingOptions poolingOptions = new PoolingOptions()
 126                         //Each connection allows a maximum of 64 concurrent requests
 127                         .setMaxRequestsPerConnection(HostDistance.LOCAL, maxRequestsPerConnection)
 128                         //Have at least two connections to each machine in the cluster
 129                         .setCoreConnectionsPerHost(HostDistance.LOCAL, coreConnectionsPerHost)
 130                         //There are up to eight connections to each machine in the cluster
 131                         .setMaxConnectionsPerHost(HostDistance.LOCAL, maxConnectionsPerHost)
 132                         .setMaxQueueSize(maxQueueSize)
 133                         .setPoolTimeoutMillis(poolTimeoutMillis);
 134                 //ÈáçËØïÁ≠ñÁï•
 135                 RetryPolicy retryPolicy = DowngradingConsistencyRetryPolicy.INSTANCE;
 136 
 137                 for (String server : StringUtils.split(address, &quot;,&quot;)) {
 138                     cassandraPort = Integer.parseInt(StringUtils.split(server, &quot;:&quot;)[1]);
 139                     serversList.add(InetAddress.getByName(StringUtils.split(server, &quot;:&quot;)[0]));
 140                 }
 141 
 142                 if (userName == null || userName.isEmpty() || password == null || password.isEmpty()) {
<abbr title=" 143                     cluster = Cluster.builder().addContactPoints(serversList).withRetryPolicy(retryPolicy)"> 143                     cluster = Cluster.builder().addContactPoints(serversList).withRetryPolicy(retryPolicyüîµ</abbr>
 144                             .withPort(cassandraPort)
 145                             .withPoolingOptions(poolingOptions).withSocketOptions(so)
 146                             .withQueryOptions(queryOptions).build();
 147                 } else {
<abbr title=" 148                     cluster = Cluster.builder().addContactPoints(serversList).withRetryPolicy(retryPolicy)"> 148                     cluster = Cluster.builder().addContactPoints(serversList).withRetryPolicy(retryPolicyüîµ</abbr>
 149                             .withPort(cassandraPort)
 150                             .withPoolingOptions(poolingOptions).withSocketOptions(so)
 151                             .withCredentials(userName, password)
 152                             .withQueryOptions(queryOptions).build();
 153                 }
 154                 // Âª∫Á´ãËøûÊé• ËøûÊé•Â∑≤Â≠òÂú®ÁöÑÈîÆÁ©∫Èó¥
 155                 session = cluster.connectAsync(database);
 156                 LOG.info(&quot;connect cassandra is successed!&quot;);
 157             }
 158         } catch (Exception e) {
 159             LOG.error(&quot;connect cassandra is error:&quot; + e.getMessage());
 160         }
 161     }
 162 
 163     @Override
 164 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 165     public void asyncInvoke(Tuple2&lt;Boolean,Row&gt; input, ResultFuture&lt;Tuple2&lt;Boolean,Row&gt;&gt; resultFuture) throws Exception {"> 165     public void asyncInvoke(Tuple2&lt;Boolean,Row&gt; input, ResultFuture&lt;Tuple2&lt;Boolean,Row&gt;&gt; resultFuture) thüîµ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 166         Tuple2&lt;Boolean, Row&gt; inputCopy = Tuple2.of(input.f0, input.f1);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 167         JsonArray inputParams = new JsonArray();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 168         StringBuffer stringBuffer = new StringBuffer();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 169         String sqlWhere = &quot; where &quot;;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 170 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 171         for (int i = 0; i &lt; sideInfo.getEqualFieldList().size(); i++) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 172             Integer conValIndex = sideInfo.getEqualValIndex().get(i);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 173             Object equalObj = inputCopy.f1.getField(conValIndex);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 174             if (equalObj == null) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 175                 dealMissKey(inputCopy, resultFuture);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 176                 return;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 177             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 178             inputParams.add(equalObj);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 179             StringBuffer sqlTemp = stringBuffer.append(sideInfo.getEqualFieldList().get(i))</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 180                     .append(&quot; = &quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 181             if (equalObj instanceof String) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 182                 sqlTemp.append(&quot;&#x27;&quot; + equalObj + &quot;&#x27;&quot;)</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 183                         .append(&quot; and &quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 184             } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 185                 sqlTemp.append(equalObj)</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 186                         .append(&quot; and &quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 187             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 188 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 189         }</span>
 190 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 191 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 191 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwüîµ</abbr></span>
 192 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 193 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 194     public void handleAsyncInvoke(Map&lt;String, Object&gt; inputParams, CRow input, ResultFuture&lt;CRow&gt; resultFuture) throws Exception {"> 194     public void handleAsyncInvoke(Map&lt;String, Object&gt; inputParams, CRow input, ResultFuture&lt;CRow&gt; resultFüîµ</abbr></span>
 195 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 196 
 197         String key = buildCacheKey(inputParams);
 198 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 199         sqlWhere = sqlWhere + stringBuffer.toString().substring(0, stringBuffer.lastIndexOf(&quot; and &quot;));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 200 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 201         if (openCache()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 202             CacheObj val = getFromCache(key);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 203             if (val != null) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 204 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 205                 if (ECacheContentType.MissVal == val.getType()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 206                     dealMissKey(inputCopy, resultFuture);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 207                     return;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 208                 } else if (ECacheContentType.MultiLine == val.getType()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 209                     List&lt;Tuple2&lt;Boolean,Row&gt;&gt; rowList = Lists.newArrayList();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 210                     for (Object jsonArray : (List) val.getContent()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 211                         Row row = fillData(inputCopy.f1, jsonArray);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 212                         rowList.add(Tuple2.of(inputCopy.f0, row));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 213                     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 214                     resultFuture.complete(rowList);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 215                 } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 216                     throw new RuntimeException(&quot;not support cache obj type &quot; + val.getType());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 217                 }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 218                 return;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 219             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 220         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 221 </span>
 222 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 223 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 223 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwüîµ</abbr></span>
 224 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 225 </span>
 226 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 227         //connect Cassandra
 228         connCassandraDB(cassandraSideTableInfo);
 229 
<abbr title=" 230         String sqlCondition = sideInfo.getSqlCondition() + &quot; &quot; + buildWhereCondition(inputParams) + &quot;  ALLOW FILTERING &quot;;"> 230         String sqlCondition = sideInfo.getSqlCondition() + &quot; &quot; + buildWhereCondition(inputParams) + &quot;  ALüîµ</abbr>
 231         LOG.info(&quot;sqlCondition:{}&quot; + sqlCondition);
 232 
 233         ListenableFuture&lt;ResultSet&gt; resultSet = Futures.transformAsync(session,
 234                 new AsyncFunction&lt;Session, ResultSet&gt;() {
 235                     @Override
 236                     public ListenableFuture&lt;ResultSet&gt; apply(Session session) throws Exception {
 237                         return session.executeAsync(sqlCondition);
 238                     }
 239                 });
 240 
 241         ListenableFuture&lt;List&lt;com.datastax.driver.core.Row&gt;&gt; data = Futures.transform(resultSet,
 242                 new Function&lt;ResultSet, List&lt;com.datastax.driver.core.Row&gt;&gt;() {
 243                     @Override
 244                     public List&lt;com.datastax.driver.core.Row&gt; apply(ResultSet rs) {
 245                         return rs.all();
 246                     }
 247                 });
 248 
 249         Futures.addCallback(data, new FutureCallback&lt;List&lt;com.datastax.driver.core.Row&gt;&gt;() {
 250             @Override
 251             public void onSuccess(List&lt;com.datastax.driver.core.Row&gt; rows) {
 252                 cluster.closeAsync();
 253                 if (rows.size() &gt; 0) {
 254                     List&lt;com.datastax.driver.core.Row&gt; cacheContent = Lists.newArrayList();
 255                     List&lt;Tuple2&lt;Boolean,Row&gt;&gt; rowList = Lists.newArrayList();
 256                     for (com.datastax.driver.core.Row line : rows) {
 257 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 258                         Row row = fillData(inputCopy.f1, line);</span>
 259 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 260 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 260 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwüîµ</abbr></span>
 261 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 262 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 263                         Row row = fillData(input.row(), line);</span>
 264 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 265                         if (openCache()) {
 266                             cacheContent.add(line);
 267                         }
 268 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 269                         rowList.add(Tuple2.of(inputCopy.f0,row));</span>
 270 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 271 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 271 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwüîµ</abbr></span>
 272 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 273 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 274                         rowList.add(new CRow(row, input.change()));</span>
 275 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 276                     }
 277                     resultFuture.complete(rowList);
 278                     if (openCache()) {
 279                         putCache(key, CacheObj.buildCacheObj(ECacheContentType.MultiLine, cacheContent));
 280                     }
 281                 } else {
 282                     dealMissKey(input, resultFuture);
 283                     if (openCache()) {
 284                         putCache(key, CacheMissVal.getMissKeyObj());
 285                     }
 286                     resultFuture.complete(null);
 287                 }
 288             }
 289 
 290             @Override
 291             public void onFailure(Throwable t) {
 292                 LOG.error(&quot;Failed to retrieve the data: %s%n&quot;,
 293                         t.getMessage());
 294                 cluster.closeAsync();
 295                 resultFuture.completeExceptionally(t);
 296             }
 297         });
 298     }
 299 
 300     @Override
 301     public String buildCacheKey(Map&lt;String, Object&gt; inputParams) {
 302         StringBuilder sb = new StringBuilder();
 303         for (Object ele : inputParams.values()) {
 304             sb.append(ele.toString()).append(&quot;_&quot;);
 305         }
 306         return sb.toString();
 307     }
 308 
 309     private String buildWhereCondition(Map&lt;String, Object&gt; inputParams){
 310         StringBuilder sb = new StringBuilder(&quot; where &quot;);
 311         for(Map.Entry&lt;String, Object&gt; entry : inputParams.entrySet()){
<abbr title=" 312             Object value = entry.getValue() instanceof String ? &quot;&#x27;&quot; + entry.getValue() + &quot;&#x27;&quot; : entry.getValue();"> 312             Object value = entry.getValue() instanceof String ? &quot;&#x27;&quot; + entry.getValue() + &quot;&#x27;&quot; : entry.getVüîµ</abbr>
 313             sb.append(String.format(&quot;%s = %s&quot;, entry.getKey(), value));
 314         }
 315         return sb.toString();
 316     }
 317 
 318     @Override
 319     public Row fillData(Row input, Object line) {
 320         com.datastax.driver.core.Row rowArray = (com.datastax.driver.core.Row) line;
 321         Row row = new Row(sideInfo.getOutFieldInfoList().size());
 322         for (Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getInFieldIndex().entrySet()) {
 323             Object obj = input.getField(entry.getValue());
 324             obj = convertTimeIndictorTypeInfo(entry.getValue(), obj);
 325             row.setField(entry.getKey(), obj);
 326         }
 327 
 328         for (Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getSideFieldIndex().entrySet()) {
 329             if (rowArray == null) {
 330                 row.setField(entry.getKey(), null);
 331             } else {
 332                 row.setField(entry.getKey(), rowArray.getObject(entry.getValue()));
 333             }
 334         }
 335 
 336         return row;
 337     }
 338 
 339     @Override
 340     public void close() throws Exception {
 341         super.close();
 342         if (cluster != null) {
 343             cluster.close();
 344             cluster = null;
 345         }
 346     }
 347 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  /*
   2   * Licensed to the Apache Software Foundation (ASF) under one
   3   * or more contributor license agreements.  See the NOTICE file
   4   * distributed with this work for additional information
   5   * regarding copyright ownership.  The ASF licenses this file
   6   * to you under the Apache License, Version 2.0 (the
   7   * &quot;License&quot;); you may not use this file except in compliance
   8   * with the License.  You may obtain a copy of the License at
   9   *
  10   *     http://www.apache.org/licenses/LICENSE-2.0
  11   *
  12   * Unless required by applicable law or agreed to in writing, software
  13   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15   * See the License for the specific language governing permissions and
  16   * limitations under the License.
  17   */
  18  
  19  
  20  package com.dtstack.flink.sql.side.cassandra;
  21  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  22 +import org.apache.flink.api.java.tuple.Tuple2;</span>
  23  import org.apache.flink.api.java.typeutils.RowTypeInfo;
  24  import org.apache.flink.configuration.Configuration;
  25  import org.apache.flink.streaming.api.functions.async.ResultFuture;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  26 -import org.apache.flink.table.runtime.types.CRow;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  27 -import org.apache.flink.table.typeutils.TimeIndicatorTypeInfo;</span>
  28  import org.apache.flink.types.Row;
  29  
  30  import com.datastax.driver.core.Cluster;
  31  import com.datastax.driver.core.ConsistencyLevel;
  32  import com.datastax.driver.core.HostDistance;
  33  import com.datastax.driver.core.PoolingOptions;
  34  import com.datastax.driver.core.QueryOptions;
  35  import com.datastax.driver.core.ResultSet;
  36  import com.datastax.driver.core.Session;
  37  import com.datastax.driver.core.SocketOptions;
  38  import com.datastax.driver.core.policies.DowngradingConsistencyRetryPolicy;
  39  import com.datastax.driver.core.policies.RetryPolicy;
  40  import com.dtstack.flink.sql.enums.ECacheContentType;
  41  import com.dtstack.flink.sql.side.BaseAsyncReqRow;
  42  import com.dtstack.flink.sql.side.CacheMissVal;
  43  import com.dtstack.flink.sql.side.FieldInfo;
  44  import com.dtstack.flink.sql.side.JoinInfo;
  45  import com.dtstack.flink.sql.side.AbstractSideTableInfo;
  46  import com.dtstack.flink.sql.side.cache.CacheObj;
  47  import com.dtstack.flink.sql.side.cassandra.table.CassandraSideTableInfo;
  48  import com.google.common.base.Function;
  49  import com.google.common.collect.Lists;
  50  import com.google.common.util.concurrent.AsyncFunction;
  51  import com.google.common.util.concurrent.FutureCallback;
  52  import com.google.common.util.concurrent.Futures;
  53  import com.google.common.util.concurrent.ListenableFuture;
  54  import io.vertx.core.json.JsonArray;
  55  import org.apache.commons.lang3.StringUtils;
  56  import org.slf4j.Logger;
  57  import org.slf4j.LoggerFactory;
  58  
  59  import java.net.InetAddress;
  60  import java.sql.Timestamp;
  61  import java.util.ArrayList;
  62  import java.util.List;
  63  import java.util.Map;
  64  
  65  /**
  66   * Reason:
  67   * Date: 2018/11/22
  68   *
  69   * @author xuqianjin
  70   */
  71  public class CassandraAsyncReqRow extends BaseAsyncReqRow {
  72  
  73      private static final long serialVersionUID = 6631584128079864735L;
  74  
  75      private static final Logger LOG = LoggerFactory.getLogger(CassandraAsyncReqRow.class);
  76  
  77      private final static int DEFAULT_VERTX_EVENT_LOOP_POOL_SIZE = 10;
  78  
  79      private final static int DEFAULT_VERTX_WORKER_POOL_SIZE = 20;
  80  
  81      private final static int DEFAULT_MAX_DB_CONN_POOL_SIZE = 20;
  82  
  83      private transient Cluster cluster;
  84      private transient ListenableFuture session;
  85      private transient CassandraSideTableInfo cassandraSideTableInfo;
  86  
<abbr title="  87      public CassandraAsyncReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, AbstractSideTableInfo sideTableInfo) {">  87      public CassandraAsyncReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, Abstüîµ</abbr>
<abbr title="  88          super(new com.dtstack.flink.sql.side.cassandra.CassandraAsyncSideInfo(rowTypeInfo, joinInfo, outFieldInfoList, sideTableInfo));">  88          super(new com.dtstack.flink.sql.side.cassandra.CassandraAsyncSideInfo(rowTypeInfo, joinInfo, outFieldInfoLüîµ</abbr>
  89      }
  90  
  91  
  92      @Override
  93      public void open(Configuration parameters) throws Exception {
  94          super.open(parameters);
  95          cassandraSideTableInfo = (CassandraSideTableInfo) sideInfo.getSideTableInfo();
  96          connCassandraDB(cassandraSideTableInfo);
  97      }
  98  
  99      private void connCassandraDB(CassandraSideTableInfo tableInfo) {
 100          try {
 101              if (session == null) {
 102                  QueryOptions queryOptions = new QueryOptions();
 103                  //The default consistency level for queries: ConsistencyLevel.TWO.
 104                  queryOptions.setConsistencyLevel(ConsistencyLevel.QUORUM);
<abbr title=" 105                  Integer maxRequestsPerConnection = tableInfo.getMaxRequestsPerConnection() == null ? 1 : tableInfo.getMaxRequestsPerConnection();"> 105                  Integer maxRequestsPerConnection = tableInfo.getMaxRequestsPerConnection() == null ? 1 : tableInfoüîµ</abbr>
<abbr title=" 106                  Integer coreConnectionsPerHost = tableInfo.getCoreConnectionsPerHost() == null ? 8 : tableInfo.getCoreConnectionsPerHost();"> 106                  Integer coreConnectionsPerHost = tableInfo.getCoreConnectionsPerHost() == null ? 8 : tableInfo.getüîµ</abbr>
<abbr title=" 107                  Integer maxConnectionsPerHost = tableInfo.getMaxConnectionsPerHost() == null ? 32768 : tableInfo.getMaxConnectionsPerHost();"> 107                  Integer maxConnectionsPerHost = tableInfo.getMaxConnectionsPerHost() == null ? 32768 : tableInfo.güîµ</abbr>
 108                  Integer maxQueueSize = tableInfo.getMaxQueueSize() == null ? 100000 : tableInfo.getMaxQueueSize();
<abbr title=" 109                  Integer readTimeoutMillis = tableInfo.getReadTimeoutMillis() == null ? 60000 : tableInfo.getReadTimeoutMillis();"> 109                  Integer readTimeoutMillis = tableInfo.getReadTimeoutMillis() == null ? 60000 : tableInfo.getReadTiüîµ</abbr>
<abbr title=" 110                  Integer connectTimeoutMillis = tableInfo.getConnectTimeoutMillis() == null ? 60000 : tableInfo.getConnectTimeoutMillis();"> 110                  Integer connectTimeoutMillis = tableInfo.getConnectTimeoutMillis() == null ? 60000 : tableInfo.getüîµ</abbr>
<abbr title=" 111                  Integer poolTimeoutMillis = tableInfo.getPoolTimeoutMillis() == null ? 60000 : tableInfo.getPoolTimeoutMillis();"> 111                  Integer poolTimeoutMillis = tableInfo.getPoolTimeoutMillis() == null ? 60000 : tableInfo.getPoolTiüîµ</abbr>
 112                  Integer cassandraPort = 0;
 113                  String address = tableInfo.getAddress();
 114                  String userName = tableInfo.getUserName();
 115                  String password = tableInfo.getPassword();
 116                  String database = tableInfo.getDatabase();
 117  
 118                  ArrayList serversList = new ArrayList();
 119                  //Read timeout or connection timeout Settings
 120                  SocketOptions so = new SocketOptions()
 121                          .setReadTimeoutMillis(readTimeoutMillis)
 122                          .setConnectTimeoutMillis(connectTimeoutMillis);
 123  
 124                  //The cluster USES hostdistance.local in the same machine room
 125                  //Hostdistance. REMOTE is used for different machine rooms
 126                  //Ignore use HostDistance. IGNORED
 127                  PoolingOptions poolingOptions = new PoolingOptions()
 128                          //Each connection allows a maximum of 64 concurrent requests
 129                          .setMaxRequestsPerConnection(HostDistance.LOCAL, maxRequestsPerConnection)
 130                          //Have at least two connections to each machine in the cluster
 131                          .setCoreConnectionsPerHost(HostDistance.LOCAL, coreConnectionsPerHost)
 132                          //There are up to eight connections to each machine in the cluster
 133                          .setMaxConnectionsPerHost(HostDistance.LOCAL, maxConnectionsPerHost)
 134                          .setMaxQueueSize(maxQueueSize)
 135                          .setPoolTimeoutMillis(poolTimeoutMillis);
 136                  //ÈáçËØïÁ≠ñÁï•
 137                  RetryPolicy retryPolicy = DowngradingConsistencyRetryPolicy.INSTANCE;
 138  
 139                  for (String server : StringUtils.split(address, &quot;,&quot;)) {
 140                      cassandraPort = Integer.parseInt(StringUtils.split(server, &quot;:&quot;)[1]);
 141                      serversList.add(InetAddress.getByName(StringUtils.split(server, &quot;:&quot;)[0]));
 142                  }
 143  
 144                  if (userName == null || userName.isEmpty() || password == null || password.isEmpty()) {
 145                      cluster = Cluster.builder().addContactPoints(serversList).withRetryPolicy(retryPolicy)
 146                              .withPort(cassandraPort)
 147                              .withPoolingOptions(poolingOptions).withSocketOptions(so)
 148                              .withQueryOptions(queryOptions).build();
 149                  } else {
 150                      cluster = Cluster.builder().addContactPoints(serversList).withRetryPolicy(retryPolicy)
 151                              .withPort(cassandraPort)
 152                              .withPoolingOptions(poolingOptions).withSocketOptions(so)
 153                              .withCredentials(userName, password)
 154                              .withQueryOptions(queryOptions).build();
 155                  }
 156                  // Âª∫Á´ãËøûÊé• ËøûÊé•Â∑≤Â≠òÂú®ÁöÑÈîÆÁ©∫Èó¥
 157                  session = cluster.connectAsync(database);
 158                  LOG.info(&quot;connect cassandra is successed!&quot;);
 159              }
 160          } catch (Exception e) {
 161              LOG.error(&quot;connect cassandra is error:&quot; + e.getMessage());
 162          }
 163      }
 164  
 165      @Override
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 166 -    public void asyncInvoke(CRow input, ResultFuture&lt;CRow&gt; resultFuture) throws Exception {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 167 -        CRow inputCopy = new CRow(input.row(), input.change());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 168 +    public void asyncInvoke(Tuple2&lt;Boolean,Row&gt; input, ResultFuture&lt;Tuple2&lt;Boolean,Row&gt;&gt; resultFuture) throws Exception {"> 168 +    public void asyncInvoke(Tuple2&lt;Boolean,Row&gt; input, ResultFuture&lt;Tuple2&lt;Boolean,Row&gt;&gt; resultFuture) throws Exceüîµ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 169 +        Tuple2&lt;Boolean, Row&gt; inputCopy = Tuple2.of(input.f0, input.f1);</span>
 170          JsonArray inputParams = new JsonArray();
 171          StringBuffer stringBuffer = new StringBuffer();
 172          String sqlWhere = &quot; where &quot;;
 173  
 174          for (int i = 0; i &lt; sideInfo.getEqualFieldList().size(); i++) {
 175              Integer conValIndex = sideInfo.getEqualValIndex().get(i);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 176 -            Object equalObj = inputCopy.row().getField(conValIndex);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 177 +            Object equalObj = inputCopy.f1.getField(conValIndex);</span>
 178              if (equalObj == null) {
 179                  dealMissKey(inputCopy, resultFuture);
 180                  return;
 181              }
 182              inputParams.add(equalObj);
 183              StringBuffer sqlTemp = stringBuffer.append(sideInfo.getEqualFieldList().get(i))
 184                      .append(&quot; = &quot;);
 185              if (equalObj instanceof String) {
 186                  sqlTemp.append(&quot;&#x27;&quot; + equalObj + &quot;&#x27;&quot;)
 187                          .append(&quot; and &quot;);
 188              } else {
 189                  sqlTemp.append(equalObj)
 190                          .append(&quot; and &quot;);
 191              }
 192  
 193          }

 194  
 195          String key = buildCacheKey(inputParams);
 196          sqlWhere = sqlWhere + stringBuffer.toString().substring(0, stringBuffer.lastIndexOf(&quot; and &quot;));
 197  
 198          if (openCache()) {
 199              CacheObj val = getFromCache(key);
 200              if (val != null) {
 201  
 202                  if (ECacheContentType.MissVal == val.getType()) {
 203                      dealMissKey(inputCopy, resultFuture);
 204                      return;
 205                  } else if (ECacheContentType.MultiLine == val.getType()) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 206 -                    List&lt;CRow&gt; rowList = Lists.newArrayList();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 207 +                    List&lt;Tuple2&lt;Boolean,Row&gt;&gt; rowList = Lists.newArrayList();</span>
 208                      for (Object jsonArray : (List) val.getContent()) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 209 -                        Row row = fillData(inputCopy.row(), jsonArray);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 210 -                        rowList.add(new CRow(row, inputCopy.change()));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 211 +                        Row row = fillData(inputCopy.f1, jsonArray);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 212 +                        rowList.add(Tuple2.of(inputCopy.f0, row));</span>
 213                      }
 214                      resultFuture.complete(rowList);
 215                  } else {
 216                      throw new RuntimeException(&quot;not support cache obj type &quot; + val.getType());
 217                  }
 218                  return;
 219              }
 220          }
 221  
 222          //connect Cassandra
 223          connCassandraDB(cassandraSideTableInfo);
 224  
 225          String sqlCondition = sideInfo.getSqlCondition() + &quot; &quot; + sqlWhere + &quot;  ALLOW FILTERING &quot;;

 226          LOG.info(&quot;sqlCondition:{}&quot; + sqlCondition);
 227  
 228          ListenableFuture&lt;ResultSet&gt; resultSet = Futures.transformAsync(session,
 229                  new AsyncFunction&lt;Session, ResultSet&gt;() {
 230                      @Override
 231                      public ListenableFuture&lt;ResultSet&gt; apply(Session session) throws Exception {
 232                          return session.executeAsync(sqlCondition);
 233                      }
 234                  });
 235  
 236          ListenableFuture&lt;List&lt;com.datastax.driver.core.Row&gt;&gt; data = Futures.transform(resultSet,
 237                  new Function&lt;ResultSet, List&lt;com.datastax.driver.core.Row&gt;&gt;() {
 238                      @Override
 239                      public List&lt;com.datastax.driver.core.Row&gt; apply(ResultSet rs) {
 240                          return rs.all();
 241                      }
 242                  });
 243  
 244          Futures.addCallback(data, new FutureCallback&lt;List&lt;com.datastax.driver.core.Row&gt;&gt;() {
 245              @Override
 246              public void onSuccess(List&lt;com.datastax.driver.core.Row&gt; rows) {
 247                  cluster.closeAsync();
 248                  if (rows.size() &gt; 0) {
 249                      List&lt;com.datastax.driver.core.Row&gt; cacheContent = Lists.newArrayList();
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 250 -                    List&lt;CRow&gt; rowList = Lists.newArrayList();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 251 +                    List&lt;Tuple2&lt;Boolean,Row&gt;&gt; rowList = Lists.newArrayList();</span>
 252                      for (com.datastax.driver.core.Row line : rows) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 253 -                        Row row = fillData(inputCopy.row(), line);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 254 +                        Row row = fillData(inputCopy.f1, line);</span>
 255                          if (openCache()) {
 256                              cacheContent.add(line);
 257                          }
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 258 -                        rowList.add(new CRow(row,inputCopy.change()));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 259 +                        rowList.add(Tuple2.of(inputCopy.f0,row));</span>
 260                      }
 261                      resultFuture.complete(rowList);
 262                      if (openCache()) {
 263                          putCache(key, CacheObj.buildCacheObj(ECacheContentType.MultiLine, cacheContent));
 264                      }
 265                  } else {
 266                      dealMissKey(inputCopy, resultFuture);

 267                      if (openCache()) {
 268                          putCache(key, CacheMissVal.getMissKeyObj());
 269                      }
 270                      resultFuture.complete(null);
 271                  }
 272              }
 273  
 274              @Override
 275              public void onFailure(Throwable t) {
 276                  LOG.error(&quot;Failed to retrieve the data: %s%n&quot;,
 277                          t.getMessage());
 278                  cluster.closeAsync();
 279                  resultFuture.completeExceptionally(t);
 280              }
 281          });
 282      }
 283  
 284      @Override


















 285      public Row fillData(Row input, Object line) {
 286          com.datastax.driver.core.Row rowArray = (com.datastax.driver.core.Row) line;
 287          Row row = new Row(sideInfo.getOutFieldInfoList().size());
 288          for (Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getInFieldIndex().entrySet()) {
 289              Object obj = input.getField(entry.getValue());
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 290 -            boolean isTimeIndicatorTypeInfo = TimeIndicatorTypeInfo.class.isAssignableFrom(sideInfo.getRowTypeInfo().getTypeAt(entry.getValue()).getClass());"> 290 -            boolean isTimeIndicatorTypeInfo = TimeIndicatorTypeInfo.class.isAssignableFrom(sideInfo.getRowTypeInfoüîµ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 291 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 292 -            if (obj instanceof Timestamp &amp;&amp; isTimeIndicatorTypeInfo) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 293 -                obj = ((Timestamp) obj).getTime();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 294 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 295 -</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 296 +            obj = convertTimeIndictorTypeInfo(entry.getValue(), obj);</span>
 297              row.setField(entry.getKey(), obj);
 298          }
 299  
 300          for (Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getSideFieldIndex().entrySet()) {
 301              if (rowArray == null) {
 302                  row.setField(entry.getKey(), null);
 303              } else {
 304                  row.setField(entry.getKey(), rowArray.getObject(entry.getValue()));
 305              }
 306          }
 307  
 308          return row;
 309      }
 310  
 311      @Override
 312      public void close() throws Exception {
 313          super.close();
 314          if (cluster != null) {
 315              cluster.close();
 316              cluster = null;
 317          }
 318      }
 319  
 320      public String buildCacheKey(JsonArray jsonArray) {
 321          StringBuilder sb = new StringBuilder();
 322          for (Object ele : jsonArray.getList()) {
 323              sb.append(ele.toString())
 324                      .append(&quot;_&quot;);
 325          }
 326  
 327          return sb.toString();
 328      }
 329  }</pre></td>
                            <td><pre>   1  /*
   2   * Licensed to the Apache Software Foundation (ASF) under one
   3   * or more contributor license agreements.  See the NOTICE file
   4   * distributed with this work for additional information
   5   * regarding copyright ownership.  The ASF licenses this file
   6   * to you under the Apache License, Version 2.0 (the
   7   * &quot;License&quot;); you may not use this file except in compliance
   8   * with the License.  You may obtain a copy of the License at
   9   *
  10   *     http://www.apache.org/licenses/LICENSE-2.0
  11   *
  12   * Unless required by applicable law or agreed to in writing, software
  13   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15   * See the License for the specific language governing permissions and
  16   * limitations under the License.
  17   */
  18  
  19  
  20  package com.dtstack.flink.sql.side.cassandra;
  21  

  22  import org.apache.flink.api.java.typeutils.RowTypeInfo;
  23  import org.apache.flink.configuration.Configuration;
  24  import org.apache.flink.streaming.api.functions.async.ResultFuture;
  25  import org.apache.flink.table.runtime.types.CRow;
  26  import org.apache.flink.table.typeutils.TimeIndicatorTypeInfo;
  27  import org.apache.flink.types.Row;
  28  
  29  import com.datastax.driver.core.Cluster;
  30  import com.datastax.driver.core.ConsistencyLevel;
  31  import com.datastax.driver.core.HostDistance;
  32  import com.datastax.driver.core.PoolingOptions;
  33  import com.datastax.driver.core.QueryOptions;
  34  import com.datastax.driver.core.ResultSet;
  35  import com.datastax.driver.core.Session;
  36  import com.datastax.driver.core.SocketOptions;
  37  import com.datastax.driver.core.policies.DowngradingConsistencyRetryPolicy;
  38  import com.datastax.driver.core.policies.RetryPolicy;
  39  import com.dtstack.flink.sql.enums.ECacheContentType;
  40  import com.dtstack.flink.sql.side.BaseAsyncReqRow;
  41  import com.dtstack.flink.sql.side.CacheMissVal;
  42  import com.dtstack.flink.sql.side.FieldInfo;
  43  import com.dtstack.flink.sql.side.JoinInfo;
  44  import com.dtstack.flink.sql.side.AbstractSideTableInfo;
  45  import com.dtstack.flink.sql.side.cache.CacheObj;
  46  import com.dtstack.flink.sql.side.cassandra.table.CassandraSideTableInfo;
  47  import com.google.common.base.Function;
  48  import com.google.common.collect.Lists;
  49  import com.google.common.util.concurrent.AsyncFunction;
  50  import com.google.common.util.concurrent.FutureCallback;
  51  import com.google.common.util.concurrent.Futures;
  52  import com.google.common.util.concurrent.ListenableFuture;
  53  import io.vertx.core.json.JsonArray;
  54  import org.apache.commons.lang3.StringUtils;
  55  import org.slf4j.Logger;
  56  import org.slf4j.LoggerFactory;
  57  
  58  import java.net.InetAddress;
  59  import java.sql.Timestamp;
  60  import java.util.ArrayList;
  61  import java.util.List;
  62  import java.util.Map;
  63  
  64  /**
  65   * Reason:
  66   * Date: 2018/11/22
  67   *
  68   * @author xuqianjin
  69   */
  70  public class CassandraAsyncReqRow extends BaseAsyncReqRow {
  71  
  72      private static final long serialVersionUID = 6631584128079864735L;
  73  
  74      private static final Logger LOG = LoggerFactory.getLogger(CassandraAsyncReqRow.class);
  75  
  76      private final static int DEFAULT_VERTX_EVENT_LOOP_POOL_SIZE = 10;
  77  
  78      private final static int DEFAULT_VERTX_WORKER_POOL_SIZE = 20;
  79  
  80      private final static int DEFAULT_MAX_DB_CONN_POOL_SIZE = 20;
  81  
  82      private transient Cluster cluster;
  83      private transient ListenableFuture session;
  84      private transient CassandraSideTableInfo cassandraSideTableInfo;
  85  
<abbr title="  86      public CassandraAsyncReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, AbstractSideTableInfo sideTableInfo) {">  86      public CassandraAsyncReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, Abstüîµ</abbr>
<abbr title="  87          super(new com.dtstack.flink.sql.side.cassandra.CassandraAsyncSideInfo(rowTypeInfo, joinInfo, outFieldInfoList, sideTableInfo));">  87          super(new com.dtstack.flink.sql.side.cassandra.CassandraAsyncSideInfo(rowTypeInfo, joinInfo, outFieldInfoLüîµ</abbr>
  88      }
  89  
  90  
  91      @Override
  92      public void open(Configuration parameters) throws Exception {
  93          super.open(parameters);
  94          cassandraSideTableInfo = (CassandraSideTableInfo) sideInfo.getSideTableInfo();
  95          connCassandraDB(cassandraSideTableInfo);
  96      }
  97  
  98      private void connCassandraDB(CassandraSideTableInfo tableInfo) {
  99          try {
 100              if (session == null) {
 101                  QueryOptions queryOptions = new QueryOptions();
 102                  //The default consistency level for queries: ConsistencyLevel.TWO.
 103                  queryOptions.setConsistencyLevel(ConsistencyLevel.QUORUM);
<abbr title=" 104                  Integer maxRequestsPerConnection = tableInfo.getMaxRequestsPerConnection() == null ? 1 : tableInfo.getMaxRequestsPerConnection();"> 104                  Integer maxRequestsPerConnection = tableInfo.getMaxRequestsPerConnection() == null ? 1 : tableInfoüîµ</abbr>
<abbr title=" 105                  Integer coreConnectionsPerHost = tableInfo.getCoreConnectionsPerHost() == null ? 8 : tableInfo.getCoreConnectionsPerHost();"> 105                  Integer coreConnectionsPerHost = tableInfo.getCoreConnectionsPerHost() == null ? 8 : tableInfo.getüîµ</abbr>
<abbr title=" 106                  Integer maxConnectionsPerHost = tableInfo.getMaxConnectionsPerHost() == null ? 32768 : tableInfo.getMaxConnectionsPerHost();"> 106                  Integer maxConnectionsPerHost = tableInfo.getMaxConnectionsPerHost() == null ? 32768 : tableInfo.güîµ</abbr>
 107                  Integer maxQueueSize = tableInfo.getMaxQueueSize() == null ? 100000 : tableInfo.getMaxQueueSize();
<abbr title=" 108                  Integer readTimeoutMillis = tableInfo.getReadTimeoutMillis() == null ? 60000 : tableInfo.getReadTimeoutMillis();"> 108                  Integer readTimeoutMillis = tableInfo.getReadTimeoutMillis() == null ? 60000 : tableInfo.getReadTiüîµ</abbr>
<abbr title=" 109                  Integer connectTimeoutMillis = tableInfo.getConnectTimeoutMillis() == null ? 60000 : tableInfo.getConnectTimeoutMillis();"> 109                  Integer connectTimeoutMillis = tableInfo.getConnectTimeoutMillis() == null ? 60000 : tableInfo.getüîµ</abbr>
<abbr title=" 110                  Integer poolTimeoutMillis = tableInfo.getPoolTimeoutMillis() == null ? 60000 : tableInfo.getPoolTimeoutMillis();"> 110                  Integer poolTimeoutMillis = tableInfo.getPoolTimeoutMillis() == null ? 60000 : tableInfo.getPoolTiüîµ</abbr>
 111                  Integer cassandraPort = 0;
 112                  String address = tableInfo.getAddress();
 113                  String userName = tableInfo.getUserName();
 114                  String password = tableInfo.getPassword();
 115                  String database = tableInfo.getDatabase();
 116  
 117                  ArrayList serversList = new ArrayList();
 118                  //Read timeout or connection timeout Settings
 119                  SocketOptions so = new SocketOptions()
 120                          .setReadTimeoutMillis(readTimeoutMillis)
 121                          .setConnectTimeoutMillis(connectTimeoutMillis);
 122  
 123                  //The cluster USES hostdistance.local in the same machine room
 124                  //Hostdistance. REMOTE is used for different machine rooms
 125                  //Ignore use HostDistance. IGNORED
 126                  PoolingOptions poolingOptions = new PoolingOptions()
 127                          //Each connection allows a maximum of 64 concurrent requests
 128                          .setMaxRequestsPerConnection(HostDistance.LOCAL, maxRequestsPerConnection)
 129                          //Have at least two connections to each machine in the cluster
 130                          .setCoreConnectionsPerHost(HostDistance.LOCAL, coreConnectionsPerHost)
 131                          //There are up to eight connections to each machine in the cluster
 132                          .setMaxConnectionsPerHost(HostDistance.LOCAL, maxConnectionsPerHost)
 133                          .setMaxQueueSize(maxQueueSize)
 134                          .setPoolTimeoutMillis(poolTimeoutMillis);
 135                  //ÈáçËØïÁ≠ñÁï•
 136                  RetryPolicy retryPolicy = DowngradingConsistencyRetryPolicy.INSTANCE;
 137  
 138                  for (String server : StringUtils.split(address, &quot;,&quot;)) {
 139                      cassandraPort = Integer.parseInt(StringUtils.split(server, &quot;:&quot;)[1]);
 140                      serversList.add(InetAddress.getByName(StringUtils.split(server, &quot;:&quot;)[0]));
 141                  }
 142  
 143                  if (userName == null || userName.isEmpty() || password == null || password.isEmpty()) {
 144                      cluster = Cluster.builder().addContactPoints(serversList).withRetryPolicy(retryPolicy)
 145                              .withPort(cassandraPort)
 146                              .withPoolingOptions(poolingOptions).withSocketOptions(so)
 147                              .withQueryOptions(queryOptions).build();
 148                  } else {
 149                      cluster = Cluster.builder().addContactPoints(serversList).withRetryPolicy(retryPolicy)
 150                              .withPort(cassandraPort)
 151                              .withPoolingOptions(poolingOptions).withSocketOptions(so)
 152                              .withCredentials(userName, password)
 153                              .withQueryOptions(queryOptions).build();
 154                  }
 155                  // Âª∫Á´ãËøûÊé• ËøûÊé•Â∑≤Â≠òÂú®ÁöÑÈîÆÁ©∫Èó¥
 156                  session = cluster.connectAsync(database);
 157                  LOG.info(&quot;connect cassandra is successed!&quot;);
 158              }
 159          } catch (Exception e) {
 160              LOG.error(&quot;connect cassandra is error:&quot; + e.getMessage());
 161          }
 162      }
 163  
 164      @Override
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 165 -    public void asyncInvoke(CRow input, ResultFuture&lt;CRow&gt; resultFuture) throws Exception {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 166 -        CRow inputCopy = new CRow(input.row(), input.change());</span>


<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 167 -        JsonArray inputParams = new JsonArray();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 168 -        StringBuffer stringBuffer = new StringBuffer();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 169 -        String sqlWhere = &quot; where &quot;;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 170 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 171 -        for (int i = 0; i &lt; sideInfo.getEqualFieldList().size(); i++) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 172 -            Integer conValIndex = sideInfo.getEqualValIndex().get(i);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 173 -            Object equalObj = inputCopy.row().getField(conValIndex);</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 174 -            if (equalObj == null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 175 -                dealMissKey(inputCopy, resultFuture);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 176 -                return;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 177 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 178 -            inputParams.add(equalObj);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 179 -            StringBuffer sqlTemp = stringBuffer.append(sideInfo.getEqualFieldList().get(i))</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 180 -                    .append(&quot; = &quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 181 -            if (equalObj instanceof String) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 182 -                sqlTemp.append(&quot;&#x27;&quot; + equalObj + &quot;&#x27;&quot;)</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 183 -                        .append(&quot; and &quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 184 -            } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 185 -                sqlTemp.append(equalObj)</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 186 -                        .append(&quot; and &quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 187 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 188 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 189 -        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 190 +    public void handleAsyncInvoke(Map&lt;String, Object&gt; inputParams, CRow input, ResultFuture&lt;CRow&gt; resultFuture) throws Exception {"> 190 +    public void handleAsyncInvoke(Map&lt;String, Object&gt; inputParams, CRow input, ResultFuture&lt;CRow&gt; resultFuture) thüîµ</abbr></span>
 191  
 192          String key = buildCacheKey(inputParams);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 193 -        sqlWhere = sqlWhere + stringBuffer.toString().substring(0, stringBuffer.lastIndexOf(&quot; and &quot;));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 194 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 195 -        if (openCache()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 196 -            CacheObj val = getFromCache(key);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 197 -            if (val != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 198 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 199 -                if (ECacheContentType.MissVal == val.getType()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 200 -                    dealMissKey(inputCopy, resultFuture);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 201 -                    return;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 202 -                } else if (ECacheContentType.MultiLine == val.getType()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 203 -                    List&lt;CRow&gt; rowList = Lists.newArrayList();</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 204 -                    for (Object jsonArray : (List) val.getContent()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 205 -                        Row row = fillData(inputCopy.row(), jsonArray);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 206 -                        rowList.add(new CRow(row, inputCopy.change()));</span>


<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 207 -                    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 208 -                    resultFuture.complete(rowList);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 209 -                } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 210 -                    throw new RuntimeException(&quot;not support cache obj type &quot; + val.getType());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 211 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 212 -                return;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 213 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 214 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 215 -</span>
 216          //connect Cassandra
 217          connCassandraDB(cassandraSideTableInfo);
 218  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 219 -        String sqlCondition = sideInfo.getSqlCondition() + &quot; &quot; + sqlWhere + &quot;  ALLOW FILTERING &quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 220 +        String sqlCondition = sideInfo.getSqlCondition() + &quot; &quot; + buildWhereCondition(inputParams) + &quot;  ALLOW FILTERING &quot;;"> 220 +        String sqlCondition = sideInfo.getSqlCondition() + &quot; &quot; + buildWhereCondition(inputParams) + &quot;  ALLOW FILTEüîµ</abbr></span>
 221          LOG.info(&quot;sqlCondition:{}&quot; + sqlCondition);
 222  
 223          ListenableFuture&lt;ResultSet&gt; resultSet = Futures.transformAsync(session,
 224                  new AsyncFunction&lt;Session, ResultSet&gt;() {
 225                      @Override
 226                      public ListenableFuture&lt;ResultSet&gt; apply(Session session) throws Exception {
 227                          return session.executeAsync(sqlCondition);
 228                      }
 229                  });
 230  
 231          ListenableFuture&lt;List&lt;com.datastax.driver.core.Row&gt;&gt; data = Futures.transform(resultSet,
 232                  new Function&lt;ResultSet, List&lt;com.datastax.driver.core.Row&gt;&gt;() {
 233                      @Override
 234                      public List&lt;com.datastax.driver.core.Row&gt; apply(ResultSet rs) {
 235                          return rs.all();
 236                      }
 237                  });
 238  
 239          Futures.addCallback(data, new FutureCallback&lt;List&lt;com.datastax.driver.core.Row&gt;&gt;() {
 240              @Override
 241              public void onSuccess(List&lt;com.datastax.driver.core.Row&gt; rows) {
 242                  cluster.closeAsync();
 243                  if (rows.size() &gt; 0) {
 244                      List&lt;com.datastax.driver.core.Row&gt; cacheContent = Lists.newArrayList();
 245                      List&lt;CRow&gt; rowList = Lists.newArrayList();

 246                      for (com.datastax.driver.core.Row line : rows) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 247 -                        Row row = fillData(inputCopy.row(), line);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 248 +                        Row row = fillData(input.row(), line);</span>
 249                          if (openCache()) {
 250                              cacheContent.add(line);
 251                          }
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 252 -                        rowList.add(new CRow(row,inputCopy.change()));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 253 +                        rowList.add(new CRow(row, input.change()));</span>
 254                      }
 255                      resultFuture.complete(rowList);
 256                      if (openCache()) {
 257                          putCache(key, CacheObj.buildCacheObj(ECacheContentType.MultiLine, cacheContent));
 258                      }
 259                  } else {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 260 -                    dealMissKey(inputCopy, resultFuture);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 261 +                    dealMissKey(input, resultFuture);</span>
 262                      if (openCache()) {
 263                          putCache(key, CacheMissVal.getMissKeyObj());
 264                      }
 265                      resultFuture.complete(null);
 266                  }
 267              }
 268  
 269              @Override
 270              public void onFailure(Throwable t) {
 271                  LOG.error(&quot;Failed to retrieve the data: %s%n&quot;,
 272                          t.getMessage());
 273                  cluster.closeAsync();
 274                  resultFuture.completeExceptionally(t);
 275              }
 276          });
 277      }
 278  
 279      @Override
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 280 +    public String buildCacheKey(Map&lt;String, Object&gt; inputParams) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 281 +        StringBuilder sb = new StringBuilder();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 282 +        for (Object ele : inputParams.values()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 283 +            sb.append(ele.toString()).append(&quot;_&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 284 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 285 +        return sb.toString();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 286 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 287 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 288 +    private String buildWhereCondition(Map&lt;String, Object&gt; inputParams){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 289 +        StringBuilder sb = new StringBuilder(&quot; where &quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 290 +        for(Map.Entry&lt;String, Object&gt; entry : inputParams.entrySet()){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 291 +            Object value = entry.getValue() instanceof String ? &quot;&#x27;&quot; + entry.getValue() + &quot;&#x27;&quot; : entry.getValue();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 292 +            sb.append(String.format(&quot;%s = %s&quot;, entry.getKey(), value));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 293 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 294 +        return sb.toString();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 295 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 296 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 297 +    @Override</span>
 298      public Row fillData(Row input, Object line) {
 299          com.datastax.driver.core.Row rowArray = (com.datastax.driver.core.Row) line;
 300          Row row = new Row(sideInfo.getOutFieldInfoList().size());
 301          for (Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getInFieldIndex().entrySet()) {
 302              Object obj = input.getField(entry.getValue());
<abbr title=" 303              boolean isTimeIndicatorTypeInfo = TimeIndicatorTypeInfo.class.isAssignableFrom(sideInfo.getRowTypeInfo().getTypeAt(entry.getValue()).getClass());"> 303              boolean isTimeIndicatorTypeInfo = TimeIndicatorTypeInfo.class.isAssignableFrom(sideInfo.getRowTypeInfoüîµ</abbr>
 304  
 305              if (obj instanceof Timestamp &amp;&amp; isTimeIndicatorTypeInfo) {
 306                  obj = ((Timestamp) obj).getTime();
 307              }
 308  

 309              row.setField(entry.getKey(), obj);
 310          }
 311  
 312          for (Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getSideFieldIndex().entrySet()) {
 313              if (rowArray == null) {
 314                  row.setField(entry.getKey(), null);
 315              } else {
 316                  row.setField(entry.getKey(), rowArray.getObject(entry.getValue()));
 317              }
 318          }
 319  
 320          return row;
 321      }
 322  
 323      @Override
 324      public void close() throws Exception {
 325          super.close();
 326          if (cluster != null) {
 327              cluster.close();
 328              cluster = null;
 329          }
 330      }
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 331 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 332 -    public String buildCacheKey(JsonArray jsonArray) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 333 -        StringBuilder sb = new StringBuilder();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 334 -        for (Object ele : jsonArray.getList()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 335 -            sb.append(ele.toString())</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 336 -                    .append(&quot;_&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 337 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 338 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 339 -        return sb.toString();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 340 -    }</span>
 341  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            