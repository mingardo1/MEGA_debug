<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>271</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    271
                    <a href="270.html">prev</a>
                    <a href="272.html">next</a>
                    <a href="271_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    DTStack/flinkStreamSQL_30e3058e916f9dae3d97cc8ba5fb89c2999c645f_redis5/redis5-side/redis-async-side/src/main/java/com/dtstack/flink/sql/side/redis/RedisAsyncReqRow.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;30e3058e916f9dae3d97cc8ba5fb89c2999c645f:redis5/redis5-side/redis-async-side/src/main/java/com/dtstack/flink/sql/side/redis/RedisAsyncReqRow.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;30e3058e916f9dae3d97cc8ba5fb89c2999c645f^1:redis5/redis5-side/redis-async-side/src/main/java/com/dtstack/flink/sql/side/redis/RedisAsyncReqRow.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;30e3058e916f9dae3d97cc8ba5fb89c2999c645f^2:redis5/redis5-side/redis-async-side/src/main/java/com/dtstack/flink/sql/side/redis/RedisAsyncReqRow.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;d022e4b01c20810044fc561a790109c3915a7708:redis5/redis5-side/redis-async-side/src/main/java/com/dtstack/flink/sql/side/redis/RedisAsyncReqRow.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[bj]], subset: [[bj]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 /*
   2  * Licensed to the Apache Software Foundation (ASF) under one
   3  * or more contributor license agreements.  See the NOTICE file
   4  * distributed with this work for additional information
   5  * regarding copyright ownership.  The ASF licenses this file
   6  * to you under the Apache License, Version 2.0 (the
   7  * &quot;License&quot;); you may not use this file except in compliance
   8  * with the License.  You may obtain a copy of the License at
   9  *
  10  *     http://www.apache.org/licenses/LICENSE-2.0
  11  *
  12  * Unless required by applicable law or agreed to in writing, software
  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15  * See the License for the specific language governing permissions and
  16  * limitations under the License.
  17  */
  18 
  19 package com.dtstack.flink.sql.side.redis;
  20 
  21 import com.dtstack.flink.sql.enums.ECacheContentType;
  22 import com.dtstack.flink.sql.side.AbstractSideTableInfo;
  23 import com.dtstack.flink.sql.side.BaseAsyncReqRow;
  24 import com.dtstack.flink.sql.side.CacheMissVal;
  25 import com.dtstack.flink.sql.side.FieldInfo;
  26 import com.dtstack.flink.sql.side.JoinInfo;
  27 import com.dtstack.flink.sql.side.cache.CacheObj;
  28 import com.dtstack.flink.sql.side.redis.enums.RedisType;
  29 import com.dtstack.flink.sql.side.redis.table.RedisSideReqRow;
  30 import com.dtstack.flink.sql.side.redis.table.RedisSideTableInfo;
  31 import com.dtstack.flink.sql.util.RowDataComplete;
  32 import io.lettuce.core.RedisClient;
  33 import io.lettuce.core.RedisFuture;
  34 import io.lettuce.core.RedisURI;
  35 import io.lettuce.core.api.StatefulRedisConnection;
  36 import io.lettuce.core.api.async.RedisHashAsyncCommands;
  37 import io.lettuce.core.api.async.RedisKeyAsyncCommands;
  38 import io.lettuce.core.cluster.RedisClusterClient;
  39 import io.lettuce.core.cluster.api.StatefulRedisClusterConnection;
  40 import org.apache.commons.collections.MapUtils;
  41 import org.apache.commons.lang.StringUtils;
  42 import org.apache.flink.api.java.typeutils.RowTypeInfo;
  43 import org.apache.flink.configuration.Configuration;
  44 import org.apache.flink.streaming.api.functions.async.ResultFuture;
  45 import org.apache.flink.table.dataformat.BaseRow;
  46 
  47 import java.util.List;
  48 import java.util.Map;
  49 import java.util.Objects;
  50 import java.util.function.Consumer;
  51 import java.util.regex.Matcher;
  52 
  53 /**
  54  * @author yanxi
  55  */
  56 public class RedisAsyncReqRow extends BaseAsyncReqRow {
  57 
  58     private static final long serialVersionUID = -2079908694523987738L;
  59 
  60     private RedisClient redisClient;
  61 
  62     private StatefulRedisConnection&lt;String, String&gt; connection;
  63 
  64     private RedisClusterClient clusterClient;
  65 
  66     private StatefulRedisClusterConnection&lt;String, String&gt; clusterConnection;
  67 
  68     private RedisKeyAsyncCommands&lt;String, String&gt; async;
  69 
  70     private RedisSideTableInfo redisSideTableInfo;
  71 
  72     private final RedisSideReqRow redisSideReqRow;
  73 
<abbr title="  74     public RedisAsyncReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, AbstractSideTableInfo sideTableInfo) {">  74     public RedisAsyncReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList,ðŸ”µ</abbr>
  75         super(new RedisAsyncSideInfo(rowTypeInfo, joinInfo, outFieldInfoList, sideTableInfo));
  76         redisSideReqRow = new RedisSideReqRow(super.sideInfo, (RedisSideTableInfo) sideTableInfo);
  77     }
  78 
  79     @Override
  80     public void open(Configuration parameters) throws Exception {
  81         super.open(parameters);
  82         redisSideTableInfo = (RedisSideTableInfo) sideInfo.getSideTableInfo();
  83         buildRedisClient(redisSideTableInfo);
  84     }
  85 
  86     private void buildRedisClient(RedisSideTableInfo tableInfo){
  87         String url = redisSideTableInfo.getUrl();
  88         String password = redisSideTableInfo.getPassword();
  89 
  90         String database = redisSideTableInfo.getDatabase();
  91         if (database == null){
  92             database = &quot;0&quot;;
  93         }
  94         switch (RedisType.parse(tableInfo.getRedisType())){
  95             case STANDALONE:
  96                 RedisURI redisURI = RedisURI.create(&quot;redis://&quot; + url);
  97                 redisURI.setPassword(password);
  98                 redisURI.setDatabase(Integer.parseInt(database));
  99                 redisClient = RedisClient.create(redisURI);
 100                 connection = redisClient.connect();
 101                 async = connection.async();
 102                 break;
 103             case SENTINEL:
 104 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 105                 RedisURI redisSentinelURI = RedisURI.create(&quot;redis-sentinel://&quot; + url);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 106                 redisSentinelURI.setPassword(password);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 107                 redisSentinelURI.setDatabase(Integer.parseInt(database));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 108                 redisSentinelURI.setSentinelMasterId(redisSideTableInfo.getMasterName());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 109                 redisClient = RedisClient.create(redisSentinelURI);</span>
 110 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 111                 RedisURI redisSentinelURI = RedisURI.create(&quot;redis-sentinel://&quot; + url);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 112                 redisSentinelURI.setPassword(password);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 113                 redisSentinelURI.setDatabase(Integer.valueOf(database));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 114                 redisSentinelURI.setSentinelMasterId(redisSideTableInfo.getMasterName());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 115                 redisClient = RedisClient.create(redisSentinelURI);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 116                 connection = redisClient.connect();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 117                 async = connection.async();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 118                 break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 119             case CLUSTER:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 120                 RedisURI clusterURI = RedisURI.create(&quot;redis://&quot; + url);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 121                 clusterURI.setPassword(password);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 122                 clusterClient = RedisClusterClient.create(clusterURI);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 123                 clusterConnection = clusterClient.connect();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 124                 async = clusterConnection.async();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 125             default:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 126                 break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 127         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 128     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 129 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 130     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 131     public BaseRow fillData(BaseRow input, Object sideInput) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 132         return redisSideReqRow.fillData(input, sideInput);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 133     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 134 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 135     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 136     public void handleAsyncInvoke(Map&lt;String, Object&gt; inputParams, BaseRow input, ResultFuture&lt;BaseRow&gt; resultFuture) throws Exception {"> 136     public void handleAsyncInvoke(Map&lt;String, Object&gt; inputParams, BaseRow input, ResultFuture&lt;BaseRow&gt; rðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 137         String key = buildCacheKey(inputParams);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 138         if(StringUtils.isBlank(key)){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 139             return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 140         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 141         RedisFuture&lt;Map&lt;String, String&gt;&gt; future = ((RedisHashAsyncCommands) async).hgetall(key);</span>
 142 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 143                 String[] urlSplit = StringUtils.split(url, &quot;,&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 144                 RedisURI.Builder builder = null;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 145                 for (String item : urlSplit) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 146                     Matcher mather = RedisSideReqRow.HOST_PORT_PATTERN.matcher(item);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 147                     if (mather.find()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 148                         builder = buildSentinelUri(</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 149                                 mather.group(&quot;host&quot;),</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 150                                 mather.group(&quot;port&quot;),</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 151                                 builder</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 152                         );</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 153                     } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 154                         throw new IllegalArgumentException(</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 155                                 String.format(&quot;Illegal format with redis url [%s]&quot;, item)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 156                         );</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 157                     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 158                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 159 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 160                 if (Objects.nonNull(builder)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 161                     builder</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 162                             .withPassword(tableInfo.getPassword())</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 163                             .withDatabase(Integer.parseInt(tableInfo.getDatabase()))</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 164                             .withSentinelMasterId(tableInfo.getMasterName());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 165                 } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 166                     throw new NullPointerException(&quot;build redis uri error!&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 167                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 168 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 169                 RedisURI uri = builder.build();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 170                 redisClient = RedisClient.create(uri);</span>
 171 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 172                 connection = redisClient.connect();
 173                 async = connection.async();
 174                 break;
 175             case CLUSTER:
 176                 RedisURI clusterURI = RedisURI.create(&quot;redis://&quot; + url);
 177                 clusterURI.setPassword(password);
 178                 clusterClient = RedisClusterClient.create(clusterURI);
 179                 clusterConnection = clusterClient.connect();
 180                 async = clusterConnection.async();
 181             default:
 182                 break;
 183         }
 184     }
 185 
 186     private RedisURI.Builder buildSentinelUri(
 187             String host,
 188             String port,
 189             RedisURI.Builder builder) {
 190         if (Objects.nonNull(builder)) {
 191             builder.withSentinel(host, Integer.parseInt(port));
 192         } else {
 193             builder = RedisURI.Builder.sentinel(host, Integer.parseInt(port));
 194         }
 195         return builder;
 196     }
 197 
 198     @Override
 199     public BaseRow fillData(BaseRow input, Object sideInput) {
 200         return redisSideReqRow.fillData(input, sideInput);
 201     }
 202 
 203     @Override
<abbr title=" 204     public void handleAsyncInvoke(Map&lt;String, Object&gt; inputParams, BaseRow input, ResultFuture&lt;BaseRow&gt; resultFuture) throws Exception {"> 204     public void handleAsyncInvoke(Map&lt;String, Object&gt; inputParams, BaseRow input, ResultFuture&lt;BaseRow&gt; rðŸ”µ</abbr>
 205         String key = buildCacheKey(inputParams);
 206         if(StringUtils.isBlank(key)){
 207             return;
 208         }
 209         RedisFuture&lt;Map&lt;String, String&gt;&gt; future = ((RedisHashAsyncCommands) async).hgetall(key);
 210         future.thenAccept(values -&gt; {
 211             if (MapUtils.isNotEmpty(values)) {
 212                 try {
 213                     BaseRow row = fillData(input, values);
 214                     dealCacheData(key,CacheObj.buildCacheObj(ECacheContentType.SingleLine, row));
 215                     RowDataComplete.completeBaseRow(resultFuture, row);
 216                 } catch (Exception e) {
 217                     dealFillDataError(input, resultFuture, e);
 218                 }
 219             } else {
 220                 dealMissKey(input, resultFuture);
 221                 dealCacheData(key, CacheMissVal.getMissKeyObj());
 222             }
 223         });
 224     }
 225 
 226     @Override
 227     public String buildCacheKey(Map&lt;String, Object&gt; refData) {
 228         return redisSideReqRow.buildCacheKey(refData);
 229     }
 230 
 231     @Override
 232     public void close() throws Exception {
 233         super.close();
 234         if (connection != null){
 235             connection.close();
 236         }
 237         if (redisClient != null){
 238             redisClient.shutdown();
 239         }
 240         if (clusterConnection != null){
 241             clusterConnection.close();
 242         }
 243         if (clusterClient != null){
 244             clusterClient.shutdown();
 245         }
 246     }
 247 
 248 }</pre></td>
                            <td><pre>   1 /*
   2  * Licensed to the Apache Software Foundation (ASF) under one
   3  * or more contributor license agreements.  See the NOTICE file
   4  * distributed with this work for additional information
   5  * regarding copyright ownership.  The ASF licenses this file
   6  * to you under the Apache License, Version 2.0 (the
   7  * &quot;License&quot;); you may not use this file except in compliance
   8  * with the License.  You may obtain a copy of the License at
   9  *
  10  *     http://www.apache.org/licenses/LICENSE-2.0
  11  *
  12  * Unless required by applicable law or agreed to in writing, software
  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15  * See the License for the specific language governing permissions and
  16  * limitations under the License.
  17  */
  18 
  19 package com.dtstack.flink.sql.side.redis;
  20 
  21 import com.dtstack.flink.sql.enums.ECacheContentType;
  22 import com.dtstack.flink.sql.side.AbstractSideTableInfo;
  23 import com.dtstack.flink.sql.side.BaseAsyncReqRow;
  24 import com.dtstack.flink.sql.side.CacheMissVal;
  25 import com.dtstack.flink.sql.side.FieldInfo;
  26 import com.dtstack.flink.sql.side.JoinInfo;
  27 import com.dtstack.flink.sql.side.cache.CacheObj;
  28 import com.dtstack.flink.sql.side.redis.enums.RedisType;
  29 import com.dtstack.flink.sql.side.redis.table.RedisSideReqRow;
  30 import com.dtstack.flink.sql.side.redis.table.RedisSideTableInfo;
  31 import com.dtstack.flink.sql.util.RowDataComplete;
  32 import io.lettuce.core.RedisClient;
  33 import io.lettuce.core.RedisFuture;
  34 import io.lettuce.core.RedisURI;
  35 import io.lettuce.core.api.StatefulRedisConnection;
  36 import io.lettuce.core.api.async.RedisHashAsyncCommands;
  37 import io.lettuce.core.api.async.RedisKeyAsyncCommands;
  38 import io.lettuce.core.cluster.RedisClusterClient;
  39 import io.lettuce.core.cluster.api.StatefulRedisClusterConnection;
  40 import org.apache.commons.collections.MapUtils;
  41 import org.apache.commons.lang.StringUtils;
  42 import org.apache.flink.api.java.typeutils.RowTypeInfo;
  43 import org.apache.flink.configuration.Configuration;
  44 import org.apache.flink.streaming.api.functions.async.ResultFuture;
  45 import org.apache.flink.table.dataformat.BaseRow;
  46 
  47 import java.util.List;
  48 import java.util.Map;
  49 import java.util.Objects;
  50 import java.util.function.Consumer;
  51 import java.util.regex.Matcher;
  52 
  53 /**
  54  * @author yanxi
  55  */
  56 public class RedisAsyncReqRow extends BaseAsyncReqRow {
  57 
  58     private static final long serialVersionUID = -2079908694523987738L;
  59 
  60     private RedisClient redisClient;
  61 
  62     private StatefulRedisConnection&lt;String, String&gt; connection;
  63 
  64     private RedisClusterClient clusterClient;
  65 
  66     private StatefulRedisClusterConnection&lt;String, String&gt; clusterConnection;
  67 
  68     private RedisKeyAsyncCommands&lt;String, String&gt; async;
  69 
  70     private RedisSideTableInfo redisSideTableInfo;
  71 
  72     private final RedisSideReqRow redisSideReqRow;
  73 
<abbr title="  74     public RedisAsyncReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, AbstractSideTableInfo sideTableInfo) {">  74     public RedisAsyncReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList,ðŸ”µ</abbr>
  75         super(new RedisAsyncSideInfo(rowTypeInfo, joinInfo, outFieldInfoList, sideTableInfo));
  76         redisSideReqRow = new RedisSideReqRow(super.sideInfo, (RedisSideTableInfo) sideTableInfo);
  77     }
  78 
  79     @Override
  80     public void open(Configuration parameters) throws Exception {
  81         super.open(parameters);
  82         redisSideTableInfo = (RedisSideTableInfo) sideInfo.getSideTableInfo();
  83         buildRedisClient(redisSideTableInfo);
  84     }
  85 
  86     private void buildRedisClient(RedisSideTableInfo tableInfo){
  87         String url = redisSideTableInfo.getUrl();
  88         String password = redisSideTableInfo.getPassword();
  89 
  90         String database = redisSideTableInfo.getDatabase();
  91         if (database == null){
  92             database = &quot;0&quot;;
  93         }
  94         switch (RedisType.parse(tableInfo.getRedisType())){
  95             case STANDALONE:
  96                 RedisURI redisURI = RedisURI.create(&quot;redis://&quot; + url);
  97                 redisURI.setPassword(password);
  98                 redisURI.setDatabase(Integer.parseInt(database));
  99                 redisClient = RedisClient.create(redisURI);
 100                 connection = redisClient.connect();
 101                 async = connection.async();
 102                 break;
 103             case SENTINEL:
 104 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 105                 RedisURI redisSentinelURI = RedisURI.create(&quot;redis-sentinel://&quot; + url);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 106                 redisSentinelURI.setPassword(password);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 107                 redisSentinelURI.setDatabase(Integer.parseInt(database));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 108                 redisSentinelURI.setSentinelMasterId(redisSideTableInfo.getMasterName());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 109                 redisClient = RedisClient.create(redisSentinelURI);</span>
 110 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 111                 RedisURI redisSentinelURI = RedisURI.create(&quot;redis-sentinel://&quot; + url);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 112                 redisSentinelURI.setPassword(password);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 113                 redisSentinelURI.setDatabase(Integer.valueOf(database));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 114                 redisSentinelURI.setSentinelMasterId(redisSideTableInfo.getMasterName());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 115                 redisClient = RedisClient.create(redisSentinelURI);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 116                 connection = redisClient.connect();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 117                 async = connection.async();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 118                 break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 119             case CLUSTER:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 120                 RedisURI clusterURI = RedisURI.create(&quot;redis://&quot; + url);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 121                 clusterURI.setPassword(password);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 122                 clusterClient = RedisClusterClient.create(clusterURI);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 123                 clusterConnection = clusterClient.connect();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 124                 async = clusterConnection.async();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 125             default:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 126                 break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 127         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 128     }</span>
 129 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 130                 String[] urlSplit = StringUtils.split(url, &quot;,&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 131                 RedisURI.Builder builder = null;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 132                 for (String item : urlSplit) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 133                     Matcher mather = RedisSideReqRow.HOST_PORT_PATTERN.matcher(item);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 134                     if (mather.find()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 135                         builder = buildSentinelUri(</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 136                                 mather.group(&quot;host&quot;),</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 137                                 mather.group(&quot;port&quot;),</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 138                                 builder</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 139                         );</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 140                     } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 141                         throw new IllegalArgumentException(</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 142                                 String.format(&quot;Illegal format with redis url [%s]&quot;, item)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 143                         );</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 144                     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 145                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 146 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 147                 if (Objects.nonNull(builder)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 148                     builder</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 149                             .withPassword(tableInfo.getPassword())</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 150                             .withDatabase(Integer.parseInt(tableInfo.getDatabase()))</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 151                             .withSentinelMasterId(tableInfo.getMasterName());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 152                 } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 153                     throw new NullPointerException(&quot;build redis uri error!&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 154                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 155 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 156                 RedisURI uri = builder.build();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 157                 redisClient = RedisClient.create(uri);</span>
 158 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 159                 connection = redisClient.connect();
 160                 async = connection.async();
 161                 break;
 162             case CLUSTER:
 163                 RedisURI clusterURI = RedisURI.create(&quot;redis://&quot; + url);
 164                 clusterURI.setPassword(password);
 165                 clusterClient = RedisClusterClient.create(clusterURI);
 166                 clusterConnection = clusterClient.connect();
 167                 async = clusterConnection.async();
 168             default:
 169                 break;
 170         }
 171     }
 172 
 173     private RedisURI.Builder buildSentinelUri(
 174             String host,
 175             String port,
 176             RedisURI.Builder builder) {
 177         if (Objects.nonNull(builder)) {
 178             builder.withSentinel(host, Integer.parseInt(port));
 179         } else {
 180             builder = RedisURI.Builder.sentinel(host, Integer.parseInt(port));
 181         }
 182         return builder;
 183     }
 184 
 185     @Override
 186     public BaseRow fillData(BaseRow input, Object sideInput) {
 187         return redisSideReqRow.fillData(input, sideInput);
 188     }
 189 
 190     @Override
<abbr title=" 191     public void handleAsyncInvoke(Map&lt;String, Object&gt; inputParams, BaseRow input, ResultFuture&lt;BaseRow&gt; resultFuture) throws Exception {"> 191     public void handleAsyncInvoke(Map&lt;String, Object&gt; inputParams, BaseRow input, ResultFuture&lt;BaseRow&gt; rðŸ”µ</abbr>
 192         String key = buildCacheKey(inputParams);
 193         if(StringUtils.isBlank(key)){
 194             return;
 195         }
 196         RedisFuture&lt;Map&lt;String, String&gt;&gt; future = ((RedisHashAsyncCommands) async).hgetall(key);
 197         future.thenAccept(values -&gt; {
 198                 if (MapUtils.isNotEmpty(values)) {
 199                     try {
 200                         BaseRow row = fillData(input, values);
 201                         dealCacheData(key,CacheObj.buildCacheObj(ECacheContentType.SingleLine, row));
 202                         RowDataComplete.completeBaseRow(resultFuture, row);
 203                     } catch (Exception e) {
 204                         dealFillDataError(input, resultFuture, e);
 205                     }
 206                 } else {
 207                     dealMissKey(input, resultFuture);
 208                     dealCacheData(key, CacheMissVal.getMissKeyObj());
 209                 }
 210         });
 211     }
 212 
 213     @Override
 214     public String buildCacheKey(Map&lt;String, Object&gt; refData) {
 215         return redisSideReqRow.buildCacheKey(refData);
 216     }
 217 
 218     @Override
 219     public void close() throws Exception {
 220         super.close();
 221         if (connection != null){
 222             connection.close();
 223         }
 224         if (redisClient != null){
 225             redisClient.shutdown();
 226         }
 227         if (clusterConnection != null){
 228             clusterConnection.close();
 229         }
 230         if (clusterClient != null){
 231             clusterClient.shutdown();
 232         }
 233     }
 234 
 235 }
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                            <td><pre>   1 /*
   2  * Licensed to the Apache Software Foundation (ASF) under one
   3  * or more contributor license agreements.  See the NOTICE file
   4  * distributed with this work for additional information
   5  * regarding copyright ownership.  The ASF licenses this file
   6  * to you under the Apache License, Version 2.0 (the
   7  * &quot;License&quot;); you may not use this file except in compliance
   8  * with the License.  You may obtain a copy of the License at
   9  *
  10  *     http://www.apache.org/licenses/LICENSE-2.0
  11  *
  12  * Unless required by applicable law or agreed to in writing, software
  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15  * See the License for the specific language governing permissions and
  16  * limitations under the License.
  17  */
  18 package com.dtstack.flink.sql.side.redis;
  19 
  20 import com.dtstack.flink.sql.enums.ECacheContentType;
  21 import com.dtstack.flink.sql.side.AbstractSideTableInfo;
  22 import com.dtstack.flink.sql.side.BaseAsyncReqRow;
  23 import com.dtstack.flink.sql.side.CacheMissVal;
  24 import com.dtstack.flink.sql.side.FieldInfo;
  25 import com.dtstack.flink.sql.side.JoinInfo;
  26 import com.dtstack.flink.sql.side.cache.CacheObj;
  27 import com.dtstack.flink.sql.side.redis.enums.RedisType;
  28 import com.dtstack.flink.sql.side.redis.table.RedisSideReqRow;
  29 import com.dtstack.flink.sql.side.redis.table.RedisSideTableInfo;
  30 import com.dtstack.flink.sql.util.RowDataComplete;
  31 import io.lettuce.core.RedisClient;
  32 import io.lettuce.core.RedisFuture;
  33 import io.lettuce.core.RedisURI;
  34 import io.lettuce.core.api.StatefulRedisConnection;
  35 import io.lettuce.core.api.async.RedisHashAsyncCommands;
  36 import io.lettuce.core.api.async.RedisKeyAsyncCommands;
  37 import io.lettuce.core.cluster.RedisClusterClient;
  38 import io.lettuce.core.cluster.api.StatefulRedisClusterConnection;
  39 import java.util.List;
  40 import java.util.Map;
  41 import java.util.Objects;
  42 import java.util.function.Consumer;
  43 import java.util.regex.Matcher;
  44 import org.apache.commons.collections.MapUtils;
  45 import org.apache.commons.lang.StringUtils;
  46 import org.apache.flink.api.java.typeutils.RowTypeInfo;
  47 import org.apache.flink.configuration.Configuration;
  48 import org.apache.flink.streaming.api.functions.async.ResultFuture;
  49 import org.apache.flink.table.dataformat.BaseRow;
  50 
  51 
  52 /**
  53  * @author yanxi
  54  */
  55 public class RedisAsyncReqRow extends BaseAsyncReqRow {
  56     private static final long serialVersionUID = -2079908694523987738L;
  57 
  58     private RedisClient redisClient;
  59 
  60     private StatefulRedisConnection&lt;String, String&gt; connection;
  61 
  62     private RedisClusterClient clusterClient;
  63 
  64     private StatefulRedisClusterConnection&lt;String, String&gt; clusterConnection;
  65 
  66     private RedisKeyAsyncCommands&lt;String, String&gt; async;
  67 
  68     private RedisSideTableInfo redisSideTableInfo;
  69 
  70     private final RedisSideReqRow redisSideReqRow;
  71 
<abbr title="  72     public RedisAsyncReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, AbstractSideTableInfo sideTableInfo) {">  72     public RedisAsyncReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList,ðŸ”µ</abbr>
  73         super(new RedisAsyncSideInfo(rowTypeInfo, joinInfo, outFieldInfoList, sideTableInfo));
  74         redisSideReqRow = new RedisSideReqRow(super.sideInfo, ((RedisSideTableInfo) (sideTableInfo)));
  75     }
  76 
  77     @Override
  78     public void open(Configuration parameters) throws Exception {
  79         super.open(parameters);
  80         redisSideTableInfo = (RedisSideTableInfo) sideInfo.getSideTableInfo();
  81         buildRedisClient(redisSideTableInfo);
  82     }
  83 
  84     private void buildRedisClient(RedisSideTableInfo tableInfo) {
  85         String url = redisSideTableInfo.getUrl();
  86         String password = redisSideTableInfo.getPassword();
  87         String database = redisSideTableInfo.getDatabase();
  88         if (database == null) {
  89             database = &quot;0&quot;;
  90         }
  91         switch (RedisType.parse(tableInfo.getRedisType())) {
  92             case STANDALONE :
  93                 RedisURI redisURI = RedisURI.create(&quot;redis://&quot; + url);
  94                 redisURI.setPassword(password);
  95                 redisURI.setDatabase(Integer.parseInt(database));
  96                 redisClient = RedisClient.create(redisURI);
  97                 connection = redisClient.connect();
  98                 async = connection.async();
  99                 break;
 100             case SENTINEL :
 101                 String[] urlSplit = StringUtils.split(url, &quot;,&quot;);
 102                 RedisURI.Builder builder = null;
 103                 for (String item : urlSplit) {
 104                     Matcher mather = RedisSideReqRow.HOST_PORT_PATTERN.matcher(item);
 105                     if (mather.find()) {
 106                         builder = buildSentinelUri(mather.group(&quot;host&quot;), mather.group(&quot;port&quot;), builder);
 107                     } else {
<abbr title=" 108                         throw new IllegalArgumentException(String.format(&quot;Illegal format with redis url [%s]&quot;, item));"> 108                         throw new IllegalArgumentException(String.format(&quot;Illegal format with redis url [ðŸ”µ</abbr>
 109                     }
 110                 }
 111                 if (Objects.nonNull(builder)) {
<abbr title=" 112                     builder.withPassword(tableInfo.getPassword()).withDatabase(Integer.parseInt(tableInfo.getDatabase())).withSentinelMasterId(tableInfo.getMasterName());"> 112                     builder.withPassword(tableInfo.getPassword()).withDatabase(Integer.parseInt(tableInfoðŸ”µ</abbr>
 113                 } else {
 114                     throw new NullPointerException(&quot;build redis uri error!&quot;);
 115                 }
 116                 RedisURI uri = builder.build();
 117                 redisClient = RedisClient.create(uri);
 118                 connection = redisClient.connect();
 119                 async = connection.async();
 120                 break;
 121             case CLUSTER :
 122                 RedisURI clusterURI = RedisURI.create(&quot;redis://&quot; + url);
 123                 clusterURI.setPassword(password);
 124                 clusterClient = RedisClusterClient.create(clusterURI);
 125                 clusterConnection = clusterClient.connect();
 126                 async = clusterConnection.async();
 127             default :
 128                 break;
 129         }
 130     }
 131 
 132     private RedisURI.Builder buildSentinelUri(
 133             String host,
 134             String port,
 135             RedisURI.Builder builder) {
 136         if (Objects.nonNull(builder)) {
 137             builder.withSentinel(host, Integer.parseInt(port));
 138         } else {
 139             builder = RedisURI.Builder.sentinel(host, Integer.parseInt(port));
 140         }
 141         return builder;
 142     }
 143 
 144     @Override
 145     public BaseRow fillData(BaseRow input, Object sideInput) {
 146         return redisSideReqRow.fillData(input, sideInput);
 147     }
 148 
 149     @Override
<abbr title=" 150     public void handleAsyncInvoke(Map&lt;String, Object&gt; inputParams, BaseRow input, ResultFuture&lt;BaseRow&gt; resultFuture) throws Exception {"> 150     public void handleAsyncInvoke(Map&lt;String, Object&gt; inputParams, BaseRow input, ResultFuture&lt;BaseRow&gt; rðŸ”µ</abbr>
 151         String key = buildCacheKey(inputParams);
 152         if (StringUtils.isBlank(key)) {
 153             return;
 154         }
 155         RedisFuture&lt;Map&lt;String, String&gt;&gt; future = ((RedisHashAsyncCommands) (async)).hgetall(key);
 156         future.thenAccept(( values) -&gt; {
 157             if (MapUtils.isNotEmpty(values)) {
 158                 try {
 159                     BaseRow row = fillData(input, values);
 160                     dealCacheData(key, CacheObj.buildCacheObj(ECacheContentType.SingleLine, row));
 161                     RowDataComplete.completeBaseRow(resultFuture, row);
 162                 } catch ( e) {
 163                     dealFillDataError(input, resultFuture, e);
 164                 }
 165             } else {
 166                 dealMissKey(input, resultFuture);
 167                 dealCacheData(key, CacheMissVal.getMissKeyObj());
 168             }
 169         });
 170     }
 171 
 172     @Override
 173     public String buildCacheKey(Map&lt;String, Object&gt; refData) {
 174         return redisSideReqRow.buildCacheKey(refData);
 175     }
 176 
 177     @Override
 178     public void close() throws Exception {
 179         super.close();
 180         if (connection != null){
 181             connection.close();
 182         }
 183         if (redisClient != null){
 184             redisClient.shutdown();
 185         }
 186         if (clusterConnection != null){
 187             clusterConnection.close();
 188         }
 189         if (clusterClient != null){
 190             clusterClient.shutdown();
 191         }
 192     }
 193 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  /*
   2   * Licensed to the Apache Software Foundation (ASF) under one
   3   * or more contributor license agreements.  See the NOTICE file
   4   * distributed with this work for additional information
   5   * regarding copyright ownership.  The ASF licenses this file
   6   * to you under the Apache License, Version 2.0 (the
   7   * &quot;License&quot;); you may not use this file except in compliance
   8   * with the License.  You may obtain a copy of the License at
   9   *
  10   *     http://www.apache.org/licenses/LICENSE-2.0
  11   *
  12   * Unless required by applicable law or agreed to in writing, software
  13   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15   * See the License for the specific language governing permissions and
  16   * limitations under the License.
  17   */
  18  
  19  package com.dtstack.flink.sql.side.redis;
  20  
  21  import com.dtstack.flink.sql.enums.ECacheContentType;
  22  import com.dtstack.flink.sql.side.AbstractSideTableInfo;
  23  import com.dtstack.flink.sql.side.BaseAsyncReqRow;
  24  import com.dtstack.flink.sql.side.CacheMissVal;
  25  import com.dtstack.flink.sql.side.FieldInfo;
  26  import com.dtstack.flink.sql.side.JoinInfo;
  27  import com.dtstack.flink.sql.side.cache.CacheObj;
  28  import com.dtstack.flink.sql.side.redis.enums.RedisType;
  29  import com.dtstack.flink.sql.side.redis.table.RedisSideReqRow;
  30  import com.dtstack.flink.sql.side.redis.table.RedisSideTableInfo;
  31  import com.dtstack.flink.sql.util.RowDataComplete;
  32  import io.lettuce.core.RedisClient;
  33  import io.lettuce.core.RedisFuture;
  34  import io.lettuce.core.RedisURI;
  35  import io.lettuce.core.api.StatefulRedisConnection;
  36  import io.lettuce.core.api.async.RedisHashAsyncCommands;
  37  import io.lettuce.core.api.async.RedisKeyAsyncCommands;
  38  import io.lettuce.core.cluster.RedisClusterClient;
  39  import io.lettuce.core.cluster.api.StatefulRedisClusterConnection;
  40  import org.apache.commons.collections.MapUtils;
  41  import org.apache.commons.lang.StringUtils;
  42  import org.apache.flink.api.java.typeutils.RowTypeInfo;
  43  import org.apache.flink.configuration.Configuration;
  44  import org.apache.flink.streaming.api.functions.async.ResultFuture;
  45  import org.apache.flink.table.dataformat.BaseRow;
  46  
  47  import java.util.List;
  48  import java.util.Map;

  49  import java.util.function.Consumer;


  50  /**
  51   * @author yanxi
  52   */
  53  public class RedisAsyncReqRow extends BaseAsyncReqRow {
  54  
  55      private static final long serialVersionUID = -2079908694523987738L;
  56  
  57      private RedisClient redisClient;
  58  
  59      private StatefulRedisConnection&lt;String, String&gt; connection;
  60  
  61      private RedisClusterClient clusterClient;
  62  
  63      private StatefulRedisClusterConnection&lt;String, String&gt; clusterConnection;
  64  
  65      private RedisKeyAsyncCommands&lt;String, String&gt; async;
  66  
  67      private RedisSideTableInfo redisSideTableInfo;
  68  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  69 -    private RedisSideReqRow redisSideReqRow;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  70 +    private final RedisSideReqRow redisSideReqRow;</span>
  71  
<abbr title="  72      public RedisAsyncReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, AbstractSideTableInfo sideTableInfo) {">  72      public RedisAsyncReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, AbstractðŸ”µ</abbr>
  73          super(new RedisAsyncSideInfo(rowTypeInfo, joinInfo, outFieldInfoList, sideTableInfo));
  74          redisSideReqRow = new RedisSideReqRow(super.sideInfo, (RedisSideTableInfo) sideTableInfo);
  75      }
  76  
  77      @Override
  78      public void open(Configuration parameters) throws Exception {
  79          super.open(parameters);
  80          redisSideTableInfo = (RedisSideTableInfo) sideInfo.getSideTableInfo();
  81          buildRedisClient(redisSideTableInfo);
  82      }
  83  
  84      private void buildRedisClient(RedisSideTableInfo tableInfo){
  85          String url = redisSideTableInfo.getUrl();
  86          String password = redisSideTableInfo.getPassword();
  87  
  88          String database = redisSideTableInfo.getDatabase();
  89          if (database == null){
  90              database = &quot;0&quot;;
  91          }
  92          switch (RedisType.parse(tableInfo.getRedisType())){
  93              case STANDALONE:
  94                  RedisURI redisURI = RedisURI.create(&quot;redis://&quot; + url);
  95                  redisURI.setPassword(password);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  96 -                redisURI.setDatabase(Integer.valueOf(database));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  97 +                redisURI.setDatabase(Integer.parseInt(database));</span>
  98                  redisClient = RedisClient.create(redisURI);
  99                  connection = redisClient.connect();
 100                  async = connection.async();
 101                  break;
 102              case SENTINEL:
 103                  RedisURI redisSentinelURI = RedisURI.create(&quot;redis-sentinel://&quot; + url);
 104                  redisSentinelURI.setPassword(password);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 105 -                redisSentinelURI.setDatabase(Integer.valueOf(database));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 106 +                redisSentinelURI.setDatabase(Integer.parseInt(database));</span>
 107                  redisSentinelURI.setSentinelMasterId(redisSideTableInfo.getMasterName());
 108                  redisClient = RedisClient.create(redisSentinelURI);




























 109                  connection = redisClient.connect();
 110                  async = connection.async();
 111                  break;
 112              case CLUSTER:
 113                  RedisURI clusterURI = RedisURI.create(&quot;redis://&quot; + url);
 114                  clusterURI.setPassword(password);
 115                  clusterClient = RedisClusterClient.create(clusterURI);
 116                  clusterConnection = clusterClient.connect();
 117                  async = clusterConnection.async();
 118              default:
 119                  break;
 120          }












 121      }
 122  
 123      @Override
 124      public BaseRow fillData(BaseRow input, Object sideInput) {
 125          return redisSideReqRow.fillData(input, sideInput);
 126      }
 127  
 128      @Override
<abbr title=" 129      public void handleAsyncInvoke(Map&lt;String, Object&gt; inputParams, BaseRow input, ResultFuture&lt;BaseRow&gt; resultFuture) throws Exception {"> 129      public void handleAsyncInvoke(Map&lt;String, Object&gt; inputParams, BaseRow input, ResultFuture&lt;BaseRow&gt; resultFutuðŸ”µ</abbr>
 130          String key = buildCacheKey(inputParams);
 131          if(StringUtils.isBlank(key)){
 132              return;
 133          }
 134          RedisFuture&lt;Map&lt;String, String&gt;&gt; future = ((RedisHashAsyncCommands) async).hgetall(key);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 135 -        future.thenAccept(new Consumer&lt;Map&lt;String, String&gt;&gt;() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 136 -            @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 137 -            public void accept(Map&lt;String, String&gt; values) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 138 -                if (MapUtils.isNotEmpty(values)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 139 -                    try {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 140 -                        BaseRow row = fillData(input, values);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 141 -                        dealCacheData(key,CacheObj.buildCacheObj(ECacheContentType.SingleLine, row));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 142 -                        RowDataComplete.completeBaseRow(resultFuture, row);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 143 -                    } catch (Exception e) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 144 -                        dealFillDataError(input, resultFuture, e);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 145 -                    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 146 -                } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 147 -                    dealMissKey(input, resultFuture);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 148 -                    dealCacheData(key, CacheMissVal.getMissKeyObj());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 149 +        future.thenAccept(values -&gt; {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 150 +            if (MapUtils.isNotEmpty(values)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 151 +                try {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 152 +                    BaseRow row = fillData(input, values);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 153 +                    dealCacheData(key,CacheObj.buildCacheObj(ECacheContentType.SingleLine, row));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 154 +                    RowDataComplete.completeBaseRow(resultFuture, row);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 155 +                } catch (Exception e) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 156 +                    dealFillDataError(input, resultFuture, e);</span>
 157                  }
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 158 +            } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 159 +                dealMissKey(input, resultFuture);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 160 +                dealCacheData(key, CacheMissVal.getMissKeyObj());</span>
 161              }
 162          });
 163      }
 164  
 165      @Override
 166      public String buildCacheKey(Map&lt;String, Object&gt; refData) {
 167          return redisSideReqRow.buildCacheKey(refData);
 168      }
 169  
 170      @Override
 171      public void close() throws Exception {
 172          super.close();
 173          if (connection != null){
 174              connection.close();
 175          }
 176          if (redisClient != null){
 177              redisClient.shutdown();
 178          }
 179          if (clusterConnection != null){
 180              clusterConnection.close();
 181          }
 182          if (clusterClient != null){
 183              clusterClient.shutdown();
 184          }
 185      }
 186  
 187  }</pre></td>
                            <td><pre>   1  /*
   2   * Licensed to the Apache Software Foundation (ASF) under one
   3   * or more contributor license agreements.  See the NOTICE file
   4   * distributed with this work for additional information
   5   * regarding copyright ownership.  The ASF licenses this file
   6   * to you under the Apache License, Version 2.0 (the
   7   * &quot;License&quot;); you may not use this file except in compliance
   8   * with the License.  You may obtain a copy of the License at
   9   *
  10   *     http://www.apache.org/licenses/LICENSE-2.0
  11   *
  12   * Unless required by applicable law or agreed to in writing, software
  13   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15   * See the License for the specific language governing permissions and
  16   * limitations under the License.
  17   */
  18  
  19  package com.dtstack.flink.sql.side.redis;
  20  
  21  import com.dtstack.flink.sql.enums.ECacheContentType;
  22  import com.dtstack.flink.sql.side.AbstractSideTableInfo;
  23  import com.dtstack.flink.sql.side.BaseAsyncReqRow;
  24  import com.dtstack.flink.sql.side.CacheMissVal;
  25  import com.dtstack.flink.sql.side.FieldInfo;
  26  import com.dtstack.flink.sql.side.JoinInfo;
  27  import com.dtstack.flink.sql.side.cache.CacheObj;
  28  import com.dtstack.flink.sql.side.redis.enums.RedisType;
  29  import com.dtstack.flink.sql.side.redis.table.RedisSideReqRow;
  30  import com.dtstack.flink.sql.side.redis.table.RedisSideTableInfo;
  31  import com.dtstack.flink.sql.util.RowDataComplete;
  32  import io.lettuce.core.RedisClient;
  33  import io.lettuce.core.RedisFuture;
  34  import io.lettuce.core.RedisURI;
  35  import io.lettuce.core.api.StatefulRedisConnection;
  36  import io.lettuce.core.api.async.RedisHashAsyncCommands;
  37  import io.lettuce.core.api.async.RedisKeyAsyncCommands;
  38  import io.lettuce.core.cluster.RedisClusterClient;
  39  import io.lettuce.core.cluster.api.StatefulRedisClusterConnection;
  40  import org.apache.commons.collections.MapUtils;
  41  import org.apache.commons.lang.StringUtils;
  42  import org.apache.flink.api.java.typeutils.RowTypeInfo;
  43  import org.apache.flink.configuration.Configuration;
  44  import org.apache.flink.streaming.api.functions.async.ResultFuture;
  45  import org.apache.flink.table.dataformat.BaseRow;
  46  
  47  import java.util.List;
  48  import java.util.Map;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  49 +import java.util.Objects;</span>
  50  import java.util.function.Consumer;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  51 +import java.util.regex.Matcher;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  52 +</span>
  53  /**
  54   * @author yanxi
  55   */
  56  public class RedisAsyncReqRow extends BaseAsyncReqRow {
  57  
  58      private static final long serialVersionUID = -2079908694523987738L;
  59  
  60      private RedisClient redisClient;
  61  
  62      private StatefulRedisConnection&lt;String, String&gt; connection;
  63  
  64      private RedisClusterClient clusterClient;
  65  
  66      private StatefulRedisClusterConnection&lt;String, String&gt; clusterConnection;
  67  
  68      private RedisKeyAsyncCommands&lt;String, String&gt; async;
  69  
  70      private RedisSideTableInfo redisSideTableInfo;
  71  
  72      private RedisSideReqRow redisSideReqRow;

  73  
<abbr title="  74      public RedisAsyncReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, AbstractSideTableInfo sideTableInfo) {">  74      public RedisAsyncReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, AbstractðŸ”µ</abbr>
  75          super(new RedisAsyncSideInfo(rowTypeInfo, joinInfo, outFieldInfoList, sideTableInfo));
  76          redisSideReqRow = new RedisSideReqRow(super.sideInfo, (RedisSideTableInfo) sideTableInfo);
  77      }
  78  
  79      @Override
  80      public void open(Configuration parameters) throws Exception {
  81          super.open(parameters);
  82          redisSideTableInfo = (RedisSideTableInfo) sideInfo.getSideTableInfo();
  83          buildRedisClient(redisSideTableInfo);
  84      }
  85  
  86      private void buildRedisClient(RedisSideTableInfo tableInfo){
  87          String url = redisSideTableInfo.getUrl();
  88          String password = redisSideTableInfo.getPassword();
  89  
  90          String database = redisSideTableInfo.getDatabase();
  91          if (database == null){
  92              database = &quot;0&quot;;
  93          }
  94          switch (RedisType.parse(tableInfo.getRedisType())){
  95              case STANDALONE:
  96                  RedisURI redisURI = RedisURI.create(&quot;redis://&quot; + url);
  97                  redisURI.setPassword(password);
  98                  redisURI.setDatabase(Integer.valueOf(database));

  99                  redisClient = RedisClient.create(redisURI);
 100                  connection = redisClient.connect();
 101                  async = connection.async();
 102                  break;
 103              case SENTINEL:
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 104 -                RedisURI redisSentinelURI = RedisURI.create(&quot;redis-sentinel://&quot; + url);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 105 -                redisSentinelURI.setPassword(password);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 106 -                redisSentinelURI.setDatabase(Integer.valueOf(database));</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 107 -                redisSentinelURI.setSentinelMasterId(redisSideTableInfo.getMasterName());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 108 -                redisClient = RedisClient.create(redisSentinelURI);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 109 +                String[] urlSplit = StringUtils.split(url, &quot;,&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 110 +                RedisURI.Builder builder = null;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 111 +                for (String item : urlSplit) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 112 +                    Matcher mather = RedisSideReqRow.HOST_PORT_PATTERN.matcher(item);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 113 +                    if (mather.find()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 114 +                        builder = buildSentinelUri(</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 115 +                                mather.group(&quot;host&quot;),</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 116 +                                mather.group(&quot;port&quot;),</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 117 +                                builder</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 118 +                        );</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 119 +                    } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 120 +                        throw new IllegalArgumentException(</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 121 +                                String.format(&quot;Illegal format with redis url [%s]&quot;, item)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 122 +                        );</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 123 +                    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 124 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 125 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 126 +                if (Objects.nonNull(builder)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 127 +                    builder</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 128 +                            .withPassword(tableInfo.getPassword())</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 129 +                            .withDatabase(Integer.parseInt(tableInfo.getDatabase()))</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 130 +                            .withSentinelMasterId(tableInfo.getMasterName());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 131 +                } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 132 +                    throw new NullPointerException(&quot;build redis uri error!&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 133 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 134 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 135 +                RedisURI uri = builder.build();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 136 +                redisClient = RedisClient.create(uri);</span>
 137                  connection = redisClient.connect();
 138                  async = connection.async();
 139                  break;
 140              case CLUSTER:
 141                  RedisURI clusterURI = RedisURI.create(&quot;redis://&quot; + url);
 142                  clusterURI.setPassword(password);
 143                  clusterClient = RedisClusterClient.create(clusterURI);
 144                  clusterConnection = clusterClient.connect();
 145                  async = clusterConnection.async();
 146              default:
 147                  break;
 148          }
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 149 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 150 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 151 +    private RedisURI.Builder buildSentinelUri(</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 152 +            String host,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 153 +            String port,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 154 +            RedisURI.Builder builder) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 155 +        if (Objects.nonNull(builder)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 156 +            builder.withSentinel(host, Integer.parseInt(port));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 157 +        } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 158 +            builder = RedisURI.Builder.sentinel(host, Integer.parseInt(port));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 159 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 160 +        return builder;</span>
 161      }
 162  
 163      @Override
 164      public BaseRow fillData(BaseRow input, Object sideInput) {
 165          return redisSideReqRow.fillData(input, sideInput);
 166      }
 167  
 168      @Override
<abbr title=" 169      public void handleAsyncInvoke(Map&lt;String, Object&gt; inputParams, BaseRow input, ResultFuture&lt;BaseRow&gt; resultFuture) throws Exception {"> 169      public void handleAsyncInvoke(Map&lt;String, Object&gt; inputParams, BaseRow input, ResultFuture&lt;BaseRow&gt; resultFutuðŸ”µ</abbr>
 170          String key = buildCacheKey(inputParams);
 171          if(StringUtils.isBlank(key)){
 172              return;
 173          }
 174          RedisFuture&lt;Map&lt;String, String&gt;&gt; future = ((RedisHashAsyncCommands) async).hgetall(key);
 175          future.thenAccept(new Consumer&lt;Map&lt;String, String&gt;&gt;() {
 176              @Override
 177              public void accept(Map&lt;String, String&gt; values) {
 178                  if (MapUtils.isNotEmpty(values)) {
 179                      try {
 180                          BaseRow row = fillData(input, values);
 181                          dealCacheData(key,CacheObj.buildCacheObj(ECacheContentType.SingleLine, row));
 182                          RowDataComplete.completeBaseRow(resultFuture, row);
 183                      } catch (Exception e) {
 184                          dealFillDataError(input, resultFuture, e);
 185                      }
 186                  } else {
 187                      dealMissKey(input, resultFuture);
 188                      dealCacheData(key, CacheMissVal.getMissKeyObj());








 189                  }



 190              }
 191          });
 192      }
 193  
 194      @Override
 195      public String buildCacheKey(Map&lt;String, Object&gt; refData) {
 196          return redisSideReqRow.buildCacheKey(refData);
 197      }
 198  
 199      @Override
 200      public void close() throws Exception {
 201          super.close();
 202          if (connection != null){
 203              connection.close();
 204          }
 205          if (redisClient != null){
 206              redisClient.shutdown();
 207          }
 208          if (clusterConnection != null){
 209              clusterConnection.close();
 210          }
 211          if (clusterClient != null){
 212              clusterClient.shutdown();
 213          }
 214      }
 215  
 216  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            