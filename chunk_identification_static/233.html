<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>233</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    233
                    <a href="232.html">prev</a>
                    <a href="234.html">next</a>
                    <a href="233_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    BroadleafCommerce/BroadleafCommerce_8a215674f716dcaf861d2fd1d33951ef2d117dfc_core/broadleaf-framework-web/src/main/java/org/broadleafcommerce/core/web/processor/GoogleUniversalAnalyticsProcessor.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;8a215674f716dcaf861d2fd1d33951ef2d117dfc:core/broadleaf-framework-web/src/main/java/org/broadleafcommerce/core/web/processor/GoogleUniversalAnalyticsProcessor.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;8a215674f716dcaf861d2fd1d33951ef2d117dfc^1:core/broadleaf-framework-web/src/main/java/org/broadleafcommerce/core/web/processor/GoogleUniversalAnalyticsProcessor.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;8a215674f716dcaf861d2fd1d33951ef2d117dfc^2:core/broadleaf-framework-web/src/main/java/org/broadleafcommerce/core/web/processor/GoogleUniversalAnalyticsProcessor.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;2f9b07c02068e537453caf19387c86881174dd4a:core/broadleaf-framework-web/src/main/java/org/broadleafcommerce/core/web/processor/GoogleUniversalAnalyticsProcessor.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[bj], [s]], subset: [[sbj]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Framework Web
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  * 
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.core.web.processor;
  19 
  20 import org.apache.commons.collections.MapUtils;
  21 import org.apache.commons.lang3.StringUtils;
  22 import org.apache.commons.logging.Log;
  23 import org.apache.commons.logging.LogFactory;
  24 import org.broadleafcommerce.common.util.BLCSystemProperty;
  25 import org.broadleafcommerce.common.web.BroadleafRequestContext;
  26 import org.broadleafcommerce.core.catalog.domain.Sku;
  27 import org.broadleafcommerce.core.order.domain.DiscreteOrderItem;
  28 import org.broadleafcommerce.core.order.domain.FulfillmentGroup;
  29 import org.broadleafcommerce.core.order.domain.FulfillmentGroupItem;
  30 import org.broadleafcommerce.core.order.domain.Order;
  31 import org.broadleafcommerce.core.order.domain.OrderItem;
  32 import org.broadleafcommerce.core.order.domain.OrderItemAttribute;
  33 import org.broadleafcommerce.core.order.domain.SkuAccessor;
  34 import org.broadleafcommerce.core.order.service.OrderService;
  35 import org.broadleafcommerce.presentation.condition.ConditionalOnTemplating;
  36 import org.broadleafcommerce.presentation.dialect.AbstractBroadleafTagReplacementProcessor;
  37 import org.broadleafcommerce.presentation.model.BroadleafTemplateContext;
  38 import org.broadleafcommerce.presentation.model.BroadleafTemplateElement;
  39 import org.broadleafcommerce.presentation.model.BroadleafTemplateModel;
  40 import org.broadleafcommerce.presentation.model.BroadleafTemplateNonVoidElement;
  41 import org.springframework.beans.factory.annotation.Value;
  42 import org.springframework.stereotype.Component;
  43 
  44 import java.util.HashMap;
  45 import java.util.Map;
  46 import java.util.Map.Entry;
  47 
  48 import javax.annotation.Resource;
  49 import javax.servlet.http.HttpServletRequest;
  50 
  51 /**
  52  * &lt;p&gt;
<abbr title="  53  * Takes advantage of the new-stype analytics.js from Google Analytics rather than the deprected ga.js. This also">  53  * Takes advantage of the new-stype analytics.js from Google Analytics rather than the deprected ga.js. TðŸ”µ</abbr>
<abbr title="  54  * supports a pre-processed &lt;b&gt;orderNumber&lt;/b&gt; attribute that can be null, suitable for things like the order confirmation">  54  * supports a pre-processed &lt;b&gt;orderNumber&lt;/b&gt; attribute that can be null, suitable for things like the oðŸ”µ</abbr>
  55  * page to send e-commerce transactions. Example usage:
  56  * 
  57  * &lt;pre&gt;
  58  * &amp;lt;google_universal_analytics ordernumber=&quot;${order?.orderNumber&quot; /&amp;gt;
  59  * &lt;/pre&gt;
  60  * 
  61  * &lt;p&gt;
  62  * This processor also supports:
  63  * &lt;ul&gt;
<abbr title="  64  *  &lt;li&gt;Multiple trackers (extensible via {@link #getTrackers()} or by setting the {@code googleAnalytics.masterWebPropertyId}">  64  *  &lt;li&gt;Multiple trackers (extensible via {@link #getTrackers()} or by setting the {@code googleAnalyticsðŸ”µ</abbr>
  65  *      and {@code googleAnalytics.webPropertyId})&lt;/li&gt;
  66  *  &lt;li&gt;Affiliates for e-commerce ({@ googleAnalytics.affiliation property})&lt;/li&gt;
<abbr title="  67  *  &lt;li&gt;&lt;a href=&quot;https://support.google.com/analytics/answer/2558867?hl=en&amp;utm_id=ad&quot;&gt;Link attribution&lt;/a&gt;">  67  *  &lt;li&gt;&lt;a href=&quot;https://support.google.com/analytics/answer/2558867?hl=en&amp;utm_id=ad&quot;&gt;Link attribution&lt;/aðŸ”µ</abbr>
  68  *      ({@code googleAnalytics.enableLinkAttribution} system property, default {@code true})&lt;/li&gt;
  69  *  &lt;li&gt;&lt;a href=&quot;https://support.google.com/analytics/answer/3450482&quot;&gt;Display Advertising&lt;/a&gt;
  70  *      ({@code googleAnalytics.enableDisplayAdvertising} system property, default {@code false})&lt;/li&gt;
  71  * &lt;/ul&gt;
  72  * 
<abbr title="  73  * @param ordernumber the order number to look up for ecommerce tracking, such as on the confirmation page">  73  * @param ordernumber the order number to look up for ecommerce tracking, such as on the confirmation pagðŸ”µ</abbr>
  74  * 
  75  * @author Phillip Verheyden (phillipuniverse)
  76  */
  77 @Component(&quot;blGoogleUniversalAnalyticsProcessor&quot;)
  78 @ConditionalOnTemplating
  79 public class GoogleUniversalAnalyticsProcessor extends AbstractBroadleafTagReplacementProcessor {
  80 
  81     private static final Log LOG = LogFactory.getLog(GoogleUniversalAnalyticsProcessor.class);
  82 
  83     /**
<abbr title="  84      * Global value, intentionally only retrieved as a file property NOT via the system properties service">  84      * Global value, intentionally only retrieved as a file property NOT via the system properties servicðŸ”µ</abbr>
  85      */
  86     @Value(&quot;${googleAnalytics.masterWebPropertyId}&quot;)
  87     protected String masterWebPropertyId;
  88     
  89     @Resource(name = &quot;blOrderService&quot;)
  90     protected OrderService orderService;
  91     
  92     /**
<abbr title="  93      * This will force the domain to 127.0.0.1 which is useful to determine if the Google Analytics tag is sending">  93      * This will force the domain to 127.0.0.1 which is useful to determine if the Google Analytics tag iðŸ”µ</abbr>
  94      * a request to Google
  95      */
  96     @Value(&quot;${googleAnalytics.testLocal}&quot;)
  97     protected boolean testLocal = false;
  98     
  99     @Override
 100     public String getName() {
 101         return &quot;google_universal_analytics&quot;;
 102     }
 103     
 104     @Override
 105     public int getPrecedence() {
 106         return 0;
 107     }
 108     
 109     @Override
<abbr title=" 110     public BroadleafTemplateModel getReplacementModel(String tagName, Map&lt;String, String&gt; tagAttributes, BroadleafTemplateContext context) {"> 110     public BroadleafTemplateModel getReplacementModel(String tagName, Map&lt;String, String&gt; tagAttributes, ðŸ”µ</abbr>
 111         StringBuffer sb = new StringBuffer();
 112         Map&lt;String, String&gt; trackers = getTrackers();
 113         if (MapUtils.isNotEmpty(trackers)) {
 114             sb.append(&quot;(function(i,s,o,g,r,a,m){i[&#x27;GoogleAnalyticsObject&#x27;]=r;i[r]=i[r]||function(){&quot;);
 115             sb.append(&quot;(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),&quot;);
 116             sb.append(&quot;m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)&quot;);
 117             sb.append(&quot;})(window,document,&#x27;script&#x27;,&#x27;//www.google-analytics.com/analytics.js&#x27;,&#x27;ga&#x27;);&quot;);
 118             
 119             String orderNumberExpression = tagAttributes.get(&quot;ordernumber&quot;);
 120             String orderNumber = null;
 121             if (orderNumberExpression != null) {
 122                 orderNumber = (String) context.parseExpression(orderNumberExpression);
 123             }
 124             
 125             Order order = null;
 126             if (orderNumber != null) {
 127                 order = orderService.findOrderByOrderNumber(orderNumber);
 128             }
 129             
 130             for (Entry&lt;String, String&gt; tracker : trackers.entrySet()) {
 131                 String trackerName = tracker.getKey();
 132                 String trackerPrefix = &quot;&quot;;
 133                 String id = tracker.getValue();
 134                 sb.append(&quot;ga(&#x27;create&#x27;, &#x27;&quot; + id + &quot;&#x27;, &#x27;auto&#x27;, {&quot;);
 135 
 136                 if (!&quot;webProperty&quot;.equals(trackerName)) {
 137                     trackerPrefix = trackerName + &quot;.&quot;;
 138                     sb.append(&quot;&#x27;name&#x27;: &#x27;&quot; + trackerName + &quot;&#x27;&quot;);
 139                     if (testLocal) {
 140                         sb.append(&quot;,&quot;);
 141                     }
 142                 }
 143                 if (testLocal) {
 144                     sb.append(&quot;&#x27;cookieDomain&#x27;: &#x27;none&#x27;&quot;);
 145                 }
 146                 sb.append(&quot;});&quot;);
 147 
 148                 if (&quot;webProperty&quot;.equals(trackerName)) {
<abbr title=" 149                     HttpServletRequest request = BroadleafRequestContext.getBroadleafRequestContext().getRequest();"> 149                     HttpServletRequest request = BroadleafRequestContext.getBroadleafRequestContext().getðŸ”µ</abbr>
 150                     if (request != null) {
<abbr title=" 151                         Map&lt;String, String&gt; setValuesMap = (Map&lt;String, String&gt;) request.getAttribute(&quot;blGAValuesMap&quot;);"> 151                         Map&lt;String, String&gt; setValuesMap = (Map&lt;String, String&gt;) request.getAttribute(&quot;blðŸ”µ</abbr>
 152                         if (setValuesMap != null) {
 153                             for (Map.Entry&lt;String, String&gt; entry : setValuesMap.entrySet()) {
<abbr title=" 154                                 sb.append(&quot;ga(&#x27;&quot; + trackerPrefix + &quot;set&#x27;,&quot;).append(entry.getKey()).append(&quot;,&quot;)"> 154                                 sb.append(&quot;ga(&#x27;&quot; + trackerPrefix + &quot;set&#x27;,&quot;).append(entry.getKey()).appendðŸ”µ</abbr>
 155                                         .append(entry.getValue()).append(&quot;);&quot;);
 156                             }
 157                         }
 158                     }
 159                 }
 160 
 161                 sb.append(&quot;ga(&#x27;&quot; + trackerPrefix + &quot;send&#x27;, &#x27;pageview&#x27;);&quot;);
 162                 
 163                 if (isIncludeLinkAttribution()) {
 164                     sb.append(getLinkAttributionJs(trackerPrefix));
 165                 }
 166                 if (isIncludeDisplayAdvertising()) {
 167                     sb.append(getDisplayAdvertisingJs(trackerPrefix));
 168                 }
 169                 
 170                 if (order != null) {
 171                     sb.append(getTransactionJs(order, trackerPrefix));
 172                 }
 173             }
 174             
 175             // Add contentNode to the document
 176             BroadleafTemplateModel model = context.createModel();
 177             BroadleafTemplateNonVoidElement scriptTag = context.createNonVoidElement(&quot;script&quot;);
 178             BroadleafTemplateElement script = context.createTextElement(sb.toString());
 179             scriptTag.addChild(script);
 180             model.addElement(scriptTag);
 181             return model;
 182         } else {
<abbr title=" 183             LOG.warn(&quot;No trackers were found, not outputting Google Analytics script. Set the googleAnalytics.webPropertyId&quot;"> 183             LOG.warn(&quot;No trackers were found, not outputting Google Analytics script. Set the googleAnalyðŸ”µ</abbr>
<abbr title=" 184                     + &quot; and/or the googleAnalytics.masterWebPropertyId system properties to output Google Analytics&quot;);"> 184                     + &quot; and/or the googleAnalytics.masterWebPropertyId system properties to output GoogleðŸ”µ</abbr>
 185         }
 186         return null;
 187     }
 188 
 189     /**
 190      * Grabs a map of trackers keyed by the tracker name with the analytics ID as the value
 191      */
 192     protected Map&lt;String, String&gt; getTrackers() {
 193         Map&lt;String, String&gt; trackers = new HashMap&lt;&gt;();
 194         if (shouldShowMasterTracker()) {
 195             trackers.put(&quot;master&quot;, getMasterWebPropertyId());
 196         }
 197         if (StringUtils.isNotBlank(getWebPropertyId())) {
 198             trackers.put(&quot;webProperty&quot;, getWebPropertyId());
 199         }
 200         
 201         return trackers;
 202     }
 203     
 204     protected boolean shouldShowMasterTracker() {
 205         String masterWebPropertyId = getMasterWebPropertyId();
<abbr title=" 206         return (StringUtils.isNotBlank(masterWebPropertyId) &amp;&amp; (!&quot;UA-XXXXXXX-X&quot;.equals(masterWebPropertyId)));"> 206         return (StringUtils.isNotBlank(masterWebPropertyId) &amp;&amp; (!&quot;UA-XXXXXXX-X&quot;.equals(masterWebPropertyIðŸ”µ</abbr>
 207     }
 208 
 209     /**
 210      * Builds the linke attribution Javascript
 211      * @param tracker the name of the tracker that is using the link attribution
 212      * @return
 213      */
 214     protected String getLinkAttributionJs(String trackerPrefix) {
 215         return &quot;ga(&#x27;&quot; + trackerPrefix + &quot;require&#x27;, &#x27;linkid&#x27;, &#x27;linkid.js&#x27;);&quot;;
 216     }
 217     
 218     /**
 219      * Builds the display advertising Javascript for the given tracker
 220      * @param tracker
 221      * @return
 222      */
 223     protected String getDisplayAdvertisingJs(String trackerPrefix) {
 224         return &quot;ga(&#x27;&quot; + trackerPrefix + &quot;require&#x27;, &#x27;displayfeatures&#x27;);&quot;;
 225     }
 226     
 227     /**
<abbr title=" 228      * Builds the transaction analytics for the given tracker name. Invokes {@link #getItemJs(Order, String) for each item"> 228      * Builds the transaction analytics for the given tracker name. Invokes {@link #getItemJs(Order, StriðŸ”µ</abbr>
 229      * in the given &lt;b&gt;order&lt;/b&gt;.
 230      */
 231     protected String getTransactionJs(Order order, String trackerPrefix) {
 232         StringBuffer sb = new StringBuffer();
 233         sb.append(&quot;ga(&#x27;&quot; + trackerPrefix + &quot;require&#x27;, &#x27;ecommerce&#x27;, &#x27;ecommerce.js&#x27;);&quot;);
 234         
 235         sb.append(&quot;ga(&#x27;&quot; + trackerPrefix + &quot;ecommerce:addTransaction&#x27;, {&quot;);
 236         sb.append(&quot;&#x27;id&#x27;: &#x27;&quot; + order.getOrderNumber() + &quot;&#x27;&quot;);
 237         if (StringUtils.isNotBlank(getAffiliation())) {
 238             sb.append(&quot;,&#x27;affiliation&#x27;: &#x27;&quot; + getAffiliation() + &quot;&#x27;&quot;);
 239         }
 240         sb.append(&quot;,&#x27;revenue&#x27;: &#x27;&quot; + order.getTotal() + &quot;&#x27;&quot;);
 241         sb.append(&quot;,&#x27;shipping&#x27;:&#x27;&quot; + order.getTotalShipping() + &quot;&#x27;&quot;);
 242         sb.append(&quot;,&#x27;tax&#x27;: &#x27;&quot; + order.getTotalTax() + &quot;&#x27;&quot;);
 243 
 244         if (order.getCurrency() != null) {
 245             sb.append(&quot;,&#x27;currency&#x27;: &#x27;&quot; + order.getCurrency().getCurrencyCode() + &quot;&#x27;&quot;);
 246         }
 247         sb.append(&quot;});&quot;);
 248 
 249         sb.append(getItemJs(order, trackerPrefix));
 250         
 251         sb.append(&quot;ga(&#x27;&quot; + trackerPrefix + &quot;ecommerce:send&#x27;);&quot;);
 252         return sb.toString();
 253     }
 254     
 255     protected String getItemJs(Order order, String trackerPrefix) {
 256         StringBuffer sb = new StringBuffer();
 257         for (FulfillmentGroup fulfillmentGroup : order.getFulfillmentGroups()) {
<abbr title=" 258             for (FulfillmentGroupItem fulfillmentGroupItem : fulfillmentGroup.getFulfillmentGroupItems()) {"> 258             for (FulfillmentGroupItem fulfillmentGroupItem : fulfillmentGroup.getFulfillmentGroupItems())ðŸ”µ</abbr>
 259                 OrderItem orderItem = fulfillmentGroupItem.getOrderItem();
 260 
 261 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 262                 if (SkuAccessor.class.isAssignableFrom(orderItem.getClass())) {</span>
 263 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 264                 Sku sku = ((SkuAccessor) orderItem).getSku();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 265                 </span>
 266 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 267                 if (orderItem instanceof DiscreteOrderItem) {</span>
 268 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 269                     Sku sku = ((SkuAccessor) orderItem).getSku();
 270 
 271                     sb.append(&quot;ga(&#x27;&quot; + trackerPrefix + &quot;ecommerce:addItem&#x27;, {&quot;);
 272                     sb.append(&quot;&#x27;id&#x27;: &#x27;&quot; + order.getOrderNumber() + &quot;&#x27;&quot;);
 273                     sb.append(&quot;,&#x27;name&#x27;: &#x27;&quot; + sku.getName() + &quot;&#x27;&quot;);
 274                     sb.append(&quot;,&#x27;sku&#x27;: &#x27;&quot; + sku.getId() + &quot;&#x27;&quot;);
 275                     sb.append(&quot;,&#x27;category&#x27;: &#x27;&quot; + getVariation(orderItem) + &quot;&#x27;&quot;);
 276                     sb.append(&quot;,&#x27;price&#x27;: &#x27;&quot; + orderItem.getAveragePrice() + &quot;&#x27;&quot;);
 277                     sb.append(&quot;,&#x27;quantity&#x27;: &#x27;&quot; + orderItem.getQuantity() + &quot;&#x27;&quot;);
 278                     sb.append(&quot;});&quot;);
 279                 }
 280             }
 281         }
 282         return sb.toString();
 283     }
 284     
 285     /**
 286      * Returns the product option values separated by a space if they are
 287      * relevant for the item, or the product category if no options are available
 288      * 
 289      * @return
 290      */
 291     protected String getVariation(OrderItem item) {
 292         if (MapUtils.isEmpty(item.getOrderItemAttributes())) {
 293             return item.getCategory() == null ? &quot;&quot; : item.getCategory().getName();
 294         }
 295         
 296         //use product options instead
 297         String result = &quot;&quot;;
 298         for (Map.Entry&lt;String, OrderItemAttribute&gt; entry : item.getOrderItemAttributes().entrySet()) {
 299             result += entry.getValue().getValue() + &quot; &quot;;
 300         }
 301 
 302         //the result has a space at the end, ensure that is stripped out
 303         return result.substring(0, result.length() - 1);
 304     }
 305 
 306     public String getMasterWebPropertyId() {
 307         return masterWebPropertyId;
 308     }
 309 
 310     public void setMasterWebPropertyId(String masterWebPropertyId) {
 311         this.masterWebPropertyId = masterWebPropertyId;
 312     }
 313     
 314     public String getAffiliation() {
 315         return BLCSystemProperty.resolveSystemProperty(&quot;googleAnalytics.affiliation&quot;);
 316     }
 317     
 318     public String getWebPropertyId() {
 319         return BLCSystemProperty.resolveSystemProperty(&quot;googleAnalytics.webPropertyId&quot;);
 320     }
 321     
 322     public boolean isIncludeLinkAttribution() {
<abbr title=" 323         return BLCSystemProperty.resolveBooleanSystemProperty(&quot;googleAnalytics.enableLinkAttribution&quot;, true);"> 323         return BLCSystemProperty.resolveBooleanSystemProperty(&quot;googleAnalytics.enableLinkAttribution&quot;, trðŸ”µ</abbr>
 324     }
 325 
 326     public boolean isIncludeDisplayAdvertising() {
<abbr title=" 327         return BLCSystemProperty.resolveBooleanSystemProperty(&quot;googleAnalytics.enableDisplayAdvertising&quot;, false);"> 327         return BLCSystemProperty.resolveBooleanSystemProperty(&quot;googleAnalytics.enableDisplayAdvertising&quot;,ðŸ”µ</abbr>
 328     }
 329 
 330 }</pre></td>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Framework Web
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  *
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.core.web.processor;
  19 
  20 import org.apache.commons.collections.MapUtils;
  21 import org.apache.commons.lang3.StringUtils;
  22 import org.apache.commons.logging.Log;
  23 import org.apache.commons.logging.LogFactory;
  24 import org.broadleafcommerce.common.util.BLCSystemProperty;
  25 import org.broadleafcommerce.common.web.BroadleafRequestContext;
  26 import org.broadleafcommerce.core.catalog.domain.Sku;
  27 import org.broadleafcommerce.core.order.domain.DiscreteOrderItem;
  28 import org.broadleafcommerce.core.order.domain.FulfillmentGroup;
  29 import org.broadleafcommerce.core.order.domain.FulfillmentGroupItem;
  30 import org.broadleafcommerce.core.order.domain.Order;
  31 import org.broadleafcommerce.core.order.domain.OrderItem;
  32 import org.broadleafcommerce.core.order.domain.OrderItemAttribute;
  33 import org.broadleafcommerce.core.order.domain.SkuAccessor;
  34 import org.broadleafcommerce.core.order.service.OrderService;
  35 import org.broadleafcommerce.presentation.condition.ConditionalOnTemplating;
  36 import org.broadleafcommerce.presentation.dialect.AbstractBroadleafTagReplacementProcessor;
  37 import org.broadleafcommerce.presentation.model.BroadleafTemplateContext;
  38 import org.broadleafcommerce.presentation.model.BroadleafTemplateElement;
  39 import org.broadleafcommerce.presentation.model.BroadleafTemplateModel;
  40 import org.broadleafcommerce.presentation.model.BroadleafTemplateNonVoidElement;
  41 import org.springframework.beans.factory.annotation.Value;
  42 import org.springframework.stereotype.Component;
  43 
  44 import java.util.HashMap;
  45 import java.util.Map;
  46 import java.util.Map.Entry;
  47 
  48 import javax.annotation.Resource;
  49 import javax.servlet.http.HttpServletRequest;
  50 
  51 /**
  52  * &lt;p&gt;
<abbr title="  53  * Takes advantage of the new-stype analytics.js from Google Analytics rather than the deprected ga.js. This also">  53  * Takes advantage of the new-stype analytics.js from Google Analytics rather than the deprected ga.js. TðŸ”µ</abbr>
<abbr title="  54  * supports a pre-processed &lt;b&gt;orderNumber&lt;/b&gt; attribute that can be null, suitable for things like the order confirmation">  54  * supports a pre-processed &lt;b&gt;orderNumber&lt;/b&gt; attribute that can be null, suitable for things like the oðŸ”µ</abbr>
  55  * page to send e-commerce transactions. Example usage:
  56  *
  57  * &lt;pre&gt;
  58  * &amp;lt;google_universal_analytics ordernumber=&quot;${order?.orderNumber&quot; /&amp;gt;
  59  * &lt;/pre&gt;
  60  *
  61  * &lt;p&gt;
  62  * This processor also supports:
  63  * &lt;ul&gt;
<abbr title="  64  *  &lt;li&gt;Multiple trackers (extensible via {@link #getTrackers()} or by setting the {@code googleAnalytics.masterWebPropertyId}">  64  *  &lt;li&gt;Multiple trackers (extensible via {@link #getTrackers()} or by setting the {@code googleAnalyticsðŸ”µ</abbr>
  65  *      and {@code googleAnalytics.webPropertyId})&lt;/li&gt;
  66  *  &lt;li&gt;Affiliates for e-commerce ({@ googleAnalytics.affiliation property})&lt;/li&gt;
<abbr title="  67  *  &lt;li&gt;&lt;a href=&quot;https://support.google.com/analytics/answer/2558867?hl=en&amp;utm_id=ad&quot;&gt;Link attribution&lt;/a&gt;">  67  *  &lt;li&gt;&lt;a href=&quot;https://support.google.com/analytics/answer/2558867?hl=en&amp;utm_id=ad&quot;&gt;Link attribution&lt;/aðŸ”µ</abbr>
  68  *      ({@code googleAnalytics.enableLinkAttribution} system property, default {@code true})&lt;/li&gt;
  69  *  &lt;li&gt;&lt;a href=&quot;https://support.google.com/analytics/answer/3450482&quot;&gt;Display Advertising&lt;/a&gt;
  70  *      ({@code googleAnalytics.enableDisplayAdvertising} system property, default {@code false})&lt;/li&gt;
  71  * &lt;/ul&gt;
  72  *
<abbr title="  73  * @param ordernumber the order number to look up for ecommerce tracking, such as on the confirmation page">  73  * @param ordernumber the order number to look up for ecommerce tracking, such as on the confirmation pagðŸ”µ</abbr>
  74  *
  75  * @author Phillip Verheyden (phillipuniverse)
  76  */
  77 @Component(&quot;blGoogleUniversalAnalyticsProcessor&quot;)
  78 @ConditionalOnTemplating
  79 public class GoogleUniversalAnalyticsProcessor extends AbstractBroadleafTagReplacementProcessor {
  80 
  81     private static final Log LOG = LogFactory.getLog(GoogleUniversalAnalyticsProcessor.class);
  82 
  83     /**
<abbr title="  84      * Global value, intentionally only retrieved as a file property NOT via the system properties service">  84      * Global value, intentionally only retrieved as a file property NOT via the system properties servicðŸ”µ</abbr>
  85      */
  86     @Value(&quot;${googleAnalytics.masterWebPropertyId}&quot;)
  87     protected String masterWebPropertyId;
  88 
  89     @Resource(name = &quot;blOrderService&quot;)
  90     protected OrderService orderService;
  91 
  92     /**
<abbr title="  93      * This will force the domain to 127.0.0.1 which is useful to determine if the Google Analytics tag is sending">  93      * This will force the domain to 127.0.0.1 which is useful to determine if the Google Analytics tag iðŸ”µ</abbr>
  94      * a request to Google
  95      */
  96     @Value(&quot;${googleAnalytics.testLocal}&quot;)
  97     protected boolean testLocal = false;
  98 
  99     @Override
 100     public String getName() {
 101         return &quot;google_universal_analytics&quot;;
 102     }
 103 
 104     @Override
 105     public int getPrecedence() {
 106         return 0;
 107     }
 108 
 109     @Override
<abbr title=" 110     public BroadleafTemplateModel getReplacementModel(String tagName, Map&lt;String, String&gt; tagAttributes, BroadleafTemplateContext context) {"> 110     public BroadleafTemplateModel getReplacementModel(String tagName, Map&lt;String, String&gt; tagAttributes, ðŸ”µ</abbr>
 111         StringBuffer sb = new StringBuffer();
 112         Map&lt;String, String&gt; trackers = getTrackers();
 113         if (MapUtils.isNotEmpty(trackers)) {
 114             sb.append(&quot;(function(i,s,o,g,r,a,m){i[&#x27;GoogleAnalyticsObject&#x27;]=r;i[r]=i[r]||function(){&quot;);
 115             sb.append(&quot;(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),&quot;);
 116             sb.append(&quot;m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)&quot;);
 117             sb.append(&quot;})(window,document,&#x27;script&#x27;,&#x27;//www.google-analytics.com/analytics.js&#x27;,&#x27;ga&#x27;);&quot;);
 118 
 119             String orderNumberExpression = tagAttributes.get(&quot;ordernumber&quot;);
 120             String orderNumber = null;
 121             if (orderNumberExpression != null) {
 122                 orderNumber = (String) context.parseExpression(orderNumberExpression);
 123             }
 124 
 125             Order order = null;
 126             if (orderNumber != null) {
 127                 order = orderService.findOrderByOrderNumber(orderNumber);
 128             }
 129 
 130             for (Entry&lt;String, String&gt; tracker : trackers.entrySet()) {
 131                 String trackerName = tracker.getKey();
 132                 String trackerPrefix = &quot;&quot;;
 133                 String id = tracker.getValue();
 134                 sb.append(&quot;ga(&#x27;create&#x27;, &#x27;&quot; + id + &quot;&#x27;, &#x27;auto&#x27;, {&quot;);
 135 
 136                 if (!&quot;webProperty&quot;.equals(trackerName)) {
 137                     trackerPrefix = trackerName + &quot;.&quot;;
 138                     sb.append(&quot;&#x27;name&#x27;: &#x27;&quot; + trackerName + &quot;&#x27;&quot;);
 139                     if (testLocal) {
 140                         sb.append(&quot;,&quot;);
 141                     }
 142                 }
 143                 if (testLocal) {
 144                     sb.append(&quot;&#x27;cookieDomain&#x27;: &#x27;none&#x27;&quot;);
 145                 }
 146                 sb.append(&quot;});&quot;);
 147 
 148                 if (&quot;webProperty&quot;.equals(trackerName)) {
<abbr title=" 149                     HttpServletRequest request = BroadleafRequestContext.getBroadleafRequestContext().getRequest();"> 149                     HttpServletRequest request = BroadleafRequestContext.getBroadleafRequestContext().getðŸ”µ</abbr>
 150                     if (request != null) {
<abbr title=" 151                         Map&lt;String, String&gt; setValuesMap = (Map&lt;String, String&gt;) request.getAttribute(&quot;blGAValuesMap&quot;);"> 151                         Map&lt;String, String&gt; setValuesMap = (Map&lt;String, String&gt;) request.getAttribute(&quot;blðŸ”µ</abbr>
 152                         if (setValuesMap != null) {
 153                             for (Map.Entry&lt;String, String&gt; entry : setValuesMap.entrySet()) {
<abbr title=" 154                                 sb.append(&quot;ga(&#x27;&quot; + trackerPrefix + &quot;set&#x27;,&quot;).append(entry.getKey()).append(&quot;,&quot;)"> 154                                 sb.append(&quot;ga(&#x27;&quot; + trackerPrefix + &quot;set&#x27;,&quot;).append(entry.getKey()).appendðŸ”µ</abbr>
 155                                         .append(entry.getValue()).append(&quot;);&quot;);
 156                             }
 157                         }
 158                     }
 159                 }
 160 
 161                 sb.append(&quot;ga(&#x27;&quot; + trackerPrefix + &quot;send&#x27;, &#x27;pageview&#x27;);&quot;);
 162 
 163                 if (isIncludeLinkAttribution()) {
 164                     sb.append(getLinkAttributionJs(trackerPrefix));
 165                 }
 166                 if (isIncludeDisplayAdvertising()) {
 167                     sb.append(getDisplayAdvertisingJs(trackerPrefix));
 168                 }
 169 
 170                 if (order != null) {
 171                     sb.append(getTransactionJs(order, trackerPrefix));
 172                 }
 173             }
 174 
 175             // Add contentNode to the document
 176             BroadleafTemplateModel model = context.createModel();
 177             BroadleafTemplateNonVoidElement scriptTag = context.createNonVoidElement(&quot;script&quot;);
 178             BroadleafTemplateElement script = context.createTextElement(sb.toString());
 179             scriptTag.addChild(script);
 180             model.addElement(scriptTag);
 181             return model;
 182         } else {
<abbr title=" 183             LOG.warn(&quot;No trackers were found, not outputting Google Analytics script. Set the googleAnalytics.webPropertyId&quot;"> 183             LOG.warn(&quot;No trackers were found, not outputting Google Analytics script. Set the googleAnalyðŸ”µ</abbr>
<abbr title=" 184                     + &quot; and/or the googleAnalytics.masterWebPropertyId system properties to output Google Analytics&quot;);"> 184                     + &quot; and/or the googleAnalytics.masterWebPropertyId system properties to output GoogleðŸ”µ</abbr>
 185         }
 186         return null;
 187     }
 188 
 189     /**
 190      * Grabs a map of trackers keyed by the tracker name with the analytics ID as the value
 191      */
 192     protected Map&lt;String, String&gt; getTrackers() {
 193         Map&lt;String, String&gt; trackers = new HashMap&lt;&gt;();
 194         if (shouldShowMasterTracker()) {
 195             trackers.put(&quot;master&quot;, getMasterWebPropertyId());
 196         }
 197         if (StringUtils.isNotBlank(getWebPropertyId())) {
 198             trackers.put(&quot;webProperty&quot;, getWebPropertyId());
 199         }
 200 
 201         return trackers;
 202     }
 203 
 204     protected boolean shouldShowMasterTracker() {
 205         String masterWebPropertyId = getMasterWebPropertyId();
<abbr title=" 206         return (StringUtils.isNotBlank(masterWebPropertyId) &amp;&amp; (!&quot;UA-XXXXXXX-X&quot;.equals(masterWebPropertyId)));"> 206         return (StringUtils.isNotBlank(masterWebPropertyId) &amp;&amp; (!&quot;UA-XXXXXXX-X&quot;.equals(masterWebPropertyIðŸ”µ</abbr>
 207     }
 208 
 209     /**
 210      * Builds the linke attribution Javascript
 211      * @param tracker the name of the tracker that is using the link attribution
 212      * @return
 213      */
 214     protected String getLinkAttributionJs(String trackerPrefix) {
 215         return &quot;ga(&#x27;&quot; + trackerPrefix + &quot;require&#x27;, &#x27;linkid&#x27;, &#x27;linkid.js&#x27;);&quot;;
 216     }
 217 
 218     /**
 219      * Builds the display advertising Javascript for the given tracker
 220      * @param tracker
 221      * @return
 222      */
 223     protected String getDisplayAdvertisingJs(String trackerPrefix) {
 224         return &quot;ga(&#x27;&quot; + trackerPrefix + &quot;require&#x27;, &#x27;displayfeatures&#x27;);&quot;;
 225     }
 226 
 227     /**
<abbr title=" 228      * Builds the transaction analytics for the given tracker name. Invokes {@link #getItemJs(Order, String) for each item"> 228      * Builds the transaction analytics for the given tracker name. Invokes {@link #getItemJs(Order, StriðŸ”µ</abbr>
 229      * in the given &lt;b&gt;order&lt;/b&gt;.
 230      */
 231     protected String getTransactionJs(Order order, String trackerPrefix) {
 232         StringBuffer sb = new StringBuffer();
 233         sb.append(&quot;ga(&#x27;&quot; + trackerPrefix + &quot;require&#x27;, &#x27;ecommerce&#x27;, &#x27;ecommerce.js&#x27;);&quot;);
 234 
 235         sb.append(&quot;ga(&#x27;&quot; + trackerPrefix + &quot;ecommerce:addTransaction&#x27;, {&quot;);
 236         sb.append(&quot;&#x27;id&#x27;: &#x27;&quot; + order.getOrderNumber() + &quot;&#x27;&quot;);
 237         if (StringUtils.isNotBlank(getAffiliation())) {
 238             sb.append(&quot;,&#x27;affiliation&#x27;: &#x27;&quot; + getAffiliation() + &quot;&#x27;&quot;);
 239         }
 240         sb.append(&quot;,&#x27;revenue&#x27;: &#x27;&quot; + order.getTotal() + &quot;&#x27;&quot;);
 241         sb.append(&quot;,&#x27;shipping&#x27;:&#x27;&quot; + order.getTotalShipping() + &quot;&#x27;&quot;);
 242         sb.append(&quot;,&#x27;tax&#x27;: &#x27;&quot; + order.getTotalTax() + &quot;&#x27;&quot;);
 243 
 244         if (order.getCurrency() != null) {
 245             sb.append(&quot;,&#x27;currency&#x27;: &#x27;&quot; + order.getCurrency().getCurrencyCode() + &quot;&#x27;&quot;);
 246         }
 247         sb.append(&quot;});&quot;);
 248 
 249         sb.append(getItemJs(order, trackerPrefix));
 250 
 251         sb.append(&quot;ga(&#x27;&quot; + trackerPrefix + &quot;ecommerce:send&#x27;);&quot;);
 252         return sb.toString();
 253     }
 254 
 255     protected String getItemJs(Order order, String trackerPrefix) {
 256         StringBuffer sb = new StringBuffer();
 257         for (FulfillmentGroup fulfillmentGroup : order.getFulfillmentGroups()) {
<abbr title=" 258             for (FulfillmentGroupItem fulfillmentGroupItem : fulfillmentGroup.getFulfillmentGroupItems()) {"> 258             for (FulfillmentGroupItem fulfillmentGroupItem : fulfillmentGroup.getFulfillmentGroupItems())ðŸ”µ</abbr>
 259                 OrderItem orderItem = fulfillmentGroupItem.getOrderItem();
 260 
 261 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 262                 if (SkuAccessor.class.isAssignableFrom(orderItem.getClass())) {</span>
 263 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 264                 Sku sku = ((SkuAccessor) orderItem).getSku();</span>
 265 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 266                 if (orderItem instanceof DiscreteOrderItem) {</span>
 267 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 268                 Sku sku = ((SkuAccessor) orderItem).getSku();
 269 
 270                 sb.append(&quot;ga(&#x27;&quot; + trackerPrefix + &quot;ecommerce:addItem&#x27;, {&quot;);
 271                 sb.append(&quot;&#x27;id&#x27;: &#x27;&quot; + order.getOrderNumber() + &quot;&#x27;&quot;);
 272                 sb.append(&quot;,&#x27;name&#x27;: &#x27;&quot; + sku.getName() + &quot;&#x27;&quot;);
 273                 sb.append(&quot;,&#x27;sku&#x27;: &#x27;&quot; + sku.getId() + &quot;&#x27;&quot;);
 274                 sb.append(&quot;,&#x27;category&#x27;: &#x27;&quot; + getVariation(orderItem) + &quot;&#x27;&quot;);
 275                 sb.append(&quot;,&#x27;price&#x27;: &#x27;&quot; + orderItem.getAveragePrice() + &quot;&#x27;&quot;);
 276                 sb.append(&quot;,&#x27;quantity&#x27;: &#x27;&quot; + orderItem.getQuantity() + &quot;&#x27;&quot;);
 277                 sb.append(&quot;});&quot;);
 278             }
 279         }
 280         }
 281         return sb.toString();
 282     }
 283 
 284     /**
 285      * Returns the product option values separated by a space if they are
 286      * relevant for the item, or the product category if no options are available
 287      *
 288      * @return
 289      */
 290     protected String getVariation(OrderItem item) {
 291         if (MapUtils.isEmpty(item.getOrderItemAttributes())) {
 292             return item.getCategory() == null ? &quot;&quot; : item.getCategory().getName();
 293         }
 294 
 295         //use product options instead
 296         String result = &quot;&quot;;
 297         for (Map.Entry&lt;String, OrderItemAttribute&gt; entry : item.getOrderItemAttributes().entrySet()) {
 298             result += entry.getValue().getValue() + &quot; &quot;;
 299         }
 300 
 301         //the result has a space at the end, ensure that is stripped out
 302         return result.substring(0, result.length() - 1);
 303     }
 304 
 305     public String getMasterWebPropertyId() {
 306         return masterWebPropertyId;
 307     }
 308 
 309     public void setMasterWebPropertyId(String masterWebPropertyId) {
 310         this.masterWebPropertyId = masterWebPropertyId;
 311     }
 312 
 313     public String getAffiliation() {
 314         return BLCSystemProperty.resolveSystemProperty(&quot;googleAnalytics.affiliation&quot;);
 315     }
 316 
 317     public String getWebPropertyId() {
 318         return BLCSystemProperty.resolveSystemProperty(&quot;googleAnalytics.webPropertyId&quot;);
 319     }
 320 
 321     public boolean isIncludeLinkAttribution() {
<abbr title=" 322         return BLCSystemProperty.resolveBooleanSystemProperty(&quot;googleAnalytics.enableLinkAttribution&quot;, true);"> 322         return BLCSystemProperty.resolveBooleanSystemProperty(&quot;googleAnalytics.enableLinkAttribution&quot;, trðŸ”µ</abbr>
 323     }
 324 
 325     public boolean isIncludeDisplayAdvertising() {
<abbr title=" 326         return BLCSystemProperty.resolveBooleanSystemProperty(&quot;googleAnalytics.enableDisplayAdvertising&quot;, false);"> 326         return BLCSystemProperty.resolveBooleanSystemProperty(&quot;googleAnalytics.enableDisplayAdvertising&quot;,ðŸ”µ</abbr>
 327     }
 328 
 329 }</pre></td>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Framework Web
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  *
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.core.web.processor;
  19 
  20 import java.util.HashMap;
  21 import java.util.Map.Entry;
  22 import java.util.Map;
  23 import javax.annotation.Resource;
  24 import javax.servlet.http.HttpServletRequest;
  25 import org.apache.commons.collections.MapUtils;
  26 import org.apache.commons.lang3.StringUtils;
  27 import org.apache.commons.logging.Log;
  28 import org.apache.commons.logging.LogFactory;
  29 import org.broadleafcommerce.common.util.BLCSystemProperty;
  30 import org.broadleafcommerce.common.web.BroadleafRequestContext;
  31 import org.broadleafcommerce.core.catalog.domain.Sku;
  32 import org.broadleafcommerce.core.order.domain.DiscreteOrderItem;
  33 import org.broadleafcommerce.core.order.domain.FulfillmentGroup;
  34 import org.broadleafcommerce.core.order.domain.FulfillmentGroupItem;
  35 import org.broadleafcommerce.core.order.domain.Order;
  36 import org.broadleafcommerce.core.order.domain.OrderItem;
  37 import org.broadleafcommerce.core.order.domain.OrderItemAttribute;
  38 import org.broadleafcommerce.core.order.domain.SkuAccessor;
  39 import org.broadleafcommerce.core.order.service.OrderService;
  40 import org.broadleafcommerce.presentation.condition.ConditionalOnTemplating;
  41 import org.broadleafcommerce.presentation.dialect.AbstractBroadleafTagReplacementProcessor;
  42 import org.broadleafcommerce.presentation.model.BroadleafTemplateContext;
  43 import org.broadleafcommerce.presentation.model.BroadleafTemplateElement;
  44 import org.broadleafcommerce.presentation.model.BroadleafTemplateModel;
  45 import org.broadleafcommerce.presentation.model.BroadleafTemplateNonVoidElement;
  46 import org.springframework.beans.factory.annotation.Value;
  47 import org.springframework.stereotype.Component;
  48 
  49 
  50 /**
  51  * &lt;p&gt;
<abbr title="  52  * Takes advantage of the new-stype analytics.js from Google Analytics rather than the deprected ga.js. This also">  52  * Takes advantage of the new-stype analytics.js from Google Analytics rather than the deprected ga.js. TðŸ”µ</abbr>
<abbr title="  53  * supports a pre-processed &lt;b&gt;orderNumber&lt;/b&gt; attribute that can be null, suitable for things like the order confirmation">  53  * supports a pre-processed &lt;b&gt;orderNumber&lt;/b&gt; attribute that can be null, suitable for things like the oðŸ”µ</abbr>
  54  * page to send e-commerce transactions. Example usage:
  55  *
  56  * &lt;pre&gt;
  57  * &amp;lt;google_universal_analytics ordernumber=&quot;${order?.orderNumber&quot; /&amp;gt;
  58  * &lt;/pre&gt;
  59  *
  60  * &lt;p&gt;
  61  * This processor also supports:
  62  * &lt;ul&gt;
<abbr title="  63  *  &lt;li&gt;Multiple trackers (extensible via {@link #getTrackers()} or by setting the {@code googleAnalytics.masterWebPropertyId}">  63  *  &lt;li&gt;Multiple trackers (extensible via {@link #getTrackers()} or by setting the {@code googleAnalyticsðŸ”µ</abbr>
  64  *      and {@code googleAnalytics.webPropertyId})&lt;/li&gt;
  65  *  &lt;li&gt;Affiliates for e-commerce ({@ googleAnalytics.affiliation property})&lt;/li&gt;
<abbr title="  66  *  &lt;li&gt;&lt;a href=&quot;https://support.google.com/analytics/answer/2558867?hl=en&amp;utm_id=ad&quot;&gt;Link attribution&lt;/a&gt;">  66  *  &lt;li&gt;&lt;a href=&quot;https://support.google.com/analytics/answer/2558867?hl=en&amp;utm_id=ad&quot;&gt;Link attribution&lt;/aðŸ”µ</abbr>
  67  *      ({@code googleAnalytics.enableLinkAttribution} system property, default {@code true})&lt;/li&gt;
  68  *  &lt;li&gt;&lt;a href=&quot;https://support.google.com/analytics/answer/3450482&quot;&gt;Display Advertising&lt;/a&gt;
  69  *      ({@code googleAnalytics.enableDisplayAdvertising} system property, default {@code false})&lt;/li&gt;
  70  * &lt;/ul&gt;
  71  *
<abbr title="  72  * @param ordernumber the order number to look up for ecommerce tracking, such as on the confirmation page">  72  * @param ordernumber the order number to look up for ecommerce tracking, such as on the confirmation pagðŸ”µ</abbr>
  73  *
  74  * @author Phillip Verheyden (phillipuniverse)
  75  */
  76 @Component(&quot;blGoogleUniversalAnalyticsProcessor&quot;)
  77 @ConditionalOnTemplating
  78 public class GoogleUniversalAnalyticsProcessor extends AbstractBroadleafTagReplacementProcessor {
  79     private static final Log LOG = LogFactory.getLog(GoogleUniversalAnalyticsProcessor.class);
  80 
  81     /**
<abbr title="  82      * Global value, intentionally only retrieved as a file property NOT via the system properties service">  82      * Global value, intentionally only retrieved as a file property NOT via the system properties servicðŸ”µ</abbr>
  83      */
  84     @Value(&quot;${googleAnalytics.masterWebPropertyId}&quot;)
  85     protected String masterWebPropertyId;
  86 
  87     @Resource(name = &quot;blOrderService&quot;)
  88     protected OrderService orderService;
  89 
  90     /**
<abbr title="  91      * This will force the domain to 127.0.0.1 which is useful to determine if the Google Analytics tag is sending">  91      * This will force the domain to 127.0.0.1 which is useful to determine if the Google Analytics tag iðŸ”µ</abbr>
  92      * a request to Google
  93      */
  94     @Value(&quot;${googleAnalytics.testLocal}&quot;)
  95     protected boolean testLocal = false;
  96 
  97     @Override
  98     public String getName() {
  99         return &quot;google_universal_analytics&quot;;
 100     }
 101 
 102     @Override
 103     public int getPrecedence() {
 104         return 0;
 105     }
 106 
 107     @Override
<abbr title=" 108     public BroadleafTemplateModel getReplacementModel(String tagName, Map&lt;String, String&gt; tagAttributes, BroadleafTemplateContext context) {"> 108     public BroadleafTemplateModel getReplacementModel(String tagName, Map&lt;String, String&gt; tagAttributes, ðŸ”µ</abbr>
 109         StringBuffer sb = new StringBuffer();
 110         Map&lt;String, String&gt; trackers = getTrackers();
 111         if (MapUtils.isNotEmpty(trackers)) {
 112             sb.append(&quot;(function(i,s,o,g,r,a,m){i[&#x27;GoogleAnalyticsObject&#x27;]=r;i[r]=i[r]||function(){&quot;);
 113             sb.append(&quot;(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),&quot;);
 114             sb.append(&quot;m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)&quot;);
 115             sb.append(&quot;})(window,document,&#x27;script&#x27;,&#x27;//www.google-analytics.com/analytics.js&#x27;,&#x27;ga&#x27;);&quot;);
 116 
 117             String orderNumberExpression = tagAttributes.get(&quot;ordernumber&quot;);
 118             String orderNumber = null;
 119             if (orderNumberExpression != null) {
 120                 orderNumber = (String) context.parseExpression(orderNumberExpression);
 121             }
 122 
 123             Order order = null;
 124             if (orderNumber != null) {
 125                 order = orderService.findOrderByOrderNumber(orderNumber);
 126             }
 127 
 128             for (Entry&lt;String, String&gt; tracker : trackers.entrySet()) {
 129                 String trackerName = tracker.getKey();
 130                 String trackerPrefix = &quot;&quot;;
 131                 String id = tracker.getValue();
 132                 sb.append(&quot;ga(&#x27;create&#x27;, &#x27;&quot; + id + &quot;&#x27;, &#x27;auto&#x27;, {&quot;);
 133 
 134                 if (!&quot;webProperty&quot;.equals(trackerName)) {
 135                     trackerPrefix = trackerName + &quot;.&quot;;
 136                     sb.append(&quot;&#x27;name&#x27;: &#x27;&quot; + trackerName + &quot;&#x27;&quot;);
 137                     if (testLocal) {
 138                         sb.append(&quot;,&quot;);
 139                     }
 140                 }
 141                 if (testLocal) {
 142                     sb.append(&quot;&#x27;cookieDomain&#x27;: &#x27;none&#x27;&quot;);
 143                 }
 144                 sb.append(&quot;});&quot;);
 145 
 146                 if (&quot;webProperty&quot;.equals(trackerName)) {
<abbr title=" 147                     HttpServletRequest request = BroadleafRequestContext.getBroadleafRequestContext().getRequest();"> 147                     HttpServletRequest request = BroadleafRequestContext.getBroadleafRequestContext().getðŸ”µ</abbr>
 148                     if (request != null) {
<abbr title=" 149                         Map&lt;String, String&gt; setValuesMap = (Map&lt;String, String&gt;) request.getAttribute(&quot;blGAValuesMap&quot;);"> 149                         Map&lt;String, String&gt; setValuesMap = (Map&lt;String, String&gt;) request.getAttribute(&quot;blðŸ”µ</abbr>
 150                         if (setValuesMap != null) {
 151                             for (Map.Entry&lt;String, String&gt; entry : setValuesMap.entrySet()) {
<abbr title=" 152                                 sb.append(&quot;ga(&#x27;&quot; + trackerPrefix + &quot;set&#x27;,&quot;).append(entry.getKey()).append(&quot;,&quot;)"> 152                                 sb.append(&quot;ga(&#x27;&quot; + trackerPrefix + &quot;set&#x27;,&quot;).append(entry.getKey()).appendðŸ”µ</abbr>
 153                                         .append(entry.getValue()).append(&quot;);&quot;);
 154                             }
 155                         }
 156                     }
 157                 }
 158 
 159                 sb.append(&quot;ga(&#x27;&quot; + trackerPrefix + &quot;send&#x27;, &#x27;pageview&#x27;);&quot;);
 160 
 161                 if (isIncludeLinkAttribution()) {
 162                     sb.append(getLinkAttributionJs(trackerPrefix));
 163                 }
 164                 if (isIncludeDisplayAdvertising()) {
 165                     sb.append(getDisplayAdvertisingJs(trackerPrefix));
 166                 }
 167 
 168                 if (order != null) {
 169                     sb.append(getTransactionJs(order, trackerPrefix));
 170                 }
 171             }
 172 
 173             // Add contentNode to the document
 174             BroadleafTemplateModel model = context.createModel();
 175             BroadleafTemplateNonVoidElement scriptTag = context.createNonVoidElement(&quot;script&quot;);
 176             BroadleafTemplateElement script = context.createTextElement(sb.toString());
 177             scriptTag.addChild(script);
 178             model.addElement(scriptTag);
 179             return model;
 180         } else {
<abbr title=" 181             LOG.warn(&quot;No trackers were found, not outputting Google Analytics script. Set the googleAnalytics.webPropertyId&quot;"> 181             LOG.warn(&quot;No trackers were found, not outputting Google Analytics script. Set the googleAnalyðŸ”µ</abbr>
<abbr title=" 182                     + &quot; and/or the googleAnalytics.masterWebPropertyId system properties to output Google Analytics&quot;);"> 182                     + &quot; and/or the googleAnalytics.masterWebPropertyId system properties to output GoogleðŸ”µ</abbr>
 183         }
 184         return null;
 185     }
 186 
 187     /**
 188      * Grabs a map of trackers keyed by the tracker name with the analytics ID as the value
 189      */
 190     protected Map&lt;String, String&gt; getTrackers() {
 191         Map&lt;String, String&gt; trackers = new HashMap&lt;&gt;();
 192         if (shouldShowMasterTracker()) {
 193             trackers.put(&quot;master&quot;, getMasterWebPropertyId());
 194         }
 195         if (StringUtils.isNotBlank(getWebPropertyId())) {
 196             trackers.put(&quot;webProperty&quot;, getWebPropertyId());
 197         }
 198 
 199         return trackers;
 200     }
 201 
 202     protected boolean shouldShowMasterTracker() {
 203         String masterWebPropertyId = getMasterWebPropertyId();
<abbr title=" 204         return (StringUtils.isNotBlank(masterWebPropertyId) &amp;&amp; (!&quot;UA-XXXXXXX-X&quot;.equals(masterWebPropertyId)));"> 204         return (StringUtils.isNotBlank(masterWebPropertyId) &amp;&amp; (!&quot;UA-XXXXXXX-X&quot;.equals(masterWebPropertyIðŸ”µ</abbr>
 205     }
 206 
 207     /**
 208      * Builds the linke attribution Javascript
 209      * @param tracker the name of the tracker that is using the link attribution
 210      * @return
 211      */
 212     protected String getLinkAttributionJs(String trackerPrefix) {
 213         return &quot;ga(&#x27;&quot; + trackerPrefix + &quot;require&#x27;, &#x27;linkid&#x27;, &#x27;linkid.js&#x27;);&quot;;
 214     }
 215 
 216     /**
 217      * Builds the display advertising Javascript for the given tracker
 218      * @param tracker
 219      * @return
 220      */
 221     protected String getDisplayAdvertisingJs(String trackerPrefix) {
 222         return &quot;ga(&#x27;&quot; + trackerPrefix + &quot;require&#x27;, &#x27;displayfeatures&#x27;);&quot;;
 223     }
 224 
 225     /**
<abbr title=" 226      * Builds the transaction analytics for the given tracker name. Invokes {@link #getItemJs(Order, String) for each item"> 226      * Builds the transaction analytics for the given tracker name. Invokes {@link #getItemJs(Order, StriðŸ”µ</abbr>
 227      * in the given &lt;b&gt;order&lt;/b&gt;.
 228      */
 229     protected String getTransactionJs(Order order, String trackerPrefix) {
 230         StringBuffer sb = new StringBuffer();
 231         sb.append(&quot;ga(&#x27;&quot; + trackerPrefix + &quot;require&#x27;, &#x27;ecommerce&#x27;, &#x27;ecommerce.js&#x27;);&quot;);
 232 
 233         sb.append(&quot;ga(&#x27;&quot; + trackerPrefix + &quot;ecommerce:addTransaction&#x27;, {&quot;);
 234         sb.append(&quot;&#x27;id&#x27;: &#x27;&quot; + order.getOrderNumber() + &quot;&#x27;&quot;);
 235         if (StringUtils.isNotBlank(getAffiliation())) {
 236             sb.append(&quot;,&#x27;affiliation&#x27;: &#x27;&quot; + getAffiliation() + &quot;&#x27;&quot;);
 237         }
 238         sb.append(&quot;,&#x27;revenue&#x27;: &#x27;&quot; + order.getTotal() + &quot;&#x27;&quot;);
 239         sb.append(&quot;,&#x27;shipping&#x27;:&#x27;&quot; + order.getTotalShipping() + &quot;&#x27;&quot;);
 240         sb.append(&quot;,&#x27;tax&#x27;: &#x27;&quot; + order.getTotalTax() + &quot;&#x27;&quot;);
 241 
 242         if (order.getCurrency() != null) {
 243             sb.append(&quot;,&#x27;currency&#x27;: &#x27;&quot; + order.getCurrency().getCurrencyCode() + &quot;&#x27;&quot;);
 244         }
 245         sb.append(&quot;});&quot;);
 246 
 247         sb.append(getItemJs(order, trackerPrefix));
 248 
 249         sb.append(&quot;ga(&#x27;&quot; + trackerPrefix + &quot;ecommerce:send&#x27;);&quot;);
 250         return sb.toString();
 251     }
 252 
 253     protected String getItemJs(Order order, String trackerPrefix) {
 254         StringBuffer sb = new StringBuffer();
 255         for (FulfillmentGroup fulfillmentGroup : order.getFulfillmentGroups()) {
<abbr title=" 256             for (FulfillmentGroupItem fulfillmentGroupItem : fulfillmentGroup.getFulfillmentGroupItems()) {"> 256             for (FulfillmentGroupItem fulfillmentGroupItem : fulfillmentGroup.getFulfillmentGroupItems())ðŸ”µ</abbr>
 257                 OrderItem orderItem = fulfillmentGroupItem.getOrderItem();
 258                 if (
 259 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 260 SkuAccessor.class.isAssignableFrom(orderItem.getClass())</span>
 261 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 262 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 262 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwðŸ”µ</abbr></span>
 263 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 264 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 265 orderItem instanceof DiscreteOrderItem</span>
 266 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 267                 ) {
 268                     Sku sku = ((SkuAccessor) (orderItem)).getSku();
 269                     sb.append((&quot;ga(&#x27;&quot; + trackerPrefix) + &quot;ecommerce:addItem&#x27;, {&quot;);
 270                     sb.append((&quot;&#x27;id&#x27;: &#x27;&quot; + order.getOrderNumber()) + &quot;&#x27;&quot;);
 271                     sb.append((&quot;,&#x27;name&#x27;: &#x27;&quot; + sku.getName()) + &quot;&#x27;&quot;);
 272                     sb.append((&quot;,&#x27;sku&#x27;: &#x27;&quot; + sku.getId()) + &quot;&#x27;&quot;);
 273                     sb.append((&quot;,&#x27;category&#x27;: &#x27;&quot; + getVariation(orderItem)) + &quot;&#x27;&quot;);
 274                     sb.append((&quot;,&#x27;price&#x27;: &#x27;&quot; + orderItem.getAveragePrice()) + &quot;&#x27;&quot;);
 275                     sb.append((&quot;,&#x27;quantity&#x27;: &#x27;&quot; + orderItem.getQuantity()) + &quot;&#x27;&quot;);
 276                     sb.append(&quot;});&quot;);
 277                 }
 278             }
 279         }
 280         return sb.toString();
 281     }
 282 
 283     /**
 284      * Returns the product option values separated by a space if they are
 285      * relevant for the item, or the product category if no options are available
 286      *
 287      * @return
 288      */
 289     protected String getVariation(OrderItem item) {
 290         if (MapUtils.isEmpty(item.getOrderItemAttributes())) {
 291             return item.getCategory() == null ? &quot;&quot; : item.getCategory().getName();
 292         }
 293 
 294         //use product options instead
 295         String result = &quot;&quot;;
 296         for (Map.Entry&lt;String, OrderItemAttribute&gt; entry : item.getOrderItemAttributes().entrySet()) {
 297             result += entry.getValue().getValue() + &quot; &quot;;
 298         }
 299 
 300         //the result has a space at the end, ensure that is stripped out
 301         return result.substring(0, result.length() - 1);
 302     }
 303 
 304     public String getMasterWebPropertyId() {
 305         return masterWebPropertyId;
 306     }
 307 
 308     public void setMasterWebPropertyId(String masterWebPropertyId) {
 309         this.masterWebPropertyId = masterWebPropertyId;
 310     }
 311 
 312     public String getAffiliation() {
 313         return BLCSystemProperty.resolveSystemProperty(&quot;googleAnalytics.affiliation&quot;);
 314     }
 315 
 316     public String getWebPropertyId() {
 317         return BLCSystemProperty.resolveSystemProperty(&quot;googleAnalytics.webPropertyId&quot;);
 318     }
 319 
 320     public boolean isIncludeLinkAttribution() {
<abbr title=" 321         return BLCSystemProperty.resolveBooleanSystemProperty(&quot;googleAnalytics.enableLinkAttribution&quot;, true);"> 321         return BLCSystemProperty.resolveBooleanSystemProperty(&quot;googleAnalytics.enableLinkAttribution&quot;, trðŸ”µ</abbr>
 322     }
 323 
 324     public boolean isIncludeDisplayAdvertising() {
<abbr title=" 325         return BLCSystemProperty.resolveBooleanSystemProperty(&quot;googleAnalytics.enableDisplayAdvertising&quot;, false);"> 325         return BLCSystemProperty.resolveBooleanSystemProperty(&quot;googleAnalytics.enableDisplayAdvertising&quot;,ðŸ”µ</abbr>
 326     }
 327 }
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  /*
   2   * #%L
   3   * BroadleafCommerce Framework Web
   4   * %%
   5   * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6   * %%
   7   * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8   * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9   * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10   * the Broadleaf End User License Agreement (EULA), Version 1.1
  11   * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12   * shall apply.
  13   *
<abbr title="  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr>
  15   * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.
  16   * #L%
  17   */
  18  package org.broadleafcommerce.core.web.processor;
  19  
  20  import org.apache.commons.collections.MapUtils;
  21  import org.apache.commons.lang3.StringUtils;
  22  import org.apache.commons.logging.Log;
  23  import org.apache.commons.logging.LogFactory;
  24  import org.broadleafcommerce.common.util.BLCSystemProperty;
  25  import org.broadleafcommerce.common.web.BroadleafRequestContext;
  26  import org.broadleafcommerce.core.catalog.domain.Sku;

  27  import org.broadleafcommerce.core.order.domain.FulfillmentGroup;
  28  import org.broadleafcommerce.core.order.domain.FulfillmentGroupItem;
  29  import org.broadleafcommerce.core.order.domain.Order;
  30  import org.broadleafcommerce.core.order.domain.OrderItem;
  31  import org.broadleafcommerce.core.order.domain.OrderItemAttribute;
  32  import org.broadleafcommerce.core.order.domain.SkuAccessor;
  33  import org.broadleafcommerce.core.order.service.OrderService;
  34  import org.broadleafcommerce.presentation.condition.ConditionalOnTemplating;
  35  import org.broadleafcommerce.presentation.dialect.AbstractBroadleafTagReplacementProcessor;
  36  import org.broadleafcommerce.presentation.model.BroadleafTemplateContext;
  37  import org.broadleafcommerce.presentation.model.BroadleafTemplateElement;
  38  import org.broadleafcommerce.presentation.model.BroadleafTemplateModel;
  39  import org.broadleafcommerce.presentation.model.BroadleafTemplateNonVoidElement;
  40  import org.springframework.beans.factory.annotation.Value;
  41  import org.springframework.stereotype.Component;
  42  
  43  import java.util.HashMap;
  44  import java.util.Map;
  45  import java.util.Map.Entry;
  46  
  47  import javax.annotation.Resource;
  48  import javax.servlet.http.HttpServletRequest;
  49  
  50  /**
  51   * &lt;p&gt;
  52   * Takes advantage of the new-stype analytics.js from Google Analytics rather than the deprected ga.js. This also
<abbr title="  53   * supports a pre-processed &lt;b&gt;orderNumber&lt;/b&gt; attribute that can be null, suitable for things like the order confirmation">  53   * supports a pre-processed &lt;b&gt;orderNumber&lt;/b&gt; attribute that can be null, suitable for things like the order confðŸ”µ</abbr>
  54   * page to send e-commerce transactions. Example usage:
  55   *
  56   * &lt;pre&gt;
  57   * &amp;lt;google_universal_analytics ordernumber=&quot;${order?.orderNumber&quot; /&amp;gt;
  58   * &lt;/pre&gt;
  59   *
  60   * &lt;p&gt;
  61   * This processor also supports:
  62   * &lt;ul&gt;
<abbr title="  63   *  &lt;li&gt;Multiple trackers (extensible via {@link #getTrackers()} or by setting the {@code googleAnalytics.masterWebPropertyId}">  63   *  &lt;li&gt;Multiple trackers (extensible via {@link #getTrackers()} or by setting the {@code googleAnalytics.masterWeðŸ”µ</abbr>
  64   *      and {@code googleAnalytics.webPropertyId})&lt;/li&gt;
  65   *  &lt;li&gt;Affiliates for e-commerce ({@ googleAnalytics.affiliation property})&lt;/li&gt;
  66   *  &lt;li&gt;&lt;a href=&quot;https://support.google.com/analytics/answer/2558867?hl=en&amp;utm_id=ad&quot;&gt;Link attribution&lt;/a&gt;
  67   *      ({@code googleAnalytics.enableLinkAttribution} system property, default {@code true})&lt;/li&gt;
  68   *  &lt;li&gt;&lt;a href=&quot;https://support.google.com/analytics/answer/3450482&quot;&gt;Display Advertising&lt;/a&gt;
  69   *      ({@code googleAnalytics.enableDisplayAdvertising} system property, default {@code false})&lt;/li&gt;
  70   * &lt;/ul&gt;
  71   *
  72   * @param ordernumber the order number to look up for ecommerce tracking, such as on the confirmation page
  73   *
  74   * @author Phillip Verheyden (phillipuniverse)
  75   */
  76  @Component(&quot;blGoogleUniversalAnalyticsProcessor&quot;)
  77  @ConditionalOnTemplating
  78  public class GoogleUniversalAnalyticsProcessor extends AbstractBroadleafTagReplacementProcessor {
  79  
  80      private static final Log LOG = LogFactory.getLog(GoogleUniversalAnalyticsProcessor.class);
  81  
  82      /**
  83       * Global value, intentionally only retrieved as a file property NOT via the system properties service
  84       */
  85      @Value(&quot;${googleAnalytics.masterWebPropertyId}&quot;)
  86      protected String masterWebPropertyId;
  87  
  88      @Resource(name = &quot;blOrderService&quot;)
  89      protected OrderService orderService;
  90  
  91      /**
  92       * This will force the domain to 127.0.0.1 which is useful to determine if the Google Analytics tag is sending
  93       * a request to Google
  94       */
  95      @Value(&quot;${googleAnalytics.testLocal}&quot;)
  96      protected boolean testLocal = false;
  97  
  98      @Override
  99      public String getName() {
 100          return &quot;google_universal_analytics&quot;;
 101      }
 102  
 103      @Override
 104      public int getPrecedence() {
 105          return 0;
 106      }
 107  
 108      @Override
<abbr title=" 109      public BroadleafTemplateModel getReplacementModel(String tagName, Map&lt;String, String&gt; tagAttributes, BroadleafTemplateContext context) {"> 109      public BroadleafTemplateModel getReplacementModel(String tagName, Map&lt;String, String&gt; tagAttributes, BroadleafðŸ”µ</abbr>
 110          StringBuffer sb = new StringBuffer();
 111          Map&lt;String, String&gt; trackers = getTrackers();
 112          if (MapUtils.isNotEmpty(trackers)) {
 113              sb.append(&quot;(function(i,s,o,g,r,a,m){i[&#x27;GoogleAnalyticsObject&#x27;]=r;i[r]=i[r]||function(){&quot;);
 114              sb.append(&quot;(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),&quot;);
 115              sb.append(&quot;m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)&quot;);
 116              sb.append(&quot;})(window,document,&#x27;script&#x27;,&#x27;//www.google-analytics.com/analytics.js&#x27;,&#x27;ga&#x27;);&quot;);
 117  
 118              String orderNumberExpression = tagAttributes.get(&quot;ordernumber&quot;);
 119              String orderNumber = null;
 120              if (orderNumberExpression != null) {
 121                  orderNumber = (String) context.parseExpression(orderNumberExpression);
 122              }
 123  
 124              Order order = null;
 125              if (orderNumber != null) {
 126                  order = orderService.findOrderByOrderNumber(orderNumber);
 127              }
 128  
 129              for (Entry&lt;String, String&gt; tracker : trackers.entrySet()) {
 130                  String trackerName = tracker.getKey();
 131                  String trackerPrefix = &quot;&quot;;
 132                  String id = tracker.getValue();
 133                  sb.append(&quot;ga(&#x27;create&#x27;, &#x27;&quot; + id + &quot;&#x27;, &#x27;auto&#x27;, {&quot;);
 134  
 135                  if (!&quot;webProperty&quot;.equals(trackerName)) {
 136                      trackerPrefix = trackerName + &quot;.&quot;;
 137                      sb.append(&quot;&#x27;name&#x27;: &#x27;&quot; + trackerName + &quot;&#x27;&quot;);
 138                      if (testLocal) {
 139                          sb.append(&quot;,&quot;);
 140                      }
 141                  }
 142                  if (testLocal) {
 143                      sb.append(&quot;&#x27;cookieDomain&#x27;: &#x27;none&#x27;&quot;);
 144                  }
 145                  sb.append(&quot;});&quot;);
 146  
 147                  if (&quot;webProperty&quot;.equals(trackerName)) {
<abbr title=" 148                      HttpServletRequest request = BroadleafRequestContext.getBroadleafRequestContext().getRequest();"> 148                      HttpServletRequest request = BroadleafRequestContext.getBroadleafRequestContext().getRequest()ðŸ”µ</abbr>
 149                      if (request != null) {
<abbr title=" 150                          Map&lt;String, String&gt; setValuesMap = (Map&lt;String, String&gt;) request.getAttribute(&quot;blGAValuesMap&quot;);"> 150                          Map&lt;String, String&gt; setValuesMap = (Map&lt;String, String&gt;) request.getAttribute(&quot;blGAValuesMðŸ”µ</abbr>
 151                          if (setValuesMap != null) {
 152                              for (Map.Entry&lt;String, String&gt; entry : setValuesMap.entrySet()) {
 153                                  sb.append(&quot;ga(&#x27;&quot; + trackerPrefix + &quot;set&#x27;,&quot;).append(entry.getKey()).append(&quot;,&quot;)
 154                                          .append(entry.getValue()).append(&quot;);&quot;);
 155                              }
 156                          }
 157                      }
 158                  }
 159  
 160                  sb.append(&quot;ga(&#x27;&quot; + trackerPrefix + &quot;send&#x27;, &#x27;pageview&#x27;);&quot;);
 161  
 162                  if (isIncludeLinkAttribution()) {
 163                      sb.append(getLinkAttributionJs(trackerPrefix));
 164                  }
 165                  if (isIncludeDisplayAdvertising()) {
 166                      sb.append(getDisplayAdvertisingJs(trackerPrefix));
 167                  }
 168  
 169                  if (order != null) {
 170                      sb.append(getTransactionJs(order, trackerPrefix));
 171                  }
 172              }
 173  
 174              // Add contentNode to the document
 175              BroadleafTemplateModel model = context.createModel();
 176              BroadleafTemplateNonVoidElement scriptTag = context.createNonVoidElement(&quot;script&quot;);
 177              BroadleafTemplateElement script = context.createTextElement(sb.toString());
 178              scriptTag.addChild(script);
 179              model.addElement(scriptTag);
 180              return model;
 181          } else {
<abbr title=" 182              LOG.warn(&quot;No trackers were found, not outputting Google Analytics script. Set the googleAnalytics.webPropertyId&quot;"> 182              LOG.warn(&quot;No trackers were found, not outputting Google Analytics script. Set the googleAnalytics.webPðŸ”µ</abbr>
<abbr title=" 183                      + &quot; and/or the googleAnalytics.masterWebPropertyId system properties to output Google Analytics&quot;);"> 183                      + &quot; and/or the googleAnalytics.masterWebPropertyId system properties to output Google AnalyticðŸ”µ</abbr>
 184          }
 185          return null;
 186      }
 187  
 188      /**
 189       * Grabs a map of trackers keyed by the tracker name with the analytics ID as the value
 190       */
 191      protected Map&lt;String, String&gt; getTrackers() {
 192          Map&lt;String, String&gt; trackers = new HashMap&lt;&gt;();
 193          if (shouldShowMasterTracker()) {
 194              trackers.put(&quot;master&quot;, getMasterWebPropertyId());
 195          }
 196          if (StringUtils.isNotBlank(getWebPropertyId())) {
 197              trackers.put(&quot;webProperty&quot;, getWebPropertyId());
 198          }
 199  
 200          return trackers;
 201      }
 202  
 203      protected boolean shouldShowMasterTracker() {
 204          String masterWebPropertyId = getMasterWebPropertyId();
 205          return (StringUtils.isNotBlank(masterWebPropertyId) &amp;&amp; (!&quot;UA-XXXXXXX-X&quot;.equals(masterWebPropertyId)));
 206      }
 207  
 208      /**
 209       * Builds the linke attribution Javascript
 210       * @param tracker the name of the tracker that is using the link attribution
 211       * @return
 212       */
 213      protected String getLinkAttributionJs(String trackerPrefix) {
 214          return &quot;ga(&#x27;&quot; + trackerPrefix + &quot;require&#x27;, &#x27;linkid&#x27;, &#x27;linkid.js&#x27;);&quot;;
 215      }
 216  
 217      /**
 218       * Builds the display advertising Javascript for the given tracker
 219       * @param tracker
 220       * @return
 221       */
 222      protected String getDisplayAdvertisingJs(String trackerPrefix) {
 223          return &quot;ga(&#x27;&quot; + trackerPrefix + &quot;require&#x27;, &#x27;displayfeatures&#x27;);&quot;;
 224      }
 225  
 226      /**
<abbr title=" 227       * Builds the transaction analytics for the given tracker name. Invokes {@link #getItemJs(Order, String) for each item"> 227       * Builds the transaction analytics for the given tracker name. Invokes {@link #getItemJs(Order, String) for eðŸ”µ</abbr>
 228       * in the given &lt;b&gt;order&lt;/b&gt;.
 229       */
 230      protected String getTransactionJs(Order order, String trackerPrefix) {
 231          StringBuffer sb = new StringBuffer();
 232          sb.append(&quot;ga(&#x27;&quot; + trackerPrefix + &quot;require&#x27;, &#x27;ecommerce&#x27;, &#x27;ecommerce.js&#x27;);&quot;);
 233  
 234          sb.append(&quot;ga(&#x27;&quot; + trackerPrefix + &quot;ecommerce:addTransaction&#x27;, {&quot;);
 235          sb.append(&quot;&#x27;id&#x27;: &#x27;&quot; + order.getOrderNumber() + &quot;&#x27;&quot;);
 236          if (StringUtils.isNotBlank(getAffiliation())) {
 237              sb.append(&quot;,&#x27;affiliation&#x27;: &#x27;&quot; + getAffiliation() + &quot;&#x27;&quot;);
 238          }
 239          sb.append(&quot;,&#x27;revenue&#x27;: &#x27;&quot; + order.getTotal() + &quot;&#x27;&quot;);
 240          sb.append(&quot;,&#x27;shipping&#x27;:&#x27;&quot; + order.getTotalShipping() + &quot;&#x27;&quot;);
 241          sb.append(&quot;,&#x27;tax&#x27;: &#x27;&quot; + order.getTotalTax() + &quot;&#x27;&quot;);
 242  
 243          if (order.getCurrency() != null) {
 244              sb.append(&quot;,&#x27;currency&#x27;: &#x27;&quot; + order.getCurrency().getCurrencyCode() + &quot;&#x27;&quot;);
 245          }
 246          sb.append(&quot;});&quot;);
 247  
 248          sb.append(getItemJs(order, trackerPrefix));
 249  
 250          sb.append(&quot;ga(&#x27;&quot; + trackerPrefix + &quot;ecommerce:send&#x27;);&quot;);
 251          return sb.toString();
 252      }
 253  
 254      protected String getItemJs(Order order, String trackerPrefix) {
 255          StringBuffer sb = new StringBuffer();
 256          for (FulfillmentGroup fulfillmentGroup : order.getFulfillmentGroups()) {
 257              for (FulfillmentGroupItem fulfillmentGroupItem : fulfillmentGroup.getFulfillmentGroupItems()) {
 258                  OrderItem orderItem = fulfillmentGroupItem.getOrderItem();
 259  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 260 -                Sku sku = ((SkuAccessor) orderItem).getSku();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 261 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 262 -                sb.append(&quot;ga(&#x27;&quot; + trackerPrefix + &quot;ecommerce:addItem&#x27;, {&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 263 -                sb.append(&quot;&#x27;id&#x27;: &#x27;&quot; + order.getOrderNumber() + &quot;&#x27;&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 264 -                sb.append(&quot;,&#x27;name&#x27;: &#x27;&quot; + sku.getName() + &quot;&#x27;&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 265 -                sb.append(&quot;,&#x27;sku&#x27;: &#x27;&quot; + sku.getId() + &quot;&#x27;&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 266 -                sb.append(&quot;,&#x27;category&#x27;: &#x27;&quot; + getVariation(orderItem) + &quot;&#x27;&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 267 -                sb.append(&quot;,&#x27;price&#x27;: &#x27;&quot; + orderItem.getAveragePrice() + &quot;&#x27;&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 268 -                sb.append(&quot;,&#x27;quantity&#x27;: &#x27;&quot; + orderItem.getQuantity() + &quot;&#x27;&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 269 -                sb.append(&quot;});&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 270 +                if (SkuAccessor.class.isAssignableFrom(orderItem.getClass())) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 271 +                    Sku sku = ((SkuAccessor) orderItem).getSku();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 272 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 273 +                    sb.append(&quot;ga(&#x27;&quot; + trackerPrefix + &quot;ecommerce:addItem&#x27;, {&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 274 +                    sb.append(&quot;&#x27;id&#x27;: &#x27;&quot; + order.getOrderNumber() + &quot;&#x27;&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 275 +                    sb.append(&quot;,&#x27;name&#x27;: &#x27;&quot; + sku.getName() + &quot;&#x27;&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 276 +                    sb.append(&quot;,&#x27;sku&#x27;: &#x27;&quot; + sku.getId() + &quot;&#x27;&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 277 +                    sb.append(&quot;,&#x27;category&#x27;: &#x27;&quot; + getVariation(orderItem) + &quot;&#x27;&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 278 +                    sb.append(&quot;,&#x27;price&#x27;: &#x27;&quot; + orderItem.getAveragePrice() + &quot;&#x27;&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 279 +                    sb.append(&quot;,&#x27;quantity&#x27;: &#x27;&quot; + orderItem.getQuantity() + &quot;&#x27;&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 280 +                    sb.append(&quot;});&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 281 +                }</span>
 282              }
 283          }
 284          return sb.toString();
 285      }
 286  
 287      /**
 288       * Returns the product option values separated by a space if they are
 289       * relevant for the item, or the product category if no options are available
 290       *
 291       * @return
 292       */
 293      protected String getVariation(OrderItem item) {
 294          if (MapUtils.isEmpty(item.getOrderItemAttributes())) {
 295              return item.getCategory() == null ? &quot;&quot; : item.getCategory().getName();
 296          }
 297  
 298          //use product options instead
 299          String result = &quot;&quot;;
 300          for (Map.Entry&lt;String, OrderItemAttribute&gt; entry : item.getOrderItemAttributes().entrySet()) {
 301              result += entry.getValue().getValue() + &quot; &quot;;
 302          }
 303  
 304          //the result has a space at the end, ensure that is stripped out
 305          return result.substring(0, result.length() - 1);
 306      }
 307  
 308      public String getMasterWebPropertyId() {
 309          return masterWebPropertyId;
 310      }
 311  
 312      public void setMasterWebPropertyId(String masterWebPropertyId) {
 313          this.masterWebPropertyId = masterWebPropertyId;
 314      }
 315  
 316      public String getAffiliation() {
 317          return BLCSystemProperty.resolveSystemProperty(&quot;googleAnalytics.affiliation&quot;);
 318      }
 319  
 320      public String getWebPropertyId() {
 321          return BLCSystemProperty.resolveSystemProperty(&quot;googleAnalytics.webPropertyId&quot;);
 322      }
 323  
 324      public boolean isIncludeLinkAttribution() {
 325          return BLCSystemProperty.resolveBooleanSystemProperty(&quot;googleAnalytics.enableLinkAttribution&quot;, true);
 326      }
 327  
 328      public boolean isIncludeDisplayAdvertising() {
 329          return BLCSystemProperty.resolveBooleanSystemProperty(&quot;googleAnalytics.enableDisplayAdvertising&quot;, false);
 330      }
 331  
 332  }</pre></td>
                            <td><pre>   1  /*
   2   * #%L
   3   * BroadleafCommerce Framework Web
   4   * %%
   5   * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6   * %%
   7   * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8   * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9   * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10   * the Broadleaf End User License Agreement (EULA), Version 1.1
  11   * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12   * shall apply.
  13   *
<abbr title="  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr>
  15   * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.
  16   * #L%
  17   */
  18  package org.broadleafcommerce.core.web.processor;
  19  
  20  import org.apache.commons.collections.MapUtils;
  21  import org.apache.commons.lang3.StringUtils;
  22  import org.apache.commons.logging.Log;
  23  import org.apache.commons.logging.LogFactory;
  24  import org.broadleafcommerce.common.util.BLCSystemProperty;
  25  import org.broadleafcommerce.common.web.BroadleafRequestContext;
  26  import org.broadleafcommerce.core.catalog.domain.Sku;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  27 +import org.broadleafcommerce.core.order.domain.DiscreteOrderItem;</span>
  28  import org.broadleafcommerce.core.order.domain.FulfillmentGroup;
  29  import org.broadleafcommerce.core.order.domain.FulfillmentGroupItem;
  30  import org.broadleafcommerce.core.order.domain.Order;
  31  import org.broadleafcommerce.core.order.domain.OrderItem;
  32  import org.broadleafcommerce.core.order.domain.OrderItemAttribute;
  33  import org.broadleafcommerce.core.order.domain.SkuAccessor;
  34  import org.broadleafcommerce.core.order.service.OrderService;
  35  import org.broadleafcommerce.presentation.condition.ConditionalOnTemplating;
  36  import org.broadleafcommerce.presentation.dialect.AbstractBroadleafTagReplacementProcessor;
  37  import org.broadleafcommerce.presentation.model.BroadleafTemplateContext;
  38  import org.broadleafcommerce.presentation.model.BroadleafTemplateElement;
  39  import org.broadleafcommerce.presentation.model.BroadleafTemplateModel;
  40  import org.broadleafcommerce.presentation.model.BroadleafTemplateNonVoidElement;
  41  import org.springframework.beans.factory.annotation.Value;
  42  import org.springframework.stereotype.Component;
  43  
  44  import java.util.HashMap;
  45  import java.util.Map;
  46  import java.util.Map.Entry;
  47  
  48  import javax.annotation.Resource;
  49  import javax.servlet.http.HttpServletRequest;
  50  
  51  /**
  52   * &lt;p&gt;
  53   * Takes advantage of the new-stype analytics.js from Google Analytics rather than the deprected ga.js. This also
<abbr title="  54   * supports a pre-processed &lt;b&gt;orderNumber&lt;/b&gt; attribute that can be null, suitable for things like the order confirmation">  54   * supports a pre-processed &lt;b&gt;orderNumber&lt;/b&gt; attribute that can be null, suitable for things like the order confðŸ”µ</abbr>
  55   * page to send e-commerce transactions. Example usage:
  56   *
  57   * &lt;pre&gt;
  58   * &amp;lt;google_universal_analytics ordernumber=&quot;${order?.orderNumber&quot; /&amp;gt;
  59   * &lt;/pre&gt;
  60   *
  61   * &lt;p&gt;
  62   * This processor also supports:
  63   * &lt;ul&gt;
<abbr title="  64   *  &lt;li&gt;Multiple trackers (extensible via {@link #getTrackers()} or by setting the {@code googleAnalytics.masterWebPropertyId}">  64   *  &lt;li&gt;Multiple trackers (extensible via {@link #getTrackers()} or by setting the {@code googleAnalytics.masterWeðŸ”µ</abbr>
  65   *      and {@code googleAnalytics.webPropertyId})&lt;/li&gt;
  66   *  &lt;li&gt;Affiliates for e-commerce ({@ googleAnalytics.affiliation property})&lt;/li&gt;
  67   *  &lt;li&gt;&lt;a href=&quot;https://support.google.com/analytics/answer/2558867?hl=en&amp;utm_id=ad&quot;&gt;Link attribution&lt;/a&gt;
  68   *      ({@code googleAnalytics.enableLinkAttribution} system property, default {@code true})&lt;/li&gt;
  69   *  &lt;li&gt;&lt;a href=&quot;https://support.google.com/analytics/answer/3450482&quot;&gt;Display Advertising&lt;/a&gt;
  70   *      ({@code googleAnalytics.enableDisplayAdvertising} system property, default {@code false})&lt;/li&gt;
  71   * &lt;/ul&gt;
  72   *
  73   * @param ordernumber the order number to look up for ecommerce tracking, such as on the confirmation page
  74   *
  75   * @author Phillip Verheyden (phillipuniverse)
  76   */
  77  @Component(&quot;blGoogleUniversalAnalyticsProcessor&quot;)
  78  @ConditionalOnTemplating
  79  public class GoogleUniversalAnalyticsProcessor extends AbstractBroadleafTagReplacementProcessor {
  80  
  81      private static final Log LOG = LogFactory.getLog(GoogleUniversalAnalyticsProcessor.class);
  82  
  83      /**
  84       * Global value, intentionally only retrieved as a file property NOT via the system properties service
  85       */
  86      @Value(&quot;${googleAnalytics.masterWebPropertyId}&quot;)
  87      protected String masterWebPropertyId;
  88  
  89      @Resource(name = &quot;blOrderService&quot;)
  90      protected OrderService orderService;
  91  
  92      /**
  93       * This will force the domain to 127.0.0.1 which is useful to determine if the Google Analytics tag is sending
  94       * a request to Google
  95       */
  96      @Value(&quot;${googleAnalytics.testLocal}&quot;)
  97      protected boolean testLocal = false;
  98  
  99      @Override
 100      public String getName() {
 101          return &quot;google_universal_analytics&quot;;
 102      }
 103  
 104      @Override
 105      public int getPrecedence() {
 106          return 0;
 107      }
 108  
 109      @Override
<abbr title=" 110      public BroadleafTemplateModel getReplacementModel(String tagName, Map&lt;String, String&gt; tagAttributes, BroadleafTemplateContext context) {"> 110      public BroadleafTemplateModel getReplacementModel(String tagName, Map&lt;String, String&gt; tagAttributes, BroadleafðŸ”µ</abbr>
 111          StringBuffer sb = new StringBuffer();
 112          Map&lt;String, String&gt; trackers = getTrackers();
 113          if (MapUtils.isNotEmpty(trackers)) {
 114              sb.append(&quot;(function(i,s,o,g,r,a,m){i[&#x27;GoogleAnalyticsObject&#x27;]=r;i[r]=i[r]||function(){&quot;);
 115              sb.append(&quot;(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),&quot;);
 116              sb.append(&quot;m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)&quot;);
 117              sb.append(&quot;})(window,document,&#x27;script&#x27;,&#x27;//www.google-analytics.com/analytics.js&#x27;,&#x27;ga&#x27;);&quot;);
 118  
 119              String orderNumberExpression = tagAttributes.get(&quot;ordernumber&quot;);
 120              String orderNumber = null;
 121              if (orderNumberExpression != null) {
 122                  orderNumber = (String) context.parseExpression(orderNumberExpression);
 123              }
 124  
 125              Order order = null;
 126              if (orderNumber != null) {
 127                  order = orderService.findOrderByOrderNumber(orderNumber);
 128              }
 129  
 130              for (Entry&lt;String, String&gt; tracker : trackers.entrySet()) {
 131                  String trackerName = tracker.getKey();
 132                  String trackerPrefix = &quot;&quot;;
 133                  String id = tracker.getValue();
 134                  sb.append(&quot;ga(&#x27;create&#x27;, &#x27;&quot; + id + &quot;&#x27;, &#x27;auto&#x27;, {&quot;);
 135  
 136                  if (!&quot;webProperty&quot;.equals(trackerName)) {
 137                      trackerPrefix = trackerName + &quot;.&quot;;
 138                      sb.append(&quot;&#x27;name&#x27;: &#x27;&quot; + trackerName + &quot;&#x27;&quot;);
 139                      if (testLocal) {
 140                          sb.append(&quot;,&quot;);
 141                      }
 142                  }
 143                  if (testLocal) {
 144                      sb.append(&quot;&#x27;cookieDomain&#x27;: &#x27;none&#x27;&quot;);
 145                  }
 146                  sb.append(&quot;});&quot;);
 147  
 148                  if (&quot;webProperty&quot;.equals(trackerName)) {
<abbr title=" 149                      HttpServletRequest request = BroadleafRequestContext.getBroadleafRequestContext().getRequest();"> 149                      HttpServletRequest request = BroadleafRequestContext.getBroadleafRequestContext().getRequest()ðŸ”µ</abbr>
 150                      if (request != null) {
<abbr title=" 151                          Map&lt;String, String&gt; setValuesMap = (Map&lt;String, String&gt;) request.getAttribute(&quot;blGAValuesMap&quot;);"> 151                          Map&lt;String, String&gt; setValuesMap = (Map&lt;String, String&gt;) request.getAttribute(&quot;blGAValuesMðŸ”µ</abbr>
 152                          if (setValuesMap != null) {
 153                              for (Map.Entry&lt;String, String&gt; entry : setValuesMap.entrySet()) {
 154                                  sb.append(&quot;ga(&#x27;&quot; + trackerPrefix + &quot;set&#x27;,&quot;).append(entry.getKey()).append(&quot;,&quot;)
 155                                          .append(entry.getValue()).append(&quot;);&quot;);
 156                              }
 157                          }
 158                      }
 159                  }
 160  
 161                  sb.append(&quot;ga(&#x27;&quot; + trackerPrefix + &quot;send&#x27;, &#x27;pageview&#x27;);&quot;);
 162  
 163                  if (isIncludeLinkAttribution()) {
 164                      sb.append(getLinkAttributionJs(trackerPrefix));
 165                  }
 166                  if (isIncludeDisplayAdvertising()) {
 167                      sb.append(getDisplayAdvertisingJs(trackerPrefix));
 168                  }
 169  
 170                  if (order != null) {
 171                      sb.append(getTransactionJs(order, trackerPrefix));
 172                  }
 173              }
 174  
 175              // Add contentNode to the document
 176              BroadleafTemplateModel model = context.createModel();
 177              BroadleafTemplateNonVoidElement scriptTag = context.createNonVoidElement(&quot;script&quot;);
 178              BroadleafTemplateElement script = context.createTextElement(sb.toString());
 179              scriptTag.addChild(script);
 180              model.addElement(scriptTag);
 181              return model;
 182          } else {
<abbr title=" 183              LOG.warn(&quot;No trackers were found, not outputting Google Analytics script. Set the googleAnalytics.webPropertyId&quot;"> 183              LOG.warn(&quot;No trackers were found, not outputting Google Analytics script. Set the googleAnalytics.webPðŸ”µ</abbr>
<abbr title=" 184                      + &quot; and/or the googleAnalytics.masterWebPropertyId system properties to output Google Analytics&quot;);"> 184                      + &quot; and/or the googleAnalytics.masterWebPropertyId system properties to output Google AnalyticðŸ”µ</abbr>
 185          }
 186          return null;
 187      }
 188  
 189      /**
 190       * Grabs a map of trackers keyed by the tracker name with the analytics ID as the value
 191       */
 192      protected Map&lt;String, String&gt; getTrackers() {
 193          Map&lt;String, String&gt; trackers = new HashMap&lt;&gt;();
 194          if (shouldShowMasterTracker()) {
 195              trackers.put(&quot;master&quot;, getMasterWebPropertyId());
 196          }
 197          if (StringUtils.isNotBlank(getWebPropertyId())) {
 198              trackers.put(&quot;webProperty&quot;, getWebPropertyId());
 199          }
 200  
 201          return trackers;
 202      }
 203  
 204      protected boolean shouldShowMasterTracker() {
 205          String masterWebPropertyId = getMasterWebPropertyId();
 206          return (StringUtils.isNotBlank(masterWebPropertyId) &amp;&amp; (!&quot;UA-XXXXXXX-X&quot;.equals(masterWebPropertyId)));
 207      }
 208  
 209      /**
 210       * Builds the linke attribution Javascript
 211       * @param tracker the name of the tracker that is using the link attribution
 212       * @return
 213       */
 214      protected String getLinkAttributionJs(String trackerPrefix) {
 215          return &quot;ga(&#x27;&quot; + trackerPrefix + &quot;require&#x27;, &#x27;linkid&#x27;, &#x27;linkid.js&#x27;);&quot;;
 216      }
 217  
 218      /**
 219       * Builds the display advertising Javascript for the given tracker
 220       * @param tracker
 221       * @return
 222       */
 223      protected String getDisplayAdvertisingJs(String trackerPrefix) {
 224          return &quot;ga(&#x27;&quot; + trackerPrefix + &quot;require&#x27;, &#x27;displayfeatures&#x27;);&quot;;
 225      }
 226  
 227      /**
<abbr title=" 228       * Builds the transaction analytics for the given tracker name. Invokes {@link #getItemJs(Order, String) for each item"> 228       * Builds the transaction analytics for the given tracker name. Invokes {@link #getItemJs(Order, String) for eðŸ”µ</abbr>
 229       * in the given &lt;b&gt;order&lt;/b&gt;.
 230       */
 231      protected String getTransactionJs(Order order, String trackerPrefix) {
 232          StringBuffer sb = new StringBuffer();
 233          sb.append(&quot;ga(&#x27;&quot; + trackerPrefix + &quot;require&#x27;, &#x27;ecommerce&#x27;, &#x27;ecommerce.js&#x27;);&quot;);
 234  
 235          sb.append(&quot;ga(&#x27;&quot; + trackerPrefix + &quot;ecommerce:addTransaction&#x27;, {&quot;);
 236          sb.append(&quot;&#x27;id&#x27;: &#x27;&quot; + order.getOrderNumber() + &quot;&#x27;&quot;);
 237          if (StringUtils.isNotBlank(getAffiliation())) {
 238              sb.append(&quot;,&#x27;affiliation&#x27;: &#x27;&quot; + getAffiliation() + &quot;&#x27;&quot;);
 239          }
 240          sb.append(&quot;,&#x27;revenue&#x27;: &#x27;&quot; + order.getTotal() + &quot;&#x27;&quot;);
 241          sb.append(&quot;,&#x27;shipping&#x27;:&#x27;&quot; + order.getTotalShipping() + &quot;&#x27;&quot;);
 242          sb.append(&quot;,&#x27;tax&#x27;: &#x27;&quot; + order.getTotalTax() + &quot;&#x27;&quot;);
 243  
 244          if (order.getCurrency() != null) {
 245              sb.append(&quot;,&#x27;currency&#x27;: &#x27;&quot; + order.getCurrency().getCurrencyCode() + &quot;&#x27;&quot;);
 246          }
 247          sb.append(&quot;});&quot;);
 248  
 249          sb.append(getItemJs(order, trackerPrefix));
 250  
 251          sb.append(&quot;ga(&#x27;&quot; + trackerPrefix + &quot;ecommerce:send&#x27;);&quot;);
 252          return sb.toString();
 253      }
 254  
 255      protected String getItemJs(Order order, String trackerPrefix) {
 256          StringBuffer sb = new StringBuffer();
 257          for (FulfillmentGroup fulfillmentGroup : order.getFulfillmentGroups()) {
 258              for (FulfillmentGroupItem fulfillmentGroupItem : fulfillmentGroup.getFulfillmentGroupItems()) {
 259                  OrderItem orderItem = fulfillmentGroupItem.getOrderItem();
 260  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 261 -                Sku sku = ((SkuAccessor) orderItem).getSku();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 262 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 263 -                sb.append(&quot;ga(&#x27;&quot; + trackerPrefix + &quot;ecommerce:addItem&#x27;, {&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 264 -                sb.append(&quot;&#x27;id&#x27;: &#x27;&quot; + order.getOrderNumber() + &quot;&#x27;&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 265 -                sb.append(&quot;,&#x27;name&#x27;: &#x27;&quot; + sku.getName() + &quot;&#x27;&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 266 -                sb.append(&quot;,&#x27;sku&#x27;: &#x27;&quot; + sku.getId() + &quot;&#x27;&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 267 -                sb.append(&quot;,&#x27;category&#x27;: &#x27;&quot; + getVariation(orderItem) + &quot;&#x27;&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 268 -                sb.append(&quot;,&#x27;price&#x27;: &#x27;&quot; + orderItem.getAveragePrice() + &quot;&#x27;&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 269 -                sb.append(&quot;,&#x27;quantity&#x27;: &#x27;&quot; + orderItem.getQuantity() + &quot;&#x27;&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 270 -                sb.append(&quot;});&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 271 +                if (orderItem instanceof DiscreteOrderItem) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 272 +                    Sku sku = ((SkuAccessor) orderItem).getSku();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 273 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 274 +                    sb.append(&quot;ga(&#x27;&quot; + trackerPrefix + &quot;ecommerce:addItem&#x27;, {&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 275 +                    sb.append(&quot;&#x27;id&#x27;: &#x27;&quot; + order.getOrderNumber() + &quot;&#x27;&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 276 +                    sb.append(&quot;,&#x27;name&#x27;: &#x27;&quot; + sku.getName() + &quot;&#x27;&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 277 +                    sb.append(&quot;,&#x27;sku&#x27;: &#x27;&quot; + sku.getId() + &quot;&#x27;&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 278 +                    sb.append(&quot;,&#x27;category&#x27;: &#x27;&quot; + getVariation(orderItem) + &quot;&#x27;&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 279 +                    sb.append(&quot;,&#x27;price&#x27;: &#x27;&quot; + orderItem.getAveragePrice() + &quot;&#x27;&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 280 +                    sb.append(&quot;,&#x27;quantity&#x27;: &#x27;&quot; + orderItem.getQuantity() + &quot;&#x27;&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 281 +                    sb.append(&quot;});&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 282 +                }</span>
 283              }
 284          }
 285          return sb.toString();
 286      }
 287  
 288      /**
 289       * Returns the product option values separated by a space if they are
 290       * relevant for the item, or the product category if no options are available
 291       *
 292       * @return
 293       */
 294      protected String getVariation(OrderItem item) {
 295          if (MapUtils.isEmpty(item.getOrderItemAttributes())) {
 296              return item.getCategory() == null ? &quot;&quot; : item.getCategory().getName();
 297          }
 298  
 299          //use product options instead
 300          String result = &quot;&quot;;
 301          for (Map.Entry&lt;String, OrderItemAttribute&gt; entry : item.getOrderItemAttributes().entrySet()) {
 302              result += entry.getValue().getValue() + &quot; &quot;;
 303          }
 304  
 305          //the result has a space at the end, ensure that is stripped out
 306          return result.substring(0, result.length() - 1);
 307      }
 308  
 309      public String getMasterWebPropertyId() {
 310          return masterWebPropertyId;
 311      }
 312  
 313      public void setMasterWebPropertyId(String masterWebPropertyId) {
 314          this.masterWebPropertyId = masterWebPropertyId;
 315      }
 316  
 317      public String getAffiliation() {
 318          return BLCSystemProperty.resolveSystemProperty(&quot;googleAnalytics.affiliation&quot;);
 319      }
 320  
 321      public String getWebPropertyId() {
 322          return BLCSystemProperty.resolveSystemProperty(&quot;googleAnalytics.webPropertyId&quot;);
 323      }
 324  
 325      public boolean isIncludeLinkAttribution() {
 326          return BLCSystemProperty.resolveBooleanSystemProperty(&quot;googleAnalytics.enableLinkAttribution&quot;, true);
 327      }
 328  
 329      public boolean isIncludeDisplayAdvertising() {
 330          return BLCSystemProperty.resolveBooleanSystemProperty(&quot;googleAnalytics.enableDisplayAdvertising&quot;, false);
 331      }
 332  
 333  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            