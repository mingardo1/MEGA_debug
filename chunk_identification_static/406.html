<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>406</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    406
                    <a href="405.html">prev</a>
                    <a href="407.html">next</a>
                    <a href="406_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    DTStack/flinkStreamSQL_e408d12c730a7397701e361d52cac823c1694111_rdb/rdb-side/src/main/java/com/dtstack/flink/sql/side/rdb/async/RdbAsyncSideInfo.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;e408d12c730a7397701e361d52cac823c1694111:rdb/rdb-side/src/main/java/com/dtstack/flink/sql/side/rdb/async/RdbAsyncSideInfo.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;e408d12c730a7397701e361d52cac823c1694111^1:rdb/rdb-side/src/main/java/com/dtstack/flink/sql/side/rdb/async/RdbAsyncSideInfo.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;e408d12c730a7397701e361d52cac823c1694111^2:rdb/rdb-side/src/main/java/com/dtstack/flink/sql/side/rdb/async/RdbAsyncSideInfo.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;09a8d23c2b8c9e6955f6f68bed4a2fe16cc7fbd3:rdb/rdb-side/src/main/java/com/dtstack/flink/sql/side/rdb/async/RdbAsyncSideInfo.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[bj]], subset: [[bj]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 /*
   2  * Licensed to the Apache Software Foundation (ASF) under one
   3  * or more contributor license agreements.  See the NOTICE file
   4  * distributed with this work for additional information
   5  * regarding copyright ownership.  The ASF licenses this file
   6  * to you under the Apache License, Version 2.0 (the
   7  * &quot;License&quot;); you may not use this file except in compliance
   8  * with the License.  You may obtain a copy of the License at
   9  *
  10  *     http://www.apache.org/licenses/LICENSE-2.0
  11  *
  12  * Unless required by applicable law or agreed to in writing, software
  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15  * See the License for the specific language governing permissions and
  16  * limitations under the License.
  17  */
  18 
  19 package com.dtstack.flink.sql.side.rdb.async;
  20 
  21 import org.apache.flink.api.java.typeutils.RowTypeInfo;
  22 
  23 import com.dtstack.flink.sql.side.FieldInfo;
  24 import com.dtstack.flink.sql.side.JoinInfo;
  25 import com.dtstack.flink.sql.side.PredicateInfo;
  26 import com.dtstack.flink.sql.side.BaseSideInfo;
  27 import com.dtstack.flink.sql.side.AbstractSideTableInfo;
  28 import com.dtstack.flink.sql.side.rdb.table.RdbSideTableInfo;
  29 import com.dtstack.flink.sql.util.ParseUtils;
  30 import com.google.common.collect.Lists;
  31 import org.apache.calcite.sql.SqlBasicCall;
  32 import org.apache.calcite.sql.SqlIdentifier;
  33 import org.apache.calcite.sql.SqlKind;
  34 import org.apache.calcite.sql.SqlNode;
  35 import org.apache.commons.lang3.StringUtils;
  36 import org.slf4j.Logger;
  37 import org.slf4j.LoggerFactory;
  38 
  39 import java.util.Arrays;
  40 import java.util.List;
  41 import java.util.Map;
  42 import java.util.stream.Collectors;
  43 
  44 
  45 /**
  46  * Reason:
  47  * Date: 2018/11/26
  48  * Company: www.dtstack.com
  49  *
  50  * @author maqi
  51  */
  52 
  53 public class RdbAsyncSideInfo extends BaseSideInfo {
  54 
  55     private static final long serialVersionUID = 1942629132469918611L;
  56     private static final Logger LOG = LoggerFactory.getLogger(RdbAsyncSideInfo.class);
  57 
  58 
<abbr title="  59     public RdbAsyncSideInfo(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, AbstractSideTableInfo sideTableInfo) {">  59     public RdbAsyncSideInfo(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList,ðŸ”µ</abbr>
  60         super(rowTypeInfo, joinInfo, outFieldInfoList, sideTableInfo);
  61     }
  62 
  63     @Override
  64     public void buildEqualInfo(JoinInfo joinInfo, AbstractSideTableInfo sideTableInfo) {
  65         RdbSideTableInfo rdbSideTableInfo = (RdbSideTableInfo) sideTableInfo;
  66 
  67         String sideTableName = joinInfo.getSideTableName();
  68         SqlNode conditionNode = joinInfo.getCondition();
  69 
  70         List&lt;SqlNode&gt; sqlNodeList = Lists.newArrayList();
  71         List&lt;String&gt; sqlJoinCompareOperate= Lists.newArrayList();
  72 
  73         ParseUtils.parseAnd(conditionNode, sqlNodeList);
  74         ParseUtils.parseJoinCompareOperate(conditionNode, sqlJoinCompareOperate);
  75 
  76         for (SqlNode sqlNode : sqlNodeList) {
  77             dealOneEqualCon(sqlNode, sideTableName);
  78         }
  79 
<abbr title="  80         sqlCondition = getSelectFromStatement(getTableName(rdbSideTableInfo), Arrays.asList(StringUtils.split(sideSelectFields, &quot;,&quot;)),">  80         sqlCondition = getSelectFromStatement(getTableName(rdbSideTableInfo), Arrays.asList(StringUtils.sðŸ”µ</abbr>
  81                 equalFieldList, sqlJoinCompareOperate, sideTableInfo.getPredicateInfoes());
  82         LOG.info(&quot;----------dimension sql query-----------\n{}&quot;, sqlCondition);
  83     }
  84 
  85 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  86 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  87     @Override</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  88     public void dealOneEqualCon(SqlNode sqlNode, String sideTableName) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  89         if (!SqlKind.COMPARISON.contains(sqlNode.getKind())) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  90             throw new RuntimeException(&quot;not compare operator.&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  91         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  92 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  93         SqlIdentifier left = (SqlIdentifier) ((SqlBasicCall) sqlNode).getOperands()[0];</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  94         SqlIdentifier right = (SqlIdentifier) ((SqlBasicCall) sqlNode).getOperands()[1];</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  95 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  96         String leftTableName = left.getComponent(0).getSimple();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  97         String leftField = left.getComponent(1).getSimple();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  98 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  99         String rightTableName = right.getComponent(0).getSimple();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 100         String rightField = right.getComponent(1).getSimple();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 101 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 102         if (leftTableName.equalsIgnoreCase(sideTableName)) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 103             equalFieldList.add(leftField);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 104             int equalFieldIndex = -1;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 105             for (int i = 0; i &lt; getFieldNames().length; i++) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 106                 String fieldName = getFieldNames()[i];</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 107                 if (fieldName.equalsIgnoreCase(rightField)) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 108                     equalFieldIndex = i;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 109                 }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 110             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 111             if (equalFieldIndex == -1) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 112                 throw new RuntimeException(&quot;can&#x27;t deal equal field: &quot; + sqlNode);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 113             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 114 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 115             equalValIndex.add(equalFieldIndex);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 116 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 117         } else if (rightTableName.equalsIgnoreCase(sideTableName)) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 118 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 119             equalFieldList.add(rightField);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 120             int equalFieldIndex = -1;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 121             for (int i = 0; i &lt; getFieldNames().length; i++) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 122                 String fieldName = getFieldNames()[i];</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 123                 if (fieldName.equalsIgnoreCase(leftField)) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 124                     equalFieldIndex = i;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 125                 }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 126             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 127             if (equalFieldIndex == -1) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 128                 throw new RuntimeException(&quot;can&#x27;t deal equal field: &quot; + sqlNode.toString());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 129             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 130 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 131             equalValIndex.add(equalFieldIndex);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 132 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 133         } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 134             throw new RuntimeException(&quot;resolve equalFieldList error:&quot; + sqlNode.toString());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 135         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 136 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 137     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 138 </span>
 139 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 140 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 141     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 142     public void dealOneEqualCon(SqlNode sqlNode, String sideTableName) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 143         if (!SqlKind.COMPARISON.contains(sqlNode.getKind())) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 144             throw new RuntimeException(&quot;not compare operator.&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 145         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 146 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 147         SqlIdentifier left = (SqlIdentifier) ((SqlBasicCall) sqlNode).getOperands()[0];</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 148         SqlIdentifier right = (SqlIdentifier) ((SqlBasicCall) sqlNode).getOperands()[1];</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 149 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 150         String leftTableName = left.getComponent(0).getSimple();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 151         String leftField = left.getComponent(1).getSimple();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 152 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 153         String rightTableName = right.getComponent(0).getSimple();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 154         String rightField = right.getComponent(1).getSimple();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 155 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 156         if (leftTableName.equalsIgnoreCase(sideTableName)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 157             equalFieldList.add(leftField);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 158             int equalFieldIndex = -1;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 159             for (int i = 0; i &lt; rowTypeInfo.getFieldNames().length; i++) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 160                 String fieldName = rowTypeInfo.getFieldNames()[i];</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 161                 if (fieldName.equalsIgnoreCase(rightField)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 162                     equalFieldIndex = i;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 163                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 164             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 165             if (equalFieldIndex == -1) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 166                 throw new RuntimeException(&quot;can&#x27;t deal equal field: &quot; + sqlNode);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 167             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 168 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 169             equalValIndex.add(equalFieldIndex);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 170 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 171         } else if (rightTableName.equalsIgnoreCase(sideTableName)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 172 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 173             equalFieldList.add(rightField);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 174             int equalFieldIndex = -1;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 175             for (int i = 0; i &lt; rowTypeInfo.getFieldNames().length; i++) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 176                 String fieldName = rowTypeInfo.getFieldNames()[i];</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 177                 if (fieldName.equalsIgnoreCase(leftField)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 178                     equalFieldIndex = i;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 179                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 180             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 181             if (equalFieldIndex == -1) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 182                 throw new RuntimeException(&quot;can&#x27;t deal equal field: &quot; + sqlNode.toString());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 183             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 184 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 185             equalValIndex.add(equalFieldIndex);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 186 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 187         } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 188             throw new RuntimeException(&quot;resolve equalFieldList error:&quot; + sqlNode.toString());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 189         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 190 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 191     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 192 </span>
 193 =======
 194 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 195     public String getAdditionalWhereClause() {
 196         return &quot;&quot;;
 197     }
 198 
<abbr title=" 199     public String getSelectFromStatement(String tableName, List&lt;String&gt; selectFields, List&lt;String&gt; conditionFields, List&lt;String&gt; sqlJoinCompareOperate,"> 199     public String getSelectFromStatement(String tableName, List&lt;String&gt; selectFields, List&lt;String&gt; conditðŸ”µ</abbr>
 200                                          List&lt;PredicateInfo&gt; predicateInfoes) {
 201         String fromClause = selectFields.stream()
 202                 .map(this::quoteIdentifier)
 203                 .collect(Collectors.joining(&quot;, &quot;));
 204 
 205         String whereClause = conditionFields.stream()
<abbr title=" 206                 .map(f -&gt; quoteIdentifier(sideTableInfo.getPhysicalFields().getOrDefault(f, f)) + sqlJoinCompareOperate.get(conditionFields.indexOf(f)) + wrapperPlaceholder(f))"> 206                 .map(f -&gt; quoteIdentifier(sideTableInfo.getPhysicalFields().getOrDefault(f, f)) + sqlJoinðŸ”µ</abbr>
 207                 .collect(Collectors.joining(&quot; AND &quot;));
 208 
 209         String predicateClause = predicateInfoes.stream()
 210                 .map(this::buildFilterCondition)
 211                 .collect(Collectors.joining(&quot; AND &quot;));
 212 
<abbr title=" 213         String dimQuerySql = &quot;SELECT &quot; + fromClause + &quot; FROM &quot; + tableName + (conditionFields.size() &gt; 0 ? &quot; WHERE &quot; + whereClause : &quot;&quot;)"> 213         String dimQuerySql = &quot;SELECT &quot; + fromClause + &quot; FROM &quot; + tableName + (conditionFields.size() &gt; 0 ðŸ”µ</abbr>
<abbr title=" 214                 + (predicateInfoes.size() &gt; 0 ? &quot; AND &quot; + predicateClause : &quot;&quot;) + getAdditionalWhereClause();"> 214                 + (predicateInfoes.size() &gt; 0 ? &quot; AND &quot; + predicateClause : &quot;&quot;) + getAdditionalWhereClausðŸ”µ</abbr>
 215 
 216         return dimQuerySql;
 217     }
 218 
 219     public String wrapperPlaceholder(String fieldName) {
 220         return &quot; ? &quot;;
 221     }
 222 
 223     public String buildFilterCondition(PredicateInfo info) {
 224         switch (info.getOperatorKind()) {
 225             case &quot;IN&quot;:
 226             case &quot;NOT_IN&quot;:
<abbr title=" 227                 return quoteIdentifier(info.getFieldName()) + &quot; &quot; + info.getOperatorName() + &quot; ( &quot; + info.getCondition() + &quot; )&quot;;"> 227                 return quoteIdentifier(info.getFieldName()) + &quot; &quot; + info.getOperatorName() + &quot; ( &quot; + infoðŸ”µ</abbr>
 228             case &quot;NOT_EQUALS&quot;:
 229                 return quoteIdentifier(info.getFieldName()) + &quot; != &quot; + info.getCondition();
 230             case &quot;BETWEEN&quot;:
 231                 return quoteIdentifier(info.getFieldName()) + &quot; BETWEEN  &quot; + info.getCondition();
 232             case &quot;IS_NOT_NULL&quot;:
 233             case &quot;IS_NULL&quot;:
 234                 return quoteIdentifier(info.getFieldName()) + &quot; &quot; + info.getOperatorName();
 235             default:
<abbr title=" 236                 return quoteIdentifier(info.getFieldName()) + &quot; &quot; + info.getOperatorName() + &quot; &quot; + info.getCondition();"> 236                 return quoteIdentifier(info.getFieldName()) + &quot; &quot; + info.getOperatorName() + &quot; &quot; + info.gðŸ”µ</abbr>
 237         }
 238     }
 239 
 240     public String getTableName(RdbSideTableInfo rdbSideTableInfo) {
 241         return rdbSideTableInfo.getTableName();
 242     }
 243 
 244     public String quoteIdentifier(String identifier) {
 245         return &quot; &quot; + identifier + &quot; &quot;;
 246     }
 247 
 248 }</pre></td>
                            <td><pre>   1 /*
   2  * Licensed to the Apache Software Foundation (ASF) under one
   3  * or more contributor license agreements.  See the NOTICE file
   4  * distributed with this work for additional information
   5  * regarding copyright ownership.  The ASF licenses this file
   6  * to you under the Apache License, Version 2.0 (the
   7  * &quot;License&quot;); you may not use this file except in compliance
   8  * with the License.  You may obtain a copy of the License at
   9  *
  10  *     http://www.apache.org/licenses/LICENSE-2.0
  11  *
  12  * Unless required by applicable law or agreed to in writing, software
  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15  * See the License for the specific language governing permissions and
  16  * limitations under the License.
  17  */
  18 
  19 package com.dtstack.flink.sql.side.rdb.async;
  20 
  21 import org.apache.flink.api.java.typeutils.RowTypeInfo;
  22 
  23 import com.dtstack.flink.sql.side.FieldInfo;
  24 import com.dtstack.flink.sql.side.JoinInfo;
  25 import com.dtstack.flink.sql.side.PredicateInfo;
  26 import com.dtstack.flink.sql.side.BaseSideInfo;
  27 import com.dtstack.flink.sql.side.AbstractSideTableInfo;
  28 import com.dtstack.flink.sql.side.rdb.table.RdbSideTableInfo;
  29 import com.dtstack.flink.sql.util.ParseUtils;
  30 import com.google.common.collect.Lists;
  31 import org.apache.calcite.sql.SqlBasicCall;
  32 import org.apache.calcite.sql.SqlIdentifier;
  33 import org.apache.calcite.sql.SqlKind;
  34 import org.apache.calcite.sql.SqlNode;
  35 import org.apache.commons.lang3.StringUtils;
  36 import org.slf4j.Logger;
  37 import org.slf4j.LoggerFactory;
  38 
  39 import java.util.Arrays;
  40 import java.util.List;
  41 import java.util.Map;
  42 import java.util.stream.Collectors;
  43 
  44 
  45 /**
  46  * Reason:
  47  * Date: 2018/11/26
  48  * Company: www.dtstack.com
  49  *
  50  * @author maqi
  51  */
  52 
  53 public class RdbAsyncSideInfo extends BaseSideInfo {
  54 
  55     private static final long serialVersionUID = 1942629132469918611L;
  56     private static final Logger LOG = LoggerFactory.getLogger(RdbAsyncSideInfo.class);
  57 
  58 
<abbr title="  59     public RdbAsyncSideInfo(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, AbstractSideTableInfo sideTableInfo) {">  59     public RdbAsyncSideInfo(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList,ðŸ”µ</abbr>
  60         super(rowTypeInfo, joinInfo, outFieldInfoList, sideTableInfo);
  61     }
  62 
  63     @Override
  64     public void buildEqualInfo(JoinInfo joinInfo, AbstractSideTableInfo sideTableInfo) {
  65         RdbSideTableInfo rdbSideTableInfo = (RdbSideTableInfo) sideTableInfo;
  66 
  67         String sideTableName = joinInfo.getSideTableName();
  68         SqlNode conditionNode = joinInfo.getCondition();
  69 
  70         List&lt;SqlNode&gt; sqlNodeList = Lists.newArrayList();
  71         List&lt;String&gt; sqlJoinCompareOperate= Lists.newArrayList();
  72 
  73         ParseUtils.parseAnd(conditionNode, sqlNodeList);
  74         ParseUtils.parseJoinCompareOperate(conditionNode, sqlJoinCompareOperate);
  75 
  76         for (SqlNode sqlNode : sqlNodeList) {
  77             dealOneEqualCon(sqlNode, sideTableName);
  78         }
  79 
<abbr title="  80         sqlCondition = getSelectFromStatement(getTableName(rdbSideTableInfo), Arrays.asList(StringUtils.split(sideSelectFields, &quot;,&quot;)),">  80         sqlCondition = getSelectFromStatement(getTableName(rdbSideTableInfo), Arrays.asList(StringUtils.sðŸ”µ</abbr>
  81                 equalFieldList, sqlJoinCompareOperate, sideTableInfo.getPredicateInfoes());
  82         LOG.info(&quot;----------dimension sql query-----------\n{}&quot;, sqlCondition);
  83     }
  84 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  85 @Override</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  86     public void dealOneEqualCon(SqlNode sqlNode, String sideTableName) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  87         if (!SqlKind.COMPARISON.contains(sqlNode.getKind())) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  88             throw new RuntimeException(&quot;not compare operator.&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  89         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  90 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  91         SqlIdentifier left = (SqlIdentifier) ((SqlBasicCall) sqlNode).getOperands()[0];</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  92         SqlIdentifier right = (SqlIdentifier) ((SqlBasicCall) sqlNode).getOperands()[1];</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  93 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  94         String leftTableName = left.getComponent(0).getSimple();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  95         String leftField = left.getComponent(1).getSimple();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  96 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  97         String rightTableName = right.getComponent(0).getSimple();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  98         String rightField = right.getComponent(1).getSimple();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  99 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 100         if (leftTableName.equalsIgnoreCase(sideTableName)) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 101             equalFieldList.add(leftField);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 102             int equalFieldIndex = -1;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 103             for (int i = 0; i &lt; getFieldNames().length; i++) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 104                 String fieldName = getFieldNames()[i];</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 105                 if (fieldName.equalsIgnoreCase(rightField)) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 106                     equalFieldIndex = i;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 107                 }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 108             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 109             if (equalFieldIndex == -1) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 110                 throw new RuntimeException(&quot;can&#x27;t deal equal field: &quot; + sqlNode);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 111             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 112 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 113             equalValIndex.add(equalFieldIndex);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 114 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 115         } else if (rightTableName.equalsIgnoreCase(sideTableName)) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 116 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 117             equalFieldList.add(rightField);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 118             int equalFieldIndex = -1;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 119             for (int i = 0; i &lt; getFieldNames().length; i++) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 120                 String fieldName = getFieldNames()[i];</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 121                 if (fieldName.equalsIgnoreCase(leftField)) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 122                     equalFieldIndex = i;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 123                 }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 124             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 125             if (equalFieldIndex == -1) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 126                 throw new RuntimeException(&quot;can&#x27;t deal equal field: &quot; + sqlNode.toString());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 127             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 128 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 129             equalValIndex.add(equalFieldIndex);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 130 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 131         } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 132             throw new RuntimeException(&quot;resolve equalFieldList error:&quot; + sqlNode.toString());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 133         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 134 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 135     }</span>
 136 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 137 @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 138     public void dealOneEqualCon(SqlNode sqlNode, String sideTableName) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 139         if (!SqlKind.COMPARISON.contains(sqlNode.getKind())) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 140             throw new RuntimeException(&quot;not compare operator.&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 141         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 142 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 143         SqlIdentifier left = (SqlIdentifier) ((SqlBasicCall) sqlNode).getOperands()[0];</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 144         SqlIdentifier right = (SqlIdentifier) ((SqlBasicCall) sqlNode).getOperands()[1];</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 145 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 146         String leftTableName = left.getComponent(0).getSimple();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 147         String leftField = left.getComponent(1).getSimple();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 148 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 149         String rightTableName = right.getComponent(0).getSimple();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 150         String rightField = right.getComponent(1).getSimple();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 151 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 152         if (leftTableName.equalsIgnoreCase(sideTableName)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 153             equalFieldList.add(leftField);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 154             int equalFieldIndex = -1;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 155             for (int i = 0; i &lt; rowTypeInfo.getFieldNames().length; i++) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 156                 String fieldName = rowTypeInfo.getFieldNames()[i];</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 157                 if (fieldName.equalsIgnoreCase(rightField)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 158                     equalFieldIndex = i;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 159                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 160             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 161             if (equalFieldIndex == -1) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 162                 throw new RuntimeException(&quot;can&#x27;t deal equal field: &quot; + sqlNode);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 163             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 164 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 165             equalValIndex.add(equalFieldIndex);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 166 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 167         } else if (rightTableName.equalsIgnoreCase(sideTableName)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 168 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 169             equalFieldList.add(rightField);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 170             int equalFieldIndex = -1;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 171             for (int i = 0; i &lt; rowTypeInfo.getFieldNames().length; i++) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 172                 String fieldName = rowTypeInfo.getFieldNames()[i];</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 173                 if (fieldName.equalsIgnoreCase(leftField)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 174                     equalFieldIndex = i;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 175                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 176             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 177             if (equalFieldIndex == -1) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 178                 throw new RuntimeException(&quot;can&#x27;t deal equal field: &quot; + sqlNode.toString());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 179             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 180 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 181             equalValIndex.add(equalFieldIndex);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 182 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 183         } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 184             throw new RuntimeException(&quot;resolve equalFieldList error:&quot; + sqlNode.toString());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 185         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 186 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 187     }</span>
 188 =======
 189 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 190 
 191 
 192     public String getAdditionalWhereClause() {
 193         return &quot;&quot;;
 194     }
 195 
<abbr title=" 196     public String getSelectFromStatement(String tableName, List&lt;String&gt; selectFields, List&lt;String&gt; conditionFields, List&lt;String&gt; sqlJoinCompareOperate,"> 196     public String getSelectFromStatement(String tableName, List&lt;String&gt; selectFields, List&lt;String&gt; conditðŸ”µ</abbr>
 197                                          List&lt;PredicateInfo&gt; predicateInfoes) {
 198         String fromClause = selectFields.stream()
 199                 .map(this::quoteIdentifier)
 200                 .collect(Collectors.joining(&quot;, &quot;));
 201 
 202         String whereClause = conditionFields.stream()
<abbr title=" 203                 .map(f -&gt; quoteIdentifier(sideTableInfo.getPhysicalFields().getOrDefault(f, f)) + sqlJoinCompareOperate.get(conditionFields.indexOf(f)) + wrapperPlaceholder(f))"> 203                 .map(f -&gt; quoteIdentifier(sideTableInfo.getPhysicalFields().getOrDefault(f, f)) + sqlJoinðŸ”µ</abbr>
 204                 .collect(Collectors.joining(&quot; AND &quot;));
 205 
 206         String predicateClause = predicateInfoes.stream()
 207                 .map(this::buildFilterCondition)
 208                 .collect(Collectors.joining(&quot; AND &quot;));
 209 
<abbr title=" 210         String dimQuerySql = &quot;SELECT &quot; + fromClause + &quot; FROM &quot; + tableName + (conditionFields.size() &gt; 0 ? &quot; WHERE &quot; + whereClause : &quot;&quot;)"> 210         String dimQuerySql = &quot;SELECT &quot; + fromClause + &quot; FROM &quot; + tableName + (conditionFields.size() &gt; 0 ðŸ”µ</abbr>
<abbr title=" 211                 + (predicateInfoes.size() &gt; 0 ? &quot; AND &quot; + predicateClause : &quot;&quot;) + getAdditionalWhereClause();"> 211                 + (predicateInfoes.size() &gt; 0 ? &quot; AND &quot; + predicateClause : &quot;&quot;) + getAdditionalWhereClausðŸ”µ</abbr>
 212 
 213         return dimQuerySql;
 214     }
 215 
 216     public String wrapperPlaceholder(String fieldName) {
 217         return &quot; ? &quot;;
 218     }
 219 
 220     public String buildFilterCondition(PredicateInfo info) {
 221         switch (info.getOperatorKind()) {
 222             case &quot;IN&quot;:
 223             case &quot;NOT_IN&quot;:
<abbr title=" 224                 return quoteIdentifier(info.getFieldName()) + &quot; &quot; + info.getOperatorName() + &quot; ( &quot; + info.getCondition() + &quot; )&quot;;"> 224                 return quoteIdentifier(info.getFieldName()) + &quot; &quot; + info.getOperatorName() + &quot; ( &quot; + infoðŸ”µ</abbr>
 225             case &quot;NOT_EQUALS&quot;:
 226                 return quoteIdentifier(info.getFieldName()) + &quot; != &quot; + info.getCondition();
 227             case &quot;BETWEEN&quot;:
 228                 return quoteIdentifier(info.getFieldName()) + &quot; BETWEEN  &quot; + info.getCondition();
 229             case &quot;IS_NOT_NULL&quot;:
 230             case &quot;IS_NULL&quot;:
 231                 return quoteIdentifier(info.getFieldName()) + &quot; &quot; + info.getOperatorName();
 232             default:
<abbr title=" 233                 return quoteIdentifier(info.getFieldName()) + &quot; &quot; + info.getOperatorName() + &quot; &quot; + info.getCondition();"> 233                 return quoteIdentifier(info.getFieldName()) + &quot; &quot; + info.getOperatorName() + &quot; &quot; + info.gðŸ”µ</abbr>
 234         }
 235     }
 236 
 237     public String getTableName(RdbSideTableInfo rdbSideTableInfo) {
 238         return rdbSideTableInfo.getTableName();
 239     }
 240 
 241     public String quoteIdentifier(String identifier) {
 242         return &quot; &quot; + identifier + &quot; &quot;;
 243     }
 244 
 245 }
 
 </pre></td>
                            <td><pre>   1 /*
   2  * Licensed to the Apache Software Foundation (ASF) under one
   3  * or more contributor license agreements.  See the NOTICE file
   4  * distributed with this work for additional information
   5  * regarding copyright ownership.  The ASF licenses this file
   6  * to you under the Apache License, Version 2.0 (the
   7  * &quot;License&quot;); you may not use this file except in compliance
   8  * with the License.  You may obtain a copy of the License at
   9  *
  10  *     http://www.apache.org/licenses/LICENSE-2.0
  11  *
  12  * Unless required by applicable law or agreed to in writing, software
  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15  * See the License for the specific language governing permissions and
  16  * limitations under the License.
  17  */
  18 package com.dtstack.flink.sql.side.rdb.async;
  19 
  20 import com.dtstack.flink.sql.side.AbstractSideTableInfo;
  21 import com.dtstack.flink.sql.side.BaseSideInfo;
  22 import com.dtstack.flink.sql.side.FieldInfo;
  23 import com.dtstack.flink.sql.side.JoinInfo;
  24 import com.dtstack.flink.sql.side.PredicateInfo;
  25 import com.dtstack.flink.sql.side.rdb.table.RdbSideTableInfo;
  26 import com.dtstack.flink.sql.util.ParseUtils;
  27 import com.google.common.collect.Lists;
  28 import java.util.Arrays;
  29 import java.util.List;
  30 import java.util.Map;
  31 import java.util.stream.Collectors;
  32 import org.apache.calcite.sql.SqlBasicCall;
  33 import org.apache.calcite.sql.SqlIdentifier;
  34 import org.apache.calcite.sql.SqlKind;
  35 import org.apache.calcite.sql.SqlNode;
  36 import org.apache.commons.lang3.StringUtils;
  37 import org.apache.flink.api.java.typeutils.RowTypeInfo;
  38 import org.slf4j.Logger;
  39 import org.slf4j.LoggerFactory;
  40 
  41 
  42 /**
  43  * Reason:
  44  * Date: 2018/11/26
  45  * Company: www.dtstack.com
  46  *
  47  * @author maqi
  48  */
  49 public class RdbAsyncSideInfo extends BaseSideInfo {
  50     private static final long serialVersionUID = 1942629132469918611L;
  51 
  52     private static final Logger LOG = LoggerFactory.getLogger(RdbAsyncSideInfo.class);
  53 
<abbr title="  54     public RdbAsyncSideInfo(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, AbstractSideTableInfo sideTableInfo) {">  54     public RdbAsyncSideInfo(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList,ðŸ”µ</abbr>
  55         super(rowTypeInfo, joinInfo, outFieldInfoList, sideTableInfo);
  56     }
  57 
  58     @Override
  59     public void buildEqualInfo(JoinInfo joinInfo, AbstractSideTableInfo sideTableInfo) {
  60         RdbSideTableInfo rdbSideTableInfo = ((RdbSideTableInfo) (sideTableInfo));
  61         String sideTableName = joinInfo.getSideTableName();
  62         SqlNode conditionNode = joinInfo.getCondition();
  63         List&lt;SqlNode&gt; sqlNodeList = Lists.newArrayList();
  64         List&lt;String&gt; sqlJoinCompareOperate = Lists.newArrayList();
  65         ParseUtils.parseAnd(conditionNode, sqlNodeList);
  66         ParseUtils.parseJoinCompareOperate(conditionNode, sqlJoinCompareOperate);
  67         for (SqlNode sqlNode : sqlNodeList) {
  68             dealOneEqualCon(sqlNode, sideTableName);
  69         }
<abbr title="  70         sqlCondition = getSelectFromStatement(getTableName(rdbSideTableInfo), Arrays.asList(StringUtils.split(sideSelectFields, &quot;,&quot;)), equalFieldList, sqlJoinCompareOperate, sideTableInfo.getPredicateInfoes());">  70         sqlCondition = getSelectFromStatement(getTableName(rdbSideTableInfo), Arrays.asList(StringUtils.sðŸ”µ</abbr>
  71         LOG.info(&quot;----------dimension sql query-----------\n{}&quot;, sqlCondition);
  72     }
  73 
  74     public String getAdditionalWhereClause() {
  75         return &quot;&quot;;
  76     }
  77 
<abbr title="  78     public String getSelectFromStatement(String tableName, List&lt;String&gt; selectFields, List&lt;String&gt; conditionFields, List&lt;String&gt; sqlJoinCompareOperate,">  78     public String getSelectFromStatement(String tableName, List&lt;String&gt; selectFields, List&lt;String&gt; conditðŸ”µ</abbr>
  79                                          List&lt;PredicateInfo&gt; predicateInfoes) {
  80         String fromClause = selectFields.stream()
  81                 .map(this::quoteIdentifier)
  82                 .collect(Collectors.joining(&quot;, &quot;));
  83 
  84         String whereClause = conditionFields.stream()
<abbr title="  85                 .map(f -&gt; quoteIdentifier(sideTableInfo.getPhysicalFields().getOrDefault(f, f)) + sqlJoinCompareOperate.get(conditionFields.indexOf(f)) + wrapperPlaceholder(f))">  85                 .map(f -&gt; quoteIdentifier(sideTableInfo.getPhysicalFields().getOrDefault(f, f)) + sqlJoinðŸ”µ</abbr>
  86                 .collect(Collectors.joining(&quot; AND &quot;));
  87 
  88         String predicateClause = predicateInfoes.stream()
  89                 .map(this::buildFilterCondition)
  90                 .collect(Collectors.joining(&quot; AND &quot;));
  91 
<abbr title="  92         String dimQuerySql = &quot;SELECT &quot; + fromClause + &quot; FROM &quot; + tableName + (conditionFields.size() &gt; 0 ? &quot; WHERE &quot; + whereClause : &quot;&quot;)">  92         String dimQuerySql = &quot;SELECT &quot; + fromClause + &quot; FROM &quot; + tableName + (conditionFields.size() &gt; 0 ðŸ”µ</abbr>
<abbr title="  93                 + (predicateInfoes.size() &gt; 0 ? &quot; AND &quot; + predicateClause : &quot;&quot;) + getAdditionalWhereClause();">  93                 + (predicateInfoes.size() &gt; 0 ? &quot; AND &quot; + predicateClause : &quot;&quot;) + getAdditionalWhereClausðŸ”µ</abbr>
  94 
  95         return dimQuerySql;
  96     }
  97 
  98     public String wrapperPlaceholder(String fieldName) {
  99         return &quot; ? &quot;;
 100     }
 101 
 102     public String buildFilterCondition(PredicateInfo info) {
 103         switch (info.getOperatorKind()) {
 104             case &quot;IN&quot;:
 105             case &quot;NOT_IN&quot;:
<abbr title=" 106                 return quoteIdentifier(info.getFieldName()) + &quot; &quot; + info.getOperatorName() + &quot; ( &quot; + info.getCondition() + &quot; )&quot;;"> 106                 return quoteIdentifier(info.getFieldName()) + &quot; &quot; + info.getOperatorName() + &quot; ( &quot; + infoðŸ”µ</abbr>
 107             case &quot;NOT_EQUALS&quot;:
 108                 return quoteIdentifier(info.getFieldName()) + &quot; != &quot; + info.getCondition();
 109             case &quot;BETWEEN&quot;:
 110                 return quoteIdentifier(info.getFieldName()) + &quot; BETWEEN  &quot; + info.getCondition();
 111             case &quot;IS_NOT_NULL&quot;:
 112             case &quot;IS_NULL&quot;:
 113                 return quoteIdentifier(info.getFieldName()) + &quot; &quot; + info.getOperatorName();
 114             default:
<abbr title=" 115                 return quoteIdentifier(info.getFieldName()) + &quot; &quot; + info.getOperatorName() + &quot; &quot; + info.getCondition();"> 115                 return quoteIdentifier(info.getFieldName()) + &quot; &quot; + info.getOperatorName() + &quot; &quot; + info.gðŸ”µ</abbr>
 116         }
 117     }
 118 
 119     public String getTableName(RdbSideTableInfo rdbSideTableInfo) {
 120         return rdbSideTableInfo.getTableName();
 121     }
 122 
 123     public String quoteIdentifier(String identifier) {
 124         return &quot; &quot; + identifier + &quot; &quot;;
 125     }
 126 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  /*
   2   * Licensed to the Apache Software Foundation (ASF) under one
   3   * or more contributor license agreements.  See the NOTICE file
   4   * distributed with this work for additional information
   5   * regarding copyright ownership.  The ASF licenses this file
   6   * to you under the Apache License, Version 2.0 (the
   7   * &quot;License&quot;); you may not use this file except in compliance
   8   * with the License.  You may obtain a copy of the License at
   9   *
  10   *     http://www.apache.org/licenses/LICENSE-2.0
  11   *
  12   * Unless required by applicable law or agreed to in writing, software
  13   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15   * See the License for the specific language governing permissions and
  16   * limitations under the License.
  17   */
  18  
  19  package com.dtstack.flink.sql.side.rdb.async;
  20  
  21  import org.apache.flink.api.java.typeutils.RowTypeInfo;
  22  
  23  import com.dtstack.flink.sql.side.FieldInfo;
  24  import com.dtstack.flink.sql.side.JoinInfo;
  25  import com.dtstack.flink.sql.side.PredicateInfo;
  26  import com.dtstack.flink.sql.side.BaseSideInfo;
  27  import com.dtstack.flink.sql.side.AbstractSideTableInfo;
  28  import com.dtstack.flink.sql.side.rdb.table.RdbSideTableInfo;
  29  import com.dtstack.flink.sql.util.ParseUtils;
  30  import com.google.common.collect.Lists;
  31  import org.apache.calcite.sql.SqlBasicCall;
  32  import org.apache.calcite.sql.SqlIdentifier;
  33  import org.apache.calcite.sql.SqlKind;
  34  import org.apache.calcite.sql.SqlNode;
  35  import org.apache.commons.lang3.StringUtils;
  36  import org.slf4j.Logger;
  37  import org.slf4j.LoggerFactory;
  38  
  39  import java.util.Arrays;
  40  import java.util.List;
  41  import java.util.Map;
  42  import java.util.stream.Collectors;
  43  
  44  
  45  /**
  46   * Reason:
  47   * Date: 2018/11/26
  48   * Company: www.dtstack.com
  49   *
  50   * @author maqi
  51   */
  52  
  53  public class RdbAsyncSideInfo extends BaseSideInfo {
  54  
  55      private static final long serialVersionUID = 1942629132469918611L;
  56      private static final Logger LOG = LoggerFactory.getLogger(RdbAsyncSideInfo.class);
  57  
  58  
<abbr title="  59      public RdbAsyncSideInfo(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, AbstractSideTableInfo sideTableInfo) {">  59      public RdbAsyncSideInfo(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, AbstractðŸ”µ</abbr>
  60          super(rowTypeInfo, joinInfo, outFieldInfoList, sideTableInfo);
  61      }
  62  
  63      @Override
  64      public void buildEqualInfo(JoinInfo joinInfo, AbstractSideTableInfo sideTableInfo) {
  65          RdbSideTableInfo rdbSideTableInfo = (RdbSideTableInfo) sideTableInfo;
  66  
  67          String sideTableName = joinInfo.getSideTableName();
  68          SqlNode conditionNode = joinInfo.getCondition();
  69  
  70          List&lt;SqlNode&gt; sqlNodeList = Lists.newArrayList();
  71          List&lt;String&gt; sqlJoinCompareOperate= Lists.newArrayList();
  72  
  73          ParseUtils.parseAnd(conditionNode, sqlNodeList);
  74          ParseUtils.parseJoinCompareOperate(conditionNode, sqlJoinCompareOperate);
  75  
  76          for (SqlNode sqlNode : sqlNodeList) {
  77              dealOneEqualCon(sqlNode, sideTableName);
  78          }
  79  
<abbr title="  80          sqlCondition = getSelectFromStatement(getTableName(rdbSideTableInfo), Arrays.asList(StringUtils.split(sideSelectFields, &quot;,&quot;)),">  80          sqlCondition = getSelectFromStatement(getTableName(rdbSideTableInfo), Arrays.asList(StringUtils.split(sideðŸ”µ</abbr>
  81                  equalFieldList, sqlJoinCompareOperate, sideTableInfo.getPredicateInfoes());
  82          LOG.info(&quot;----------dimension sql query-----------\n{}&quot;, sqlCondition);
  83      }
  84  
  85  
  86      @Override
  87      public void dealOneEqualCon(SqlNode sqlNode, String sideTableName) {
  88          if (!SqlKind.COMPARISON.contains(sqlNode.getKind())) {
  89              throw new RuntimeException(&quot;not compare operator.&quot;);
  90          }
  91  
  92          SqlIdentifier left = (SqlIdentifier) ((SqlBasicCall) sqlNode).getOperands()[0];
  93          SqlIdentifier right = (SqlIdentifier) ((SqlBasicCall) sqlNode).getOperands()[1];
  94  
  95          String leftTableName = left.getComponent(0).getSimple();
  96          String leftField = left.getComponent(1).getSimple();
  97  
  98          String rightTableName = right.getComponent(0).getSimple();
  99          String rightField = right.getComponent(1).getSimple();
 100  
 101          if (leftTableName.equalsIgnoreCase(sideTableName)) {
 102              equalFieldList.add(leftField);
 103              int equalFieldIndex = -1;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 104 -            for (int i = 0; i &lt; rowTypeInfo.getFieldNames().length; i++) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 105 -                String fieldName = rowTypeInfo.getFieldNames()[i];</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 106 +            for (int i = 0; i &lt; getFieldNames().length; i++) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 107 +                String fieldName = getFieldNames()[i];</span>
 108                  if (fieldName.equalsIgnoreCase(rightField)) {
 109                      equalFieldIndex = i;
 110                  }
 111              }
 112              if (equalFieldIndex == -1) {
 113                  throw new RuntimeException(&quot;can&#x27;t deal equal field: &quot; + sqlNode);
 114              }
 115  
 116              equalValIndex.add(equalFieldIndex);
 117  
 118          } else if (rightTableName.equalsIgnoreCase(sideTableName)) {
 119  
 120              equalFieldList.add(rightField);
 121              int equalFieldIndex = -1;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 122 -            for (int i = 0; i &lt; rowTypeInfo.getFieldNames().length; i++) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 123 -                String fieldName = rowTypeInfo.getFieldNames()[i];</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 124 +            for (int i = 0; i &lt; getFieldNames().length; i++) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 125 +                String fieldName = getFieldNames()[i];</span>
 126                  if (fieldName.equalsIgnoreCase(leftField)) {
 127                      equalFieldIndex = i;
 128                  }
 129              }
 130              if (equalFieldIndex == -1) {
 131                  throw new RuntimeException(&quot;can&#x27;t deal equal field: &quot; + sqlNode.toString());
 132              }
 133  
 134              equalValIndex.add(equalFieldIndex);
 135  
 136          } else {
 137              throw new RuntimeException(&quot;resolve equalFieldList error:&quot; + sqlNode.toString());
 138          }
 139  
 140      }
 141  
 142      public String getAdditionalWhereClause() {
 143          return &quot;&quot;;
 144      }
 145  
 146  
<abbr title=" 147      public String getSelectFromStatement(String tableName, List&lt;String&gt; selectFields, List&lt;String&gt; conditionFields, List&lt;String&gt; sqlJoinCompareOperate,"> 147      public String getSelectFromStatement(String tableName, List&lt;String&gt; selectFields, List&lt;String&gt; conditionFieldsðŸ”µ</abbr>
 148                                           List&lt;PredicateInfo&gt; predicateInfoes) {
 149          String fromClause = selectFields.stream()
 150                  .map(this::quoteIdentifier)
 151                  .collect(Collectors.joining(&quot;, &quot;));
 152  
 153          String whereClause = conditionFields.stream()
<abbr title=" 154                  .map(f -&gt; quoteIdentifier(sideTableInfo.getPhysicalFields().getOrDefault(f, f)) + sqlJoinCompareOperate.get(conditionFields.indexOf(f)) + wrapperPlaceholder(f))"> 154                  .map(f -&gt; quoteIdentifier(sideTableInfo.getPhysicalFields().getOrDefault(f, f)) + sqlJoinCompareOpðŸ”µ</abbr>
 155                  .collect(Collectors.joining(&quot; AND &quot;));
 156  
 157          String predicateClause = predicateInfoes.stream()
 158                  .map(this::buildFilterCondition)
 159                  .collect(Collectors.joining(&quot; AND &quot;));
 160  
<abbr title=" 161          String dimQuerySql = &quot;SELECT &quot; + fromClause + &quot; FROM &quot; + tableName + (conditionFields.size() &gt; 0 ? &quot; WHERE &quot; + whereClause : &quot;&quot;)"> 161          String dimQuerySql = &quot;SELECT &quot; + fromClause + &quot; FROM &quot; + tableName + (conditionFields.size() &gt; 0 ? &quot; WHEREðŸ”µ</abbr>
 162                  + (predicateInfoes.size() &gt; 0 ? &quot; AND &quot; + predicateClause : &quot;&quot;) + getAdditionalWhereClause();
 163  
 164          return dimQuerySql;
 165      }
 166  
 167      public String wrapperPlaceholder(String fieldName) {
 168          return &quot; ? &quot;;
 169      }
 170  
 171      public String buildFilterCondition(PredicateInfo info) {
 172          switch (info.getOperatorKind()) {
 173              case &quot;IN&quot;:
 174              case &quot;NOT_IN&quot;:
<abbr title=" 175                  return quoteIdentifier(info.getFieldName()) + &quot; &quot; + info.getOperatorName() + &quot; ( &quot; + info.getCondition() + &quot; )&quot;;"> 175                  return quoteIdentifier(info.getFieldName()) + &quot; &quot; + info.getOperatorName() + &quot; ( &quot; + info.getCondiðŸ”µ</abbr>
 176              case &quot;NOT_EQUALS&quot;:
 177                  return quoteIdentifier(info.getFieldName()) + &quot; != &quot; + info.getCondition();
 178              case &quot;BETWEEN&quot;:
 179                  return quoteIdentifier(info.getFieldName()) + &quot; BETWEEN  &quot; + info.getCondition();
 180              case &quot;IS_NOT_NULL&quot;:
 181              case &quot;IS_NULL&quot;:
 182                  return quoteIdentifier(info.getFieldName()) + &quot; &quot; + info.getOperatorName();
 183              default:
<abbr title=" 184                  return quoteIdentifier(info.getFieldName()) + &quot; &quot; + info.getOperatorName() + &quot; &quot; + info.getCondition();"> 184                  return quoteIdentifier(info.getFieldName()) + &quot; &quot; + info.getOperatorName() + &quot; &quot; + info.getConditiðŸ”µ</abbr>
 185          }
 186      }
 187  
 188      public String getTableName(RdbSideTableInfo rdbSideTableInfo) {
 189          return rdbSideTableInfo.getTableName();
 190      }
 191  
 192      public String quoteIdentifier(String identifier) {
 193          return &quot; &quot; + identifier + &quot; &quot;;
 194      }
 195  
 196  }</pre></td>
                            <td><pre>   1  /*
   2   * Licensed to the Apache Software Foundation (ASF) under one
   3   * or more contributor license agreements.  See the NOTICE file
   4   * distributed with this work for additional information
   5   * regarding copyright ownership.  The ASF licenses this file
   6   * to you under the Apache License, Version 2.0 (the
   7   * &quot;License&quot;); you may not use this file except in compliance
   8   * with the License.  You may obtain a copy of the License at
   9   *
  10   *     http://www.apache.org/licenses/LICENSE-2.0
  11   *
  12   * Unless required by applicable law or agreed to in writing, software
  13   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15   * See the License for the specific language governing permissions and
  16   * limitations under the License.
  17   */
  18  
  19  package com.dtstack.flink.sql.side.rdb.async;
  20  
  21  import org.apache.flink.api.java.typeutils.RowTypeInfo;
  22  
  23  import com.dtstack.flink.sql.side.FieldInfo;
  24  import com.dtstack.flink.sql.side.JoinInfo;
  25  import com.dtstack.flink.sql.side.PredicateInfo;
  26  import com.dtstack.flink.sql.side.BaseSideInfo;
  27  import com.dtstack.flink.sql.side.AbstractSideTableInfo;
  28  import com.dtstack.flink.sql.side.rdb.table.RdbSideTableInfo;
  29  import com.dtstack.flink.sql.util.ParseUtils;
  30  import com.google.common.collect.Lists;
  31  import org.apache.calcite.sql.SqlBasicCall;
  32  import org.apache.calcite.sql.SqlIdentifier;
  33  import org.apache.calcite.sql.SqlKind;
  34  import org.apache.calcite.sql.SqlNode;
  35  import org.apache.commons.lang3.StringUtils;
  36  import org.slf4j.Logger;
  37  import org.slf4j.LoggerFactory;
  38  
  39  import java.util.Arrays;
  40  import java.util.List;
  41  import java.util.Map;
  42  import java.util.stream.Collectors;
  43  
  44  
  45  /**
  46   * Reason:
  47   * Date: 2018/11/26
  48   * Company: www.dtstack.com
  49   *
  50   * @author maqi
  51   */
  52  
  53  public class RdbAsyncSideInfo extends BaseSideInfo {
  54  
  55      private static final long serialVersionUID = 1942629132469918611L;
  56      private static final Logger LOG = LoggerFactory.getLogger(RdbAsyncSideInfo.class);
  57  
  58  
<abbr title="  59      public RdbAsyncSideInfo(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, AbstractSideTableInfo sideTableInfo) {">  59      public RdbAsyncSideInfo(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, AbstractðŸ”µ</abbr>
  60          super(rowTypeInfo, joinInfo, outFieldInfoList, sideTableInfo);
  61      }
  62  
  63      @Override
  64      public void buildEqualInfo(JoinInfo joinInfo, AbstractSideTableInfo sideTableInfo) {
  65          RdbSideTableInfo rdbSideTableInfo = (RdbSideTableInfo) sideTableInfo;
  66  
  67          String sideTableName = joinInfo.getSideTableName();
  68          SqlNode conditionNode = joinInfo.getCondition();
  69  
  70          List&lt;SqlNode&gt; sqlNodeList = Lists.newArrayList();
  71          List&lt;String&gt; sqlJoinCompareOperate= Lists.newArrayList();
  72  
  73          ParseUtils.parseAnd(conditionNode, sqlNodeList);
  74          ParseUtils.parseJoinCompareOperate(conditionNode, sqlJoinCompareOperate);
  75  
  76          for (SqlNode sqlNode : sqlNodeList) {
  77              dealOneEqualCon(sqlNode, sideTableName);
  78          }
  79  
<abbr title="  80          sqlCondition = getSelectFromStatement(getTableName(rdbSideTableInfo), Arrays.asList(StringUtils.split(sideSelectFields, &quot;,&quot;)),">  80          sqlCondition = getSelectFromStatement(getTableName(rdbSideTableInfo), Arrays.asList(StringUtils.split(sideðŸ”µ</abbr>
  81                  equalFieldList, sqlJoinCompareOperate, sideTableInfo.getPredicateInfoes());
  82          LOG.info(&quot;----------dimension sql query-----------\n{}&quot;, sqlCondition);
  83      }
  84  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  85 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  86 -    @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  87 -    public void dealOneEqualCon(SqlNode sqlNode, String sideTableName) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  88 -        if (!SqlKind.COMPARISON.contains(sqlNode.getKind())) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  89 -            throw new RuntimeException(&quot;not compare operator.&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  90 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  91 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  92 -        SqlIdentifier left = (SqlIdentifier) ((SqlBasicCall) sqlNode).getOperands()[0];</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  93 -        SqlIdentifier right = (SqlIdentifier) ((SqlBasicCall) sqlNode).getOperands()[1];</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  94 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  95 -        String leftTableName = left.getComponent(0).getSimple();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  96 -        String leftField = left.getComponent(1).getSimple();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  97 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  98 -        String rightTableName = right.getComponent(0).getSimple();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  99 -        String rightField = right.getComponent(1).getSimple();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 100 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 101 -        if (leftTableName.equalsIgnoreCase(sideTableName)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 102 -            equalFieldList.add(leftField);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 103 -            int equalFieldIndex = -1;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 104 -            for (int i = 0; i &lt; rowTypeInfo.getFieldNames().length; i++) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 105 -                String fieldName = rowTypeInfo.getFieldNames()[i];</span>


<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 106 -                if (fieldName.equalsIgnoreCase(rightField)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 107 -                    equalFieldIndex = i;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 108 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 109 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 110 -            if (equalFieldIndex == -1) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 111 -                throw new RuntimeException(&quot;can&#x27;t deal equal field: &quot; + sqlNode);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 112 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 113 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 114 -            equalValIndex.add(equalFieldIndex);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 115 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 116 -        } else if (rightTableName.equalsIgnoreCase(sideTableName)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 117 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 118 -            equalFieldList.add(rightField);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 119 -            int equalFieldIndex = -1;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 120 -            for (int i = 0; i &lt; rowTypeInfo.getFieldNames().length; i++) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 121 -                String fieldName = rowTypeInfo.getFieldNames()[i];</span>


<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 122 -                if (fieldName.equalsIgnoreCase(leftField)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 123 -                    equalFieldIndex = i;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 124 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 125 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 126 -            if (equalFieldIndex == -1) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 127 -                throw new RuntimeException(&quot;can&#x27;t deal equal field: &quot; + sqlNode.toString());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 128 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 129 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 130 -            equalValIndex.add(equalFieldIndex);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 131 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 132 -        } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 133 -            throw new RuntimeException(&quot;resolve equalFieldList error:&quot; + sqlNode.toString());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 134 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 135 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 136 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 137 -</span>
 138      public String getAdditionalWhereClause() {
 139          return &quot;&quot;;
 140      }
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 141 -</span>
 142  
<abbr title=" 143      public String getSelectFromStatement(String tableName, List&lt;String&gt; selectFields, List&lt;String&gt; conditionFields, List&lt;String&gt; sqlJoinCompareOperate,"> 143      public String getSelectFromStatement(String tableName, List&lt;String&gt; selectFields, List&lt;String&gt; conditionFieldsðŸ”µ</abbr>
 144                                           List&lt;PredicateInfo&gt; predicateInfoes) {
 145          String fromClause = selectFields.stream()
 146                  .map(this::quoteIdentifier)
 147                  .collect(Collectors.joining(&quot;, &quot;));
 148  
 149          String whereClause = conditionFields.stream()
<abbr title=" 150                  .map(f -&gt; quoteIdentifier(sideTableInfo.getPhysicalFields().getOrDefault(f, f)) + sqlJoinCompareOperate.get(conditionFields.indexOf(f)) + wrapperPlaceholder(f))"> 150                  .map(f -&gt; quoteIdentifier(sideTableInfo.getPhysicalFields().getOrDefault(f, f)) + sqlJoinCompareOpðŸ”µ</abbr>
 151                  .collect(Collectors.joining(&quot; AND &quot;));
 152  
 153          String predicateClause = predicateInfoes.stream()
 154                  .map(this::buildFilterCondition)
 155                  .collect(Collectors.joining(&quot; AND &quot;));
 156  
<abbr title=" 157          String dimQuerySql = &quot;SELECT &quot; + fromClause + &quot; FROM &quot; + tableName + (conditionFields.size() &gt; 0 ? &quot; WHERE &quot; + whereClause : &quot;&quot;)"> 157          String dimQuerySql = &quot;SELECT &quot; + fromClause + &quot; FROM &quot; + tableName + (conditionFields.size() &gt; 0 ? &quot; WHEREðŸ”µ</abbr>
 158                  + (predicateInfoes.size() &gt; 0 ? &quot; AND &quot; + predicateClause : &quot;&quot;) + getAdditionalWhereClause();
 159  
 160          return dimQuerySql;
 161      }
 162  
 163      public String wrapperPlaceholder(String fieldName) {
 164          return &quot; ? &quot;;
 165      }
 166  
 167      public String buildFilterCondition(PredicateInfo info) {
 168          switch (info.getOperatorKind()) {
 169              case &quot;IN&quot;:
 170              case &quot;NOT_IN&quot;:
<abbr title=" 171                  return quoteIdentifier(info.getFieldName()) + &quot; &quot; + info.getOperatorName() + &quot; ( &quot; + info.getCondition() + &quot; )&quot;;"> 171                  return quoteIdentifier(info.getFieldName()) + &quot; &quot; + info.getOperatorName() + &quot; ( &quot; + info.getCondiðŸ”µ</abbr>
 172              case &quot;NOT_EQUALS&quot;:
 173                  return quoteIdentifier(info.getFieldName()) + &quot; != &quot; + info.getCondition();
 174              case &quot;BETWEEN&quot;:
 175                  return quoteIdentifier(info.getFieldName()) + &quot; BETWEEN  &quot; + info.getCondition();
 176              case &quot;IS_NOT_NULL&quot;:
 177              case &quot;IS_NULL&quot;:
 178                  return quoteIdentifier(info.getFieldName()) + &quot; &quot; + info.getOperatorName();
 179              default:
<abbr title=" 180                  return quoteIdentifier(info.getFieldName()) + &quot; &quot; + info.getOperatorName() + &quot; &quot; + info.getCondition();"> 180                  return quoteIdentifier(info.getFieldName()) + &quot; &quot; + info.getOperatorName() + &quot; &quot; + info.getConditiðŸ”µ</abbr>
 181          }
 182      }
 183  
 184      public String getTableName(RdbSideTableInfo rdbSideTableInfo) {
 185          return rdbSideTableInfo.getTableName();
 186      }
 187  
 188      public String quoteIdentifier(String identifier) {
 189          return &quot; &quot; + identifier + &quot; &quot;;
 190      }
 191  
 192  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            