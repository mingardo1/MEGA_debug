<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>605</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    605
                    <a href="604.html">prev</a>
                    <a href="606.html">next</a>
                    <a href="605_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    DTStack/flinkStreamSQL_b44a86dc90b7fbefeec65e6c5a467a259b41ec59_core/src/main/java/com/dtstack/flink/sql/exec/ExecuteProcessHelper.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;b44a86dc90b7fbefeec65e6c5a467a259b41ec59:core/src/main/java/com/dtstack/flink/sql/exec/ExecuteProcessHelper.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;b44a86dc90b7fbefeec65e6c5a467a259b41ec59^1:core/src/main/java/com/dtstack/flink/sql/exec/ExecuteProcessHelper.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;b44a86dc90b7fbefeec65e6c5a467a259b41ec59^2:core/src/main/java/com/dtstack/flink/sql/exec/ExecuteProcessHelper.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;1a973cf785a926fcd45c51fa474acc2ae880f8cb:core/src/main/java/com/dtstack/flink/sql/exec/ExecuteProcessHelper.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[b], [b], [b], [b], [j], [s], [s], [s], [s], [s], [s], [s]], subset: [[sbj], [b], [b], [b]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 /*
   2  * Licensed to the Apache Software Foundation (ASF) under one
   3  * or more contributor license agreements.  See the NOTICE file
   4  * distributed with this work for additional information
   5  * regarding copyright ownership.  The ASF licenses this file
   6  * to you under the Apache License, Version 2.0 (the
   7  * &quot;License&quot;); you may not use this file except in compliance
   8  * with the License.  You may obtain a copy of the License at
   9  *
  10  *     http://www.apache.org/licenses/LICENSE-2.0
  11  *
  12  * Unless required by applicable law or agreed to in writing, software
  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15  * See the License for the specific language governing permissions and
  16  * limitations under the License.
  17  */
  18 
  19 package com.dtstack.flink.sql.exec;
  20 
  21 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  22 import com.aiweiergou.tool.logger.api.ChangeLogLevelProcess;</span>
  23 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  24 import ch.qos.logback.classic.Level;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  25 import ch.qos.logback.classic.LoggerContext;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  26 import com.dtstack.flink.sql.classloader.ClassLoaderManager;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  27 import com.dtstack.flink.sql.config.CalciteConfig;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  28 import com.dtstack.flink.sql.enums.ClusterMode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  29 import com.dtstack.flink.sql.enums.ECacheType;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  30 import com.dtstack.flink.sql.enums.EPluginLoadMode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  31 import com.dtstack.flink.sql.environment.MyLocalStreamEnvironment;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  32 import com.dtstack.flink.sql.environment.StreamEnvConfigManager;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  33 import com.dtstack.flink.sql.function.FunctionManager;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  34 import com.dtstack.flink.sql.option.OptionParser;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  35 import com.dtstack.flink.sql.option.Options;</span>
  36 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  37 import org.apache.flink.api.common.typeinfo.TypeInformation;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  38 import org.apache.flink.api.java.tuple.Tuple2;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  39 import org.apache.flink.api.java.typeutils.RowTypeInfo;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  40 import org.apache.flink.streaming.api.datastream.DataStream;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  41 import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  42 import org.apache.flink.table.api.StreamQueryConfig;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  43 import org.apache.flink.table.api.Table;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  44 import org.apache.flink.table.api.TableEnvironment;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  45 import org.apache.flink.table.api.java.StreamTableEnvironment;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  46 import org.apache.flink.table.sinks.TableSink;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  47 import org.apache.flink.types.Row;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  48 </span>
  49 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
  50 import com.dtstack.flink.sql.classloader.ClassLoaderManager;
  51 import com.dtstack.flink.sql.config.CalciteConfig;
  52 import com.dtstack.flink.sql.constrant.ConfigConstrant;
  53 import com.dtstack.flink.sql.enums.ClusterMode;
  54 import com.dtstack.flink.sql.enums.ECacheType;
  55 import com.dtstack.flink.sql.enums.EPluginLoadMode;
  56 import com.dtstack.flink.sql.environment.MyLocalStreamEnvironment;
  57 import com.dtstack.flink.sql.environment.StreamEnvConfigManager;
  58 import com.dtstack.flink.sql.function.FunctionManager;
  59 import com.dtstack.flink.sql.option.OptionParser;
  60 import com.dtstack.flink.sql.option.Options;
  61 import com.dtstack.flink.sql.parser.CreateFuncParser;
  62 import com.dtstack.flink.sql.parser.CreateTmpTableParser;
  63 import com.dtstack.flink.sql.parser.InsertSqlParser;
  64 import com.dtstack.flink.sql.parser.SqlParser;
  65 import com.dtstack.flink.sql.parser.SqlTree;
  66 import com.dtstack.flink.sql.side.SideSqlExec;
  67 import com.dtstack.flink.sql.side.AbstractSideTableInfo;
  68 import com.dtstack.flink.sql.sink.StreamSinkFactory;
  69 import com.dtstack.flink.sql.source.StreamSourceFactory;
  70 import com.dtstack.flink.sql.table.AbstractSourceTableInfo;
  71 import com.dtstack.flink.sql.table.AbstractTableInfo;
  72 import com.dtstack.flink.sql.table.AbstractTargetTableInfo;
  73 import com.dtstack.flink.sql.util.DtStringUtil;
  74 import com.dtstack.flink.sql.util.PluginUtil;
  75 import com.dtstack.flink.sql.watermarker.WaterMarkerAssigner;
  76 import com.fasterxml.jackson.databind.ObjectMapper;
  77 import com.google.common.base.Preconditions;
  78 import com.google.common.base.Strings;
  79 import com.google.common.collect.Lists;
  80 import com.google.common.collect.Maps;
  81 import com.google.common.collect.Sets;
  82 import org.apache.calcite.sql.SqlInsert;
  83 import org.apache.calcite.sql.SqlNode;
  84 import org.apache.commons.io.Charsets;
  85 import org.apache.commons.lang3.StringUtils;
  86 import org.slf4j.Logger;
  87 import org.slf4j.LoggerFactory;
  88 
  89 import java.io.File;
  90 import java.lang.reflect.InvocationTargetException;
  91 import java.net.URL;
  92 import java.net.URLClassLoader;
  93 import java.net.URLDecoder;
  94 import java.util.Arrays;
  95 import java.util.List;
  96 import java.util.Map;
  97 import java.util.Properties;
  98 import java.util.Set;
  99 
 100 /**
 101  *  任务执行时的流程方法
 102  * Date: 2020/2/17
 103  * Company: www.dtstack.com
 104  * @author maqi
 105  */
 106 public class ExecuteProcessHelper {
 107 
 108     private static final String CLASS_FILE_NAME_FMT = &quot;class_path_%d&quot;;
 109     private static final Logger LOG = LoggerFactory.getLogger(ExecuteProcessHelper.class);
 110     private static final ObjectMapper OBJECT_MAPPER = new ObjectMapper();
 111 
 112 
 113     public static ParamsInfo parseParams(String[] args) throws Exception {
 114         LOG.info(&quot;------------program params-------------------------&quot;);
 115         System.out.println(&quot;------------program params-------------------------&quot;);
 116         Arrays.stream(args).forEach(arg -&gt; LOG.info(&quot;{}&quot;, arg));
 117         Arrays.stream(args).forEach(System.out::println);
 118         LOG.info(&quot;-------------------------------------------&quot;);
 119         System.out.println(&quot;----------------------------------------&quot;);
 120 
 121         OptionParser optionParser = new OptionParser(args);
 122         Options options = optionParser.getOptions();
 123 
 124         String sql = URLDecoder.decode(options.getSql(), Charsets.UTF_8.name());
 125         String name = options.getName();
 126         String localSqlPluginPath = options.getLocalSqlPluginPath();
 127         String remoteSqlPluginPath = options.getRemoteSqlPluginPath();
 128         String pluginLoadMode = options.getPluginLoadMode();
 129         String deployMode = options.getMode();
 130 
<abbr title=" 131         Preconditions.checkArgument(checkRemoteSqlPluginPath(remoteSqlPluginPath, deployMode, pluginLoadMode),"> 131         Preconditions.checkArgument(checkRemoteSqlPluginPath(remoteSqlPluginPath, deployMode, pluginLoadM🔵</abbr>
 132                 &quot;Non-local mode or shipfile deployment mode, remoteSqlPluginPath is required&quot;);
 133         String confProp = URLDecoder.decode(options.getConfProp(), Charsets.UTF_8.toString());
 134         Properties confProperties = PluginUtil.jsonStrToObject(confProp, Properties.class);
 135 
 136         List&lt;URL&gt; jarUrlList = getExternalJarUrls(options.getAddjar());
 137 
 138         return ParamsInfo.builder()
 139                 .setSql(sql)
 140                 .setName(name)
 141                 .setLocalSqlPluginPath(localSqlPluginPath)
 142                 .setRemoteSqlPluginPath(remoteSqlPluginPath)
 143                 .setPluginLoadMode(pluginLoadMode)
 144                 .setDeployMode(deployMode)
 145                 .setConfProp(confProperties)
 146 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 147                 .setJarUrlList(jarUrlList)</span>
 148 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 149                 .setDeployMode(deployMode)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 150                 .setConfProp(confProperties)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 151                 .setJarUrlList(jarURList)</span>
 152 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 153                 .setJarUrlList(jarURList)</span>
 154 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 155                 .build();
 156 
 157     }
 158 
 159     /**
 160      *   非local模式或者shipfile部署模式，remoteSqlPluginPath必填
 161      * @param remoteSqlPluginPath
 162      * @param deployMode
 163      * @param pluginLoadMode
 164      * @return
 165      */
<abbr title=" 166     public static boolean checkRemoteSqlPluginPath(String remoteSqlPluginPath, String deployMode, String pluginLoadMode) {"> 166     public static boolean checkRemoteSqlPluginPath(String remoteSqlPluginPath, String deployMode, String 🔵</abbr>
 167         if (StringUtils.isEmpty(remoteSqlPluginPath)) {
 168             return StringUtils.equalsIgnoreCase(pluginLoadMode, EPluginLoadMode.SHIPFILE.name())
 169                     || StringUtils.equalsIgnoreCase(deployMode, ClusterMode.local.name());
 170         }
 171         return true;
 172     }
 173 
 174 
 175     public static StreamExecutionEnvironment getStreamExecution(ParamsInfo paramsInfo) throws Exception {
<abbr title=" 176         StreamExecutionEnvironment env = ExecuteProcessHelper.getStreamExeEnv(paramsInfo.getConfProp(), paramsInfo.getDeployMode());"> 176         StreamExecutionEnvironment env = ExecuteProcessHelper.getStreamExeEnv(paramsInfo.getConfProp(), p🔵</abbr>
 177         StreamTableEnvironment tableEnv = StreamTableEnvironment.create(env);
<abbr title=" 178         StreamQueryConfig streamQueryConfig = StreamEnvConfigManager.getStreamQueryConfig(tableEnv, paramsInfo.getConfProp());"> 178         StreamQueryConfig streamQueryConfig = StreamEnvConfigManager.getStreamQueryConfig(tableEnv, param🔵</abbr>
 179 
 180         SqlParser.setLocalSqlPluginRoot(paramsInfo.getLocalSqlPluginPath());
 181         SqlTree sqlTree = SqlParser.parseSql(paramsInfo.getSql());
 182 
 183         Map&lt;String, AbstractSideTableInfo&gt; sideTableMap = Maps.newHashMap();
 184         Map&lt;String, Table&gt; registerTableCache = Maps.newHashMap();
 185 
 186         //register udf
 187         ExecuteProcessHelper.registerUserDefinedFunction(sqlTree, paramsInfo.getJarUrlList(), tableEnv);
 188         //register table schema
<abbr title=" 189         Set&lt;URL&gt; classPathSets = ExecuteProcessHelper.registerTable(sqlTree, env, tableEnv, paramsInfo.getLocalSqlPluginPath(),"> 189         Set&lt;URL&gt; classPathSets = ExecuteProcessHelper.registerTable(sqlTree, env, tableEnv, paramsInfo.ge🔵</abbr>
<abbr title=" 190                 paramsInfo.getRemoteSqlPluginPath(), paramsInfo.getPluginLoadMode(), sideTableMap, registerTableCache);"> 190                 paramsInfo.getRemoteSqlPluginPath(), paramsInfo.getPluginLoadMode(), sideTableMap, regist🔵</abbr>
 191         // cache classPathSets
 192         ExecuteProcessHelper.registerPluginUrlToCachedFile(env, classPathSets);
 193 
<abbr title=" 194         ExecuteProcessHelper.sqlTranslation(paramsInfo.getLocalSqlPluginPath(), tableEnv, sqlTree, sideTableMap, registerTableCache, streamQueryConfig);"> 194         ExecuteProcessHelper.sqlTranslation(paramsInfo.getLocalSqlPluginPath(), tableEnv, sqlTree, sideTa🔵</abbr>
 195 
 196         if (env instanceof MyLocalStreamEnvironment) {
 197             ((MyLocalStreamEnvironment) env).setClasspaths(ClassLoaderManager.getClassPath());
 198         }
 199         return env;
 200     }
 201 
 202 
 203     public static List&lt;URL&gt; getExternalJarUrls(String addJarListStr) throws java.io.IOException {
 204         List&lt;URL&gt; jarUrlList = Lists.newArrayList();
 205         if (Strings.isNullOrEmpty(addJarListStr)) {
 206             return jarUrlList;
 207         }
 208 
<abbr title=" 209         List&lt;String&gt; addJarFileList = OBJECT_MAPPER.readValue(URLDecoder.decode(addJarListStr, Charsets.UTF_8.name()), List.class);"> 209         List&lt;String&gt; addJarFileList = OBJECT_MAPPER.readValue(URLDecoder.decode(addJarListStr, Charsets.U🔵</abbr>
 210         //Get External jar to load
 211         for (String addJarPath : addJarFileList) {
 212             jarUrlList.add(new File(addJarPath).toURI().toURL());
 213         }
 214         return jarUrlList;
 215     }
 216     
 217     private static void sqlTranslation(String localSqlPluginPath,
 218             StreamTableEnvironment tableEnv,
 219             SqlTree sqlTree,Map&lt;String, SideTableInfo&gt; sideTableMap,
 220             Map&lt;String, Table&gt; registerTableCache,
 221             StreamQueryConfig queryConfig) throws Exception {
 222 
 223 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 224     private static void sqlTranslation(String localSqlPluginPath,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 225                                        StreamTableEnvironment tableEnv,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 226                                        SqlTree sqlTree,Map&lt;String, AbstractSideTableInfo&gt; sideTableMap,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 227                                        Map&lt;String, Table&gt; registerTableCache,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 228                                        StreamQueryConfig queryConfig) throws Exception {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 229 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 230         SideSqlExec sideSqlExec = new SideSqlExec();</span>
 231 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 232         return jarUrlList;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 233     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 234 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 235     public static void sqlTranslation(String localSqlPluginPath, StreamTableEnvironment tableEnv, SqlTree sqlTree, Map&lt;String, SideTableInfo&gt; sideTableMap, Map&lt;String, Table&gt; registerTableCache, StreamQueryConfig queryConfig) throws Exception {"> 235     public static void sqlTranslation(String localSqlPluginPath, StreamTableEnvironment tableEnv, SqlTree🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 236         SideSqlExec sideSqlExec = new SideSqlExec();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 237         sideSqlExec.setLocalSqlPluginPath(localSqlPluginPath);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 238         for (CreateTmpTableParser.SqlParserResult result : sqlTree.getTmpSqlList()) {</span>
 239 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 240     	SideSqlExec sideSqlExec = new SideSqlExec();</span>
 241 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 242         sideSqlExec.setLocalSqlPluginPath(localSqlPluginPath);
 243         for (CreateTmpTableParser.SqlParserResult result : sqlTree.getTmpSqlList()) {
<abbr title=" 244             sideSqlExec.exec(result.getExecSql(), sideTableMap, tableEnv, registerTableCache, queryConfig, result);"> 244             sideSqlExec.exec(result.getExecSql(), sideTableMap, tableEnv, registerTableCache, queryConfig🔵</abbr>
 245         }
 246 
 247         for (InsertSqlParser.SqlParseResult result : sqlTree.getExecSqlList()) {
 248             if (LOG.isInfoEnabled()) {
 249                 LOG.info(&quot;exe-sql:\n&quot; + result.getExecSql());
 250             }
 251 
 252             boolean isSide = false;
 253             for (String tableName : result.getTargetTableList()) {
 254                 if (sqlTree.getTmpTableMap().containsKey(tableName)) {
 255                     CreateTmpTableParser.SqlParserResult tmp = sqlTree.getTmpTableMap().get(tableName);
 256                     String realSql = DtStringUtil.replaceIgnoreQuota(result.getExecSql(), &quot;`&quot;, &quot;&quot;);
 257 
<abbr title=" 258                     SqlNode sqlNode = org.apache.calcite.sql.parser.SqlParser.create(realSql, CalciteConfig.MYSQL_LEX_CONFIG).parseStmt();"> 258                     SqlNode sqlNode = org.apache.calcite.sql.parser.SqlParser.create(realSql, CalciteConf🔵</abbr>
 259                     String tmpSql = ((SqlInsert) sqlNode).getSource().toString();
 260                     tmp.setExecSql(tmpSql);
<abbr title=" 261                     sideSqlExec.exec(tmp.getExecSql(), sideTableMap, tableEnv, registerTableCache, queryConfig, tmp);"> 261                     sideSqlExec.exec(tmp.getExecSql(), sideTableMap, tableEnv, registerTableCache, queryC🔵</abbr>
 262                 } else {
 263                     for (String sourceTable : result.getSourceTableList()) {
 264                         if (sideTableMap.containsKey(sourceTable)) {
 265                             isSide = true;
 266                             break;
 267                         }
 268                     }
 269                     if (isSide) {
 270                         //sql-dimensional table contains the dimension table of execution
<abbr title=" 271                         sideSqlExec.exec(result.getExecSql(), sideTableMap, tableEnv, registerTableCache, queryConfig, null);"> 271                         sideSqlExec.exec(result.getExecSql(), sideTableMap, tableEnv, registerTableCache,🔵</abbr>
 272                     } else {
 273                         System.out.println(&quot;----------exec sql without dimension join-----------&quot;);
 274                         System.out.println(&quot;----------real sql exec is--------------------------&quot;);
 275                         System.out.println(result.getExecSql());
 276                         FlinkSQLExec.sqlUpdate(tableEnv, result.getExecSql(), queryConfig);
 277                         if (LOG.isInfoEnabled()) {
 278                             System.out.println();
 279                             LOG.info(&quot;exec sql: &quot; + result.getExecSql());
 280                         }
 281                     }
 282                 }
 283             }
 284         }
 285     }
 286 
<abbr title=" 287     public static void registerUserDefinedFunction(SqlTree sqlTree, List&lt;URL&gt; jarUrlList, TableEnvironment tableEnv)"> 287     public static void registerUserDefinedFunction(SqlTree sqlTree, List&lt;URL&gt; jarUrlList, TableEnvironmen🔵</abbr>
 288             throws IllegalAccessException, InvocationTargetException {
 289         // udf和tableEnv须由同一个类加载器加载
 290         ClassLoader levelClassLoader = tableEnv.getClass().getClassLoader();
 291         URLClassLoader classLoader = null;
 292         List&lt;CreateFuncParser.SqlParserResult&gt; funcList = sqlTree.getFunctionList();
 293         for (CreateFuncParser.SqlParserResult funcInfo : funcList) {
 294             //classloader
 295             if (classLoader == null) {
<abbr title=" 296                 classLoader = ClassLoaderManager.loadExtraJar(jarUrlList, (URLClassLoader) levelClassLoader);"> 296                 classLoader = ClassLoaderManager.loadExtraJar(jarUrlList, (URLClassLoader) levelClassLoad🔵</abbr>
 297             }
<abbr title=" 298             FunctionManager.registerUDF(funcInfo.getType(), funcInfo.getClassName(), funcInfo.getName(), tableEnv, classLoader);"> 298             FunctionManager.registerUDF(funcInfo.getType(), funcInfo.getClassName(), funcInfo.getName(), 🔵</abbr>
 299         }
 300     }
 301 
 302     /**
 303      *    向Flink注册源表和结果表，返回执行时插件包的全路径
 304      * @param sqlTree
 305      * @param env
 306      * @param tableEnv
 307      * @param localSqlPluginPath
 308      * @param remoteSqlPluginPath
 309      * @param pluginLoadMode   插件加载模式 classpath or shipfile
 310      * @param sideTableMap
 311      * @param registerTableCache
 312      * @return
 313      * @throws Exception
 314      */
<abbr title=" 315     public static Set&lt;URL&gt; registerTable(SqlTree sqlTree, StreamExecutionEnvironment env, StreamTableEnvironment tableEnv, String localSqlPluginPath,"> 315     public static Set&lt;URL&gt; registerTable(SqlTree sqlTree, StreamExecutionEnvironment env, StreamTableEnvi🔵</abbr>
<abbr title=" 316                                          String remoteSqlPluginPath, String pluginLoadMode, Map&lt;String, AbstractSideTableInfo&gt; sideTableMap, Map&lt;String, Table&gt; registerTableCache) throws Exception {"> 316                                          String remoteSqlPluginPath, String pluginLoadMode, Map&lt;String, A🔵</abbr>
 317         Set&lt;URL&gt; pluginClassPatshSets = Sets.newHashSet();
 318         WaterMarkerAssigner waterMarkerAssigner = new WaterMarkerAssigner();
 319         for (AbstractTableInfo tableInfo : sqlTree.getTableInfoMap().values()) {
 320 
 321             if (tableInfo instanceof AbstractSourceTableInfo) {
 322 
 323                 AbstractSourceTableInfo sourceTableInfo = (AbstractSourceTableInfo) tableInfo;
<abbr title=" 324                 Table table = StreamSourceFactory.getStreamSource(sourceTableInfo, env, tableEnv, localSqlPluginPath);"> 324                 Table table = StreamSourceFactory.getStreamSource(sourceTableInfo, env, tableEnv, localSq🔵</abbr>
 325                 tableEnv.registerTable(sourceTableInfo.getAdaptName(), table);
<abbr title=" 326                 //Note --- parameter conversion function can not be used inside a function of the type of polymerization"> 326                 //Note --- parameter conversion function can not be used inside a function of the type of🔵</abbr>
 327                 //Create table in which the function is arranged only need adaptation sql
 328                 String adaptSql = sourceTableInfo.getAdaptSelectSql();
 329                 Table adaptTable = adaptSql == null ? table : tableEnv.sqlQuery(adaptSql);
 330 
<abbr title=" 331                 RowTypeInfo typeInfo = new RowTypeInfo(adaptTable.getSchema().getFieldTypes(), adaptTable.getSchema().getFieldNames());"> 331                 RowTypeInfo typeInfo = new RowTypeInfo(adaptTable.getSchema().getFieldTypes(), adaptTable🔵</abbr>
 332                 DataStream adaptStream = tableEnv.toRetractStream(adaptTable, typeInfo)
 333                         .map((Tuple2&lt;Boolean, Row&gt; f0) -&gt; {
 334                             return f0.f1;
 335                         })
 336                         .returns(typeInfo);
 337 
 338                 String fields = String.join(&quot;,&quot;, typeInfo.getFieldNames());
 339 
 340                 if (waterMarkerAssigner.checkNeedAssignWaterMarker(sourceTableInfo)) {
<abbr title=" 341                     adaptStream = waterMarkerAssigner.assignWaterMarker(adaptStream, typeInfo, sourceTableInfo);"> 341                     adaptStream = waterMarkerAssigner.assignWaterMarker(adaptStream, typeInfo, sourceTabl🔵</abbr>
 342                     fields += &quot;,ROWTIME.ROWTIME&quot;;
 343                 } else {
 344                     fields += &quot;,PROCTIME.PROCTIME&quot;;
 345                 }
 346 
 347                 Table regTable = tableEnv.fromDataStream(adaptStream, fields);
 348                 tableEnv.registerTable(tableInfo.getName(), regTable);
 349                 if (LOG.isInfoEnabled()) {
 350                     LOG.info(&quot;registe table {} success.&quot;, tableInfo.getName());
 351                 }
 352                 registerTableCache.put(tableInfo.getName(), regTable);
 353 
<abbr title=" 354                 URL sourceTablePathUrl = PluginUtil.buildSourceAndSinkPathByLoadMode(tableInfo.getType(), AbstractSourceTableInfo.SOURCE_SUFFIX, localSqlPluginPath, remoteSqlPluginPath, pluginLoadMode);"> 354                 URL sourceTablePathUrl = PluginUtil.buildSourceAndSinkPathByLoadMode(tableInfo.getType(),🔵</abbr>
 355                 pluginClassPatshSets.add(sourceTablePathUrl);
 356             } else if (tableInfo instanceof AbstractTargetTableInfo) {
 357 
<abbr title=" 358                 TableSink tableSink = StreamSinkFactory.getTableSink((AbstractTargetTableInfo) tableInfo, localSqlPluginPath);"> 358                 TableSink tableSink = StreamSinkFactory.getTableSink((AbstractTargetTableInfo) tableInfo,🔵</abbr>
<abbr title=" 359                 TypeInformation[] flinkTypes = FunctionManager.transformTypes(tableInfo.getFieldClasses());"> 359                 TypeInformation[] flinkTypes = FunctionManager.transformTypes(tableInfo.getFieldClasses()🔵</abbr>
<abbr title=" 360                 tableEnv.registerTableSink(tableInfo.getName(), tableInfo.getFields(), flinkTypes, tableSink);"> 360                 tableEnv.registerTableSink(tableInfo.getName(), tableInfo.getFields(), flinkTypes, tableS🔵</abbr>
 361 
<abbr title=" 362                 URL sinkTablePathUrl = PluginUtil.buildSourceAndSinkPathByLoadMode(tableInfo.getType(), AbstractTargetTableInfo.TARGET_SUFFIX, localSqlPluginPath, remoteSqlPluginPath, pluginLoadMode);"> 362                 URL sinkTablePathUrl = PluginUtil.buildSourceAndSinkPathByLoadMode(tableInfo.getType(), A🔵</abbr>
 363                 pluginClassPatshSets.add(sinkTablePathUrl);
 364             } else if (tableInfo instanceof AbstractSideTableInfo) {
<abbr title=" 365                 String sideOperator = ECacheType.ALL.name().equals(((AbstractSideTableInfo) tableInfo).getCacheType()) ? &quot;all&quot; : &quot;async&quot;;"> 365                 String sideOperator = ECacheType.ALL.name().equals(((AbstractSideTableInfo) tableInfo).ge🔵</abbr>
 366                 sideTableMap.put(tableInfo.getName(), (AbstractSideTableInfo) tableInfo);
 367 
<abbr title=" 368                 URL sideTablePathUrl = PluginUtil.buildSidePathByLoadMode(tableInfo.getType(), sideOperator, AbstractSideTableInfo.TARGET_SUFFIX, localSqlPluginPath, remoteSqlPluginPath, pluginLoadMode);"> 368                 URL sideTablePathUrl = PluginUtil.buildSidePathByLoadMode(tableInfo.getType(), sideOperat🔵</abbr>
 369                 pluginClassPatshSets.add(sideTablePathUrl);
 370             } else {
 371                 throw new RuntimeException(&quot;not support table type:&quot; + tableInfo.getType());
 372             }
 373         }
 374         return pluginClassPatshSets;
 375     }
 376 
 377     /**
 378      *   perjob模式将job依赖的插件包路径存储到cacheFile，在外围将插件包路径传递给jobgraph
 379      * @param env
 380      * @param classPathSet
 381      */
<abbr title=" 382     public static void registerPluginUrlToCachedFile(StreamExecutionEnvironment env, Set&lt;URL&gt; classPathSet) {"> 382     public static void registerPluginUrlToCachedFile(StreamExecutionEnvironment env, Set&lt;URL&gt; classPathSe🔵</abbr>
 383         int i = 0;
 384         for (URL url : classPathSet) {
 385             String classFileName = String.format(CLASS_FILE_NAME_FMT, i);
 386             env.registerCachedFile(url.getPath(), classFileName, true);
 387             i++;
 388         }
 389     }
 390 
<abbr title=" 391     public static StreamExecutionEnvironment getStreamExeEnv(Properties confProperties, String deployMode) throws Exception {"> 391     public static StreamExecutionEnvironment getStreamExeEnv(Properties confProperties, String deployMode🔵</abbr>
 392         StreamExecutionEnvironment env = !ClusterMode.local.name().equals(deployMode) ?
 393                 StreamExecutionEnvironment.getExecutionEnvironment() :
 394                 new MyLocalStreamEnvironment();
 395 
 396         StreamEnvConfigManager.streamExecutionEnvironmentConfig(env, confProperties);
 397         return env;
 398     }
 399 
 400 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 401     public static void setLogLevel(ParamsInfo paramsInfo){</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 402         String logLevel = paramsInfo.getConfProp().getProperty(ConfigConstrant.LOG_LEVEL_KEY);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 403         if(org.apache.commons.lang3.StringUtils.isBlank(logLevel)){</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 404             return;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 405         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 406         ChangeLogLevelProcess logLevelProcess = new ChangeLogLevelProcess();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 407         logLevelProcess.process(logLevel);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 408     }</span>
 409 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 410         ch.qos.logback.classic.Logger logger = loggerContext.getLogger(&quot;root&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 411         logger.setLevel(Level.toLevel(level, Level.INFO));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 412     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 413 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 414 }</span>
 415 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 416 </span>
 417 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 418 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                            <td><pre>   1 /*
   2  * Licensed to the Apache Software Foundation (ASF) under one
   3  * or more contributor license agreements.  See the NOTICE file
   4  * distributed with this work for additional information
   5  * regarding copyright ownership.  The ASF licenses this file
   6  * to you under the Apache License, Version 2.0 (the
   7  * &quot;License&quot;); you may not use this file except in compliance
   8  * with the License.  You may obtain a copy of the License at
   9  *
  10  *     http://www.apache.org/licenses/LICENSE-2.0
  11  *
  12  * Unless required by applicable law or agreed to in writing, software
  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15  * See the License for the specific language governing permissions and
  16  * limitations under the License.
  17  */
  18 
  19 package com.dtstack.flink.sql.exec;
  20 
  21 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  22 import com.aiweiergou.tool.logger.api.ChangeLogLevelProcess;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  23 import com.dtstack.flink.sql.classloader.ClassLoaderManager;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  24 import com.dtstack.flink.sql.config.CalciteConfig;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  25 import com.dtstack.flink.sql.constrant.ConfigConstrant;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  26 import com.dtstack.flink.sql.enums.ClusterMode;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  27 import com.dtstack.flink.sql.enums.ECacheType;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  28 import com.dtstack.flink.sql.enums.EPluginLoadMode;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  29 import com.dtstack.flink.sql.environment.MyLocalStreamEnvironment;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  30 import com.dtstack.flink.sql.environment.StreamEnvConfigManager;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  31 import com.dtstack.flink.sql.function.FunctionManager;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  32 import com.dtstack.flink.sql.option.OptionParser;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  33 import com.dtstack.flink.sql.option.Options;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  34 import com.dtstack.flink.sql.parser.CreateFuncParser;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  35 import com.dtstack.flink.sql.parser.CreateTmpTableParser;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  36 import com.dtstack.flink.sql.parser.InsertSqlParser;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  37 import com.dtstack.flink.sql.parser.SqlParser;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  38 import com.dtstack.flink.sql.parser.SqlTree;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  39 import com.dtstack.flink.sql.side.SideSqlExec;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  40 import com.dtstack.flink.sql.side.AbstractSideTableInfo;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  41 import com.dtstack.flink.sql.sink.StreamSinkFactory;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  42 import com.dtstack.flink.sql.source.StreamSourceFactory;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  43 import com.dtstack.flink.sql.table.AbstractSourceTableInfo;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  44 import com.dtstack.flink.sql.table.AbstractTableInfo;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  45 import com.dtstack.flink.sql.table.AbstractTargetTableInfo;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  46 import com.dtstack.flink.sql.util.DtStringUtil;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  47 import com.dtstack.flink.sql.util.PluginUtil;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  48 import com.dtstack.flink.sql.watermarker.WaterMarkerAssigner;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  49 import com.fasterxml.jackson.databind.ObjectMapper;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  50 import com.google.common.base.Preconditions;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  51 import com.google.common.base.Strings;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  52 import com.google.common.collect.Lists;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  53 import com.google.common.collect.Maps;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  54 import com.google.common.collect.Sets;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  55 import org.apache.calcite.sql.SqlInsert;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  56 import org.apache.calcite.sql.SqlNode;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  57 import org.apache.commons.io.Charsets;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  58 import org.apache.commons.lang3.StringUtils;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  59 import org.apache.flink.api.common.typeinfo.TypeInformation;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  60 import org.apache.flink.api.java.tuple.Tuple2;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  61 import org.apache.flink.api.java.typeutils.RowTypeInfo;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  62 import org.apache.flink.streaming.api.datastream.DataStream;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  63 import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  64 import org.apache.flink.table.api.StreamQueryConfig;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  65 import org.apache.flink.table.api.Table;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  66 import org.apache.flink.table.api.TableEnvironment;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  67 import org.apache.flink.table.api.java.StreamTableEnvironment;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  68 import org.apache.flink.table.sinks.TableSink;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  69 import org.apache.flink.types.Row;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  70 import org.slf4j.Logger;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  71 import org.slf4j.LoggerFactory;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  72 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  73 import java.io.File;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  74 import java.lang.reflect.InvocationTargetException;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  75 import java.net.URL;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  76 import java.net.URLClassLoader;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  77 import java.net.URLDecoder;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  78 import java.util.Arrays;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  79 import java.util.List;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  80 import java.util.Map;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  81 import java.util.Properties;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  82 import java.util.Set;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  83 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  84 /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  85  *  任务执行时的流程方法</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  86  * Date: 2020/2/17</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  87  * Company: www.dtstack.com</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  88  * @author maqi</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  89  */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  90 public class ExecuteProcessHelper {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  91 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  92     private static final String CLASS_FILE_NAME_FMT = &quot;class_path_%d&quot;;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  93     private static final Logger LOG = LoggerFactory.getLogger(ExecuteProcessHelper.class);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  94     private static final ObjectMapper OBJECT_MAPPER = new ObjectMapper();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  95 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  96 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  97     public static ParamsInfo parseParams(String[] args) throws Exception {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  98         LOG.info(&quot;------------program params-------------------------&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  99         System.out.println(&quot;------------program params-------------------------&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 100         Arrays.stream(args).forEach(arg -&gt; LOG.info(&quot;{}&quot;, arg));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 101         Arrays.stream(args).forEach(System.out::println);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 102         LOG.info(&quot;-------------------------------------------&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 103         System.out.println(&quot;----------------------------------------&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 104 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 105         OptionParser optionParser = new OptionParser(args);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 106         Options options = optionParser.getOptions();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 107 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 108         String sql = URLDecoder.decode(options.getSql(), Charsets.UTF_8.name());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 109         String name = options.getName();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 110         String localSqlPluginPath = options.getLocalSqlPluginPath();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 111         String remoteSqlPluginPath = options.getRemoteSqlPluginPath();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 112         String pluginLoadMode = options.getPluginLoadMode();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 113         String deployMode = options.getMode();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 114         String logLevel = options.getLogLevel();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 115 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 116         Preconditions.checkArgument(checkRemoteSqlPluginPath(remoteSqlPluginPath, deployMode, pluginLoadMode),"> 116         Preconditions.checkArgument(checkRemoteSqlPluginPath(remoteSqlPluginPath, deployMode, pluginLoadM🔵</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 117                 &quot;Non-local mode or shipfile deployment mode, remoteSqlPluginPath is required&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 118         String confProp = URLDecoder.decode(options.getConfProp(), Charsets.UTF_8.toString());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 119         Properties confProperties = PluginUtil.jsonStrToObject(confProp, Properties.class);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 120 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 121         List&lt;URL&gt; jarUrlList = getExternalJarUrls(options.getAddjar());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 122 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 123         return ParamsInfo.builder()</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 124                 .setSql(sql)</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 125                 .setName(name)</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 126                 .setLocalSqlPluginPath(localSqlPluginPath)</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 127                 .setRemoteSqlPluginPath(remoteSqlPluginPath)</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 128                 .setPluginLoadMode(pluginLoadMode)</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 129                 .setDeployMode(deployMode)</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 130                 .setConfProp(confProperties)</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 131                 .setJarUrlList(jarUrlList)</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 132                 .build();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 133 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 134     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 135 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 136     /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 137      *   非local模式或者shipfile部署模式，remoteSqlPluginPath必填</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 138      * @param remoteSqlPluginPath</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 139      * @param deployMode</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 140      * @param pluginLoadMode</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 141      * @return</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 142      */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 143     public static boolean checkRemoteSqlPluginPath(String remoteSqlPluginPath, String deployMode, String pluginLoadMode) {"> 143     public static boolean checkRemoteSqlPluginPath(String remoteSqlPluginPath, String deployMode, String 🔵</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 144         if (StringUtils.isEmpty(remoteSqlPluginPath)) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 145             return StringUtils.equalsIgnoreCase(pluginLoadMode, EPluginLoadMode.SHIPFILE.name())</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 146                     || StringUtils.equalsIgnoreCase(deployMode, ClusterMode.local.name());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 147         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 148         return true;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 149     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 150 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 151 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 152     public static StreamExecutionEnvironment getStreamExecution(ParamsInfo paramsInfo) throws Exception {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 153         StreamExecutionEnvironment env = ExecuteProcessHelper.getStreamExeEnv(paramsInfo.getConfProp(), paramsInfo.getDeployMode());"> 153         StreamExecutionEnvironment env = ExecuteProcessHelper.getStreamExeEnv(paramsInfo.getConfProp(), p🔵</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 154         StreamTableEnvironment tableEnv = StreamTableEnvironment.create(env);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 155         StreamQueryConfig streamQueryConfig = StreamEnvConfigManager.getStreamQueryConfig(tableEnv, paramsInfo.getConfProp());"> 155         StreamQueryConfig streamQueryConfig = StreamEnvConfigManager.getStreamQueryConfig(tableEnv, param🔵</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 156 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 157         SqlParser.setLocalSqlPluginRoot(paramsInfo.getLocalSqlPluginPath());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 158         SqlTree sqlTree = SqlParser.parseSql(paramsInfo.getSql());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 159 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 160         Map&lt;String, AbstractSideTableInfo&gt; sideTableMap = Maps.newHashMap();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 161         Map&lt;String, Table&gt; registerTableCache = Maps.newHashMap();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 162 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 163         //register udf</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 164         ExecuteProcessHelper.registerUserDefinedFunction(sqlTree, paramsInfo.getJarUrlList(), tableEnv);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 165         //register table schema</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 166         Set&lt;URL&gt; classPathSets = ExecuteProcessHelper.registerTable(sqlTree, env, tableEnv, paramsInfo.getLocalSqlPluginPath(),"> 166         Set&lt;URL&gt; classPathSets = ExecuteProcessHelper.registerTable(sqlTree, env, tableEnv, paramsInfo.ge🔵</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 167                 paramsInfo.getRemoteSqlPluginPath(), paramsInfo.getPluginLoadMode(), sideTableMap, registerTableCache);"> 167                 paramsInfo.getRemoteSqlPluginPath(), paramsInfo.getPluginLoadMode(), sideTableMap, regist🔵</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 168         // cache classPathSets</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 169         ExecuteProcessHelper.registerPluginUrlToCachedFile(env, classPathSets);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 170 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 171         ExecuteProcessHelper.sqlTranslation(paramsInfo.getLocalSqlPluginPath(), tableEnv, sqlTree, sideTableMap, registerTableCache, streamQueryConfig);"> 171         ExecuteProcessHelper.sqlTranslation(paramsInfo.getLocalSqlPluginPath(), tableEnv, sqlTree, sideTa🔵</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 172 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 173         if (env instanceof MyLocalStreamEnvironment) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 174             ((MyLocalStreamEnvironment) env).setClasspaths(ClassLoaderManager.getClassPath());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 175         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 176         return env;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 177     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 178 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 179 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 180     public static List&lt;URL&gt; getExternalJarUrls(String addJarListStr) throws java.io.IOException {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 181         List&lt;URL&gt; jarUrlList = Lists.newArrayList();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 182         if (Strings.isNullOrEmpty(addJarListStr)) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 183             return jarUrlList;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 184         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 185 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 186         List&lt;String&gt; addJarFileList = OBJECT_MAPPER.readValue(URLDecoder.decode(addJarListStr, Charsets.UTF_8.name()), List.class);"> 186         List&lt;String&gt; addJarFileList = OBJECT_MAPPER.readValue(URLDecoder.decode(addJarListStr, Charsets.U🔵</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 187         //Get External jar to load</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 188         for (String addJarPath : addJarFileList) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 189             jarUrlList.add(new File(addJarPath).toURI().toURL());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 190         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 191         return jarUrlList;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 192     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 193 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 194     private static void sqlTranslation(String localSqlPluginPath,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 195                                        StreamTableEnvironment tableEnv,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 196                                        SqlTree sqlTree,Map&lt;String, AbstractSideTableInfo&gt; sideTableMap,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 197                                        Map&lt;String, Table&gt; registerTableCache,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 198                                        StreamQueryConfig queryConfig) throws Exception {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 199 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 200         SideSqlExec sideSqlExec = new SideSqlExec();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 201         sideSqlExec.setLocalSqlPluginPath(localSqlPluginPath);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 202         for (CreateTmpTableParser.SqlParserResult result : sqlTree.getTmpSqlList()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 203             sideSqlExec.exec(result.getExecSql(), sideTableMap, tableEnv, registerTableCache, queryConfig, result);"> 203             sideSqlExec.exec(result.getExecSql(), sideTableMap, tableEnv, registerTableCache, queryConfig🔵</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 204         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 205 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 206         for (InsertSqlParser.SqlParseResult result : sqlTree.getExecSqlList()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 207             if (LOG.isInfoEnabled()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 208                 LOG.info(&quot;exe-sql:\n&quot; + result.getExecSql());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 209             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 210 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 211             boolean isSide = false;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 212             for (String tableName : result.getTargetTableList()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 213                 if (sqlTree.getTmpTableMap().containsKey(tableName)) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 214                     CreateTmpTableParser.SqlParserResult tmp = sqlTree.getTmpTableMap().get(tableName);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 215                     String realSql = DtStringUtil.replaceIgnoreQuota(result.getExecSql(), &quot;`&quot;, &quot;&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 216 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 217                     SqlNode sqlNode = org.apache.calcite.sql.parser.SqlParser.create(realSql, CalciteConfig.MYSQL_LEX_CONFIG).parseStmt();"> 217                     SqlNode sqlNode = org.apache.calcite.sql.parser.SqlParser.create(realSql, CalciteConf🔵</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 218                     String tmpSql = ((SqlInsert) sqlNode).getSource().toString();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 219                     tmp.setExecSql(tmpSql);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 220                     sideSqlExec.exec(tmp.getExecSql(), sideTableMap, tableEnv, registerTableCache, queryConfig, tmp);"> 220                     sideSqlExec.exec(tmp.getExecSql(), sideTableMap, tableEnv, registerTableCache, queryC🔵</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 221                 } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 222                     for (String sourceTable : result.getSourceTableList()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 223                         if (sideTableMap.containsKey(sourceTable)) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 224                             isSide = true;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 225                             break;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 226                         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 227                     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 228                     if (isSide) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 229                         //sql-dimensional table contains the dimension table of execution</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 230                         sideSqlExec.exec(result.getExecSql(), sideTableMap, tableEnv, registerTableCache, queryConfig, null);"> 230                         sideSqlExec.exec(result.getExecSql(), sideTableMap, tableEnv, registerTableCache,🔵</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 231                     } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 232                         System.out.println(&quot;----------exec sql without dimension join-----------&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 233                         System.out.println(&quot;----------real sql exec is--------------------------&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 234                         System.out.println(result.getExecSql());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 235                         FlinkSQLExec.sqlUpdate(tableEnv, result.getExecSql(), queryConfig);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 236                         if (LOG.isInfoEnabled()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 237                             System.out.println();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 238                             LOG.info(&quot;exec sql: &quot; + result.getExecSql());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 239                         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 240                     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 241                 }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 242             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 243         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 244     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 245 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 246     public static void registerUserDefinedFunction(SqlTree sqlTree, List&lt;URL&gt; jarUrlList, TableEnvironment tableEnv)"> 246     public static void registerUserDefinedFunction(SqlTree sqlTree, List&lt;URL&gt; jarUrlList, TableEnvironmen🔵</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 247             throws IllegalAccessException, InvocationTargetException {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 248         // udf和tableEnv须由同一个类加载器加载</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 249         ClassLoader levelClassLoader = tableEnv.getClass().getClassLoader();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 250         URLClassLoader classLoader = null;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 251         List&lt;CreateFuncParser.SqlParserResult&gt; funcList = sqlTree.getFunctionList();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 252         for (CreateFuncParser.SqlParserResult funcInfo : funcList) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 253             //classloader</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 254             if (classLoader == null) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 255                 classLoader = ClassLoaderManager.loadExtraJar(jarUrlList, (URLClassLoader) levelClassLoader);"> 255                 classLoader = ClassLoaderManager.loadExtraJar(jarUrlList, (URLClassLoader) levelClassLoad🔵</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 256             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 257             FunctionManager.registerUDF(funcInfo.getType(), funcInfo.getClassName(), funcInfo.getName(), tableEnv, classLoader);"> 257             FunctionManager.registerUDF(funcInfo.getType(), funcInfo.getClassName(), funcInfo.getName(), 🔵</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 258         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 259     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 260 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 261     /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 262      *    向Flink注册源表和结果表，返回执行时插件包的全路径</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 263      * @param sqlTree</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 264      * @param env</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 265      * @param tableEnv</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 266      * @param localSqlPluginPath</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 267      * @param remoteSqlPluginPath</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 268      * @param pluginLoadMode   插件加载模式 classpath or shipfile</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 269      * @param sideTableMap</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 270      * @param registerTableCache</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 271      * @return</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 272      * @throws Exception</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 273      */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 274     public static Set&lt;URL&gt; registerTable(SqlTree sqlTree, StreamExecutionEnvironment env, StreamTableEnvironment tableEnv, String localSqlPluginPath,"> 274     public static Set&lt;URL&gt; registerTable(SqlTree sqlTree, StreamExecutionEnvironment env, StreamTableEnvi🔵</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 275                                          String remoteSqlPluginPath, String pluginLoadMode, Map&lt;String, AbstractSideTableInfo&gt; sideTableMap, Map&lt;String, Table&gt; registerTableCache) throws Exception {"> 275                                          String remoteSqlPluginPath, String pluginLoadMode, Map&lt;String, A🔵</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 276         Set&lt;URL&gt; pluginClassPatshSets = Sets.newHashSet();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 277         WaterMarkerAssigner waterMarkerAssigner = new WaterMarkerAssigner();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 278         for (AbstractTableInfo tableInfo : sqlTree.getTableInfoMap().values()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 279 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 280             if (tableInfo instanceof AbstractSourceTableInfo) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 281 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 282                 AbstractSourceTableInfo sourceTableInfo = (AbstractSourceTableInfo) tableInfo;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 283                 Table table = StreamSourceFactory.getStreamSource(sourceTableInfo, env, tableEnv, localSqlPluginPath);"> 283                 Table table = StreamSourceFactory.getStreamSource(sourceTableInfo, env, tableEnv, localSq🔵</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 284                 tableEnv.registerTable(sourceTableInfo.getAdaptName(), table);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 285                 //Note --- parameter conversion function can not be used inside a function of the type of polymerization"> 285                 //Note --- parameter conversion function can not be used inside a function of the type of🔵</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 286                 //Create table in which the function is arranged only need adaptation sql</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 287                 String adaptSql = sourceTableInfo.getAdaptSelectSql();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 288                 Table adaptTable = adaptSql == null ? table : tableEnv.sqlQuery(adaptSql);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 289 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 290                 RowTypeInfo typeInfo = new RowTypeInfo(adaptTable.getSchema().getFieldTypes(), adaptTable.getSchema().getFieldNames());"> 290                 RowTypeInfo typeInfo = new RowTypeInfo(adaptTable.getSchema().getFieldTypes(), adaptTable🔵</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 291                 DataStream adaptStream = tableEnv.toRetractStream(adaptTable, typeInfo)</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 292                         .map((Tuple2&lt;Boolean, Row&gt; f0) -&gt; {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 293                             return f0.f1;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 294                         })</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 295                         .returns(typeInfo);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 296 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 297                 String fields = String.join(&quot;,&quot;, typeInfo.getFieldNames());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 298 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 299                 if (waterMarkerAssigner.checkNeedAssignWaterMarker(sourceTableInfo)) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 300                     adaptStream = waterMarkerAssigner.assignWaterMarker(adaptStream, typeInfo, sourceTableInfo);"> 300                     adaptStream = waterMarkerAssigner.assignWaterMarker(adaptStream, typeInfo, sourceTabl🔵</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 301                     fields += &quot;,ROWTIME.ROWTIME&quot;;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 302                 } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 303                     fields += &quot;,PROCTIME.PROCTIME&quot;;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 304                 }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 305 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 306                 Table regTable = tableEnv.fromDataStream(adaptStream, fields);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 307                 tableEnv.registerTable(tableInfo.getName(), regTable);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 308                 if (LOG.isInfoEnabled()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 309                     LOG.info(&quot;registe table {} success.&quot;, tableInfo.getName());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 310                 }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 311                 registerTableCache.put(tableInfo.getName(), regTable);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 312 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 313                 URL sourceTablePathUrl = PluginUtil.buildSourceAndSinkPathByLoadMode(tableInfo.getType(), AbstractSourceTableInfo.SOURCE_SUFFIX, localSqlPluginPath, remoteSqlPluginPath, pluginLoadMode);"> 313                 URL sourceTablePathUrl = PluginUtil.buildSourceAndSinkPathByLoadMode(tableInfo.getType(),🔵</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 314                 pluginClassPatshSets.add(sourceTablePathUrl);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 315             } else if (tableInfo instanceof AbstractTargetTableInfo) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 316 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 317                 TableSink tableSink = StreamSinkFactory.getTableSink((AbstractTargetTableInfo) tableInfo, localSqlPluginPath);"> 317                 TableSink tableSink = StreamSinkFactory.getTableSink((AbstractTargetTableInfo) tableInfo,🔵</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 318                 TypeInformation[] flinkTypes = FunctionManager.transformTypes(tableInfo.getFieldClasses());"> 318                 TypeInformation[] flinkTypes = FunctionManager.transformTypes(tableInfo.getFieldClasses()🔵</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 319                 tableEnv.registerTableSink(tableInfo.getName(), tableInfo.getFields(), flinkTypes, tableSink);"> 319                 tableEnv.registerTableSink(tableInfo.getName(), tableInfo.getFields(), flinkTypes, tableS🔵</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 320 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 321                 URL sinkTablePathUrl = PluginUtil.buildSourceAndSinkPathByLoadMode(tableInfo.getType(), AbstractTargetTableInfo.TARGET_SUFFIX, localSqlPluginPath, remoteSqlPluginPath, pluginLoadMode);"> 321                 URL sinkTablePathUrl = PluginUtil.buildSourceAndSinkPathByLoadMode(tableInfo.getType(), A🔵</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 322                 pluginClassPatshSets.add(sinkTablePathUrl);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 323             } else if (tableInfo instanceof AbstractSideTableInfo) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 324                 String sideOperator = ECacheType.ALL.name().equals(((AbstractSideTableInfo) tableInfo).getCacheType()) ? &quot;all&quot; : &quot;async&quot;;"> 324                 String sideOperator = ECacheType.ALL.name().equals(((AbstractSideTableInfo) tableInfo).ge🔵</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 325                 sideTableMap.put(tableInfo.getName(), (AbstractSideTableInfo) tableInfo);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 326 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 327                 URL sideTablePathUrl = PluginUtil.buildSidePathByLoadMode(tableInfo.getType(), sideOperator, AbstractSideTableInfo.TARGET_SUFFIX, localSqlPluginPath, remoteSqlPluginPath, pluginLoadMode);"> 327                 URL sideTablePathUrl = PluginUtil.buildSidePathByLoadMode(tableInfo.getType(), sideOperat🔵</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 328                 pluginClassPatshSets.add(sideTablePathUrl);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 329             } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 330                 throw new RuntimeException(&quot;not support table type:&quot; + tableInfo.getType());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 331             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 332         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 333         return pluginClassPatshSets;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 334     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 335 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 336     /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 337      *   perjob模式将job依赖的插件包路径存储到cacheFile，在外围将插件包路径传递给jobgraph</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 338      * @param env</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 339      * @param classPathSet</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 340      */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 341     public static void registerPluginUrlToCachedFile(StreamExecutionEnvironment env, Set&lt;URL&gt; classPathSet) {"> 341     public static void registerPluginUrlToCachedFile(StreamExecutionEnvironment env, Set&lt;URL&gt; classPathSe🔵</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 342         int i = 0;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 343         for (URL url : classPathSet) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 344             String classFileName = String.format(CLASS_FILE_NAME_FMT, i);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 345             env.registerCachedFile(url.getPath(), classFileName, true);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 346             i++;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 347         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 348     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 349 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 350     public static StreamExecutionEnvironment getStreamExeEnv(Properties confProperties, String deployMode) throws Exception {"> 350     public static StreamExecutionEnvironment getStreamExeEnv(Properties confProperties, String deployMode🔵</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 351         StreamExecutionEnvironment env = !ClusterMode.local.name().equals(deployMode) ?</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 352                 StreamExecutionEnvironment.getExecutionEnvironment() :</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 353                 new MyLocalStreamEnvironment();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 354 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 355         StreamEnvConfigManager.streamExecutionEnvironmentConfig(env, confProperties);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 356         return env;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 357     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 358 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 359     public static void setLogLevel(ParamsInfo paramsInfo){</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 360         String logLevel = paramsInfo.getConfProp().getProperty(ConfigConstrant.LOG_LEVEL_KEY);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 361         if(org.apache.commons.lang3.StringUtils.isBlank(logLevel)){</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 362             return;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 363         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 364         ChangeLogLevelProcess logLevelProcess = new ChangeLogLevelProcess();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 365         logLevelProcess.process(logLevel);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 366     }</span>
 367 ||||||| BASE
 368 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 369 import org.apache.flink.api.common.typeinfo.TypeInformation;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 370 import org.apache.flink.api.java.tuple.Tuple2;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 371 import org.apache.flink.api.java.typeutils.RowTypeInfo;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 372 import org.apache.flink.streaming.api.datastream.DataStream;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 373 import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 374 import org.apache.flink.table.api.StreamQueryConfig;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 375 import org.apache.flink.table.api.Table;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 376 import org.apache.flink.table.api.TableEnvironment;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 377 import org.apache.flink.table.api.java.StreamTableEnvironment;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 378 import org.apache.flink.table.sinks.TableSink;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 379 import org.apache.flink.types.Row;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 380 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 381 import com.dtstack.flink.sql.classloader.ClassLoaderManager;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 382 import com.dtstack.flink.sql.config.CalciteConfig;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 383 import com.dtstack.flink.sql.enums.ClusterMode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 384 import com.dtstack.flink.sql.enums.ECacheType;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 385 import com.dtstack.flink.sql.enums.EPluginLoadMode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 386 import com.dtstack.flink.sql.environment.MyLocalStreamEnvironment;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 387 import com.dtstack.flink.sql.environment.StreamEnvConfigManager;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 388 import com.dtstack.flink.sql.function.FunctionManager;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 389 import com.dtstack.flink.sql.option.OptionParser;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 390 import com.dtstack.flink.sql.option.Options;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 391 import com.dtstack.flink.sql.parser.CreateFuncParser;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 392 import com.dtstack.flink.sql.parser.CreateTmpTableParser;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 393 import com.dtstack.flink.sql.parser.InsertSqlParser;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 394 import com.dtstack.flink.sql.parser.SqlParser;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 395 import com.dtstack.flink.sql.parser.SqlTree;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 396 import com.dtstack.flink.sql.side.SideSqlExec;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 397 import com.dtstack.flink.sql.side.SideTableInfo;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 398 import com.dtstack.flink.sql.sink.StreamSinkFactory;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 399 import com.dtstack.flink.sql.source.StreamSourceFactory;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 400 import com.dtstack.flink.sql.table.SourceTableInfo;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 401 import com.dtstack.flink.sql.table.TableInfo;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 402 import com.dtstack.flink.sql.table.TargetTableInfo;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 403 import com.dtstack.flink.sql.util.DtStringUtil;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 404 import com.dtstack.flink.sql.util.PluginUtil;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 405 import com.dtstack.flink.sql.watermarker.WaterMarkerAssigner;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 406 import com.fasterxml.jackson.databind.ObjectMapper;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 407 import com.google.common.base.Preconditions;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 408 import com.google.common.base.Strings;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 409 import com.google.common.collect.Lists;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 410 import com.google.common.collect.Maps;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 411 import com.google.common.collect.Sets;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 412 import org.apache.calcite.sql.SqlInsert;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 413 import org.apache.calcite.sql.SqlNode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 414 import org.apache.commons.io.Charsets;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 415 import org.apache.commons.lang3.StringUtils;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 416 import org.slf4j.Logger;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 417 import org.slf4j.LoggerFactory;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 418 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 419 import java.io.File;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 420 import java.lang.reflect.InvocationTargetException;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 421 import java.net.URL;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 422 import java.net.URLClassLoader;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 423 import java.net.URLDecoder;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 424 import java.util.Arrays;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 425 import java.util.List;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 426 import java.util.Map;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 427 import java.util.Properties;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 428 import java.util.Set;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 429 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 430 /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 431  *  任务执行时的流程方法</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 432  * Date: 2020/2/17</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 433  * Company: www.dtstack.com</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 434  * @author maqi</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 435  */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 436 public class ExecuteProcessHelper {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 437 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 438     private static final String CLASS_FILE_NAME_FMT = &quot;class_path_%d&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 439     private static final Logger LOG = LoggerFactory.getLogger(ExecuteProcessHelper.class);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 440     private static final ObjectMapper OBJECT_MAPPER = new ObjectMapper();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 441 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 442 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 443     public static ParamsInfo parseParams(String[] args) throws Exception {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 444         LOG.info(&quot;------------program params-------------------------&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 445         System.out.println(&quot;------------program params-------------------------&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 446         Arrays.stream(args).forEach(arg -&gt; LOG.info(&quot;{}&quot;, arg));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 447         Arrays.stream(args).forEach(System.out::println);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 448         LOG.info(&quot;-------------------------------------------&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 449         System.out.println(&quot;----------------------------------------&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 450 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 451         OptionParser optionParser = new OptionParser(args);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 452         Options options = optionParser.getOptions();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 453 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 454         String sql = URLDecoder.decode(options.getSql(), Charsets.UTF_8.name());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 455         String name = options.getName();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 456         String localSqlPluginPath = options.getLocalSqlPluginPath();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 457         String remoteSqlPluginPath = options.getRemoteSqlPluginPath();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 458         String pluginLoadMode = options.getPluginLoadMode();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 459         String deployMode = options.getMode();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 460 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 461         Preconditions.checkArgument(checkRemoteSqlPluginPath(remoteSqlPluginPath, deployMode, pluginLoadMode),"> 461         Preconditions.checkArgument(checkRemoteSqlPluginPath(remoteSqlPluginPath, deployMode, pluginLoadM🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 462                 &quot;Non-local mode or shipfile deployment mode, remoteSqlPluginPath is required&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 463         String confProp = URLDecoder.decode(options.getConfProp(), Charsets.UTF_8.toString());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 464         Properties confProperties = PluginUtil.jsonStrToObject(confProp, Properties.class);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 465 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 466         List&lt;URL&gt; jarURList = getExternalJarUrls(options.getAddjar());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 467 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 468         return ParamsInfo.builder()</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 469                 .setSql(sql)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 470                 .setName(name)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 471                 .setLocalSqlPluginPath(localSqlPluginPath)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 472                 .setRemoteSqlPluginPath(remoteSqlPluginPath)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 473                 .setPluginLoadMode(pluginLoadMode)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 474                 .setDeployMode(deployMode)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 475                 .setConfProp(confProperties)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 476                 .setJarUrlList(jarURList)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 477                 .build();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 478 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 479     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 480 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 481     /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 482      *   非local模式或者shipfile部署模式，remoteSqlPluginPath必填</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 483      * @param remoteSqlPluginPath</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 484      * @param deployMode</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 485      * @param pluginLoadMode</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 486      * @return</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 487      */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 488     public static boolean checkRemoteSqlPluginPath(String remoteSqlPluginPath, String deployMode, String pluginLoadMode) {"> 488     public static boolean checkRemoteSqlPluginPath(String remoteSqlPluginPath, String deployMode, String 🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 489         if (StringUtils.isEmpty(remoteSqlPluginPath)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 490             return StringUtils.equalsIgnoreCase(pluginLoadMode, EPluginLoadMode.SHIPFILE.name())</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 491                     || StringUtils.equalsIgnoreCase(deployMode, ClusterMode.local.name());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 492         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 493         return true;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 494     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 495 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 496 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 497     public static StreamExecutionEnvironment getStreamExecution(ParamsInfo paramsInfo) throws Exception {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 498         StreamExecutionEnvironment env = ExecuteProcessHelper.getStreamExeEnv(paramsInfo.getConfProp(), paramsInfo.getDeployMode());"> 498         StreamExecutionEnvironment env = ExecuteProcessHelper.getStreamExeEnv(paramsInfo.getConfProp(), p🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 499         StreamTableEnvironment tableEnv = StreamTableEnvironment.create(env);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 500         StreamQueryConfig streamQueryConfig = StreamEnvConfigManager.getStreamQueryConfig(tableEnv, paramsInfo.getConfProp());"> 500         StreamQueryConfig streamQueryConfig = StreamEnvConfigManager.getStreamQueryConfig(tableEnv, param🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 501 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 502         SqlParser.setLocalSqlPluginRoot(paramsInfo.getLocalSqlPluginPath());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 503         SqlTree sqlTree = SqlParser.parseSql(paramsInfo.getSql());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 504 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 505         Map&lt;String, SideTableInfo&gt; sideTableMap = Maps.newHashMap();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 506         Map&lt;String, Table&gt; registerTableCache = Maps.newHashMap();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 507 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 508         //register udf</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 509         ExecuteProcessHelper.registerUserDefinedFunction(sqlTree, paramsInfo.getJarUrlList(), tableEnv);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 510         //register table schema</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 511         Set&lt;URL&gt; classPathSets = ExecuteProcessHelper.registerTable(sqlTree, env, tableEnv, paramsInfo.getLocalSqlPluginPath(),"> 511         Set&lt;URL&gt; classPathSets = ExecuteProcessHelper.registerTable(sqlTree, env, tableEnv, paramsInfo.ge🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 512                 paramsInfo.getRemoteSqlPluginPath(), paramsInfo.getPluginLoadMode(), sideTableMap, registerTableCache);"> 512                 paramsInfo.getRemoteSqlPluginPath(), paramsInfo.getPluginLoadMode(), sideTableMap, regist🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 513         // cache classPathSets</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 514         ExecuteProcessHelper.registerPluginUrlToCachedFile(env, classPathSets);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 515 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 516         ExecuteProcessHelper.sqlTranslation(paramsInfo.getLocalSqlPluginPath(), tableEnv, sqlTree, sideTableMap, registerTableCache, streamQueryConfig);"> 516         ExecuteProcessHelper.sqlTranslation(paramsInfo.getLocalSqlPluginPath(), tableEnv, sqlTree, sideTa🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 517 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 518         if (env instanceof MyLocalStreamEnvironment) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 519             ((MyLocalStreamEnvironment) env).setClasspaths(ClassLoaderManager.getClassPath());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 520         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 521         return env;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 522     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 523 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 524 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 525     public static List&lt;URL&gt; getExternalJarUrls(String addJarListStr) throws java.io.IOException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 526         List&lt;URL&gt; jarUrlList = Lists.newArrayList();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 527         if (Strings.isNullOrEmpty(addJarListStr)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 528             return jarUrlList;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 529         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 530 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 531         List&lt;String&gt; addJarFileList = OBJECT_MAPPER.readValue(URLDecoder.decode(addJarListStr, Charsets.UTF_8.name()), List.class);"> 531         List&lt;String&gt; addJarFileList = OBJECT_MAPPER.readValue(URLDecoder.decode(addJarListStr, Charsets.U🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 532         //Get External jar to load</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 533         for (String addJarPath : addJarFileList) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 534             jarUrlList.add(new File(addJarPath).toURI().toURL());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 535         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 536         return jarUrlList;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 537     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 538 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 539     private static void sqlTranslation(String localSqlPluginPath,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 540             StreamTableEnvironment tableEnv,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 541             SqlTree sqlTree,Map&lt;String, SideTableInfo&gt; sideTableMap,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 542             Map&lt;String, Table&gt; registerTableCache,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 543             StreamQueryConfig queryConfig) throws Exception {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 544 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 545     	SideSqlExec sideSqlExec = new SideSqlExec();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 546         sideSqlExec.setLocalSqlPluginPath(localSqlPluginPath);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 547         for (CreateTmpTableParser.SqlParserResult result : sqlTree.getTmpSqlList()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 548             sideSqlExec.exec(result.getExecSql(), sideTableMap, tableEnv, registerTableCache, queryConfig, result);"> 548             sideSqlExec.exec(result.getExecSql(), sideTableMap, tableEnv, registerTableCache, queryConfig🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 549         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 550 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 551         for (InsertSqlParser.SqlParseResult result : sqlTree.getExecSqlList()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 552             if (LOG.isInfoEnabled()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 553                 LOG.info(&quot;exe-sql:\n&quot; + result.getExecSql());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 554             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 555             boolean isSide = false;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 556             for (String tableName : result.getTargetTableList()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 557                 if (sqlTree.getTmpTableMap().containsKey(tableName)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 558                     CreateTmpTableParser.SqlParserResult tmp = sqlTree.getTmpTableMap().get(tableName);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 559                     String realSql = DtStringUtil.replaceIgnoreQuota(result.getExecSql(), &quot;`&quot;, &quot;&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 560 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 561                     SqlNode sqlNode = org.apache.calcite.sql.parser.SqlParser.create(realSql, CalciteConfig.MYSQL_LEX_CONFIG).parseStmt();"> 561                     SqlNode sqlNode = org.apache.calcite.sql.parser.SqlParser.create(realSql, CalciteConf🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 562                     String tmpSql = ((SqlInsert) sqlNode).getSource().toString();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 563                     tmp.setExecSql(tmpSql);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 564                     sideSqlExec.exec(tmp.getExecSql(), sideTableMap, tableEnv, registerTableCache, queryConfig, tmp);"> 564                     sideSqlExec.exec(tmp.getExecSql(), sideTableMap, tableEnv, registerTableCache, queryC🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 565                 } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 566                     for (String sourceTable : result.getSourceTableList()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 567                         if (sideTableMap.containsKey(sourceTable)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 568                             isSide = true;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 569                             break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 570                         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 571                     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 572                     if (isSide) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 573                         //sql-dimensional table contains the dimension table of execution</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 574                         sideSqlExec.exec(result.getExecSql(), sideTableMap, tableEnv, registerTableCache, queryConfig, null);"> 574                         sideSqlExec.exec(result.getExecSql(), sideTableMap, tableEnv, registerTableCache,🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 575                     } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 576                         System.out.println(&quot;----------exec sql without dimension join-----------&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 577                         System.out.println(&quot;----------real sql exec is--------------------------&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 578                         System.out.println(result.getExecSql());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 579                         FlinkSQLExec.sqlUpdate(tableEnv, result.getExecSql(), queryConfig);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 580                         if (LOG.isInfoEnabled()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 581                             LOG.info(&quot;exec sql: &quot; + result.getExecSql());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 582                         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 583                     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 584                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 585             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 586         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 587     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 588 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 589     public static void registerUserDefinedFunction(SqlTree sqlTree, List&lt;URL&gt; jarUrlList, TableEnvironment tableEnv)"> 589     public static void registerUserDefinedFunction(SqlTree sqlTree, List&lt;URL&gt; jarUrlList, TableEnvironmen🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 590             throws IllegalAccessException, InvocationTargetException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 591         // udf和tableEnv须由同一个类加载器加载</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 592         ClassLoader levelClassLoader = tableEnv.getClass().getClassLoader();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 593         URLClassLoader classLoader = null;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 594         List&lt;CreateFuncParser.SqlParserResult&gt; funcList = sqlTree.getFunctionList();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 595         for (CreateFuncParser.SqlParserResult funcInfo : funcList) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 596             //classloader</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 597             if (classLoader == null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 598                 classLoader = ClassLoaderManager.loadExtraJar(jarUrlList, (URLClassLoader) levelClassLoader);"> 598                 classLoader = ClassLoaderManager.loadExtraJar(jarUrlList, (URLClassLoader) levelClassLoad🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 599             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 600             FunctionManager.registerUDF(funcInfo.getType(), funcInfo.getClassName(), funcInfo.getName(), tableEnv, classLoader);"> 600             FunctionManager.registerUDF(funcInfo.getType(), funcInfo.getClassName(), funcInfo.getName(), 🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 601         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 602     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 603 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 604     /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 605      *    向Flink注册源表和结果表，返回执行时插件包的全路径</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 606      * @param sqlTree</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 607      * @param env</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 608      * @param tableEnv</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 609      * @param localSqlPluginPath</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 610      * @param remoteSqlPluginPath</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 611      * @param pluginLoadMode   插件加载模式 classpath or shipfile</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 612      * @param sideTableMap</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 613      * @param registerTableCache</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 614      * @return</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 615      * @throws Exception</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 616      */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 617     public static Set&lt;URL&gt; registerTable(SqlTree sqlTree, StreamExecutionEnvironment env, StreamTableEnvironment tableEnv, String localSqlPluginPath,"> 617     public static Set&lt;URL&gt; registerTable(SqlTree sqlTree, StreamExecutionEnvironment env, StreamTableEnvi🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 618                                          String remoteSqlPluginPath, String pluginLoadMode, Map&lt;String, SideTableInfo&gt; sideTableMap, Map&lt;String, Table&gt; registerTableCache) throws Exception {"> 618                                          String remoteSqlPluginPath, String pluginLoadMode, Map&lt;String, S🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 619         Set&lt;URL&gt; pluginClassPatshSets = Sets.newHashSet();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 620         WaterMarkerAssigner waterMarkerAssigner = new WaterMarkerAssigner();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 621         for (TableInfo tableInfo : sqlTree.getTableInfoMap().values()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 622 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 623             if (tableInfo instanceof SourceTableInfo) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 624 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 625                 SourceTableInfo sourceTableInfo = (SourceTableInfo) tableInfo;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 626                 Table table = StreamSourceFactory.getStreamSource(sourceTableInfo, env, tableEnv, localSqlPluginPath);"> 626                 Table table = StreamSourceFactory.getStreamSource(sourceTableInfo, env, tableEnv, localSq🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 627                 tableEnv.registerTable(sourceTableInfo.getAdaptName(), table);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 628                 //Note --- parameter conversion function can not be used inside a function of the type of polymerization"> 628                 //Note --- parameter conversion function can not be used inside a function of the type of🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 629                 //Create table in which the function is arranged only need adaptation sql</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 630                 String adaptSql = sourceTableInfo.getAdaptSelectSql();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 631                 Table adaptTable = adaptSql == null ? table : tableEnv.sqlQuery(adaptSql);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 632 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 633                 RowTypeInfo typeInfo = new RowTypeInfo(adaptTable.getSchema().getFieldTypes(), adaptTable.getSchema().getFieldNames());"> 633                 RowTypeInfo typeInfo = new RowTypeInfo(adaptTable.getSchema().getFieldTypes(), adaptTable🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 634                 DataStream adaptStream = tableEnv.toRetractStream(adaptTable, typeInfo)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 635                         .map((Tuple2&lt;Boolean, Row&gt; f0) -&gt; {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 636                             return f0.f1;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 637                         })</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 638                         .returns(typeInfo);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 639 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 640                 String fields = String.join(&quot;,&quot;, typeInfo.getFieldNames());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 641 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 642                 if (waterMarkerAssigner.checkNeedAssignWaterMarker(sourceTableInfo)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 643                     adaptStream = waterMarkerAssigner.assignWaterMarker(adaptStream, typeInfo, sourceTableInfo);"> 643                     adaptStream = waterMarkerAssigner.assignWaterMarker(adaptStream, typeInfo, sourceTabl🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 644                     fields += &quot;,ROWTIME.ROWTIME&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 645                 } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 646                     fields += &quot;,PROCTIME.PROCTIME&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 647                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 648 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 649                 Table regTable = tableEnv.fromDataStream(adaptStream, fields);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 650                 tableEnv.registerTable(tableInfo.getName(), regTable);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 651                 if (LOG.isInfoEnabled()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 652                     LOG.info(&quot;registe table {} success.&quot;, tableInfo.getName());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 653                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 654                 registerTableCache.put(tableInfo.getName(), regTable);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 655 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 656                 URL sourceTablePathUrl = PluginUtil.buildSourceAndSinkPathByLoadMode(tableInfo.getType(), SourceTableInfo.SOURCE_SUFFIX, localSqlPluginPath, remoteSqlPluginPath, pluginLoadMode);"> 656                 URL sourceTablePathUrl = PluginUtil.buildSourceAndSinkPathByLoadMode(tableInfo.getType(),🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 657                 pluginClassPatshSets.add(sourceTablePathUrl);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 658             } else if (tableInfo instanceof TargetTableInfo) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 659 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 660                 TableSink tableSink = StreamSinkFactory.getTableSink((TargetTableInfo) tableInfo, localSqlPluginPath);"> 660                 TableSink tableSink = StreamSinkFactory.getTableSink((TargetTableInfo) tableInfo, localSq🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 661                 TypeInformation[] flinkTypes = FunctionManager.transformTypes(tableInfo.getFieldClasses());"> 661                 TypeInformation[] flinkTypes = FunctionManager.transformTypes(tableInfo.getFieldClasses()🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 662                 tableEnv.registerTableSink(tableInfo.getName(), tableInfo.getFields(), flinkTypes, tableSink);"> 662                 tableEnv.registerTableSink(tableInfo.getName(), tableInfo.getFields(), flinkTypes, tableS🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 663 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 664                 URL sinkTablePathUrl = PluginUtil.buildSourceAndSinkPathByLoadMode(tableInfo.getType(), TargetTableInfo.TARGET_SUFFIX, localSqlPluginPath, remoteSqlPluginPath, pluginLoadMode);"> 664                 URL sinkTablePathUrl = PluginUtil.buildSourceAndSinkPathByLoadMode(tableInfo.getType(), T🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 665                 pluginClassPatshSets.add(sinkTablePathUrl);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 666             } else if (tableInfo instanceof SideTableInfo) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 667                 String sideOperator = ECacheType.ALL.name().equals(((SideTableInfo) tableInfo).getCacheType()) ? &quot;all&quot; : &quot;async&quot;;"> 667                 String sideOperator = ECacheType.ALL.name().equals(((SideTableInfo) tableInfo).getCacheTy🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 668                 sideTableMap.put(tableInfo.getName(), (SideTableInfo) tableInfo);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 669 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 670                 URL sideTablePathUrl = PluginUtil.buildSidePathByLoadMode(tableInfo.getType(), sideOperator, SideTableInfo.TARGET_SUFFIX, localSqlPluginPath, remoteSqlPluginPath, pluginLoadMode);"> 670                 URL sideTablePathUrl = PluginUtil.buildSidePathByLoadMode(tableInfo.getType(), sideOperat🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 671                 pluginClassPatshSets.add(sideTablePathUrl);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 672             } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 673                 throw new RuntimeException(&quot;not support table type:&quot; + tableInfo.getType());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 674             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 675         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 676         return pluginClassPatshSets;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 677     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 678 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 679     /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 680      *   perjob模式将job依赖的插件包路径存储到cacheFile，在外围将插件包路径传递给jobgraph</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 681      * @param env</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 682      * @param classPathSet</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 683      */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 684     public static void registerPluginUrlToCachedFile(StreamExecutionEnvironment env, Set&lt;URL&gt; classPathSet) {"> 684     public static void registerPluginUrlToCachedFile(StreamExecutionEnvironment env, Set&lt;URL&gt; classPathSe🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 685         int i = 0;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 686         for (URL url : classPathSet) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 687             String classFileName = String.format(CLASS_FILE_NAME_FMT, i);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 688             env.registerCachedFile(url.getPath(), classFileName, true);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 689             i++;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 690         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 691     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 692 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 693     public static StreamExecutionEnvironment getStreamExeEnv(Properties confProperties, String deployMode) throws Exception {"> 693     public static StreamExecutionEnvironment getStreamExeEnv(Properties confProperties, String deployMode🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 694         StreamExecutionEnvironment env = !ClusterMode.local.name().equals(deployMode) ?</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 695                 StreamExecutionEnvironment.getExecutionEnvironment() :</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 696                 new MyLocalStreamEnvironment();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 697 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 698         StreamEnvConfigManager.streamExecutionEnvironmentConfig(env, confProperties);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 699         return env;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 700     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 701 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 702 </span>
 703 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 704 }</pre></td>
                            <td><pre>   1 /*
   2  * Licensed to the Apache Software Foundation (ASF) under one
   3  * or more contributor license agreements.  See the NOTICE file
   4  * distributed with this work for additional information
   5  * regarding copyright ownership.  The ASF licenses this file
   6  * to you under the Apache License, Version 2.0 (the
   7  * &quot;License&quot;); you may not use this file except in compliance
   8  * with the License.  You may obtain a copy of the License at
   9  *
  10  *     http://www.apache.org/licenses/LICENSE-2.0
  11  *
  12  * Unless required by applicable law or agreed to in writing, software
  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15  * See the License for the specific language governing permissions and
  16  * limitations under the License.
  17  */
  18 package com.dtstack.flink.sql.exec;
  19 
  20 import com.aiweiergou.tool.logger.api.ChangeLogLevelProcess;
  21 import com.dtstack.flink.sql.classloader.ClassLoaderManager;
  22 import com.dtstack.flink.sql.config.CalciteConfig;
  23 import com.dtstack.flink.sql.constrant.ConfigConstrant;
  24 import com.dtstack.flink.sql.enums.ClusterMode;
  25 import com.dtstack.flink.sql.enums.ECacheType;
  26 import com.dtstack.flink.sql.enums.EPluginLoadMode;
  27 import com.dtstack.flink.sql.environment.MyLocalStreamEnvironment;
  28 import com.dtstack.flink.sql.environment.StreamEnvConfigManager;
  29 import com.dtstack.flink.sql.function.FunctionManager;
  30 import com.dtstack.flink.sql.option.OptionParser;
  31 import com.dtstack.flink.sql.option.Options;
  32 import com.dtstack.flink.sql.parser.CreateFuncParser;
  33 import com.dtstack.flink.sql.parser.CreateTmpTableParser;
  34 import com.dtstack.flink.sql.parser.InsertSqlParser;
  35 import com.dtstack.flink.sql.parser.SqlParser;
  36 import com.dtstack.flink.sql.parser.SqlTree;
  37 import com.dtstack.flink.sql.side.AbstractSideTableInfo;
  38 import com.dtstack.flink.sql.side.SideSqlExec;
  39 import com.dtstack.flink.sql.side.SideTableInfo;
  40 import com.dtstack.flink.sql.sink.StreamSinkFactory;
  41 import com.dtstack.flink.sql.source.StreamSourceFactory;
  42 import com.dtstack.flink.sql.table.AbstractSourceTableInfo;
  43 import com.dtstack.flink.sql.table.AbstractTableInfo;
  44 import com.dtstack.flink.sql.table.AbstractTargetTableInfo;
  45 import com.dtstack.flink.sql.table.SourceTableInfo;
  46 import com.dtstack.flink.sql.table.TableInfo;
  47 import com.dtstack.flink.sql.table.TargetTableInfo;
  48 import com.dtstack.flink.sql.util.DtStringUtil;
  49 import com.dtstack.flink.sql.util.PluginUtil;
  50 import com.dtstack.flink.sql.watermarker.WaterMarkerAssigner;
  51 import com.fasterxml.jackson.databind.ObjectMapper;
  52 import com.google.common.base.Preconditions;
  53 import com.google.common.base.Strings;
  54 import com.google.common.collect.Lists;
  55 import com.google.common.collect.Maps;
  56 import com.google.common.collect.Sets;
  57 import java.io.File;
  58 import java.lang.reflect.InvocationTargetException;
  59 import java.net.URL;
  60 import java.net.URLClassLoader;
  61 import java.net.URLDecoder;
  62 import java.util.Arrays;
  63 import java.util.List;
  64 import java.util.Map;
  65 import java.util.Properties;
  66 import java.util.Set;
  67 import org.apache.calcite.sql.SqlInsert;
  68 import org.apache.calcite.sql.SqlNode;
  69 import org.apache.commons.io.Charsets;
  70 import org.apache.commons.lang3.StringUtils;
  71 import org.apache.flink.api.common.typeinfo.TypeInformation;
  72 import org.apache.flink.api.java.tuple.Tuple2;
  73 import org.apache.flink.api.java.typeutils.RowTypeInfo;
  74 import org.apache.flink.streaming.api.datastream.DataStream;
  75 import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;
  76 import org.apache.flink.table.api.StreamQueryConfig;
  77 import org.apache.flink.table.api.Table;
  78 import org.apache.flink.table.api.TableEnvironment;
  79 import org.apache.flink.table.api.java.StreamTableEnvironment;
  80 import org.apache.flink.table.sinks.TableSink;
  81 import org.apache.flink.types.Row;
  82 import org.slf4j.Logger;
  83 import org.slf4j.LoggerFactory;
  84 
  85 
  86 /**
  87  *  任务执行时的流程方法
  88  * Date: 2020/2/17
  89  * Company: www.dtstack.com
  90  * @author maqi
  91  */
  92 public class ExecuteProcessHelper {
  93     private static final String CLASS_FILE_NAME_FMT = &quot;class_path_%d&quot;;
  94 
  95     private static final Logger LOG = LoggerFactory.getLogger(ExecuteProcessHelper.class);
  96 
  97     private static final ObjectMapper OBJECT_MAPPER = new ObjectMapper();
  98 
  99     public static ParamsInfo parseParams(String[] args) throws Exception {
 100         LOG.info(&quot;------------program params-------------------------&quot;);
 101         System.out.println(&quot;------------program params-------------------------&quot;);
 102         Arrays.stream(args).forEach(( arg) -&gt; LOG.info(&quot;{}&quot;, arg));
 103         Arrays.stream(args).forEach(System.out::println);
 104         LOG.info(&quot;-------------------------------------------&quot;);
 105         System.out.println(&quot;----------------------------------------&quot;);
 106         OptionParser optionParser = new OptionParser(args);
 107         Options options = optionParser.getOptions();
 108         String sql = URLDecoder.decode(options.getSql(), Charsets.UTF_8.name());
 109         String name = options.getName();
 110         String localSqlPluginPath = options.getLocalSqlPluginPath();
 111         String remoteSqlPluginPath = options.getRemoteSqlPluginPath();
 112         String pluginLoadMode = options.getPluginLoadMode();
 113         String deployMode = options.getMode();
 114         String logLevel = options.getLogLevel();
<abbr title=" 115         Preconditions.checkArgument(checkRemoteSqlPluginPath(remoteSqlPluginPath, deployMode, pluginLoadMode), &quot;Non-local mode or shipfile deployment mode, remoteSqlPluginPath is required&quot;);"> 115         Preconditions.checkArgument(checkRemoteSqlPluginPath(remoteSqlPluginPath, deployMode, pluginLoadM🔵</abbr>
 116         String confProp = URLDecoder.decode(options.getConfProp(), Charsets.UTF_8.toString());
 117         Properties confProperties = PluginUtil.jsonStrToObject(confProp, Properties.class);
 118 
 119 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 120         List&lt;URL&gt; jarUrlList = getExternalJarUrls(options.getAddjar());</span>
 121 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 122 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 122 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kw🔵</abbr></span>
 123 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 124 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 125         List&lt;URL&gt; jarURList = getExternalJarUrls(options.getAddjar());</span>
 126 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 127 
<abbr title=" 128         return ParamsInfo.builder().setSql(sql).setName(name).setLocalSqlPluginPath(localSqlPluginPath).setRemoteSqlPluginPath(remoteSqlPluginPath).setPluginLoadMode(pluginLoadMode).setDeployMode(deployMode).setConfProp(confProperties).setJarUrlList("> 128         return ParamsInfo.builder().setSql(sql).setName(name).setLocalSqlPluginPath(localSqlPluginPath).s🔵</abbr>
 129 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 130 jarUrlList</span>
 131 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 132 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 132 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kw🔵</abbr></span>
 133 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 134 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 135 jarURList</span>
 136 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 137         ).build();
 138     }
 139 
 140     /**
 141      * 非local模式或者shipfile部署模式，remoteSqlPluginPath必填
 142      *
 143      * @param remoteSqlPluginPath
 144      *
 145      * @param deployMode
 146      *
 147      * @param pluginLoadMode
 148      *
 149      * @return
 150      */
<abbr title=" 151     public static boolean checkRemoteSqlPluginPath(String remoteSqlPluginPath, String deployMode, String pluginLoadMode) {"> 151     public static boolean checkRemoteSqlPluginPath(String remoteSqlPluginPath, String deployMode, String 🔵</abbr>
 152         if (StringUtils.isEmpty(remoteSqlPluginPath)) {
<abbr title=" 153             return StringUtils.equalsIgnoreCase(pluginLoadMode, EPluginLoadMode.SHIPFILE.name()) || StringUtils.equalsIgnoreCase(deployMode, ClusterMode.local.name());"> 153             return StringUtils.equalsIgnoreCase(pluginLoadMode, EPluginLoadMode.SHIPFILE.name()) || Strin🔵</abbr>
 154         }
 155         return true;
 156     }
 157 
 158     public static StreamExecutionEnvironment getStreamExecution(ParamsInfo paramsInfo) throws Exception {
<abbr title=" 159         StreamExecutionEnvironment env = ExecuteProcessHelper.getStreamExeEnv(paramsInfo.getConfProp(), paramsInfo.getDeployMode());"> 159         StreamExecutionEnvironment env = ExecuteProcessHelper.getStreamExeEnv(paramsInfo.getConfProp(), p🔵</abbr>
 160         StreamTableEnvironment tableEnv = StreamTableEnvironment.create(env);
<abbr title=" 161         StreamQueryConfig streamQueryConfig = StreamEnvConfigManager.getStreamQueryConfig(tableEnv, paramsInfo.getConfProp());"> 161         StreamQueryConfig streamQueryConfig = StreamEnvConfigManager.getStreamQueryConfig(tableEnv, param🔵</abbr>
 162         SqlParser.setLocalSqlPluginRoot(paramsInfo.getLocalSqlPluginPath());
 163         SqlTree sqlTree = SqlParser.parseSql(paramsInfo.getSql());
 164         Map&lt;String,
 165 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 166 AbstractSideTableInfo</span>
 167 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 168 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 168 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kw🔵</abbr></span>
 169 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 170 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 171 SideTableInfo</span>
 172 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 173         &gt; sideTableMap = Maps.newHashMap();
 174         Map&lt;String, Table&gt; registerTableCache = Maps.newHashMap();
 175         //register udf
 176         ExecuteProcessHelper.registerUserDefinedFunction(sqlTree, paramsInfo.getJarUrlList(), tableEnv);
 177         //register table schema
<abbr title=" 178         Set&lt;URL&gt; classPathSets = ExecuteProcessHelper.registerTable(sqlTree, env, tableEnv, paramsInfo.getLocalSqlPluginPath(), paramsInfo.getRemoteSqlPluginPath(), paramsInfo.getPluginLoadMode(), sideTableMap, registerTableCache);"> 178         Set&lt;URL&gt; classPathSets = ExecuteProcessHelper.registerTable(sqlTree, env, tableEnv, paramsInfo.ge🔵</abbr>
 179         // cache classPathSets
 180         ExecuteProcessHelper.registerPluginUrlToCachedFile(env, classPathSets);
<abbr title=" 181         ExecuteProcessHelper.sqlTranslation(paramsInfo.getLocalSqlPluginPath(), tableEnv, sqlTree, sideTableMap, registerTableCache, streamQueryConfig);"> 181         ExecuteProcessHelper.sqlTranslation(paramsInfo.getLocalSqlPluginPath(), tableEnv, sqlTree, sideTa🔵</abbr>
 182         if (env instanceof MyLocalStreamEnvironment) {
 183             ((MyLocalStreamEnvironment) (env)).setClasspaths(ClassLoaderManager.getClassPath());
 184         }
 185         return env;
 186     }
 187 
 188     public static List&lt;URL&gt; getExternalJarUrls(String addJarListStr) throws java.io.IOException {
 189         List&lt;URL&gt; jarUrlList = Lists.newArrayList();
 190         if (Strings.isNullOrEmpty(addJarListStr)) {
 191             return jarUrlList;
 192         }
<abbr title=" 193         List&lt;String&gt; addJarFileList = OBJECT_MAPPER.readValue(URLDecoder.decode(addJarListStr, Charsets.UTF_8.name()), List.class);"> 193         List&lt;String&gt; addJarFileList = OBJECT_MAPPER.readValue(URLDecoder.decode(addJarListStr, Charsets.U🔵</abbr>
 194         //Get External jar to load
 195         for (String addJarPath : addJarFileList) {
 196             jarUrlList.add(new File(addJarPath).toURI().toURL());
 197         }
 198         return jarUrlList;
 199     }
 200 
<abbr title=" 201     private static void sqlTranslation(String localSqlPluginPath, StreamTableEnvironment tableEnv, SqlTree sqlTree, Map&lt;String,"> 201     private static void sqlTranslation(String localSqlPluginPath, StreamTableEnvironment tableEnv, SqlTre🔵</abbr>
 202 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 203 AbstractSideTableInfo</span>
 204 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 205 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 205 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kw🔵</abbr></span>
 206 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 207 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 208 SideTableInfo</span>
 209 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
<abbr title=" 210     &gt; sideTableMap, Map&lt;String, Table&gt; registerTableCache, StreamQueryConfig queryConfig) throws Exception {"> 210     &gt; sideTableMap, Map&lt;String, Table&gt; registerTableCache, StreamQueryConfig queryConfig) throws Exceptio🔵</abbr>
 211         SideSqlExec sideSqlExec = new SideSqlExec();
 212         sideSqlExec.setLocalSqlPluginPath(localSqlPluginPath);
 213         for (CreateTmpTableParser.SqlParserResult result : sqlTree.getTmpSqlList()) {
<abbr title=" 214             sideSqlExec.exec(result.getExecSql(), sideTableMap, tableEnv, registerTableCache, queryConfig, result);"> 214             sideSqlExec.exec(result.getExecSql(), sideTableMap, tableEnv, registerTableCache, queryConfig🔵</abbr>
 215         }
 216         for (InsertSqlParser.SqlParseResult result : sqlTree.getExecSqlList()) {
 217             if (LOG.isInfoEnabled()) {
 218                 LOG.info(&quot;exe-sql:\n&quot; + result.getExecSql());
 219             }
 220             boolean isSide = false;
 221             for (String tableName : result.getTargetTableList()) {
 222                 if (sqlTree.getTmpTableMap().containsKey(tableName)) {
 223                     CreateTmpTableParser.SqlParserResult tmp = sqlTree.getTmpTableMap().get(tableName);
 224                     String realSql = DtStringUtil.replaceIgnoreQuota(result.getExecSql(), &quot;`&quot;, &quot;&quot;);
<abbr title=" 225                     SqlNode sqlNode = org.apache.calcite.sql.parser.SqlParser.create(realSql, CalciteConfig.MYSQL_LEX_CONFIG).parseStmt();"> 225                     SqlNode sqlNode = org.apache.calcite.sql.parser.SqlParser.create(realSql, CalciteConf🔵</abbr>
 226                     String tmpSql = ((SqlInsert) (sqlNode)).getSource().toString();
 227                     tmp.setExecSql(tmpSql);
<abbr title=" 228                     sideSqlExec.exec(tmp.getExecSql(), sideTableMap, tableEnv, registerTableCache, queryConfig, tmp);"> 228                     sideSqlExec.exec(tmp.getExecSql(), sideTableMap, tableEnv, registerTableCache, queryC🔵</abbr>
 229                 } else {
 230                     for (String sourceTable : result.getSourceTableList()) {
 231                         if (sideTableMap.containsKey(sourceTable)) {
 232                             isSide = true;
 233                             break;
 234                         }
 235                     }
 236                     if (isSide) {
 237                         // sql-dimensional table contains the dimension table of execution
<abbr title=" 238                         sideSqlExec.exec(result.getExecSql(), sideTableMap, tableEnv, registerTableCache, queryConfig, null);"> 238                         sideSqlExec.exec(result.getExecSql(), sideTableMap, tableEnv, registerTableCache,🔵</abbr>
 239                     } else {
 240                         System.out.println(&quot;----------exec sql without dimension join-----------&quot;);
 241                         System.out.println(&quot;----------real sql exec is--------------------------&quot;);
 242                         System.out.println(result.getExecSql());
 243                         FlinkSQLExec.sqlUpdate(tableEnv, result.getExecSql(), queryConfig);
 244                         if (LOG.isInfoEnabled())
 245 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 246 {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 247                             System.out.println();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 248                             LOG.info(&quot;exec sql: &quot; + result.getExecSql());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 249                         }</span>
 250 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 251 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 251 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kw🔵</abbr></span>
 252 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 253 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 254 {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 255                             LOG.info(&quot;exec sql: &quot; + result.getExecSql());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 256                         }</span>
 257 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 258 
 259                     }
 260                 }
 261             }
 262         }
 263     }
 264 
<abbr title=" 265     public static void registerUserDefinedFunction(SqlTree sqlTree, List&lt;URL&gt; jarUrlList, TableEnvironment tableEnv) throws IllegalAccessException, InvocationTargetException {"> 265     public static void registerUserDefinedFunction(SqlTree sqlTree, List&lt;URL&gt; jarUrlList, TableEnvironmen🔵</abbr>
 266         // udf和tableEnv须由同一个类加载器加载
 267         ClassLoader levelClassLoader = tableEnv.getClass().getClassLoader();
 268         URLClassLoader classLoader = null;
 269         List&lt;CreateFuncParser.SqlParserResult&gt; funcList = sqlTree.getFunctionList();
 270         for (CreateFuncParser.SqlParserResult funcInfo : funcList) {
 271             // classloader
 272             if (classLoader == null) {
<abbr title=" 273                 classLoader = ClassLoaderManager.loadExtraJar(jarUrlList, ((URLClassLoader) (levelClassLoader)));"> 273                 classLoader = ClassLoaderManager.loadExtraJar(jarUrlList, ((URLClassLoader) (levelClassLo🔵</abbr>
 274             }
<abbr title=" 275             FunctionManager.registerUDF(funcInfo.getType(), funcInfo.getClassName(), funcInfo.getName(), tableEnv, classLoader);"> 275             FunctionManager.registerUDF(funcInfo.getType(), funcInfo.getClassName(), funcInfo.getName(), 🔵</abbr>
 276         }
 277     }
 278 
 279     /**
 280      *   perjob模式将job依赖的插件包路径存储到cacheFile，在外围将插件包路径传递给jobgraph
 281      * @param env
 282      * @param classPathSet
 283      */
<abbr title=" 284     public static void registerPluginUrlToCachedFile(StreamExecutionEnvironment env, Set&lt;URL&gt; classPathSet) {"> 284     public static void registerPluginUrlToCachedFile(StreamExecutionEnvironment env, Set&lt;URL&gt; classPathSe🔵</abbr>
 285         int i = 0;
 286         for (URL url : classPathSet) {
 287             String classFileName = String.format(CLASS_FILE_NAME_FMT, i);
 288             env.registerCachedFile(url.getPath(), classFileName, true);
 289             i++;
 290         }
 291     }
 292 
<abbr title=" 293     public static StreamExecutionEnvironment getStreamExeEnv(Properties confProperties, String deployMode) throws Exception {"> 293     public static StreamExecutionEnvironment getStreamExeEnv(Properties confProperties, String deployMode🔵</abbr>
<abbr title=" 294         StreamExecutionEnvironment env = (!ClusterMode.local.name().equals(deployMode)) ? StreamExecutionEnvironment.getExecutionEnvironment() : new MyLocalStreamEnvironment();"> 294         StreamExecutionEnvironment env = (!ClusterMode.local.name().equals(deployMode)) ? StreamExecution🔵</abbr>
 295         StreamEnvConfigManager.streamExecutionEnvironmentConfig(env, confProperties);
 296         return env;
 297     }
 298 
 299     public static void setLogLevel(ParamsInfo paramsInfo){
 300         String logLevel = paramsInfo.getConfProp().getProperty(ConfigConstrant.LOG_LEVEL_KEY);
 301         if(org.apache.commons.lang3.StringUtils.isBlank(logLevel)){
 302             return;
 303         }
 304         ChangeLogLevelProcess logLevelProcess = new ChangeLogLevelProcess();
 305         logLevelProcess.process(logLevel);
 306     }
 307 
 308     /**
 309      * 向Flink注册源表和结果表，返回执行时插件包的全路径
 310      *
 311      * @param sqlTree
 312      *
 313      * @param env
 314      *
 315      * @param tableEnv
 316      *
 317      * @param localSqlPluginPath
 318      *
 319      * @param remoteSqlPluginPath
 320      *
 321      * @param pluginLoadMode
 322      * 		插件加载模式 classpath or shipfile
 323      * @param sideTableMap
 324      *
 325      * @param registerTableCache
 326      *
 327      * @return
 328      * @throws Exception
 329      *
 330      */
<abbr title=" 331     public static Set&lt;URL&gt; registerTable(SqlTree sqlTree, StreamExecutionEnvironment env, StreamTableEnvironment tableEnv, String localSqlPluginPath, String remoteSqlPluginPath, String pluginLoadMode, Map&lt;String,"> 331     public static Set&lt;URL&gt; registerTable(SqlTree sqlTree, StreamExecutionEnvironment env, StreamTableEnvi🔵</abbr>
 332 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 333 AbstractSideTableInfo</span>
 334 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 335 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 335 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kw🔵</abbr></span>
 336 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 337 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 338 SideTableInfo</span>
 339 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 340     &gt; sideTableMap, Map&lt;String, Table&gt; registerTableCache) throws Exception {
 341         Set&lt;URL&gt; pluginClassPatshSets = Sets.newHashSet();
 342         WaterMarkerAssigner waterMarkerAssigner = new WaterMarkerAssigner();
 343         for (
 344 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 345 AbstractTableInfo</span>
 346 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 347 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 347 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kw🔵</abbr></span>
 348 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 349 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 350 TableInfo</span>
 351 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 352          tableInfo : sqlTree.getTableInfoMap().values()) {
 353             if (tableInfo instanceof
 354 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 355 AbstractSourceTableInfo</span>
 356 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 357 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 357 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kw🔵</abbr></span>
 358 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 359 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 360 SourceTableInfo</span>
 361 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 362             ) {
 363 
 364 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 365 AbstractSourceTableInfo</span>
 366 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 367 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 367 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kw🔵</abbr></span>
 368 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 369 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 370 SourceTableInfo</span>
 371 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 372                  sourceTableInfo = ((
 373 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 374 AbstractSourceTableInfo</span>
 375 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 376 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 376 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kw🔵</abbr></span>
 377 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 378 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 379 SourceTableInfo</span>
 380 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 381                 ) (tableInfo));
<abbr title=" 382                 Table table = StreamSourceFactory.getStreamSource(sourceTableInfo, env, tableEnv, localSqlPluginPath);"> 382                 Table table = StreamSourceFactory.getStreamSource(sourceTableInfo, env, tableEnv, localSq🔵</abbr>
 383                 tableEnv.registerTable(sourceTableInfo.getAdaptName(), table);
<abbr title=" 384                 // Note --- parameter conversion function can not be used inside a function of the type of polymerization"> 384                 // Note --- parameter conversion function can not be used inside a function of the type o🔵</abbr>
 385                 // Create table in which the function is arranged only need adaptation sql
 386                 String adaptSql = sourceTableInfo.getAdaptSelectSql();
 387                 Table adaptTable = (adaptSql == null) ? table : tableEnv.sqlQuery(adaptSql);
<abbr title=" 388                 RowTypeInfo typeInfo = new RowTypeInfo(adaptTable.getSchema().getFieldTypes(), adaptTable.getSchema().getFieldNames());"> 388                 RowTypeInfo typeInfo = new RowTypeInfo(adaptTable.getSchema().getFieldTypes(), adaptTable🔵</abbr>
<abbr title=" 389                 DataStream adaptStream = tableEnv.toRetractStream(adaptTable, typeInfo).map((Tuple2&lt;Boolean, Row&gt; f0) -&gt; {"> 389                 DataStream adaptStream = tableEnv.toRetractStream(adaptTable, typeInfo).map((Tuple2&lt;Boole🔵</abbr>
 390                     return f0.f1;
 391                 }).returns(typeInfo);
 392                 String fields = String.join(&quot;,&quot;, typeInfo.getFieldNames());
 393                 if (waterMarkerAssigner.checkNeedAssignWaterMarker(sourceTableInfo)) {
<abbr title=" 394                     adaptStream = waterMarkerAssigner.assignWaterMarker(adaptStream, typeInfo, sourceTableInfo);"> 394                     adaptStream = waterMarkerAssigner.assignWaterMarker(adaptStream, typeInfo, sourceTabl🔵</abbr>
 395                     fields += &quot;,ROWTIME.ROWTIME&quot;;
 396                 } else {
 397                     fields += &quot;,PROCTIME.PROCTIME&quot;;
 398                 }
 399                 Table regTable = tableEnv.fromDataStream(adaptStream, fields);
 400                 tableEnv.registerTable(tableInfo.getName(), regTable);
 401                 if (LOG.isInfoEnabled()) {
 402                     LOG.info(&quot;registe table {} success.&quot;, tableInfo.getName());
 403                 }
 404                 registerTableCache.put(tableInfo.getName(), regTable);
 405                 URL sourceTablePathUrl = PluginUtil.buildSourceAndSinkPathByLoadMode(tableInfo.getType(),
 406 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 407 AbstractSourceTableInfo</span>
 408 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 409 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 409 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kw🔵</abbr></span>
 410 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 411 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 412 SourceTableInfo</span>
 413 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 414                 .SOURCE_SUFFIX, localSqlPluginPath, remoteSqlPluginPath, pluginLoadMode);
 415                 pluginClassPatshSets.add(sourceTablePathUrl);
 416             } else if (tableInfo instanceof
 417 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 418 AbstractTargetTableInfo</span>
 419 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 420 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 420 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kw🔵</abbr></span>
 421 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 422 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 423 TargetTableInfo</span>
 424 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 425             ) {
 426                 TableSink tableSink = StreamSinkFactory.getTableSink(((
 427 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 428 AbstractTargetTableInfo</span>
 429 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 430 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 430 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kw🔵</abbr></span>
 431 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 432 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 433 TargetTableInfo</span>
 434 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 435                 ) (tableInfo)), localSqlPluginPath);
<abbr title=" 436                 TypeInformation[] flinkTypes = FunctionManager.transformTypes(tableInfo.getFieldClasses());"> 436                 TypeInformation[] flinkTypes = FunctionManager.transformTypes(tableInfo.getFieldClasses()🔵</abbr>
<abbr title=" 437                 tableEnv.registerTableSink(tableInfo.getName(), tableInfo.getFields(), flinkTypes, tableSink);"> 437                 tableEnv.registerTableSink(tableInfo.getName(), tableInfo.getFields(), flinkTypes, tableS🔵</abbr>
 438                 URL sinkTablePathUrl = PluginUtil.buildSourceAndSinkPathByLoadMode(tableInfo.getType(),
 439 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 440 AbstractTargetTableInfo</span>
 441 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 442 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 442 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kw🔵</abbr></span>
 443 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 444 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 445 TargetTableInfo</span>
 446 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 447                 .TARGET_SUFFIX, localSqlPluginPath, remoteSqlPluginPath, pluginLoadMode);
 448                 pluginClassPatshSets.add(sinkTablePathUrl);
 449             } else if (tableInfo instanceof
 450 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 451 AbstractSideTableInfo</span>
 452 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 453 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 453 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kw🔵</abbr></span>
 454 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 455 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 456 SideTableInfo</span>
 457 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 458             ) {
 459                 String sideOperator = (ECacheType.ALL.name().equals(((
 460 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 461 AbstractSideTableInfo</span>
 462 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 463 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 463 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kw🔵</abbr></span>
 464 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 465 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 466 SideTableInfo</span>
 467 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 468                 ) (tableInfo)).getCacheType())) ? &quot;all&quot; : &quot;async&quot;;
 469                 sideTableMap.put(tableInfo.getName(), ((
 470 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 471 AbstractSideTableInfo</span>
 472 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 473 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 473 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kw🔵</abbr></span>
 474 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 475 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 476 SideTableInfo</span>
 477 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 478                 ) (tableInfo)));
<abbr title=" 479                 URL sideTablePathUrl = PluginUtil.buildSidePathByLoadMode(tableInfo.getType(), sideOperator,"> 479                 URL sideTablePathUrl = PluginUtil.buildSidePathByLoadMode(tableInfo.getType(), sideOperat🔵</abbr>
 480 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 481 AbstractSideTableInfo</span>
 482 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 483 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 483 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kw🔵</abbr></span>
 484 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 485 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 486 SideTableInfo</span>
 487 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 488                 .TARGET_SUFFIX, localSqlPluginPath, remoteSqlPluginPath, pluginLoadMode);
 489                 pluginClassPatshSets.add(sideTablePathUrl);
 490             } else {
 491                 throw new RuntimeException(&quot;not support table type:&quot; + tableInfo.getType());
 492             }
 493         }
 494         return pluginClassPatshSets;
 495     }
 496 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre><span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   1 +/*</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   2 + * Licensed to the Apache Software Foundation (ASF) under one</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   3 + * or more contributor license agreements.  See the NOTICE file</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   4 + * distributed with this work for additional information</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   5 + * regarding copyright ownership.  The ASF licenses this file</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   6 + * to you under the Apache License, Version 2.0 (the</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   7 + * &quot;License&quot;); you may not use this file except in compliance</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   8 + * with the License.  You may obtain a copy of the License at</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   9 + *</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  10 + *     http://www.apache.org/licenses/LICENSE-2.0</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  11 + *</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  12 + * Unless required by applicable law or agreed to in writing, software</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  13 + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  14 + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  15 + * See the License for the specific language governing permissions and</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  16 + * limitations under the License.</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  17 + */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  18 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  19 +package com.dtstack.flink.sql.exec;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  20 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  21 +import com.aiweiergou.tool.logger.api.ChangeLogLevelProcess;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  22 +import com.dtstack.flink.sql.classloader.ClassLoaderManager;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  23 +import com.dtstack.flink.sql.config.CalciteConfig;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  24 +import com.dtstack.flink.sql.constrant.ConfigConstrant;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  25 +import com.dtstack.flink.sql.enums.ClusterMode;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  26 +import com.dtstack.flink.sql.enums.ECacheType;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  27 +import com.dtstack.flink.sql.enums.EPluginLoadMode;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  28 +import com.dtstack.flink.sql.environment.MyLocalStreamEnvironment;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  29 +import com.dtstack.flink.sql.environment.StreamEnvConfigManager;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  30 +import com.dtstack.flink.sql.function.FunctionManager;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  31 +import com.dtstack.flink.sql.option.OptionParser;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  32 +import com.dtstack.flink.sql.option.Options;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  33 +import com.dtstack.flink.sql.parser.CreateFuncParser;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  34 +import com.dtstack.flink.sql.parser.CreateTmpTableParser;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  35 +import com.dtstack.flink.sql.parser.InsertSqlParser;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  36 +import com.dtstack.flink.sql.parser.SqlParser;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  37 +import com.dtstack.flink.sql.parser.SqlTree;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  38 +import com.dtstack.flink.sql.side.SideSqlExec;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  39 +import com.dtstack.flink.sql.side.AbstractSideTableInfo;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  40 +import com.dtstack.flink.sql.sink.StreamSinkFactory;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  41 +import com.dtstack.flink.sql.source.StreamSourceFactory;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  42 +import com.dtstack.flink.sql.table.AbstractSourceTableInfo;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  43 +import com.dtstack.flink.sql.table.AbstractTableInfo;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  44 +import com.dtstack.flink.sql.table.AbstractTargetTableInfo;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  45 +import com.dtstack.flink.sql.util.DtStringUtil;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  46 +import com.dtstack.flink.sql.util.PluginUtil;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  47 +import com.dtstack.flink.sql.watermarker.WaterMarkerAssigner;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  48 +import com.fasterxml.jackson.databind.ObjectMapper;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  49 +import com.google.common.base.Preconditions;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  50 +import com.google.common.base.Strings;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  51 +import com.google.common.collect.Lists;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  52 +import com.google.common.collect.Maps;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  53 +import com.google.common.collect.Sets;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  54 +import org.apache.calcite.sql.SqlInsert;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  55 +import org.apache.calcite.sql.SqlNode;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  56 +import org.apache.commons.io.Charsets;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  57 +import org.apache.commons.lang3.StringUtils;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  58 +import org.apache.flink.api.common.typeinfo.TypeInformation;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  59 +import org.apache.flink.api.java.tuple.Tuple2;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  60 +import org.apache.flink.api.java.typeutils.RowTypeInfo;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  61 +import org.apache.flink.streaming.api.datastream.DataStream;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  62 +import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  63 +import org.apache.flink.table.api.StreamQueryConfig;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  64 +import org.apache.flink.table.api.Table;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  65 +import org.apache.flink.table.api.TableEnvironment;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  66 +import org.apache.flink.table.api.java.StreamTableEnvironment;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  67 +import org.apache.flink.table.sinks.TableSink;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  68 +import org.apache.flink.types.Row;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  69 +import org.slf4j.Logger;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  70 +import org.slf4j.LoggerFactory;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  71 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  72 +import java.io.File;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  73 +import java.lang.reflect.InvocationTargetException;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  74 +import java.net.URL;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  75 +import java.net.URLClassLoader;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  76 +import java.net.URLDecoder;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  77 +import java.util.Arrays;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  78 +import java.util.List;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  79 +import java.util.Map;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  80 +import java.util.Properties;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  81 +import java.util.Set;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  82 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  83 +/**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  84 + *  任务执行时的流程方法</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  85 + * Date: 2020/2/17</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  86 + * Company: www.dtstack.com</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  87 + * @author maqi</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  88 + */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  89 +public class ExecuteProcessHelper {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  90 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  91 +    private static final String CLASS_FILE_NAME_FMT = &quot;class_path_%d&quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  92 +    private static final Logger LOG = LoggerFactory.getLogger(ExecuteProcessHelper.class);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  93 +    private static final ObjectMapper OBJECT_MAPPER = new ObjectMapper();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  94 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  95 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  96 +    public static ParamsInfo parseParams(String[] args) throws Exception {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  97 +        LOG.info(&quot;------------program params-------------------------&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  98 +        System.out.println(&quot;------------program params-------------------------&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  99 +        Arrays.stream(args).forEach(arg -&gt; LOG.info(&quot;{}&quot;, arg));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 100 +        Arrays.stream(args).forEach(System.out::println);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 101 +        LOG.info(&quot;-------------------------------------------&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 102 +        System.out.println(&quot;----------------------------------------&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 103 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 104 +        OptionParser optionParser = new OptionParser(args);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 105 +        Options options = optionParser.getOptions();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 106 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 107 +        String sql = URLDecoder.decode(options.getSql(), Charsets.UTF_8.name());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 108 +        String name = options.getName();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 109 +        String localSqlPluginPath = options.getLocalSqlPluginPath();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 110 +        String remoteSqlPluginPath = options.getRemoteSqlPluginPath();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 111 +        String pluginLoadMode = options.getPluginLoadMode();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 112 +        String deployMode = options.getMode();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 113 +        String logLevel = options.getLogLevel();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 114 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 115 +        Preconditions.checkArgument(checkRemoteSqlPluginPath(remoteSqlPluginPath, deployMode, pluginLoadMode),</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 116 +                &quot;Non-local mode or shipfile deployment mode, remoteSqlPluginPath is required&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 117 +        String confProp = URLDecoder.decode(options.getConfProp(), Charsets.UTF_8.toString());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 118 +        Properties confProperties = PluginUtil.jsonStrToObject(confProp, Properties.class);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 119 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 120 +        List&lt;URL&gt; jarUrlList = getExternalJarUrls(options.getAddjar());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 121 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 122 +        return ParamsInfo.builder()</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 123 +                .setSql(sql)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 124 +                .setName(name)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 125 +                .setLocalSqlPluginPath(localSqlPluginPath)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 126 +                .setRemoteSqlPluginPath(remoteSqlPluginPath)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 127 +                .setPluginLoadMode(pluginLoadMode)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 128 +                .setDeployMode(deployMode)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 129 +                .setConfProp(confProperties)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 130 +                .setJarUrlList(jarUrlList)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 131 +                .build();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 132 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 133 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 134 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 135 +    /**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 136 +     *   非local模式或者shipfile部署模式，remoteSqlPluginPath必填</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 137 +     * @param remoteSqlPluginPath</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 138 +     * @param deployMode</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 139 +     * @param pluginLoadMode</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 140 +     * @return</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 141 +     */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 142 +    public static boolean checkRemoteSqlPluginPath(String remoteSqlPluginPath, String deployMode, String pluginLoadMode) {"> 142 +    public static boolean checkRemoteSqlPluginPath(String remoteSqlPluginPath, String deployMode, String pluginLoa🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 143 +        if (StringUtils.isEmpty(remoteSqlPluginPath)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 144 +            return StringUtils.equalsIgnoreCase(pluginLoadMode, EPluginLoadMode.SHIPFILE.name())</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 145 +                    || StringUtils.equalsIgnoreCase(deployMode, ClusterMode.local.name());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 146 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 147 +        return true;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 148 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 149 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 150 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 151 +    public static StreamExecutionEnvironment getStreamExecution(ParamsInfo paramsInfo) throws Exception {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 152 +        StreamExecutionEnvironment env = ExecuteProcessHelper.getStreamExeEnv(paramsInfo.getConfProp(), paramsInfo.getDeployMode());"> 152 +        StreamExecutionEnvironment env = ExecuteProcessHelper.getStreamExeEnv(paramsInfo.getConfProp(), paramsInfo🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 153 +        StreamTableEnvironment tableEnv = StreamTableEnvironment.create(env);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 154 +        StreamQueryConfig streamQueryConfig = StreamEnvConfigManager.getStreamQueryConfig(tableEnv, paramsInfo.getConfProp());"> 154 +        StreamQueryConfig streamQueryConfig = StreamEnvConfigManager.getStreamQueryConfig(tableEnv, paramsInfo.get🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 155 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 156 +        SqlParser.setLocalSqlPluginRoot(paramsInfo.getLocalSqlPluginPath());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 157 +        SqlTree sqlTree = SqlParser.parseSql(paramsInfo.getSql());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 158 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 159 +        Map&lt;String, AbstractSideTableInfo&gt; sideTableMap = Maps.newHashMap();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 160 +        Map&lt;String, Table&gt; registerTableCache = Maps.newHashMap();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 161 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 162 +        //register udf</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 163 +        ExecuteProcessHelper.registerUserDefinedFunction(sqlTree, paramsInfo.getJarUrlList(), tableEnv);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 164 +        //register table schema</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 165 +        Set&lt;URL&gt; classPathSets = ExecuteProcessHelper.registerTable(sqlTree, env, tableEnv, paramsInfo.getLocalSqlPluginPath(),"> 165 +        Set&lt;URL&gt; classPathSets = ExecuteProcessHelper.registerTable(sqlTree, env, tableEnv, paramsInfo.getLocalSql🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 166 +                paramsInfo.getRemoteSqlPluginPath(), paramsInfo.getPluginLoadMode(), sideTableMap, registerTableCache);"> 166 +                paramsInfo.getRemoteSqlPluginPath(), paramsInfo.getPluginLoadMode(), sideTableMap, registerTableCa🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 167 +        // cache classPathSets</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 168 +        ExecuteProcessHelper.registerPluginUrlToCachedFile(env, classPathSets);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 169 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 170 +        ExecuteProcessHelper.sqlTranslation(paramsInfo.getLocalSqlPluginPath(), tableEnv, sqlTree, sideTableMap, registerTableCache, streamQueryConfig);"> 170 +        ExecuteProcessHelper.sqlTranslation(paramsInfo.getLocalSqlPluginPath(), tableEnv, sqlTree, sideTableMap, r🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 171 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 172 +        if (env instanceof MyLocalStreamEnvironment) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 173 +            ((MyLocalStreamEnvironment) env).setClasspaths(ClassLoaderManager.getClassPath());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 174 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 175 +        return env;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 176 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 177 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 178 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 179 +    public static List&lt;URL&gt; getExternalJarUrls(String addJarListStr) throws java.io.IOException {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 180 +        List&lt;URL&gt; jarUrlList = Lists.newArrayList();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 181 +        if (Strings.isNullOrEmpty(addJarListStr)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 182 +            return jarUrlList;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 183 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 184 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 185 +        List&lt;String&gt; addJarFileList = OBJECT_MAPPER.readValue(URLDecoder.decode(addJarListStr, Charsets.UTF_8.name()), List.class);"> 185 +        List&lt;String&gt; addJarFileList = OBJECT_MAPPER.readValue(URLDecoder.decode(addJarListStr, Charsets.UTF_8.name🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 186 +        //Get External jar to load</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 187 +        for (String addJarPath : addJarFileList) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 188 +            jarUrlList.add(new File(addJarPath).toURI().toURL());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 189 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 190 +        return jarUrlList;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 191 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 192 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 193 +    private static void sqlTranslation(String localSqlPluginPath,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 194 +                                       StreamTableEnvironment tableEnv,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 195 +                                       SqlTree sqlTree,Map&lt;String, AbstractSideTableInfo&gt; sideTableMap,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 196 +                                       Map&lt;String, Table&gt; registerTableCache,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 197 +                                       StreamQueryConfig queryConfig) throws Exception {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 198 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 199 +        SideSqlExec sideSqlExec = new SideSqlExec();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 200 +        sideSqlExec.setLocalSqlPluginPath(localSqlPluginPath);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 201 +        for (CreateTmpTableParser.SqlParserResult result : sqlTree.getTmpSqlList()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 202 +            sideSqlExec.exec(result.getExecSql(), sideTableMap, tableEnv, registerTableCache, queryConfig, result);"> 202 +            sideSqlExec.exec(result.getExecSql(), sideTableMap, tableEnv, registerTableCache, queryConfig, result)🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 203 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 204 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 205 +        for (InsertSqlParser.SqlParseResult result : sqlTree.getExecSqlList()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 206 +            if (LOG.isInfoEnabled()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 207 +                LOG.info(&quot;exe-sql:\n&quot; + result.getExecSql());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 208 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 209 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 210 +            boolean isSide = false;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 211 +            for (String tableName : result.getTargetTableList()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 212 +                if (sqlTree.getTmpTableMap().containsKey(tableName)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 213 +                    CreateTmpTableParser.SqlParserResult tmp = sqlTree.getTmpTableMap().get(tableName);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 214 +                    String realSql = DtStringUtil.replaceIgnoreQuota(result.getExecSql(), &quot;`&quot;, &quot;&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 215 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 216 +                    SqlNode sqlNode = org.apache.calcite.sql.parser.SqlParser.create(realSql, CalciteConfig.MYSQL_LEX_CONFIG).parseStmt();"> 216 +                    SqlNode sqlNode = org.apache.calcite.sql.parser.SqlParser.create(realSql, CalciteConfig.MYSQL_🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 217 +                    String tmpSql = ((SqlInsert) sqlNode).getSource().toString();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 218 +                    tmp.setExecSql(tmpSql);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 219 +                    sideSqlExec.exec(tmp.getExecSql(), sideTableMap, tableEnv, registerTableCache, queryConfig, tmp);"> 219 +                    sideSqlExec.exec(tmp.getExecSql(), sideTableMap, tableEnv, registerTableCache, queryConfig, tm🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 220 +                } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 221 +                    for (String sourceTable : result.getSourceTableList()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 222 +                        if (sideTableMap.containsKey(sourceTable)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 223 +                            isSide = true;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 224 +                            break;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 225 +                        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 226 +                    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 227 +                    if (isSide) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 228 +                        //sql-dimensional table contains the dimension table of execution</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 229 +                        sideSqlExec.exec(result.getExecSql(), sideTableMap, tableEnv, registerTableCache, queryConfig, null);"> 229 +                        sideSqlExec.exec(result.getExecSql(), sideTableMap, tableEnv, registerTableCache, queryCon🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 230 +                    } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 231 +                        System.out.println(&quot;----------exec sql without dimension join-----------&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 232 +                        System.out.println(&quot;----------real sql exec is--------------------------&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 233 +                        System.out.println(result.getExecSql());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 234 +                        FlinkSQLExec.sqlUpdate(tableEnv, result.getExecSql(), queryConfig);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 235 +                        if (LOG.isInfoEnabled()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 236 +                            System.out.println();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 237 +                            LOG.info(&quot;exec sql: &quot; + result.getExecSql());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 238 +                        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 239 +                    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 240 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 241 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 242 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 243 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 244 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 245 +    public static void registerUserDefinedFunction(SqlTree sqlTree, List&lt;URL&gt; jarUrlList, TableEnvironment tableEnv)"> 245 +    public static void registerUserDefinedFunction(SqlTree sqlTree, List&lt;URL&gt; jarUrlList, TableEnvironment tableEn🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 246 +            throws IllegalAccessException, InvocationTargetException {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 247 +        // udf和tableEnv须由同一个类加载器加载</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 248 +        ClassLoader levelClassLoader = tableEnv.getClass().getClassLoader();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 249 +        URLClassLoader classLoader = null;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 250 +        List&lt;CreateFuncParser.SqlParserResult&gt; funcList = sqlTree.getFunctionList();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 251 +        for (CreateFuncParser.SqlParserResult funcInfo : funcList) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 252 +            //classloader</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 253 +            if (classLoader == null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 254 +                classLoader = ClassLoaderManager.loadExtraJar(jarUrlList, (URLClassLoader) levelClassLoader);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 255 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 256 +            FunctionManager.registerUDF(funcInfo.getType(), funcInfo.getClassName(), funcInfo.getName(), tableEnv, classLoader);"> 256 +            FunctionManager.registerUDF(funcInfo.getType(), funcInfo.getClassName(), funcInfo.getName(), tableEnv,🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 257 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 258 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 259 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 260 +    /**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 261 +     *    向Flink注册源表和结果表，返回执行时插件包的全路径</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 262 +     * @param sqlTree</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 263 +     * @param env</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 264 +     * @param tableEnv</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 265 +     * @param localSqlPluginPath</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 266 +     * @param remoteSqlPluginPath</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 267 +     * @param pluginLoadMode   插件加载模式 classpath or shipfile</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 268 +     * @param sideTableMap</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 269 +     * @param registerTableCache</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 270 +     * @return</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 271 +     * @throws Exception</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 272 +     */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 273 +    public static Set&lt;URL&gt; registerTable(SqlTree sqlTree, StreamExecutionEnvironment env, StreamTableEnvironment tableEnv, String localSqlPluginPath,"> 273 +    public static Set&lt;URL&gt; registerTable(SqlTree sqlTree, StreamExecutionEnvironment env, StreamTableEnvironment t🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 274 +                                         String remoteSqlPluginPath, String pluginLoadMode, Map&lt;String, AbstractSideTableInfo&gt; sideTableMap, Map&lt;String, Table&gt; registerTableCache) throws Exception {"> 274 +                                         String remoteSqlPluginPath, String pluginLoadMode, Map&lt;String, AbstractSi🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 275 +        Set&lt;URL&gt; pluginClassPatshSets = Sets.newHashSet();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 276 +        WaterMarkerAssigner waterMarkerAssigner = new WaterMarkerAssigner();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 277 +        for (AbstractTableInfo tableInfo : sqlTree.getTableInfoMap().values()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 278 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 279 +            if (tableInfo instanceof AbstractSourceTableInfo) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 280 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 281 +                AbstractSourceTableInfo sourceTableInfo = (AbstractSourceTableInfo) tableInfo;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 282 +                Table table = StreamSourceFactory.getStreamSource(sourceTableInfo, env, tableEnv, localSqlPluginPath);"> 282 +                Table table = StreamSourceFactory.getStreamSource(sourceTableInfo, env, tableEnv, localSqlPluginPa🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 283 +                tableEnv.registerTable(sourceTableInfo.getAdaptName(), table);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 284 +                //Note --- parameter conversion function can not be used inside a function of the type of polymerization"> 284 +                //Note --- parameter conversion function can not be used inside a function of the type of polymeri🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 285 +                //Create table in which the function is arranged only need adaptation sql</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 286 +                String adaptSql = sourceTableInfo.getAdaptSelectSql();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 287 +                Table adaptTable = adaptSql == null ? table : tableEnv.sqlQuery(adaptSql);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 288 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 289 +                RowTypeInfo typeInfo = new RowTypeInfo(adaptTable.getSchema().getFieldTypes(), adaptTable.getSchema().getFieldNames());"> 289 +                RowTypeInfo typeInfo = new RowTypeInfo(adaptTable.getSchema().getFieldTypes(), adaptTable.getSchem🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 290 +                DataStream adaptStream = tableEnv.toRetractStream(adaptTable, typeInfo)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 291 +                        .map((Tuple2&lt;Boolean, Row&gt; f0) -&gt; {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 292 +                            return f0.f1;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 293 +                        })</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 294 +                        .returns(typeInfo);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 295 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 296 +                String fields = String.join(&quot;,&quot;, typeInfo.getFieldNames());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 297 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 298 +                if (waterMarkerAssigner.checkNeedAssignWaterMarker(sourceTableInfo)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 299 +                    adaptStream = waterMarkerAssigner.assignWaterMarker(adaptStream, typeInfo, sourceTableInfo);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 300 +                    fields += &quot;,ROWTIME.ROWTIME&quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 301 +                } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 302 +                    fields += &quot;,PROCTIME.PROCTIME&quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 303 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 304 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 305 +                Table regTable = tableEnv.fromDataStream(adaptStream, fields);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 306 +                tableEnv.registerTable(tableInfo.getName(), regTable);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 307 +                if (LOG.isInfoEnabled()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 308 +                    LOG.info(&quot;registe table {} success.&quot;, tableInfo.getName());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 309 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 310 +                registerTableCache.put(tableInfo.getName(), regTable);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 311 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 312 +                URL sourceTablePathUrl = PluginUtil.buildSourceAndSinkPathByLoadMode(tableInfo.getType(), AbstractSourceTableInfo.SOURCE_SUFFIX, localSqlPluginPath, remoteSqlPluginPath, pluginLoadMode);"> 312 +                URL sourceTablePathUrl = PluginUtil.buildSourceAndSinkPathByLoadMode(tableInfo.getType(), Abstract🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 313 +                pluginClassPatshSets.add(sourceTablePathUrl);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 314 +            } else if (tableInfo instanceof AbstractTargetTableInfo) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 315 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 316 +                TableSink tableSink = StreamSinkFactory.getTableSink((AbstractTargetTableInfo) tableInfo, localSqlPluginPath);"> 316 +                TableSink tableSink = StreamSinkFactory.getTableSink((AbstractTargetTableInfo) tableInfo, localSql🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 317 +                TypeInformation[] flinkTypes = FunctionManager.transformTypes(tableInfo.getFieldClasses());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 318 +                tableEnv.registerTableSink(tableInfo.getName(), tableInfo.getFields(), flinkTypes, tableSink);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 319 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 320 +                URL sinkTablePathUrl = PluginUtil.buildSourceAndSinkPathByLoadMode(tableInfo.getType(), AbstractTargetTableInfo.TARGET_SUFFIX, localSqlPluginPath, remoteSqlPluginPath, pluginLoadMode);"> 320 +                URL sinkTablePathUrl = PluginUtil.buildSourceAndSinkPathByLoadMode(tableInfo.getType(), AbstractTa🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 321 +                pluginClassPatshSets.add(sinkTablePathUrl);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 322 +            } else if (tableInfo instanceof AbstractSideTableInfo) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 323 +                String sideOperator = ECacheType.ALL.name().equals(((AbstractSideTableInfo) tableInfo).getCacheType()) ? &quot;all&quot; : &quot;async&quot;;"> 323 +                String sideOperator = ECacheType.ALL.name().equals(((AbstractSideTableInfo) tableInfo).getCacheTyp🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 324 +                sideTableMap.put(tableInfo.getName(), (AbstractSideTableInfo) tableInfo);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 325 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 326 +                URL sideTablePathUrl = PluginUtil.buildSidePathByLoadMode(tableInfo.getType(), sideOperator, AbstractSideTableInfo.TARGET_SUFFIX, localSqlPluginPath, remoteSqlPluginPath, pluginLoadMode);"> 326 +                URL sideTablePathUrl = PluginUtil.buildSidePathByLoadMode(tableInfo.getType(), sideOperator, Abstr🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 327 +                pluginClassPatshSets.add(sideTablePathUrl);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 328 +            } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 329 +                throw new RuntimeException(&quot;not support table type:&quot; + tableInfo.getType());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 330 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 331 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 332 +        return pluginClassPatshSets;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 333 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 334 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 335 +    /**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 336 +     *   perjob模式将job依赖的插件包路径存储到cacheFile，在外围将插件包路径传递给jobgraph</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 337 +     * @param env</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 338 +     * @param classPathSet</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 339 +     */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 340 +    public static void registerPluginUrlToCachedFile(StreamExecutionEnvironment env, Set&lt;URL&gt; classPathSet) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 341 +        int i = 0;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 342 +        for (URL url : classPathSet) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 343 +            String classFileName = String.format(CLASS_FILE_NAME_FMT, i);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 344 +            env.registerCachedFile(url.getPath(), classFileName, true);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 345 +            i++;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 346 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 347 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 348 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 349 +    public static StreamExecutionEnvironment getStreamExeEnv(Properties confProperties, String deployMode) throws Exception {"> 349 +    public static StreamExecutionEnvironment getStreamExeEnv(Properties confProperties, String deployMode) throws 🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 350 +        StreamExecutionEnvironment env = !ClusterMode.local.name().equals(deployMode) ?</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 351 +                StreamExecutionEnvironment.getExecutionEnvironment() :</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 352 +                new MyLocalStreamEnvironment();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 353 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 354 +        StreamEnvConfigManager.streamExecutionEnvironmentConfig(env, confProperties);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 355 +        return env;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 356 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 357 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 358 +    public static void setLogLevel(ParamsInfo paramsInfo){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 359 +        String logLevel = paramsInfo.getConfProp().getProperty(ConfigConstrant.LOG_LEVEL_KEY);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 360 +        if(org.apache.commons.lang3.StringUtils.isBlank(logLevel)){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 361 +            return;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 362 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 363 +        ChangeLogLevelProcess logLevelProcess = new ChangeLogLevelProcess();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 364 +        logLevelProcess.process(logLevel);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 365 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 366 +}</span></pre></td>
                            <td><pre><span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   1 +/*</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   2 + * Licensed to the Apache Software Foundation (ASF) under one</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   3 + * or more contributor license agreements.  See the NOTICE file</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   4 + * distributed with this work for additional information</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   5 + * regarding copyright ownership.  The ASF licenses this file</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   6 + * to you under the Apache License, Version 2.0 (the</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   7 + * &quot;License&quot;); you may not use this file except in compliance</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   8 + * with the License.  You may obtain a copy of the License at</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   9 + *</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  10 + *     http://www.apache.org/licenses/LICENSE-2.0</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  11 + *</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  12 + * Unless required by applicable law or agreed to in writing, software</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  13 + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  14 + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  15 + * See the License for the specific language governing permissions and</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  16 + * limitations under the License.</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  17 + */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  18 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  19 +package com.dtstack.flink.sql.exec;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  20 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  21 +import org.apache.flink.api.common.typeinfo.TypeInformation;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  22 +import org.apache.flink.api.java.tuple.Tuple2;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  23 +import org.apache.flink.api.java.typeutils.RowTypeInfo;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  24 +import org.apache.flink.streaming.api.datastream.DataStream;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  25 +import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  26 +import org.apache.flink.table.api.StreamQueryConfig;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  27 +import org.apache.flink.table.api.Table;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  28 +import org.apache.flink.table.api.TableEnvironment;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  29 +import org.apache.flink.table.api.java.StreamTableEnvironment;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  30 +import org.apache.flink.table.sinks.TableSink;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  31 +import org.apache.flink.types.Row;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  32 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  33 +import com.dtstack.flink.sql.classloader.ClassLoaderManager;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  34 +import com.dtstack.flink.sql.config.CalciteConfig;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  35 +import com.dtstack.flink.sql.enums.ClusterMode;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  36 +import com.dtstack.flink.sql.enums.ECacheType;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  37 +import com.dtstack.flink.sql.enums.EPluginLoadMode;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  38 +import com.dtstack.flink.sql.environment.MyLocalStreamEnvironment;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  39 +import com.dtstack.flink.sql.environment.StreamEnvConfigManager;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  40 +import com.dtstack.flink.sql.function.FunctionManager;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  41 +import com.dtstack.flink.sql.option.OptionParser;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  42 +import com.dtstack.flink.sql.option.Options;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  43 +import com.dtstack.flink.sql.parser.CreateFuncParser;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  44 +import com.dtstack.flink.sql.parser.CreateTmpTableParser;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  45 +import com.dtstack.flink.sql.parser.InsertSqlParser;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  46 +import com.dtstack.flink.sql.parser.SqlParser;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  47 +import com.dtstack.flink.sql.parser.SqlTree;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  48 +import com.dtstack.flink.sql.side.SideSqlExec;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  49 +import com.dtstack.flink.sql.side.SideTableInfo;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  50 +import com.dtstack.flink.sql.sink.StreamSinkFactory;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  51 +import com.dtstack.flink.sql.source.StreamSourceFactory;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  52 +import com.dtstack.flink.sql.table.SourceTableInfo;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  53 +import com.dtstack.flink.sql.table.TableInfo;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  54 +import com.dtstack.flink.sql.table.TargetTableInfo;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  55 +import com.dtstack.flink.sql.util.DtStringUtil;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  56 +import com.dtstack.flink.sql.util.PluginUtil;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  57 +import com.dtstack.flink.sql.watermarker.WaterMarkerAssigner;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  58 +import com.fasterxml.jackson.databind.ObjectMapper;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  59 +import com.google.common.base.Preconditions;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  60 +import com.google.common.base.Strings;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  61 +import com.google.common.collect.Lists;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  62 +import com.google.common.collect.Maps;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  63 +import com.google.common.collect.Sets;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  64 +import org.apache.calcite.sql.SqlInsert;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  65 +import org.apache.calcite.sql.SqlNode;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  66 +import org.apache.commons.io.Charsets;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  67 +import org.apache.commons.lang3.StringUtils;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  68 +import org.slf4j.Logger;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  69 +import org.slf4j.LoggerFactory;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  70 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  71 +import java.io.File;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  72 +import java.lang.reflect.InvocationTargetException;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  73 +import java.net.URL;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  74 +import java.net.URLClassLoader;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  75 +import java.net.URLDecoder;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  76 +import java.util.Arrays;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  77 +import java.util.List;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  78 +import java.util.Map;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  79 +import java.util.Properties;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  80 +import java.util.Set;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  81 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  82 +/**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  83 + *  任务执行时的流程方法</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  84 + * Date: 2020/2/17</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  85 + * Company: www.dtstack.com</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  86 + * @author maqi</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  87 + */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  88 +public class ExecuteProcessHelper {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  89 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  90 +    private static final String CLASS_FILE_NAME_FMT = &quot;class_path_%d&quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  91 +    private static final Logger LOG = LoggerFactory.getLogger(ExecuteProcessHelper.class);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  92 +    private static final ObjectMapper OBJECT_MAPPER = new ObjectMapper();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  93 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  94 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  95 +    public static ParamsInfo parseParams(String[] args) throws Exception {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  96 +        LOG.info(&quot;------------program params-------------------------&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  97 +        System.out.println(&quot;------------program params-------------------------&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  98 +        Arrays.stream(args).forEach(arg -&gt; LOG.info(&quot;{}&quot;, arg));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  99 +        Arrays.stream(args).forEach(System.out::println);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 100 +        LOG.info(&quot;-------------------------------------------&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 101 +        System.out.println(&quot;----------------------------------------&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 102 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 103 +        OptionParser optionParser = new OptionParser(args);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 104 +        Options options = optionParser.getOptions();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 105 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 106 +        String sql = URLDecoder.decode(options.getSql(), Charsets.UTF_8.name());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 107 +        String name = options.getName();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 108 +        String localSqlPluginPath = options.getLocalSqlPluginPath();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 109 +        String remoteSqlPluginPath = options.getRemoteSqlPluginPath();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 110 +        String pluginLoadMode = options.getPluginLoadMode();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 111 +        String deployMode = options.getMode();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 112 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 113 +        Preconditions.checkArgument(checkRemoteSqlPluginPath(remoteSqlPluginPath, deployMode, pluginLoadMode),</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 114 +                &quot;Non-local mode or shipfile deployment mode, remoteSqlPluginPath is required&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 115 +        String confProp = URLDecoder.decode(options.getConfProp(), Charsets.UTF_8.toString());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 116 +        Properties confProperties = PluginUtil.jsonStrToObject(confProp, Properties.class);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 117 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 118 +        List&lt;URL&gt; jarURList = getExternalJarUrls(options.getAddjar());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 119 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 120 +        return ParamsInfo.builder()</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 121 +                .setSql(sql)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 122 +                .setName(name)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 123 +                .setLocalSqlPluginPath(localSqlPluginPath)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 124 +                .setRemoteSqlPluginPath(remoteSqlPluginPath)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 125 +                .setPluginLoadMode(pluginLoadMode)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 126 +                .setDeployMode(deployMode)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 127 +                .setConfProp(confProperties)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 128 +                .setJarUrlList(jarURList)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 129 +                .build();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 130 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 131 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 132 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 133 +    /**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 134 +     *   非local模式或者shipfile部署模式，remoteSqlPluginPath必填</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 135 +     * @param remoteSqlPluginPath</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 136 +     * @param deployMode</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 137 +     * @param pluginLoadMode</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 138 +     * @return</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 139 +     */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 140 +    public static boolean checkRemoteSqlPluginPath(String remoteSqlPluginPath, String deployMode, String pluginLoadMode) {"> 140 +    public static boolean checkRemoteSqlPluginPath(String remoteSqlPluginPath, String deployMode, String pluginLoa🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 141 +        if (StringUtils.isEmpty(remoteSqlPluginPath)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 142 +            return StringUtils.equalsIgnoreCase(pluginLoadMode, EPluginLoadMode.SHIPFILE.name())</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 143 +                    || StringUtils.equalsIgnoreCase(deployMode, ClusterMode.local.name());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 144 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 145 +        return true;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 146 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 147 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 148 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 149 +    public static StreamExecutionEnvironment getStreamExecution(ParamsInfo paramsInfo) throws Exception {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 150 +        StreamExecutionEnvironment env = ExecuteProcessHelper.getStreamExeEnv(paramsInfo.getConfProp(), paramsInfo.getDeployMode());"> 150 +        StreamExecutionEnvironment env = ExecuteProcessHelper.getStreamExeEnv(paramsInfo.getConfProp(), paramsInfo🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 151 +        StreamTableEnvironment tableEnv = StreamTableEnvironment.create(env);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 152 +        StreamQueryConfig streamQueryConfig = StreamEnvConfigManager.getStreamQueryConfig(tableEnv, paramsInfo.getConfProp());"> 152 +        StreamQueryConfig streamQueryConfig = StreamEnvConfigManager.getStreamQueryConfig(tableEnv, paramsInfo.get🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 153 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 154 +        SqlParser.setLocalSqlPluginRoot(paramsInfo.getLocalSqlPluginPath());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 155 +        SqlTree sqlTree = SqlParser.parseSql(paramsInfo.getSql());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 156 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 157 +        Map&lt;String, SideTableInfo&gt; sideTableMap = Maps.newHashMap();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 158 +        Map&lt;String, Table&gt; registerTableCache = Maps.newHashMap();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 159 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 160 +        //register udf</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 161 +        ExecuteProcessHelper.registerUserDefinedFunction(sqlTree, paramsInfo.getJarUrlList(), tableEnv);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 162 +        //register table schema</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 163 +        Set&lt;URL&gt; classPathSets = ExecuteProcessHelper.registerTable(sqlTree, env, tableEnv, paramsInfo.getLocalSqlPluginPath(),"> 163 +        Set&lt;URL&gt; classPathSets = ExecuteProcessHelper.registerTable(sqlTree, env, tableEnv, paramsInfo.getLocalSql🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 164 +                paramsInfo.getRemoteSqlPluginPath(), paramsInfo.getPluginLoadMode(), sideTableMap, registerTableCache);"> 164 +                paramsInfo.getRemoteSqlPluginPath(), paramsInfo.getPluginLoadMode(), sideTableMap, registerTableCa🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 165 +        // cache classPathSets</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 166 +        ExecuteProcessHelper.registerPluginUrlToCachedFile(env, classPathSets);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 167 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 168 +        ExecuteProcessHelper.sqlTranslation(paramsInfo.getLocalSqlPluginPath(), tableEnv, sqlTree, sideTableMap, registerTableCache, streamQueryConfig);"> 168 +        ExecuteProcessHelper.sqlTranslation(paramsInfo.getLocalSqlPluginPath(), tableEnv, sqlTree, sideTableMap, r🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 169 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 170 +        if (env instanceof MyLocalStreamEnvironment) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 171 +            ((MyLocalStreamEnvironment) env).setClasspaths(ClassLoaderManager.getClassPath());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 172 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 173 +        return env;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 174 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 175 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 176 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 177 +    public static List&lt;URL&gt; getExternalJarUrls(String addJarListStr) throws java.io.IOException {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 178 +        List&lt;URL&gt; jarUrlList = Lists.newArrayList();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 179 +        if (Strings.isNullOrEmpty(addJarListStr)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 180 +            return jarUrlList;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 181 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 182 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 183 +        List&lt;String&gt; addJarFileList = OBJECT_MAPPER.readValue(URLDecoder.decode(addJarListStr, Charsets.UTF_8.name()), List.class);"> 183 +        List&lt;String&gt; addJarFileList = OBJECT_MAPPER.readValue(URLDecoder.decode(addJarListStr, Charsets.UTF_8.name🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 184 +        //Get External jar to load</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 185 +        for (String addJarPath : addJarFileList) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 186 +            jarUrlList.add(new File(addJarPath).toURI().toURL());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 187 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 188 +        return jarUrlList;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 189 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 190 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 191 +    private static void sqlTranslation(String localSqlPluginPath,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 192 +            StreamTableEnvironment tableEnv,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 193 +            SqlTree sqlTree,Map&lt;String, SideTableInfo&gt; sideTableMap,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 194 +            Map&lt;String, Table&gt; registerTableCache,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 195 +            StreamQueryConfig queryConfig) throws Exception {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 196 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 197 +    	SideSqlExec sideSqlExec = new SideSqlExec();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 198 +        sideSqlExec.setLocalSqlPluginPath(localSqlPluginPath);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 199 +        for (CreateTmpTableParser.SqlParserResult result : sqlTree.getTmpSqlList()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 200 +            sideSqlExec.exec(result.getExecSql(), sideTableMap, tableEnv, registerTableCache, queryConfig, result);"> 200 +            sideSqlExec.exec(result.getExecSql(), sideTableMap, tableEnv, registerTableCache, queryConfig, result)🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 201 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 202 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 203 +        for (InsertSqlParser.SqlParseResult result : sqlTree.getExecSqlList()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 204 +            if (LOG.isInfoEnabled()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 205 +                LOG.info(&quot;exe-sql:\n&quot; + result.getExecSql());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 206 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 207 +            boolean isSide = false;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 208 +            for (String tableName : result.getTargetTableList()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 209 +                if (sqlTree.getTmpTableMap().containsKey(tableName)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 210 +                    CreateTmpTableParser.SqlParserResult tmp = sqlTree.getTmpTableMap().get(tableName);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 211 +                    String realSql = DtStringUtil.replaceIgnoreQuota(result.getExecSql(), &quot;`&quot;, &quot;&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 212 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 213 +                    SqlNode sqlNode = org.apache.calcite.sql.parser.SqlParser.create(realSql, CalciteConfig.MYSQL_LEX_CONFIG).parseStmt();"> 213 +                    SqlNode sqlNode = org.apache.calcite.sql.parser.SqlParser.create(realSql, CalciteConfig.MYSQL_🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 214 +                    String tmpSql = ((SqlInsert) sqlNode).getSource().toString();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 215 +                    tmp.setExecSql(tmpSql);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 216 +                    sideSqlExec.exec(tmp.getExecSql(), sideTableMap, tableEnv, registerTableCache, queryConfig, tmp);"> 216 +                    sideSqlExec.exec(tmp.getExecSql(), sideTableMap, tableEnv, registerTableCache, queryConfig, tm🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 217 +                } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 218 +                    for (String sourceTable : result.getSourceTableList()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 219 +                        if (sideTableMap.containsKey(sourceTable)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 220 +                            isSide = true;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 221 +                            break;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 222 +                        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 223 +                    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 224 +                    if (isSide) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 225 +                        //sql-dimensional table contains the dimension table of execution</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 226 +                        sideSqlExec.exec(result.getExecSql(), sideTableMap, tableEnv, registerTableCache, queryConfig, null);"> 226 +                        sideSqlExec.exec(result.getExecSql(), sideTableMap, tableEnv, registerTableCache, queryCon🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 227 +                    } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 228 +                        System.out.println(&quot;----------exec sql without dimension join-----------&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 229 +                        System.out.println(&quot;----------real sql exec is--------------------------&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 230 +                        System.out.println(result.getExecSql());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 231 +                        FlinkSQLExec.sqlUpdate(tableEnv, result.getExecSql(), queryConfig);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 232 +                        if (LOG.isInfoEnabled()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 233 +                            LOG.info(&quot;exec sql: &quot; + result.getExecSql());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 234 +                        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 235 +                    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 236 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 237 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 238 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 239 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 240 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 241 +    public static void registerUserDefinedFunction(SqlTree sqlTree, List&lt;URL&gt; jarUrlList, TableEnvironment tableEnv)"> 241 +    public static void registerUserDefinedFunction(SqlTree sqlTree, List&lt;URL&gt; jarUrlList, TableEnvironment tableEn🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 242 +            throws IllegalAccessException, InvocationTargetException {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 243 +        // udf和tableEnv须由同一个类加载器加载</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 244 +        ClassLoader levelClassLoader = tableEnv.getClass().getClassLoader();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 245 +        URLClassLoader classLoader = null;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 246 +        List&lt;CreateFuncParser.SqlParserResult&gt; funcList = sqlTree.getFunctionList();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 247 +        for (CreateFuncParser.SqlParserResult funcInfo : funcList) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 248 +            //classloader</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 249 +            if (classLoader == null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 250 +                classLoader = ClassLoaderManager.loadExtraJar(jarUrlList, (URLClassLoader) levelClassLoader);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 251 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 252 +            FunctionManager.registerUDF(funcInfo.getType(), funcInfo.getClassName(), funcInfo.getName(), tableEnv, classLoader);"> 252 +            FunctionManager.registerUDF(funcInfo.getType(), funcInfo.getClassName(), funcInfo.getName(), tableEnv,🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 253 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 254 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 255 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 256 +    /**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 257 +     *    向Flink注册源表和结果表，返回执行时插件包的全路径</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 258 +     * @param sqlTree</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 259 +     * @param env</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 260 +     * @param tableEnv</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 261 +     * @param localSqlPluginPath</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 262 +     * @param remoteSqlPluginPath</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 263 +     * @param pluginLoadMode   插件加载模式 classpath or shipfile</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 264 +     * @param sideTableMap</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 265 +     * @param registerTableCache</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 266 +     * @return</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 267 +     * @throws Exception</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 268 +     */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 269 +    public static Set&lt;URL&gt; registerTable(SqlTree sqlTree, StreamExecutionEnvironment env, StreamTableEnvironment tableEnv, String localSqlPluginPath,"> 269 +    public static Set&lt;URL&gt; registerTable(SqlTree sqlTree, StreamExecutionEnvironment env, StreamTableEnvironment t🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 270 +                                         String remoteSqlPluginPath, String pluginLoadMode, Map&lt;String, SideTableInfo&gt; sideTableMap, Map&lt;String, Table&gt; registerTableCache) throws Exception {"> 270 +                                         String remoteSqlPluginPath, String pluginLoadMode, Map&lt;String, SideTableI🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 271 +        Set&lt;URL&gt; pluginClassPatshSets = Sets.newHashSet();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 272 +        WaterMarkerAssigner waterMarkerAssigner = new WaterMarkerAssigner();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 273 +        for (TableInfo tableInfo : sqlTree.getTableInfoMap().values()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 274 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 275 +            if (tableInfo instanceof SourceTableInfo) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 276 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 277 +                SourceTableInfo sourceTableInfo = (SourceTableInfo) tableInfo;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 278 +                Table table = StreamSourceFactory.getStreamSource(sourceTableInfo, env, tableEnv, localSqlPluginPath);"> 278 +                Table table = StreamSourceFactory.getStreamSource(sourceTableInfo, env, tableEnv, localSqlPluginPa🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 279 +                tableEnv.registerTable(sourceTableInfo.getAdaptName(), table);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 280 +                //Note --- parameter conversion function can not be used inside a function of the type of polymerization"> 280 +                //Note --- parameter conversion function can not be used inside a function of the type of polymeri🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 281 +                //Create table in which the function is arranged only need adaptation sql</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 282 +                String adaptSql = sourceTableInfo.getAdaptSelectSql();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 283 +                Table adaptTable = adaptSql == null ? table : tableEnv.sqlQuery(adaptSql);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 284 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 285 +                RowTypeInfo typeInfo = new RowTypeInfo(adaptTable.getSchema().getFieldTypes(), adaptTable.getSchema().getFieldNames());"> 285 +                RowTypeInfo typeInfo = new RowTypeInfo(adaptTable.getSchema().getFieldTypes(), adaptTable.getSchem🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 286 +                DataStream adaptStream = tableEnv.toRetractStream(adaptTable, typeInfo)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 287 +                        .map((Tuple2&lt;Boolean, Row&gt; f0) -&gt; {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 288 +                            return f0.f1;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 289 +                        })</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 290 +                        .returns(typeInfo);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 291 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 292 +                String fields = String.join(&quot;,&quot;, typeInfo.getFieldNames());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 293 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 294 +                if (waterMarkerAssigner.checkNeedAssignWaterMarker(sourceTableInfo)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 295 +                    adaptStream = waterMarkerAssigner.assignWaterMarker(adaptStream, typeInfo, sourceTableInfo);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 296 +                    fields += &quot;,ROWTIME.ROWTIME&quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 297 +                } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 298 +                    fields += &quot;,PROCTIME.PROCTIME&quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 299 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 300 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 301 +                Table regTable = tableEnv.fromDataStream(adaptStream, fields);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 302 +                tableEnv.registerTable(tableInfo.getName(), regTable);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 303 +                if (LOG.isInfoEnabled()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 304 +                    LOG.info(&quot;registe table {} success.&quot;, tableInfo.getName());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 305 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 306 +                registerTableCache.put(tableInfo.getName(), regTable);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 307 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 308 +                URL sourceTablePathUrl = PluginUtil.buildSourceAndSinkPathByLoadMode(tableInfo.getType(), SourceTableInfo.SOURCE_SUFFIX, localSqlPluginPath, remoteSqlPluginPath, pluginLoadMode);"> 308 +                URL sourceTablePathUrl = PluginUtil.buildSourceAndSinkPathByLoadMode(tableInfo.getType(), SourceTa🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 309 +                pluginClassPatshSets.add(sourceTablePathUrl);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 310 +            } else if (tableInfo instanceof TargetTableInfo) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 311 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 312 +                TableSink tableSink = StreamSinkFactory.getTableSink((TargetTableInfo) tableInfo, localSqlPluginPath);"> 312 +                TableSink tableSink = StreamSinkFactory.getTableSink((TargetTableInfo) tableInfo, localSqlPluginPa🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 313 +                TypeInformation[] flinkTypes = FunctionManager.transformTypes(tableInfo.getFieldClasses());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 314 +                tableEnv.registerTableSink(tableInfo.getName(), tableInfo.getFields(), flinkTypes, tableSink);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 315 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 316 +                URL sinkTablePathUrl = PluginUtil.buildSourceAndSinkPathByLoadMode(tableInfo.getType(), TargetTableInfo.TARGET_SUFFIX, localSqlPluginPath, remoteSqlPluginPath, pluginLoadMode);"> 316 +                URL sinkTablePathUrl = PluginUtil.buildSourceAndSinkPathByLoadMode(tableInfo.getType(), TargetTabl🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 317 +                pluginClassPatshSets.add(sinkTablePathUrl);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 318 +            } else if (tableInfo instanceof SideTableInfo) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 319 +                String sideOperator = ECacheType.ALL.name().equals(((SideTableInfo) tableInfo).getCacheType()) ? &quot;all&quot; : &quot;async&quot;;"> 319 +                String sideOperator = ECacheType.ALL.name().equals(((SideTableInfo) tableInfo).getCacheType()) ? &quot;🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 320 +                sideTableMap.put(tableInfo.getName(), (SideTableInfo) tableInfo);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 321 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 322 +                URL sideTablePathUrl = PluginUtil.buildSidePathByLoadMode(tableInfo.getType(), sideOperator, SideTableInfo.TARGET_SUFFIX, localSqlPluginPath, remoteSqlPluginPath, pluginLoadMode);"> 322 +                URL sideTablePathUrl = PluginUtil.buildSidePathByLoadMode(tableInfo.getType(), sideOperator, SideT🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 323 +                pluginClassPatshSets.add(sideTablePathUrl);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 324 +            } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 325 +                throw new RuntimeException(&quot;not support table type:&quot; + tableInfo.getType());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 326 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 327 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 328 +        return pluginClassPatshSets;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 329 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 330 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 331 +    /**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 332 +     *   perjob模式将job依赖的插件包路径存储到cacheFile，在外围将插件包路径传递给jobgraph</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 333 +     * @param env</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 334 +     * @param classPathSet</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 335 +     */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 336 +    public static void registerPluginUrlToCachedFile(StreamExecutionEnvironment env, Set&lt;URL&gt; classPathSet) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 337 +        int i = 0;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 338 +        for (URL url : classPathSet) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 339 +            String classFileName = String.format(CLASS_FILE_NAME_FMT, i);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 340 +            env.registerCachedFile(url.getPath(), classFileName, true);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 341 +            i++;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 342 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 343 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 344 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 345 +    public static StreamExecutionEnvironment getStreamExeEnv(Properties confProperties, String deployMode) throws Exception {"> 345 +    public static StreamExecutionEnvironment getStreamExeEnv(Properties confProperties, String deployMode) throws 🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 346 +        StreamExecutionEnvironment env = !ClusterMode.local.name().equals(deployMode) ?</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 347 +                StreamExecutionEnvironment.getExecutionEnvironment() :</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 348 +                new MyLocalStreamEnvironment();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 349 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 350 +        StreamEnvConfigManager.streamExecutionEnvironmentConfig(env, confProperties);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 351 +        return env;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 352 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 353 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 354 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 355 +}</span></pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            